<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description" content="YubiKey 5 ã‚·ãƒªãƒ¼ã‚ºã§ Azure AD ã®ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®è¨¼æ˜æ›¸èªè¨¼ã‚’è©¦ã—ãŸã®ã§ãƒ¡ãƒ¢ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="YubiKey 5 ã‚·ãƒªãƒ¼ã‚ºã§ Azure AD ã®ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®è¨¼æ˜æ›¸èªè¨¼ã™ã‚‹">
<meta property="og:url" content="http://blog.haniyama.com/2020/10/17/serviceprincipal-certauth-using-yubikey5/index.html">
<meta property="og:site_name" content="enjoy struggling">
<meta property="og:description" content="YubiKey 5 ã‚·ãƒªãƒ¼ã‚ºã§ Azure AD ã®ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®è¨¼æ˜æ›¸èªè¨¼ã‚’è©¦ã—ãŸã®ã§ãƒ¡ãƒ¢ã€‚">
<meta property="og:locale">
<meta property="og:image" content="http://blog.haniyama.com/2020/10/17/serviceprincipal-certauth-using-yubikey5/pose_button_osu.png">
<meta property="og:image" content="http://blog.haniyama.com/2020/10/17/serviceprincipal-certauth-using-yubikey5/newapp.png">
<meta property="og:image" content="http://blog.haniyama.com/2020/10/17/serviceprincipal-certauth-using-yubikey5/api-permissions.png">
<meta property="og:image" content="http://blog.haniyama.com/2020/10/17/serviceprincipal-certauth-using-yubikey5/new-selfsigncertificate.png">
<meta property="og:image" content="http://blog.haniyama.com/2020/10/17/serviceprincipal-certauth-using-yubikey5/yubikey-manager.png">
<meta property="og:image" content="http://blog.haniyama.com/2020/10/17/serviceprincipal-certauth-using-yubikey5/cert.png">
<meta property="og:image" content="http://blog.haniyama.com/2020/10/17/serviceprincipal-certauth-using-yubikey5/connect-azuread.png">
<meta property="og:image" content="http://blog.haniyama.com/2020/10/17/serviceprincipal-certauth-using-yubikey5/get-policy.png">
<meta property="og:image" content="http://blog.haniyama.com/2020/10/17/serviceprincipal-certauth-using-yubikey5/disable-policy.png">
<meta property="article:published_time" content="2020-10-17T12:40:24.000Z">
<meta property="article:modified_time" content="2022-05-18T13:45:29.116Z">
<meta property="article:author" content="watahani">
<meta property="article:tag" content="Azure AD">
<meta property="article:tag" content="YubiKey">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.haniyama.com/2020/10/17/serviceprincipal-certauth-using-yubikey5/pose_button_osu.png">
<meta name="twitter:creator" content="@watahani"><meta name="description"><meta name="keywords" content="Java, Javascript, AWS, GCP, PGP"><link rel="alternate" type="application/atom+xml" href="/atom.xml" title="enjoy struggling"><title>YubiKey 5 ã‚·ãƒªãƒ¼ã‚ºã§ Azure AD ã®ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®è¨¼æ˜æ›¸èªè¨¼ã™ã‚‹ - enjoy struggling</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.png"><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create', 'UA-113476970-1', 'auto');ga('send', 'pageview');</script><meta name="generator" content="Hexo 6.3.0"><link rel="stylesheet" href="/css/prism-atom-dark.css" type="text/css"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a target="_blank" rel="noopener" href="https://github.com/watahani"><span>Github</span></a></li><li><a target="_blank" rel="noopener" href="https://qiita.com/watahani"><span>Qiita</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><link rel="amphtml" href="./amp/index.html"><label class="navi-button light" for="navi">MENU</label><img class="background" src="https://storage.googleapis.com/blog-haniyama/background-min.png"><div class="post-title"><h1 class="title">YubiKey 5 ã‚·ãƒªãƒ¼ã‚ºã§ Azure AD ã®ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®è¨¼æ˜æ›¸èªè¨¼ã™ã‚‹</h1><ul class="meta"><li><i class="icon icon-author"></i>watahani</li><li><i class="icon icon-clock"></i>20 Minutes</li><li><i class="icon icon-calendar"></i>October 17, 2020</li></ul></div></div><div class="article-content" style="max-width:800px"><p>YubiKey 5 ã‚·ãƒªãƒ¼ã‚ºã§ Azure AD ã®ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®è¨¼æ˜æ›¸èªè¨¼ã‚’è©¦ã—ãŸã®ã§ãƒ¡ãƒ¢ã€‚</p>
<span id="more"></span>

<h2 id="å…ƒãƒã‚¿"><a href="#å…ƒãƒã‚¿" class="headerlink" title="å…ƒãƒã‚¿"></a>å…ƒãƒã‚¿</h2><p>åœŸæ›œã®æ˜¼ã«ãŠããŸã‚‰ EMS å‹‰å¼·ä¼šãªã‚‹ã‚‚ã® TL ã§ç››ã‚Šä¸ŠãŒã£ã¦ã„ã‚‹ã®ã§è¦‹ã¦ã„ãŸã‚‰ã€æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã§ç®¡ç†è€…ãŒãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã•ã‚Œã¦å›°ã£ãŸã¨ã„ã†è©±ãŒã‚ã‚Šã€ã“ã†ã„ã†ã®ã‚ã‚Œã°ã„ã„ãªãƒ¼ã¨æ€ã£ãŸã®ã§ä½œã£ã¦ã¿ã‚‹ã€‚</p>
<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ Microsoft Graph API ã§å©ã‘ã‚‹ã‚ˆã†ã«ãªã£ãŸã—ã€ç·Šæ€¥è§£é™¤ãƒœã‚¿ãƒ³ã¨ã‹ä½œã‚‹ã®æ¥½ã—ãã†ã€‚<a target="_blank" rel="noopener" href="https://twitter.com/hashtag/jpemsug?src=hash&amp;ref_src=twsrc%5Etfw">#jpemsug</a> <a target="_blank" rel="noopener" href="https://t.co/WvVDsaLkLu">pic.twitter.com/WvVDsaLkLu</a></p>&mdash; 82@ã¯ã« (@watahani) <a target="_blank" rel="noopener" href="https://twitter.com/watahani/status/1317353605867790336?ref_src=twsrc%5Etfw">October 17, 2020</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>ç·Šæ€¥è§£é™¤ãƒœã‚¿ãƒ³ã‚’ä½œã‚‹ã€‚</p>
<p><img src="/2020/10/17/serviceprincipal-certauth-using-yubikey5/pose_button_osu.png" alt="ã„ã‚‰ã™ã¨ã‚„"></p>
<h2 id="å•é¡Œç‚¹"><a href="#å•é¡Œç‚¹" class="headerlink" title="å•é¡Œç‚¹"></a>å•é¡Œç‚¹</h2><p>Microsoft Graph API ã§ <a target="_blank" rel="noopener" href="https://docs.microsoft.com/ja-jp/graph/api/resources/conditionalaccesspolicy?view=graph-rest-1.0">æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ãŒæ“ä½œ</a> ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã€ ç·Šæ€¥è§£é™¤ãƒœã‚¿ãƒ³ã‚’ä½œã‚‹ã“ã¨è‡ªä½“ã¯ç°¡å˜ãªã®ã§ã™ãŒèª°ã§ã‚‚æŠ¼ã›ã¦ã—ã¾ã†ã¨å›°ã‚Šã¾ã™ã­ã€‚</p>
<p>ã†ãƒ¼ã‚“ã€è³‡æ ¼æƒ…å ±ã‚’å®‰å…¨ã«ä¿ç®¡ã§ãã‚‹ç´ æ•µãªãƒ‡ãƒã‚¤ã‚¹ã¯ãªã„ã‹ãªãï½ï¼Ÿ</p>
<p>è¨¼æ˜æ›¸ã‚’ä¿å­˜ã§ãã¦ã€æ‰‹ã”ã‚ã§ä¸ˆå¤«ãªãƒ‡ãƒã‚¤ã‚¹ç„¡ã„ã‹ãªï½ï¼Ÿ<br>.<br>.<br>.<br>.</p>
<p>ã¯ã„ã€ã‚ã‚Šã¾ã—ãŸã€‚</p>
<iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=82p-22&language=ja_JP&o=9&p=8&l=as4&m=amazon&f=ifr&ref=as_ss_li_til&asins=B07HBD71HL&linkId=f2bf005f94ac048773128cc9c094d7fb"></iframe>

<blockquote>
<p>å®£ä¼ã—ãŸã®ã§æŒ‡ç´‹èªè¨¼ã®ã§ãã‚‹ YubiKey ãã ã•ã„ğŸ¤¤ğŸ¤¤</p>
</blockquote>
<h2 id="YubiKey-ã«ä¿å­˜ã—ãŸè¨¼æ˜æ›¸ã§ã€è¨¼æ˜æ›¸èªè¨¼ãŒã—ãŸã„"><a href="#YubiKey-ã«ä¿å­˜ã—ãŸè¨¼æ˜æ›¸ã§ã€è¨¼æ˜æ›¸èªè¨¼ãŒã—ãŸã„" class="headerlink" title="YubiKey ã«ä¿å­˜ã—ãŸè¨¼æ˜æ›¸ã§ã€è¨¼æ˜æ›¸èªè¨¼ãŒã—ãŸã„"></a>YubiKey ã«ä¿å­˜ã—ãŸè¨¼æ˜æ›¸ã§ã€è¨¼æ˜æ›¸èªè¨¼ãŒã—ãŸã„</h2><p>YubiKey4, YubiKey5 ã‚·ãƒªãƒ¼ã‚ºã¯ã€Windows ä¸Šã§ã‚¹ãƒãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ã¨ã—ã¦åƒãã€‚Windows 10 ã®å ´åˆã€minidriver ã‚‚åˆã‚ã‹ã‚‰å…¥ã£ã¦ã„ã‚‹ã®ã§ã€Service Principal ã®èªè¨¼ã‚‚ã§ãã‚‹ã‚“ã˜ã‚ƒãªã„ï¼Ÿã¨æ€ã£ã¦ã‚„ã£ã¦ã¿ãŸã‚‰ç°¡å˜ã«ã§ããŸã®ã§ã€ãƒ¡ãƒ¢ã€‚</p>
<h2 id="Azure-AD-ã«æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹è§£é™¤ç”¨ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«-ã‚¢ãƒ—ãƒª-ã‚’ä½œã‚‹"><a href="#Azure-AD-ã«æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹è§£é™¤ç”¨ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«-ã‚¢ãƒ—ãƒª-ã‚’ä½œã‚‹" class="headerlink" title="Azure AD ã«æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹è§£é™¤ç”¨ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ« (ã‚¢ãƒ—ãƒª) ã‚’ä½œã‚‹"></a>Azure AD ã«æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹è§£é™¤ç”¨ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ« (ã‚¢ãƒ—ãƒª) ã‚’ä½œã‚‹</h2><p>ã¾ãšã¯ã€æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹è§£é™¤ç”¨ã®ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã‚’ä½œã‚‹ã€‚ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã«ã¤ã„ã¦ã¯<a target="_blank" rel="noopener" href="https://qiita.com/watahani/items/1f3f533097b7a15d6698">ä»¥å‰ Qiita ã§æ›¸ã„ãŸã®ã§</a>ã•ã£ãã‚Šã¨ã€‚</p>
<h3 id="ã‚¢ãƒ—ãƒªã®ä½œæˆ"><a href="#ã‚¢ãƒ—ãƒªã®ä½œæˆ" class="headerlink" title="ã‚¢ãƒ—ãƒªã®ä½œæˆ"></a>ã‚¢ãƒ—ãƒªã®ä½œæˆ</h3><p><code>Azure Active Directory</code> &gt; <code>ã‚¢ãƒ—ãƒªã®ç™»éŒ²</code> &gt; <code>æ–°ã—ã„ã‚¢ãƒ—ãƒª</code></p>
<p><img src="/2020/10/17/serviceprincipal-certauth-using-yubikey5/newapp.png"></p>
<p>å…¨ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç™»éŒ²ã€‚</p>
<h3 id="API-ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯"><a href="#API-ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯" class="headerlink" title="API ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯"></a>API ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯</h3><p>ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã§æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã‚’æ“ä½œã™ã‚‹ã«ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ¨©é™ã® <code>Policy.Read.All</code>, <code>Policy.ReadWrite.ConditionalAccess</code>, <code>Application.Read.All</code> ãŒå¿…è¦ã€‚</p>
<p><code>ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã®è¿½åŠ </code> ã‹ã‚‰ Microsoft Graph API ã‚’é¸ã³ã€ã€Œã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ¨©é™ã€ã§ã€ä¸Šè¨˜ 3 ã¤ã®æ¨©é™ã‚’è¿½åŠ ã™ã‚‹ã€‚ãã®å¾Œã€ã€Œ&lt;ãƒ†ãƒŠãƒ³ãƒˆå&gt;ã«ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’è¿½åŠ ã—ã¾ã™ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€Admin Consent ã‚’å®Ÿæ–½ã™ã‚‹ã€‚</p>
<p><img src="/2020/10/17/serviceprincipal-certauth-using-yubikey5/api-permissions.png"></p>
<h2 id="YubiKey-ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"><a href="#YubiKey-ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—" class="headerlink" title="YubiKey ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"></a>YubiKey ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h2><p>ãã®å¾Œã€ãŠã‚‚ã‚€ã‚ã« YubiKey 5 ã‚’ PC ã«åˆºã—ã¦ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã€‚</p>
<pre class="language-powershell" style="" tabindex="0"><code id="3a92693f" class="language-powershell" data-prism-hydrate="{&quot;element&quot;:&quot;3a92693f&quot;,&quot;language&quot;:&quot;powershell&quot;,&quot;code&quot;:&quot;\n$currentDate = Get-Date\n$notAfter  = $currentDate.AddYears(10)\n$selfCert = New-SelfSignedCertificate -CertStoreLocation cert:\\CurrentUser\\my -Subject \&quot;CN=d22351ce-beb5-4e41-8346-3a7d99db934,OU=ConditionalAccessUnlocker\&quot;  -Provider \&quot;Microsoft Base Smart Card Crypto Provider\&quot; -KeySpec Signature -NotAfter $notAfter\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token variable\&quot;\u003e$currentDate</span> = <span class=\&quot;token function\&quot;>Get-Date</span>\n<span class=\&quot;token variable\&quot;>$notAfter</span>  = <span class=\&quot;token variable\&quot;>$currentDate</span><span class=\&quot;token punctuation\&quot;>.</span>AddYears<span class=\&quot;token punctuation\&quot;>(</span>10<span class=\&quot;token punctuation\&quot;>)</span>\n<span class=\&quot;token variable\&quot;>$selfCert</span> = <span class=\&quot;token function\&quot;>New-SelfSignedCertificate</span> <span class=\&quot;token operator\&quot;>-</span>CertStoreLocation cert:\\CurrentUser\\my <span class=\&quot;token operator\&quot;>-</span>Subject <span class=\&quot;token string\&quot;>\&quot;CN=d22351ce-beb5-4e41-8346-3a7d99db934,OU=ConditionalAccessUnlocker\&quot;</span>  <span class=\&quot;token operator\&quot;>-</span>Provider <span class=\&quot;token string\&quot;>\&quot;Microsoft Base Smart Card Crypto Provider\&quot;</span> <span class=\&quot;token operator\&quot;>-</span>KeySpec Signature <span class=\&quot;token operator\&quot;>-</span>NotAfter <span class=\&quot;token variable\&quot;>$notAfter</span>\n&quot;}">
<span class="token variable">$currentDate</span> = <span class="token function">Get-Date</span>
<span class="token variable">$notAfter</span>  = <span class="token variable">$currentDate</span><span class="token punctuation">.</span>AddYears<span class="token punctuation">(</span>10<span class="token punctuation">)</span>
<span class="token variable">$selfCert</span> = <span class="token function">New-SelfSignedCertificate</span> <span class="token operator">-</span>CertStoreLocation cert:\CurrentUser\my <span class="token operator">-</span>Subject <span class="token string">"CN=d22351ce-beb5-4e41-8346-3a7d99db934,OU=ConditionalAccessUnlocker"</span>  <span class="token operator">-</span>Provider <span class="token string">"Microsoft Base Smart Card Crypto Provider"</span> <span class="token operator">-</span>KeySpec Signature <span class="token operator">-</span>NotAfter <span class="token variable">$notAfter</span>
</code></pre>

<p><img src="/2020/10/17/serviceprincipal-certauth-using-yubikey5/new-selfsigncertificate.png" alt="PIN"></p>
<blockquote>
<p>è¨¼æ˜æ›¸ã®ä½œæ³•ã¯ã‚ã¾ã‚Šåˆ†ã‹ã‚‰ãªã„ã‘ã©ã€AppId ã‚’ Subject ã«å…¥ã‚Œã¨ã‘ã°ä¾¿åˆ©ãã†ã€‚<br>ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã¯ãƒ†ã‚¹ãƒˆä¸­ã®ãªã®ã§ã€DNS ã§è¨­å®šã—ã¦ã‚‹ã€‚</p>
</blockquote>
<p>PIN ã‚’è¦æ±‚ã•ã‚Œã‚‹ã®ã§ã€YubiKey 5 ã® PIN ã‚’å…¥ã‚Œã‚‹ã€‚Azure AD ãªã©ã§ FIDO2 ã§ä½¿ã£ã¦ã„ã‚‹å ´åˆã¯å…±é€šãªã®ã§ã€ãã‚Œã‚’å…¥ã‚Œã‚‹ã€‚åˆã‚ã¦ä½¿ã†å ´åˆã¯å¥½ããª PIN ã‚’å…¥ã‚Œã‚‹ã€‚</p>
<p>ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã§ YubiKey ä¸Šã«è‡ªå·±è¨¼æ˜æ›¸ãŒä¿å­˜ã•ã‚Œã‚‹ã€‚YubiKey Manager ã§è¦‹ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã§ 9a ã‚¹ãƒ­ãƒƒãƒˆã«è¨¼æ˜æ›¸ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã®ãŒåˆ†ã‹ã‚‹ã€‚</p>
<p><img src="/2020/10/17/serviceprincipal-certauth-using-yubikey5/yubikey-manager.png"></p>
<p><code>certutil</code> ã§ã‚‚ç¢ºèªã§ãã‚‹ã€‚</p>
<pre class="language-powershell" style="" tabindex="0"><code id="f947843e" class="language-powershell" data-prism-hydrate="{&quot;element&quot;:&quot;f947843e&quot;,&quot;language&quot;:&quot;powershell&quot;,&quot;code&quot;:&quot;\ncertutil -scinfo\n&quot;,&quot;highlightedCode&quot;:&quot;\ncertutil \u003cspan class=\&quot;token operator\&quot;\u003e-</span>scinfo\n&quot;}">
certutil <span class="token operator">-</span>scinfo
</code></pre>

<p>å‰Šé™¤ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚‚ãƒ¡ãƒ¢ã£ã¦ãŠãã€‚</p>
<pre class="language-powershell" style="" tabindex="0"><code id="4af8693f" class="language-powershell" data-prism-hydrate="{&quot;element&quot;:&quot;4af8693f&quot;,&quot;language&quot;:&quot;powershell&quot;,&quot;code&quot;:&quot;\n certutil -delkey -csp \&quot;Microsoft Base Smart Card Crypto Provider\&quot; \&quot;te-4d4c1e9d-2c00-4995-9396-4014ef5a281d\&quot; #ã‚­ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠåã¯ -scinfo ã§å‡ºã¦ããŸã‚„ã¤\n&quot;,&quot;highlightedCode&quot;:&quot;\n certutil \u003cspan class=\&quot;token operator\&quot;\u003e-</span>delkey <span class=\&quot;token operator\&quot;>-</span>csp <span class=\&quot;token string\&quot;>\&quot;Microsoft Base Smart Card Crypto Provider\&quot;</span> <span class=\&quot;token string\&quot;>\&quot;te-4d4c1e9d-2c00-4995-9396-4014ef5a281d\&quot;</span> <span class=\&quot;token comment\&quot;>#ã‚­ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠåã¯ -scinfo ã§å‡ºã¦ããŸã‚„ã¤</span>\n&quot;}">
 certutil <span class="token operator">-</span>delkey <span class="token operator">-</span>csp <span class="token string">"Microsoft Base Smart Card Crypto Provider"</span> <span class="token string">"te-4d4c1e9d-2c00-4995-9396-4014ef5a281d"</span> <span class="token comment">#ã‚­ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠåã¯ -scinfo ã§å‡ºã¦ããŸã‚„ã¤</span>
</code></pre>

<p>ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§è¨¼æ˜æ›¸ã‚’å‡ºåŠ›ã™ã‚‹ã€‚</p>
<pre class="language-powershell" style="" tabindex="0"><code id="87b04a3f" class="language-powershell" data-prism-hydrate="{&quot;element&quot;:&quot;87b04a3f&quot;,&quot;language&quot;:&quot;powershell&quot;,&quot;code&quot;:&quot;\n$cerfile = \&quot;.\\ConditionalAccessUnlocker.cer\&quot;\nExport-Certificate -Cert $cert -FilePath $cerfile\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token variable\&quot;\u003e$cerfile</span> = <span class=\&quot;token string\&quot;>\&quot;.\\ConditionalAccessUnlocker.cer\&quot;</span>\n<span class=\&quot;token function\&quot;>Export-Certificate</span> <span class=\&quot;token operator\&quot;>-</span>Cert <span class=\&quot;token variable\&quot;>$cert</span> <span class=\&quot;token operator\&quot;>-</span>FilePath <span class=\&quot;token variable\&quot;>$cerfile</span>\n&quot;}">
<span class="token variable">$cerfile</span> = <span class="token string">".\ConditionalAccessUnlocker.cer"</span>
<span class="token function">Export-Certificate</span> <span class="token operator">-</span>Cert <span class="token variable">$cert</span> <span class="token operator">-</span>FilePath <span class="token variable">$cerfile</span>
</code></pre>

<blockquote>
<p>Note:<br> ã“ã®è¾ºå‹•ã‹ãªã„ã¨ãã¯ã€ã‚‚ã—ã‹ã™ã‚‹ã¨ã“ã®è¾ºã®ãƒ¬ã‚¸ã‚¹ãƒˆãƒªãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚<br><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/ff404287(v=ws.10)">https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/ff404287(v=ws.10)</a></p>
</blockquote>
<h3 id="è¨¼æ˜æ›¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"><a href="#è¨¼æ˜æ›¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰" class="headerlink" title="è¨¼æ˜æ›¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"></a>è¨¼æ˜æ›¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3><p>Azure ãƒãƒ¼ã‚¿ãƒ«ã«æˆ»ã£ã¦ã€ä½œã£ãŸã‚¢ãƒ—ãƒªã® <code>è¨¼æ˜æ›¸ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ</code> ã‚’é¸æŠã—ã€å…ˆã»ã©ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸè¨¼æ˜æ›¸ã€ <code>ConditionalAccessUnlocker.cer</code> ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã€‚</p>
<p><img src="/2020/10/17/serviceprincipal-certauth-using-yubikey5/cert.png"></p>
<h2 id="Azure-AD-PowerShell-Module-ã§æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã‚’æ“ä½œ"><a href="#Azure-AD-PowerShell-Module-ã§æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã‚’æ“ä½œ" class="headerlink" title="Azure AD PowerShell Module ã§æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã‚’æ“ä½œ"></a>Azure AD PowerShell Module ã§æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã‚’æ“ä½œ</h2><h3 id="PowerShell-Module-ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"><a href="#PowerShell-Module-ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«" class="headerlink" title="PowerShell Module ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"></a>PowerShell Module ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</h3><p>Azure AD PowerShell Module v2 ã® Version <code>2.0.2.106</code> ä»¥ä¸Šã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚</p>
<pre class="language-powershell" style="" tabindex="0"><code id="d685373f" class="language-powershell" data-prism-hydrate="{&quot;element&quot;:&quot;d685373f&quot;,&quot;language&quot;:&quot;powershell&quot;,&quot;code&quot;:&quot;\nInstall-Module -Name AzureAD -Force\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token function\&quot;\u003eInstall-Module</span> <span class=\&quot;token operator\&quot;>-</span>Name AzureAD <span class=\&quot;token operator\&quot;>-</span>Force\n&quot;}">
<span class="token function">Install-Module</span> <span class="token operator">-</span>Name AzureAD <span class="token operator">-</span>Force
</code></pre>

<h3 id="ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹-ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®æ¨©é™ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³"><a href="#ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹-ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®æ¨©é™ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³" class="headerlink" title="ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®æ¨©é™ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³"></a>ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®æ¨©é™ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³</h3><p>ã•ã£ãä½œæˆã—ãŸè¨¼æ˜æ›¸ã‚’èª­ã¿è¾¼ã‚“ã§ã€ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®æ¨©é™ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã™ã‚‹ã€‚</p>
<pre class="language-powershell" style="" tabindex="0"><code id="0a3f213f" class="language-powershell" data-prism-hydrate="{&quot;element&quot;:&quot;0a3f213f&quot;,&quot;language&quot;:&quot;powershell&quot;,&quot;code&quot;:&quot;\n$cert = Get-ChildItem Cert:\\CurrentUser\\My\\ | ?{ $_.Subject -like \&quot;*OU=ConditionalAccessUnlocker*\&quot;} ; $cert\n$appId = $cert.Subject.Split(\&quot;,\&quot;)[0].Split(\&quot;=\&quot;)[1]\n\nConnect-AzureAD -TenantId $tenantId -ApplicationId $appId -CertificateThumbprint $cert.Thumbprint\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token variable\&quot;\u003e$cert</span> = <span class=\&quot;token function\&quot;>Get-ChildItem</span> Cert:\\CurrentUser\\My\\ <span class=\&quot;token punctuation\&quot;>|</span> ?<span class=\&quot;token punctuation\&quot;>{</span> <span class=\&quot;token variable\&quot;>$_</span><span class=\&quot;token punctuation\&quot;>.</span>Subject <span class=\&quot;token operator\&quot;>-like</span> <span class=\&quot;token string\&quot;>\&quot;*OU=ConditionalAccessUnlocker*\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span> <span class=\&quot;token punctuation\&quot;>;</span> <span class=\&quot;token variable\&quot;>$cert</span>\n<span class=\&quot;token variable\&quot;>$appId</span> = <span class=\&quot;token variable\&quot;>$cert</span><span class=\&quot;token punctuation\&quot;>.</span>Subject<span class=\&quot;token punctuation\&quot;>.</span>Split<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;,\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>[</span>0<span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>.</span>Split<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;=\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>[</span>1<span class=\&quot;token punctuation\&quot;>]</span>\n\n<span class=\&quot;token function\&quot;>Connect-AzureAD</span> <span class=\&quot;token operator\&quot;>-</span>TenantId <span class=\&quot;token variable\&quot;>$tenantId</span> <span class=\&quot;token operator\&quot;>-</span>ApplicationId <span class=\&quot;token variable\&quot;>$appId</span> <span class=\&quot;token operator\&quot;>-</span>CertificateThumbprint <span class=\&quot;token variable\&quot;>$cert</span><span class=\&quot;token punctuation\&quot;>.</span>Thumbprint\n&quot;}">
<span class="token variable">$cert</span> = <span class="token function">Get-ChildItem</span> Cert:\CurrentUser\My\ <span class="token punctuation">|</span> ?<span class="token punctuation">{</span> <span class="token variable">$_</span><span class="token punctuation">.</span>Subject <span class="token operator">-like</span> <span class="token string">"*OU=ConditionalAccessUnlocker*"</span><span class="token punctuation">}</span> <span class="token punctuation">;</span> <span class="token variable">$cert</span>
<span class="token variable">$appId</span> = <span class="token variable">$cert</span><span class="token punctuation">.</span>Subject<span class="token punctuation">.</span>Split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">[</span>0<span class="token punctuation">]</span><span class="token punctuation">.</span>Split<span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">)</span><span class="token punctuation">[</span>1<span class="token punctuation">]</span>

<span class="token function">Connect-AzureAD</span> <span class="token operator">-</span>TenantId <span class="token variable">$tenantId</span> <span class="token operator">-</span>ApplicationId <span class="token variable">$appId</span> <span class="token operator">-</span>CertificateThumbprint <span class="token variable">$cert</span><span class="token punctuation">.</span>Thumbprint
</code></pre>

<p><img src="/2020/10/17/serviceprincipal-certauth-using-yubikey5/connect-azuread.png"></p>
<p>PIN ã‚’èã‹ã‚Œã‚‹ã®ã§ã€YubiKey ã® PIN ã‚’å…¥åŠ›ã™ã‚‹ã€‚</p>
<p><img src="/2020/10/17/serviceprincipal-certauth-using-yubikey5/get-policy.png"></p>
<p>ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã§ãã‚‹ã®ã§ã€å¾Œã¯ãƒãƒªã‚·ãƒ¼ã‚’æ“ä½œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’ãƒãƒãƒãƒå©ã„ã¦è§£é™¤ã™ã‚Œã°â€¦</p>
<p><img src="/2020/10/17/serviceprincipal-certauth-using-yubikey5/disable-policy.png"></p>
<p><strong>ã‚ã‚Œâ€¦ ã†ã¾ãå‹•ã‹ãªã„â€¦ã€‚</strong> ğŸ˜…</p>
<h2 id="ã¾ã¨ã‚"><a href="#ã¾ã¨ã‚" class="headerlink" title="ã¾ã¨ã‚"></a>ã¾ã¨ã‚</h2><p><del>å‰Šé™¤ã¯ä¸Šæ‰‹ãå‹•ã„ãŸã®ã§ã€ç·Šæ€¥æ™‚ã¯ Remove-AzureADMSConditionalAccessPolicy ã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã‚‹ãƒãƒªã‚·ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹ãªã‚Šã—ã¦ãã ã•ã„ã€‚</del></p>
<p>ã„ã¤ã®é–“ã«ã‹æ²»ã£ã¦ã¾ã—ãŸã€‚</p>
<pre class="language-powershell" style="" tabindex="0"><code id="6776693f" class="language-powershell" data-prism-hydrate="{&quot;element&quot;:&quot;6776693f&quot;,&quot;language&quot;:&quot;powershell&quot;,&quot;code&quot;:&quot;\nGet-AzureADMSConditionalAccessPolicy | %{ Set-AzureADMSConditionalAccessPolicy -PolicyId $_.Id -State \&quot;disabled\&quot;}\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token function\&quot;\u003eGet-AzureADMSConditionalAccessPolicy</span> <span class=\&quot;token punctuation\&quot;>|</span> <span class=\&quot;token operator\&quot;>%</span><span class=\&quot;token punctuation\&quot;>{</span> <span class=\&quot;token function\&quot;>Set-AzureADMSConditionalAccessPolicy</span> <span class=\&quot;token operator\&quot;>-</span>PolicyId <span class=\&quot;token variable\&quot;>$_</span><span class=\&quot;token punctuation\&quot;>.</span>Id <span class=\&quot;token operator\&quot;>-</span>State <span class=\&quot;token string\&quot;>\&quot;disabled\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span>\n&quot;}">
<span class="token function">Get-AzureADMSConditionalAccessPolicy</span> <span class="token punctuation">|</span> <span class="token operator">%</span><span class="token punctuation">{</span> <span class="token function">Set-AzureADMSConditionalAccessPolicy</span> <span class="token operator">-</span>PolicyId <span class="token variable">$_</span><span class="token punctuation">.</span>Id <span class="token operator">-</span>State <span class="token string">"disabled"</span><span class="token punctuation">}</span>
</code></pre>

<p>ã“ã‚Œã§ã€ç·Šæ€¥æ™‚ã« YubiKey ãŒã‚ã‚Œã°æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã‚’å‰Šé™¤ã—ã¦ãƒ†ãƒŠãƒ³ãƒˆã«å…¥ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã€å®‰å¿ƒã—ã¦æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã®å®Ÿé¨“ãŒå‡ºæ¥ã¾ã™ã­ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Azure-Samples/azure-ad-conditional-access-apis/tree/main/01-configure/powershell">azure-ad-conditional-access-apis&#x2F;01-configure&#x2F;powershell at main Â· Azure-Samples&#x2F;azure-ad-conditional-access-apis</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/graph/api/resources/conditionalaccesspolicy?view=graph-rest-1.0">Use query parameters to customize responses - Microsoft Graph | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://pivkey.zendesk.com/hc/en-us/articles/204519855-Deleting-a-Certificate-and-Keys-using-Certutil">Deleting a Certificate and Keys using Certutil â€“ Taglio PIVKey</a></li>
</ul>
<div class="related-post"><h3>é–¢é€£è¨˜äº‹</h3><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2020\09\27\aad-external-identity-api-connector\" title="Azure AD External Identity ã®ã‚»ãƒ«ãƒ• ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã¨ API ã‚³ãƒã‚¯ã‚¿ãƒ¼" rel="bookmark">Azure AD External Identity ã®ã‚»ãƒ«ãƒ• ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã¨ API ã‚³ãƒã‚¯ã‚¿ãƒ¼</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2020\02\16\customize-aad-token-claims\" title="Azure AD ã§ OAuth/OIDC ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹" rel="bookmark">Azure AD ã§ OAuth/OIDC ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2019\11\24\ms-ignite-2019\" title="Microsoft Ignite 2019 ãƒ¡ãƒ¢" rel="bookmark">Microsoft Ignite 2019 ãƒ¡ãƒ¢</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2019\07\15\azuread-fido2-security-key-public-preview\" title="Azure AD ã® FIDO2 Security Key å¯¾å¿œã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒæ¥ãŸãƒ¼" rel="bookmark">Azure AD ã® FIDO2 Security Key å¯¾å¿œã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒæ¥ãŸãƒ¼</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2018\04\26\fido2-security-key\" title="FIDO2 å¯¾å¿œã® Security Key ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³" rel="bookmark">FIDO2 å¯¾å¿œã® Security Key ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³</a></h3></div></li></ul></div></div><div class="article-meta" style="max-width:800px"><div class="tags"><i class="icon icon-tag"></i><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure-AD/" rel="tag">Azure AD</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/YubiKey/" rel="tag">YubiKey</a><span class="tag-list-count">10</span></li></ul></div></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2020/12/09/oidc-sse-cape-risc/"><i class="icon icon-arror-left"></i></a></li><li><a href="/2020/10/09/onenote-to-markdown/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/82p" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="https://twitter.com/watahani" title="Twitter" target="_blank"><i class="icon icon-twitter"></i></a></li><li><a href="https://www.facebook.com/haniyama.wataru" title="Facebook" target="_blank"><i class="icon icon-facebook"></i></a></li></ul></div><div class="bottom"><p class="copyright">Â© 2023 enjoy struggling<br><small>POWER BY <a href="https://hexo.io" target="_blank">HEXO</a></small><small>, THEME BY <a href="https://github.com/BoizZ/hexo-theme-laughing" target="_blank">LAUGHING</a></small></p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>