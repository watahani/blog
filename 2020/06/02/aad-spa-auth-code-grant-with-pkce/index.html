<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description" content="Authorization Code Flow with PKCE に対応した MSAL.js 2.x がプレビューでリリースされていたので、触ってみたメモ。 Azure ポータルのアプリの登録画面Azure AD のアプリ登録の画面がアップデートしており、リダイレクト URI の登録に SPA が追加されていた。">
<meta property="og:type" content="article">
<meta property="og:title" content="Azure AD の SPA 向け Authorize Code Flow with PKCE (MSAL.js 2.x)">
<meta property="og:url" content="http://blog.haniyama.com/2020/06/02/aad-spa-auth-code-grant-with-pkce/index.html">
<meta property="og:site_name" content="enjoy struggling">
<meta property="og:description" content="Authorization Code Flow with PKCE に対応した MSAL.js 2.x がプレビューでリリースされていたので、触ってみたメモ。 Azure ポータルのアプリの登録画面Azure AD のアプリ登録の画面がアップデートしており、リダイレクト URI の登録に SPA が追加されていた。">
<meta property="og:locale">
<meta property="og:image" content="http://blog.haniyama.com/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-new-redirect-uri.png">
<meta property="og:image" content="http://blog.haniyama.com/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-spa.png">
<meta property="og:image" content="http://blog.haniyama.com/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-quick-start.png">
<meta property="og:image" content="http://blog.haniyama.com/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-quick-start-spa.png">
<meta property="og:image" content="http://blog.haniyama.com/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-quick-start-notice.png">
<meta property="og:image" content="http://blog.haniyama.com/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-quick-start-download-sample.png">
<meta property="og:image" content="http://blog.haniyama.com/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-settings-auth.png">
<meta property="og:image" content="http://blog.haniyama.com/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-settings-manifest.png">
<meta property="og:image" content="http://blog.haniyama.com/2020/06/02/aad-spa-auth-code-grant-with-pkce/sample-top.png">
<meta property="og:image" content="http://blog.haniyama.com/2020/06/02/aad-spa-auth-code-grant-with-pkce/AADSTS900144.png">
<meta property="article:published_time" content="2020-06-02T09:23:00.000Z">
<meta property="article:modified_time" content="2022-05-18T13:45:28.985Z">
<meta property="article:author" content="watahani">
<meta property="article:tag" content="Azure">
<meta property="article:tag" content="OAuth">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.haniyama.com/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-new-redirect-uri.png">
<meta name="twitter:creator" content="@watahani"><meta name="description"><meta name="keywords" content="Java, Javascript, AWS, GCP, PGP"><link rel="alternate" type="application/atom+xml" href="/atom.xml" title="enjoy struggling"><title>Azure AD の SPA 向け Authorize Code Flow with PKCE (MSAL.js 2.x) - enjoy struggling</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.png"><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create', 'UA-113476970-1', 'auto');ga('send', 'pageview');</script><meta name="generator" content="Hexo 6.3.0"><link rel="stylesheet" href="/css/prism-atom-dark.css" type="text/css"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a target="_blank" rel="noopener" href="https://github.com/watahani"><span>Github</span></a></li><li><a target="_blank" rel="noopener" href="https://qiita.com/watahani"><span>Qiita</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><link rel="amphtml" href="./amp/index.html"><label class="navi-button light" for="navi">MENU</label><img class="background" src="https://storage.googleapis.com/blog-haniyama/background-min.png"><div class="post-title"><h1 class="title">Azure AD の SPA 向け Authorize Code Flow with PKCE (MSAL.js 2.x)</h1><ul class="meta"><li><i class="icon icon-author"></i>watahani</li><li><i class="icon icon-clock"></i>60 Minutes</li><li><i class="icon icon-calendar"></i>June 2, 2020</li></ul></div></div><div class="article-content" style="max-width:800px"><p>Authorization Code Flow with PKCE に対応した MSAL.js 2.x がプレビューでリリースされていたので、触ってみたメモ。</p>
<h2 id="Azure-ポータルのアプリの登録画面"><a href="#Azure-ポータルのアプリの登録画面" class="headerlink" title="Azure ポータルのアプリの登録画面"></a>Azure ポータルのアプリの登録画面</h2><p>Azure AD のアプリ登録の画面がアップデートしており、リダイレクト URI の登録に SPA が追加されていた。</p>
<span id="more"></span>

<p><img src="/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-new-redirect-uri.png"></p>
<p>クリックするとこんな表示が。</p>
<p><img src="/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-spa.png"></p>
<blockquote>
<p>最新バージョンの MSAL.js では、PKCE と CORS で認証コード フローが使用されます。</p>
</blockquote>
<blockquote>
<p>リダイレクト URI は、PKCE での承認コード フローの対象となります。</p>
</blockquote>
<p>少しわかり辛いが、既定では MSAL.js 2.0 を利用した承認コード フロー (Authorize Code Flow) with <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc7636">PKCE</a> を利用する設定になったとのことらしい。</p>
<p>もちろん暗黙の付与にチェックを入れることで、引き続き Implicit Flow も利用できる。</p>
<h2 id="MSAL-js-2-0"><a href="#MSAL-js-2-0" class="headerlink" title="MSAL.js 2.0"></a>MSAL.js 2.0</h2><p>Microsoft が SPA 向けに提供している JavaScript 向けの認証ライブラリとしては以下の 3 つがある。なお ADAL は、古いエンドポイントを利用しているため、新規で開発する場合には選択肢から外そう。</p>
<ul>
<li>Authorize Code Grant を利用する <a target="_blank" rel="noopener" href="https://github.com/AzureAD/microsoft-authentication-library-for-js/tree/dev/lib/msal-browser">MSAL.js 2.x</a></li>
<li>Implicit Flow を利用する <a target="_blank" rel="noopener" href="https://github.com/AzureAD/microsoft-authentication-library-for-js/tree/dev/lib/msal-core">MSAL.js 1.x</a>  </li>
<li>Implicit Flow (v1 エンドポイント) を利用する ADAL.js</li>
</ul>
<p>今出ている MSAL.js 関連の記事は 1.x 系のものがほとんどだが、今後は 1.x 系なのか、2.x 系なのかしっかり見極めて読む必要がある。</p>
<h2 id="サンプルを動かす"><a href="#サンプルを動かす" class="headerlink" title="サンプルを動かす"></a>サンプルを動かす</h2><p>アプリ登録画面が更新され、サンプル コードを自動生成してくれるようになった。めっちゃ楽に動く。すごい便利。</p>
<p>クイックスタートからサンプルを作る。</p>
<p><img src="/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-quick-start.png"></p>
<blockquote>
<p>シングルページ アプリケーション (SPA) &gt; JavaScript (認証コード フロー) を選択</p>
</blockquote>
<p><img src="/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-quick-start-spa.png"></p>
<blockquote>
<p>既定で Code Grant を推してはいるけど、あくまで MSAL.js 2.x はプレビュー</p>
</blockquote>
<p><img src="/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-quick-start-notice.png"></p>
<p>あとは手順通りにボタンをポチポチしていくと、アプリ登録の設定変更を行い、client_id などを埋め込んだサンプルがダウンロードできる。</p>
<p> <code>これらの変更を行います</code> をクリックして、アプリの設定を更新したのち、コードサンプルをダウンロードする。</p>
<p><img src="/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-quick-start-download-sample.png"></p>
<p>自動で設定される内容はこんな感じ</p>
<p><img src="/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-settings-auth.png"></p>
<p>マニフェストには、<code>type: &quot;spa&quot;</code> として登録されている。</p>
<p><img src="/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-settings-manifest.png"></p>
<p>ダウンロードしたサンプルを解凍して、npm install &amp;&amp; npm start を実行すると <a target="_blank" rel="noopener" href="http://localhost:3000/">http://localhost:3000</a> でサンプルが動く。</p>
<p><img src="/2020/06/02/aad-spa-auth-code-grant-with-pkce/sample-top.png"></p>
<h2 id="認証の流れ"><a href="#認証の流れ" class="headerlink" title="認証の流れ"></a>認証の流れ</h2><p>Sign In をクリックすることで、Authorize Endpoint にリクエストが飛ぶ。</p>
<p>サンプルはマルチ テナントアプリなので、organizations エンドポイントに対し認証リクエストを送信する。</p>
<pre class="language-http" style="" tabindex="0"><code id="a6781e3f" class="language-http" data-prism-hydrate="{&quot;element&quot;:&quot;a6781e3f&quot;,&quot;language&quot;:&quot;http&quot;,&quot;code&quot;:&quot;\nhttps://login.microsoftonline.com/organizations/oauth2/v2.0/authorize?\n\nresponse_type=code\u0026\nscope=openid%20profile%20user.read%20offline_access&amp;\nclient_id=47a5a26f-13c5-4f59-84f8-6a57b8ede039&amp;\nredirect_uri=http%3A%2F%2Flocalhost%3A3000%2F&amp;\nstate=d57b6054-1930-422d-b707-fe840584790c&amp;\nnonce=2babda35-58fd-4d5c-9381-ed174e9214d3&amp;\nclient_info=1&amp;\nx-client-SKU=MSAL.JS&amp;\nx-client-Ver=1.0.0-beta.0&amp;\ncode_challenge=ZhDtcgD2hU8bRjD1Qpvhcrvm-J38iUvkovNdbbc3o0w&amp;\ncode_challenge_method=S256&amp;\nclient-request-id=303fc61d-7bbe-4f25-8430-5d11b7b5240f&amp;\nresponse_mode=fragment&amp;\nsso_reload=true\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token header\&quot;\u003e<span class=\&quot;token header-name keyword\&quot;>https</span><span class=\&quot;token punctuation\&quot;>:</span><span class=\&quot;token header-value\&quot;>//login.microsoftonline.com/organizations/oauth2/v2.0/authorize?</span></span>\n\nresponse_type=code&amp;amp;\nscope=openid%20profile%20user.read%20offline_access&amp;amp;\nclient_id=47a5a26f-13c5-4f59-84f8-6a57b8ede039&amp;amp;\nredirect_uri=http%3A%2F%2Flocalhost%3A3000%2F&amp;amp;\nstate=d57b6054-1930-422d-b707-fe840584790c&amp;amp;\nnonce=2babda35-58fd-4d5c-9381-ed174e9214d3&amp;amp;\nclient_info=1&amp;amp;\nx-client-SKU=MSAL.JS&amp;amp;\nx-client-Ver=1.0.0-beta.0&amp;amp;\ncode_challenge=ZhDtcgD2hU8bRjD1Qpvhcrvm-J38iUvkovNdbbc3o0w&amp;amp;\ncode_challenge_method=S256&amp;amp;\nclient-request-id=303fc61d-7bbe-4f25-8430-5d11b7b5240f&amp;amp;\nresponse_mode=fragment&amp;amp;\nsso_reload=true\n&quot;}">
<span class="token header"><span class="token header-name keyword">https</span><span class="token punctuation">:</span><span class="token header-value">//login.microsoftonline.com/organizations/oauth2/v2.0/authorize?</span></span>

response_type=code&amp;
scope=openid%20profile%20user.read%20offline_access&amp;
client_id=47a5a26f-13c5-4f59-84f8-6a57b8ede039&amp;
redirect_uri=http%3A%2F%2Flocalhost%3A3000%2F&amp;
state=d57b6054-1930-422d-b707-fe840584790c&amp;
nonce=2babda35-58fd-4d5c-9381-ed174e9214d3&amp;
client_info=1&amp;
x-client-SKU=MSAL.JS&amp;
x-client-Ver=1.0.0-beta.0&amp;
code_challenge=ZhDtcgD2hU8bRjD1Qpvhcrvm-J38iUvkovNdbbc3o0w&amp;
code_challenge_method=S256&amp;
client-request-id=303fc61d-7bbe-4f25-8430-5d11b7b5240f&amp;
response_mode=fragment&amp;
sso_reload=true
</code></pre>

<p>ポイントは、code_challenge と code_challenge_method が含まれていること。</p>
<blockquote>
<p>code_challenge&#x3D;ZhDtcgD2hU8bRjD1Qpvhcrvm-J38iUvkovNdbbc3o0w</p>
</blockquote>
<p>サインイン &amp; Consent 後、code が返却される</p>
<pre class="language-http" style="" tabindex="0"><code id="89243d3f" class="language-http" data-prism-hydrate="{&quot;element&quot;:&quot;89243d3f&quot;,&quot;language&quot;:&quot;http&quot;,&quot;code&quot;:&quot;\nhttp://localhost:3000/#\n\ncode=0.ASsArFzjubin3UihAruhjq...\u0026\nclient_info=eyJ1aWQiOiIxMTc1MGFiZS1kOWE2LTQ3MTYtOTdiNS03N2I0MzBjOGFmNjUiLCJ1dGlkIjoiYjllMzVjYWMtYTdiOC00OGRkLWExMDItYmJhMThlYWNhNTI0In0&amp;\nstate=0bf48805-be5d-404f-9f9a-c31fc321a292&amp;\nsession_state=c1f74a08-8442-486c-bb75-107298d6dc7e\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token header\&quot;\u003e<span class=\&quot;token header-name keyword\&quot;>http</span><span class=\&quot;token punctuation\&quot;>:</span><span class=\&quot;token header-value\&quot;>//localhost:3000/#</span></span>\n\ncode=0.ASsArFzjubin3UihAruhjq...&amp;amp;\nclient_info=eyJ1aWQiOiIxMTc1MGFiZS1kOWE2LTQ3MTYtOTdiNS03N2I0MzBjOGFmNjUiLCJ1dGlkIjoiYjllMzVjYWMtYTdiOC00OGRkLWExMDItYmJhMThlYWNhNTI0In0&amp;amp;\nstate=0bf48805-be5d-404f-9f9a-c31fc321a292&amp;amp;\nsession_state=c1f74a08-8442-486c-bb75-107298d6dc7e\n&quot;}">
<span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//localhost:3000/#</span></span>

code=0.ASsArFzjubin3UihAruhjq...&amp;
client_info=eyJ1aWQiOiIxMTc1MGFiZS1kOWE2LTQ3MTYtOTdiNS03N2I0MzBjOGFmNjUiLCJ1dGlkIjoiYjllMzVjYWMtYTdiOC00OGRkLWExMDItYmJhMThlYWNhNTI0In0&amp;
state=0bf48805-be5d-404f-9f9a-c31fc321a292&amp;
session_state=c1f74a08-8442-486c-bb75-107298d6dc7e
</code></pre>

<p>token エンドポイントへの POST リクエストには code_verifier を付与する。</p>
<pre class="language-http" style="" tabindex="0"><code id="9ab3c13e" class="language-http" data-prism-hydrate="{&quot;element&quot;:&quot;9ab3c13e&quot;,&quot;language&quot;:&quot;http&quot;,&quot;code&quot;:&quot;\nPOST https://login.microsoftonline.com/organizations/oauth2/v2.0/token HTTP/1.1\nHost: login.microsoftonline.com\nConnection: keep-alive\nContent-Length: 1052\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.61 Safari/537.36\ncontent-type: application/x-www-form-urlencoded\nAccept: */*\nOrigin: http://localhost:3000\nSec-Fetch-Site: cross-site\nSec-Fetch-Mode: cors\nSec-Fetch-Dest: empty\nReferer: http://localhost:3000/\nAccept-Encoding: gzip, deflate, br\nAccept-Language: en-US,en;q=0.9,ja-CA;q=0.8,ja;q=0.7\n\nclient_id=47a5a26f-13c5-4f59-84f8-6a57b8ede039\u0026\nscope=openid%20profile%20user.read%20offline_access&amp;\nredirect_uri=http%3A%2F%2Flocalhost%3A3000%2F&amp;\ncode=0.ASsArFzjubin3UihAruhjqylJG...&amp;\ncode_verifier=NUJGSXpNM1VEazlHVW9vYXRWb0o5RDJSTXI2Q1l3WGI&amp;\ngrant_type=authorization_code\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token request-line\&quot;\u003e<span class=\&quot;token method property\&quot;>POST</span> <span class=\&quot;token request-target url\&quot;>https://login.microsoftonline.com/organizations/oauth2/v2.0/token</span> <span class=\&quot;token http-version property\&quot;>HTTP/1.1</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Host</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>login.microsoftonline.com</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Connection</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>keep-alive</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Content-Length</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>1052</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>User-Agent</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.61 Safari/537.36</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>content-type</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>application/x-www-form-urlencoded</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Accept</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>*/*</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Origin</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>http://localhost:3000</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Sec-Fetch-Site</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>cross-site</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Sec-Fetch-Mode</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>cors</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Sec-Fetch-Dest</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>empty</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Referer</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>http://localhost:3000/</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Accept-Encoding</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>gzip, deflate, br</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Accept-Language</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>en-US,en;q=0.9,ja-CA;q=0.8,ja;q=0.7</span></span>\n\nclient_id=47a5a26f-13c5-4f59-84f8-6a57b8ede039&amp;amp;\nscope=openid%20profile%20user.read%20offline_access&amp;amp;\nredirect_uri=http%3A%2F%2Flocalhost%3A3000%2F&amp;amp;\ncode=0.ASsArFzjubin3UihAruhjqylJG...&amp;amp;\ncode_verifier=NUJGSXpNM1VEazlHVW9vYXRWb0o5RDJSTXI2Q1l3WGI&amp;amp;\ngrant_type=authorization_code\n&quot;}">
<span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">https://login.microsoftonline.com/organizations/oauth2/v2.0/token</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">login.microsoftonline.com</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">keep-alive</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">1052</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.61 Safari/537.36</span></span>
<span class="token header"><span class="token header-name keyword">content-type</span><span class="token punctuation">:</span> <span class="token header-value">application/x-www-form-urlencoded</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">*/*</span></span>
<span class="token header"><span class="token header-name keyword">Origin</span><span class="token punctuation">:</span> <span class="token header-value">http://localhost:3000</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Fetch-Site</span><span class="token punctuation">:</span> <span class="token header-value">cross-site</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Fetch-Mode</span><span class="token punctuation">:</span> <span class="token header-value">cors</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Fetch-Dest</span><span class="token punctuation">:</span> <span class="token header-value">empty</span></span>
<span class="token header"><span class="token header-name keyword">Referer</span><span class="token punctuation">:</span> <span class="token header-value">http://localhost:3000/</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate, br</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">en-US,en;q=0.9,ja-CA;q=0.8,ja;q=0.7</span></span>

client_id=47a5a26f-13c5-4f59-84f8-6a57b8ede039&amp;
scope=openid%20profile%20user.read%20offline_access&amp;
redirect_uri=http%3A%2F%2Flocalhost%3A3000%2F&amp;
code=0.ASsArFzjubin3UihAruhjqylJG...&amp;
code_verifier=NUJGSXpNM1VEazlHVW9vYXRWb0o5RDJSTXI2Q1l3WGI&amp;
grant_type=authorization_code
</code></pre>

<p>code_verifier の値を、SHA256 でハッシュを取ると、code_challenge の値と一致するはず。</p>
<pre class="language-powershell" style="" tabindex="0"><code id="19cf1b3e" class="language-powershell" data-prism-hydrate="{&quot;element&quot;:&quot;19cf1b3e&quot;,&quot;language&quot;:&quot;powershell&quot;,&quot;code&quot;:&quot;\n ConvertFrom-CodeVerifier - \u0027NUJGSXpNM1VEazlHVW9vYXRWb0o5RDJSTXI2Q1l3WGI'\n# ZhDtcgD2hU8bRjD1Qpvhcrvm-J38iUvkovNdbbc3o0w\n&quot;,&quot;highlightedCode&quot;:&quot;\n \u003cspan class=\&quot;token function\&quot;\u003eConvertFrom-CodeVerifier</span> <span class=\&quot;token operator\&quot;>-</span> <span class=\&quot;token string\&quot;>'NUJGSXpNM1VEazlHVW9vYXRWb0o5RDJSTXI2Q1l3WGI'</span>\n<span class=\&quot;token comment\&quot;># ZhDtcgD2hU8bRjD1Qpvhcrvm-J38iUvkovNdbbc3o0w</span>\n&quot;}">
 <span class="token function">ConvertFrom-CodeVerifier</span> <span class="token operator">-</span> <span class="token string">'NUJGSXpNM1VEazlHVW9vYXRWb0o5RDJSTXI2Q1l3WGI'</span>
<span class="token comment"># ZhDtcgD2hU8bRjD1Qpvhcrvm-J38iUvkovNdbbc3o0w</span>
</code></pre>

<p>code_verifier から code_challenge を計算する関数はこんな感じ。</p>
<script src="https://gist.github.com/watahani/57b91116335d4738e23918f5996d7553.js"></script>


<h2 id="エラーを発生させてみたメモ"><a href="#エラーを発生させてみたメモ" class="headerlink" title="エラーを発生させてみたメモ"></a>エラーを発生させてみたメモ</h2><h3 id="AADSTS50148-エラー"><a href="#AADSTS50148-エラー" class="headerlink" title="AADSTS50148 エラー"></a>AADSTS50148 エラー</h3><p>トークン リクエストを code_verifier を消したり、間違えたりして送ってみる。怒られる。</p>
<pre class="language-js" style="" tabindex="0"><code id="88760d3f" class="language-js" data-prism-hydrate="{&quot;element&quot;:&quot;88760d3f&quot;,&quot;language&quot;:&quot;js&quot;,&quot;code&quot;:&quot;\nu=\u0027https://login.microsoftonline.com/organizations/oauth2/v2.0/token'\ndata = {\n    \&quot;client_id\&quot;: \&quot;47a5a26f-13c5-4f59-84f8-6a57b8ede039\&quot;,\n    \&quot;scope\&quot;: \&quot;openid\&quot;,\n    \&quot;grant_type\&quot;: \&quot;authorization_code\&quot;,\n    \&quot;redirect_uri\&quot;: \&quot;http://localhost:3000/\&quot;,\n    \&quot;code\&quot;: code\n  }\n\nlet urlEncodedDataPairs = [];\nfor(let name in data ) {\n    urlEncodedDataPairs.push( encodeURIComponent( name ) + '=' + encodeURIComponent( data[name] ) );\n}\nurlEncodedData = urlEncodedDataPairs.join( '\u0026' ).replace( /%20/g, '+' );\n\nvar request = new XMLHttpRequest()\nrequest.addEventListener( 'load', function(event) {\n  console.log(event.target.response);\n});\nrequest.open(\&quot;POST\&quot;,u)\nrequest.setRequestHeader( 'Content-Type', 'application/x-www-form-urlencoded' )\n\nrequest.send(urlEncodedData)\n\n//{\&quot;error\&quot;:\&quot;invalid_grant\&quot;,\&quot;error_description\&quot;:\&quot;AADSTS50148: The code_verifier does not match the code_challenge supplied in the authorization request for PKCE.\\r\\nTrace ID: 5c4218e1-fa34-4609-bdb6-f3a63a918200\\r\\nCorrelation ID: 6957aeea-d8fd-43b7-bf3f-79c2a3654bde\\r\\nTimestamp: 2020-06-02 08:00:46Z\&quot;,\&quot;error_codes\&quot;:[50148],\&quot;timestamp\&quot;:\&quot;2020-06-02 08:00:46Z\&quot;,\&quot;trace_id\&quot;:\&quot;5c4218e1-fa34-4609-bdb6-f3a63a918200\&quot;,\&quot;correlation_id\&quot;:\&quot;6957aeea-d8fd-43b7-bf3f-79c2a3654bde\&quot;,\&quot;error_uri\&quot;:\&quot;https://login.microsoftonline.com/error?code=50148\&quot;}\n&quot;,&quot;highlightedCode&quot;:&quot;\nu\u003cspan class=\&quot;token operator\&quot;\u003e=</span><span class=\&quot;token string\&quot;>'https://login.microsoftonline.com/organizations/oauth2/v2.0/token'</span>\ndata <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token punctuation\&quot;>{</span>\n    <span class=\&quot;token string-property property\&quot;>\&quot;client_id\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;47a5a26f-13c5-4f59-84f8-6a57b8ede039\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string-property property\&quot;>\&quot;scope\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;openid\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string-property property\&quot;>\&quot;grant_type\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;authorization_code\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string-property property\&quot;>\&quot;redirect_uri\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;http://localhost:3000/\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string-property property\&quot;>\&quot;code\&quot;</span><span class=\&quot;token operator\&quot;>:</span> code\n  <span class=\&quot;token punctuation\&quot;>}</span>\n\n<span class=\&quot;token keyword\&quot;>let</span> urlEncodedDataPairs <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token punctuation\&quot;>[</span><span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token keyword\&quot;>for</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token keyword\&quot;>let</span> name <span class=\&quot;token keyword\&quot;>in</span> data <span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token punctuation\&quot;>{</span>\n    urlEncodedDataPairs<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>push</span><span class=\&quot;token punctuation\&quot;>(</span> <span class=\&quot;token function\&quot;>encodeURIComponent</span><span class=\&quot;token punctuation\&quot;>(</span> name <span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token operator\&quot;>+</span> <span class=\&quot;token string\&quot;>'='</span> <span class=\&quot;token operator\&quot;>+</span> <span class=\&quot;token function\&quot;>encodeURIComponent</span><span class=\&quot;token punctuation\&quot;>(</span> data<span class=\&quot;token punctuation\&quot;>[</span>name<span class=\&quot;token punctuation\&quot;>]</span> <span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token punctuation\&quot;>}</span>\nurlEncodedData <span class=\&quot;token operator\&quot;>=</span> urlEncodedDataPairs<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>join</span><span class=\&quot;token punctuation\&quot;>(</span> <span class=\&quot;token string\&quot;>'&amp;amp;'</span> <span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>replace</span><span class=\&quot;token punctuation\&quot;>(</span> <span class=\&quot;token regex\&quot;><span class=\&quot;token regex-delimiter\&quot;>/</span><span class=\&quot;token regex-source language-regex\&quot;>%20</span><span class=\&quot;token regex-delimiter\&quot;>/</span><span class=\&quot;token regex-flags\&quot;>g</span></span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token string\&quot;>'+'</span> <span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n\n<span class=\&quot;token keyword\&quot;>var</span> request <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token keyword\&quot;>new</span> <span class=\&quot;token class-name\&quot;>XMLHttpRequest</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\nrequest<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>addEventListener</span><span class=\&quot;token punctuation\&quot;>(</span> <span class=\&quot;token string\&quot;>'load'</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token keyword\&quot;>function</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>event</span><span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token punctuation\&quot;>{</span>\n  console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>event<span class=\&quot;token punctuation\&quot;>.</span>target<span class=\&quot;token punctuation\&quot;>.</span>response<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\nrequest<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>open</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;POST\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>u<span class=\&quot;token punctuation\&quot;>)</span>\nrequest<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>setRequestHeader</span><span class=\&quot;token punctuation\&quot;>(</span> <span class=\&quot;token string\&quot;>'Content-Type'</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token string\&quot;>'application/x-www-form-urlencoded'</span> <span class=\&quot;token punctuation\&quot;>)</span>\n\nrequest<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>send</span><span class=\&quot;token punctuation\&quot;>(</span>urlEncodedData<span class=\&quot;token punctuation\&quot;>)</span>\n\n<span class=\&quot;token comment\&quot;>//{\&quot;error\&quot;:\&quot;invalid_grant\&quot;,\&quot;error_description\&quot;:\&quot;AADSTS50148: The code_verifier does not match the code_challenge supplied in the authorization request for PKCE.\\r\\nTrace ID: 5c4218e1-fa34-4609-bdb6-f3a63a918200\\r\\nCorrelation ID: 6957aeea-d8fd-43b7-bf3f-79c2a3654bde\\r\\nTimestamp: 2020-06-02 08:00:46Z\&quot;,\&quot;error_codes\&quot;:[50148],\&quot;timestamp\&quot;:\&quot;2020-06-02 08:00:46Z\&quot;,\&quot;trace_id\&quot;:\&quot;5c4218e1-fa34-4609-bdb6-f3a63a918200\&quot;,\&quot;correlation_id\&quot;:\&quot;6957aeea-d8fd-43b7-bf3f-79c2a3654bde\&quot;,\&quot;error_uri\&quot;:\&quot;https://login.microsoftonline.com/error?code=50148\&quot;}</span>\n&quot;}">
u<span class="token operator">=</span><span class="token string">'https://login.microsoftonline.com/organizations/oauth2/v2.0/token'</span>
data <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string-property property">"client_id"</span><span class="token operator">:</span> <span class="token string">"47a5a26f-13c5-4f59-84f8-6a57b8ede039"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"scope"</span><span class="token operator">:</span> <span class="token string">"openid"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"grant_type"</span><span class="token operator">:</span> <span class="token string">"authorization_code"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"redirect_uri"</span><span class="token operator">:</span> <span class="token string">"http://localhost:3000/"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"code"</span><span class="token operator">:</span> code
  <span class="token punctuation">}</span>

<span class="token keyword">let</span> urlEncodedDataPairs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> name <span class="token keyword">in</span> data <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    urlEncodedDataPairs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span> name <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'='</span> <span class="token operator">+</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span> data<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
urlEncodedData <span class="token operator">=</span> urlEncodedDataPairs<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span> <span class="token string">'&amp;'</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">%20</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'+'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
request<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span> <span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
request<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">,</span>u<span class="token punctuation">)</span>
request<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span> <span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'application/x-www-form-urlencoded'</span> <span class="token punctuation">)</span>

request<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>urlEncodedData<span class="token punctuation">)</span>

<span class="token comment">//{"error":"invalid_grant","error_description":"AADSTS50148: The code_verifier does not match the code_challenge supplied in the authorization request for PKCE.\r\nTrace ID: 5c4218e1-fa34-4609-bdb6-f3a63a918200\r\nCorrelation ID: 6957aeea-d8fd-43b7-bf3f-79c2a3654bde\r\nTimestamp: 2020-06-02 08:00:46Z","error_codes":[50148],"timestamp":"2020-06-02 08:00:46Z","trace_id":"5c4218e1-fa34-4609-bdb6-f3a63a918200","correlation_id":"6957aeea-d8fd-43b7-bf3f-79c2a3654bde","error_uri":"https://login.microsoftonline.com/error?code=50148"}</span>
</code></pre>

<h3 id="AADSTS900144-エラー"><a href="#AADSTS900144-エラー" class="headerlink" title="AADSTS900144 エラー"></a>AADSTS900144 エラー</h3><p>code_challenge がない AuthZ リクエストを送ってみると AADSTS900144 エラーが発生する。</p>
<pre class="language-http" style="" tabindex="0"><code id="8ccce53e" class="language-http" data-prism-hydrate="{&quot;element&quot;:&quot;8ccce53e&quot;,&quot;language&quot;:&quot;http&quot;,&quot;code&quot;:&quot;\nhttps://login.microsoftonline.com/organizations/oauth2/v2.0/authorize?\n\nresponse_type=code\u0026\nscope=openid%20profile%20user.read%20offline_access&amp;\nclient_id=47a5a26f-13c5-4f59-84f8-6a57b8ede039&amp;\nredirect_uri=http%3A%2F%2Flocalhost%3A3000%2F&amp;\nstate=d57b6054-1930-422d-b707-fe840584790c&amp;\nnonce=2babda35-58fd-4d5c-9381-ed174e9214d3&amp;\nresponse_mode=fragment\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token header\&quot;\u003e<span class=\&quot;token header-name keyword\&quot;>https</span><span class=\&quot;token punctuation\&quot;>:</span><span class=\&quot;token header-value\&quot;>//login.microsoftonline.com/organizations/oauth2/v2.0/authorize?</span></span>\n\nresponse_type=code&amp;amp;\nscope=openid%20profile%20user.read%20offline_access&amp;amp;\nclient_id=47a5a26f-13c5-4f59-84f8-6a57b8ede039&amp;amp;\nredirect_uri=http%3A%2F%2Flocalhost%3A3000%2F&amp;amp;\nstate=d57b6054-1930-422d-b707-fe840584790c&amp;amp;\nnonce=2babda35-58fd-4d5c-9381-ed174e9214d3&amp;amp;\nresponse_mode=fragment\n&quot;}">
<span class="token header"><span class="token header-name keyword">https</span><span class="token punctuation">:</span><span class="token header-value">//login.microsoftonline.com/organizations/oauth2/v2.0/authorize?</span></span>

response_type=code&amp;
scope=openid%20profile%20user.read%20offline_access&amp;
client_id=47a5a26f-13c5-4f59-84f8-6a57b8ede039&amp;
redirect_uri=http%3A%2F%2Flocalhost%3A3000%2F&amp;
state=d57b6054-1930-422d-b707-fe840584790c&amp;
nonce=2babda35-58fd-4d5c-9381-ed174e9214d3&amp;
response_mode=fragment
</code></pre>
<p><img src="/2020/06/02/aad-spa-auth-code-grant-with-pkce/AADSTS900144.png"></p>
<h3 id="AADSTS9002327-エラー"><a href="#AADSTS9002327-エラー" class="headerlink" title="AADSTS9002327 エラー"></a>AADSTS9002327 エラー</h3><p>Code を取得して、ブラウザーの XHR リクエストではなく、PowerShell などでリクエストを送信してみると、AADSTS9002327 エラーが発生する。どこ見てるんだろ、あんま検証してない。</p>
<pre class="language-powershell" style="" tabindex="0"><code id="cbb0b63d" class="language-powershell" data-prism-hydrate="{&quot;element&quot;:&quot;cbb0b63d&quot;,&quot;language&quot;:&quot;powershell&quot;,&quot;code&quot;:&quot;\n$clientId = \u002747a5a26f-13c5-4f59-84f8-6a57b8ede039'\n$redirectUri='https://localhost:3000/'\n$tenantId = \&quot;organization\&quot;\n$tokenEndpont = \&quot;https://login.microsoftonline.com/$tenantId/oauth2/v2.0/token\&quot;\n$scope = \&quot;openid profile user.read offline_access\&quot;\n\n$code='0.ASsArFzjubin3Ui...'\n$codeVerifier = 'NUJGSXpNM1VEazlHVW9vYXRWb0o5RDJSTXI2Q1l3WGI'\n\n$postParams = @{\n    client_id = $clientId;\n    redirect_uri=$redirectUri;\n    grant_type = 'authorization_code';\n    scope = $scope;\n    code=$code;\n    code_verifier=$codeVerifier;\n}\n\n$body = (Invoke-WebRequest -Uri $tokenEndpont -Method POST -Body $postParams) | ConvertFrom-Json\n\n#Invoke-WebRequest : {\&quot;error\&quot;:\&quot;invalid_request\&quot;,\&quot;error_description\&quot;:\&quot;AADSTS9002327: Tokens issued for the 'Single-Page Application' client-type may only be redeemed via cross-origin requests.\\r\\nTrace ID: c739...\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token variable\&quot;\u003e$clientId</span> = <span class=\&quot;token string\&quot;>'47a5a26f-13c5-4f59-84f8-6a57b8ede039'</span>\n<span class=\&quot;token variable\&quot;>$redirectUri</span>=<span class=\&quot;token string\&quot;>'https://localhost:3000/'</span>\n<span class=\&quot;token variable\&quot;>$tenantId</span> = <span class=\&quot;token string\&quot;>\&quot;organization\&quot;</span>\n<span class=\&quot;token variable\&quot;>$tokenEndpont</span> = <span class=\&quot;token string\&quot;>\&quot;https://login.microsoftonline.com/<span class=\&quot;token variable\&quot;>$tenantId</span>/oauth2/v2.0/token\&quot;</span>\n<span class=\&quot;token variable\&quot;>$scope</span> = <span class=\&quot;token string\&quot;>\&quot;openid profile user.read offline_access\&quot;</span>\n\n<span class=\&quot;token variable\&quot;>$code</span>=<span class=\&quot;token string\&quot;>'0.ASsArFzjubin3Ui...'</span>\n<span class=\&quot;token variable\&quot;>$codeVerifier</span> = <span class=\&quot;token string\&quot;>'NUJGSXpNM1VEazlHVW9vYXRWb0o5RDJSTXI2Q1l3WGI'</span>\n\n<span class=\&quot;token variable\&quot;>$postParams</span> = @<span class=\&quot;token punctuation\&quot;>{</span>\n    client_id = <span class=\&quot;token variable\&quot;>$clientId</span><span class=\&quot;token punctuation\&quot;>;</span>\n    redirect_uri=<span class=\&quot;token variable\&quot;>$redirectUri</span><span class=\&quot;token punctuation\&quot;>;</span>\n    grant_type = <span class=\&quot;token string\&quot;>'authorization_code'</span><span class=\&quot;token punctuation\&quot;>;</span>\n    scope = <span class=\&quot;token variable\&quot;>$scope</span><span class=\&quot;token punctuation\&quot;>;</span>\n    code=<span class=\&quot;token variable\&quot;>$code</span><span class=\&quot;token punctuation\&quot;>;</span>\n    code_verifier=<span class=\&quot;token variable\&quot;>$codeVerifier</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token punctuation\&quot;>}</span>\n\n<span class=\&quot;token variable\&quot;>$body</span> = <span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token function\&quot;>Invoke-WebRequest</span> <span class=\&quot;token operator\&quot;>-</span>Uri <span class=\&quot;token variable\&quot;>$tokenEndpont</span> <span class=\&quot;token operator\&quot;>-</span>Method POST <span class=\&quot;token operator\&quot;>-</span>Body <span class=\&quot;token variable\&quot;>$postParams</span><span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token punctuation\&quot;>|</span> <span class=\&quot;token function\&quot;>ConvertFrom-Json</span>\n\n<span class=\&quot;token comment\&quot;>#Invoke-WebRequest : {\&quot;error\&quot;:\&quot;invalid_request\&quot;,\&quot;error_description\&quot;:\&quot;AADSTS9002327: Tokens issued for the 'Single-Page Application' client-type may only be redeemed via cross-origin requests.\\r\\nTrace ID: c739...</span>\n&quot;}">
<span class="token variable">$clientId</span> = <span class="token string">'47a5a26f-13c5-4f59-84f8-6a57b8ede039'</span>
<span class="token variable">$redirectUri</span>=<span class="token string">'https://localhost:3000/'</span>
<span class="token variable">$tenantId</span> = <span class="token string">"organization"</span>
<span class="token variable">$tokenEndpont</span> = <span class="token string">"https://login.microsoftonline.com/<span class="token variable">$tenantId</span>/oauth2/v2.0/token"</span>
<span class="token variable">$scope</span> = <span class="token string">"openid profile user.read offline_access"</span>

<span class="token variable">$code</span>=<span class="token string">'0.ASsArFzjubin3Ui...'</span>
<span class="token variable">$codeVerifier</span> = <span class="token string">'NUJGSXpNM1VEazlHVW9vYXRWb0o5RDJSTXI2Q1l3WGI'</span>

<span class="token variable">$postParams</span> = @<span class="token punctuation">{</span>
    client_id = <span class="token variable">$clientId</span><span class="token punctuation">;</span>
    redirect_uri=<span class="token variable">$redirectUri</span><span class="token punctuation">;</span>
    grant_type = <span class="token string">'authorization_code'</span><span class="token punctuation">;</span>
    scope = <span class="token variable">$scope</span><span class="token punctuation">;</span>
    code=<span class="token variable">$code</span><span class="token punctuation">;</span>
    code_verifier=<span class="token variable">$codeVerifier</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$body</span> = <span class="token punctuation">(</span><span class="token function">Invoke-WebRequest</span> <span class="token operator">-</span>Uri <span class="token variable">$tokenEndpont</span> <span class="token operator">-</span>Method POST <span class="token operator">-</span>Body <span class="token variable">$postParams</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">ConvertFrom-Json</span>

<span class="token comment">#Invoke-WebRequest : {"error":"invalid_request","error_description":"AADSTS9002327: Tokens issued for the 'Single-Page Application' client-type may only be redeemed via cross-origin requests.\r\nTrace ID: c739...</span>
</code></pre>

<h3 id="おまけ-AADSTS50076-エラー"><a href="#おまけ-AADSTS50076-エラー" class="headerlink" title="(おまけ) AADSTS50076 エラー"></a>(おまけ) AADSTS50076 エラー</h3><p>IP アドレスがっつり違うとこからリフレッシュトークン使ってみると、AADSTS50076 エラーが発生した。AIP が有効じゃないと出ないっぽい。</p>
<pre class="language-js" style="" tabindex="0"><code id="0f304a3f" class="language-js" data-prism-hydrate="{&quot;element&quot;:&quot;0f304a3f&quot;,&quot;language&quot;:&quot;js&quot;,&quot;code&quot;:&quot;\nu=\u0027https://login.microsoftonline.com/organizations/oauth2/v2.0/token'\ndata = {\n    \&quot;scope\&quot;: \&quot;openid\&quot;,\n    \&quot;grant_type\&quot;: \&quot;refresh_token\&quot;,\n    \&quot;redirect_uri\&quot;: \&quot;http://localhost:3000/\&quot;,\n    \&quot;refresh_token\&quot;: refresh_token\n  }\n\nlet urlEncodedDataPairs = [];\nfor(let name in data ) {\n    urlEncodedDataPairs.push( encodeURIComponent( name ) + '=' + encodeURIComponent( data[name] ) );\n}\nurlEncodedData = urlEncodedDataPairs.join( '\u0026' ).replace( /%20/g, '+' );\n\nvar request = new XMLHttpRequest()\nrequest.addEventListener( 'load', function(event) {\n  console.log(event.target.response);\n});\nrequest.open(\&quot;POST\&quot;,u)\nrequest.setRequestHeader( 'Content-Type', 'application/x-www-form-urlencoded' )\n\nrequest.send(urlEncodedData)\n// {\&quot;error\&quot;:\&quot;invalid_grant\&quot;,\&quot;error_description\&quot;:\&quot;AADSTS50076: Due to a configuration change made by your administrator, or because you moved to a new location, you must use multi-factor authentication to access '00000003-0000-0000-c000-000000000000'.\\r\\nTrace ID: 4fa9c1ce...\n&quot;,&quot;highlightedCode&quot;:&quot;\nu\u003cspan class=\&quot;token operator\&quot;\u003e=</span><span class=\&quot;token string\&quot;>'https://login.microsoftonline.com/organizations/oauth2/v2.0/token'</span>\ndata <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token punctuation\&quot;>{</span>\n    <span class=\&quot;token string-property property\&quot;>\&quot;scope\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;openid\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string-property property\&quot;>\&quot;grant_type\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;refresh_token\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string-property property\&quot;>\&quot;redirect_uri\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;http://localhost:3000/\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string-property property\&quot;>\&quot;refresh_token\&quot;</span><span class=\&quot;token operator\&quot;>:</span> refresh_token\n  <span class=\&quot;token punctuation\&quot;>}</span>\n\n<span class=\&quot;token keyword\&quot;>let</span> urlEncodedDataPairs <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token punctuation\&quot;>[</span><span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token keyword\&quot;>for</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token keyword\&quot;>let</span> name <span class=\&quot;token keyword\&quot;>in</span> data <span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token punctuation\&quot;>{</span>\n    urlEncodedDataPairs<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>push</span><span class=\&quot;token punctuation\&quot;>(</span> <span class=\&quot;token function\&quot;>encodeURIComponent</span><span class=\&quot;token punctuation\&quot;>(</span> name <span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token operator\&quot;>+</span> <span class=\&quot;token string\&quot;>'='</span> <span class=\&quot;token operator\&quot;>+</span> <span class=\&quot;token function\&quot;>encodeURIComponent</span><span class=\&quot;token punctuation\&quot;>(</span> data<span class=\&quot;token punctuation\&quot;>[</span>name<span class=\&quot;token punctuation\&quot;>]</span> <span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token punctuation\&quot;>}</span>\nurlEncodedData <span class=\&quot;token operator\&quot;>=</span> urlEncodedDataPairs<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>join</span><span class=\&quot;token punctuation\&quot;>(</span> <span class=\&quot;token string\&quot;>'&amp;amp;'</span> <span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>replace</span><span class=\&quot;token punctuation\&quot;>(</span> <span class=\&quot;token regex\&quot;><span class=\&quot;token regex-delimiter\&quot;>/</span><span class=\&quot;token regex-source language-regex\&quot;>%20</span><span class=\&quot;token regex-delimiter\&quot;>/</span><span class=\&quot;token regex-flags\&quot;>g</span></span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token string\&quot;>'+'</span> <span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n\n<span class=\&quot;token keyword\&quot;>var</span> request <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token keyword\&quot;>new</span> <span class=\&quot;token class-name\&quot;>XMLHttpRequest</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\nrequest<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>addEventListener</span><span class=\&quot;token punctuation\&quot;>(</span> <span class=\&quot;token string\&quot;>'load'</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token keyword\&quot;>function</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>event</span><span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token punctuation\&quot;>{</span>\n  console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>event<span class=\&quot;token punctuation\&quot;>.</span>target<span class=\&quot;token punctuation\&quot;>.</span>response<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\nrequest<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>open</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;POST\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>u<span class=\&quot;token punctuation\&quot;>)</span>\nrequest<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>setRequestHeader</span><span class=\&quot;token punctuation\&quot;>(</span> <span class=\&quot;token string\&quot;>'Content-Type'</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token string\&quot;>'application/x-www-form-urlencoded'</span> <span class=\&quot;token punctuation\&quot;>)</span>\n\nrequest<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>send</span><span class=\&quot;token punctuation\&quot;>(</span>urlEncodedData<span class=\&quot;token punctuation\&quot;>)</span>\n<span class=\&quot;token comment\&quot;>// {\&quot;error\&quot;:\&quot;invalid_grant\&quot;,\&quot;error_description\&quot;:\&quot;AADSTS50076: Due to a configuration change made by your administrator, or because you moved to a new location, you must use multi-factor authentication to access '00000003-0000-0000-c000-000000000000'.\\r\\nTrace ID: 4fa9c1ce...</span>\n&quot;}">
u<span class="token operator">=</span><span class="token string">'https://login.microsoftonline.com/organizations/oauth2/v2.0/token'</span>
data <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string-property property">"scope"</span><span class="token operator">:</span> <span class="token string">"openid"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"grant_type"</span><span class="token operator">:</span> <span class="token string">"refresh_token"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"redirect_uri"</span><span class="token operator">:</span> <span class="token string">"http://localhost:3000/"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"refresh_token"</span><span class="token operator">:</span> refresh_token
  <span class="token punctuation">}</span>

<span class="token keyword">let</span> urlEncodedDataPairs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> name <span class="token keyword">in</span> data <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    urlEncodedDataPairs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span> name <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'='</span> <span class="token operator">+</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span> data<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
urlEncodedData <span class="token operator">=</span> urlEncodedDataPairs<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span> <span class="token string">'&amp;'</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">%20</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'+'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
request<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span> <span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
request<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">,</span>u<span class="token punctuation">)</span>
request<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span> <span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'application/x-www-form-urlencoded'</span> <span class="token punctuation">)</span>

request<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>urlEncodedData<span class="token punctuation">)</span>
<span class="token comment">// {"error":"invalid_grant","error_description":"AADSTS50076: Due to a configuration change made by your administrator, or because you moved to a new location, you must use multi-factor authentication to access '00000003-0000-0000-c000-000000000000'.\r\nTrace ID: 4fa9c1ce...</span>
</code></pre>
<div class="related-post"><h3>関連記事</h3><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2019\12\06\azuread-b2c-fido2-custompolicy\" title="Azure B2C の FIDO2 サンプルを動かす" rel="bookmark">Azure B2C の FIDO2 サンプルを動かす</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2023\04\26\do-not-validate-ms-graph-token\" title="Microsoft Graph API のトークンを検証しないでください" rel="bookmark">Microsoft Graph API のトークンを検証しないでください</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2021\04\24\get-aad-token-using-powershell\" title="Azure AD のトークンを PowerShell で取得する" rel="bookmark">Azure AD のトークンを PowerShell で取得する</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2021\11\05\azure-portal-change-language\" title="Azure ポータルの言語をワンクリックで切り替える" rel="bookmark">Azure ポータルの言語をワンクリックで切り替える</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2019\09\23\azuread-b2c-can-not-connect-yahooid\" title="Azure AD B2C に Yahoo! ID を連携しようとして失敗した話" rel="bookmark">Azure AD B2C に Yahoo! ID を連携しようとして失敗した話</a></h3></div></li></ul></div></div><div class="article-meta" style="max-width:800px"><div class="tags"><i class="icon icon-tag"></i><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure/" rel="tag">Azure</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OAuth/" rel="tag">OAuth</a><span class="tag-list-count">6</span></li></ul></div></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2020/09/27/aad-external-identity-api-connector/"><i class="icon icon-arror-left"></i></a></li><li><a href="/2020/04/30/azure-storage-blob-content-type-nodejs/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/82p" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="https://twitter.com/watahani" title="Twitter" target="_blank"><i class="icon icon-twitter"></i></a></li><li><a href="https://www.facebook.com/haniyama.wataru" title="Facebook" target="_blank"><i class="icon icon-facebook"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2023 enjoy struggling<br><small>POWER BY <a href="https://hexo.io" target="_blank">HEXO</a></small><small>, THEME BY <a href="https://github.com/BoizZ/hexo-theme-laughing" target="_blank">LAUGHING</a></small></p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>