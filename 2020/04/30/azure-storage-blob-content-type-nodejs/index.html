<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description" content="半年に 1 回ぐらい Azure Storage Blob を触るんだけど、毎回 Content-Type をセットするのを忘れてハマっている。今回は nodejs で書いたので、忘れないようにメモ。 パッケージとして @azure&#x2F;storage-blob を使う。あとファイル検索のために glob もつかう。">
<meta property="og:type" content="article">
<meta property="og:title" content="Azure Storage Blob に Content-Type 付きでアップロードする">
<meta property="og:url" content="http://blog.haniyama.com/2020/04/30/azure-storage-blob-content-type-nodejs/index.html">
<meta property="og:site_name" content="enjoy struggling">
<meta property="og:description" content="半年に 1 回ぐらい Azure Storage Blob を触るんだけど、毎回 Content-Type をセットするのを忘れてハマっている。今回は nodejs で書いたので、忘れないようにメモ。 パッケージとして @azure&#x2F;storage-blob を使う。あとファイル検索のために glob もつかう。">
<meta property="og:locale">
<meta property="article:published_time" content="2020-04-30T13:15:38.000Z">
<meta property="article:modified_time" content="2022-05-18T13:45:28.994Z">
<meta property="article:author" content="watahani">
<meta property="article:tag" content="Azure">
<meta property="article:tag" content="javascript">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@watahani"><meta name="description"><meta name="keywords" content="Java, Javascript, AWS, GCP, PGP"><link rel="alternate" type="application/atom+xml" href="/atom.xml" title="enjoy struggling"><title>Azure Storage Blob に Content-Type 付きでアップロードする - enjoy struggling</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.png"><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create', 'UA-113476970-1', 'auto');ga('send', 'pageview');</script><meta name="generator" content="Hexo 6.3.0"><link rel="stylesheet" href="/css/prism-atom-dark.css" type="text/css"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a target="_blank" rel="noopener" href="https://github.com/watahani"><span>Github</span></a></li><li><a target="_blank" rel="noopener" href="https://qiita.com/watahani"><span>Qiita</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><link rel="amphtml" href="./amp/index.html"><label class="navi-button light" for="navi">MENU</label><img class="background" src="https://storage.googleapis.com/blog-haniyama/background-min.png"><div class="post-title"><h1 class="title">Azure Storage Blob に Content-Type 付きでアップロードする</h1><ul class="meta"><li><i class="icon icon-author"></i>watahani</li><li><i class="icon icon-clock"></i>33 Minutes</li><li><i class="icon icon-calendar"></i>April 30, 2020</li></ul></div></div><div class="article-content" style="max-width:800px"><p>半年に 1 回ぐらい Azure Storage Blob を触るんだけど、毎回 Content-Type をセットするのを忘れてハマっている。<br>今回は nodejs で書いたので、忘れないようにメモ。</p>
<p>パッケージとして <code>@azure/storage-blob</code> を使う。あとファイル検索のために <code>glob</code> もつかう。</p>
<span id="more"></span>

<pre class="language-js" style="" tabindex="0"><code id="eed0213e" class="language-js" data-prism-hydrate="{&quot;element&quot;:&quot;eed0213e&quot;,&quot;language&quot;:&quot;js&quot;,&quot;code&quot;:&quot;\nnpm install -S @azure/storage-blob glob\n&quot;,&quot;highlightedCode&quot;:&quot;\nnpm install \u003cspan class=\&quot;token operator\&quot;\u003e-</span><span class=\&quot;token constant\&quot;>S</span> @azure<span class=\&quot;token operator\&quot;>/</span>storage<span class=\&quot;token operator\&quot;>-</span>blob glob\n&quot;}">
npm install <span class="token operator">-</span><span class="token constant">S</span> @azure<span class="token operator">/</span>storage<span class="token operator">-</span>blob glob
</code></pre>

<p>とりあえずファイルをアップロードするサンプル。</p>
<pre class="language-js" style="" tabindex="0"><code id="caa8d63e" class="language-js" data-prism-hydrate="{&quot;element&quot;:&quot;caa8d63e&quot;,&quot;language&quot;:&quot;js&quot;,&quot;code&quot;:&quot;\nconst mime = require(\&quot;mime\&quot;);\nconst { BlobServiceClient } = require(\&quot;@azure/storage-blob\&quot;);\n\nconst AZURE_STORAGE_CONNECTION_STRING = \&quot;DefaultEndpointsProtocol=https;AccountName=xxxx;AccountKey=xxxxx;EndpointSuffix=core.windows.net\&quot;;\nconst fileName = \&quot;./file.html\&quot;;\nconst containerName = \&quot;$web\&quot;;\n\nasync function uploadToBlob(fileName) {\n  const blobServiceClient = await BlobServiceClient.fromConnectionString(\n    AZURE_STORAGE_CONNECTION_STRING\n  );\n\n  const containerClient = await blobServiceClient.getContainerClient(\n    containerName\n  );\n\n  const blockBlobClient = containerClient.getBlockBlobClient(\&quot;file.html\&quot;);\n  const data = fs.readFileSync(fileName);\n  const contentType = mime.getType(fileName);\n  const options = {\n    blobHTTPHeaders: {\n      blobContentType: contentType,\n    },\n  };\n\n  return await blockBlobClient.upload(data, data.length, options);\n}\n\nuploadToBlob(fileName)\n  .then((result) =\u003e console.log(result))\n  .catch((e) => console.error(e));\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token keyword\&quot;>const</span> mime <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token function\&quot;>require</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;mime\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token keyword\&quot;>const</span> <span class=\&quot;token punctuation\&quot;>{</span> BlobServiceClient <span class=\&quot;token punctuation\&quot;>}</span> <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token function\&quot;>require</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;@azure/storage-blob\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n\n<span class=\&quot;token keyword\&quot;>const</span> <span class=\&quot;token constant\&quot;>AZURE_STORAGE_CONNECTION_STRING</span> <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token string\&quot;>\&quot;DefaultEndpointsProtocol=https;AccountName=xxxx;AccountKey=xxxxx;EndpointSuffix=core.windows.net\&quot;</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token keyword\&quot;>const</span> fileName <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token string\&quot;>\&quot;./file.html\&quot;</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token keyword\&quot;>const</span> containerName <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token string\&quot;>\&quot;$web\&quot;</span><span class=\&quot;token punctuation\&quot;>;</span>\n\n<span class=\&quot;token keyword\&quot;>async</span> <span class=\&quot;token keyword\&quot;>function</span> <span class=\&quot;token function\&quot;>uploadToBlob</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>fileName</span><span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token punctuation\&quot;>{</span>\n  <span class=\&quot;token keyword\&quot;>const</span> blobServiceClient <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token keyword\&quot;>await</span> BlobServiceClient<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>fromConnectionString</span><span class=\&quot;token punctuation\&quot;>(</span>\n    <span class=\&quot;token constant\&quot;>AZURE_STORAGE_CONNECTION_STRING</span>\n  <span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n\n  <span class=\&quot;token keyword\&quot;>const</span> containerClient <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token keyword\&quot;>await</span> blobServiceClient<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>getContainerClient</span><span class=\&quot;token punctuation\&quot;>(</span>\n    containerName\n  <span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n\n  <span class=\&quot;token keyword\&quot;>const</span> blockBlobClient <span class=\&quot;token operator\&quot;>=</span> containerClient<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>getBlockBlobClient</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;file.html\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n  <span class=\&quot;token keyword\&quot;>const</span> data <span class=\&quot;token operator\&quot;>=</span> fs<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>readFileSync</span><span class=\&quot;token punctuation\&quot;>(</span>fileName<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n  <span class=\&quot;token keyword\&quot;>const</span> contentType <span class=\&quot;token operator\&quot;>=</span> mime<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>getType</span><span class=\&quot;token punctuation\&quot;>(</span>fileName<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n  <span class=\&quot;token keyword\&quot;>const</span> options <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token punctuation\&quot;>{</span>\n    <span class=\&quot;token literal-property property\&quot;>blobHTTPHeaders</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>{</span>\n      <span class=\&quot;token literal-property property\&quot;>blobContentType</span><span class=\&quot;token operator\&quot;>:</span> contentType<span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>;</span>\n\n  <span class=\&quot;token keyword\&quot;>return</span> <span class=\&quot;token keyword\&quot;>await</span> blockBlobClient<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>upload</span><span class=\&quot;token punctuation\&quot;>(</span>data<span class=\&quot;token punctuation\&quot;>,</span> data<span class=\&quot;token punctuation\&quot;>.</span>length<span class=\&quot;token punctuation\&quot;>,</span> options<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token punctuation\&quot;>}</span>\n\n<span class=\&quot;token function\&quot;>uploadToBlob</span><span class=\&quot;token punctuation\&quot;>(</span>fileName<span class=\&quot;token punctuation\&quot;>)</span>\n  <span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>result</span><span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>result<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n  <span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>catch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>e</span><span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>error</span><span class=\&quot;token punctuation\&quot;>(</span>e<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n&quot;}">
<span class="token keyword">const</span> mime <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"mime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> BlobServiceClient <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"@azure/storage-blob"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">AZURE_STORAGE_CONNECTION_STRING</span> <span class="token operator">=</span> <span class="token string">"DefaultEndpointsProtocol=https;AccountName=xxxx;AccountKey=xxxxx;EndpointSuffix=core.windows.net"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fileName <span class="token operator">=</span> <span class="token string">"./file.html"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> containerName <span class="token operator">=</span> <span class="token string">"$web"</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">uploadToBlob</span><span class="token punctuation">(</span><span class="token parameter">fileName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> blobServiceClient <span class="token operator">=</span> <span class="token keyword">await</span> BlobServiceClient<span class="token punctuation">.</span><span class="token function">fromConnectionString</span><span class="token punctuation">(</span>
    <span class="token constant">AZURE_STORAGE_CONNECTION_STRING</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> containerClient <span class="token operator">=</span> <span class="token keyword">await</span> blobServiceClient<span class="token punctuation">.</span><span class="token function">getContainerClient</span><span class="token punctuation">(</span>
    containerName
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> blockBlobClient <span class="token operator">=</span> containerClient<span class="token punctuation">.</span><span class="token function">getBlockBlobClient</span><span class="token punctuation">(</span><span class="token string">"file.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> contentType <span class="token operator">=</span> mime<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">blobHTTPHeaders</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">blobContentType</span><span class="token operator">:</span> contentType<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">await</span> blockBlobClient<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> data<span class="token punctuation">.</span>length<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">uploadToBlob</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

<p>ポイントは mime で Content-Type を判別して、blobContentType に突っ込む、ってこれ普通に node やってる人からしたあたりまえなのかな。公式サンプル無いのなんでなんだろ… すごい悩んだ。</p>
<p>まとめてアップロードする時は glob 使ってこんな感じ。</p>
<pre class="language-js" style="" tabindex="0"><code id="ed008e3d" class="language-js" data-prism-hydrate="{&quot;element&quot;:&quot;ed008e3d&quot;,&quot;language&quot;:&quot;js&quot;,&quot;code&quot;:&quot;\nasync function uploadFolderToBlob() {\n  const blobServiceClient = await BlobServiceClient.fromConnectionString(\n    AZURE_STORAGE_CONNECTION_STRING\n  );\n\n  const containerClient = await blobServiceClient.getContainerClient(\n    containerName\n  );\n\n  return Promise.all(\n    glob(\&quot;./public/**/*.*\&quot;, { nodir: true, sync: true }).map(async (fileName) =\u003e {\n      console.log(fileName);\n      const blockBlobClient = containerClient.getBlockBlobClient(fileName);\n      const data = fs.readFileSync(fileName);\n      const contentType = mime.getType(fileName);\n      const options = {\n        blobHTTPHeaders: {\n          blobContentType: contentType,\n        },\n      };\n      return await blockBlobClient.upload(data, data.length, options);\n    })\n  );\n}\n\nuploadFolderToBlob()\n  .then((results) => console.log(results))\n  .catch((e) => console.error(e));\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token keyword\&quot;>async</span> <span class=\&quot;token keyword\&quot;>function</span> <span class=\&quot;token function\&quot;>uploadFolderToBlob</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token punctuation\&quot;>{</span>\n  <span class=\&quot;token keyword\&quot;>const</span> blobServiceClient <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token keyword\&quot;>await</span> BlobServiceClient<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>fromConnectionString</span><span class=\&quot;token punctuation\&quot;>(</span>\n    <span class=\&quot;token constant\&quot;>AZURE_STORAGE_CONNECTION_STRING</span>\n  <span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n\n  <span class=\&quot;token keyword\&quot;>const</span> containerClient <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token keyword\&quot;>await</span> blobServiceClient<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>getContainerClient</span><span class=\&quot;token punctuation\&quot;>(</span>\n    containerName\n  <span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n\n  <span class=\&quot;token keyword\&quot;>return</span> Promise<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>all</span><span class=\&quot;token punctuation\&quot;>(</span>\n    <span class=\&quot;token function\&quot;>glob</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;./public/**/*.*\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token punctuation\&quot;>{</span> <span class=\&quot;token literal-property property\&quot;>nodir</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token boolean\&quot;>true</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>sync</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token boolean\&quot;>true</span> <span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>map</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token keyword\&quot;>async</span> <span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>fileName</span><span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token operator\&quot;>=></span> <span class=\&quot;token punctuation\&quot;>{</span>\n      console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>fileName<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n      <span class=\&quot;token keyword\&quot;>const</span> blockBlobClient <span class=\&quot;token operator\&quot;>=</span> containerClient<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>getBlockBlobClient</span><span class=\&quot;token punctuation\&quot;>(</span>fileName<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n      <span class=\&quot;token keyword\&quot;>const</span> data <span class=\&quot;token operator\&quot;>=</span> fs<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>readFileSync</span><span class=\&quot;token punctuation\&quot;>(</span>fileName<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n      <span class=\&quot;token keyword\&quot;>const</span> contentType <span class=\&quot;token operator\&quot;>=</span> mime<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>getType</span><span class=\&quot;token punctuation\&quot;>(</span>fileName<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n      <span class=\&quot;token keyword\&quot;>const</span> options <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token punctuation\&quot;>{</span>\n        <span class=\&quot;token literal-property property\&quot;>blobHTTPHeaders</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>{</span>\n          <span class=\&quot;token literal-property property\&quot;>blobContentType</span><span class=\&quot;token operator\&quot;>:</span> contentType<span class=\&quot;token punctuation\&quot;>,</span>\n        <span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>,</span>\n      <span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>;</span>\n      <span class=\&quot;token keyword\&quot;>return</span> <span class=\&quot;token keyword\&quot;>await</span> blockBlobClient<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>upload</span><span class=\&quot;token punctuation\&quot;>(</span>data<span class=\&quot;token punctuation\&quot;>,</span> data<span class=\&quot;token punctuation\&quot;>.</span>length<span class=\&quot;token punctuation\&quot;>,</span> options<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n    <span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span>\n  <span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token punctuation\&quot;>}</span>\n\n<span class=\&quot;token function\&quot;>uploadFolderToBlob</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n  <span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>results</span><span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>results<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n  <span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>catch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>e</span><span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>error</span><span class=\&quot;token punctuation\&quot;>(</span>e<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n&quot;}">
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">uploadFolderToBlob</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> blobServiceClient <span class="token operator">=</span> <span class="token keyword">await</span> BlobServiceClient<span class="token punctuation">.</span><span class="token function">fromConnectionString</span><span class="token punctuation">(</span>
    <span class="token constant">AZURE_STORAGE_CONNECTION_STRING</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> containerClient <span class="token operator">=</span> <span class="token keyword">await</span> blobServiceClient<span class="token punctuation">.</span><span class="token function">getContainerClient</span><span class="token punctuation">(</span>
    containerName
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
    <span class="token function">glob</span><span class="token punctuation">(</span><span class="token string">"./public/**/*.*"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">nodir</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">sync</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">fileName</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> blockBlobClient <span class="token operator">=</span> containerClient<span class="token punctuation">.</span><span class="token function">getBlockBlobClient</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> data <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> contentType <span class="token operator">=</span> mime<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">blobHTTPHeaders</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">blobContentType</span><span class="token operator">:</span> contentType<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> blockBlobClient<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> data<span class="token punctuation">.</span>length<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">uploadFolderToBlob</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

<p><code>Promise.all()</code> で Promise のリストを包んでやるのがポイント。相変わらず非同期処理の書き方が分かってないので、いつもググりながら書いてる。<br>試した感じ fileName が <code>./path/to/file</code> みたくなっても、いい感じにアップロードしてくれるらしい。<br>(上記の例だと <code>$web/path/to/file</code> にアップロードされる)</p>
<p>今年も 1&#x2F;3 が終わってしまった。そろそろ Azure AD B2C のカスタム ポリシーのまとめネタを書きたいけど、相変わらず全然わからんのでちょいネタでブログ更新。</p>
<div class="related-post"><h3>関連記事</h3><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2020\06\02\aad-spa-auth-code-grant-with-pkce\" title="Azure AD の SPA 向け Authorize Code Flow with PKCE (MSAL.js 2.x)" rel="bookmark">Azure AD の SPA 向け Authorize Code Flow with PKCE (MSAL.js 2.x)</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2021\11\05\azure-portal-change-language\" title="Azure ポータルの言語をワンクリックで切り替える" rel="bookmark">Azure ポータルの言語をワンクリックで切り替える</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2019\09\23\azuread-b2c-can-not-connect-yahooid\" title="Azure AD B2C に Yahoo! ID を連携しようとして失敗した話" rel="bookmark">Azure AD B2C に Yahoo! ID を連携しようとして失敗した話</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2019\12\06\azuread-b2c-fido2-custompolicy\" title="Azure B2C の FIDO2 サンプルを動かす" rel="bookmark">Azure B2C の FIDO2 サンプルを動かす</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2019\07\15\azuread-fido2-security-key-public-preview\" title="Azure AD の FIDO2 Security Key 対応のパブリックプレビューが来たー" rel="bookmark">Azure AD の FIDO2 Security Key 対応のパブリックプレビューが来たー</a></h3></div></li></ul></div></div><div class="article-meta" style="max-width:800px"><div class="tags"><i class="icon icon-tag"></i><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure/" rel="tag">Azure</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/" rel="tag">javascript</a><span class="tag-list-count">1</span></li></ul></div></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2020/06/02/aad-spa-auth-code-grant-with-pkce/"><i class="icon icon-arror-left"></i></a></li><li><a href="/2020/02/16/customize-aad-token-claims/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/82p" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="https://twitter.com/watahani" title="Twitter" target="_blank"><i class="icon icon-twitter"></i></a></li><li><a href="https://www.facebook.com/haniyama.wataru" title="Facebook" target="_blank"><i class="icon icon-facebook"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2024 enjoy struggling<br><small>POWER BY <a href="https://hexo.io" target="_blank">HEXO</a></small><small>, THEME BY <a href="https://github.com/BoizZ/hexo-theme-laughing" target="_blank">LAUGHING</a></small></p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>