<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description" content="プレビューの時に AWS が対応したと話題だった GitHub ID トークンとか呼ばれてた機能が正式発表された。  GitHub Actions: Secure cloud deployments with OpenID Connect | GitHub Changelog  ドキュメントを見ると、Azure AD との連携手順もしっかり公開されているので早速試してみた。ついでに az cli">
<meta property="og:type" content="article">
<meta property="og:title" content="GitHub Secure Deployments with OIDC を Azure AD で試す">
<meta property="og:url" content="http://blog.haniyama.com/2021/10/30/github-secure-deployments-with-oidc-for-azure/index.html">
<meta property="og:site_name" content="enjoy struggling">
<meta property="og:description" content="プレビューの時に AWS が対応したと話題だった GitHub ID トークンとか呼ばれてた機能が正式発表された。  GitHub Actions: Secure cloud deployments with OpenID Connect | GitHub Changelog  ドキュメントを見ると、Azure AD との連携手順もしっかり公開されているので早速試してみた。ついでに az cli">
<meta property="og:locale">
<meta property="og:image" content="http://blog.haniyama.com/2021/10/30/github-secure-deployments-with-oidc-for-azure/appreg01.png">
<meta property="og:image" content="http://blog.haniyama.com/2021/10/30/github-secure-deployments-with-oidc-for-azure/appreg02.png">
<meta property="og:image" content="http://blog.haniyama.com/2021/10/30/github-secure-deployments-with-oidc-for-azure/github-secrets.png">
<meta property="og:image" content="http://blog.haniyama.com/2021/10/30/github-secure-deployments-with-oidc-for-azure/githb-add-secrets.png">
<meta property="og:image" content="http://blog.haniyama.com/2021/10/30/github-secure-deployments-with-oidc-for-azure/jwtio.png">
<meta property="og:image" content="http://blog.haniyama.com/2021/10/30/github-secure-deployments-with-oidc-for-azure/appreg03.png">
<meta property="article:published_time" content="2021-10-30T13:00:00.000Z">
<meta property="article:modified_time" content="2022-05-18T13:45:29.067Z">
<meta property="article:author" content="watahani">
<meta property="article:tag" content="Azure">
<meta property="article:tag" content="GitHub">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.haniyama.com/2021/10/30/github-secure-deployments-with-oidc-for-azure/appreg01.png">
<meta name="twitter:creator" content="@watahani"><meta name="description"><meta name="keywords" content="Java, Javascript, AWS, GCP, PGP"><link rel="alternate" type="application/atom+xml" href="/atom.xml" title="enjoy struggling"><title>GitHub Secure Deployments with OIDC を Azure AD で試す - enjoy struggling</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.png"><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create', 'UA-113476970-1', 'auto');ga('send', 'pageview');</script><meta name="generator" content="Hexo 6.3.0"><link rel="stylesheet" href="/css/prism-atom-dark.css" type="text/css"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a target="_blank" rel="noopener" href="https://github.com/watahani"><span>Github</span></a></li><li><a target="_blank" rel="noopener" href="https://qiita.com/watahani"><span>Qiita</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><link rel="amphtml" href="./amp/index.html"><label class="navi-button light" for="navi">MENU</label><img class="background" src="https://storage.googleapis.com/blog-haniyama/background-min.png"><div class="post-title"><h1 class="title">GitHub Secure Deployments with OIDC を Azure AD で試す</h1><ul class="meta"><li><i class="icon icon-author"></i>watahani</li><li><i class="icon icon-clock"></i>59 Minutes</li><li><i class="icon icon-calendar"></i>October 30, 2021</li></ul></div></div><div class="article-content" style="max-width:800px"><p>プレビューの時に AWS が対応したと話題だった GitHub ID トークンとか呼ばれてた機能が正式発表された。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.blog/changelog/2021-10-27-github-actions-secure-cloud-deployments-with-openid-connect/">GitHub Actions: Secure cloud deployments with OpenID Connect | GitHub Changelog</a></li>
</ul>
<p>ドキュメントを見ると、Azure AD との連携手順もしっかり公開されているので早速試してみた。ついでに az cli でラッピングされているトークン取得の通信も調べてみた。</p>
<span id="more"></span>

<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>GitHub のようなソース管理ツールは、今や CI&#x2F;CD のプラットフォームとしても拡大している。いわゆる DevOps。GitHub にも多分に漏れず GitHub Actions という CI&#x2F;CD のシステムがある。</p>
<p>このような CI&#x2F;CD ツールを使うのに頭を悩ますのがクレデンシャルの管理である。GitHub Actions の場合、通常は Environment Variables としてシークレットや証明書などを格納して、GitHub Action から呼び出すことになるのだが、実際クレデンシャルをセキュアに保とうとすると有効期限を短く保だとか、ローテーションするだとかということに頭を悩ますことになる。</p>
<p>しかし、Secure cloud deployments with OpenID Connect (これ、正式名称なんですかね。話すとき伝えづらい。) を利用すると、GitHub 上にクレデンシャルをおかなくて済む。具体的には GitHub 側がワークフロー内だけで生成できる ID トークンを資格情報としてクラウドサービス側に送信し、署名とクレームを検証することで認証を行うことができる。</p>
<h2 id="設定手順"><a href="#設定手順" class="headerlink" title="設定手順"></a>設定手順</h2><p>手順もサンプルも <a target="_blank" rel="noopener" href="https://github.com/marketplace/actions/azure-login">azure&#x2F;login のリポジトリ</a> にあった。</p>
<p>説明するよりもやってみたほうが早いのでまずは Azure AD 側からセットアップする。手順は以下の通り。1, 2 はいつもの手順なので省略。</p>
<ol>
<li>アプリの登録</li>
<li>RBAC の割り当て</li>
<li>Federated Credentials に GitHub の情報をアプリに登録</li>
<li>GitHub Actions から呼び出し</li>
</ol>
<h3 id="Federated-Credentials-に-GitHub-の情報をアプリに登録"><a href="#Federated-Credentials-に-GitHub-の情報をアプリに登録" class="headerlink" title="Federated Credentials に GitHub の情報をアプリに登録"></a>Federated Credentials に GitHub の情報をアプリに登録</h3><p>アプリの登録で登録後、通常シークレット等を発行するための <code>証明書とシークレット</code> ブレードで <code>Federated Credentials</code> を選択し、資格情報の追加を選択する。</p>
<p><img src="/2021/10/30/github-secure-deployments-with-oidc-for-azure/appreg01.png" alt="appreg01.png"></p>
<p>色々入力項目があるが、organizations (個人リポジトリならユーザー名) と リポジトリ名を入力する。</p>
<p><img src="/2021/10/30/github-secure-deployments-with-oidc-for-azure/appreg02.png" alt="appreg02.png"></p>
<p>Entity Type (エンティティ型) というのは後で説明するが、GitHub 側の特定ブランチやタグがついてる時だけ認証できる、みたいな設定ができる。ここでは <code>ブランチ</code> を選択し <code>main</code> ブランチを対象のブランチに設定する。</p>
<p>ポイントとしては、この時点でサブジェクト識別子 (sub) が <code>repo:watahani/secure-deployments-for-azure-lab:ref:refs/heads/main</code> のようになっていること。これが実際に GitHub の ID トークンに含めるべき <code>sub</code> クレームになる。逆に言うと、ここで設定した <code>sub</code> が含まれていない場合、認証に失敗する。ちなみに AAD 側で受け入れ可能な audience は編集できるが az cli を使っている限り上述のパラメーターをいじることはなさそう。</p>
<h3 id="GitHub-Actions-側の設定"><a href="#GitHub-Actions-側の設定" class="headerlink" title="GitHub Actions 側の設定"></a>GitHub Actions 側の設定</h3><p>GitHub Actions 側の設定は <a target="_blank" rel="noopener" href="https://github.com/marketplace/actions/azure-login">azure&#x2F;login のリポジトリ</a> にサンプルがあるのでその通りに記載する。現状 az cli のベータバージョンが必要なのでインストールタスクが追加されているが、これがなくなれば <code>azure/login</code> を呼び出すだけで az login ができるようになるはず。(Installing CLI-beta for OpenID Connect の job が不要になるという意味)</p>
<pre class="language-yml" style="" tabindex="0"><code id="9040c73e" class="language-yml" data-prism-hydrate="{&quot;element&quot;:&quot;9040c73e&quot;,&quot;language&quot;:&quot;yml&quot;,&quot;code&quot;:&quot;\nname: Run Azure Login with OpenID Connect\n\n# main ブランチでだけ動くように修正\non:\n  push:\n    branches:\n      - main\n\npermissions:\n      id-token: write\n      \njobs: \n  build-and-deploy:\n    runs-on: ubuntu-latest\n    steps:\n        \n    - name: Installing CLI-beta for OpenID Connect\n      run: |\n        cd ../..\n        CWD=\&quot;$(pwd)\&quot;\n        python3 -m venv oidc-venv\n        . oidc-venv/bin/activate\n        echo \&quot;activated environment\&quot;\n        python3 -m pip install -q --upgrade pip\n        echo \&quot;started installing cli beta\&quot;\n        pip install -q --extra-index-url https://azcliprod.blob.core.windows.net/beta/simple/ azure-cli\n        echo \&quot;***************installed cli beta*******************\&quot;\n        echo \&quot;$CWD/oidc-venv/bin\&quot; \u003e> $GITHUB_PATH\n        \n    - name: \u0027Az CLI login'\n      uses: azure/login@v1.4.0\n      with:\n        client-id: ${{ secrets.AZURE_CLIENTID }}\n        tenant-id: ${{ secrets.AZURE_TENANTID }}\n        subscription-id: ${{ secrets.AZURE_SUBSCRIPTIONID }}\n\n    - name: 'Run az commands'\n      run: |\n        az account show\n        az group list\n        pwd \n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token key atrule\&quot;>name</span><span class=\&quot;token punctuation\&quot;>:</span> Run Azure Login with OpenID Connect\n\n<span class=\&quot;token comment\&quot;># main ブランチでだけ動くように修正</span>\n<span class=\&quot;token key atrule\&quot;>on</span><span class=\&quot;token punctuation\&quot;>:</span>\n  <span class=\&quot;token key atrule\&quot;>push</span><span class=\&quot;token punctuation\&quot;>:</span>\n    <span class=\&quot;token key atrule\&quot;>branches</span><span class=\&quot;token punctuation\&quot;>:</span>\n      <span class=\&quot;token punctuation\&quot;>-</span> main\n\n<span class=\&quot;token key atrule\&quot;>permissions</span><span class=\&quot;token punctuation\&quot;>:</span>\n      <span class=\&quot;token key atrule\&quot;>id-token</span><span class=\&quot;token punctuation\&quot;>:</span> write\n      \n<span class=\&quot;token key atrule\&quot;>jobs</span><span class=\&quot;token punctuation\&quot;>:</span> \n  <span class=\&quot;token key atrule\&quot;>build-and-deploy</span><span class=\&quot;token punctuation\&quot;>:</span>\n    <span class=\&quot;token key atrule\&quot;>runs-on</span><span class=\&quot;token punctuation\&quot;>:</span> ubuntu<span class=\&quot;token punctuation\&quot;>-</span>latest\n    <span class=\&quot;token key atrule\&quot;>steps</span><span class=\&quot;token punctuation\&quot;>:</span>\n        \n    <span class=\&quot;token punctuation\&quot;>-</span> <span class=\&quot;token key atrule\&quot;>name</span><span class=\&quot;token punctuation\&quot;>:</span> Installing CLI<span class=\&quot;token punctuation\&quot;>-</span>beta for OpenID Connect\n      <span class=\&quot;token key atrule\&quot;>run</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>|</span><span class=\&quot;token scalar string\&quot;>\n        cd ../..\n        CWD=\&quot;$(pwd)\&quot;\n        python3 -m venv oidc-venv\n        . oidc-venv/bin/activate\n        echo \&quot;activated environment\&quot;\n        python3 -m pip install -q --upgrade pip\n        echo \&quot;started installing cli beta\&quot;\n        pip install -q --extra-index-url https://azcliprod.blob.core.windows.net/beta/simple/ azure-cli\n        echo \&quot;***************installed cli beta*******************\&quot;\n        echo \&quot;$CWD/oidc-venv/bin\&quot; >> $GITHUB_PATH</span>\n        \n    <span class=\&quot;token punctuation\&quot;>-</span> <span class=\&quot;token key atrule\&quot;>name</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token string\&quot;>'Az CLI login'</span>\n      <span class=\&quot;token key atrule\&quot;>uses</span><span class=\&quot;token punctuation\&quot;>:</span> azure/login@v1.4.0\n      <span class=\&quot;token key atrule\&quot;>with</span><span class=\&quot;token punctuation\&quot;>:</span>\n        <span class=\&quot;token key atrule\&quot;>client-id</span><span class=\&quot;token punctuation\&quot;>:</span> $<span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token punctuation\&quot;>{</span> secrets.AZURE_CLIENTID <span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>}</span>\n        <span class=\&quot;token key atrule\&quot;>tenant-id</span><span class=\&quot;token punctuation\&quot;>:</span> $<span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token punctuation\&quot;>{</span> secrets.AZURE_TENANTID <span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>}</span>\n        <span class=\&quot;token key atrule\&quot;>subscription-id</span><span class=\&quot;token punctuation\&quot;>:</span> $<span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token punctuation\&quot;>{</span> secrets.AZURE_SUBSCRIPTIONID <span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>}</span>\n\n    <span class=\&quot;token punctuation\&quot;>-</span> <span class=\&quot;token key atrule\&quot;>name</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token string\&quot;>'Run az commands'</span>\n      <span class=\&quot;token key atrule\&quot;>run</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>|</span><span class=\&quot;token scalar string\&quot;>\n        az account show\n        az group list\n        pwd </span>\n&quot;}">
<span class="token key atrule">name</span><span class="token punctuation">:</span> Run Azure Login with OpenID Connect

<span class="token comment"># main ブランチでだけ動くように修正</span>
<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> main

<span class="token key atrule">permissions</span><span class="token punctuation">:</span>
      <span class="token key atrule">id-token</span><span class="token punctuation">:</span> write
      
<span class="token key atrule">jobs</span><span class="token punctuation">:</span> 
  <span class="token key atrule">build-and-deploy</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
        
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Installing CLI<span class="token punctuation">-</span>beta for OpenID Connect
      <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        cd ../..
        CWD="$(pwd)"
        python3 -m venv oidc-venv
        . oidc-venv/bin/activate
        echo "activated environment"
        python3 -m pip install -q --upgrade pip
        echo "started installing cli beta"
        pip install -q --extra-index-url https://azcliprod.blob.core.windows.net/beta/simple/ azure-cli
        echo "***************installed cli beta*******************"
        echo "$CWD/oidc-venv/bin" &gt;&gt; $GITHUB_PATH</span>
        
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'Az CLI login'</span>
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> azure/login@v1.4.0
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">client-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.AZURE_CLIENTID <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">tenant-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.AZURE_TENANTID <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">subscription-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.AZURE_SUBSCRIPTIONID <span class="token punctuation">}</span><span class="token punctuation">}</span>

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'Run az commands'</span>
      <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        az account show
        az group list
        pwd </span>
</code></pre>

<p>サンプルのままだと、push したらタスクが動いてしまうので、ちゃんと main ブランチだけで動くようにした方が良いだろう。今回はブランチ名を指定して federated credentials を作成したので、別ブランチで Action が動くとトークン取得に失敗してまう。</p>
<p>環境変数は、とりあえずリポジトリ全体の Secrets にでも突っ込んでおく。Environment を設定するなら Environment Secrets に入れればいいだろう。</p>
<p><img src="/2021/10/30/github-secure-deployments-with-oidc-for-azure/github-secrets.png" alt="github-secrets.png"><br><img src="/2021/10/30/github-secure-deployments-with-oidc-for-azure/githb-add-secrets.png" alt="github-add-secrets.png"></p>
<p>保存して push すると GitHub Actions が動いて、割り当てたリソースグループの情報が見えた。</p>
<pre class="language-json" style="" tabindex="0"><code id="7d11743f" class="language-json" data-prism-hydrate="{&quot;element&quot;:&quot;7d11743f&quot;,&quot;language&quot;:&quot;json&quot;,&quot;code&quot;:&quot;\n// az group list\n\n{\n  \&quot;environmentName\&quot;: \&quot;AzureCloud\&quot;,\n  \&quot;homeTenantId\&quot;: \&quot;***\&quot;,\n  \&quot;id\&quot;: \&quot;***\&quot;,\n  \&quot;isDefault\&quot;: true,\n  \&quot;managedByTenants\&quot;: [],\n  \&quot;name\&quot;: \&quot;My Subscription Name\&quot;,\n  \&quot;state\&quot;: \&quot;Enabled\&quot;,\n  \&quot;tenantId\&quot;: \&quot;***\&quot;,\n  \&quot;user\&quot;: {\n    \&quot;name\&quot;: \&quot;***\&quot;,\n    \&quot;type\&quot;: \&quot;servicePrincipal\&quot;\n  }\n}\n[\n  {\n    \&quot;id\&quot;: \&quot;/subscriptions/***/resourceGroups/gh-actions-branch\&quot;,\n    \&quot;location\&quot;: \&quot;eastus\&quot;,\n    \&quot;managedBy\&quot;: null,\n    \&quot;name\&quot;: \&quot;gh-actions-branch\&quot;,\n    \&quot;properties\&quot;: {\n      \&quot;provisioningState\&quot;: \&quot;Succeeded\&quot;\n    },\n    \&quot;tags\&quot;: {},\n    \&quot;type\&quot;: \&quot;Microsoft.Resources/resourceGroups\&quot;\n  }\n]\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token comment\&quot;\u003e// az group list</span>\n\n<span class=\&quot;token punctuation\&quot;>{</span>\n  <span class=\&quot;token property\&quot;>\&quot;environmentName\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;AzureCloud\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;homeTenantId\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;***\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;id\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;***\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;isDefault\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token boolean\&quot;>true</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;managedByTenants\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>[</span><span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;My Subscription Name\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;state\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;Enabled\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;tenantId\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;***\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;user\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>{</span>\n    <span class=\&quot;token property\&quot;>\&quot;name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;***\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token property\&quot;>\&quot;type\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;servicePrincipal\&quot;</span>\n  <span class=\&quot;token punctuation\&quot;>}</span>\n<span class=\&quot;token punctuation\&quot;>}</span>\n<span class=\&quot;token punctuation\&quot;>[</span>\n  <span class=\&quot;token punctuation\&quot;>{</span>\n    <span class=\&quot;token property\&quot;>\&quot;id\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;/subscriptions/***/resourceGroups/gh-actions-branch\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token property\&quot;>\&quot;location\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;eastus\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token property\&quot;>\&quot;managedBy\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token null keyword\&quot;>null</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token property\&quot;>\&quot;name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;gh-actions-branch\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token property\&quot;>\&quot;properties\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>{</span>\n      <span class=\&quot;token property\&quot;>\&quot;provisioningState\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;Succeeded\&quot;</span>\n    <span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token property\&quot;>\&quot;tags\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token property\&quot;>\&quot;type\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;Microsoft.Resources/resourceGroups\&quot;</span>\n  <span class=\&quot;token punctuation\&quot;>}</span>\n<span class=\&quot;token punctuation\&quot;>]</span>\n&quot;}">
<span class="token comment">// az group list</span>

<span class="token punctuation">{</span>
  <span class="token property">"environmentName"</span><span class="token operator">:</span> <span class="token string">"AzureCloud"</span><span class="token punctuation">,</span>
  <span class="token property">"homeTenantId"</span><span class="token operator">:</span> <span class="token string">"***"</span><span class="token punctuation">,</span>
  <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"***"</span><span class="token punctuation">,</span>
  <span class="token property">"isDefault"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">"managedByTenants"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"My Subscription Name"</span><span class="token punctuation">,</span>
  <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"Enabled"</span><span class="token punctuation">,</span>
  <span class="token property">"tenantId"</span><span class="token operator">:</span> <span class="token string">"***"</span><span class="token punctuation">,</span>
  <span class="token property">"user"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"***"</span><span class="token punctuation">,</span>
    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"servicePrincipal"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"/subscriptions/***/resourceGroups/gh-actions-branch"</span><span class="token punctuation">,</span>
    <span class="token property">"location"</span><span class="token operator">:</span> <span class="token string">"eastus"</span><span class="token punctuation">,</span>
    <span class="token property">"managedBy"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"gh-actions-branch"</span><span class="token punctuation">,</span>
    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"provisioningState"</span><span class="token operator">:</span> <span class="token string">"Succeeded"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"tags"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"Microsoft.Resources/resourceGroups"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre>

<h3 id="GitHub-ID-トークンの中身"><a href="#GitHub-ID-トークンの中身" class="headerlink" title="GitHub ID トークンの中身"></a>GitHub ID トークンの中身</h3><p>このままだと面白くないので、az cli のソースをみてトークンの取り方を調べてみようと思ったのだがソースがどこにあるかよくわからなかったので手探りで curl コマンドを叩くことにした。とはいえ ID トークンの取得はすでに先人たちが試してくれているので、その通りに記載する。</p>
<p>ACTIONS_ID_TOKEN_REQUEST_URL へはクエリパラメータとして aud を渡すことで、任意の Audience を ID トークンに埋め込めるようだった。</p>
<pre class="language-sh" style="" tabindex="0"><code id="5b1b6b3f" class="language-sh" data-prism-hydrate="{&quot;element&quot;:&quot;5b1b6b3f&quot;,&quot;language&quot;:&quot;sh&quot;,&quot;code&quot;:&quot;\nfederated_token=`curl -H \&quot;Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN\&quot; \&quot;$ACTIONS_ID_TOKEN_REQUEST_URL\u0026audience=api://AzureADTokenExchange\&quot; | jq -r \u0027.value'`\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token assign-left variable\&quot;\u003efederated_token</span><span class=\&quot;token operator\&quot;>=</span><span class=\&quot;token variable\&quot;><span class=\&quot;token variable\&quot;>`</span><span class=\&quot;token function\&quot;>curl</span> <span class=\&quot;token parameter variable\&quot;>-H</span> <span class=\&quot;token string\&quot;>\&quot;Authorization: bearer <span class=\&quot;token variable\&quot;>$ACTIONS_ID_TOKEN_REQUEST_TOKEN</span>\&quot;</span> <span class=\&quot;token string\&quot;>\&quot;<span class=\&quot;token variable\&quot;>$ACTIONS_ID_TOKEN_REQUEST_URL</span>&amp;amp;audience=api://AzureADTokenExchange\&quot;</span> <span class=\&quot;token operator\&quot;>|</span> jq <span class=\&quot;token parameter variable\&quot;>-r</span> <span class=\&quot;token string\&quot;>'.value'</span><span class=\&quot;token variable\&quot;>`</span></span>\n&quot;}">
<span class="token assign-left variable">federated_token</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">curl</span> <span class="token parameter variable">-H</span> <span class="token string">"Authorization: bearer <span class="token variable">$ACTIONS_ID_TOKEN_REQUEST_TOKEN</span>"</span> <span class="token string">"<span class="token variable">$ACTIONS_ID_TOKEN_REQUEST_URL</span>&amp;audience=api://AzureADTokenExchange"</span> <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> <span class="token string">'.value'</span><span class="token variable">`</span></span>
</code></pre>

<p>実際に取得したトークンがこんな感じ。</p>
<script src="https://gist.github.com/watahani/cad18acba1bc2ad655ee275558b1d2e4.js"></script>

<p>まずは、署名を検証するために openid-configuration を見に行く。</p>
<p><a target="_blank" rel="noopener" href="https://token.actions.githubusercontent.com/.well-known/openid-configuration">https://token.actions.githubusercontent.com/.well-known/openid-configuration</a></p>
<pre class="language-json" style="" tabindex="0"><code id="638e0b3f" class="language-json" data-prism-hydrate="{&quot;element&quot;:&quot;638e0b3f&quot;,&quot;language&quot;:&quot;json&quot;,&quot;code&quot;:&quot;\n{\n  \&quot;issuer\&quot;: \&quot;https://token.actions.githubusercontent.com\&quot;,\n  \&quot;jwks_uri\&quot;: \&quot;https://token.actions.githubusercontent.com/.well-known/jwks\&quot;,\n  \&quot;subject_types_supported\&quot;: [\n    \&quot;public\&quot;,\n    \&quot;pairwise\&quot;\n  ],\n  \&quot;response_types_supported\&quot;: [\n    \&quot;id_token\&quot;\n  ],\n  \&quot;claims_supported\&quot;: [\n    \&quot;sub\&quot;,\n    \&quot;aud\&quot;,\n    \&quot;exp\&quot;,\n    \&quot;iat\&quot;,\n    \&quot;iss\&quot;,\n    \&quot;jti\&quot;,\n    \&quot;nbf\&quot;,\n    \&quot;ref\&quot;,\n    \&quot;repository\&quot;,\n    \&quot;repository_owner\&quot;,\n    \&quot;run_id\&quot;,\n    \&quot;run_number\&quot;,\n    \&quot;run_attempt\&quot;,\n    \&quot;actor\&quot;,\n    \&quot;workflow\&quot;,\n    \&quot;head_ref\&quot;,\n    \&quot;base_ref\&quot;,\n    \&quot;event_name\&quot;,\n    \&quot;ref_type\&quot;,\n    \&quot;environment\&quot;,\n    \&quot;job_workflow_ref\&quot;\n  ],\n  \&quot;id_token_signing_alg_values_supported\&quot;: [\n    \&quot;RS256\&quot;\n  ],\n  \&quot;scopes_supported\&quot;: [\n    \&quot;openid\&quot;\n  ]\n}\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token punctuation\&quot;\u003e{</span>\n  <span class=\&quot;token property\&quot;>\&quot;issuer\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;https://token.actions.githubusercontent.com\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;jwks_uri\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;https://token.actions.githubusercontent.com/.well-known/jwks\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;subject_types_supported\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>[</span>\n    <span class=\&quot;token string\&quot;>\&quot;public\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string\&quot;>\&quot;pairwise\&quot;</span>\n  <span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;response_types_supported\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>[</span>\n    <span class=\&quot;token string\&quot;>\&quot;id_token\&quot;</span>\n  <span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;claims_supported\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>[</span>\n    <span class=\&quot;token string\&quot;>\&quot;sub\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string\&quot;>\&quot;aud\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string\&quot;>\&quot;exp\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string\&quot;>\&quot;iat\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string\&quot;>\&quot;iss\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string\&quot;>\&quot;jti\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string\&quot;>\&quot;nbf\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string\&quot;>\&quot;ref\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string\&quot;>\&quot;repository\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string\&quot;>\&quot;repository_owner\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string\&quot;>\&quot;run_id\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string\&quot;>\&quot;run_number\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string\&quot;>\&quot;run_attempt\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string\&quot;>\&quot;actor\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string\&quot;>\&quot;workflow\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string\&quot;>\&quot;head_ref\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string\&quot;>\&quot;base_ref\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string\&quot;>\&quot;event_name\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string\&quot;>\&quot;ref_type\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string\&quot;>\&quot;environment\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string\&quot;>\&quot;job_workflow_ref\&quot;</span>\n  <span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;id_token_signing_alg_values_supported\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>[</span>\n    <span class=\&quot;token string\&quot;>\&quot;RS256\&quot;</span>\n  <span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;scopes_supported\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>[</span>\n    <span class=\&quot;token string\&quot;>\&quot;openid\&quot;</span>\n  <span class=\&quot;token punctuation\&quot;>]</span>\n<span class=\&quot;token punctuation\&quot;>}</span>\n&quot;}">
<span class="token punctuation">{</span>
  <span class="token property">"issuer"</span><span class="token operator">:</span> <span class="token string">"https://token.actions.githubusercontent.com"</span><span class="token punctuation">,</span>
  <span class="token property">"jwks_uri"</span><span class="token operator">:</span> <span class="token string">"https://token.actions.githubusercontent.com/.well-known/jwks"</span><span class="token punctuation">,</span>
  <span class="token property">"subject_types_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"public"</span><span class="token punctuation">,</span>
    <span class="token string">"pairwise"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"response_types_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"id_token"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"claims_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"sub"</span><span class="token punctuation">,</span>
    <span class="token string">"aud"</span><span class="token punctuation">,</span>
    <span class="token string">"exp"</span><span class="token punctuation">,</span>
    <span class="token string">"iat"</span><span class="token punctuation">,</span>
    <span class="token string">"iss"</span><span class="token punctuation">,</span>
    <span class="token string">"jti"</span><span class="token punctuation">,</span>
    <span class="token string">"nbf"</span><span class="token punctuation">,</span>
    <span class="token string">"ref"</span><span class="token punctuation">,</span>
    <span class="token string">"repository"</span><span class="token punctuation">,</span>
    <span class="token string">"repository_owner"</span><span class="token punctuation">,</span>
    <span class="token string">"run_id"</span><span class="token punctuation">,</span>
    <span class="token string">"run_number"</span><span class="token punctuation">,</span>
    <span class="token string">"run_attempt"</span><span class="token punctuation">,</span>
    <span class="token string">"actor"</span><span class="token punctuation">,</span>
    <span class="token string">"workflow"</span><span class="token punctuation">,</span>
    <span class="token string">"head_ref"</span><span class="token punctuation">,</span>
    <span class="token string">"base_ref"</span><span class="token punctuation">,</span>
    <span class="token string">"event_name"</span><span class="token punctuation">,</span>
    <span class="token string">"ref_type"</span><span class="token punctuation">,</span>
    <span class="token string">"environment"</span><span class="token punctuation">,</span>
    <span class="token string">"job_workflow_ref"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"id_token_signing_alg_values_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"RS256"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"scopes_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"openid"</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>

<p><code>jkws_uri</code> から  <code>kid</code>: <code>DA6DD449E0E809599CECDFB3BDB6A2D7D0C2503A</code> の証明書を取ってきて <a target="_blank" rel="noopener" href="https://jwt.io/">jwt.io</a> に入れるとちゃんと検証できた。</p>
<p><img src="/2021/10/30/github-secure-deployments-with-oidc-for-azure/jwtio.png" alt="jwtio.png"></p>
<h4 id="クレームの中身"><a href="#クレームの中身" class="headerlink" title="クレームの中身"></a>クレームの中身</h4><p>Azure AD では多分 <code>sub</code> と <code>iss</code> ぐらいしか見てないが、色々情報が入っている。前述の通り aud はカスタマイズできるし、Azure AD 側でも変更できるので、それぞれが一致していれば認証は出来そう。(あんまやる意味ないけど)<br>ちなみに <code>environment</code> だけは Environment を作って動かさないと入ってこなかった。有効期限は 900 秒、ワークフローの中で何回発行できるか、などは試してない。</p>
<h4 id="sub-の中身"><a href="#sub-の中身" class="headerlink" title="sub の中身"></a>sub の中身</h4><p><code>sub</code> としては以下の 4 パターンがあるようで、それぞれのパターンで以下のような形式だった。</p>
<table>
<thead>
<tr>
<th>エンティティ型</th>
<th>trigger</th>
<th>sub</th>
</tr>
</thead>
<tbody><tr>
<td>ブランチ (Branch)</td>
<td>push</td>
<td>repo:{organization_name}&#x2F;{repository_name}:{branch_name}</td>
</tr>
<tr>
<td>タグ (Tag)</td>
<td>push&#x2F;tags</td>
<td>repo:{organization_name}&#x2F;{repository_name}:ref:refs&#x2F;tags&#x2F;{tag_name}</td>
</tr>
<tr>
<td>環境 (Environment)</td>
<td>push&#x2F;environment</td>
<td>repo:{organization_name}&#x2F;{repository_name}:environment:{environment_name}</td>
</tr>
<tr>
<td>Pull Request</td>
<td>pull_request</td>
<td>repo:{organization_name}&#x2F;{repository_name}:pull_request</td>
</tr>
</tbody></table>
<p>いちおうそれぞれ動かしてみた、<a target="_blank" rel="noopener" href="https://github.com/watahani/secure-deployments-for-azure-lab/tree/main/.github/workflows">サンプル</a> もおいておく。GitHub Actions の書き方あまり知らなくて、めちゃくちゃ試行錯誤したのでコミットログが汚い。</p>
<p>ちなみに Azure AD のアプリの登録から pull_request の sub を設定しようとすると、ポータルの問題で repo:{organization_name}&#x2F;{repository_name}:pull<code>-</code>request の形式になってしまう。(<code>_</code> が <code>-</code> になってる)</p>
<p>このせいで Pull Request ベースの Action が失敗しまくったのだがトークンの中身みても、しばらく何で失敗しているか分からなった。こういう間違いホントに気づけないから困るｗ</p>
<p>sub の値を直接編集すれば正しく動くので Pull Request のトリガーを設定したいときは、以下の通り設定しよう。速攻ポータルから Feedback しておいた。</p>
<p><img src="/2021/10/30/github-secure-deployments-with-oidc-for-azure/appreg03.png" alt="appreg03.png"></p>
<p>気になって <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/graph/api/application-post-federatedidentitycredentials?view=graph-rest-beta&tabs=http">Graph API のリファレンス</a> を漁ったところ sub を生で指定するようなので、多分ポータル側の問題のように見える。</p>
<h3 id="Azure-AD-との認証フロー"><a href="#Azure-AD-との認証フロー" class="headerlink" title="Azure AD との認証フロー"></a>Azure AD との認証フロー</h3><p>Azure AD への認証フローは、Client Credentials の client_assertion に入れれば良いんでしょ？と思って入れたら実際動いた。</p>
<p>あとで公式ドキュメントが見つかって (<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/workload-identity-federation">Workload identity federation - Microsoft identity platform | Microsoft Docs</a>) 見たら答えが書いてあったので、悩む必要はなかったが…。</p>
<p>なので、<a target="_blank" rel="noopener" href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow">Client Credentials Grant</a> でトークンを取るだけ。試しに management.azure.com の API をたたいて動くことを確認する。</p>
<pre class="language-sh" style="" tabindex="0"><code id="bbe2143f" class="language-sh" data-prism-hydrate="{&quot;element&quot;:&quot;bbe2143f&quot;,&quot;language&quot;:&quot;sh&quot;,&quot;code&quot;:&quot;\nazure_token=`curl -X POST https://login.microsoftonline.com/${AZURE_TENANTID}/oauth2/v2.0/token \\\n      -F client_id=${AZURE_CLIENTID} \\\n      -F grant_type=client_credentials \\\n      -F scope=https://management.azure.com/.default \\\n      -F client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer \\\n      -F client_assertion=${federated_token} | jq -r \u0027.access_token'`\ncurl -H \&quot;Authorization: Bearer $azure_token\&quot; https://management.azure.com/subscriptions/$AZURE_SUBSCRIPTIONID/resourcegroups?api-version=2021-04-01\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token assign-left variable\&quot;\u003eazure_token</span><span class=\&quot;token operator\&quot;>=</span><span class=\&quot;token variable\&quot;><span class=\&quot;token variable\&quot;>`</span><span class=\&quot;token function\&quot;>curl</span> <span class=\&quot;token parameter variable\&quot;>-X</span> POST https://login.microsoftonline.com/$<span class=\&quot;token punctuation\&quot;>{</span>AZURE_TENANTID<span class=\&quot;token punctuation\&quot;>}</span>/oauth2/v2.0/token <span class=\&quot;token punctuation\&quot;>\\</span>\n      <span class=\&quot;token parameter variable\&quot;>-F</span> <span class=\&quot;token assign-left variable\&quot;>client_id</span><span class=\&quot;token operator\&quot;>=</span>$<span class=\&quot;token punctuation\&quot;>{</span>AZURE_CLIENTID<span class=\&quot;token punctuation\&quot;>}</span> <span class=\&quot;token punctuation\&quot;>\\</span>\n      <span class=\&quot;token parameter variable\&quot;>-F</span> <span class=\&quot;token assign-left variable\&quot;>grant_type</span><span class=\&quot;token operator\&quot;>=</span>client_credentials <span class=\&quot;token punctuation\&quot;>\\</span>\n      <span class=\&quot;token parameter variable\&quot;>-F</span> <span class=\&quot;token assign-left variable\&quot;>scope</span><span class=\&quot;token operator\&quot;>=</span>https://management.azure.com/.default <span class=\&quot;token punctuation\&quot;>\\</span>\n      <span class=\&quot;token parameter variable\&quot;>-F</span> <span class=\&quot;token assign-left variable\&quot;>client_assertion_type</span><span class=\&quot;token operator\&quot;>=</span>urn:ietf:params:oauth:client-assertion-type:jwt-bearer <span class=\&quot;token punctuation\&quot;>\\</span>\n      <span class=\&quot;token parameter variable\&quot;>-F</span> <span class=\&quot;token assign-left variable\&quot;>client_assertion</span><span class=\&quot;token operator\&quot;>=</span>$<span class=\&quot;token punctuation\&quot;>{</span>federated_token<span class=\&quot;token punctuation\&quot;>}</span> <span class=\&quot;token operator\&quot;>|</span> jq <span class=\&quot;token parameter variable\&quot;>-r</span> <span class=\&quot;token string\&quot;>'.access_token'</span><span class=\&quot;token variable\&quot;>`</span></span>\n<span class=\&quot;token function\&quot;>curl</span> <span class=\&quot;token parameter variable\&quot;>-H</span> <span class=\&quot;token string\&quot;>\&quot;Authorization: Bearer <span class=\&quot;token variable\&quot;>$azure_token</span>\&quot;</span> https://management.azure.com/subscriptions/<span class=\&quot;token variable\&quot;>$AZURE_SUBSCRIPTIONID</span>/resourcegroups?api-version<span class=\&quot;token operator\&quot;>=</span><span class=\&quot;token number\&quot;>2021</span>-04-01\n&quot;}">
<span class="token assign-left variable">azure_token</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">curl</span> <span class="token parameter variable">-X</span> POST https://login.microsoftonline.com/$<span class="token punctuation">{</span>AZURE_TENANTID<span class="token punctuation">}</span>/oauth2/v2.0/token <span class="token punctuation">\</span>
      <span class="token parameter variable">-F</span> <span class="token assign-left variable">client_id</span><span class="token operator">=</span>$<span class="token punctuation">{</span>AZURE_CLIENTID<span class="token punctuation">}</span> <span class="token punctuation">\</span>
      <span class="token parameter variable">-F</span> <span class="token assign-left variable">grant_type</span><span class="token operator">=</span>client_credentials <span class="token punctuation">\</span>
      <span class="token parameter variable">-F</span> <span class="token assign-left variable">scope</span><span class="token operator">=</span>https://management.azure.com/.default <span class="token punctuation">\</span>
      <span class="token parameter variable">-F</span> <span class="token assign-left variable">client_assertion_type</span><span class="token operator">=</span>urn:ietf:params:oauth:client-assertion-type:jwt-bearer <span class="token punctuation">\</span>
      <span class="token parameter variable">-F</span> <span class="token assign-left variable">client_assertion</span><span class="token operator">=</span>$<span class="token punctuation">{</span>federated_token<span class="token punctuation">}</span> <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> <span class="token string">'.access_token'</span><span class="token variable">`</span></span>
<span class="token function">curl</span> <span class="token parameter variable">-H</span> <span class="token string">"Authorization: Bearer <span class="token variable">$azure_token</span>"</span> https://management.azure.com/subscriptions/<span class="token variable">$AZURE_SUBSCRIPTIONID</span>/resourcegroups?api-version<span class="token operator">=</span><span class="token number">2021</span>-04-01
</code></pre>

<p>全体のコードはこんな感じになる。</p>
<script src="https://gist.github.com/watahani/e831a19a4653a459847070b60909e02b.js"></script>

<p>アプリに必要な権限さえ与えておけば scope を呼び出す API ごとに設定することで Microsoft Graph や独自の API に対するトークン何かも取れると思う。個人のテスト テナントだったら GitHub Actions で定期ジョブとか組めそうで非常に良い。とはいえ、クレデンシャルが漏れないからといって安全というわけではないので、きちんと使うには GitHub Actions を勉強しましょう。</p>
<h3 id="所感"><a href="#所感" class="headerlink" title="所感"></a>所感</h3><p>AWS の IAM が GitHub OIDC に対応したとき Twitter ですごく盛り上がっていたが、あまり何のことか分かっておらず、今回触ってはじめて理解した。何で今まで無かったんだというレベルで良い。</p>
<p>GitHub Actions についてもこの前作ってみて、おおよその作り方も分かっているので、GitHub OIDC 使いつつ、検証用テナントの設定保存したりいじったりする GitHub Actions でも書いてみようかなー。</p>
<h3 id="蛇足な疑問"><a href="#蛇足な疑問" class="headerlink" title="蛇足な疑問"></a>蛇足な疑問</h3><p>Microsoft Graph API で <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/graph/api/application-post-federatedidentitycredentials?view=graph-rest-beta&tabs=http">federated Credentials 作成</a> のリファレンス見ると Azure AD から発行したトークンを、Client Credentials の assertion として使うようなサンプルが書いてある。</p>
<pre class="language-http" style="" tabindex="0"><code id="7330113f" class="language-http" data-prism-hydrate="{&quot;element&quot;:&quot;7330113f&quot;,&quot;language&quot;:&quot;http&quot;,&quot;code&quot;:&quot;\nPOST https://graph.microsoft.com/beta/applications/bcd7c908-1c4d-4d48-93ee-ff38349a75c8/federatedIdentityCredentials/\nContent-Type: application/json\n\n{\n    \&quot;name\&quot;: \&quot;testing02\&quot;,\n    \&quot;issuer\&quot;: \&quot;https://login.microsoftonline.com/3d1e2be9-a10a-4a0c-8380-7ce190f98ed9/v2.0\&quot;,\n    \&quot;subject\&quot;: \&quot;a7d388c3-5e3f-4959-ac7d-786b3383006a\&quot;,\n    \&quot;audiences\&quot;: [\n        \&quot;api://AzureADTokenExchange\&quot;\n    ]\n}\n&quot;,&quot;highlightedCode&quot;:&quot;\nPOST https://graph.microsoft.com/beta/applications/bcd7c908-1c4d-4d48-93ee-ff38349a75c8/federatedIdentityCredentials/\n\u003cspan class=\&quot;token header\&quot;\u003e<span class=\&quot;token header-name keyword\&quot;>Content-Type</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>application/json</span></span>\n<span class=\&quot;token application-json\&quot;>\n<span class=\&quot;token punctuation\&quot;>{</span>\n    <span class=\&quot;token string-property property\&quot;>\&quot;name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;testing02\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string-property property\&quot;>\&quot;issuer\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;https://login.microsoftonline.com/3d1e2be9-a10a-4a0c-8380-7ce190f98ed9/v2.0\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string-property property\&quot;>\&quot;subject\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;a7d388c3-5e3f-4959-ac7d-786b3383006a\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string-property property\&quot;>\&quot;audiences\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>[</span>\n        <span class=\&quot;token string\&quot;>\&quot;api://AzureADTokenExchange\&quot;</span>\n    <span class=\&quot;token punctuation\&quot;>]</span>\n<span class=\&quot;token punctuation\&quot;>}</span>\n</span>&quot;}">
POST https://graph.microsoft.com/beta/applications/bcd7c908-1c4d-4d48-93ee-ff38349a75c8/federatedIdentityCredentials/
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/json</span></span>
<span class="token application-json">
<span class="token punctuation">{</span>
    <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"testing02"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"issuer"</span><span class="token operator">:</span> <span class="token string">"https://login.microsoftonline.com/3d1e2be9-a10a-4a0c-8380-7ce190f98ed9/v2.0"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"subject"</span><span class="token operator">:</span> <span class="token string">"a7d388c3-5e3f-4959-ac7d-786b3383006a"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"audiences"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"api://AzureADTokenExchange"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</span></code></pre>

<p><code>openid-configuration</code> が読めて <code>sub</code> と <code>aud</code> さえあってればいいので、ユーザーの ID トークン使ってアプリ権限のアクセス トークンとる、とかも動きはしそう。使いどころは分からないけど。</p>
<p>その他に、気になる点としては、Trigger が複数条件あったときに何が優先されるかというのがドキュメントを読んでも良くわからず。例えば、以下のようなワークフローがあったときに、id_token の sub には何が入るのか。</p>
<pre class="language-yml" style="" tabindex="0"><code id="5999c73e" class="language-yml" data-prism-hydrate="{&quot;element&quot;:&quot;5999c73e&quot;,&quot;language&quot;:&quot;yml&quot;,&quot;code&quot;:&quot;\non: [push, pull_request]\n  branches:\n    - dev\n  tags:\n    - v1.0.0-beta\n\njobs: \n  development-build:\n    runs-on: ubuntu-latest\n    environment: development\n    steps:        \n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token key atrule\&quot;\u003eon</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>[</span>push<span class=\&quot;token punctuation\&quot;>,</span> pull_request<span class=\&quot;token punctuation\&quot;>]</span>\n  <span class=\&quot;token key atrule\&quot;>branches</span><span class=\&quot;token punctuation\&quot;>:</span>\n    <span class=\&quot;token punctuation\&quot;>-</span> dev\n  <span class=\&quot;token key atrule\&quot;>tags</span><span class=\&quot;token punctuation\&quot;>:</span>\n    <span class=\&quot;token punctuation\&quot;>-</span> v1.0.0<span class=\&quot;token punctuation\&quot;>-</span>beta\n\n<span class=\&quot;token key atrule\&quot;>jobs</span><span class=\&quot;token punctuation\&quot;>:</span> \n  <span class=\&quot;token key atrule\&quot;>development-build</span><span class=\&quot;token punctuation\&quot;>:</span>\n    <span class=\&quot;token key atrule\&quot;>runs-on</span><span class=\&quot;token punctuation\&quot;>:</span> ubuntu<span class=\&quot;token punctuation\&quot;>-</span>latest\n    <span class=\&quot;token key atrule\&quot;>environment</span><span class=\&quot;token punctuation\&quot;>:</span> development\n    <span class=\&quot;token key atrule\&quot;>steps</span><span class=\&quot;token punctuation\&quot;>:</span>        \n&quot;}">
<span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>push<span class="token punctuation">,</span> pull_request<span class="token punctuation">]</span>
  <span class="token key atrule">branches</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> dev
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> v1.0.0<span class="token punctuation">-</span>beta

<span class="token key atrule">jobs</span><span class="token punctuation">:</span> 
  <span class="token key atrule">development-build</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">environment</span><span class="token punctuation">:</span> development
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>        
</code></pre>

<p>GitHub Actions はあまり触ってないのでどんなワークフローを組むのが一般的なのかは分からないが、環境によっては発行される id_token の <code>sub</code> を気にしないといけないかもしれない。GitHub Actions 詳しい人教えてください。</p>
<h3 id="参考サイト"><a href="#参考サイト" class="headerlink" title="参考サイト"></a>参考サイト</h3><ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/workload-identity-federation">Workload identity federation - Microsoft identity platform | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect">About security hardening with OpenID Connect - GitHub Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://zenn.dev/mryhryki/articles/2021-09-19-access-aws-by-github-actions">GitHub Actions のIDトークンを使ってAWSリソースにアクセスする</a></li>
</ul>
<div class="related-post"><h3>関連記事</h3><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2020\06\02\aad-spa-auth-code-grant-with-pkce\" title="Azure AD の SPA 向け Authorize Code Flow with PKCE (MSAL.js 2.x)" rel="bookmark">Azure AD の SPA 向け Authorize Code Flow with PKCE (MSAL.js 2.x)</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2021\11\05\azure-portal-change-language\" title="Azure ポータルの言語をワンクリックで切り替える" rel="bookmark">Azure ポータルの言語をワンクリックで切り替える</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2019\09\23\azuread-b2c-can-not-connect-yahooid\" title="Azure AD B2C に Yahoo! ID を連携しようとして失敗した話" rel="bookmark">Azure AD B2C に Yahoo! ID を連携しようとして失敗した話</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2020\04\30\azure-storage-blob-content-type-nodejs\" title="Azure Storage Blob に Content-Type 付きでアップロードする" rel="bookmark">Azure Storage Blob に Content-Type 付きでアップロードする</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2019\12\06\azuread-b2c-fido2-custompolicy\" title="Azure B2C の FIDO2 サンプルを動かす" rel="bookmark">Azure B2C の FIDO2 サンプルを動かす</a></h3></div></li></ul></div></div><div class="article-meta" style="max-width:800px"><div class="tags"><i class="icon icon-tag"></i><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure/" rel="tag">Azure</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GitHub/" rel="tag">GitHub</a><span class="tag-list-count">1</span></li></ul></div></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2021/11/05/azure-portal-change-language/"><i class="icon icon-arror-left"></i></a></li><li><a href="/2021/04/24/get-aad-token-using-powershell/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/82p" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="https://twitter.com/watahani" title="Twitter" target="_blank"><i class="icon icon-twitter"></i></a></li><li><a href="https://www.facebook.com/haniyama.wataru" title="Facebook" target="_blank"><i class="icon icon-facebook"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2023 enjoy struggling<br><small>POWER BY <a href="https://hexo.io" target="_blank">HEXO</a></small><small>, THEME BY <a href="https://github.com/BoizZ/hexo-theme-laughing" target="_blank">LAUGHING</a></small></p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>