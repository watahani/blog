<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description" content="最近 CORS を改めて勉強したけど、やっぱり知識があいまいな部分があるので、一旦アウトプットとしてまとめておく。">
<meta property="og:type" content="article">
<meta property="og:title" content="自分的 CORS メモ">
<meta property="og:url" content="http://blog.haniyama.com/2021/04/24/cors/index.html">
<meta property="og:site_name" content="enjoy struggling">
<meta property="og:description" content="最近 CORS を改めて勉強したけど、やっぱり知識があいまいな部分があるので、一旦アウトプットとしてまとめておく。">
<meta property="og:locale">
<meta property="og:image" content="http://blog.haniyama.com/2021/04/24/cors/devtools01.png">
<meta property="og:image" content="http://blog.haniyama.com/2021/04/24/cors/devtools02.png">
<meta property="article:published_time" content="2021-04-24T06:46:00.000Z">
<meta property="article:modified_time" content="2022-05-18T13:45:29.038Z">
<meta property="article:author" content="watahani">
<meta property="article:tag" content="雑記">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.haniyama.com/2021/04/24/cors/devtools01.png">
<meta name="twitter:creator" content="@watahani"><meta name="description"><meta name="keywords" content="Java, Javascript, AWS, GCP, PGP"><link rel="alternate" type="application/atom+xml" href="/atom.xml" title="enjoy struggling"><title>自分的 CORS メモ - enjoy struggling</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.png"><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create', 'UA-113476970-1', 'auto');ga('send', 'pageview');</script><meta name="generator" content="Hexo 6.3.0"><link rel="stylesheet" href="/css/prism-atom-dark.css" type="text/css"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a target="_blank" rel="noopener" href="https://github.com/watahani"><span>Github</span></a></li><li><a target="_blank" rel="noopener" href="https://qiita.com/watahani"><span>Qiita</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><link rel="amphtml" href="./amp/index.html"><label class="navi-button light" for="navi">MENU</label><img class="background" src="https://storage.googleapis.com/blog-haniyama/background-min.png"><div class="post-title"><h1 class="title">自分的 CORS メモ</h1><ul class="meta"><li><i class="icon icon-author"></i>watahani</li><li><i class="icon icon-clock"></i>181 Minutes</li><li><i class="icon icon-calendar"></i>April 24, 2021</li></ul></div></div><div class="article-content" style="max-width:800px"><p>最近 CORS を改めて勉強したけど、やっぱり知識があいまいな部分があるので、一旦アウトプットとしてまとめておく。</p>
<span id="more"></span>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>とりあえず MDN を読んどけばなんとなく理解できる。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/ja/docs/Web/HTTP/CORS">オリジン間リソース共有 (CORS) - HTTP | MDN</a></li>
</ul>
<p>なんで CORS があるのって話。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://note.crohaco.net/2019/http-cors-preflight/">CORS とか Preflight とかよくわかんないよな - くろのて</a></li>
</ul>
<p>なんでできたのかみたいな話を調べていくと JSONP とかいう黒魔術の話がでて楽しそうだが、キリがなさそう。</p>
<p>TL で CORS 完全手冊という中国語のブログが紹介されており、Google 翻訳で読んだところすごくわかりやすかった。全部で 6 章あるが、自分が理解できたのは大体 3 章まで。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.huli.tw/2021/02/19/cors-guide-1/">CORS 完全手冊（一）：為什麼會發生 CORS 錯誤？ - Huli</a></li>
</ul>
<p>大体理解した後、日本語のドキュメントを探したけど、あんま良さげなのはなかった。<br>実用上は Qiita のこの記事読んどけば大丈夫そう。</p>
<p><a target="_blank" rel="noopener" href="https://qiita.com/tomoyukilabs/items/81698edd5812ff6acb34">CORSまとめ - Qiita</a></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://fetch.spec.whatwg.org/">Fetch Standard</a></li>
</ul>
<p>仕様は気になるところ (<a target="_blank" rel="noopener" href="https://fetch.spec.whatwg.org/#cors-preflight-fetch">preflight</a> のロジックあたり) だけつまみ読みした感じ。多くの人はここだけ読んでおけば十分だろうと思う。</p>
<h2 id="CORS-Step-0"><a href="#CORS-Step-0" class="headerlink" title="CORS Step 0"></a>CORS Step 0</h2><p>CORS の制約は Origin が異なるときに発生する。<a target="_blank" rel="noopener" href="https://html.spec.whatwg.org/multipage/origin.html#same-site">same site</a> とは異なり、same origin はスキーマとポート、ドメインがすべて一致する必要がある。<br><a target="_blank" rel="noopener" href="http://google.com/">http://google.com</a> と <a target="_blank" rel="noopener" href="https://www.google.com/">https://www.google.com</a> は same site だが same origin ではない。どうもスキーマが違う場合には schemelessly same site というらしいが…。</p>
<p>とにかく same origin ではないサイトへの XMLHttpRequest, fecth API を利用した通信が CROS でブロックされる。<br>F12 を押してブラウザーの DevTools を立ち上げ、コンソールに <code>fetch(&quot;https://google.com&quot;)</code> と打ってみる。</p>
<pre class="language-js" style="" tabindex="0"><code id="f17ee73d" class="language-js" data-prism-hydrate="{&quot;element&quot;:&quot;f17ee73d&quot;,&quot;language&quot;:&quot;js&quot;,&quot;code&quot;:&quot;\nfetch(\&quot;https://google.com\&quot;)\nPromise&nbsp;{\u003cpending\u003e}\n// cors.html:1 Access to fetch at \u0027https://google.com/' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.\n&quot;,&quot;highlightedCode&quot;:&quot;\n<span class=\&quot;token function\&quot;>fetch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;https://google.com\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span>\nPromise <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token operator\&quot;>\u0026lt;</span>pending<span class=\&quot;token operator\&quot;>></span><span class=\&quot;token punctuation\&quot;>}</span>\n<span class=\&quot;token comment\&quot;>// cors.html:1 Access to fetch at 'https://google.com/' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.</span>\n&quot;}">
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"https://google.com"</span><span class="token punctuation">)</span>
Promise <span class="token punctuation">{</span><span class="token operator">&lt;</span>pending<span class="token operator">&gt;</span><span class="token punctuation">}</span>
<span class="token comment">// cors.html:1 Access to fetch at 'https://google.com/' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.</span>
</code></pre>

<p>CORS ポリシーによりブロックされたと出る。リクエスト モードを no-cros にすれば opaque response を得られるとあるが、これは通信はするが JavaScript に値を返さずに、エラーも抑制されるモードで、たいていの場合は役に立たない。<a target="_blank" rel="noopener" href="https://blog.fullstacktraining.com/what-is-an-opaque-response/">opaque response でググると出てくるサイトによると</a> キャッシュ戦略に役立つらしいが今回は興味がないのでパス。</p>
<p>さて、CORS はサーバーの応答ヘッダーによりブラウザーが、通信を制御する仕様なので Google に通信を送ったって何も学べないので、適当なサーバーを立てる。</p>
<pre class="language-python" style="" tabindex="0"><code id="9fcf6e3f" class="language-python" data-prism-hydrate="{&quot;element&quot;:&quot;9fcf6e3f&quot;,&quot;language&quot;:&quot;python&quot;,&quot;code&quot;:&quot;\nfrom http.server import BaseHTTPRequestHandler, ThreadingHTTPServer\nimport logging\n\&quot;\&quot;\&quot;\nVery simple HTTP server in python for logging requests (for python 3.7 or later)\nUsage::\n    ./server.py [\u003cport\u003e]\n\&quot;\&quot;\&quot;\n\nclass S(BaseHTTPRequestHandler):\n    def _set_response(self, custom_headers = {}):\n        self.send_response(200)\n        self.end_headers()\n\n    def do_GET(self):\n        logging.info(\&quot;GET request,\\nPath: %s\\nHeaders:\\n%s\\n\&quot;,\n                     str(self.path), str(self.headers))\n        self._set_response()\n        self.wfile.write(\&quot;GET request for {},\\n\\nwith request headers: \\n{}\&quot;.format(\n            self.path, self.headers).encode(\u0027utf-8'))\n\ndef run(server_class=ThreadingHTTPServer, handler_class=S, port=8080):\n    logging.basicConfig(level=logging.INFO)\n    server_address = ('', port)\n    httpd = server_class(server_address, handler_class)\n    logging.info(\&quot;Starting httpd... port {}\\n\&quot;.format(str(port)))\n    try:\n        httpd.serve_forever()\n    except KeyboardInterrupt:\n        pass\n    httpd.server_close()\n    logging.info('Stopping httpd...\\n')\n\n\nif __name__ == '__main__':\n    from sys import argv\n\n    if len(argv) == 2:\n        run(port=int(argv[1]))\n    else:\n        run()\n&quot;,&quot;highlightedCode&quot;:&quot;\n<span class=\&quot;token keyword\&quot;>from</span> http<span class=\&quot;token punctuation\&quot;>.</span>server <span class=\&quot;token keyword\&quot;>import</span> BaseHTTPRequestHandler<span class=\&quot;token punctuation\&quot;>,</span> ThreadingHTTPServer\n<span class=\&quot;token keyword\&quot;>import</span> logging\n<span class=\&quot;token triple-quoted-string string\&quot;>\&quot;\&quot;\&quot;\nVery simple HTTP server in python for logging requests (for python 3.7 or later)\nUsage::\n    ./server.py [\u0026lt;port>]\n\&quot;\&quot;\&quot;</span>\n\n<span class=\&quot;token keyword\&quot;>class</span> <span class=\&quot;token class-name\&quot;>S</span><span class=\&quot;token punctuation\&quot;>(</span>BaseHTTPRequestHandler<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>:</span>\n    <span class=\&quot;token keyword\&quot;>def</span> <span class=\&quot;token function\&quot;>_set_response</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>,</span> custom_headers <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>:</span>\n        self<span class=\&quot;token punctuation\&quot;>.</span>send_response<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token number\&quot;>200</span><span class=\&quot;token punctuation\&quot;>)</span>\n        self<span class=\&quot;token punctuation\&quot;>.</span>end_headers<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n    <span class=\&quot;token keyword\&quot;>def</span> <span class=\&quot;token function\&quot;>do_GET</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>:</span>\n        logging<span class=\&quot;token punctuation\&quot;>.</span>info<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;GET request,\\nPath: %s\\nHeaders:\\n%s\\n\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n                     <span class=\&quot;token builtin\&quot;>str</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>.</span>path<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token builtin\&quot;>str</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>.</span>headers<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n        self<span class=\&quot;token punctuation\&quot;>.</span>_set_response<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n        self<span class=\&quot;token punctuation\&quot;>.</span>wfile<span class=\&quot;token punctuation\&quot;>.</span>write<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;GET request for {},\\n\\nwith request headers: \\n{}\&quot;</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token builtin\&quot;>format</span><span class=\&quot;token punctuation\&quot;>(</span>\n            self<span class=\&quot;token punctuation\&quot;>.</span>path<span class=\&quot;token punctuation\&quot;>,</span> self<span class=\&quot;token punctuation\&quot;>.</span>headers<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span>encode<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>'utf-8'</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n<span class=\&quot;token keyword\&quot;>def</span> <span class=\&quot;token function\&quot;>run</span><span class=\&quot;token punctuation\&quot;>(</span>server_class<span class=\&quot;token operator\&quot;>=</span>ThreadingHTTPServer<span class=\&quot;token punctuation\&quot;>,</span> handler_class<span class=\&quot;token operator\&quot;>=</span>S<span class=\&quot;token punctuation\&quot;>,</span> port<span class=\&quot;token operator\&quot;>=</span><span class=\&quot;token number\&quot;>8080</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>:</span>\n    logging<span class=\&quot;token punctuation\&quot;>.</span>basicConfig<span class=\&quot;token punctuation\&quot;>(</span>level<span class=\&quot;token operator\&quot;>=</span>logging<span class=\&quot;token punctuation\&quot;>.</span>INFO<span class=\&quot;token punctuation\&quot;>)</span>\n    server_address <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>''</span><span class=\&quot;token punctuation\&quot;>,</span> port<span class=\&quot;token punctuation\&quot;>)</span>\n    httpd <span class=\&quot;token operator\&quot;>=</span> server_class<span class=\&quot;token punctuation\&quot;>(</span>server_address<span class=\&quot;token punctuation\&quot;>,</span> handler_class<span class=\&quot;token punctuation\&quot;>)</span>\n    logging<span class=\&quot;token punctuation\&quot;>.</span>info<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;Starting httpd... port {}\\n\&quot;</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token builtin\&quot;>format</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token builtin\&quot;>str</span><span class=\&quot;token punctuation\&quot;>(</span>port<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n    <span class=\&quot;token keyword\&quot;>try</span><span class=\&quot;token punctuation\&quot;>:</span>\n        httpd<span class=\&quot;token punctuation\&quot;>.</span>serve_forever<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n    <span class=\&quot;token keyword\&quot;>except</span> KeyboardInterrupt<span class=\&quot;token punctuation\&quot;>:</span>\n        <span class=\&quot;token keyword\&quot;>pass</span>\n    httpd<span class=\&quot;token punctuation\&quot;>.</span>server_close<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n    logging<span class=\&quot;token punctuation\&quot;>.</span>info<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>'Stopping httpd...\\n'</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n\n<span class=\&quot;token keyword\&quot;>if</span> __name__ <span class=\&quot;token operator\&quot;>==</span> <span class=\&quot;token string\&quot;>'__main__'</span><span class=\&quot;token punctuation\&quot;>:</span>\n    <span class=\&quot;token keyword\&quot;>from</span> sys <span class=\&quot;token keyword\&quot;>import</span> argv\n\n    <span class=\&quot;token keyword\&quot;>if</span> <span class=\&quot;token builtin\&quot;>len</span><span class=\&quot;token punctuation\&quot;>(</span>argv<span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token operator\&quot;>==</span> <span class=\&quot;token number\&quot;>2</span><span class=\&quot;token punctuation\&quot;>:</span>\n        run<span class=\&quot;token punctuation\&quot;>(</span>port<span class=\&quot;token operator\&quot;>=</span><span class=\&quot;token builtin\&quot;>int</span><span class=\&quot;token punctuation\&quot;>(</span>argv<span class=\&quot;token punctuation\&quot;>[</span><span class=\&quot;token number\&quot;>1</span><span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n    <span class=\&quot;token keyword\&quot;>else</span><span class=\&quot;token punctuation\&quot;>:</span>\n        run<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n&quot;}">
<span class="token keyword">from</span> http<span class="token punctuation">.</span>server <span class="token keyword">import</span> BaseHTTPRequestHandler<span class="token punctuation">,</span> ThreadingHTTPServer
<span class="token keyword">import</span> logging
<span class="token triple-quoted-string string">"""
Very simple HTTP server in python for logging requests (for python 3.7 or later)
Usage::
    ./server.py [&lt;port&gt;]
"""</span>

<span class="token keyword">class</span> <span class="token class-name">S</span><span class="token punctuation">(</span>BaseHTTPRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">_set_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> custom_headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">do_GET</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"GET request,\nPath: %s\nHeaders:\n%s\n"</span><span class="token punctuation">,</span>
                     <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_set_response<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"GET request for {},\n\nwith request headers: \n{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>path<span class="token punctuation">,</span> self<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>server_class<span class="token operator">=</span>ThreadingHTTPServer<span class="token punctuation">,</span> handler_class<span class="token operator">=</span>S<span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>
    server_address <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span>
    httpd <span class="token operator">=</span> server_class<span class="token punctuation">(</span>server_address<span class="token punctuation">,</span> handler_class<span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Starting httpd... port {}\n"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        httpd<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
    httpd<span class="token punctuation">.</span>server_close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Stopping httpd...\n'</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> sys <span class="token keyword">import</span> argv

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
        run<span class="token punctuation">(</span>port<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>

<p>python server.py みたいにしたら動く。ThreadingHTTPServer は python 3.7 じゃないと動かないので、それ以上のバージョンを。あらためて、fetch を試して Python サーバーのログを見る。</p>
<pre class="language-javascript" style="" tabindex="0"><code id="0916043f" class="language-javascript" data-prism-hydrate="{&quot;element&quot;:&quot;0916043f&quot;,&quot;language&quot;:&quot;javascript&quot;,&quot;code&quot;:&quot;\nfetch(\&quot;http://localhost:8080/api\&quot;)\nPromise&nbsp;{\u003cpending\u003e}\n//Access to fetch at \u0027http://localhost:8080/api' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.\n&quot;,&quot;highlightedCode&quot;:&quot;\n<span class=\&quot;token function\&quot;>fetch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;http://localhost:8080/api\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span>\nPromise <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token operator\&quot;>\u0026lt;</span>pending<span class=\&quot;token operator\&quot;>></span><span class=\&quot;token punctuation\&quot;>}</span>\n<span class=\&quot;token comment\&quot;>//Access to fetch at 'http://localhost:8080/api' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.</span>\n&quot;}">
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/api"</span><span class="token punctuation">)</span>
Promise <span class="token punctuation">{</span><span class="token operator">&lt;</span>pending<span class="token operator">&gt;</span><span class="token punctuation">}</span>
<span class="token comment">//Access to fetch at 'http://localhost:8080/api' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.</span>
</code></pre>

<p>Google に送ったリクエストと同じく CORS のエラーが出ている。一方、Python サーバー側のログはこんなかんじで、リクエストが到達している。つまりレスポンスも返している。</p>
<pre class="language-log" style="" tabindex="0"><code id="0a574e3f" class="language-log" data-prism-hydrate="{&quot;element&quot;:&quot;0a574e3f&quot;,&quot;language&quot;:&quot;log&quot;,&quot;code&quot;:&quot;\nINFO:root:GET request,\nPath: /api\nHeaders:\nHost: localhost:8080\nConnection: keep-alive\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36 Edg/89.0.774.57\nAccept: */*\nOrigin: https://blog.haniyama.com\nSec-Fetch-Site: cross-site\nSec-Fetch-Mode: cors\nSec-Fetch-Dest: empty\nAccept-Encoding: gzip, deflate, br\nAccept-Language: ja,en-US;q=0.9,en;q=0.8\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token level info keyword\&quot;\u003eINFO</span><span class=\&quot;token operator\&quot;>:</span>root<span class=\&quot;token operator\&quot;>:</span>GET request<span class=\&quot;token punctuation\&quot;>,</span>\n<span class=\&quot;token property\&quot;>Path:</span> <span class=\&quot;token file-path string\&quot;>/api</span>\n<span class=\&quot;token property\&quot;>Headers:</span>\n<span class=\&quot;token property\&quot;>Host:</span> localhost<span class=\&quot;token operator\&quot;>:</span><span class=\&quot;token number\&quot;>8080</span>\n<span class=\&quot;token property\&quot;>Connection:</span> keep<span class=\&quot;token operator\&quot;>-</span>alive\n<span class=\&quot;token property\&quot;>User-Agent:</span> Mozilla<span class=\&quot;token operator\&quot;>/</span><span class=\&quot;token number\&quot;>5.0</span> <span class=\&quot;token operator\&quot;>(</span>Windows NT <span class=\&quot;token number\&quot;>10.0</span><span class=\&quot;token operator\&quot;>;</span> Win64<span class=\&quot;token operator\&quot;>;</span> x64<span class=\&quot;token operator\&quot;>)</span> AppleWebKit<span class=\&quot;token operator\&quot;>/</span><span class=\&quot;token number\&quot;>537.36</span> <span class=\&quot;token operator\&quot;>(</span>KHTML<span class=\&quot;token punctuation\&quot;>,</span> like Gecko<span class=\&quot;token operator\&quot;>)</span> Chrome<span class=\&quot;token operator\&quot;>/</span><span class=\&quot;token number\&quot;>89.0.4389.90</span> Safari<span class=\&quot;token operator\&quot;>/</span><span class=\&quot;token number\&quot;>537.36</span> Edg<span class=\&quot;token operator\&quot;>/</span><span class=\&quot;token ip-address constant\&quot;>89.0.774.57</span>\n<span class=\&quot;token property\&quot;>Accept:</span> <span class=\&quot;token operator\&quot;>*</span><span class=\&quot;token operator\&quot;>/</span><span class=\&quot;token operator\&quot;>*</span>\n<span class=\&quot;token property\&quot;>Origin:</span> <span class=\&quot;token url\&quot;>https://blog.haniyama.com</span>\n<span class=\&quot;token property\&quot;>Sec-Fetch-Site:</span> cross<span class=\&quot;token operator\&quot;>-</span>site\n<span class=\&quot;token property\&quot;>Sec-Fetch-Mode:</span> cors\n<span class=\&quot;token property\&quot;>Sec-Fetch-Dest:</span> empty\n<span class=\&quot;token property\&quot;>Accept-Encoding:</span> gzip<span class=\&quot;token punctuation\&quot;>,</span> deflate<span class=\&quot;token punctuation\&quot;>,</span> br\n<span class=\&quot;token property\&quot;>Accept-Language:</span> ja<span class=\&quot;token punctuation\&quot;>,</span>en<span class=\&quot;token operator\&quot;>-</span>US<span class=\&quot;token operator\&quot;>;</span>q<span class=\&quot;token operator\&quot;>=</span><span class=\&quot;token number\&quot;>0.9</span><span class=\&quot;token punctuation\&quot;>,</span>en<span class=\&quot;token operator\&quot;>;</span>q<span class=\&quot;token operator\&quot;>=</span><span class=\&quot;token number\&quot;>0.8</span>\n&quot;}">
<span class="token level info keyword">INFO</span><span class="token operator">:</span>root<span class="token operator">:</span>GET request<span class="token punctuation">,</span>
<span class="token property">Path:</span> <span class="token file-path string">/api</span>
<span class="token property">Headers:</span>
<span class="token property">Host:</span> localhost<span class="token operator">:</span><span class="token number">8080</span>
<span class="token property">Connection:</span> keep<span class="token operator">-</span>alive
<span class="token property">User-Agent:</span> Mozilla<span class="token operator">/</span><span class="token number">5.0</span> <span class="token operator">(</span>Windows NT <span class="token number">10.0</span><span class="token operator">;</span> Win64<span class="token operator">;</span> x64<span class="token operator">)</span> AppleWebKit<span class="token operator">/</span><span class="token number">537.36</span> <span class="token operator">(</span>KHTML<span class="token punctuation">,</span> like Gecko<span class="token operator">)</span> Chrome<span class="token operator">/</span><span class="token number">89.0.4389.90</span> Safari<span class="token operator">/</span><span class="token number">537.36</span> Edg<span class="token operator">/</span><span class="token ip-address constant">89.0.774.57</span>
<span class="token property">Accept:</span> <span class="token operator">*</span><span class="token operator">/</span><span class="token operator">*</span>
<span class="token property">Origin:</span> <span class="token url">https://blog.haniyama.com</span>
<span class="token property">Sec-Fetch-Site:</span> cross<span class="token operator">-</span>site
<span class="token property">Sec-Fetch-Mode:</span> cors
<span class="token property">Sec-Fetch-Dest:</span> empty
<span class="token property">Accept-Encoding:</span> gzip<span class="token punctuation">,</span> deflate<span class="token punctuation">,</span> br
<span class="token property">Accept-Language:</span> ja<span class="token punctuation">,</span>en<span class="token operator">-</span>US<span class="token operator">;</span>q<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span>en<span class="token operator">;</span>q<span class="token operator">=</span><span class="token number">0.8</span>
</code></pre>

<p>ブラウザーの DevTools では、レスポンスの内容は見えない。</p>
<p><img src="/2021/04/24/cors/devtools01.png"></p>
<p>Fiddler (http なので WireShark でも) などの通信トレースを取得するツールで通信をみると、確かにブラウザーがレスポンスを受け取っていることがわかる。</p>
<pre class="language-http" style="" tabindex="0"><code id="456e913e" class="language-http" data-prism-hydrate="{&quot;element&quot;:&quot;456e913e&quot;,&quot;language&quot;:&quot;http&quot;,&quot;code&quot;:&quot;\nHTTP/1.0 200 OK\nServer: BaseHTTP/0.6 Python/3.9.0\nDate: Mon, 22 Mar 2021 13:02:37 GMT\n\nGET request for /api,\n\nwith request headers: \nHost: localhost:8080\nConnection: keep-alive\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36 Edg/89.0.774.57\nAccept: */*\nOrigin: https://blog.haniyama.com\nSec-Fetch-Site: cross-site\nSec-Fetch-Mode: cors\nSec-Fetch-Dest: empty\nAccept-Encoding: gzip, deflate, br\nAccept-Language: ja,en-US;q=0.9,en;q=0.8\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token response-status\&quot;\u003e<span class=\&quot;token http-version property\&quot;>HTTP/1.0</span> <span class=\&quot;token status-code number\&quot;>200</span> <span class=\&quot;token reason-phrase string\&quot;>OK</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Server</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>BaseHTTP/0.6 Python/3.9.0</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Date</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>Mon, 22 Mar 2021 13:02:37 GMT</span></span>\n\nGET request for /api,\n\nwith request headers: \n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Host</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>localhost:8080</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Connection</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>keep-alive</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>User-Agent</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36 Edg/89.0.774.57</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Accept</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>*/*</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Origin</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>https://blog.haniyama.com</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Sec-Fetch-Site</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>cross-site</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Sec-Fetch-Mode</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>cors</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Sec-Fetch-Dest</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>empty</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Accept-Encoding</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>gzip, deflate, br</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Accept-Language</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>ja,en-US;q=0.9,en;q=0.8</span></span>\n&quot;}">
<span class="token response-status"><span class="token http-version property">HTTP/1.0</span> <span class="token status-code number">200</span> <span class="token reason-phrase string">OK</span></span>
<span class="token header"><span class="token header-name keyword">Server</span><span class="token punctuation">:</span> <span class="token header-value">BaseHTTP/0.6 Python/3.9.0</span></span>
<span class="token header"><span class="token header-name keyword">Date</span><span class="token punctuation">:</span> <span class="token header-value">Mon, 22 Mar 2021 13:02:37 GMT</span></span>

GET request for /api,

with request headers: 
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">localhost:8080</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">keep-alive</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36 Edg/89.0.774.57</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">*/*</span></span>
<span class="token header"><span class="token header-name keyword">Origin</span><span class="token punctuation">:</span> <span class="token header-value">https://blog.haniyama.com</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Fetch-Site</span><span class="token punctuation">:</span> <span class="token header-value">cross-site</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Fetch-Mode</span><span class="token punctuation">:</span> <span class="token header-value">cors</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Fetch-Dest</span><span class="token punctuation">:</span> <span class="token header-value">empty</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate, br</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">ja,en-US;q=0.9,en;q=0.8</span></span>
</code></pre>

<p>動かしてみればわかるが、ブラウザーはリクエストを送信し、レスポンスを受け取ったが、CORS を成功させるための条件を満たさなかったため、JavaScript へデータは渡さないことを選択した動作となっている。<br>CORS を判定するのは常にブラウザーであり、サーバー側でも JavaScript 側でもない。そのため、たとえば curl や Invoke-WebRequest など、ブラウザーではない API アクセスは問題なく成功する。</p>
<p>そして CORS を成功させるには、ブラウザーでも JavaScript でもなく、サーバー側を修正する必要がある。</p>
<p>※ ただし私の周りで起こる CORS の問題は、たいていサーバー側が何らかのエッジで、実際に修正ができないパターンのことが多い。というか仕組みを知っていれば当たり前なのだが、<a target="_blank" rel="noopener" href="https://docs.microsoft.com/ja-jp/azure/active-directory/manage-apps/application-proxy-understand-cors-issues">事前認証が有効な Azure AD アプリケーション プロキシは CORS に対応していない。</a></p>
<h2 id="CORS-Step-1-Access-Control-Allow-Origin"><a href="#CORS-Step-1-Access-Control-Allow-Origin" class="headerlink" title="CORS Step 1 (Access-Control-Allow-Origin)"></a>CORS Step 1 (Access-Control-Allow-Origin)</h2><p>ということでサーバーサイドのコードを修正してみる。</p>
<pre class="language-python" style="" tabindex="0"><code id="39171e3f" class="language-python" data-prism-hydrate="{&quot;element&quot;:&quot;39171e3f&quot;,&quot;language&quot;:&quot;python&quot;,&quot;code&quot;:&quot;\nfrom http.server import BaseHTTPRequestHandler, ThreadingHTTPServer\nimport logging\n\&quot;\&quot;\&quot;\nVery simple HTTP server in python for logging requests (for python 3.7 or later)\nUsage::\n    ./server.py [\u003cport\u003e]\n\&quot;\&quot;\&quot;\n\nclass S(BaseHTTPRequestHandler):\n    def _set_response(self, custom_headers = {}):\n        self.send_response(200)\n        # add header\n        self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;*\&quot;)\n        self.end_headers()\n\n    def do_GET(self):\n        logging.info(\&quot;GET request,\\nPath: %s\\nHeaders:\\n%s\\n\&quot;,\n                     str(self.path), str(self.headers))\n        self._set_response()\n        self.wfile.write(\&quot;GET request for {},\\n\\n with request headers: \\n {}\&quot;.format(\n            self.path, self.headers).encode(\u0027utf-8'))\n\ndef run(server_class=ThreadingHTTPServer, handler_class=S, port=8080):\n    logging.basicConfig(level=logging.INFO)\n    server_address = ('', port)\n    httpd = server_class(server_address, handler_class)\n    logging.info(\&quot;Starting httpd... port {}\\n\&quot;.format(str(port)))\n    try:\n        httpd.serve_forever()\n    except KeyboardInterrupt:\n        pass\n    httpd.server_close()\n    logging.info('Stopping httpd...\\n')\n\n\nif __name__ == '__main__':\n    from sys import argv\n\n    if len(argv) == 2:\n        run(port=int(argv[1]))\n    else:\n        run()\n&quot;,&quot;highlightedCode&quot;:&quot;\n<span class=\&quot;token keyword\&quot;>from</span> http<span class=\&quot;token punctuation\&quot;>.</span>server <span class=\&quot;token keyword\&quot;>import</span> BaseHTTPRequestHandler<span class=\&quot;token punctuation\&quot;>,</span> ThreadingHTTPServer\n<span class=\&quot;token keyword\&quot;>import</span> logging\n<span class=\&quot;token triple-quoted-string string\&quot;>\&quot;\&quot;\&quot;\nVery simple HTTP server in python for logging requests (for python 3.7 or later)\nUsage::\n    ./server.py [\u0026lt;port>]\n\&quot;\&quot;\&quot;</span>\n\n<span class=\&quot;token keyword\&quot;>class</span> <span class=\&quot;token class-name\&quot;>S</span><span class=\&quot;token punctuation\&quot;>(</span>BaseHTTPRequestHandler<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>:</span>\n    <span class=\&quot;token keyword\&quot;>def</span> <span class=\&quot;token function\&quot;>_set_response</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>,</span> custom_headers <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>:</span>\n        self<span class=\&quot;token punctuation\&quot;>.</span>send_response<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token number\&quot;>200</span><span class=\&quot;token punctuation\&quot;>)</span>\n        <span class=\&quot;token comment\&quot;># add header</span>\n        self<span class=\&quot;token punctuation\&quot;>.</span>send_header<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;Access-Control-Allow-Origin\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token string\&quot;>\&quot;*\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span>\n        self<span class=\&quot;token punctuation\&quot;>.</span>end_headers<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n    <span class=\&quot;token keyword\&quot;>def</span> <span class=\&quot;token function\&quot;>do_GET</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>:</span>\n        logging<span class=\&quot;token punctuation\&quot;>.</span>info<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;GET request,\\nPath: %s\\nHeaders:\\n%s\\n\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n                     <span class=\&quot;token builtin\&quot;>str</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>.</span>path<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token builtin\&quot;>str</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>.</span>headers<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n        self<span class=\&quot;token punctuation\&quot;>.</span>_set_response<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n        self<span class=\&quot;token punctuation\&quot;>.</span>wfile<span class=\&quot;token punctuation\&quot;>.</span>write<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;GET request for {},\\n\\n with request headers: \\n {}\&quot;</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token builtin\&quot;>format</span><span class=\&quot;token punctuation\&quot;>(</span>\n            self<span class=\&quot;token punctuation\&quot;>.</span>path<span class=\&quot;token punctuation\&quot;>,</span> self<span class=\&quot;token punctuation\&quot;>.</span>headers<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span>encode<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>'utf-8'</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n<span class=\&quot;token keyword\&quot;>def</span> <span class=\&quot;token function\&quot;>run</span><span class=\&quot;token punctuation\&quot;>(</span>server_class<span class=\&quot;token operator\&quot;>=</span>ThreadingHTTPServer<span class=\&quot;token punctuation\&quot;>,</span> handler_class<span class=\&quot;token operator\&quot;>=</span>S<span class=\&quot;token punctuation\&quot;>,</span> port<span class=\&quot;token operator\&quot;>=</span><span class=\&quot;token number\&quot;>8080</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>:</span>\n    logging<span class=\&quot;token punctuation\&quot;>.</span>basicConfig<span class=\&quot;token punctuation\&quot;>(</span>level<span class=\&quot;token operator\&quot;>=</span>logging<span class=\&quot;token punctuation\&quot;>.</span>INFO<span class=\&quot;token punctuation\&quot;>)</span>\n    server_address <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>''</span><span class=\&quot;token punctuation\&quot;>,</span> port<span class=\&quot;token punctuation\&quot;>)</span>\n    httpd <span class=\&quot;token operator\&quot;>=</span> server_class<span class=\&quot;token punctuation\&quot;>(</span>server_address<span class=\&quot;token punctuation\&quot;>,</span> handler_class<span class=\&quot;token punctuation\&quot;>)</span>\n    logging<span class=\&quot;token punctuation\&quot;>.</span>info<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;Starting httpd... port {}\\n\&quot;</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token builtin\&quot;>format</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token builtin\&quot;>str</span><span class=\&quot;token punctuation\&quot;>(</span>port<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n    <span class=\&quot;token keyword\&quot;>try</span><span class=\&quot;token punctuation\&quot;>:</span>\n        httpd<span class=\&quot;token punctuation\&quot;>.</span>serve_forever<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n    <span class=\&quot;token keyword\&quot;>except</span> KeyboardInterrupt<span class=\&quot;token punctuation\&quot;>:</span>\n        <span class=\&quot;token keyword\&quot;>pass</span>\n    httpd<span class=\&quot;token punctuation\&quot;>.</span>server_close<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n    logging<span class=\&quot;token punctuation\&quot;>.</span>info<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>'Stopping httpd...\\n'</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n\n<span class=\&quot;token keyword\&quot;>if</span> __name__ <span class=\&quot;token operator\&quot;>==</span> <span class=\&quot;token string\&quot;>'__main__'</span><span class=\&quot;token punctuation\&quot;>:</span>\n    <span class=\&quot;token keyword\&quot;>from</span> sys <span class=\&quot;token keyword\&quot;>import</span> argv\n\n    <span class=\&quot;token keyword\&quot;>if</span> <span class=\&quot;token builtin\&quot;>len</span><span class=\&quot;token punctuation\&quot;>(</span>argv<span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token operator\&quot;>==</span> <span class=\&quot;token number\&quot;>2</span><span class=\&quot;token punctuation\&quot;>:</span>\n        run<span class=\&quot;token punctuation\&quot;>(</span>port<span class=\&quot;token operator\&quot;>=</span><span class=\&quot;token builtin\&quot;>int</span><span class=\&quot;token punctuation\&quot;>(</span>argv<span class=\&quot;token punctuation\&quot;>[</span><span class=\&quot;token number\&quot;>1</span><span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n    <span class=\&quot;token keyword\&quot;>else</span><span class=\&quot;token punctuation\&quot;>:</span>\n        run<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n&quot;}">
<span class="token keyword">from</span> http<span class="token punctuation">.</span>server <span class="token keyword">import</span> BaseHTTPRequestHandler<span class="token punctuation">,</span> ThreadingHTTPServer
<span class="token keyword">import</span> logging
<span class="token triple-quoted-string string">"""
Very simple HTTP server in python for logging requests (for python 3.7 or later)
Usage::
    ./server.py [&lt;port&gt;]
"""</span>

<span class="token keyword">class</span> <span class="token class-name">S</span><span class="token punctuation">(</span>BaseHTTPRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">_set_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> custom_headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
        <span class="token comment"># add header</span>
        self<span class="token punctuation">.</span>send_header<span class="token punctuation">(</span><span class="token string">"Access-Control-Allow-Origin"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">do_GET</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"GET request,\nPath: %s\nHeaders:\n%s\n"</span><span class="token punctuation">,</span>
                     <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_set_response<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"GET request for {},\n\n with request headers: \n {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>path<span class="token punctuation">,</span> self<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>server_class<span class="token operator">=</span>ThreadingHTTPServer<span class="token punctuation">,</span> handler_class<span class="token operator">=</span>S<span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>
    server_address <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span>
    httpd <span class="token operator">=</span> server_class<span class="token punctuation">(</span>server_address<span class="token punctuation">,</span> handler_class<span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Starting httpd... port {}\n"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        httpd<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
    httpd<span class="token punctuation">.</span>server_close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Stopping httpd...\n'</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> sys <span class="token keyword">import</span> argv

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
        run<span class="token punctuation">(</span>port<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>

<p>これで先ほどと同じ fetch リクエストを送信してみる。</p>
<pre class="language-js" style="" tabindex="0"><code id="2072683d" class="language-js" data-prism-hydrate="{&quot;element&quot;:&quot;2072683d&quot;,&quot;language&quot;:&quot;js&quot;,&quot;code&quot;:&quot;\nfetch(\&quot;http://localhost:8080/api/step1\&quot;)\nPromise&nbsp;{\u003cpending\u003e}\n&quot;,&quot;highlightedCode&quot;:&quot;\n<span class=\&quot;token function\&quot;>fetch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;http://localhost:8080/api/step1\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span>\nPromise <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token operator\&quot;>\u0026lt;</span>pending<span class=\&quot;token operator\&quot;>></span><span class=\&quot;token punctuation\&quot;>}</span>\n&quot;}">
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/api/step1"</span><span class="token punctuation">)</span>
Promise <span class="token punctuation">{</span><span class="token operator">&lt;</span>pending<span class="token operator">&gt;</span><span class="token punctuation">}</span>
</code></pre>

<p>今度はエラーは起こらない。</p>
<pre class="language-js" style="" tabindex="0"><code id="5f9b743f" class="language-js" data-prism-hydrate="{&quot;element&quot;:&quot;5f9b743f&quot;,&quot;language&quot;:&quot;js&quot;,&quot;code&quot;:&quot;\nfetch(\&quot;http://localhost:8080/api/step1\&quot;).then(r =\u003e r.text()).then(data => console.log(data))\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token function\&quot;>fetch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;http://localhost:8080/api/step1\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>r</span> <span class=\&quot;token operator\&quot;>=></span> r<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>text</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>data</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>data<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n&quot;}">
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/api/step1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>

<p>のようにすればレスポンスの内容が見えるはず。 <code>Access-Control-Allow-Origin: &quot;*&quot;</code> ヘッダーは CORS でのアクセスをサーバーがブラウザーに許可するヘッダーということ。</p>
<h2 id="CORS-Step-2-Access-Control-Allow-Headers"><a href="#CORS-Step-2-Access-Control-Allow-Headers" class="headerlink" title="CORS Step 2 (Access-Control-Allow-Headers)"></a>CORS Step 2 (Access-Control-Allow-Headers)</h2><p>無事に CORS の対応ができたので、次はデータの送信を行う API を作る。</p>
<pre class="language-python" style="" tabindex="0"><code id="50c0ad3d" class="language-python" data-prism-hydrate="{&quot;element&quot;:&quot;50c0ad3d&quot;,&quot;language&quot;:&quot;python&quot;,&quot;code&quot;:&quot;\n    def do_POST(self):\n        logging.info(\&quot;POST request,\\nPath: %s\\nHeaders:\\n%s\\n\&quot;,\n                     str(self.path), str(self.headers))\n\n        content_length = int(self.headers[\u0027Content-Length'])\n        post_data = self.rfile.read(content_length)\n        body = json.loads(post_data)\n\n        self._set_response()\n\n        res = json.dumps({\n            \&quot;status\&quot;: \&quot;ok\&quot;,\n            \&quot;message\&quot;: \&quot;hello {}\&quot;.format(body.get(\&quot;name\&quot;))\n        })\n        \n        self.wfile.write(res.encode('utf-8'))\n&quot;,&quot;highlightedCode&quot;:&quot;\n    \u003cspan class=\&quot;token keyword\&quot;\u003edef</span> <span class=\&quot;token function\&quot;>do_POST</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>:</span>\n        logging<span class=\&quot;token punctuation\&quot;>.</span>info<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;POST request,\\nPath: %s\\nHeaders:\\n%s\\n\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n                     <span class=\&quot;token builtin\&quot;>str</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>.</span>path<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token builtin\&quot;>str</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>.</span>headers<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n        content_length <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token builtin\&quot;>int</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>.</span>headers<span class=\&quot;token punctuation\&quot;>[</span><span class=\&quot;token string\&quot;>'Content-Length'</span><span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>)</span>\n        post_data <span class=\&quot;token operator\&quot;>=</span> self<span class=\&quot;token punctuation\&quot;>.</span>rfile<span class=\&quot;token punctuation\&quot;>.</span>read<span class=\&quot;token punctuation\&quot;>(</span>content_length<span class=\&quot;token punctuation\&quot;>)</span>\n        body <span class=\&quot;token operator\&quot;>=</span> json<span class=\&quot;token punctuation\&quot;>.</span>loads<span class=\&quot;token punctuation\&quot;>(</span>post_data<span class=\&quot;token punctuation\&quot;>)</span>\n\n        self<span class=\&quot;token punctuation\&quot;>.</span>_set_response<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n        res <span class=\&quot;token operator\&quot;>=</span> json<span class=\&quot;token punctuation\&quot;>.</span>dumps<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>{</span>\n            <span class=\&quot;token string\&quot;>\&quot;status\&quot;</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;ok\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n            <span class=\&quot;token string\&quot;>\&quot;message\&quot;</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;hello {}\&quot;</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token builtin\&quot;>format</span><span class=\&quot;token punctuation\&quot;>(</span>body<span class=\&quot;token punctuation\&quot;>.</span>get<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;name\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n        <span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span>\n        \n        self<span class=\&quot;token punctuation\&quot;>.</span>wfile<span class=\&quot;token punctuation\&quot;>.</span>write<span class=\&quot;token punctuation\&quot;>(</span>res<span class=\&quot;token punctuation\&quot;>.</span>encode<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>'utf-8'</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n&quot;}">
    <span class="token keyword">def</span> <span class="token function">do_POST</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"POST request,\nPath: %s\nHeaders:\n%s\n"</span><span class="token punctuation">,</span>
                     <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>

        content_length <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Content-Length'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        post_data <span class="token operator">=</span> self<span class="token punctuation">.</span>rfile<span class="token punctuation">.</span>read<span class="token punctuation">(</span>content_length<span class="token punctuation">)</span>
        body <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>post_data<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>_set_response<span class="token punctuation">(</span><span class="token punctuation">)</span>

        res <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"ok"</span><span class="token punctuation">,</span>
            <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"hello {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span>res<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>

<p>そして、POST するデータは JSON でこう送る。</p>
<pre class="language-js" style="" tabindex="0"><code id="81a7673f" class="language-js" data-prism-hydrate="{&quot;element&quot;:&quot;81a7673f&quot;,&quot;language&quot;:&quot;js&quot;,&quot;code&quot;:&quot;\nfetch(\&quot;http://localhost:8080/api/step2\&quot;, { method: \&quot;POST\&quot; , body: JSON.stringify({\&quot;name\&quot;: \&quot;watahani\&quot;})}).then(r =\u003e r.text()).then(data => console.log(data))\n\n//{\&quot;status\&quot;: \&quot;ok\&quot;, \&quot;message\&quot;: \&quot;hello watahani\&quot;}\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token function\&quot;>fetch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;http://localhost:8080/api/step2\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token punctuation\&quot;>{</span> <span class=\&quot;token literal-property property\&quot;>method</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;POST\&quot;</span> <span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>body</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token constant\&quot;>JSON</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>stringify</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;watahani\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>r</span> <span class=\&quot;token operator\&quot;>=></span> r<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>text</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>data</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>data<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n<span class=\&quot;token comment\&quot;>//{\&quot;status\&quot;: \&quot;ok\&quot;, \&quot;message\&quot;: \&quot;hello watahani\&quot;}</span>\n&quot;}">
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/api/step2"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span> <span class="token punctuation">,</span> <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"watahani"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//{"status": "ok", "message": "hello watahani"}</span>
</code></pre>

<p>すばらしい。Access-Control-Allow-Origin のおかげでうまく通信ができている。しかしながら、ここで Content-Type を “application&#x2F;json” で、Authorization ヘッダーにアクセストークンを含めて送ってほしいと要望があったため、以下のように追加するとまた謎のエラーが発生する。</p>
<pre class="language-js" style="" tabindex="0"><code id="c371b93e" class="language-js" data-prism-hydrate="{&quot;element&quot;:&quot;c371b93e&quot;,&quot;language&quot;:&quot;js&quot;,&quot;code&quot;:&quot;\nfetch(\&quot;http://localhost:8080/api/step2\&quot;, { method: \&quot;POST\&quot; , headers: {\&quot;Content-Type\&quot;: \&quot;application/json\&quot;, \&quot;Authorization\&quot;: \&quot;xxxxx\&quot;}, body: JSON.stringify({\&quot;name\&quot;: \&quot;watahani\&quot;})}).then(r =\u003e r.text()).then(data => console.log(data))\n\n//Access to fetch at \u0027http://localhost:8080/api/step2' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: Response to preflight request doesn't pass access control check: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token function\&quot;>fetch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;http://localhost:8080/api/step2\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token punctuation\&quot;>{</span> <span class=\&quot;token literal-property property\&quot;>method</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;POST\&quot;</span> <span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>headers</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;Content-Type\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;application/json\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token string-property property\&quot;>\&quot;Authorization\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;xxxxx\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>body</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token constant\&quot;>JSON</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>stringify</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;watahani\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>r</span> <span class=\&quot;token operator\&quot;>=></span> r<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>text</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>data</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>data<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n<span class=\&quot;token comment\&quot;>//Access to fetch at 'http://localhost:8080/api/step2' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: Response to preflight request doesn't pass access control check: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.</span>\n&quot;}">
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/api/step2"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span> <span class="token punctuation">,</span> <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span> <span class="token string-property property">"Authorization"</span><span class="token operator">:</span> <span class="token string">"xxxxx"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"watahani"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//Access to fetch at 'http://localhost:8080/api/step2' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: Response to preflight request doesn't pass access control check: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.</span>
</code></pre>

<p>これは preflight request がパスしなかったというエラーだ。preflight request とは、単純リクエスト (simple request) ではない通信が発生する際に発生する “お伺い” であり、OPTIONS リクエストにより本来行うリクエストを送ってよい origin からの通信なのかを判別する機能、というのが私の理解。</p>
<p>一方で <a target="_blank" rel="noopener" href="https://developer.mozilla.org/ja/docs/Web/HTTP/CORS#simple_requests">単純リクエストの実際の条件</a> は MDN に纏まっているが、API 側に副作用を与えず認証を必要としない GET, HEAD リクエスト、ブラウザーに元来含まれている form post による通信が単純リクエスト、と私は理解している。</p>
<p>さて、これを解決するには Access-Control-Allow-Origin を <code>*</code> ではなく、fetch 元の Origin と一致させる必要がある。</p>
<pre class="language-diff" style="" tabindex="0"><code id="4a45ca3c" class="language-diff" data-prism-hydrate="{&quot;element&quot;:&quot;4a45ca3c&quot;,&quot;language&quot;:&quot;diff&quot;,&quot;code&quot;:&quot;\n-        self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;*\&quot;)\n+        self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token deleted-sign deleted\&quot;\u003e<span class=\&quot;token prefix deleted\&quot;>-</span><span class=\&quot;token line\&quot;>        self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;*\&quot;)\n</span></span><span class=\&quot;token inserted-sign inserted\&quot;><span class=\&quot;token prefix inserted\&quot;>+</span><span class=\&quot;token line\&quot;>        self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n</span></span>&quot;}">
<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">        self.send_header("Access-Control-Allow-Origin", "*")
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">        self.send_header("Access-Control-Allow-Origin", "https://blog.haniyama.com")
</span></span></code></pre>

<p>また、OPTIONS リクエストを受け取れるように以下も追加する。</p>
<pre class="language-python" style="" tabindex="0"><code id="b949be3e" class="language-python" data-prism-hydrate="{&quot;element&quot;:&quot;b949be3e&quot;,&quot;language&quot;:&quot;python&quot;,&quot;code&quot;:&quot;\n    def do_OPTIONS(self):\n        logging.info(\&quot;OPTIONS request,\\nPath: %s\\nHeaders:\\n%s\\n\&quot;,\n                     str(self.path), str(self.headers))\n        self._set_response()\n\n        self.wfile.write(\&quot;OPTIONS request for {},\\n\\n with request headers:\\n{}\&quot;.format(\n            self.path, self.headers).encode(\u0027utf-8'))\n&quot;,&quot;highlightedCode&quot;:&quot;\n    \u003cspan class=\&quot;token keyword\&quot;\u003edef</span> <span class=\&quot;token function\&quot;>do_OPTIONS</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>:</span>\n        logging<span class=\&quot;token punctuation\&quot;>.</span>info<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;OPTIONS request,\\nPath: %s\\nHeaders:\\n%s\\n\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n                     <span class=\&quot;token builtin\&quot;>str</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>.</span>path<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token builtin\&quot;>str</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>.</span>headers<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n        self<span class=\&quot;token punctuation\&quot;>.</span>_set_response<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n        self<span class=\&quot;token punctuation\&quot;>.</span>wfile<span class=\&quot;token punctuation\&quot;>.</span>write<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;OPTIONS request for {},\\n\\n with request headers:\\n{}\&quot;</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token builtin\&quot;>format</span><span class=\&quot;token punctuation\&quot;>(</span>\n            self<span class=\&quot;token punctuation\&quot;>.</span>path<span class=\&quot;token punctuation\&quot;>,</span> self<span class=\&quot;token punctuation\&quot;>.</span>headers<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span>encode<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>'utf-8'</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n&quot;}">
    <span class="token keyword">def</span> <span class="token function">do_OPTIONS</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"OPTIONS request,\nPath: %s\nHeaders:\n%s\n"</span><span class="token punctuation">,</span>
                     <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_set_response<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"OPTIONS request for {},\n\n with request headers:\n{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>path<span class="token punctuation">,</span> self<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>

<p>この状態でもエラーが出る。</p>
<pre class="language-js" style="" tabindex="0"><code id="2d6fc03e" class="language-js" data-prism-hydrate="{&quot;element&quot;:&quot;2d6fc03e&quot;,&quot;language&quot;:&quot;js&quot;,&quot;code&quot;:&quot;\nfetch(\&quot;http://localhost:8080/api/step2\&quot;, { method: \&quot;POST\&quot; , headers: {\&quot;Content-Type\&quot;: \&quot;application/json\&quot;, \&quot;Authorization\&quot;: \&quot;xxxxx\&quot;}, body: JSON.stringify({\&quot;name\&quot;: \&quot;watahani\&quot;})}).then(r =\u003e r.text()).then(data => console.log(data))\n\nPromise&nbsp;{\u003cpending>}\n\nAccess to fetch at \u0027http://localhost:8080/api/step2' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: Request header field content-type is not allowed by Access-Control-Allow-Headers in preflight response.\n&quot;,&quot;highlightedCode&quot;:&quot;\n<span class=\&quot;token function\&quot;>fetch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;http://localhost:8080/api/step2\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token punctuation\&quot;>{</span> <span class=\&quot;token literal-property property\&quot;>method</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;POST\&quot;</span> <span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>headers</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;Content-Type\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;application/json\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token string-property property\&quot;>\&quot;Authorization\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;xxxxx\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>body</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token constant\&quot;>JSON</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>stringify</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;watahani\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>r</span> <span class=\&quot;token operator\&quot;>=></span> r<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>text</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>data</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>data<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n\nPromise <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token operator\&quot;>\u0026lt;</span>pending<span class=\&quot;token operator\&quot;>></span><span class=\&quot;token punctuation\&quot;>}</span>\n\nAccess to fetch at <span class=\&quot;token string\&quot;>'http://localhost:8080/api/step2'</span> from origin <span class=\&quot;token string\&quot;>'https://blog.haniyama.com'</span> has been blocked by <span class=\&quot;token constant\&quot;>CORS</span> <span class=\&quot;token literal-property property\&quot;>policy</span><span class=\&quot;token operator\&quot;>:</span> Request header field content<span class=\&quot;token operator\&quot;>-</span>type is not allowed by Access<span class=\&quot;token operator\&quot;>-</span>Control<span class=\&quot;token operator\&quot;>-</span>Allow<span class=\&quot;token operator\&quot;>-</span>Headers <span class=\&quot;token keyword\&quot;>in</span> preflight response<span class=\&quot;token punctuation\&quot;>.</span>\n&quot;}">
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/api/step2"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span> <span class="token punctuation">,</span> <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span> <span class="token string-property property">"Authorization"</span><span class="token operator">:</span> <span class="token string">"xxxxx"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"watahani"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>

Promise <span class="token punctuation">{</span><span class="token operator">&lt;</span>pending<span class="token operator">&gt;</span><span class="token punctuation">}</span>

Access to fetch at <span class="token string">'http://localhost:8080/api/step2'</span> from origin <span class="token string">'https://blog.haniyama.com'</span> has been blocked by <span class="token constant">CORS</span> <span class="token literal-property property">policy</span><span class="token operator">:</span> Request header field content<span class="token operator">-</span>type is not allowed by Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Headers <span class="token keyword">in</span> preflight response<span class="token punctuation">.</span>
</code></pre>

<p>カスタム ヘッダーを送信するためには、Access-Control-Allow-Headers を追加しろといっている。</p>
<p>プリフライト リクエストのヘッダーを見てみると <code>Access-Control-Request-Headers: authorization,content-type</code> の記載があり、API 側がこれらのヘッダーを許可するのであれば <code>Access-Control-Allow-Headers: authorization, content-type</code> を返さなければならない。</p>
<pre class="language-http" style="" tabindex="0"><code id="b3ba813e" class="language-http" data-prism-hydrate="{&quot;element&quot;:&quot;b3ba813e&quot;,&quot;language&quot;:&quot;http&quot;,&quot;code&quot;:&quot;\nHost: localhost:8080\nConnection: keep-alive\nAccept: */*\nAccess-Control-Request-Method: POST\nAccess-Control-Request-Headers: authorization,content-type\nOrigin: https://blog.haniyama.com\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36 Edg/89.0.774.63\nSec-Fetch-Mode: cors\nSec-Fetch-Site: cross-site\nSec-Fetch-Dest: empty\nAccept-Encoding: gzip, deflate, br\nAccept-Language: ja,en-US;q=0.9,en;q=0.8\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token header\&quot;\u003e<span class=\&quot;token header-name keyword\&quot;>Host</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>localhost:8080</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Connection</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>keep-alive</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Accept</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>*/*</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Access-Control-Request-Method</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>POST</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Access-Control-Request-Headers</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>authorization,content-type</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Origin</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>https://blog.haniyama.com</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>User-Agent</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36 Edg/89.0.774.63</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Sec-Fetch-Mode</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>cors</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Sec-Fetch-Site</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>cross-site</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Sec-Fetch-Dest</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>empty</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Accept-Encoding</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>gzip, deflate, br</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Accept-Language</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>ja,en-US;q=0.9,en;q=0.8</span></span>\n&quot;}">
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">localhost:8080</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">keep-alive</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">*/*</span></span>
<span class="token header"><span class="token header-name keyword">Access-Control-Request-Method</span><span class="token punctuation">:</span> <span class="token header-value">POST</span></span>
<span class="token header"><span class="token header-name keyword">Access-Control-Request-Headers</span><span class="token punctuation">:</span> <span class="token header-value">authorization,content-type</span></span>
<span class="token header"><span class="token header-name keyword">Origin</span><span class="token punctuation">:</span> <span class="token header-value">https://blog.haniyama.com</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36 Edg/89.0.774.63</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Fetch-Mode</span><span class="token punctuation">:</span> <span class="token header-value">cors</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Fetch-Site</span><span class="token punctuation">:</span> <span class="token header-value">cross-site</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Fetch-Dest</span><span class="token punctuation">:</span> <span class="token header-value">empty</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate, br</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">ja,en-US;q=0.9,en;q=0.8</span></span>
</code></pre>

<p>ということで、以下のコードを追加する。</p>
<pre class="language-diff" style="" tabindex="0"><code id="5b22513e" class="language-diff" data-prism-hydrate="{&quot;element&quot;:&quot;5b22513e&quot;,&quot;language&quot;:&quot;diff&quot;,&quot;code&quot;:&quot;\n        self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token unchanged\&quot;\u003e<span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n</span></span>&quot;}">
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Origin", "https://blog.haniyama.com")
</span></span></code></pre>

<p>これで無事にリクエストが通るようになる。ちなみに現時点だとワイルドカードによる指定でも問題ない。</p>
<pre class="language-diff" style="" tabindex="0"><code id="09349c3e" class="language-diff" data-prism-hydrate="{&quot;element&quot;:&quot;09349c3e&quot;,&quot;language&quot;:&quot;diff&quot;,&quot;code&quot;:&quot;\n        self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n-       self.send_header(\&quot;Access-Control-Allow-Headers\&quot;, \&quot;Authorization, Content-Type\&quot;)\n+       self.send_header(\&quot;Access-Control-Allow-Headers\&quot;, \&quot;*\&quot;)\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token unchanged\&quot;\u003e<span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n</span></span><span class=\&quot;token deleted-sign deleted\&quot;><span class=\&quot;token prefix deleted\&quot;>-</span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Headers\&quot;, \&quot;Authorization, Content-Type\&quot;)\n</span></span><span class=\&quot;token inserted-sign inserted\&quot;><span class=\&quot;token prefix inserted\&quot;>+</span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Headers\&quot;, \&quot;*\&quot;)\n</span></span>&quot;}">
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Origin", "https://blog.haniyama.com")
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">       self.send_header("Access-Control-Allow-Headers", "Authorization, Content-Type")
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">       self.send_header("Access-Control-Allow-Headers", "*")
</span></span></code></pre>

<h2 id="CORS-Step-3-Access-Control-Allow-Headers"><a href="#CORS-Step-3-Access-Control-Allow-Headers" class="headerlink" title="CORS Step 3 (Access-Control-Allow-Headers)"></a>CORS Step 3 (Access-Control-Allow-Headers)</h2><p>さて、POST メソッドができたところで Delete メソッドを受け付ける API も構成したいとのことで、Delete 用のメソッドをサーバー側に追加した。</p>
<pre class="language-python" style="" tabindex="0"><code id="46a8f33e" class="language-python" data-prism-hydrate="{&quot;element&quot;:&quot;46a8f33e&quot;,&quot;language&quot;:&quot;python&quot;,&quot;code&quot;:&quot;\n    def do_DELETE(self):\n        logging.info(\&quot;DELETE request,\\nPath: %s\\nHeaders:\\n%s\\n\&quot;,\n                     str(self.path), str(self.headers))\n\n        content_length = int(self.headers[\u0027Content-Length'])\n        post_data = self.rfile.read(content_length)\n        body = json.loads(post_data)\n\n        self._set_response()\n\n        res = json.dumps({\n            \&quot;status\&quot;: \&quot;ok\&quot;,\n            \&quot;message\&quot;: \&quot;deleted {}\&quot;.format(body.get(\&quot;name\&quot;))\n        })\n        \n        self.wfile.write(res.encode('utf-8'))\n&quot;,&quot;highlightedCode&quot;:&quot;\n    \u003cspan class=\&quot;token keyword\&quot;\u003edef</span> <span class=\&quot;token function\&quot;>do_DELETE</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>:</span>\n        logging<span class=\&quot;token punctuation\&quot;>.</span>info<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;DELETE request,\\nPath: %s\\nHeaders:\\n%s\\n\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n                     <span class=\&quot;token builtin\&quot;>str</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>.</span>path<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token builtin\&quot;>str</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>.</span>headers<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n        content_length <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token builtin\&quot;>int</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>.</span>headers<span class=\&quot;token punctuation\&quot;>[</span><span class=\&quot;token string\&quot;>'Content-Length'</span><span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>)</span>\n        post_data <span class=\&quot;token operator\&quot;>=</span> self<span class=\&quot;token punctuation\&quot;>.</span>rfile<span class=\&quot;token punctuation\&quot;>.</span>read<span class=\&quot;token punctuation\&quot;>(</span>content_length<span class=\&quot;token punctuation\&quot;>)</span>\n        body <span class=\&quot;token operator\&quot;>=</span> json<span class=\&quot;token punctuation\&quot;>.</span>loads<span class=\&quot;token punctuation\&quot;>(</span>post_data<span class=\&quot;token punctuation\&quot;>)</span>\n\n        self<span class=\&quot;token punctuation\&quot;>.</span>_set_response<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n        res <span class=\&quot;token operator\&quot;>=</span> json<span class=\&quot;token punctuation\&quot;>.</span>dumps<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>{</span>\n            <span class=\&quot;token string\&quot;>\&quot;status\&quot;</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;ok\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n            <span class=\&quot;token string\&quot;>\&quot;message\&quot;</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;deleted {}\&quot;</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token builtin\&quot;>format</span><span class=\&quot;token punctuation\&quot;>(</span>body<span class=\&quot;token punctuation\&quot;>.</span>get<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;name\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n        <span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span>\n        \n        self<span class=\&quot;token punctuation\&quot;>.</span>wfile<span class=\&quot;token punctuation\&quot;>.</span>write<span class=\&quot;token punctuation\&quot;>(</span>res<span class=\&quot;token punctuation\&quot;>.</span>encode<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>'utf-8'</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n&quot;}">
    <span class="token keyword">def</span> <span class="token function">do_DELETE</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"DELETE request,\nPath: %s\nHeaders:\n%s\n"</span><span class="token punctuation">,</span>
                     <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>

        content_length <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Content-Length'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        post_data <span class="token operator">=</span> self<span class="token punctuation">.</span>rfile<span class="token punctuation">.</span>read<span class="token punctuation">(</span>content_length<span class="token punctuation">)</span>
        body <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>post_data<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>_set_response<span class="token punctuation">(</span><span class="token punctuation">)</span>

        res <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"ok"</span><span class="token punctuation">,</span>
            <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"deleted {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span>res<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>

<p>Step 2 でヘッダーの構成はすんでいるので、単純に DELETE リクエストを投げる。</p>
<pre class="language-js" style="" tabindex="0"><code id="45a7023f" class="language-js" data-prism-hydrate="{&quot;element&quot;:&quot;45a7023f&quot;,&quot;language&quot;:&quot;js&quot;,&quot;code&quot;:&quot;\nfetch(\&quot;http://localhost:8080/api/step2\&quot;, { method: \&quot;DELETE\&quot; , headers: {\&quot;Content-Type\&quot;: \&quot;application/json\&quot;, \&quot;Authorization\&quot;: \&quot;xxxxx\&quot;}, body: JSON.stringify({\&quot;name\&quot;: \&quot;watahani\&quot;})}).then(r =\u003e r.text()).then(data => console.log(data))\n\n//Access to fetch at \u0027http://localhost:8080/api/step2' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: Method DELETE is not allowed by Access-Control-Allow-Methods in preflight response.\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token function\&quot;>fetch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;http://localhost:8080/api/step2\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token punctuation\&quot;>{</span> <span class=\&quot;token literal-property property\&quot;>method</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;DELETE\&quot;</span> <span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>headers</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;Content-Type\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;application/json\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token string-property property\&quot;>\&quot;Authorization\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;xxxxx\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>body</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token constant\&quot;>JSON</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>stringify</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;watahani\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>r</span> <span class=\&quot;token operator\&quot;>=></span> r<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>text</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>data</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>data<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n<span class=\&quot;token comment\&quot;>//Access to fetch at 'http://localhost:8080/api/step2' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: Method DELETE is not allowed by Access-Control-Allow-Methods in preflight response.</span>\n&quot;}">
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/api/step2"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"DELETE"</span> <span class="token punctuation">,</span> <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span> <span class="token string-property property">"Authorization"</span><span class="token operator">:</span> <span class="token string">"xxxxx"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"watahani"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//Access to fetch at 'http://localhost:8080/api/step2' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: Method DELETE is not allowed by Access-Control-Allow-Methods in preflight response.</span>
</code></pre>

<p>なるほど、今度は Access-Control-Allow-Methods ヘッダーに DELETE が含まれないため失敗してしまった。<br>実は POST, GET, HEAD のリクエストは CORS-safelisted Methods のため、後に説明する credentials mode が included ではない場合は暗黙的に許可される。しかし CORS-safelisted Methods ではない場合は Access-Control-Allow-Methods の指定が必要となる。</p>
<pre class="language-diff" style="" tabindex="0"><code id="8b184a3f" class="language-diff" data-prism-hydrate="{&quot;element&quot;:&quot;8b184a3f&quot;,&quot;language&quot;:&quot;diff&quot;,&quot;code&quot;:&quot;\n        self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n        self.send_header(\&quot;Access-Control-Allow-Headers\&quot;, \&quot;*\&quot;)\n+       self.send_header(\&quot;Access-Control-Allow-Methods\&quot;, \&quot;*\&quot;)\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token unchanged\&quot;\u003e<span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n</span><span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Headers\&quot;, \&quot;*\&quot;)\n</span></span><span class=\&quot;token inserted-sign inserted\&quot;><span class=\&quot;token prefix inserted\&quot;>+</span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Methods\&quot;, \&quot;*\&quot;)\n</span></span>&quot;}">
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Origin", "https://blog.haniyama.com")
</span><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Headers", "*")
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">       self.send_header("Access-Control-Allow-Methods", "*")
</span></span></code></pre>

<p>なお、credentials mode が include の場合、より制約が厳しくなり Access-Control-Allow-Headers や Access-Control-Allow-Methods で “*” によるワイルドカード指定はできなくなるため、以下のような指定が必要になる。</p>
<pre class="language-diff" style="" tabindex="0"><code id="2c023a3e" class="language-diff" data-prism-hydrate="{&quot;element&quot;:&quot;2c023a3e&quot;,&quot;language&quot;:&quot;diff&quot;,&quot;code&quot;:&quot;\n        self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n        self.send_header(\&quot;Access-Control-Alltoiuow-Headers\&quot;, \&quot;Authorization, Content-Type\&quot;)\n+       self.send_header(\&quot;Access-Control-Allow-Methods\&quot;, \&quot;POST, DELETE\&quot;)\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token unchanged\&quot;\u003e<span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n</span><span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Alltoiuow-Headers\&quot;, \&quot;Authorization, Content-Type\&quot;)\n</span></span><span class=\&quot;token inserted-sign inserted\&quot;><span class=\&quot;token prefix inserted\&quot;>+</span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Methods\&quot;, \&quot;POST, DELETE\&quot;)\n</span></span>&quot;}">
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Origin", "https://blog.haniyama.com")
</span><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Alltoiuow-Headers", "Authorization, Content-Type")
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">       self.send_header("Access-Control-Allow-Methods", "POST, DELETE")
</span></span></code></pre>

<h2 id="CORS-Step-4-Access-Control-Allow-Credentials"><a href="#CORS-Step-4-Access-Control-Allow-Credentials" class="headerlink" title="CORS Step 4 (Access-Control-Allow-Credentials)"></a>CORS Step 4 (Access-Control-Allow-Credentials)</h2><p>ということで次はリクエストに Cookie を含めたい場合の話。fetch の credentials オプションを “include” にすると、レスポンス ヘッダーに <code>Access-Control-Allow-Credentials: true</code> が必要になる。</p>
<pre class="language-javascript" style="" tabindex="0"><code id="0430413f" class="language-javascript" data-prism-hydrate="{&quot;element&quot;:&quot;0430413f&quot;,&quot;language&quot;:&quot;javascript&quot;,&quot;code&quot;:&quot;\nfetch(\&quot;http://localhost:8080/api/step3\&quot;, { method: \&quot;POST\&quot; , headers: {\&quot;Content-Type\&quot;: \&quot;application/json\&quot;, \&quot;Authorization\&quot;: \&quot;xxxxx\&quot;}, credentials: \&quot;include\&quot;, body: JSON.stringify({\&quot;name\&quot;: \&quot;watahani\&quot;})}).then(r =\u003e r.text()).then(data => console.log(data))\n//Access to fetch at \u0027http://localhost:8080/api/step3' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: Response to preflight request doesn't pass access control check: The value of the 'Access-Control-Allow-Credentials' header in the response is '' which must be 'true' when the request's credentials mode is 'include'.\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token function\&quot;>fetch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;http://localhost:8080/api/step3\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token punctuation\&quot;>{</span> <span class=\&quot;token literal-property property\&quot;>method</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;POST\&quot;</span> <span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>headers</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;Content-Type\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;application/json\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token string-property property\&quot;>\&quot;Authorization\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;xxxxx\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>credentials</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;include\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>body</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token constant\&quot;>JSON</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>stringify</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;watahani\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>r</span> <span class=\&quot;token operator\&quot;>=></span> r<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>text</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>data</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>data<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n<span class=\&quot;token comment\&quot;>//Access to fetch at 'http://localhost:8080/api/step3' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: Response to preflight request doesn't pass access control check: The value of the 'Access-Control-Allow-Credentials' header in the response is '' which must be 'true' when the request's credentials mode is 'include'.</span>\n&quot;}">
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/api/step3"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span> <span class="token punctuation">,</span> <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span> <span class="token string-property property">"Authorization"</span><span class="token operator">:</span> <span class="token string">"xxxxx"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token string">"include"</span><span class="token punctuation">,</span> <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"watahani"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">//Access to fetch at 'http://localhost:8080/api/step3' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: Response to preflight request doesn't pass access control check: The value of the 'Access-Control-Allow-Credentials' header in the response is '' which must be 'true' when the request's credentials mode is 'include'.</span>
</code></pre>

<p>ということで、以下を追加する。</p>
<pre class="language-diff" style="" tabindex="0"><code id="a934453e" class="language-diff" data-prism-hydrate="{&quot;element&quot;:&quot;a934453e&quot;,&quot;language&quot;:&quot;diff&quot;,&quot;code&quot;:&quot;\n        self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n        self.send_header(\&quot;Access-Control-Alltoiuow-Headers\&quot;, \&quot;Authorization, Content-Type\&quot;)\n        self.send_header(\&quot;Access-Control-Allow-Methods\&quot;, \&quot;POST, DELETE\&quot;)\n+       self.send_header(\&quot;Access-Control-Allow-Credentials\&quot;, \&quot;true\&quot;)\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token unchanged\&quot;\u003e<span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n</span><span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Alltoiuow-Headers\&quot;, \&quot;Authorization, Content-Type\&quot;)\n</span><span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Methods\&quot;, \&quot;POST, DELETE\&quot;)\n</span></span><span class=\&quot;token inserted-sign inserted\&quot;><span class=\&quot;token prefix inserted\&quot;>+</span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Credentials\&quot;, \&quot;true\&quot;)\n</span></span>&quot;}">
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Origin", "https://blog.haniyama.com")
</span><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Alltoiuow-Headers", "Authorization, Content-Type")
</span><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Methods", "POST, DELETE")
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">       self.send_header("Access-Control-Allow-Credentials", "true")
</span></span></code></pre>

<pre class="language-javascript" style="" tabindex="0"><code id="c24d173f" class="language-javascript" data-prism-hydrate="{&quot;element&quot;:&quot;c24d173f&quot;,&quot;language&quot;:&quot;javascript&quot;,&quot;code&quot;:&quot;\nfetch(\&quot;http://localhost:8080/api/step4\&quot;, { method: \&quot;POST\&quot; , headers: {\&quot;Content-Type\&quot;: \&quot;application/json\&quot;, \&quot;Authorization\&quot;: \&quot;xxxxx\&quot;}, credentials: \&quot;include\&quot;, body: JSON.stringify({\&quot;name\&quot;: \&quot;watahani\&quot;})}).then(r =\u003e r.text()).then(data => console.log(data))\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token function\&quot;>fetch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;http://localhost:8080/api/step4\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token punctuation\&quot;>{</span> <span class=\&quot;token literal-property property\&quot;>method</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;POST\&quot;</span> <span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>headers</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;Content-Type\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;application/json\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token string-property property\&quot;>\&quot;Authorization\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;xxxxx\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>credentials</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;include\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>body</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token constant\&quot;>JSON</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>stringify</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;watahani\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>r</span> <span class=\&quot;token operator\&quot;>=></span> r<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>text</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>data</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>data<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n&quot;}">
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/api/step4"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span> <span class="token punctuation">,</span> <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span> <span class="token string-property property">"Authorization"</span><span class="token operator">:</span> <span class="token string">"xxxxx"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token string">"include"</span><span class="token punctuation">,</span> <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"watahani"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>

<p>CORS で Cookie 付けたいシチュエーションっていうのが正直よくわかってないのだけど、 <code>app.example.com</code> と <code>api.example.com</code> で Cookie 共有してて送りたいみたいな時に使うのかな？あとはトラッキング用とか。<br>たぶん API 側の Set-Cookie は 3rd Party Cookie になるので拒否されると認識している。<br>(手元で試してみた限り Set-Cookie は一切きかない動き？)</p>
<h2 id="CORS-Step-5-Access-Control-Expose-Headers"><a href="#CORS-Step-5-Access-Control-Expose-Headers" class="headerlink" title="CORS Step 5 (Access-Control-Expose-Headers)"></a>CORS Step 5 (Access-Control-Expose-Headers)</h2><p>あまり興味がないのでサクッと。JavaScript から触れるヘッダーを指定する。</p>
<pre class="language-diff" style="" tabindex="0"><code id="07dcf43d" class="language-diff" data-prism-hydrate="{&quot;element&quot;:&quot;07dcf43d&quot;,&quot;language&quot;:&quot;diff&quot;,&quot;code&quot;:&quot;\n        self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n        self.send_header(\&quot;Access-Control-Alltoiuow-Headers\&quot;, \&quot;Authorization, Content-Type\&quot;)\n        self.send_header(\&quot;Access-Control-Allow-Methods\&quot;, \&quot;POST, DELETE\&quot;)\n        self.send_header(\&quot;Access-Control-Allow-Credentials\&quot;, \&quot;true\&quot;)\n+       self.send_header(\&quot;Access-Control-Expose-Headers\&quot;, \&quot;X-Exportable\&quot;)\n+       self.send_header(\&quot;X-Exportable\&quot;, \&quot;hogehoge\&quot;)\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token unchanged\&quot;\u003e<span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n</span><span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Alltoiuow-Headers\&quot;, \&quot;Authorization, Content-Type\&quot;)\n</span><span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Methods\&quot;, \&quot;POST, DELETE\&quot;)\n</span><span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Credentials\&quot;, \&quot;true\&quot;)\n</span></span><span class=\&quot;token inserted-sign inserted\&quot;><span class=\&quot;token prefix inserted\&quot;>+</span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Expose-Headers\&quot;, \&quot;X-Exportable\&quot;)\n</span><span class=\&quot;token prefix inserted\&quot;>+</span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;X-Exportable\&quot;, \&quot;hogehoge\&quot;)\n</span></span>&quot;}">
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Origin", "https://blog.haniyama.com")
</span><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Alltoiuow-Headers", "Authorization, Content-Type")
</span><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Methods", "POST, DELETE")
</span><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Credentials", "true")
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">       self.send_header("Access-Control-Expose-Headers", "X-Exportable")
</span><span class="token prefix inserted">+</span><span class="token line">       self.send_header("X-Exportable", "hogehoge")
</span></span></code></pre>

<p>すると <code>X-Exportable</code> が JavaScript で読み取り可能になる。</p>
<pre class="language-javascript" style="" tabindex="0"><code id="7f05743f" class="language-javascript" data-prism-hydrate="{&quot;element&quot;:&quot;7f05743f&quot;,&quot;language&quot;:&quot;javascript&quot;,&quot;code&quot;:&quot;\nfetch(\&quot;http://localhost:8080/api/step5\&quot;, { method: \&quot;POST\&quot; , headers: {\&quot;Content-Type\&quot;: \&quot;application/json\&quot;, \&quot;Authorization\&quot;: \&quot;xxxxx\&quot;}, credentials: \&quot;include\&quot;, body: JSON.stringify({\&quot;name\&quot;: \&quot;watahani\&quot;})}).then(r =\u003e console.log(r.headers.get(\&quot;X-Exportable\&quot;)))\n// hogehoge\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token function\&quot;>fetch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;http://localhost:8080/api/step5\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token punctuation\&quot;>{</span> <span class=\&quot;token literal-property property\&quot;>method</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;POST\&quot;</span> <span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>headers</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;Content-Type\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;application/json\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token string-property property\&quot;>\&quot;Authorization\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;xxxxx\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>credentials</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;include\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>body</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token constant\&quot;>JSON</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>stringify</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;watahani\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>r</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>r<span class=\&quot;token punctuation\&quot;>.</span>headers<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>get</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;X-Exportable\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n<span class=\&quot;token comment\&quot;>// hogehoge</span>\n&quot;}">
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/api/step5"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span> <span class="token punctuation">,</span> <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span> <span class="token string-property property">"Authorization"</span><span class="token operator">:</span> <span class="token string">"xxxxx"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token string">"include"</span><span class="token punctuation">,</span> <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"watahani"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"X-Exportable"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// hogehoge</span>
</code></pre>

<h2 id="CORS-Step-6-Access-Control-Max-Age"><a href="#CORS-Step-6-Access-Control-Max-Age" class="headerlink" title="CORS Step 6 (Access-Control-Max-Age)"></a>CORS Step 6 (Access-Control-Max-Age)</h2><p>プリフライトリクエストの結果をキャッシュする秒数を定義する。</p>
<pre class="language-diff" style="" tabindex="0"><code id="27a77c3f" class="language-diff" data-prism-hydrate="{&quot;element&quot;:&quot;27a77c3f&quot;,&quot;language&quot;:&quot;diff&quot;,&quot;code&quot;:&quot;\n        self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n        self.send_header(\&quot;Access-Control-Alltoiuow-Headers\&quot;, \&quot;Authorization, Content-Type\&quot;)\n        self.send_header(\&quot;Access-Control-Allow-Methods\&quot;, \&quot;POST, DELETE\&quot;)\n        self.send_header(\&quot;Access-Control-Allow-Credentials\&quot;, \&quot;true\&quot;)\n        self.send_header(\&quot;Access-Control-Expose-Headers\&quot;, \&quot;X-Exportable\&quot;)\n        self.send_header(\&quot;X-Exportable\&quot;, \&quot;hogehoge\&quot;)\n+       self.send_header(\&quot;Access-Control-Max-Age\&quot;, \&quot;10\&quot;)\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token unchanged\&quot;\u003e<span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n</span><span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Alltoiuow-Headers\&quot;, \&quot;Authorization, Content-Type\&quot;)\n</span><span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Methods\&quot;, \&quot;POST, DELETE\&quot;)\n</span><span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Credentials\&quot;, \&quot;true\&quot;)\n</span><span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Expose-Headers\&quot;, \&quot;X-Exportable\&quot;)\n</span><span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;X-Exportable\&quot;, \&quot;hogehoge\&quot;)\n</span></span><span class=\&quot;token inserted-sign inserted\&quot;><span class=\&quot;token prefix inserted\&quot;>+</span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Max-Age\&quot;, \&quot;10\&quot;)\n</span></span>&quot;}">
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Origin", "https://blog.haniyama.com")
</span><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Alltoiuow-Headers", "Authorization, Content-Type")
</span><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Methods", "POST, DELETE")
</span><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Credentials", "true")
</span><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Expose-Headers", "X-Exportable")
</span><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("X-Exportable", "hogehoge")
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">       self.send_header("Access-Control-Max-Age", "10")
</span></span></code></pre>

<p>無ければ毎回プリフライトリクエストのための OPTIONS リクエストが飛んでしまうため、重要なキャッシュ戦略。今の仕事だと気にすることがないのでさらっと。</p>
<pre class="language-javascript" style="" tabindex="0"><code id="75a1c63d" class="language-javascript" data-prism-hydrate="{&quot;element&quot;:&quot;75a1c63d&quot;,&quot;language&quot;:&quot;javascript&quot;,&quot;code&quot;:&quot;\nvar f = () =\u003e fetch(\&quot;http://localhost:8080/api/step6\&quot;, { method: \&quot;POST\&quot; , headers: {\&quot;Content-Type\&quot;: \&quot;application/json\&quot;, \&quot;Authorization\&quot;: \&quot;xxxxx\&quot;}, credentials: \&quot;include\&quot;, body: JSON.stringify({\&quot;name\&quot;: \&quot;watahani\&quot;})}).then(r => console.log(r.headers.get(\&quot;X-Exportable\&quot;)))\nvar timer = setInterval(f, 1000);\n// clearInterval(timer)\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token keyword\&quot;>var</span> <span class=\&quot;token function-variable function\&quot;>f</span> <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token operator\&quot;>=></span> <span class=\&quot;token function\&quot;>fetch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;http://localhost:8080/api/step6\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token punctuation\&quot;>{</span> <span class=\&quot;token literal-property property\&quot;>method</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;POST\&quot;</span> <span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>headers</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;Content-Type\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;application/json\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token string-property property\&quot;>\&quot;Authorization\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;xxxxx\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>credentials</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;include\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>body</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token constant\&quot;>JSON</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>stringify</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;watahani\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>r</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>r<span class=\&quot;token punctuation\&quot;>.</span>headers<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>get</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;X-Exportable\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n<span class=\&quot;token keyword\&quot;>var</span> timer <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token function\&quot;>setInterval</span><span class=\&quot;token punctuation\&quot;>(</span>f<span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token number\&quot;>1000</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token comment\&quot;>// clearInterval(timer)</span>\n&quot;}">
<span class="token keyword">var</span> <span class="token function-variable function">f</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/api/step6"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span> <span class="token punctuation">,</span> <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span> <span class="token string-property property">"Authorization"</span><span class="token operator">:</span> <span class="token string">"xxxxx"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token string">"include"</span><span class="token punctuation">,</span> <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"watahani"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"X-Exportable"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// clearInterval(timer)</span>
</code></pre>

<p>10 秒間はプリフライトリクエストがキャッシュされるので、プリフライトリクエストが飛ぶのは 10 秒に一回ぐらいになる。<br>Edge の DevTool だとプリフライトリクエストがすごくわかりやすいのでお勧め。</p>
<p><img src="/2021/04/24/cors/devtools02.png"></p>
<p>ということで、CORS について一通り手を動かして勉強してみた。<br>CORS はわかったけど、今度はサードパーティ Cookie の動きが良くわからんとなって、1 カ月ほど放置していたが、その辺はまた分かったら書き足すということで。</p>
<p>コードは Gist に上げておいたのでもし興味があれば動かしてみてください。</p>
<script src="https://gist.github.com/watahani/6c026b6899b2897bb57e947d3b1432d5.js"></script>
<div class="related-post"><h3>関連記事</h3><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2021\01\14\202101\" title="2021-01-14 めも" rel="bookmark">2021-01-14 めも</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2021\11\05\azure-portal-change-language\" title="Azure ポータルの言語をワンクリックで切り替える" rel="bookmark">Azure ポータルの言語をワンクリックで切り替える</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2018\12\18\best-buy-2018\" title="BEST BUY 2018" rel="bookmark">BEST BUY 2018</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2019\02\04\job-change\" title="転職しました" rel="bookmark">転職しました</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2019\11\24\ms-ignite-2019\" title="Microsoft Ignite 2019 メモ" rel="bookmark">Microsoft Ignite 2019 メモ</a></h3></div></li></ul></div></div><div class="article-meta" style="max-width:800px"><div class="tags"><i class="icon icon-tag"></i><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9B%91%E8%A8%98/" rel="tag">雑記</a><span class="tag-list-count">8</span></li></ul></div></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2021/04/24/get-aad-token-using-powershell/"><i class="icon icon-arror-left"></i></a></li><li><a href="/2021/01/14/202101/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/82p" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="https://twitter.com/watahani" title="Twitter" target="_blank"><i class="icon icon-twitter"></i></a></li><li><a href="https://www.facebook.com/haniyama.wataru" title="Facebook" target="_blank"><i class="icon icon-facebook"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2024 enjoy struggling<br><small>POWER BY <a href="https://hexo.io" target="_blank">HEXO</a></small><small>, THEME BY <a href="https://github.com/BoizZ/hexo-theme-laughing" target="_blank">LAUGHING</a></small></p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>