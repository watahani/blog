<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>enjoy struggling</title>
  
  <subtitle>æŠ€è¡“ãƒ¡ãƒ¢ã¨ã‹æ–™ç†ãƒã‚¿ã¨ã‹</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://blog.haniyama.com/"/>
  <updated>2024-02-18T07:06:48.703Z</updated>
  <id>http://blog.haniyama.com/</id>
  
  <author>
    <name>watahani</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Docker ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ fail2ban ã§åˆ¶é™ã™ã‚‹ (ufw ç’°å¢ƒ)</title>
    <link href="http://blog.haniyama.com/2024/02/18/docker-ufw-fail2ban/"/>
    <id>http://blog.haniyama.com/2024/02/18/docker-ufw-fail2ban/</id>
    <published>2024-02-18T03:00:00.000Z</published>
    <updated>2024-02-18T07:06:48.703Z</updated>
    
    <content type="html"><![CDATA[<p>Ubuntu 22.04 ã‚’ä½¿ã£ã¦ã„ã‚‹ã‚µãƒ¼ãƒãƒ¼ã§ã¯ã€åŸºæœ¬çš„ã« Firewall ã¨ã—ã¦ ufw ã‚’ä½¿ã£ã¦ã„ã‚‹ã¨æ€ã†ã€‚ã—ã‹ã—ãªãŒã‚‰ã€Docker ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ Docker ãŒè‡ªå‹•çš„ã« iptables ã®ãƒã‚§ãƒ¼ãƒ³ã‚’ä½œæˆã—ã€ufw ã‚’è¿‚å›ã™ã‚‹ãŸã‚ã€ufw ã§ã®åˆ¶é™ãŒåŠ¹ã‹ãªã„ã€‚çŸ¥ã‚‰ãšã«ã‚ã¡ã‚ƒãã¡ã‚ƒãƒãƒã£ãŸã€‚</p><p><a href="https://github.com/linuxserver/docker-fail2ban">GitHub - linuxserver/docker-fail2ban</a> ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ Docker ãŒè‡ªå‹•ã§ä½œæˆã™ã‚‹ DOKCER-USER ãƒã‚§ãƒ¼ãƒ³ã‚’è€ƒæ…®ã—ãŸ iptables ã®æ§‹æˆã‚’è¿½åŠ ã—ã¦ãã‚Œã‚‹ã‚ˆã† (iptables ç›´æ¥ç·¨é›†ã ã¨ FOWARD ã‚‚ã¾ã¨ã‚ã¦ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ãã‚Œã‚‹ã®ã‹ï¼Ÿç†è§£ã§ãã¦ã„ãªã„ã€‚) ã ãŒã€<a href="https://github.com/linuxserver/fail2ban-confs">è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«</a> ã®ã©ã®è¾ºãŒåŠ¹ã„ã¦ã„ã‚‹ã®ã‹è§£èª­ã™ã‚‹ã®ãŒã‚­ãƒ„ã‹ã£ãŸã€‚</p><h2 id="æœ€çµ‚çš„ãªæ§‹æˆ"><a href="#æœ€çµ‚çš„ãªæ§‹æˆ" class="headerlink" title="æœ€çµ‚çš„ãªæ§‹æˆ"></a>æœ€çµ‚çš„ãªæ§‹æˆ</h2><p>fail2ban ã¯å…ƒã€…ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã§å‹•ã‹ã™ã¤ã‚‚ã‚Šã ã£ãŸã®ã§ã€ä»¥ä¸‹ã®ã‚µã‚¤ãƒˆã‚’å‚è€ƒã« <code>/etc/ufw/after.rules</code> ã‚’è¿½åŠ ã—ã¦ ufw route ã§é€šä¿¡ã‚’åˆ¶å¾¡ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã€‚æ­£ç›´ã“ã¡ã‚‰ã®è¨­å®šã‚‚æ­£ç›´æ­£ç¢ºãªç†è§£ãŒå‡ºæ¥ã¦ã„ãªã„ã€‚</p><ul><li>å‚è€ƒ: <a href="https://matsudamper.hatenablog.com/entry/2023/03/22/081825">Dockerã¨ufwã§ãƒãƒ¼ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’ã™ã‚‹æ–¹æ³• - ã‚¢ãƒ—ãƒªé–‹ç™ºå‚™å¿˜éŒ²</a></li><li>å‚è€ƒ: <a href="https://github.com/chaifeng/ufw-docker">chaifeng/ufw-docker: To fix the Docker and UFW security flaw without disabling iptables</a></li></ul><h3 id="etc-ufw-after-rules-ã«è¿½è¨˜"><a href="#etc-ufw-after-rules-ã«è¿½è¨˜" class="headerlink" title="/etc/ufw/after.rules ã«è¿½è¨˜"></a><code>/etc/ufw/after.rules</code> ã«è¿½è¨˜</h3><p><a href="https://github.com/chaifeng/ufw-docker">chaifeng/ufw-docker: To fix the Docker and UFW security flaw without disabling iptables</a> ãã®ã¾ã¾ã‚³ãƒ”ãƒšã§è¿½åŠ </p><pre><code># BEGIN UFW AND DOCKER*filter:ufw-user-forward - [0:0]:ufw-docker-logging-deny - [0:0]:DOCKER-USER - [0:0]-A DOCKER-USER -j ufw-user-forward-A DOCKER-USER -j RETURN -s 10.0.0.0/8-A DOCKER-USER -j RETURN -s 172.16.0.0/12-A DOCKER-USER -j RETURN -s 192.168.0.0/16-A DOCKER-USER -p udp -m udp --sport 53 --dport 1024:65535 -j RETURN-A DOCKER-USER -j ufw-docker-logging-deny -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 192.168.0.0/16-A DOCKER-USER -j ufw-docker-logging-deny -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 10.0.0.0/8-A DOCKER-USER -j ufw-docker-logging-deny -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 172.16.0.0/12-A DOCKER-USER -j ufw-docker-logging-deny -p udp -m udp --dport 0:32767 -d 192.168.0.0/16-A DOCKER-USER -j ufw-docker-logging-deny -p udp -m udp --dport 0:32767 -d 10.0.0.0/8-A DOCKER-USER -j ufw-docker-logging-deny -p udp -m udp --dport 0:32767 -d 172.16.0.0/12-A DOCKER-USER -j RETURN-A ufw-docker-logging-deny -m limit --limit 3/min --limit-burst 10 -j LOG --log-prefix &quot;[UFW DOCKER BLOCK] &quot;-A ufw-docker-logging-deny -j DROPCOMMIT# END UFW AND DOCKER</code></pre><h3 id="ufw-ã®å‹•ä½œæ¤œè¨¼"><a href="#ufw-ã®å‹•ä½œæ¤œè¨¼" class="headerlink" title="ufw ã®å‹•ä½œæ¤œè¨¼"></a>ufw ã®å‹•ä½œæ¤œè¨¼</h3><p>ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã§ç‰¹å®š IP ã‹ã‚‰ Docker ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒåˆ¶é™ã§ãã‚‹ã“ã¨ã‚’ç¢ºèª</p><pre class=" language-bash"><code class="language-bash">ufw route insert 1 deny from <span class="token operator">&lt;</span>ip<span class="token operator">></span> to anyufw reload</code></pre><p><code>ufw insert</code> ã§ã¯ãªãã€<code>ufw route insert</code> ã¨ã™ã‚‹ã“ã¨</p><p>ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã§ãƒ«ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã€ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ãªã“ã¨ã‚’ç¢ºèª</p><pre class=" language-bash"><code class="language-bash">ufw route delete deny from <span class="token operator">&lt;</span>ip<span class="token operator">></span> to anyufw reload</code></pre><h3 id="Docker-ãƒ­ã‚°ã®æ§‹æˆ"><a href="#Docker-ãƒ­ã‚°ã®æ§‹æˆ" class="headerlink" title="Docker ãƒ­ã‚°ã®æ§‹æˆ"></a>Docker ãƒ­ã‚°ã®æ§‹æˆ</h3><p>ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã®ãƒ­ã‚°ã¯ Azure Monitor ã«é€ä¿¡ã—ãŸã‹ã£ãŸã‘ã©ã€ã–ã£ã¨èª¿ã¹ãŸé™ã‚Šã§ã¯ syslog ä»¥å¤–ã‚’è»¢é€ã™ã‚‹ã®ã¯ã‚ã‚“ã©ãã†ãªã®ã§ã€Docker ã®ãƒ­ã‚°ã‚‚ syslog ã«å…¨éƒ¨é€ã‚‹ã“ã¨ã«ã€‚</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">services</span><span class="token punctuation">:</span>  <span class="token key atrule">nginx-proxy</span><span class="token punctuation">:</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginxproxy/nginx<span class="token punctuation">-</span>proxy    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>proxy    <span class="token key atrule">ports</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"80:80"</span>      <span class="token punctuation">-</span> <span class="token string">"443:443"</span>    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> /var/run/docker.sock<span class="token punctuation">:</span>/tmp/docker.sock<span class="token punctuation">:</span>ro      <span class="token punctuation">-</span> ./certs<span class="token punctuation">:</span>/etc/nginx/certs<span class="token punctuation">:</span>rw      <span class="token punctuation">-</span> ./vhost.d<span class="token punctuation">:</span>/etc/nginx/vhost.d      <span class="token punctuation">-</span> ./html<span class="token punctuation">:</span>/usr/share/nginx/html      <span class="token punctuation">-</span> ./custom<span class="token punctuation">-</span>nginx.conf<span class="token punctuation">:</span>/etc/nginx/conf.d/custom<span class="token punctuation">-</span>nginx.conf<span class="token punctuation">:</span>ro    <span class="token key atrule">networks</span><span class="token punctuation">:</span>      <span class="token key atrule">proxy-network</span><span class="token punctuation">:</span>        <span class="token key atrule">ipv4_address</span><span class="token punctuation">:</span> 172.18.0.2    <span class="token key atrule">labels</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> com.github.nginx<span class="token punctuation">-</span>proxy.nginx<span class="token punctuation">-</span>proxy.keepalive=auto    <span class="token key atrule">logging</span><span class="token punctuation">:</span>      <span class="token key atrule">driver</span><span class="token punctuation">:</span> syslog      <span class="token key atrule">options</span><span class="token punctuation">:</span>        <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"nginx-proxy"</span></code></pre><p>ãƒ­ã‚°ãŒã§ã‚‹ã“ã¨ã‚’ç¢ºèª</p><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">tail</span> -f /var/log/syslog <span class="token operator">|</span> <span class="token function">grep</span> nginx-proxy</code></pre><h3 id="fail2ban-ã®è¨­å®š"><a href="#fail2ban-ã®è¨­å®š" class="headerlink" title="fail2ban ã®è¨­å®š"></a>fail2ban ã®è¨­å®š</h3><p><code>/etc/fail2ban/jail.d/nginx-proxy.local</code> ã«ä»¥ä¸‹ã®è¨­å®šã‚’è¿½åŠ </p><pre class=" language-conf"><code class="language-conf">[nginx-proxy]enabled = trueport = http,httpsfilter = nginx-proxylogpath = /var/log/syslogmaxretry = 5bantime = 600findtime = 600</code></pre><p>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¯ <code>/etc/fail2ban/filter.d/nginx-proxy.conf</code> ã«ä»¥ä¸‹ã®è¨­å®šã‚’è¿½åŠ ã—ã¦ 404 ã‚¨ãƒ©ãƒ¼ã‚’æ¤œçŸ¥ã™ã‚‹ã‚ˆã†ã«ã—ãŸ</p><pre class=" language-conf"><code class="language-conf">[Definition]failregex = ^.*nginx-proxy.*\.example\.com\s<HOST>\s-\s-\s.*HTTP/.*" 404</code></pre><p>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒã†ã¾ãå‹•ã„ã¦ã„ã‚‹ã‹ã¯ fail2ban-regex ã§ç¢ºèªã™ã‚‹</p><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> fail2ban-regex /var/log/syslog /etc/fail2ban/filter.d/nginx-proxy.conf</code></pre><p>è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ .local ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†</p><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span>  <span class="token function">cp</span> /etc/fail2ban/jail.conf /etc/fail2ban/jail.local</code></pre><pre class=" language-diff"><code class="language-diff"><span class="token deleted">-#ignoreip = 127.0.0.1/8 ::1</span><span class="token inserted">+ ignoreip = 127.0.0.1/8 ::1 192.168.0.0/16 172.0.0.0/12</span><span class="token deleted">- banaction = iptables-multiport</span><span class="token inserted">+ banaction = ufw</span>enable = true</code></pre><p>(ã‚‚ã¨ã‚‚ã¨ã® iptables-multiport ã ã£ãŸã‚‰åˆæœŸè¨­å®šã§å‹•ã„ã¦ãŸèª¬ã¯ã‚ã‚‹)</p><p>ufw ã§ ufw route ã‚‚ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã‚ˆã†ã€<code>/etc/fail2ban/action.d/ufw.conf</code> ã‚’ä¿®æ­£</p><pre class=" language-diff"><code class="language-diff">actionban = [ -n "&lt;application>" ] &amp;&amp; app="app &lt;application>"            ufw insert &lt;insertpos> &lt;blocktype> from &lt;ip> to &lt;destination> $app &amp;&amp;<span class="token inserted">+            ufw route insert &lt;insertpos> &lt;blocktype> from &lt;ip> to &lt;destination> $app</span>actionunban = [ -n "&lt;application>" ] &amp;&amp; app="app &lt;application>"              ufw delete &lt;blocktype> from &lt;ip> to &lt;destination> $app&amp;&amp;<span class="token inserted">+              ufw route delete &lt;blocktype> from &lt;ip> to &lt;destination> $app</span></code></pre><p>è¨­å®šã‚’å¤‰æ›´ã—ãŸã‚‰ fail2ban ã‚’å†èµ·å‹•</p><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> systemctl restart fail2ban</code></pre><h3 id="å‹•ä½œç¢ºèª"><a href="#å‹•ä½œç¢ºèª" class="headerlink" title="å‹•ä½œç¢ºèª"></a>å‹•ä½œç¢ºèª</h3><p>å®Ÿéš›ã« 404 ã‚’ç™ºç”Ÿã•ã›ã‚‹ã‚¢ã‚¯ã‚»ã‚¹ã‚’è©¦ã¿ã¦ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ã‹æ¤œè¨¼ã€‚ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸã‚‰ <code>fail2ban-client status</code> ã¨ <code>ufw status</code> ã§ç¢ºèª</p><pre class=" language-bash"><code class="language-bash"><span class="token operator">></span> <span class="token function">sudo</span> fail2ban-client status nginx-proxyStatus <span class="token keyword">for</span> the jail: nginx-proxy<span class="token operator">|</span>- Filter<span class="token operator">|</span>  <span class="token operator">|</span>- Currently failed: 1<span class="token operator">|</span>  <span class="token operator">|</span>- Total failed:     20<span class="token operator">|</span>  <span class="token variable"><span class="token variable">`</span>- File list:        /var/log/syslog<span class="token variable">`</span></span>- Actions   <span class="token operator">|</span>- Currently banned: 1   <span class="token operator">|</span>- Total banned:     4   `- Banned IP list:   20.247.234.38<span class="token operator">></span> <span class="token function">sudo</span> ufw statusStatus: activeTo                         Action      From--                         ------      ----Anywhere                   DENY        20.247.234.38<span class="token punctuation">..</span>.</code></pre><p>ã¡ã‚ƒã‚“ã¨ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸã€‚<br>iptables -L ã§ Docker èµ·å‹•æ™‚ã«ä½œã‚‰ã‚Œã‚‹ãƒ«ãƒ¼ãƒ«ã‚’ç†è§£ã—ã¦ã€fail2ban ã®æ—¢å®šã® iptables-multicast ã§å•é¡Œãªã„ã®ã‹ç¢ºèªã—ãŸã„ã‘ã©ã€ã¾ã‚å‹•ã„ã¦ã„ã‚‹ã‚“ã§ä»Šå›ã¯ã“ã‚Œã§ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Ubuntu 22.04 ã‚’ä½¿ã£ã¦ã„ã‚‹ã‚µãƒ¼ãƒãƒ¼ã§ã¯ã€åŸºæœ¬çš„ã« Firewall ã¨ã—ã¦ ufw ã‚’ä½¿ã£ã¦ã„ã‚‹ã¨æ€ã†ã€‚ã—ã‹ã—ãªãŒã‚‰ã€Docker ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ Docker ãŒè‡ªå‹•çš„ã« iptables ã®ãƒã‚§ãƒ¼ãƒ³ã‚’ä½œæˆã—ã€ufw ã‚’è¿‚å›ã™ã‚‹ãŸã‚ã€ufw ã§ã®åˆ¶é™
      
    
    </summary>
    
    
      <category term="Docker" scheme="http://blog.haniyama.com/tags/Docker/"/>
    
      <category term="home-server" scheme="http://blog.haniyama.com/tags/home-server/"/>
    
  </entry>
  
  <entry>
    <title>ä¹…ã—ã¶ã‚Šã«è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¦ã¦ Nextcloud ã‚’å‹•ã‹ã™</title>
    <link href="http://blog.haniyama.com/2024/02/15/home-server-nextcloud/"/>
    <id>http://blog.haniyama.com/2024/02/15/home-server-nextcloud/</id>
    <published>2024-02-15T03:00:00.000Z</published>
    <updated>2024-02-18T06:11:33.498Z</updated>
    
    <content type="html"><![CDATA[<p>ä»¥å‰è²·ã£ãŸãƒŸãƒ‹ PC ã‚’è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ã«ã—ã‚ˆã†ã¨ã—ã¦ã„ãŸã®ã ãŒã€ã¾ã£ãŸãæ™‚é–“ãŒç„¡ãã¦æ”¾ç½®ã—ã¦ã„ãŸã€‚è‚²ä¼‘ä¸­ã«å°‘ã—æ™‚é–“ãŒå–ã‚ŒãŸã®ã§ã€ã¨ã‚Šã‚ãˆãš Ubuntu ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ Nextcloud ã‚’å‹•ã‹ã—ã¦ã¿ãŸã€‚docker ã‚’ä½¿ã£ã¦æ§‹æˆã—ãŸãŒçµæ§‹ãƒãƒã£ãŸã®ã§ã€ãã®è¾ºã®ãƒ¡ãƒ¢ã€‚</p><span id="more"></span><h2 id="ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆã«ã¤ã„ã¦"><a href="#ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆã«ã¤ã„ã¦" class="headerlink" title="ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆã«ã¤ã„ã¦"></a>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆã«ã¤ã„ã¦</h2><p>IIJMio ã²ã‹ã‚Šã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ã€æ™®æ®µã¯ DS-Lite IPv4 over IPv6 ã§ã®é€šä¿¡ã‚’ã—ã¦ã„ã‚‹ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¯è©³ã—ããªã„ãŒã€DS-Lite ã§ã¯è¤‡æ•°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒä¸€ã® IPv4 ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…±æœ‰ã™ã‚‹ã“ã¨ã«ãªã‚‹ã®ã§ã€ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ãŒã§ããªã„ã€‚</p><p>å½“åˆã¯ IPv4 ã§ã®å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ã¨ DS-Lite ã®ä¸¡ç«‹ã‚’ç›®æŒ‡ã—ãŸãŒå®Ÿéš›ã« PPPoE æ¥ç¶šã‚’è©¦ã—ãŸã¨ã“ã‚ã€æ—¥ä¸­ã‚„å¤•æ–¹ã®æ··é›‘éšŠã§ã‚‚ DS-Lite ã¨éœè‰²ãŒãªã„ã“ã¨ãŒåˆ†ã‹ã£ãŸã€‚ã¨ã„ã†ã“ã¨ã§ã€PPPoE ã§æ™®é€šã«ãƒ«ãƒ¼ã‚¿ãƒ¼ã§ NAT ã™ã‚‹ã€‚</p><p>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒé…ã„ã¨æ„Ÿã˜ãŸã‚‰ãã®æ™‚ã«å‹‰å¼·ã—ã¾ã™ã€‚ä¸€èˆ¬ã®ã”å®¶åº­ãªã®ã§â€¦ã€‚</p><p>é€Ÿåº¦æ¸¬å®šã¯ <a href="https://www.speedtest.net/ja/apps/cli">speedtest-cli</a> ã§è¡Œã£ãŸã€‚</p><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> curlcurl -s https://packagecloud.io/install/repositories/ookla/speedtest-cli/script.deb.sh <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">bash</span><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> speedtest</code></pre><p>cron ã§å®šæœŸçš„ã«æ¸¬å®šã™ã‚‹ã‚ˆã†ã«ã—ãŸã®ã ãŒã€sppedtest ã‚³ãƒãƒ³ãƒ‰ã ã‘ã§ã¯æ—¥ä»˜ãŒå‡ºãªã„ã®ã§ã€3æ—¥ãã‚‰ã„ç„¡é§„ã«ã—ãŸã€‚ã‚ã‚‰ã‹ã˜ã‚é©å½“ã«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ ã—ã¦ãŠãã“ã¨ã€‚</p><pre class=" language-cron"><code class="language-cron">24  *   *   *   *   now=\"$(date +"\%Y-\%m-\%d \%H:\%M:\%S")\",; /usr/bin/speedtest -f csv -s 48463 | sed "s/^/$now/" >> /home/user/speedtest.csv</code></pre><p>jupyter notebook ã§ pandas ã§èª­ã¿è¾¼ã‚“ã§ã‚°ãƒ©ãƒ•åŒ–ã€‚ã“ã†ã„ã†ã®ã¯ Copilot Chat ã«èã‘ã°å‹æ‰‹ã«ã‚„ã£ã¦ãã‚Œã‚‹ã®ã§å¬‰ã—ã„ã€‚</p><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt<span class="token comment" spellcheck="true"># Load the CSV file</span>data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'speedtest.csv'</span><span class="token punctuation">)</span>data<span class="token punctuation">[</span><span class="token string">'download Mbps'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'download'</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">125000</span>data<span class="token punctuation">[</span><span class="token string">'upload Mbps'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'upload'</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">125000</span><span class="token comment" spellcheck="true"># Assuming 'time' is the column with time information</span>data<span class="token punctuation">[</span><span class="token string">'time jst'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'datetime utc'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dt<span class="token punctuation">.</span>tz_localize<span class="token punctuation">(</span><span class="token string">'UTC'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dt<span class="token punctuation">.</span>tz_convert<span class="token punctuation">(</span><span class="token string">'Asia/Tokyo'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># Extract hour from time</span>data<span class="token punctuation">[</span><span class="token string">'hour'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'time jst'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dt<span class="token punctuation">.</span>hour<span class="token comment" spellcheck="true"># Set 'time jst' as the index of the DataFrame</span>data<span class="token punctuation">.</span>set_index<span class="token punctuation">(</span><span class="token string">'time jst'</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># Plot 'download Mbps' and 'upload Mbps' over time</span>data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'download Mbps'</span><span class="token punctuation">,</span> <span class="token string">'upload Mbps'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># Show the plot</span>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># Group by hour and calculate mean download speed</span>average_speed_by_hour <span class="token operator">=</span> data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'hour'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'download Mbps'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># Plot the average download speed by hour</span>average_speed_by_hour<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">)</span>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p><img src="/2024/02/15/home-server-nextcloud/timechart.png" alt=""></p><p>é…ã„ã¨ãã§ã‚‚ä¸Šä¸‹ 500Mbps ãã‚‰ã„å‡ºã¦ã„ã‚‹ã®ã§ã€ç‰¹ã«å•é¡Œã¯ãªã•ãã†ã ã€‚</p><h2 id="Ubuntu-22-04-ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹-Docker-ãŒå¤ã„"><a href="#Ubuntu-22-04-ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹-Docker-ãŒå¤ã„" class="headerlink" title="Ubuntu 22.04 ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ Docker ãŒå¤ã„"></a>Ubuntu 22.04 ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ Docker ãŒå¤ã„</h2><p>Ubuntu 22.04 ã®åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­ã«è‰²ã€…ã¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒã§ãã‚‹ã®ã ãŒã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã« snap ãŒæ¡ç”¨ã•ã‚Œã¦ã„ã‚‹ã€‚snap ã§ Docker ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨ã€æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ãªã„å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã—ã¾ã†ã€‚</p><p>ã‚ã¾ã‚Šå•é¡Œã«ãªã‚‹ã“ã¨ã¯ãªã„ã¨æ€ã†ãŒã€ç§ã®ç’°å¢ƒã§ã¯ä»¥ä¸‹ã®ãƒã‚°ã‚’è¸ã‚“ã§ã—ã¾ã„ docker compose exec ãŒä½¿ãˆãªããªã£ã¦ã—ã¾ã£ãŸã€‚</p><p><a href="https://github.com/docker/compose/issues/11154">[BUG] docker-compose http: invalid Host header Â· Issue #11154 Â· docker/compose</a></p><p><code>sudo snap refresh docker --channel=latest/edge</code> ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°ã§ãã‚‹ã‚‰ã—ã„ãŒã€ãã®æƒ…å ±ã‚’è¦‹ã¤ã‘ã‚‹å‰ã« snap ã® docker ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã€å…¬å¼ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã‚’å‚è€ƒã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ç›´ã—ã¦ã—ã¾ã£ãŸã€‚</p><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> aa-remove-unknownsnap list <span class="token function">sudo</span> snap remove docker<span class="token comment" spellcheck="true"># å†èµ·å‹•å¾Œ Docker å…¬å¼ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã‚’å®Ÿæ–½</span></code></pre><h2 id="Nextcloud-ã‚’-Docker-ã§å‹•ã‹ã™"><a href="#Nextcloud-ã‚’-Docker-ã§å‹•ã‹ã™" class="headerlink" title="Nextcloud ã‚’ Docker ã§å‹•ã‹ã™"></a>Nextcloud ã‚’ Docker ã§å‹•ã‹ã™</h2><p>ã‚°ã‚°ã‚Œã°è‰²ã€…è¨˜äº‹ãŒã‚ã‚‹ãŒã€<a href="https://github.com/nextcloud/all-in-one">Nextcloud All-in-One</a> (Nextcloud AIO) ã‚’åˆ©ç”¨ã™ã‚‹ã‹ snap ã§ãƒ›ã‚¹ãƒˆã«ç›´æ¥ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã®ãŒä¸€ç•ªæ¥½ãã†ã ã£ãŸã€‚ç‰¹ã« AIO ç‰ˆã¯æ©Ÿèƒ½ãƒ¢ãƒªãƒ¢ãƒªã§ä¾¿åˆ©ãªã®ã ãŒã€AIO è‡ªä½“ãŒ docker ã‚³ãƒ³ãƒ†ãƒŠã‚’è¤‡æ•°ç«‹ã¡ä¸Šã’ã‚‹ã‚ˆã†ãªã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã€é‡åšéãã‚‹ã®ã§ä»Šå›ã¯ãƒ‘ã‚¹ã€‚<br>ãã‚‚ãã‚‚ã€ãƒ•ãƒ­ãƒ³ãƒˆã« nginx-proxy ã‚’ç½®ã„ã¦æ¤œè¨¼ã‚¢ãƒ—ãƒªã‚’è‰²ã€…å‹•ã‹ã—ãŸã‹ã£ãŸãŸã‚ã€è‡ªåˆ†ã§ docker-compose.yml ã‚’æ›¸ãã“ã¨ã«ã—ãŸã€‚</p><h3 id="ngix-proxy"><a href="#ngix-proxy" class="headerlink" title="ngix-proxy"></a>ngix-proxy</h3><p><a href="https://github.com/nginx-proxy/nginx-proxy">nginx-proxy</a> ã¯ docker.sock ã‚’ãƒã‚¦ãƒ³ãƒˆã—ã¦ã€èµ·å‹•ä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ç›£è¦–ã—ã¦è‡ªå‹•ã§ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã®è¨­å®šã‚’è¡Œã£ã¦ãã‚Œã‚‹ã€‚nginxproxy/acme-companion ã¯ nginx-proxy ãŒè¨­å®šã—ãŸãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã®è¨­å®šã‚’å…ƒã« Letâ€™s Encrypt ã®è¨¼æ˜æ›¸ã‚’è‡ªå‹•ã§å–å¾—ã—ã¦ãã‚Œã‚‹<br>ã‚ã‚‰ã‹ã˜ã‚ <code>docker network create proxy-network --subnet 172.18.0.0/16</code> ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ä½œæˆã—ã¦ãŠãã€‚ã‚µãƒ–ãƒãƒƒãƒˆã¯ Nextcloud ã® Trusted Proxy ã®ãŸã‚ã«å®šç¾©ã™ã‚‹ã€‚</p><pre class=" language-yml"><code class="language-yml">version: '3'services:  nginx-proxy:    image: nginxproxy/nginx-proxy    container_name: nginx-proxy    ports:      - "80:80"      - "443:443"    volumes:      - /var/run/docker.sock:/tmp/docker.sock:ro      - ./certs:/etc/nginx/certs:rw      - ./vhost.d:/etc/nginx/vhost.d      - ./html:/usr/share/nginx/html      - ./custom-nginx.conf:/etc/nginx/conf.d/custom-nginx.conf:ro    networks:      proxy-network:        ipv4_address: 172.18.0.2    labels:      - com.github.nginx-proxy.nginx-proxy.keepalive=auto  letsencrypt:    image: nginxproxy/acme-companion    container_name: nginx-acme        depends_on:      - nginx-proxy    environment:      - DEFAULT_EMAIL=$&#123;MAILADDRESS&#125;      - NGINX_PROXY_CONTAINER=nginx-proxy    volumes:      - /var/run/docker.sock:/var/run/docker.sock:ro      - ./certs:/etc/nginx/certs:rw      - ./vhost.d:/etc/nginx/vhost.d      - ./html:/usr/share/nginx/html    networks:      - proxy-network  ddclient:    image: lscr.io/linuxserver/ddclient:latest    container_name: ddclient    environment:      - PUID=1000      - PGID=1000      - TZ=Etc/UTC    volumes:      - ./ddclient_conf:/config    restart: unless-stoppednetworks:  proxy-network:    external: true    driver: bridge    ipam:      config:        - subnet: 172.18.0.0/16</code></pre><p>ã‚¦ãƒã® IP ã¯å‹•çš„ã‚¢ãƒ‰ãƒ¬ã‚¹ãªã®ã§ã€ddclient ã§ DNS ã‚’æ›´æ–°ã™ã‚‹ã€‚CloudFlare ã®å ´åˆã¯ã“ã‚“ãªæ„Ÿã˜ã€‚CloudFlare ã® API ãƒˆãƒ¼ã‚¯ãƒ³ã¯ DNS Read, Write ã®æ¨©é™ã§ååˆ†ã ã£ãŸã€‚<br>ãªãŠã€ã‚ã‚‰ã‹ã˜ã‚ DNS ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒãªã„ã¨å‹•ä½œã—ãªã„ã®ã§ã€æ‰‹å‹•ã§ä½œæˆã—ã¦ãŠãã“ã¨ã€‚</p><pre class=" language-conf"><code class="language-conf"># Even though we use -foreground, daemon= is still needed.# It's value here is ignored, but it's needed. The value used is set in# ddclient.in in the dockerfile.daemon=0verbose=nossl=yesuse=web, web=he   # checkip.dns.he.netprotocol=cloudflarelogin=tokenpassword='yourtoken'zone=example.comdns1.example.com, dns2.example.com</code></pre><p><code>/etc/nginx/vhost.d</code> ã«ãƒ›ã‚¹ãƒˆåã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ãã“ã¨ã§ã€å„ãƒ›ã‚¹ãƒˆã”ã¨ã«è¿½åŠ è¨­å®šãŒã§ãã‚‹ã€‚ä¾‹ãˆã° example.com å‘ã‘ã®è¨­å®šã‚’è¿½åŠ ã—ãŸã‘ã‚Œã° <code>/etc/nginx/vhost.d/example.com</code> ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã™ã‚‹ã€‚Nextcloud ã®ãƒ›ã‚¹ãƒˆåã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚„ Body ä¸Šé™ã®å¤‰æ›´ãªã©ã‚’ã—ã¦ãŠãã€‚</p><pre class=" language-ini"><code class="language-ini">send_timeout 300;keepalive_timeout 300;proxy_read_timeout 300;proxy_connect_timeout 300;proxy_send_timeout 300;client_max_body_size 1G;</code></pre><h3 id="Nextcloud-æœ¬ä½“"><a href="#Nextcloud-æœ¬ä½“" class="headerlink" title="Nextcloud æœ¬ä½“"></a>Nextcloud æœ¬ä½“</h3><p>ngix-proxy ã‚’ä½¿ã£ã¦ã„ã¦ nginx å´ã¯ã„ã˜ã‚ŠãŸããªã‹ã£ãŸã®ã§ã€apache ç‰ˆã‚’ <a href="https://github.com/nextcloud/docker/blob/master/.examples/docker-compose/insecure/mariadb/apache/docker-compose.yml">å…¬å¼ã®ã‚µãƒ³ãƒ—ãƒ«</a> ã‚’ã‚‚ã¨ã«ä½œæˆã—ãŸã€‚<br>nginx-proxy ã® vhost.d/ ã«é ‘å¼µã£ã¦è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ã‘ã° nextcloud:fpm ç‰ˆã‚’è‰¯ã„æ„Ÿã˜ã«ä½¿ãˆãã†ã ã£ãŸã‘ã©ã€php ã«ã‚‚ nginx ã®è¨­å®šã‚‚è©³ã—ããªã„ã®ã§ã€ã¨ã‚Šã‚ãˆãš apache ç‰ˆã§ã€‚</p><p>å‡ºæ¥ä¸ŠãŒã£ãŸã®ãŒã“ã‚Œã€‚</p><pre class=" language-yml"><code class="language-yml">version: '3'services:  nextcloud:    build: ./customimages/nextcloud    container_name: nextcloud    volumes:      - nextcloud_data:/var/www/html      # - ./config:/var/www/html/config # for debug      - ./log/:/var/log/nextcloud/      - ./skeleton/:/var/skeleton/      - /mnt/hdd01/:/mnt/hdd01/    env_file:      - ./.env      - ./env/db.env      - ./env/nextcloud.env    secrets:      - nextcloud_admin_password      - nextcloud_admin_user      - mysql_password      - mysql_user      - mysql_database      - smtp_password    networks:      - proxy-network      - nextcloud-network    depends_on:      - db      - redis      - elasticsearch  nextcloud-cron:    build: ./customimages/nextcloud    container_name: nextcloud-cron    restart: unless-stopped    env_file:      - ./.env      - ./env/db.env      - ./env/nextcloud.env    volumes:      - nextcloud_data:/var/www/html      # - ./config:/var/www/html/config # for debug      - ./log/:/var/log/nextcloud/      - ./skeleton/:/var/skeleton/      - /mnt/hdd01/:/mnt/hdd01/      # if customize cron file      # https://help.nextcloud.com/t/docker-setup-cron/78547/5      # https://github.com/nextcloud/docker/blob/ccdf46609ff8419ffd7c5ce4e51a117e378b72b6/Dockerfile-debian.template#L15      # - ./mycronfile:/var/spool/cron/crontabs/www-data    secrets:      - nextcloud_admin_password      - nextcloud_admin_user      - mysql_password      - mysql_user      - mysql_database      - smtp_password    networks:      - nextcloud-network    entrypoint: /cron.sh    depends_on:      - nextcloud  db:    image: mariadb    container_name: nextcloud-db    volumes:      - db_data:/var/lib/mysql    env_file:      - ./.env      - ./env/db.env    secrets:      - mysql_database      - mysql_password      - mysql_user      - mysql_root_password    networks:      - nextcloud-network  redis:    image: redis:6    container_name: nextcloud_redis    restart: always    command: ["--databases", "1"]    healthcheck:      test: ["CMD", "redis-cli", "ping"]      interval: 10s      timeout: 5s      retries: 5    volumes:      - redis_data:/data    networks:      - nextcloud-network  elasticsearch:    build: ./customimages/elasticsearch    container_name: elasticsearch    restart: always    environment:      - discovery.type=single-node      - bootstrap.memory_lock=true      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"      - xpack.security.enabled=false    volumes:      - elasticsearch_data:/usr/share/elasticsearch/data    networks:      - nextcloud-networksecrets:  nextcloud_admin_password:    file: ./secrets/nextcloud_admin_password  nextcloud_admin_user:    file: ./secrets/nextcloud_admin_user  mysql_password:    file: ./secrets/mysql_password  mysql_user:    file: ./secrets/mysql_user  mysql_database:    file: ./secrets/mysql_database  mysql_root_password:    file: ./secrets/mysql_root_password  smtp_password:    file: ./secrets/smtp_passwordvolumes:  nextcloud_data:  db_data:  redis_data:  elasticsearch_data:networks:  proxy-network:    external: true    driver: bridge    ipam:      config:        - subnet: 172.18.0.0/16  nextcloud-network:    driver: bridge</code></pre><h3 id="ãƒã‚¤ãƒ³ãƒˆãƒ¡ãƒ¢"><a href="#ãƒã‚¤ãƒ³ãƒˆãƒ¡ãƒ¢" class="headerlink" title="ãƒã‚¤ãƒ³ãƒˆãƒ¡ãƒ¢"></a>ãƒã‚¤ãƒ³ãƒˆãƒ¡ãƒ¢</h3><p>Nextcloud æœ¬ä½“ã¯ nginx-proxy ã¨åŒä¸€ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«ãŠã„ã¦ã€ãã‚Œä»¥å¤–ã®ã‚³ãƒ³ãƒ†ãƒŠ nextcloud-network ã‚’ä½œæˆã—ã¦ãã“ã«é…ç½®ã—ãŸã€‚</p><h4 id="ç’°å¢ƒå¤‰æ•°"><a href="#ç’°å¢ƒå¤‰æ•°" class="headerlink" title="ç’°å¢ƒå¤‰æ•°"></a>ç’°å¢ƒå¤‰æ•°</h4><p>.env ãƒ•ã‚¡ã‚¤ãƒ«ãªã©ã®ä¸­èº«ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚</p><pre class=" language-ini"><code class="language-ini">#for nginx-proxy<span class="token constant">VIRTUAL_HOST</span><span class="token attr-value"><span class="token punctuation">=</span>$&amp;#123;YOUR_DOMAIN&amp;#125;</span><span class="token constant">LETSENCRYPT_HOST</span><span class="token attr-value"><span class="token punctuation">=</span>$&amp;#123;YOUR_DOMAIN&amp;#125;</span><span class="token constant">LETSENCRYPT_EMAIL</span><span class="token attr-value"><span class="token punctuation">=</span>$&amp;#123;MAIL_ADDRESS&amp;#125;</span># trust nginx proxy<span class="token constant">TRUSTED_PROXIES</span><span class="token attr-value"><span class="token punctuation">=</span>172.18.0.2/32</span><span class="token constant">OVERWRITEHOST</span><span class="token attr-value"><span class="token punctuation">=</span>$&amp;#123;YOUR_DOMAIN&amp;#125;</span><span class="token constant">OVERWRITEPROTOCOL</span><span class="token attr-value"><span class="token punctuation">=</span>https</span>#admin password<span class="token constant">NEXTCLOUD_ADMIN_PASSWORD_FILE</span><span class="token attr-value"><span class="token punctuation">=</span>/run/secrets/nextcloud_admin_password</span><span class="token constant">NEXTCLOUD_ADMIN_USER_FILE</span><span class="token attr-value"><span class="token punctuation">=</span>/run/secrets/nextcloud_admin_user</span><span class="token constant">NEXTCLOUD_TRUSTED_DOMAINS</span><span class="token attr-value"><span class="token punctuation">=</span>$&amp;#123;YOUR_DOMAIN&amp;#125;</span># redis settings<span class="token constant">REDIS_HOST</span><span class="token attr-value"><span class="token punctuation">=</span>nextcloud_redis</span># smtp settings<span class="token constant">SMTP_HOST</span><span class="token attr-value"><span class="token punctuation">=</span>smtp.sendgrid.net</span><span class="token constant">SMTP_NAME</span><span class="token attr-value"><span class="token punctuation">=</span>apikey</span><span class="token constant">SMTP_PASSWORD_FILE</span><span class="token attr-value"><span class="token punctuation">=</span>/run/secrets/smtp_password</span><span class="token constant">MAIL_FROM_ADDRESS</span><span class="token attr-value"><span class="token punctuation">=</span>noreply</span><span class="token constant">SMTP_SECURE</span><span class="token attr-value"><span class="token punctuation">=</span>tls</span><span class="token constant">SMTP_AUTHTYPE</span><span class="token attr-value"><span class="token punctuation">=</span>LOGIN</span><span class="token constant">MAIL_DOMAIN</span><span class="token attr-value"><span class="token punctuation">=</span>$&amp;#123;MAIL_DOMAIN&amp;#125;</span># other settings<span class="token constant">PHP_UPLOAD_LIMIT</span><span class="token attr-value"><span class="token punctuation">=</span>10G</span><span class="token constant">NC_default_phone_region</span><span class="token attr-value"><span class="token punctuation">=</span>JP</span><span class="token constant">NC_logtype</span><span class="token attr-value"><span class="token punctuation">=</span>file</span><span class="token constant">NC_logfile</span><span class="token attr-value"><span class="token punctuation">=</span>/var/log/nextcloud/nextcloud.log</span><span class="token constant">NC_loglevel</span><span class="token attr-value"><span class="token punctuation">=</span>0</span><span class="token constant">NC_default_language</span><span class="token attr-value"><span class="token punctuation">=</span>ja</span><span class="token constant">NC_default_locale</span><span class="token attr-value"><span class="token punctuation">=</span>ja_JP</span><span class="token constant">NC_default_timezone</span><span class="token attr-value"><span class="token punctuation">=</span>Asia/Tokyo</span><span class="token constant">NC_skeletondirectory</span><span class="token attr-value"><span class="token punctuation">=</span>/var/skeleton/</span><span class="token constant">NC_maintenance_window_start</span><span class="token attr-value"><span class="token punctuation">=</span>16</span></code></pre><p>NC_ ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒã¤ãç’°å¢ƒå¤‰æ•°ã¯ config.php ã®è¨­å®šã‚’ä¸Šæ›¸ãã™ã‚‹ã€‚ç’°å¢ƒå¤‰æ•°å«ã‚ config.php ã«ç›´æ¥æ›¸ãè¾¼ã‚€ã®ã§ã¯ãªãã€å€¤ã‚’ç„¡è¦–ã—ã¦ç’°å¢ƒå¤‰æ•°ãŒä¸Šæ›¸ãã•ã‚Œã‚‹ã®ã§æ³¨æ„ã€‚ãªã®ã§è¨­å®šãŒé–“é•ã£ã¦ã„ãŸå ´åˆã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã® confing.php ã‚’ç›´æ¥æ›¸ãæ›ãˆã¦ã‚‚åæ˜ ã•ã‚Œãªã„ã€‚ã“ã‚Œã«ãƒãƒã£ã¦ 2, 3 æ™‚é–“ç„¡é§„ã«ã—ãŸã€‚ä¸Šè¨˜è¨­å®šã‚’ã™ã‚Œã°æœ€ä½é™ç®¡ç†ç”»é¢ã§è­¦å‘ŠãŒå‡ºãªããªã‚‹ã¯ãšã€‚</p><p>ã¡ãªã¿ã«ã€Nextcloud ã®ç’°å¢ƒå¤‰æ•°ã¯å¤‰æ•°åã®æœ«å°¾ã« _FILE ã¨ã¤ã‘ã‚‹ã“ã¨ã§ã€docker ã® secrets ã§ç®¡ç†ã§ãã‚‹ã€‚Nextcloud ã‚„æ‹¡å¼µæ©Ÿèƒ½ã®ã®è„†å¼±æ€§ãªã©ã§ç’°å¢ƒå¤‰æ•°ãŒæ¼ã‚ŒãŸæ™‚ã«å‚™ãˆã¦ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç³»ã¯ secrets ã§ç®¡ç†ã™ã‚‹ã“ã¨ã«ã—ãŸã€‚</p><h4 id="SendGrid"><a href="#SendGrid" class="headerlink" title="SendGrid"></a>SendGrid</h4><p>ãƒ¡ãƒ¼ãƒ«ã®é…ä¿¡ã¯ SendGrid ã‚’ä½¿ã£ã¦ã„ã‚‹ã€‚SMTP_NAME ã¯ apikey, SMTP_PASSWORD ã«ã¯ SendGrid ã® API ã‚­ãƒ¼ã‚’è¨­å®šã™ã‚‹ã€‚</p><ul><li>å‚è€ƒ: <a href="https://docs.sendgrid.com/ja/for-developers/sending-email/getting-started-smtp">SMTPãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡æ–¹æ³• | Twilio</a></li></ul><h4 id="skelton-ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª"><a href="#skelton-ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª" class="headerlink" title="skelton ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª"></a>skelton ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª</h4><p>æ–°è¦ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é…ç½®ã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã§ãã‚‹ã€‚æ—¢å®šã ã¨ã‚µãƒ³ãƒ—ãƒ«ã®ç”»åƒãªã©ãŒå…¥ã£ã¦ã„ã‚‹ã®ã§ NC_skeletondirectory=/var/skeleton/ ã§æŒ‡å®šã—ã¦ã€docker-compose.yml ã§ãƒã‚¦ãƒ³ãƒˆã—ã¦ãŠãã€‚ä½¿ã„æ–¹ã® PDF ã§ã‚‚ã¤ãã£ã¦ãƒ„ãƒƒã‚³ã‚“ã§ãŠã</p><h4 id="ãƒ­ã‚°"><a href="#ãƒ­ã‚°" class="headerlink" title="ãƒ­ã‚°"></a>ãƒ­ã‚°</h4><p>apache ç‰ˆã® docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ apache ã®ãƒ­ã‚°ã—ã‹ stdout ã«å‡ºåŠ›ã—ãªã„ã®ã§ docker compose logs ãªã©ã§ Nextcloud å´ã®ãƒ­ã‚°ãŒç¢ºèªã§ããªã„ã€‚ã¾ãŸãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›ã•ã‚Œã¦ã„ãªã‘ã‚Œã°ã€Web ã®ç®¡ç†ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ãƒ­ã‚°ãŒè¦‹ãˆãªãã¦ä¸ä¾¿ãªã®ã§ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ã™ã‚‹ã‚ˆã†ä¿®æ­£ã€‚å‡ºåŠ›å…ˆã® /var/log/nextcloud/ ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã¯ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ¡ãƒ¼ã‚¸å†…ã§ä½œæˆã—ã¦ www-data ã«ã‚ªãƒ¼ãƒŠãƒ¼ã‚’å¤‰æ›´ã—ã¦ãŠãã€‚ å®‰å®šç¨¼åƒã¾ã§ã¯ NC_loglevel ã§ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’ 0 (DEBUG) ã«ã—ã¦ã‚ã‚‹ã€‚ã—ã°ã‚‰ãã—ãŸã‚‰ 3 (ERROR) ã«æˆ»ã™ã€‚</p><h4 id="ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—"><a href="#ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—" class="headerlink" title="ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—"></a>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h4><p>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯é›‘ã« docker volume ã‚’ tar ã§å›ºã‚ã¦ã€å¤–éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ &amp; Azure Blob ã«ä¿å­˜ã—ã¦ã„ã‚‹ã€‚ãƒªã‚¹ãƒˆã‚¢ã¯å‡ºæ¥ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸã‘ã©ã€é›‘ã¯é›‘ã€‚</p><pre class=" language-sh"><code class="language-sh"># maintenance mode on# https://doc.owncloud.com/server/next/admin_manual/maintenance/enable_maintenance.htmlcd /home/watahani/docker_apps/nextclouddocker compose exec -u www-data nextcloud php occ maintenance:mode --ondate=`date '+%Y-%m-%d'`VOLUMES=("nextcloud_db_data" "nextcloud_nextcloud_data" "nextcloud_redis_data" "elasticsearch_data")for VOLUME_NAME in $&#123;VOLUMES[@]&#125;; do    echo back up $VOLUME_NAME start    BACKUP_DESTINATION=/mnt/exthdd/owncloud_backup/$VOLUME_NAME.tar.gz    sudo tar -czf "$BACKUP_DESTINATION" -C "/var/lib/docker/volumes/$VOLUME_NAME" _data    echo upload $VOLUME_NAME start    azcopy copy $BACKUP_DESTINATION "https://example.blob.core.windows.net/backup/$VOLUME_NAME-$date.tar.gz"    echo back up $VOLUME_NAME finish!donedocker compose exec -u www-data nextcloud php occ maintenance:mode --off</code></pre><p>azcopy login ãŒå»ƒæ­¢äºˆå®šã«ãªã‚‹ã‚‰ã—ãã€ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã§ã®èªè¨¼ã®å ´åˆã€ã‚ã‚‰ã‹ã˜ã‚ç’°å¢ƒå¤‰æ•°ã« AZCOPY_SPA_APPLICATION_ID, AZCOPY_SPA_CLIENT_SECRET, AZCOPY_TENANT_ID, AZCOPY_AUTO_LOGIN_TYPE=SPN ã‚’è¨­å®šã—ã¦ãŠãã“ã¨ã€‚</p><pre class=" language-sh"><code class="language-sh">INFO: 'azcopy login' command will be deprecated starting release 10.22. Use auto-login instead. Visit https://learn.microsoft.com/en-us/azure/storage/common/storage-use-azcopy-authorize-azure-active-directory#authorize-without-a-secret-store  to know more.</code></pre><p>ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªèªè¨¼ã¯ azure-cli ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãŠã„ã¦ãã®èªè¨¼æƒ…å ±ã‚’ä½¿ã„ã¾ã‚ã™å®Ÿè£…ã«ç§»è¡Œã—ã¦ã„ãã‚ˆã†ã ã€‚</p><ul><li>å‚è€ƒ: <a href="https://zenn.dev/ciffelia/articles/docker-volume-backup-restore">ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿æŒã—ãŸã¾ã¾Dockerã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒã™ã‚‹</a></li></ul><p>æœ€æ‚ªã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸå†™çœŸãƒ‡ãƒ¼ã‚¿ãŒç„¡äº‹ãªã‚‰è‰¯ã„ã®ã§ã¾ã‚ã“ã‚Œã§ãƒ¨ã‚·ã€‚</p><h4 id="ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ—ãƒª"><a href="#ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ—ãƒª" class="headerlink" title="ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ—ãƒª"></a>ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ—ãƒª</h4><p>ã“ã®è¾ºã‚’å…¥ã‚ŒãŸ</p><ul><li>memories</li><li>fulltextsearch</li><li>fulltextsearch_elasticsearch</li><li>previewgenerator</li></ul><p>ã‚³ãƒãƒ³ãƒ‰ã§å…¥ã‚Œã‚‹ãªã‚‰ <code>docker compose exec -u www-data nextcloud php occ app:install memories</code> ã®ã‚ˆã†ã«ã™ã‚‹ã€‚</p><p>æ§‹ç¯‰ã—ã¦ã„ãŸå½“æ™‚ã€<a href="https://apps.nextcloud.com/">https://apps.nextcloud.com/</a> ãŒç•°å¸¸ã«é‡ãã€ã‚¢ãƒ—ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§å‡ºæ¥ãªã‹ã£ãŸã€‚</p><pre class=" language-json"><code class="language-json">&amp;#<span class="token number">123</span><span class="token punctuation">;</span><span class="token property">"reqId"</span><span class="token operator">:</span><span class="token string">"CIl2uB04J5qvKBuCFJOe"</span><span class="token punctuation">,</span><span class="token property">"level"</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token property">"time"</span><span class="token operator">:</span><span class="token string">"2024-02-03T13:31:32+00:00"</span><span class="token punctuation">,</span><span class="token property">"remoteAddr"</span><span class="token operator">:</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token property">"user"</span><span class="token operator">:</span><span class="token string">"--"</span><span class="token punctuation">,</span><span class="token property">"app"</span><span class="token operator">:</span><span class="token string">"appstoreFetcher"</span><span class="token punctuation">,</span><span class="token property">"method"</span><span class="token operator">:</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token property">"url"</span><span class="token operator">:</span><span class="token string">"--"</span><span class="token punctuation">,</span><span class="token property">"message"</span><span class="token operator">:</span><span class="token string">"Could not connect to appstore: cURL error 28: Operation timed out after 60000 milliseconds with 2514944 out of 6055936 bytes received (see https://curl.haxx.se/libcurl/c/libcurl-errors.html) for https://apps.nextcloud.com/api/v1/apps.json"</span><span class="token punctuation">,</span><span class="token property">"userAgent"</span><span class="token operator">:</span><span class="token string">"--"</span><span class="token punctuation">,</span><span class="token property">"version"</span><span class="token operator">:</span><span class="token string">"28.0.2.5"</span><span class="token punctuation">,</span><span class="token property">"data"</span><span class="token operator">:</span>&amp;#<span class="token number">123</span><span class="token punctuation">;</span><span class="token property">"app"</span><span class="token operator">:</span><span class="token string">"appstoreFetcher"</span>&amp;#<span class="token number">125</span><span class="token punctuation">;</span>&amp;#<span class="token number">125</span><span class="token punctuation">;</span></code></pre><p>å¹¸ã„ä½•åº¦ã‹è©¦ã›ã°é€šä¿¡ã§åˆ‡ã‚‹ã¨ããŒã‚ã£ãŸã®ã§ã€ä¸€æ™‚çš„ã«ã‚ªãƒªã‚¸ãƒŠãƒ«ã® json ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ Blob ã«ãŠã„ã¦å¯¾å‡¦ã—ãŸã€‚å…·ä½“çš„ã«ã¯ <a href="https://apps.nextcloud.com/api/v1/apps.json">https://apps.nextcloud.com/api/v1/apps.json</a> ã¨ <a href="https://apps.nextcloud.com/api/v1/categories.json">https://apps.nextcloud.com/api/v1/categories.json</a> ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€é©å½“ãªã‚µã‚¤ãƒˆã€åŒã˜ãƒ‘ã‚¹ã§å…¬é–‹ã™ã‚‹ã€‚</p><p>ãã®å¾Œã€config.php ã® appstoreurl ã«ã€https://&lt;é©å½“ãªã‚µã‚¤ãƒˆ&gt;/api/v1 ã‚’è¨­å®šã™ã‚‹ã€‚</p><pre class=" language-sh"><code class="language-sh">docker compose exec -u www-data nextcloud php occ --no-warnings config:system:set appstoreurl --value="https://<é©å½“ãªã‚µã‚¤ãƒˆ>/api/v1"</code></pre><p>å…ƒã®ã‚µã‚¤ãƒˆãŒå¾©æ—§ã—ãŸã‚‰å…ƒã«æˆ»ã™</p><pre class=" language-sh"><code class="language-sh">docker compose exec -u www-data nextcloud php occ --no-warnings config:system:delete appstoreurl</code></pre><h4 id="Elastic-Search"><a href="#Elastic-Search" class="headerlink" title="Elastic Search"></a>Elastic Search</h4><p>Elastic Search ã¯æ—¥æœ¬èªæ¤œç´¢ã®ãŸã‚ã« kuromoji_tokenizer ã‚’ä½¿ã†ã‚ˆã†ã«è¨­å®šã—ã¦ãŠãã€‚ãã®ãŸã‚ã« Dockerfile ã«ã¤ã„ã¦ã‚‚ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ã„ã‚‹ã€‚</p><pre class=" language-dockerfile"><code class="language-dockerfile"># Probably from here https://github.com/elastic/elasticsearch/blob/main/distribution/docker/src/docker/DockerfileFROM elasticsearch:8.12.0USER root# hadolint ignore=DL3008RUN set -ex; \    \    export DEBIAN_FRONTEND=noninteractive; \    apt-get update; \    apt-get install -y --no-install-recommends \        tzdata \    ; \    rm -rf /var/lib/apt/lists/*; \    elasticsearch-plugin install --batch ingest-attachment;\    elasticsearch-plugin install --batch analysis-kuromoji;\    elasticsearch-plugin install --batch analysis-icuUSER 1000:0HEALTHCHECK CMD nc -z localhost 9200 || exit 1LABEL com.centurylinklabs.watchtower.enable="false"</code></pre><p>fulltextsearch ã‚’å…¥ã‚ŒãŸã‚‰ã€Web ã®ç®¡ç†ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ <a href="http://elasticsearch:9200">http://elasticsearch:9200</a> ã¨ã€ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã« kuromoji_tokenizer ã‚’æŒ‡å®šã™ã‚‹ã€‚<br>ãã®å¾Œã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®åˆæœŸä½œæˆã‚’ã—ã¦ãŠã</p><pre class=" language-sh"><code class="language-sh">docker compose exec -u www-data nextcloud php occ fulltextsearch:resetdocker compose exec -u www-data nextcloud php occ fulltextsearch:index</code></pre><p>ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å®šæœŸä½œæˆã«ã¤ã„ã¦ã¯ã€<a href="https://rohhie.net/ubuntu22-04-implementing-nextcloud-with-docker/">Ubuntu22.04 Dockerã§Nextcloud | ã‚ã£ã²ãƒ¼</a> ã‚’å‚è€ƒã« /var/www/html/occ fulltextsearch:live â€“service ã‚³ãƒãƒ³ãƒ‰ã‚’èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰å‘¼ã³ã ã™ã‚ˆã† Dockerfile ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸã€‚<br>ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤šãå‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã£ãŸã‚Šã€ãƒãƒƒãƒå‡¦ç†ã‚’ã—ãŸã„ã®ã§ã‚ã‚Œã°å¾Œè¿°ã® cron ã« fulltextsearch:index ã‚’ã‚¸ãƒ§ãƒ–ã¨ã—ã¦è¿½åŠ ã™ã‚Œã°è‰¯ã„ã ã‚ã†ã€‚</p><h4 id="memories-ã¨-previewgenerator"><a href="#memories-ã¨-previewgenerator" class="headerlink" title="memories ã¨ previewgenerator"></a>memories ã¨ previewgenerator</h4><p>memories ã‚’å…¥ã‚Œã‚‹ã“ã¨ã«ã‚ˆã‚Š Google Photo ã®ã‚ˆã†ã«æ—¥ä»˜ã”ã¨ã«å†™çœŸã‚’è¡¨ç¤ºã—ãŸã‚Šã€äººç‰©ã‚„å ´æ‰€ã”ã¨ã«å†™çœŸã‚’è¡¨ç¤ºã—ãŸã‚Šã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚ç”»åƒèªè­˜ã¯åˆ¥é€”ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒå¿…è¦ãªã®ã§ã€ä»Šå›ã¯è©¦ã—ã¦ã„ãªã„ã€‚<br>ã¾ãŸã€memories ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã«ã¯ ffmpeg ãŒå¿…è¦ãªã®ã§ã€Dockerfile ã« ffmpeg ã‚’è¿½åŠ ã—ãŸã€‚</p><p>memories ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨ Nextcloud æ—¢å®šã§ã¯ 2048px ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ç”Ÿæˆã™ã‚‹ã‚‰ã—ã„ã®ã§ã€å°‘ã—å°ã•ãã€‚</p><pre class=" language-sh"><code class="language-sh">docker compose exec -u www-data nextcloud php occ config:system:set preview_max_x --value="1024"docker compose exec -u www-data nextcloud php occ config:system:set preview_max_y --value="1024"</code></pre><p>previewgenerator ã‚‚åˆæœŸä½œæˆã‚’ã—ã¦ãŠã</p><pre class=" language-sh"><code class="language-sh">docker compose exec -it -u www-data nextcloud php occ config:app:set --value="64 256 1024" previewgenerator squareSizesdocker compose exec -it -u www-data nextcloud php occ config:app:set --value="64 256 1024" previewgenerator widthSizesdocker compose exec -it -u www-data nextcloud php occ config:app:set --value="64 256 1024" previewgenerator heightSizes</code></pre><p>å‡ºæ¥ãŸã‚‰åˆå›ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã‚’è¡Œã†</p><pre class=" language-sh"><code class="language-sh">nohup docker compose exec -u www-data nextcloud php occ preview:generate-all&</code></pre><p>çµ‚ã‚ã£ãŸã‚‰ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã‚’ nextcloud-cron ã«è¿½åŠ ã—ã¦å®šæœŸçš„ã«å·®åˆ†ç”Ÿæˆã™ã‚‹ã‚ˆã†æ§‹æˆã™ã‚‹ã€‚</p><pre class=" language-sh"><code class="language-sh">php /var/www/nextcloud/occ preview:pre-generate</code></pre><h4 id="cron"><a href="#cron" class="headerlink" title="cron"></a>cron</h4><p>Nextcloud ã® cron ã‚¸ãƒ§ãƒ–ã¯ã€nextcloud-cron ã¨ã—ã¦åˆ¥ã‚³ãƒ³ãƒ†ãƒŠã§èµ·å‹•ã—ã¦ã„ã‚‹ã€‚</p><p>å‚è€ƒ: <a href="https://help.nextcloud.com/t/docker-setup-cron/78547/5">Docker setup &amp; cron - Reiner_Nippes ã® #5 - ğŸ“¦ Appliances (Docker, Snappy, VM, NCP, AIO) - Nextcloud community</a></p><p>æ—¢å®šã§ã¯ <a href="https://github.com/nextcloud/docker/blob/ccdf46609ff8419ffd7c5ce4e51a117e378b72b6/Dockerfile-debian.template#L15">php -f /var/www/html/cron.php</a> ãŒ 5 åˆ†ã”ã¨ã«å®Ÿè¡Œã•ã‚Œã‚‹ã€‚ä¸Šæ›¸ãã—ãŸã‘ã‚Œã° <code>/var/spool/cron/crontabs/www-data</code> ã‚’ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ãªã©ã—ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã€‚</p><p>memories ã‚„ previewgenerator ã‚’é©å½“ã«å®šæœŸå®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹ã€‚ã“ã®æ™‚ cron ãƒ•ã‚¡ã‚¤ãƒ«ã®æ‰€æœ‰è€…ãŒ root ã§ãªã‘ã‚Œã°å¤±æ•—ã™ã‚‹ã®ã§æ³¨æ„ã€‚</p><ul><li>å‚è€ƒ: <a href="https://keep-memory.com/docker-busybox-crond">dockerã§BusyBox crondãŒå‹•ã‹ãªã„ â€“ numa blog</a></li></ul><pre class=" language-sh"><code class="language-sh">docker compose cp nextcloud-cron:/var/spool/cron/crontabs/www-data ./mycronfileecho '30 18 * * * php /var/www/html/occ preview:pre-generate' >> ./mycronfileecho '5 * * * * php /var/www/html/occ memories:index' >> ./mycronfilesudo chown root:root ./mycronfile</code></pre><p>ã‚³ãƒ³ãƒ†ãƒŠã«ãƒã‚¦ãƒ³ãƒˆ</p><pre class=" language-yaml"><code class="language-yaml">  <span class="token key atrule">nextcloud-cron</span><span class="token punctuation">:</span>    <span class="token key atrule">build</span><span class="token punctuation">:</span> ./customimages/nextcloud    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> nextcloud<span class="token punctuation">-</span>cron    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped    <span class="token key atrule">env_file</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ./.env      <span class="token punctuation">-</span> ./env/db.env      <span class="token punctuation">-</span> ./env/nextcloud.env    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> nextcloud_data<span class="token punctuation">:</span>/var/www/html      <span class="token comment" spellcheck="true"># - ./config:/var/www/html/config # for debug</span>      <span class="token punctuation">-</span> ./log/<span class="token punctuation">:</span>/var/log/nextcloud/      <span class="token punctuation">-</span> ./skeleton/<span class="token punctuation">:</span>/var/skeleton/      <span class="token punctuation">-</span> /mnt/hdd01/<span class="token punctuation">:</span>/mnt/hdd01/      <span class="token comment" spellcheck="true"># if customize cron file</span>      <span class="token comment" spellcheck="true"># https://help.nextcloud.com/t/docker-setup-cron/78547/5</span>      <span class="token comment" spellcheck="true"># https://github.com/nextcloud/docker/blob/ccdf46609ff8419ffd7c5ce4e51a117e378b72b6/Dockerfile-debian.template#L15</span>      <span class="token punctuation">-</span> ./mycronfile<span class="token punctuation">:</span>/var/spool/cron/crontabs/www<span class="token punctuation">-</span>data</code></pre><h4 id="Google-Taskout-ã‹ã‚‰ã®ç§»è¡Œ"><a href="#Google-Taskout-ã‹ã‚‰ã®ç§»è¡Œ" class="headerlink" title="Google Taskout ã‹ã‚‰ã®ç§»è¡Œ"></a>Google Taskout ã‹ã‚‰ã®ç§»è¡Œ</h4><p>ä»Šå›ã¯ Google Photo ã‹ã‚‰ã®ç§»è¡Œãªã®ã§ã€<a href="https://takeout.google.com/settings/takeout">Google Takeout</a> ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ã€Nextcloud ã«å–ã‚Šè¾¼ã‚€ã€‚ä¿å­˜ã—ãŸãƒ‘ã‚¹ã‚’å¤–éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨ã—ã¦ãƒã‚¦ãƒ³ãƒˆã—ã¦ã‚‚è‰¯ã„ã®ã ãŒã€ä»Šå¾Œã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚¹ãƒãƒ›ã®ã‚«ãƒ¡ãƒ©ç”»åƒã¨åŒæ§˜ã®æ‰±ã„ã«ã—ãŸã‹ã£ãŸã®ã§ã€Nextcloud ã«ç›´æ¥å–ã‚Šè¾¼ã‚€ã€‚</p><p>memories ãŒãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã‚Œã‚‹ã‚‰ã—ã„ã®ã§ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ Nextcloud ã«è»¢é€å¾Œã«ä»¥ä¸‹ã‚’å®Ÿè¡Œã™ã‚‹ã€‚</p><pre class=" language-sh"><code class="language-sh"># ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ docker volume ã«è»¢é€sudo mv ./Takeout /var/lib/docker/volumes/&#123;volume_name&#125;/_data/data/&#123;username&#125;/# ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆdocker compose exec -u www-data nextcloud php occ files:scan --path="&#123;username&#125;/files/Takeout"# Google Takeout ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€docker compose exec -u www-data nextcloud sh -c 'yes | php occ memories:migrate-google-takeout'</code></pre><p>ãŒã€æ‰‹å…ƒã®ç’°å¢ƒã§ã¯ã†ã¾ãå‹•ã‹ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã£ãŸã®ã§ã€<a href="https://github.com/TheLastGimbus/GooglePhotosTakeoutHelper">TheLastGimbus/GooglePhotosTakeoutHelper: Script that organizes the Google Takeout archive into one big chronological folder</a> ã‚’ä½¿ã£ã¦ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚“ã ã€‚</p><p>guess-from-name ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ãƒ•ã‚¡ã‚¤ãƒ«åãªã©ã‹ã‚‰æ—¥ä»˜ã‚’æ¨æ¸¬ã—ã¦ãã‚Œã‚‹ã‚‰ã—ã„ã€‚å®Ÿéš›ã« memories ã§å–ã‚Šè¾¼ã‚ãªã‹ã£ãŸãƒ‡ãƒ¼ã‚¿ãªã©ãŒã€ãƒ•ã‚©ãƒ«ãƒ€åã®æ—¥ä»˜ã‚’å…ƒã«å–ã‚Šè¾¼ã¾ã‚ŒãŸã®ã§åŠ©ã‹ã£ãŸã€‚ã‚¢ãƒ«ãƒãƒ ã¯æ—¢å®šã§ã¯å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã¯æ—¥ä»˜ãƒ•ã‚©ãƒ«ãƒ€ã«å…¥ã‚Œã¦ã‚¢ãƒ«ãƒãƒ ç”¨ã«ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’å¼µã‚‹è¨­å®šã‚‰ã—ã„ã®ã§ã€nothing ã«ã—ã¦ãŠãã€‚</p><pre class=" language-sh"><code class="language-sh">wget https://github.com/TheLastGimbus/GooglePhotosTakeoutHelper/releases/download/v3.4.3/gpth-linuxchmod +x gpth-linux./gpth-linux -i ./Takeout/ -o ./output --divide-to-dates --guess-from-name --albums nothing</code></pre><p>ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›å¾Œã€å¿µã®ãŸã‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾Œã«ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ç›´æ¥ Docker Volume ã®ä¸­ã«ç§»å‹•ã€‚</p><pre class=" language-sh"><code class="language-sh">sudo mv ./output/ALL_PHOTOS  /var/lib/docker/volumes/&#123;volume_name&#125;/_data/data/&#123;username&#125;/docker compose exec nextcloud chown -R www-data:www-data /var/lib/docker/volumes/&#123;volume_name&#125;/_data/data/&#123;username&#125;/Takeout</code></pre><p>ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œã‚‹</p><pre class=" language-sh"><code class="language-sh">docker compose exec -u www-data nextcloud php occ files:scan --path="&#123;username&#125;/files/Takeout"</code></pre><p>é›‘ã ã‘ã©å‹•ã„ãŸã®ã§ãƒ¨ã‚·ãƒƒï¼ãã‚‚ãã‚‚ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒã†ã¾ãå–ã‚Šè¾¼ã‚ãªã„å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€å®¶ã® HDD ã«ã‚ªãƒªã‚¸ãƒŠãƒ«ãŒã‚ã‚‹ã®ã§ã©ã“ã‹ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãã‚Œã«å·®ã—æ›¿ãˆã‚ˆã†ã€‚</p><h2 id="æœ€å¾Œã«"><a href="#æœ€å¾Œã«" class="headerlink" title="æœ€å¾Œã«"></a>æœ€å¾Œã«</h2><p>Docker ã§ Nextcloud ã‚’å‹•ã‹ã™ãƒ¡ãƒ¢ã€‚ãƒ•ã‚©ãƒ¼ãƒ©ãƒ ã‚‚å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚ã‹ãªã‚Šå……å®Ÿã—ã¦ã„ã‚‹ã‚‚ã®ã®ã€docker ã§å‹•ã‹ã™ã«ã¯ãã‚Œãªã‚Šã«è‹¦åŠ´ã—ãŸã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã‚„ç›£è¦–ã«ã¤ã„ã¦ã¯ã¾ã å‡ºæ¥ã¦ã„ãªã„ã®ã§ã€å˜ã« Nextcloud ã ã‘ãŒç›®çš„ã§ã‚ã‚Œã° snap ã§å…¥ã‚Œã‚‹ã®ãŒä¸€ç•ªæ¥½ã ã‚ã†ã€‚</p><p>æœ€å¾Œã«èªè¨¼ã®è©±ã‚’ã—ã¦ãŠãã¨ Nextcloud è‡ªä½“ã¯ Passkey ã«å¯¾å¿œã—ã¦ã„ã‚‹ã‚ˆã†ã§ã€å€‹äººè¨­å®šã‹ã‚‰ Android ãƒ‡ãƒã‚¤ã‚¹ã‚„ Windows Hello ã‚’è¿½åŠ ã§ããŸã€‚<br>ãŸã ãƒ¢ãƒã‚¤ãƒ« ã‚¢ãƒ—ãƒªã§ã¯ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã« Chrome ãªã©ãŒèµ·å‹•ã™ã‚‹ã®ã§ã¯ãªãã€hwsecurity.dev ã¨ã„ã†ä¼šç¤¾ãŒæä¾›ã—ã¦ã„ã‚‹ SDK ãŒçµ„ã¿è¾¼ã¾ã‚ŒãŸç‹¬è‡ªãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ãŒèµ·å‹•ã—ã¦ã€Security Key ã—ã‹ä½¿ãˆãªã„ UX ã«ãªã£ã¦ã„ãŸã€‚ãã®ãŸã‚ 2FA ã‚’æœ‰åŠ¹ã«ã—ãŸã†ãˆã§ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã€PC ã§ã‚¢ãƒ—ãƒªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç™ºè¡Œã™ã‚‹ã‹ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ ã‚­ãƒ¼ã‚„ OTP ãªã©åˆ¥ã®èªè¨¼è¦ç´ ã‚’ç™»éŒ²ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ã®ã§æ³¨æ„ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»¥å‰è²·ã£ãŸãƒŸãƒ‹ PC ã‚’è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ã«ã—ã‚ˆã†ã¨ã—ã¦ã„ãŸã®ã ãŒã€ã¾ã£ãŸãæ™‚é–“ãŒç„¡ãã¦æ”¾ç½®ã—ã¦ã„ãŸã€‚è‚²ä¼‘ä¸­ã«å°‘ã—æ™‚é–“ãŒå–ã‚ŒãŸã®ã§ã€ã¨ã‚Šã‚ãˆãš Ubuntu ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ Nextcloud ã‚’å‹•ã‹ã—ã¦ã¿ãŸã€‚docker ã‚’ä½¿ã£ã¦æ§‹æˆã—ãŸãŒçµæ§‹ãƒãƒã£ãŸã®ã§ã€ãã®è¾ºã®ãƒ¡ãƒ¢ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Docker" scheme="http://blog.haniyama.com/tags/Docker/"/>
    
      <category term="home-server" scheme="http://blog.haniyama.com/tags/home-server/"/>
    
  </entry>
  
  <entry>
    <title>App Service Authentication (aka EasyAuth) ã‚’å®‰å…¨ã«ä½¿ã†ãŸã‚ã® Tips</title>
    <link href="http://blog.haniyama.com/2023/08/01/tips-for-using-appservice-authentication-securely/"/>
    <id>http://blog.haniyama.com/2023/08/01/tips-for-using-appservice-authentication-securely/</id>
    <published>2023-07-31T16:00:00.000Z</published>
    <updated>2023-08-01T00:01:21.713Z</updated>
    
    <content type="html"><![CDATA[<p>Azure ã® App Service ã‚„ Functions ãªã©ã® Web ã‚µãƒ¼ãƒ“ã‚¹ã«ã¯ã€Azure AD ã¨é€£æºã—ã¦èªè¨¼ã‚’è¡Œã†æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚App Service èªè¨¼ã¨å‘¼ã°ã‚Œã‚‹æ©Ÿèƒ½ã§ã€æ—§ç§°ï¼Ÿã® EasyAuth ã®æ–¹ãŒé¦´æŸ“ã¿ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚<br>æœ€çŸ­ã§ã¯ã»ã¼ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ã‚¢ãƒ—ãƒªã«èªè¨¼æ©Ÿèƒ½ã‚’è¿½åŠ ã§ãã‚‹ãŸã‚ã€ã¨ã¦ã‚‚ä¾¿åˆ©ã ã€‚ã—ã‹ã—ã€æ—¢å®šã®è¨­å®šã§ã¯ãƒ†ãƒŠãƒ³ãƒˆã®ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŠã‚ˆã³ã‚¢ãƒ—ãƒªãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€è¦ä»¶ã«ã‚ˆã£ã¦ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ‡¸å¿µãŒã‚ã‚‹ã€‚</p><p>ã¨ã„ã†ã“ã¨ã§ EasyAuth ã®æ©Ÿèƒ½ãŒ Azure AD ã‹ã‚‰è¦‹ã¦ã©ã®ã‚ˆã†ãªæ©Ÿèƒ½ãªã®ã‹ã€ã©ã®ã‚ˆã†ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ‡¸å¿µãŒã‚ã‚‹ã®ã‹ã€ã©ã®ã‚ˆã†ã«å¯¾ç­–ã™ã‚‹ã®ã‹ã‚’ã¾ã¨ã‚ã¦ã¿ãŸã€‚</p><span id="more"></span><h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>æ—¢å®šã§ã¯ãƒ†ãƒŠãƒ³ãƒˆã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚„ã‚¢ãƒ—ãƒªãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã¦ã—ã¾ã†ã®ã§ã€ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®è¨­å®šã‚’å®Ÿæ–½ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã™ã‚‹</p><ul><li>App Service èªè¨¼ç”¨ã«ä½œæˆã•ã‚ŒãŸã‚¢ãƒ—ãƒªã® â€œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‰²ã‚Šå½“ã¦ã‚’æœ‰åŠ¹åŒ–â€ ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ¶é™ã™ã‚‹</li><li>App Service èªè¨¼ã®çµ„ã¿è¾¼ã¿èªå¯ãƒãƒªã‚·ãƒ¼ã‚’ä½¿ã£ã¦ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ¶é™ã™ã‚‹</li><li>App Service ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¢ãƒ—ãƒªå´ã§ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ“ã‚¸ãƒã‚¹ ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹</li></ul><h2 id="App-Service-èªè¨¼ã¨ã¯"><a href="#App-Service-èªè¨¼ã¨ã¯" class="headerlink" title="App Service èªè¨¼ã¨ã¯"></a>App Service èªè¨¼ã¨ã¯</h2><p>EasyAuth ã®åŸºæœ¬ã«ã¤ã„ã¦ã¯ã“ã“ã§ã¯è¨˜è¼‰ã—ãªã„ãŒã€ã–ã£ãã‚Šä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’æŒã£ã¦ã„ã‚‹</p><ol><li>OIDC/OAuth ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã—ã¦ã®æ©Ÿèƒ½ (OP ã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚„ã€èªå¯ã‚³ãƒ¼ãƒ‰ã®å–å¾—ã¨å¼•ãæ›ãˆã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚¹ãƒˆã‚¢ãªã©)</li><li>OIDC/OAuth ã® RP ã¨ã—ã¦ã®æ©Ÿèƒ½ (ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼ã€<strong>ç°¡æ˜“çš„ãª</strong>èªå¯ãƒãƒªã‚·ãƒ¼ã®ä½œæˆ)</li></ol><p>ã»ã¨ã‚“ã©ã®å ´åˆã¯ 1 ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã—ã¦ã®æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«æœ‰åŠ¹åŒ–ã™ã‚‹ã¨æ€ã†ãŒã€API ã¨ã—ã¦ã®æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã¯ 2 ã® RP ã¨ã—ã¦ã®æ©Ÿèƒ½ã‚‚åˆ©ç”¨ã™ã‚‹ã“ã¨ã«ãªã‚‹ã€‚<br>ã¤ã¾ã‚Šã€åˆ¥ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§å–å¾—ã—ãŸã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ EasyAuth ã§ä¿è­·ã•ã‚ŒãŸ App Service ã«é€ä¿¡ã—ã€EasyAuth ãŒæ¤œè¨¼ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹ã¨ã„ã†ã“ã¨ãŒã§ãã‚‹ã€‚</p><p>ã“ã“ã§æ³¨æ„ãŒå¿…è¦ãªã®ã¯ EasyAuth ã¯æ—¢å®šã§ã¯ aud ã®æ¤œè¨¼ã¨ iss ãŠã‚ˆã³ç½²åæ¤œè¨¼ã—ã‹è¡Œã‚ãªã„ã“ã¨ã ã€‚ãã—ã¦ Azure AD ã§ã¯ API å´ã§åˆ¶é™ã•ã‚Œã¦ã„ãªã„é™ã‚Šã€åŸºæœ¬çš„ã«ã‚¢ãƒ—ãƒªã¯è‡ªç”±ã«ç‰¹å®šã® aud ã«å¯¾ã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã§ãã‚‹ã®ã§ã€ãƒ†ãƒŠãƒ³ãƒˆã«ç™»éŒ²ã•ã‚ŒãŸã™ã¹ã¦ã®ã‚¢ãƒ—ãƒªãŒ EasyAuth ãŒæœ‰åŠ¹ãªã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ãŒã§ãã‚‹ã€‚</p><h2 id="è©¦ã—ã¦ã¿ã‚‹"><a href="#è©¦ã—ã¦ã¿ã‚‹" class="headerlink" title="è©¦ã—ã¦ã¿ã‚‹"></a>è©¦ã—ã¦ã¿ã‚‹</h2><p>ã¨ã„ã†ã“ã¨ã§ã€ç°¡å˜ãªã‚³ãƒ¼ãƒ‰ã§è©¦ã—ã¦ã¿ã‚‹ã€‚ã¾ãšã¯ App Service ãªã‚Š Functions ãªã‚Šã‚’ä½œã£ã¦ EasyAuth ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã€‚<br>ä½œæˆã—ãŸã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ID ã‚’ãƒ¡ãƒ¢ã£ã¦ãŠã</p><p><img src="/2023/08/01/tips-for-using-appservice-authentication-securely/easyauth-settings.png" alt=""></p><p>ä½œæˆã—ãŸã‚‰ã€ã“ã‚Œã¨ã¯åˆ¥ã« <code>ã‚¢ãƒ—ãƒªã®ç™»éŒ²</code> ã‹ã‚‰é©å½“ãªã‚¢ãƒ—ãƒªã‚’ç™»éŒ²ã—ã¦ã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½œæˆã™ã‚‹ã€‚</p><p><img src="/2023/08/01/tips-for-using-appservice-authentication-securely/app-secret.png" alt=""></p><p>ä½œæˆã—ãŸæ–¹ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ID ã¨ãƒ†ãƒŠãƒ³ãƒˆ ID ã‚‚ãƒ¡ãƒ¢ã£ã¦ãŠã</p><p><img src="/2023/08/01/tips-for-using-appservice-authentication-securely/app-id.png" alt=""></p><p>ãƒ¡ãƒ¢ã£ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ID ã¨ãƒ†ãƒŠãƒ³ãƒˆ IDã€ä½œæˆã—ãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½¿ã£ã¦ã€ãŠã‚‚ã‚€ã‚ã«ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ã€‚</p><pre class=" language-posershell"><code class="language-posershell">$clientId = "e27ad7e4-f5a6-400f-ad8c-99079aaff560"$clientSecret = "************"$tenantId= 'c698d583-792e-44c6-8cd6-31dc9a64795a'$scope = '6c5dd842-bcfe-4a2e-9834-b19bfba1e26b/.default'$tokenEndpoint = "https://login.microsoftonline.com/$tenantId/oauth2/v2.0/token"$postParams = @&#123;    client_id = $clientId;    client_secret = $clientSecret;    grant_type = 'client_credentials';    scope = $scope&#125;$authResult = Invoke-RestMethod -UseBasicParsing -Uri $tokenEndpoint -Method POST -ContentType "application/x-www-form-urlencoded" -Body $postParams</code></pre><p>å–å¾—ã—ãŸã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ EasyAuth ã§ä¿è­·ã•ã‚ŒãŸã‚¢ãƒ—ãƒªã«é€ä¿¡ã—ã¦ã¿ã‚‹ã€‚</p><pre class=" language-posershell"><code class="language-posershell">$headers = @&#123; Authorization = "Bearer $($authResult.access_token)" &#125;$res = Invoke-WebRequest -UseBasicParsing -Uri "https://easyauth-securely.azurewebsites.net/" -Headers $headers$res.StatusCode # => 200</code></pre><p>ã¨ã„ã†ã“ã¨ã§ã€ä½•ã®æ¨©é™ã‚‚æŒãŸãªã„ã‚¢ãƒ—ãƒªãŒ EasyAuth ã§ä¿è­·ã•ã‚ŒãŸã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ãŒå‡ºæ¥ãŸã€‚ã“ã‚Œã¯ç›´æ„Ÿã«åã™ã‚‹å‹•ä½œã«æ€ãˆã‚‹ã€‚</p><h2 id="ãªãœæ¨©é™ãŒãªã„ã®ã«ã‚‚é–¢ã‚ã‚‰ãšã‚¢ã‚¯ã‚»ã‚¹ãŒå‡ºæ¥ãŸã®ã‹"><a href="#ãªãœæ¨©é™ãŒãªã„ã®ã«ã‚‚é–¢ã‚ã‚‰ãšã‚¢ã‚¯ã‚»ã‚¹ãŒå‡ºæ¥ãŸã®ã‹" class="headerlink" title="ãªãœæ¨©é™ãŒãªã„ã®ã«ã‚‚é–¢ã‚ã‚‰ãšã‚¢ã‚¯ã‚»ã‚¹ãŒå‡ºæ¥ãŸã®ã‹"></a>ãªãœæ¨©é™ãŒãªã„ã®ã«ã‚‚é–¢ã‚ã‚‰ãšã‚¢ã‚¯ã‚»ã‚¹ãŒå‡ºæ¥ãŸã®ã‹</h2><p>ã‚·ãƒ³ãƒ—ãƒ«ã« EasyAuth ã¯æ—¢å®šã§ã¯ aud ã®æ¤œè¨¼ã¨ iss, ç½²åæ¤œè¨¼ã—ã‹è¡Œã‚ãªã„ã‹ã‚‰ã ã€‚ã¤ã¾ã‚Šã€ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã® aud ãŒ EasyAuth ã§ä¿è­·ã•ã‚ŒãŸã‚¢ãƒ—ãƒªã®ã‚‚ã®ã§ã‚ã£ã¦ã€ç½²åã®æ¤œè¨¼ãŒã§ãã‚Œã°ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã‚‹ã€‚<br>å…ˆã»ã©å–å¾—ã—ãŸã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã®å†…å®¹ã‚’ <a href="https://jwt.ms">https://jwt.ms</a> ã§è¦‹ã¦ã¿ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå†…å®¹ãŒç¢ºèªã§ãã‚‹</p><p><img src="/2023/08/01/tips-for-using-appservice-authentication-securely/access-token-claims.png" alt=""></p><p>Azure AD ã§ã¯ãƒªã‚½ãƒ¼ã‚¹å´ã§åˆ¶é™ãŒãªã•ã‚Œã¦ã„ãªã„é™ã‚Šã€ã‚¢ãƒ—ãƒªã¯ç‰¹å®šãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œå¯èƒ½ã§ã‚ã‚‹ã€‚<br>ãŸã¨ãˆã° Microsoft Graph API ã«å¯¾ã™ã‚‹ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã€ãƒ†ãƒŠãƒ³ãƒˆã«ç™»éŒ²ã•ã‚ŒãŸã™ã¹ã¦ã®ã‚¢ãƒ—ãƒªã§å–å¾—å¯èƒ½ã§ã‚ã‚‹ã€‚å…ˆã»ã©ã®ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã‚³ãƒ¼ãƒ‰ã® scope ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’ <code>&lt;appid&gt;/.default</code> ã®éƒ¨åˆ†ã‚’ãƒ†ãƒŠãƒ³ãƒˆã«ç™»éŒ²ã•ã‚ŒãŸå¥½ããªã‚¢ãƒ—ãƒªã® ID ã«å·®ã—æ›¿ãˆã¦ã¿ã‚‹ã¨ã€ãã®ã‚¢ãƒ—ãƒªã«å¯¾ã™ã‚‹ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ã§ãã‚‹ã“ã¨ãŒç¢ºèªã§ãã‚‹ã€‚</p><p>ã§ã¯ãƒ†ãƒŠãƒ³ãƒˆã«ç™»éŒ²ã•ã‚ŒãŸã‚¢ãƒ—ãƒªã¯ã€ã©ã® API ã«å¯¾ã—ã¦ã‚‚è‡ªç”±ã«ã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã‹ã¨ã„ã†ã¨ãã†ã§ã¯ãªãã€API å´ã§é€šå¸¸ã¯ãƒˆãƒ¼ã‚¯ãƒ³ã«å«ã¾ã‚Œã‚‹ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’ãƒã‚§ãƒƒã‚¯ã—æ¨©é™ã‚’æŒã£ãŸãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‹ã‚’åˆ¤å®šã™ã‚‹ã€‚<br>è‰¯ãä½¿ã‚ã‚Œã‚‹ã®ã¯ scp (scope) ã‚„ roles ã‚¯ãƒ¬ãƒ¼ãƒ ã ã‚ã†ã€‚</p><p>ãŸã¨ãˆã°ã€Microsoft Graph API ã‚’ã‚¢ãƒ—ãƒªæ¨©é™ã§å‘¼ã³å‡ºãã†ã¨ã™ã‚‹ã¨ã€API ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‹ã‚‰æ¨©é™ã‚’è¿½åŠ ã—ã€ç®¡ç†è€…ã®åŒæ„ã‚’ä»˜ä¸ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒã€ã‚ã‚Œã¯ roles ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã®ä½œæ¥­ã¨ã„ãˆã‚‹ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã§ã® Graph API å‘¼ã³å‡ºã—ã‚’ã™ã‚‹ã‚¢ãƒ—ãƒªã‚’å®Ÿè£…ã™ã‚‹ã¨ãã« scope ã‚’æŒ‡å®šã™ã‚‹ã®ã¯ scp ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã®ä½œæ¥­ã¨ã„ãˆã‚‹ã€‚</p><p>ãŸã ã€å…ˆã»ã©ã‚‚èª¬æ˜ã—ãŸé€šã‚Šã€EasyAuth ã¯æ—¢å®šã§ã¯ aud ã‚¯ãƒ¬ãƒ¼ãƒ ã®æ¤œè¨¼ã—ã‹ã—ãªã„ã€‚ã¤ã¾ã‚Š scp ã‚„ roles ã‚¯ãƒ¬ãƒ¼ãƒ ãŒãªã„ãƒˆãƒ¼ã‚¯ãƒ³ã€ã¤ã¾ã‚Šç‰¹ã«æ¨©é™ã‚’ä»˜ä¸ã—ã¦ã„ãªã„ã‚¢ãƒ—ãƒªãŒå–å¾—ã§ãã‚‹ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã§ã‚‚ã€EasyAuth ã§ä¿è­·ã•ã‚ŒãŸã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã‚‹ã€‚</p><h2 id="ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ã™ã‚‹ã«ã¯"><a href="#ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ã™ã‚‹ã«ã¯" class="headerlink" title="ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ã™ã‚‹ã«ã¯"></a>ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ã™ã‚‹ã«ã¯</h2><p>EasyAuth ã¯ã‚ãã¾ã§ç°¡æ˜“çš„ãªèªè¨¼ã®ä»•çµ„ã¿ã§ã‚ã‚Šã€æ—¢å®šã§ã¯ãƒˆãƒ¼ã‚¯ãƒ³ã® aud ã¨ç½²åã‚’æ¤œè¨¼ã™ã‚‹ã®ã¿ãªã®ã§ã€ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ã™ã‚‹ã«ã¯ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚‹ã€‚</p><ul><li>App Service èªè¨¼ç”¨ã«ä½œæˆã•ã‚ŒãŸã‚¢ãƒ—ãƒªã® â€œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‰²ã‚Šå½“ã¦ã‚’æœ‰åŠ¹â€ ã«ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ¶é™ã™ã‚‹</li><li>App Service èªè¨¼ã®çµ„ã¿è¾¼ã¿èªå¯ãƒãƒªã‚·ãƒ¼ã‚’ä½¿ã£ã¦ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ¶é™ã™ã‚‹</li><li>App Service ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¢ãƒ—ãƒªå´ã§ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ“ã‚¸ãƒã‚¹ ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹</li></ul><p>å®Ÿæ–½ãŒç°¡å˜ãªé †ã«ä¸¦ã¹ãŸãŒã€ãã‚Œãã‚Œã§ã®æ–¹æ³•ã«ã¯ä¸€é•·ä¸€çŸ­ãŒã‚ã‚‹ã€‚ã¾ãŸè¤‡é›‘ãªè¦ä»¶ã‚’æº€ãŸã™ã«ã¯ EasyAuth ã‚’åˆ©ç”¨ã™ã‚‹ã«ã—ã¦ã‚‚ã€ãƒ“ã‚¸ãƒã‚¹ ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›¸ãå¿…è¦ãŒã‚ã‚‹ã€‚</p><h3 id="App-Service-èªè¨¼ç”¨ã«ä½œæˆã•ã‚ŒãŸã‚¢ãƒ—ãƒªã®-â€œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‰²ã‚Šå½“ã¦ã‚’æœ‰åŠ¹â€-ã«ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ¶é™ã™ã‚‹"><a href="#App-Service-èªè¨¼ç”¨ã«ä½œæˆã•ã‚ŒãŸã‚¢ãƒ—ãƒªã®-â€œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‰²ã‚Šå½“ã¦ã‚’æœ‰åŠ¹â€-ã«ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ¶é™ã™ã‚‹" class="headerlink" title="App Service èªè¨¼ç”¨ã«ä½œæˆã•ã‚ŒãŸã‚¢ãƒ—ãƒªã® â€œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‰²ã‚Šå½“ã¦ã‚’æœ‰åŠ¹â€ ã«ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ¶é™ã™ã‚‹"></a>App Service èªè¨¼ç”¨ã«ä½œæˆã•ã‚ŒãŸã‚¢ãƒ—ãƒªã® â€œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‰²ã‚Šå½“ã¦ã‚’æœ‰åŠ¹â€ ã«ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ¶é™ã™ã‚‹</h3><p>ã‚ãªãŸãŒ Azure AD ã®ç®¡ç†è€…ã§ã‚ã‚Šã€Azure AD ã«å¯¾ã™ã‚‹ç®¡ç†æ¨©é™ã‚’æŒã¤å ´åˆã«ã¯æœ€ã‚‚æ‰‹ã£å–ã‚Šæ—©ã„æ–¹æ³•ã¯ <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/howto-restrict-your-app-to-a-set-of-users">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‰²ã‚Šå½“ã¦ã‚’æœ‰åŠ¹åŒ–</a> ã™ã‚‹ã“ã¨ã ã€‚<br>æ—¢å®šã§ã¯ EasyAuth ã«ã‚ˆã‚Šä½œæˆã•ã‚ŒãŸã‚¢ãƒ—ãƒªã¯ <code>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‰²ã‚Šå½“ã¦ãŒæœ‰åŠ¹ã§ã™ã‹?</code> ãŒ <code>ã„ã„ãˆ</code> ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ã“ã‚Œã‚’ <code>ã¯ã„</code> ã«å¤‰æ›´ã™ã‚‹ã€‚</p><p><img src="/2023/08/01/tips-for-using-appservice-authentication-securely/assigned-required.png" alt=""></p><p>ä½œæ¥­ã¯ <code>ã‚¢ãƒ—ãƒªã®ç™»éŒ²</code> ã§ã¯ãªã <code>ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚º ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³</code> ã‹ã‚‰è¡Œã†å¿…è¦ãŒã‚ã‚‹ã®ã§æ³¨æ„ã€‚</p><p>ã“ã®è¨­å®šã‚’å®Ÿæ–½å¾Œã€å†åº¦å…ˆã»ã©ã®ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨ã€ä»Šåº¦ã¯ 401 ã‚¨ãƒ©ãƒ¼ãŒè¿”ã£ã¦ãã‚‹ã“ã¨ãŒç¢ºèªã§ãã‚‹ã€‚</p><pre class=" language-powershell"><code class="language-powershell"><span class="token variable">$authResult</span> = <span class="token function">Invoke-RestMethod</span> <span class="token operator">-</span>UseBasicParsing <span class="token operator">-</span>Uri <span class="token variable">$tokenEndpoint</span> <span class="token operator">-</span>Method POST <span class="token operator">-</span>ContentType <span class="token string">"application/x-www-form-urlencoded"</span> <span class="token operator">-</span>Body <span class="token variable">$postParams</span><span class="token comment" spellcheck="true"># Invoke-RestMethod: &amp;#123;"error":"invalid_grant","error_description":"AADSTS501051: Application 'e27ad7e4-f5a6-400f-ad8c-99079aaff560'(EasyAuth Access App) is not assigned to a role for the application '6c5dd842-bcfe-4a2e-9834-b19bfba1e26b'(easyauth-securely).\r\nTrace ID: 31f83ef7-4e6e-4e4d-9ce7-4d3d04191c00\r\nCorrelation ID: a0ceee27-3cfb-4574-bf22-22289e6452f3\r\nTimestamp: 2023-07-31 14:23:05Z","error_codes":[501051],"timestamp":"2023-07-31 14:23:05Z","trace_id":"31f83ef7-4e6e-4e4d-9ce7-4d3d04191c00","correlation_id":"a0ceee27-3cfb-4574-bf22-22289e6452f3","error_uri":"https://login.microsoftonline.com/error?code=501051"&amp;#125;</span>```</code></pre><p>ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹ã«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨å‰²ã‚Šå½“ã¦ã«å¯¾ã—ã¦ãƒ­ãƒ¼ãƒ«ã®å‰²ã‚Šå½“ã¦ã‚’å®Ÿæ–½ã™ã‚‹ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãã®ã¾ã¾å‰²ã‚Šå½“ã¦ã‚Œã°ã‚ˆã„ãŒã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ GUI ã§ç›´æ¥å‰²ã‚Šå½“ã¦ãŒã§ããªã„ã®ã§ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ‰€å±ã™ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œã£ã¦ã€ãã®ã‚°ãƒ«ãƒ¼ãƒ—ã«å¯¾ã—ã¦ãƒ­ãƒ¼ãƒ«ã®å‰²ã‚Šå½“ã¦ã‚’è¡Œã† (è¦ Azure AD Premium ãƒ©ã‚¤ã‚»ãƒ³ã‚¹) ã‹ã€ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãŒãªã„ã®ã§ã‚ã‚Œã° Graph API çµŒç”±ã§å‰²ã‚Šå½“ã¦ã‚’å®Ÿæ–½ã™ã‚‹ã€‚</p><pre class=" language-powershell"><code class="language-powershell">Connect<span class="token operator">-</span>MgGraph <span class="token operator">-</span>Scopes <span class="token string">"Application.ReadWrite.All, AppRoleAssignment.ReadWrite.All"</span><span class="token variable">$easyAuthApp</span> = Get<span class="token operator">-</span>MgServicePrincipal <span class="token operator">-</span><span class="token keyword">Filter</span> <span class="token string">"appId eq '6c5dd842-bcfe-4a2e-9834-b19bfba1e26b'"</span><span class="token punctuation">;</span> <span class="token variable">$clientApp</span> = Get<span class="token operator">-</span>MgServicePrincipal <span class="token operator">-</span><span class="token keyword">Filter</span> <span class="token string">"appId eq 'e27ad7e4-f5a6-400f-ad8c-99079aaff560'"</span><span class="token punctuation">;</span> <span class="token variable">$defaultRoleId</span> = <span class="token punctuation">(</span><span class="token namespace">[guid]</span>::Empty<span class="token punctuation">)</span><span class="token punctuation">.</span>GuidNew<span class="token operator">-</span>MgServicePrincipalAppRoleAssignedTo <span class="token operator">-</span>ServicePrincipalId <span class="token variable">$easyAuthApp</span><span class="token punctuation">.</span>Id <span class="token operator">-</span>AppRoleId <span class="token variable">$defaultRoleId</span> <span class="token operator">-</span>ResourceId <span class="token variable">$easyAuthApp</span><span class="token punctuation">.</span>Id <span class="token operator">-</span>PrincipalId <span class="token variable">$clientApp</span><span class="token punctuation">.</span>Id</code></pre><p>ä¸Šè¨˜ã®ã‚ˆã†ã«æ¨©é™ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã‚°ãƒ«ãƒ¼ãƒ—ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ã‚¢ãƒ—ãƒªã®ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ãŒè¿½åŠ ã•ã‚Œã€ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚</p><p><img src="/2023/08/01/tips-for-using-appservice-authentication-securely/users-and-groups.png" alt=""></p><p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚åŒæ§˜ã«åˆ¶å¾¡ãŒã§ãã‚‹ãŒã€<code>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‰²ã‚Šå½“ã¦ãŒæœ‰åŠ¹ã§ã™ã‹?</code> ã‚’ <code>ã¯ã„</code> ã«è¨­å®šã—ãŸæ™‚ç‚¹ã§ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ EasyAuth ã®èªå¯å‡¦ç†ã«åŒæ„ãŒå‡ºæ¥ãªããªã‚Šã€å®Ÿè³ªç®¡ç†è€…åŒæ„ãŒå¿…è¦ã«ãªã‚‹ã®ã§ã§æ³¨æ„ã€‚<br>è©³ã—ãã¯ <a href="https://jpazureid.github.io/blog/azure-active-directory/azure-ad-consent-framework/#%E2%91%A2%E5%AF%BE%E8%B1%A1%E3%81%AE%E3%82%A2%E3%83%97%E3%83%AA%E3%81%A7%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%AE%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%81%8C%E5%BF%85%E8%A6%81%E3%81%A8%E8%A8%AD%E5%AE%9A%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B">ã€Œç®¡ç†è€…ã®æ‰¿èªãŒå¿…è¦ã€ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚ŒãŸå ´åˆã®å¯¾å‡¦æ³• | Japan Azure Identity Support Blog</a> ã‚’å‚ç…§ã®ã“ã¨ã€‚</p><p>ä¸Šè¨˜æ‰‹é †ã¯æ‰‹é †è‡ªä½“ã¯ã¾ã‚ç°¡å˜ã ãŒã€Azure AD å´ã®ç®¡ç†æ¨©é™ãŒã‚‚ã‚ã‚‚ã‚å¿…è¦ã«ãªã‚‹ã®ã§ã‚¢ãƒ—ãƒªé–‹ç™ºè€…ã ã¨ç®¡ç†è€…ã«ä¾é ¼ã™ã‚‹ã“ã¨ã«ãªã‚‹ã ã‚ã†ã€‚</p><h3 id="App-Service-èªè¨¼ã®çµ„ã¿è¾¼ã¿èªå¯ãƒãƒªã‚·ãƒ¼ã‚’ä½¿ã£ã¦ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ¶é™ã™ã‚‹"><a href="#App-Service-èªè¨¼ã®çµ„ã¿è¾¼ã¿èªå¯ãƒãƒªã‚·ãƒ¼ã‚’ä½¿ã£ã¦ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ¶é™ã™ã‚‹" class="headerlink" title="App Service èªè¨¼ã®çµ„ã¿è¾¼ã¿èªå¯ãƒãƒªã‚·ãƒ¼ã‚’ä½¿ã£ã¦ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ¶é™ã™ã‚‹"></a>App Service èªè¨¼ã®çµ„ã¿è¾¼ã¿èªå¯ãƒãƒªã‚·ãƒ¼ã‚’ä½¿ã£ã¦ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ¶é™ã™ã‚‹</h3><p>æœ€è¿‘ã§ããŸ EasyAuth ã®æ–°æ©Ÿèƒ½ã ãŒã€æœ¬å½“ã«å¿…è¦æœ€ä½é™ã®ã“ã¨ã—ã‹ã§ããªã„ãŒã¨ã‚Šã‚ãˆãšå‹•ãã€‚<br>ç°¡å˜ã«è¨­å®šæ–¹æ³•ã‚’æ›¸ã„ã¦ãŠãã€‚è©³ç´°ã¯ <a href="https://learn.microsoft.com/ja-jp/azure/app-service/configure-authentication-provider-aad?tabs=workforce-tenant#use-a-built-in-authorization-policy">çµ„ã¿è¾¼ã¿èªå¯ãƒãƒªã‚·ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹</a> ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã€‚<br>ARM API ã‚’å©ãã®ã§ã‚ˆãã‚ã‹ã‚‰ã‚“äººã¯ <a href="https://resoures.azure.com">https://resoures.azure.com</a> ã§è¨­å®šã™ã‚Œã°è‰¯ã„ã€‚</p><p>App Service ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’æ¢ã—ã¦ã€config/authsettingsV2 ã‚’é–‹ãã€‚ä¸Šéƒ¨ã® Edit ã‚’æŠ¼ã—ã¦ã‹ã‚‰ <code>identityProviders</code> &gt; <code>azureActiveDirectory</code> &gt; <code>validation</code> ã‚’ç·¨é›†ã™ã‚‹ã€‚</p><p><img src="/2023/08/01/tips-for-using-appservice-authentication-securely/authsettingsV2.png" alt=""></p><p>æŒ‡å®šã™ã‚‹ ID ã¯ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ID ã§ã¯ãªãã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã® ObjectId ã§ã‚ã‚‹ã“ã¨ã«æ³¨æ„ã€‚ã¤ã¾ã‚Šã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚º ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ–ãƒ¬ãƒ¼ãƒ‰ã‹ã‚‰ç¢ºèªã§ãã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ IDã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã¯æ™®é€šã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ ID ã‚’æŒ‡å®šã™ã‚‹ã€‚</p><p>ã“ã®è¨­å®šã‚’å®Ÿæ–½ã™ã‚‹ã¨ <code>allowedPrincipals</code> &gt; <code>identities</code> ã§è¨­å®šã—ãŸãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®ã¿ãŒã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã¨ãªã‚‹ã€‚ã‚‚ã†å°‘ã—æ­£ç¢ºã«è¨€ã†ã¨ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã® oid ã‚¯ãƒ¬ãƒ¼ãƒ ãŒ <code>allowedPrincipals</code> &gt; <code>identities</code> ã§è¨­å®šã—ãŸãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®ã„ãšã‚Œã‹ã® ObjectId ã¨ä¸€è‡´ã™ã‚‹å ´åˆã«ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã‚‹ã€‚</p><p>ã¡ãªã¿ã« <code>jwtClaimChecks</code> ã¨ã‹ã„ã†ãã‚Œã£ã½ã„åå‰ç©ºé–“ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ãŒä»Šã®ã¨ã“ã‚ä½¿ã„æ–¹ã¯ä¸æ˜ã€‚<br>ã“ã®è¨­å®šã¯ã€ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ç®¡ç†æ¨©é™ãŒã‚ã‚Œã°ã„ã„ã®ã§ã‚¢ãƒ—ãƒªç®¡ç†è€…ãŒå¤§æŠµã§ãã‚‹ã¨æ€ã‚ã‚Œã‚‹ãŒã€ã¾ã‚æ©Ÿèƒ½ä¸è¶³æ„Ÿã¯å¦ã‚ãªã„ã€‚ã›ã‚ã¦ scp ã‚„ roles ã‚¯ãƒ¬ãƒ¼ãƒ ã®æ¤œè¨¼ãã‚‰ã„ã—ã¦ãã‚ŒãŸã‚‰ã„ã„ã®ã ãŒâ€¦ã€‚</p><h3 id="App-Service-ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¢ãƒ—ãƒªå´ã§ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ“ã‚¸ãƒã‚¹-ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹"><a href="#App-Service-ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¢ãƒ—ãƒªå´ã§ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ“ã‚¸ãƒã‚¹-ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹" class="headerlink" title="App Service ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¢ãƒ—ãƒªå´ã§ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ“ã‚¸ãƒã‚¹ ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹"></a>App Service ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¢ãƒ—ãƒªå´ã§ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ“ã‚¸ãƒã‚¹ ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹</h3><p>ã‚ˆã‚Šè¤‡é›‘ãªè¦ä»¶ã‚’æº€ãŸã™ãŸã‚ã«ã¯ã€Azure AD ã‚„ EasyAuth ã®æ©Ÿèƒ½ã ã‘ã§ã¯ä¸è¶³ãªã®ã§ã€ç‹¬è‡ªã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãå¿…è¦ãŒã‚ã‚‹ã€‚<br>ã‚„ã‚ŠãŸã„ã“ã¨ã«ã‚ˆã£ã¦å®Ÿè£…é›£æ˜“åº¦ã¯ç•°ãªã‚‹ãŒ EasyAuth çµ„ã¿è¾¼ã¿ã®æ©Ÿèƒ½ãƒ¬ãƒ™ãƒ«ã‚’å®Ÿç¾ã™ã‚‹ã ã‘ãªã‚‰ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆ ãƒ˜ãƒƒãƒ€ãƒ¼ã® <code>X-MS-CLIENT-PRINCIPAL-ID</code> ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚Œã°ã‚ˆã„ã€‚ã“ã“ã« ID ãƒˆãƒ¼ã‚¯ãƒ³/ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ ID ãŒå«ã¾ã‚Œã‚‹ã®ã§ã€ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã™ã‚‹ ID ã®ãƒªã‚¹ãƒˆã‚’ã‚¢ãƒ—ãƒªå´ã§æŒã£ã¦ãŠã„ã¦ã€åˆè‡´ã™ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚Œã° OK ã ã€‚</p><p>ãŸã ã€ä¸Šè¨˜ã ã‘ã§ã‚ã‚Œã°å‰è¿°ã® 2 ã¤ã®æ–¹æ³•ã‚’ä½¿ã£ãŸã»ã†ãŒè‰¯ã„ã®ã§ã€ãƒ“ã‚¸ãƒã‚¹ ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›¸ãå ´åˆã¯è¿½åŠ ã®ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’æ§‹æˆã—ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ã«ãªã‚‹ã ã‚ã†ã€‚</p><p>ä¾‹ãˆã°ã€<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/optional-claims#configure-groups-optional-claims">groups ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’è¿½åŠ </a> ã—ã¦æ¤œè¨¼ã™ã‚Œã°ã€ç‰¹å®šã®ã‚°ãƒ«ãƒ¼ãƒ—ã«æ‰€å±ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã®ã¿æ¨©é™ã‚’ä»˜ä¸ã—ãŸã‚Šã€<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/howto-add-app-roles-in-apps">ã‚¢ãƒ—ãƒª ãƒ­ãƒ¼ãƒ«</a> ã‚’å®šç¾©ã™ã‚Œã°ã€ã‚¢ãƒ—ãƒªç‹¬è‡ªã®æ¨©é™ã‚’ Azure AD ä¸Šã§ã€ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚„ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã«ä»˜ä¸ã—ã¦ App Service ä¸Šã®ã‚¢ãƒ—ãƒªã§å‰²ã‚Šå½“ã¦ãŸæ¨©é™ã«ã‚ˆã£ãŸå¿œç­”ã‚’è¿”ã™ã¨ã„ã£ãŸã“ã¨ãŒå¯èƒ½ã ã€‚</p><p>ãã®ä»–ã®ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã«ã¯ <a href="https://learn.microsoft.com/ja-jp/azure/app-service/configure-authentication-user-identities#decoding-the-client-principal-header">X-MS-CLIENT-PRINCIPAL</a> ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‹ã€ç´ ç›´ã«ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ or ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦å€¤ã‚’å–ã‚Šå‡ºã—ã¦æ¤œè¨¼ã™ã‚‹ã€‚ã‚ã¨ .NET ãªã‚‰ ClaimsPrincipal ã«ç‰¹å®šã®ã‚¯ãƒ¬ãƒ¼ãƒ ã¯å‹æ‰‹ã«å…¥ã‚‹ã®ã§ã€ãã‚Œã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã§ã‚‚è‰¯ã„ã€‚</p><p>ã“ã®è¾ºã®è©³ç´°ã¯å‰æã®çŸ¥è­˜ã¨ã‹å«ã‚è¨˜äº‹ã«ã™ã‚‹ã¨é¢å€’ãªã®ã§ã€ä»Šå›ã¯å‰²æ„›ã€‚</p><p>ã¨ã„ã†ã“ã¨ã§ã€EasyAuth ã¯ã‚ãã¾ã§ Easy ãª Auth ãªã®ã§ã€æ—¢å®šã§ã¯çµæ§‹ã ã‚Œã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ãªçŠ¶æ…‹ã§ã€ã¡ã‚‡ã£ã¨æ€ã£ã¦ãŸã®ã¨é•ã†ï¼ã£ã¦ãªã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§æ³¨æ„ã—ã¾ã—ã‚‡ã†ã¨ã„ã†è©±ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Azure ã® App Service ã‚„ Functions ãªã©ã® Web ã‚µãƒ¼ãƒ“ã‚¹ã«ã¯ã€Azure AD ã¨é€£æºã—ã¦èªè¨¼ã‚’è¡Œã†æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚App Service èªè¨¼ã¨å‘¼ã°ã‚Œã‚‹æ©Ÿèƒ½ã§ã€æ—§ç§°ï¼Ÿã® EasyAuth ã®æ–¹ãŒé¦´æŸ“ã¿ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚&lt;br&gt;æœ€çŸ­ã§ã¯ã»ã¼ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ã‚¢ãƒ—ãƒªã«èªè¨¼æ©Ÿèƒ½ã‚’è¿½åŠ ã§ãã‚‹ãŸã‚ã€ã¨ã¦ã‚‚ä¾¿åˆ©ã ã€‚ã—ã‹ã—ã€æ—¢å®šã®è¨­å®šã§ã¯ãƒ†ãƒŠãƒ³ãƒˆã®ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŠã‚ˆã³ã‚¢ãƒ—ãƒªãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€è¦ä»¶ã«ã‚ˆã£ã¦ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ‡¸å¿µãŒã‚ã‚‹ã€‚&lt;/p&gt;
&lt;p&gt;ã¨ã„ã†ã“ã¨ã§ EasyAuth ã®æ©Ÿèƒ½ãŒ Azure AD ã‹ã‚‰è¦‹ã¦ã©ã®ã‚ˆã†ãªæ©Ÿèƒ½ãªã®ã‹ã€ã©ã®ã‚ˆã†ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ‡¸å¿µãŒã‚ã‚‹ã®ã‹ã€ã©ã®ã‚ˆã†ã«å¯¾ç­–ã™ã‚‹ã®ã‹ã‚’ã¾ã¨ã‚ã¦ã¿ãŸã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Azure AD" scheme="http://blog.haniyama.com/tags/Azure-AD/"/>
    
      <category term="App Service" scheme="http://blog.haniyama.com/tags/App-Service/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Graph API ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã—ãªã„ã§ãã ã•ã„</title>
    <link href="http://blog.haniyama.com/2023/04/26/do-not-validate-ms-graph-token/"/>
    <id>http://blog.haniyama.com/2023/04/26/do-not-validate-ms-graph-token/</id>
    <published>2023-04-26T08:04:00.000Z</published>
    <updated>2023-05-26T15:13:09.673Z</updated>
    
    <content type="html"><![CDATA[<p>Microsoft Graph API ã«å¯¾ã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã¯ JWT ã®ã‚ˆã†ã«è¦‹ãˆã‚‹ãŒã€JWT ã§ã¯ãªã„ã®ã§ã€<strong>æ±ºã—ã¦ç½²åã‚’æ¤œè¨¼ã—ã‚ˆã†ã¨ã—ã¦ã¯ã„ã‘ãªã„ã€‚</strong></p><span id="more"></span><p>ã€Œã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã®ç½²åã‚’æ¤œè¨¼ã§ãã¾ã›ã‚“ã€ã¨ã„ã†è©±ã‚’èã„ã¦ã€è©³ã—ãè©±ã‚’èã„ã¦ã¿ã‚‹ã¨æ¤œè¨¼ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ãŒ Microsoft Graph API ã«å¯¾ã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã ã£ãŸã¨ã„ã†ã‚ªãƒãŒã‚ã‚‹ã€‚</p><p>Azure AD ã‹ã‚‰ç™ºè¡Œã•ã‚Œã‚‹ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã€ç™ºè¡Œã•ã‚ŒãŸå¯¾è±¡ (audience) ã§æ¶ˆè²»ã•ã‚Œã‚‹ã¹ãã§ã‚ã‚Šã€Microsoft Graph API ã«å¯¾ã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã¯ Microsoft Graph API ã ã‘ãŒæ¤œè¨¼ã—ã¦ã‚ˆã„ã€‚<br>ç‰¹ã« Microsoft ã® First Party ã«å¯¾ã—ã¦ç™ºè¡Œã•ã‚Œã‚‹ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã«ã¤ã„ã¦ã¯ã€å…¬é–‹æƒ…å ±ã§ã‚‚ jwt å½¢å¼ã¨ã¯é™ã‚‰ãªã„ã¨æ³¨æ„æ›¸ããŒã‚ã‚‹ã€‚</p><p>[<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/v2-oauth2-auth-code-flow]">https://learn.microsoft.com/ja-jp/azure/active-directory/develop/v2-oauth2-auth-code-flow]</a></p><blockquote><p>ã“ã®ä¾‹ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å«ã‚ã¦ã€è‡ªåˆ†ãŒæ‰€æœ‰ã—ã¦ã„ãªã„ã™ã¹ã¦ã® API ã«ã¤ã„ã¦ã€ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼ã‚„èª­ã¿å–ã‚Šã‚’è¡Œã‚ãªã„ã§ãã ã•ã„ã€‚ Microsoft ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒˆãƒ¼ã‚¯ãƒ³ã«ã¯ã€JWT ã¨ã—ã¦æ¤œè¨¼ã•ã‚Œãªã„ç‰¹æ®Šãªå½¢å¼ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚ã¾ãŸã€ã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒãƒ¼ (Microsoft ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ) ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦æš—å·åŒ–ã•ã‚Œã‚‹å ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚ ãƒˆãƒ¼ã‚¯ãƒ³ã®èª­ã¿å–ã‚Šã¯ä¾¿åˆ©ãªãƒ‡ãƒãƒƒã‚°ãŠã‚ˆã³å­¦ç¿’ãƒ„ãƒ¼ãƒ«ã§ã™ãŒã€ã‚³ãƒ¼ãƒ‰å†…ã§ã“ã‚Œã«å¯¾ã™ã‚‹ä¾å­˜é–¢ä¿‚ã‚’å–å¾—ã—ãŸã‚Šã€è‡ªåˆ†ã§åˆ¶å¾¡ã™ã‚‹ API ç”¨ã§ã¯ãªã„ãƒˆãƒ¼ã‚¯ãƒ³ã«ã¤ã„ã¦ã®è©³ç´°ã‚’æƒ³å®šã—ãŸã‚Šã—ãªã„ã§ãã ã•ã„ã€‚</p></blockquote><p>è©³ã—ã„è©±ã¯ä¼šç¤¾ã®ãƒãƒ¼ãƒ ãƒ–ãƒ­ã‚° <a href="https://jpazureid.github.io/blog/azure-active-directory/oauth2-application-resource-and-api-permissions/">Azure AD ã«ç™»éŒ²ã§ãã‚‹ ã€Œã‚¢ãƒ—ãƒªã€ã¨ã€Œãƒªã‚½ãƒ¼ã‚¹ã€ã€ã€ŒAPI æ¨©é™ã€ã‚’ç†è§£ã™ã‚‹ | Japan Azure Identity Support Blog</a> ã«è©³ã—ãæ›¸ã„ãŸã®ã§ãã¡ã‚‰ã‚’å‚ç…§ã®ã“ã¨ã€‚</p><p>è¦æœ›ãŒã‚ã‚Œã°ç¶šãã‚’æ›¸ãã‹ã‚‚ã€‚</p><h2 id="å®Ÿéš›ã«æ¤œè¨¼ã—ã¦ã¿ãŸ"><a href="#å®Ÿéš›ã«æ¤œè¨¼ã—ã¦ã¿ãŸ" class="headerlink" title="å®Ÿéš›ã«æ¤œè¨¼ã—ã¦ã¿ãŸ"></a>å®Ÿéš›ã«æ¤œè¨¼ã—ã¦ã¿ãŸ</h2><p>ã¨ã„ã†ã“ã¨ã§ã€å‰ç½®ãã¯ã“ã®è¾ºã«ã—ã¦å®Ÿéš›ã« Microsoft Graph API ã«ç™ºè¡Œã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã—ã¦ã¿ãŸã€‚(ã¯ï¼Ÿ) </p><p>è©³ç´°ã¯ä»¥ä¸‹ã® GitHub Issue ã«ã‚ã‚‹é€šã‚Šã€‚</p><p><a href="https://github.com/AzureAD/azure-activedirectory-identitymodel-extensions-for-dotnet/issues/609#issuecomment-437471108">Cannot validate signature. Â· Issue #609 Â· AzureAD/azure-activedirectory-identitymodel-extensions-for-dotnet</a></p><p>Microsoft Graph API ã«ç™ºè¡Œã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã®å½¢å¼ã¯ã€ã‚ã‚‹çªç„¶ä¸é€æ˜ãªãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—åˆ—ã«ãªã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚‹ã€‚ã¾ãŸã€JWT ã®ã¾ã¾ã ãŒã“ã®æ¤œè¨¼æ–¹æ³•ãŒçªç„¶ä½¿ãˆãªããªã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã—ã€ãŸã ã®èˆˆå‘³æœ¬ä½ã§å®Ÿè£…ã—ãŸã ã‘ãªã®ã§æ³¨æ„ã€‚</p><p><strong>ã‚‚ã—ã©ã“ã‹ã‹ã‚‰ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘ã¦ãã¦å‚è€ƒã«å®Ÿè£…ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ãªã‚‰ã€ã‚¢ã‚¿ãƒã‚’å†·ã‚„ã—ã¦ä¸Šè¨˜ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ç†è§£ã§ãã‚‹ã¾ã§èª­ã¿è¾¼ã‚€ã“ã¨ã‚’ãŠã‚¹ã‚¹ãƒ¡ã™ã‚‹ã€‚</strong></p><script src="https://gist.github.com/watahani/6ddd7f1cbd8197c30e4adad9d09a6c12.js"></script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Microsoft Graph API ã«å¯¾ã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã¯ JWT ã®ã‚ˆã†ã«è¦‹ãˆã‚‹ãŒã€JWT ã§ã¯ãªã„ã®ã§ã€&lt;strong&gt;æ±ºã—ã¦ç½²åã‚’æ¤œè¨¼ã—ã‚ˆã†ã¨ã—ã¦ã¯ã„ã‘ãªã„ã€‚&lt;/strong&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Azure" scheme="http://blog.haniyama.com/tags/Azure/"/>
    
      <category term="OAuth" scheme="http://blog.haniyama.com/tags/OAuth/"/>
    
  </entry>
  
  <entry>
    <title>Azure ãƒãƒ¼ã‚¿ãƒ«ã®è¨€èªã‚’ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§åˆ‡ã‚Šæ›¿ãˆã‚‹</title>
    <link href="http://blog.haniyama.com/2021/11/05/azure-portal-change-language/"/>
    <id>http://blog.haniyama.com/2021/11/05/azure-portal-change-language/</id>
    <published>2021-11-05T03:23:00.000Z</published>
    <updated>2023-05-26T15:12:05.739Z</updated>
    
    <content type="html"><![CDATA[<p>æ¤œè¨¼ã®æ™‚ã«è‹±èªã«ã—ãŸã‚Šã€æ—¥æœ¬èªã«ã—ãŸã‚Šé¢å€’ã ã£ãŸã®ã§ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ ãƒ¬ãƒ¼ãƒˆã«ã—ãŸã€‚å‚™å¿˜éŒ²ã®ãŸã‚ã«ãƒ¡ãƒ¢ã£ã¦ãŠãã€‚</p><p>ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ ãƒãƒ¼ã«ã§ã‚‚ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãŠã‘ã°ã‚ˆã„ã€‚</p><p><a href="javascript:l%3Dnew%20URL(location.href)%3Bif(l.host%3D%3D%3D'learn.microsoft.com')%7Bwindow.location.href%3Dl.origin%20%2B%20l.pathname.replace(%2F%5E%5C%2F.*%3F%5C%2F%2F%2C%22%2Fja-jp%2F%22)%3B%7Delse%7Bl.searchParams.set(%22l%22%2C%22ja.ja-jp%22)%3Bwindow.location.href%3Dl.toString()%3B%7Dvoid(0);">æ—¥æœ¬èª</a></p><p><a href="javascript:l%3Dnew%20URL(location.href)%3Bif(l.host%3D%3D%3D'learn.microsoft.com')%7Bwindow.location.href%3Dl.origin%20%2B%20l.pathname.replace(%2F%5E%5C%2F.*%3F%5C%2F%2F%2C%22%2Fen-us%2F%22)%3B%7Delse%7Bl.searchParams.set(%22l%22%2C%22en.en-us%22)%3Bwindow.location.href%3Dl.toString()%3B%7Dvoid(0);">è‹±èª</a></p><span id="more"></span><p>ä¸­èº«ã¯ã“ã‚Œã€‚URL ã« l=en.en-us ã®ã‚¯ã‚¨ãƒªã‚’è¿½åŠ ã™ã‚‹ã ã‘ã€‚</p><pre class=" language-javascript"><code class="language-javascript">l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">;</span>l<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">"l"</span><span class="token punctuation">,</span> <span class="token string">"en.en-us"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> l<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>ã‚ã‚“ã©ã„ã®ã§ URL ãƒã‚§ãƒƒã‚¯ãªã©ã¯ã‚„ã£ã¦ãªã„ã€‚ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ ãƒ¬ãƒ¼ãƒˆã®ä½œæˆã¯ã€ã‚°ã‚°ã£ã¦ä»¥ä¸‹ã®ã‚µã‚¤ãƒˆã‚’åˆ©ç”¨ã—ãŸã€‚</p><ul><li><a href="https://ytyng.github.io/bookmarklet-script-compress/">Bookmarklet ã‚¹ã‚¯ãƒªãƒ—ãƒˆå¤‰æ›</a></li></ul><p>Docs ã®å¤‰æ›ã‚‚é¢å€’ãªã®ã§è¿½è¨˜ã€‚en-us ã‚’é›‘ã«å¤‰æ›ã—ã¦ã‚‚ã„ã„ã‚“ã ã‘ã©ä¸€å¿œã¡ã‚ƒã‚“ã¨ãƒ‘ã‚¹ã®ç‹™ã£ãŸã¨ã“ã ã‘</p><pre class=" language-javascript"><code class="language-javascript">l <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>l<span class="token punctuation">.</span>host <span class="token operator">===</span> <span class="token string">'learn.microsoft.com'</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> l<span class="token punctuation">.</span>origin <span class="token operator">+</span> l<span class="token punctuation">.</span>pathname<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/^\/.*?\//</span><span class="token punctuation">,</span> <span class="token string">"/ja-jp/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    l<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">"l"</span><span class="token punctuation">,</span> <span class="token string">"ja.ja-jp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> l<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span></code></pre>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æ¤œè¨¼ã®æ™‚ã«è‹±èªã«ã—ãŸã‚Šã€æ—¥æœ¬èªã«ã—ãŸã‚Šé¢å€’ã ã£ãŸã®ã§ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ ãƒ¬ãƒ¼ãƒˆã«ã—ãŸã€‚å‚™å¿˜éŒ²ã®ãŸã‚ã«ãƒ¡ãƒ¢ã£ã¦ãŠãã€‚&lt;/p&gt;
&lt;p&gt;ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ ãƒãƒ¼ã«ã§ã‚‚ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãŠã‘ã°ã‚ˆã„ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;javascript:l%3Dnew%20URL(location.href)%3Bif(l.host%3D%3D%3D&#39;learn.microsoft.com&#39;)%7Bwindow.location.href%3Dl.origin%20%2B%20l.pathname.replace(%2F%5E%5C%2F.*%3F%5C%2F%2F%2C%22%2Fja-jp%2F%22)%3B%7Delse%7Bl.searchParams.set(%22l%22%2C%22ja.ja-jp%22)%3Bwindow.location.href%3Dl.toString()%3B%7Dvoid(0);&quot;&gt;æ—¥æœ¬èª&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;javascript:l%3Dnew%20URL(location.href)%3Bif(l.host%3D%3D%3D&#39;learn.microsoft.com&#39;)%7Bwindow.location.href%3Dl.origin%20%2B%20l.pathname.replace(%2F%5E%5C%2F.*%3F%5C%2F%2F%2C%22%2Fen-us%2F%22)%3B%7Delse%7Bl.searchParams.set(%22l%22%2C%22en.en-us%22)%3Bwindow.location.href%3Dl.toString()%3B%7Dvoid(0);&quot;&gt;è‹±èª&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Azure" scheme="http://blog.haniyama.com/tags/Azure/"/>
    
      <category term="é›‘è¨˜" scheme="http://blog.haniyama.com/tags/%E9%9B%91%E8%A8%98/"/>
    
  </entry>
  
  <entry>
    <title>GitHub Secure Deployments with OIDC ã‚’ Azure AD ã§è©¦ã™</title>
    <link href="http://blog.haniyama.com/2021/10/30/github-secure-deployments-with-oidc-for-azure/"/>
    <id>http://blog.haniyama.com/2021/10/30/github-secure-deployments-with-oidc-for-azure/</id>
    <published>2021-10-30T13:00:00.000Z</published>
    <updated>2023-05-26T15:12:52.238Z</updated>
    
    <content type="html"><![CDATA[<p>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ™‚ã« AWS ãŒå¯¾å¿œã—ãŸã¨è©±é¡Œã ã£ãŸ GitHub ID ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã‹å‘¼ã°ã‚Œã¦ãŸæ©Ÿèƒ½ãŒæ­£å¼ç™ºè¡¨ã•ã‚ŒãŸã€‚</p><ul><li><a href="https://github.blog/changelog/2021-10-27-github-actions-secure-cloud-deployments-with-openid-connect/">GitHub Actions: Secure cloud deployments with OpenID Connect | GitHub Changelog</a></li></ul><p>ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹ã¨ã€Azure AD ã¨ã®é€£æºæ‰‹é †ã‚‚ã—ã£ã‹ã‚Šå…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã®ã§æ—©é€Ÿè©¦ã—ã¦ã¿ãŸã€‚ã¤ã„ã§ã« az cli ã§ãƒ©ãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã®é€šä¿¡ã‚‚èª¿ã¹ã¦ã¿ãŸã€‚</p><span id="more"></span><h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>GitHub ã®ã‚ˆã†ãªã‚½ãƒ¼ã‚¹ç®¡ç†ãƒ„ãƒ¼ãƒ«ã¯ã€ä»Šã‚„ CI/CD ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¨ã—ã¦ã‚‚æ‹¡å¤§ã—ã¦ã„ã‚‹ã€‚ã„ã‚ã‚†ã‚‹ DevOpsã€‚GitHub ã«ã‚‚å¤šåˆ†ã«æ¼ã‚Œãš GitHub Actions ã¨ã„ã† CI/CD ã®ã‚·ã‚¹ãƒ†ãƒ ãŒã‚ã‚‹ã€‚</p><p>ã“ã®ã‚ˆã†ãª CI/CD ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã†ã®ã«é ­ã‚’æ‚©ã¾ã™ã®ãŒã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã®ç®¡ç†ã§ã‚ã‚‹ã€‚GitHub Actions ã®å ´åˆã€é€šå¸¸ã¯ Environment Variables ã¨ã—ã¦ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚„è¨¼æ˜æ›¸ãªã©ã‚’æ ¼ç´ã—ã¦ã€GitHub Action ã‹ã‚‰å‘¼ã³å‡ºã™ã“ã¨ã«ãªã‚‹ã®ã ãŒã€å®Ÿéš›ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’ã‚»ã‚­ãƒ¥ã‚¢ã«ä¿ã¨ã†ã¨ã™ã‚‹ã¨æœ‰åŠ¹æœŸé™ã‚’çŸ­ãä¿ã ã¨ã‹ã€ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ã ã¨ã‹ã¨ã„ã†ã“ã¨ã«é ­ã‚’æ‚©ã¾ã™ã“ã¨ã«ãªã‚‹ã€‚</p><p>ã—ã‹ã—ã€Secure cloud deployments with OpenID Connect (ã“ã‚Œã€æ­£å¼åç§°ãªã‚“ã§ã™ã‹ã­ã€‚è©±ã™ã¨ãä¼ãˆã¥ã‚‰ã„ã€‚) ã‚’åˆ©ç”¨ã™ã‚‹ã¨ã€GitHub ä¸Šã«ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’ãŠã‹ãªãã¦æ¸ˆã‚€ã€‚å…·ä½“çš„ã«ã¯ GitHub å´ãŒãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å†…ã ã‘ã§ç”Ÿæˆã§ãã‚‹ ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è³‡æ ¼æƒ…å ±ã¨ã—ã¦ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹å´ã«é€ä¿¡ã—ã€ç½²åã¨ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’æ¤œè¨¼ã™ã‚‹ã“ã¨ã§èªè¨¼ã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹ã€‚</p><h2 id="è¨­å®šæ‰‹é †"><a href="#è¨­å®šæ‰‹é †" class="headerlink" title="è¨­å®šæ‰‹é †"></a>è¨­å®šæ‰‹é †</h2><p>æ‰‹é †ã‚‚ã‚µãƒ³ãƒ—ãƒ«ã‚‚ <a href="https://github.com/marketplace/actions/azure-login">azure/login ã®ãƒªãƒã‚¸ãƒˆãƒª</a> ã«ã‚ã£ãŸã€‚</p><p>èª¬æ˜ã™ã‚‹ã‚ˆã‚Šã‚‚ã‚„ã£ã¦ã¿ãŸã»ã†ãŒæ—©ã„ã®ã§ã¾ãšã¯ Azure AD å´ã‹ã‚‰ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹ã€‚æ‰‹é †ã¯ä»¥ä¸‹ã®é€šã‚Šã€‚1, 2 ã¯ã„ã¤ã‚‚ã®æ‰‹é †ãªã®ã§çœç•¥ã€‚</p><ol><li>ã‚¢ãƒ—ãƒªã®ç™»éŒ²</li><li>RBAC ã®å‰²ã‚Šå½“ã¦</li><li>Federated Credentials ã« GitHub ã®æƒ…å ±ã‚’ã‚¢ãƒ—ãƒªã«ç™»éŒ²</li><li>GitHub Actions ã‹ã‚‰å‘¼ã³å‡ºã—</li></ol><h3 id="Federated-Credentials-ã«-GitHub-ã®æƒ…å ±ã‚’ã‚¢ãƒ—ãƒªã«ç™»éŒ²"><a href="#Federated-Credentials-ã«-GitHub-ã®æƒ…å ±ã‚’ã‚¢ãƒ—ãƒªã«ç™»éŒ²" class="headerlink" title="Federated Credentials ã« GitHub ã®æƒ…å ±ã‚’ã‚¢ãƒ—ãƒªã«ç™»éŒ²"></a>Federated Credentials ã« GitHub ã®æƒ…å ±ã‚’ã‚¢ãƒ—ãƒªã«ç™»éŒ²</h3><p>ã‚¢ãƒ—ãƒªã®ç™»éŒ²ã§ç™»éŒ²å¾Œã€é€šå¸¸ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç­‰ã‚’ç™ºè¡Œã™ã‚‹ãŸã‚ã® <code>è¨¼æ˜æ›¸ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ</code> ãƒ–ãƒ¬ãƒ¼ãƒ‰ã§ <code>Federated Credentials</code> ã‚’é¸æŠã—ã€è³‡æ ¼æƒ…å ±ã®è¿½åŠ ã‚’é¸æŠã™ã‚‹ã€‚</p><p><img src="/2021/10/30/github-secure-deployments-with-oidc-for-azure/appreg01.png" alt="appreg01.png"></p><p>è‰²ã€…å…¥åŠ›é …ç›®ãŒã‚ã‚‹ãŒã€organizations (å€‹äººãƒªãƒã‚¸ãƒˆãƒªãªã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼å) ã¨ ãƒªãƒã‚¸ãƒˆãƒªåã‚’å…¥åŠ›ã™ã‚‹ã€‚</p><p><img src="/2021/10/30/github-secure-deployments-with-oidc-for-azure/appreg02.png" alt="appreg02.png"></p><p>Entity Type (ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å‹) ã¨ã„ã†ã®ã¯å¾Œã§èª¬æ˜ã™ã‚‹ãŒã€GitHub å´ã®ç‰¹å®šãƒ–ãƒ©ãƒ³ãƒã‚„ã‚¿ã‚°ãŒã¤ã„ã¦ã‚‹æ™‚ã ã‘èªè¨¼ã§ãã‚‹ã€ã¿ãŸã„ãªè¨­å®šãŒã§ãã‚‹ã€‚ã“ã“ã§ã¯ <code>ãƒ–ãƒ©ãƒ³ãƒ</code> ã‚’é¸æŠã— <code>main</code> ãƒ–ãƒ©ãƒ³ãƒã‚’å¯¾è±¡ã®ãƒ–ãƒ©ãƒ³ãƒã«è¨­å®šã™ã‚‹ã€‚</p><p>ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦ã¯ã€ã“ã®æ™‚ç‚¹ã§ã‚µãƒ–ã‚¸ã‚§ã‚¯ãƒˆè­˜åˆ¥å­ (sub) ãŒ <code>repo:watahani/secure-deployments-for-azure-lab:ref:refs/heads/main</code> ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã€‚ã“ã‚ŒãŒå®Ÿéš›ã« GitHub ã® ID ãƒˆãƒ¼ã‚¯ãƒ³ã«å«ã‚ã‚‹ã¹ã <code>sub</code> ã‚¯ãƒ¬ãƒ¼ãƒ ã«ãªã‚‹ã€‚é€†ã«è¨€ã†ã¨ã€ã“ã“ã§è¨­å®šã—ãŸ <code>sub</code> ãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆã€èªè¨¼ã«å¤±æ•—ã™ã‚‹ã€‚ã¡ãªã¿ã« AAD å´ã§å—ã‘å…¥ã‚Œå¯èƒ½ãª audience ã¯ç·¨é›†ã§ãã‚‹ãŒ az cli ã‚’ä½¿ã£ã¦ã„ã‚‹é™ã‚Šä¸Šè¿°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’ã„ã˜ã‚‹ã“ã¨ã¯ãªã•ãã†ã€‚</p><h3 id="GitHub-Actions-å´ã®è¨­å®š"><a href="#GitHub-Actions-å´ã®è¨­å®š" class="headerlink" title="GitHub Actions å´ã®è¨­å®š"></a>GitHub Actions å´ã®è¨­å®š</h3><p>GitHub Actions å´ã®è¨­å®šã¯ <a href="https://github.com/marketplace/actions/azure-login">azure/login ã®ãƒªãƒã‚¸ãƒˆãƒª</a> ã«ã‚µãƒ³ãƒ—ãƒ«ãŒã‚ã‚‹ã®ã§ãã®é€šã‚Šã«è¨˜è¼‰ã™ã‚‹ã€‚ç¾çŠ¶ az cli ã®ãƒ™ãƒ¼ã‚¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¿…è¦ãªã®ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¿ã‚¹ã‚¯ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ãŒã€ã“ã‚ŒãŒãªããªã‚Œã° <code>azure/login</code> ã‚’å‘¼ã³å‡ºã™ã ã‘ã§ az login ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã¯ãšã€‚(Installing CLI-beta for OpenID Connect ã® job ãŒä¸è¦ã«ãªã‚‹ã¨ã„ã†æ„å‘³)</p><pre class=" language-yml"><code class="language-yml">name: Run Azure Login with OpenID Connect# main ãƒ–ãƒ©ãƒ³ãƒã§ã ã‘å‹•ãã‚ˆã†ã«ä¿®æ­£on:  push:    branches:      - mainpermissions:      id-token: writejobs:   build-and-deploy:    runs-on: ubuntu-latest    steps:    - name: Installing CLI-beta for OpenID Connect      run: |        cd ../..        CWD="$(pwd)"        python3 -m venv oidc-venv        . oidc-venv/bin/activate        echo "activated environment"        python3 -m pip install -q --upgrade pip        echo "started installing cli beta"        pip install -q --extra-index-url https://azcliprod.blob.core.windows.net/beta/simple/ azure-cli        echo "***************installed cli beta*******************"        echo "$CWD/oidc-venv/bin" >> $GITHUB_PATH    - name: 'Az CLI login'      uses: azure/login@v1.4.0      with:        client-id: $&#123;&#123; secrets.AZURE_CLIENTID &#125;&#125;        tenant-id: $&#123;&#123; secrets.AZURE_TENANTID &#125;&#125;        subscription-id: $&#123;&#123; secrets.AZURE_SUBSCRIPTIONID &#125;&#125;    - name: 'Run az commands'      run: |        az account show        az group list        pwd </code></pre><p>ã‚µãƒ³ãƒ—ãƒ«ã®ã¾ã¾ã ã¨ã€push ã—ãŸã‚‰ã‚¿ã‚¹ã‚¯ãŒå‹•ã„ã¦ã—ã¾ã†ã®ã§ã€ã¡ã‚ƒã‚“ã¨ main ãƒ–ãƒ©ãƒ³ãƒã ã‘ã§å‹•ãã‚ˆã†ã«ã—ãŸæ–¹ãŒè‰¯ã„ã ã‚ã†ã€‚ä»Šå›ã¯ãƒ–ãƒ©ãƒ³ãƒåã‚’æŒ‡å®šã—ã¦ federated credentials ã‚’ä½œæˆã—ãŸã®ã§ã€åˆ¥ãƒ–ãƒ©ãƒ³ãƒã§ Action ãŒå‹•ãã¨ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã«å¤±æ•—ã—ã¦ã¾ã†ã€‚</p><p>ç’°å¢ƒå¤‰æ•°ã¯ã€ã¨ã‚Šã‚ãˆãšãƒªãƒã‚¸ãƒˆãƒªå…¨ä½“ã® Secrets ã«ã§ã‚‚çªã£è¾¼ã‚“ã§ãŠãã€‚Environment ã‚’è¨­å®šã™ã‚‹ãªã‚‰ Environment Secrets ã«å…¥ã‚Œã‚Œã°ã„ã„ã ã‚ã†ã€‚</p><p><img src="/2021/10/30/github-secure-deployments-with-oidc-for-azure/github-secrets.png" alt="github-secrets.png"><br><img src="/2021/10/30/github-secure-deployments-with-oidc-for-azure/githb-add-secrets.png" alt="github-add-secrets.png"></p><p>ä¿å­˜ã—ã¦ push ã™ã‚‹ã¨ GitHub Actions ãŒå‹•ã„ã¦ã€å‰²ã‚Šå½“ã¦ãŸãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã®æƒ…å ±ãŒè¦‹ãˆãŸã€‚</p><pre class=" language-json"><code class="language-json">// az group list&amp;#<span class="token number">123</span><span class="token punctuation">;</span>  <span class="token property">"environmentName"</span><span class="token operator">:</span> <span class="token string">"AzureCloud"</span><span class="token punctuation">,</span>  <span class="token property">"homeTenantId"</span><span class="token operator">:</span> <span class="token string">"***"</span><span class="token punctuation">,</span>  <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"***"</span><span class="token punctuation">,</span>  <span class="token property">"isDefault"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token property">"managedByTenants"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"My Subscription Name"</span><span class="token punctuation">,</span>  <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"Enabled"</span><span class="token punctuation">,</span>  <span class="token property">"tenantId"</span><span class="token operator">:</span> <span class="token string">"***"</span><span class="token punctuation">,</span>  <span class="token property">"user"</span><span class="token operator">:</span> &amp;#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"***"</span><span class="token punctuation">,</span>    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"servicePrincipal"</span>  &amp;#<span class="token number">125</span><span class="token punctuation">;</span>&amp;#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">[</span>  &amp;#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"/subscriptions/***/resourceGroups/gh-actions-branch"</span><span class="token punctuation">,</span>    <span class="token property">"location"</span><span class="token operator">:</span> <span class="token string">"eastus"</span><span class="token punctuation">,</span>    <span class="token property">"managedBy"</span><span class="token operator">:</span> <span class="token null">null</span><span class="token punctuation">,</span>    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"gh-actions-branch"</span><span class="token punctuation">,</span>    <span class="token property">"properties"</span><span class="token operator">:</span> &amp;#<span class="token number">123</span><span class="token punctuation">;</span>      <span class="token property">"provisioningState"</span><span class="token operator">:</span> <span class="token string">"Succeeded"</span>    &amp;#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span>    <span class="token property">"tags"</span><span class="token operator">:</span> &amp;#<span class="token number">123</span><span class="token punctuation">;</span>&amp;#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span>    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"Microsoft.Resources/resourceGroups"</span>  &amp;#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">]</span></code></pre><h3 id="GitHub-ID-ãƒˆãƒ¼ã‚¯ãƒ³ã®ä¸­èº«"><a href="#GitHub-ID-ãƒˆãƒ¼ã‚¯ãƒ³ã®ä¸­èº«" class="headerlink" title="GitHub ID ãƒˆãƒ¼ã‚¯ãƒ³ã®ä¸­èº«"></a>GitHub ID ãƒˆãƒ¼ã‚¯ãƒ³ã®ä¸­èº«</h3><p>ã“ã®ã¾ã¾ã ã¨é¢ç™½ããªã„ã®ã§ã€az cli ã®ã‚½ãƒ¼ã‚¹ã‚’ã¿ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã®å–ã‚Šæ–¹ã‚’èª¿ã¹ã¦ã¿ã‚ˆã†ã¨æ€ã£ãŸã®ã ãŒã‚½ãƒ¼ã‚¹ãŒã©ã“ã«ã‚ã‚‹ã‹ã‚ˆãã‚ã‹ã‚‰ãªã‹ã£ãŸã®ã§æ‰‹æ¢ã‚Šã§ curl ã‚³ãƒãƒ³ãƒ‰ã‚’å©ãã“ã¨ã«ã—ãŸã€‚ã¨ã¯ã„ãˆ ID ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã¯ã™ã§ã«å…ˆäººãŸã¡ãŒè©¦ã—ã¦ãã‚Œã¦ã„ã‚‹ã®ã§ã€ãã®é€šã‚Šã«è¨˜è¼‰ã™ã‚‹ã€‚</p><p>ACTIONS_ID_TOKEN_REQUEST_URL ã¸ã¯ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦ aud ã‚’æ¸¡ã™ã“ã¨ã§ã€ä»»æ„ã® Audience ã‚’ ID ãƒˆãƒ¼ã‚¯ãƒ³ã«åŸ‹ã‚è¾¼ã‚ã‚‹ã‚ˆã†ã ã£ãŸã€‚</p><pre class=" language-sh"><code class="language-sh">federated_token=`curl -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=api://AzureADTokenExchange" | jq -r '.value'`</code></pre><p>å®Ÿéš›ã«å–å¾—ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ãŒã“ã‚“ãªæ„Ÿã˜ã€‚</p><script src="https://gist.github.com/watahani/cad18acba1bc2ad655ee275558b1d2e4.js"></script><p>ã¾ãšã¯ã€ç½²åã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã« openid-configuration ã‚’è¦‹ã«è¡Œãã€‚</p><p><a href="https://token.actions.githubusercontent.com/.well-known/openid-configuration">https://token.actions.githubusercontent.com/.well-known/openid-configuration</a></p><pre class=" language-json"><code class="language-json">&amp;#<span class="token number">123</span><span class="token punctuation">;</span>  <span class="token property">"issuer"</span><span class="token operator">:</span> <span class="token string">"https://token.actions.githubusercontent.com"</span><span class="token punctuation">,</span>  <span class="token property">"jwks_uri"</span><span class="token operator">:</span> <span class="token string">"https://token.actions.githubusercontent.com/.well-known/jwks"</span><span class="token punctuation">,</span>  <span class="token property">"subject_types_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token string">"public"</span><span class="token punctuation">,</span>    <span class="token string">"pairwise"</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token property">"response_types_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token string">"id_token"</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token property">"claims_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token string">"sub"</span><span class="token punctuation">,</span>    <span class="token string">"aud"</span><span class="token punctuation">,</span>    <span class="token string">"exp"</span><span class="token punctuation">,</span>    <span class="token string">"iat"</span><span class="token punctuation">,</span>    <span class="token string">"iss"</span><span class="token punctuation">,</span>    <span class="token string">"jti"</span><span class="token punctuation">,</span>    <span class="token string">"nbf"</span><span class="token punctuation">,</span>    <span class="token string">"ref"</span><span class="token punctuation">,</span>    <span class="token string">"repository"</span><span class="token punctuation">,</span>    <span class="token string">"repository_owner"</span><span class="token punctuation">,</span>    <span class="token string">"run_id"</span><span class="token punctuation">,</span>    <span class="token string">"run_number"</span><span class="token punctuation">,</span>    <span class="token string">"run_attempt"</span><span class="token punctuation">,</span>    <span class="token string">"actor"</span><span class="token punctuation">,</span>    <span class="token string">"workflow"</span><span class="token punctuation">,</span>    <span class="token string">"head_ref"</span><span class="token punctuation">,</span>    <span class="token string">"base_ref"</span><span class="token punctuation">,</span>    <span class="token string">"event_name"</span><span class="token punctuation">,</span>    <span class="token string">"ref_type"</span><span class="token punctuation">,</span>    <span class="token string">"environment"</span><span class="token punctuation">,</span>    <span class="token string">"job_workflow_ref"</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token property">"id_token_signing_alg_values_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token string">"RS256"</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token property">"scopes_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token string">"openid"</span>  <span class="token punctuation">]</span>&amp;#<span class="token number">125</span><span class="token punctuation">;</span></code></pre><p><code>jkws_uri</code> ã‹ã‚‰  <code>kid</code>: <code>DA6DD449E0E809599CECDFB3BDB6A2D7D0C2503A</code> ã®è¨¼æ˜æ›¸ã‚’å–ã£ã¦ãã¦ <a href="https://jwt.io">jwt.io</a> ã«å…¥ã‚Œã‚‹ã¨ã¡ã‚ƒã‚“ã¨æ¤œè¨¼ã§ããŸã€‚</p><p><img src="/2021/10/30/github-secure-deployments-with-oidc-for-azure/jwtio.png" alt="jwtio.png"></p><h4 id="ã‚¯ãƒ¬ãƒ¼ãƒ ã®ä¸­èº«"><a href="#ã‚¯ãƒ¬ãƒ¼ãƒ ã®ä¸­èº«" class="headerlink" title="ã‚¯ãƒ¬ãƒ¼ãƒ ã®ä¸­èº«"></a>ã‚¯ãƒ¬ãƒ¼ãƒ ã®ä¸­èº«</h4><p>Azure AD ã§ã¯å¤šåˆ† <code>sub</code> ã¨ <code>iss</code> ãã‚‰ã„ã—ã‹è¦‹ã¦ãªã„ãŒã€è‰²ã€…æƒ…å ±ãŒå…¥ã£ã¦ã„ã‚‹ã€‚å‰è¿°ã®é€šã‚Š aud ã¯ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã‚‹ã—ã€Azure AD å´ã§ã‚‚å¤‰æ›´ã§ãã‚‹ã®ã§ã€ãã‚Œãã‚ŒãŒä¸€è‡´ã—ã¦ã„ã‚Œã°èªè¨¼ã¯å‡ºæ¥ãã†ã€‚(ã‚ã‚“ã¾ã‚„ã‚‹æ„å‘³ãªã„ã‘ã©)<br>ã¡ãªã¿ã« <code>environment</code> ã ã‘ã¯ Environment ã‚’ä½œã£ã¦å‹•ã‹ã•ãªã„ã¨å…¥ã£ã¦ã“ãªã‹ã£ãŸã€‚æœ‰åŠ¹æœŸé™ã¯ 900 ç§’ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ä¸­ã§ä½•å›ç™ºè¡Œã§ãã‚‹ã‹ã€ãªã©ã¯è©¦ã—ã¦ãªã„ã€‚</p><h4 id="sub-ã®ä¸­èº«"><a href="#sub-ã®ä¸­èº«" class="headerlink" title="sub ã®ä¸­èº«"></a>sub ã®ä¸­èº«</h4><p><code>sub</code> ã¨ã—ã¦ã¯ä»¥ä¸‹ã® 4 ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚‹ã‚ˆã†ã§ã€ãã‚Œãã‚Œã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ä»¥ä¸‹ã®ã‚ˆã†ãªå½¢å¼ã ã£ãŸã€‚</p><table><thead><tr><th>ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å‹</th><th>trigger</th><th>sub</th></tr></thead><tbody><tr><td>ãƒ–ãƒ©ãƒ³ãƒ (Branch)</td><td>push</td><td>repo:{organization_name}/{repository_name}:{branch_name}</td></tr><tr><td>ã‚¿ã‚° (Tag)</td><td>push/tags</td><td>repo:{organization_name}/{repository_name}:ref:refs/tags/{tag_name}</td></tr><tr><td>ç’°å¢ƒ (Environment)</td><td>push/environment</td><td>repo:{organization_name}/{repository_name}:environment:{environment_name}</td><td></td></tr><tr><td>Pull Request</td><td>pull_request</td><td>repo:{organization_name}/{repository_name}:pull_request</td></tr></tbody></table><p>ã„ã¡ãŠã†ãã‚Œãã‚Œå‹•ã‹ã—ã¦ã¿ãŸã€<a href="https://github.com/watahani/secure-deployments-for-azure-lab/tree/main/.github/workflows">ã‚µãƒ³ãƒ—ãƒ«</a> ã‚‚ãŠã„ã¦ãŠãã€‚GitHub Actions ã®æ›¸ãæ–¹ã‚ã¾ã‚ŠçŸ¥ã‚‰ãªãã¦ã€ã‚ã¡ã‚ƒãã¡ã‚ƒè©¦è¡ŒéŒ¯èª¤ã—ãŸã®ã§ã‚³ãƒŸãƒƒãƒˆãƒ­ã‚°ãŒæ±šã„ã€‚</p><p>ã¡ãªã¿ã« Azure AD ã®ã‚¢ãƒ—ãƒªã®ç™»éŒ²ã‹ã‚‰ pull_request ã® sub ã‚’è¨­å®šã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ãƒãƒ¼ã‚¿ãƒ«ã®å•é¡Œã§ repo:{organization_name}/{repository_name}:pull<code>-</code>request ã®å½¢å¼ã«ãªã£ã¦ã—ã¾ã†ã€‚(<code>_</code> ãŒ <code>-</code> ã«ãªã£ã¦ã‚‹)</p><p>ã“ã®ã›ã„ã§ Pull Request ãƒ™ãƒ¼ã‚¹ã® Action ãŒå¤±æ•—ã—ã¾ãã£ãŸã®ã ãŒãƒˆãƒ¼ã‚¯ãƒ³ã®ä¸­èº«ã¿ã¦ã‚‚ã€ã—ã°ã‚‰ãä½•ã§å¤±æ•—ã—ã¦ã„ã‚‹ã‹åˆ†ã‹ã‚‰ãªã£ãŸã€‚ã“ã†ã„ã†é–“é•ã„ãƒ›ãƒ³ãƒˆã«æ°—ã¥ã‘ãªã„ã‹ã‚‰å›°ã‚‹ï½—</p><p>sub ã®å€¤ã‚’ç›´æ¥ç·¨é›†ã™ã‚Œã°æ­£ã—ãå‹•ãã®ã§ Pull Request ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®šã—ãŸã„ã¨ãã¯ã€ä»¥ä¸‹ã®é€šã‚Šè¨­å®šã—ã‚ˆã†ã€‚é€Ÿæ”»ãƒãƒ¼ã‚¿ãƒ«ã‹ã‚‰ Feedback ã—ã¦ãŠã„ãŸã€‚</p><p><img src="/2021/10/30/github-secure-deployments-with-oidc-for-azure/appreg03.png" alt="appreg03.png"></p><p>æ°—ã«ãªã£ã¦ <a href="https://docs.microsoft.com/en-us/graph/api/application-post-federatedidentitycredentials?view=graph-rest-beta&amp;tabs=http">Graph API ã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹</a> ã‚’æ¼ã£ãŸã¨ã“ã‚ sub ã‚’ç”Ÿã§æŒ‡å®šã™ã‚‹ã‚ˆã†ãªã®ã§ã€å¤šåˆ†ãƒãƒ¼ã‚¿ãƒ«å´ã®å•é¡Œã®ã‚ˆã†ã«è¦‹ãˆã‚‹ã€‚</p><h3 id="Azure-AD-ã¨ã®èªè¨¼ãƒ•ãƒ­ãƒ¼"><a href="#Azure-AD-ã¨ã®èªè¨¼ãƒ•ãƒ­ãƒ¼" class="headerlink" title="Azure AD ã¨ã®èªè¨¼ãƒ•ãƒ­ãƒ¼"></a>Azure AD ã¨ã®èªè¨¼ãƒ•ãƒ­ãƒ¼</h3><p>Azure AD ã¸ã®èªè¨¼ãƒ•ãƒ­ãƒ¼ã¯ã€Client Credentials ã® client_assertion ã«å…¥ã‚Œã‚Œã°è‰¯ã„ã‚“ã§ã—ã‚‡ï¼Ÿã¨æ€ã£ã¦å…¥ã‚ŒãŸã‚‰å®Ÿéš›å‹•ã„ãŸã€‚</p><p>ã‚ã¨ã§å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã£ã¦ (<a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/workload-identity-federation">Workload identity federation - Microsoft identity platform | Microsoft Docs</a>) è¦‹ãŸã‚‰ç­”ãˆãŒæ›¸ã„ã¦ã‚ã£ãŸã®ã§ã€æ‚©ã‚€å¿…è¦ã¯ãªã‹ã£ãŸãŒâ€¦ã€‚</p><p>ãªã®ã§ã€<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow">Client Credentials Grant</a> ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–ã‚‹ã ã‘ã€‚è©¦ã—ã« management.azure.com ã® API ã‚’ãŸãŸã„ã¦å‹•ãã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚</p><pre class=" language-sh"><code class="language-sh">azure_token=`curl -X POST https://login.microsoftonline.com/$&#123;AZURE_TENANTID&#125;/oauth2/v2.0/token \      -F client_id=$&#123;AZURE_CLIENTID&#125; \      -F grant_type=client_credentials \      -F scope=https://management.azure.com/.default \      -F client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer \      -F client_assertion=$&#123;federated_token&#125; | jq -r '.access_token'`curl -H "Authorization: Bearer $azure_token" https://management.azure.com/subscriptions/$AZURE_SUBSCRIPTIONID/resourcegroups?api-version=2021-04-01</code></pre><p>å…¨ä½“ã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚‹ã€‚</p><script src="https://gist.github.com/watahani/e831a19a4653a459847070b60909e02b.js"></script><p>ã‚¢ãƒ—ãƒªã«å¿…è¦ãªæ¨©é™ã•ãˆä¸ãˆã¦ãŠã‘ã° scope ã‚’å‘¼ã³å‡ºã™ API ã”ã¨ã«è¨­å®šã™ã‚‹ã“ã¨ã§ Microsoft Graph ã‚„ç‹¬è‡ªã® API ã«å¯¾ã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ä½•ã‹ã‚‚å–ã‚Œã‚‹ã¨æ€ã†ã€‚å€‹äººã®ãƒ†ã‚¹ãƒˆ ãƒ†ãƒŠãƒ³ãƒˆã ã£ãŸã‚‰ GitHub Actions ã§å®šæœŸã‚¸ãƒ§ãƒ–ã¨ã‹çµ„ã‚ãã†ã§éå¸¸ã«è‰¯ã„ã€‚ã¨ã¯ã„ãˆã€ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ãŒæ¼ã‚Œãªã„ã‹ã‚‰ã¨ã„ã£ã¦å®‰å…¨ã¨ã„ã†ã‚ã‘ã§ã¯ãªã„ã®ã§ã€ãã¡ã‚“ã¨ä½¿ã†ã«ã¯ GitHub Actions ã‚’å‹‰å¼·ã—ã¾ã—ã‚‡ã†ã€‚</p><h3 id="æ‰€æ„Ÿ"><a href="#æ‰€æ„Ÿ" class="headerlink" title="æ‰€æ„Ÿ"></a>æ‰€æ„Ÿ</h3><p>AWS ã® IAM ãŒ GitHub OIDC ã«å¯¾å¿œã—ãŸã¨ã Twitter ã§ã™ã”ãç››ã‚Šä¸ŠãŒã£ã¦ã„ãŸãŒã€ã‚ã¾ã‚Šä½•ã®ã“ã¨ã‹åˆ†ã‹ã£ã¦ãŠã‚‰ãšã€ä»Šå›è§¦ã£ã¦ã¯ã˜ã‚ã¦ç†è§£ã—ãŸã€‚ä½•ã§ä»Šã¾ã§ç„¡ã‹ã£ãŸã‚“ã ã¨ã„ã†ãƒ¬ãƒ™ãƒ«ã§è‰¯ã„ã€‚</p><p>GitHub Actions ã«ã¤ã„ã¦ã‚‚ã“ã®å‰ä½œã£ã¦ã¿ã¦ã€ãŠãŠã‚ˆãã®ä½œã‚Šæ–¹ã‚‚åˆ†ã‹ã£ã¦ã„ã‚‹ã®ã§ã€GitHub OIDC ä½¿ã„ã¤ã¤ã€æ¤œè¨¼ç”¨ãƒ†ãƒŠãƒ³ãƒˆã®è¨­å®šä¿å­˜ã—ãŸã‚Šã„ã˜ã£ãŸã‚Šã™ã‚‹ GitHub Actions ã§ã‚‚æ›¸ã„ã¦ã¿ã‚ˆã†ã‹ãªãƒ¼ã€‚</p><h3 id="è›‡è¶³ãªç–‘å•"><a href="#è›‡è¶³ãªç–‘å•" class="headerlink" title="è›‡è¶³ãªç–‘å•"></a>è›‡è¶³ãªç–‘å•</h3><p>Microsoft Graph API ã§ <a href="https://docs.microsoft.com/en-us/graph/api/application-post-federatedidentitycredentials?view=graph-rest-beta&amp;tabs=http">federated Credentials ä½œæˆ</a> ã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹è¦‹ã‚‹ã¨ Azure AD ã‹ã‚‰ç™ºè¡Œã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã€Client Credentials ã® assertion ã¨ã—ã¦ä½¿ã†ã‚ˆã†ãªã‚µãƒ³ãƒ—ãƒ«ãŒæ›¸ã„ã¦ã‚ã‚‹ã€‚</p><pre class=" language-http"><code class="language-http">POST https://graph.microsoft.com/beta/applications/bcd7c908-1c4d-4d48-93ee-ff38349a75c8/federatedIdentityCredentials/<span class="token header-name keyword">Content-Type:</span> application/json<span class="token application/json"><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"testing02"</span><span class="token punctuation">,</span>    <span class="token string">"issuer"</span><span class="token punctuation">:</span> <span class="token string">"https://login.microsoftonline.com/3d1e2be9-a10a-4a0c-8380-7ce190f98ed9/v2.0"</span><span class="token punctuation">,</span>    <span class="token string">"subject"</span><span class="token punctuation">:</span> <span class="token string">"a7d388c3-5e3f-4959-ac7d-786b3383006a"</span><span class="token punctuation">,</span>    <span class="token string">"audiences"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token string">"api://AzureADTokenExchange"</span>    <span class="token punctuation">]</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span></span></code></pre><p><code>openid-configuration</code> ãŒèª­ã‚ã¦ <code>sub</code> ã¨ <code>aud</code> ã•ãˆã‚ã£ã¦ã‚Œã°ã„ã„ã®ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® ID ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ã£ã¦ã‚¢ãƒ—ãƒªæ¨©é™ã®ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã‚‹ã€ã¨ã‹ã‚‚å‹•ãã¯ã—ãã†ã€‚ä½¿ã„ã©ã“ã‚ã¯åˆ†ã‹ã‚‰ãªã„ã‘ã©ã€‚</p><p>ãã®ä»–ã«ã€æ°—ã«ãªã‚‹ç‚¹ã¨ã—ã¦ã¯ã€Trigger ãŒè¤‡æ•°æ¡ä»¶ã‚ã£ãŸã¨ãã«ä½•ãŒå„ªå…ˆã•ã‚Œã‚‹ã‹ã¨ã„ã†ã®ãŒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚“ã§ã‚‚è‰¯ãã‚ã‹ã‚‰ãšã€‚ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒã‚ã£ãŸã¨ãã«ã€id_token ã® sub ã«ã¯ä½•ãŒå…¥ã‚‹ã®ã‹ã€‚</p><pre class=" language-yml"><code class="language-yml">on: [push, pull_request]  branches:    - dev  tags:    - v1.0.0-betajobs:   development-build:    runs-on: ubuntu-latest    environment: development    steps:        </code></pre><p>GitHub Actions ã¯ã‚ã¾ã‚Šè§¦ã£ã¦ãªã„ã®ã§ã©ã‚“ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’çµ„ã‚€ã®ãŒä¸€èˆ¬çš„ãªã®ã‹ã¯åˆ†ã‹ã‚‰ãªã„ãŒã€ç’°å¢ƒã«ã‚ˆã£ã¦ã¯ç™ºè¡Œã•ã‚Œã‚‹ id_token ã® <code>sub</code> ã‚’æ°—ã«ã—ãªã„ã¨ã„ã‘ãªã„ã‹ã‚‚ã—ã‚Œãªã„ã€‚GitHub Actions è©³ã—ã„äººæ•™ãˆã¦ãã ã•ã„ã€‚</p><h3 id="å‚è€ƒã‚µã‚¤ãƒˆ"><a href="#å‚è€ƒã‚µã‚¤ãƒˆ" class="headerlink" title="å‚è€ƒã‚µã‚¤ãƒˆ"></a>å‚è€ƒã‚µã‚¤ãƒˆ</h3><ul><li><a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/workload-identity-federation">Workload identity federation - Microsoft identity platform | Microsoft Docs</a></li><li><a href="https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect">About security hardening with OpenID Connect - GitHub Docs</a></li><li><a href="https://zenn.dev/mryhryki/articles/2021-09-19-access-aws-by-github-actions">GitHub Actions ã®IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã£ã¦AWSãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ™‚ã« AWS ãŒå¯¾å¿œã—ãŸã¨è©±é¡Œã ã£ãŸ GitHub ID ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã‹å‘¼ã°ã‚Œã¦ãŸæ©Ÿèƒ½ãŒæ­£å¼ç™ºè¡¨ã•ã‚ŒãŸã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.blog/changelog/2021-10-27-github-actions-secure-cloud-deployments-with-openid-connect/&quot;&gt;GitHub Actions: Secure cloud deployments with OpenID Connect | GitHub Changelog&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹ã¨ã€Azure AD ã¨ã®é€£æºæ‰‹é †ã‚‚ã—ã£ã‹ã‚Šå…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã®ã§æ—©é€Ÿè©¦ã—ã¦ã¿ãŸã€‚ã¤ã„ã§ã« az cli ã§ãƒ©ãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã®é€šä¿¡ã‚‚èª¿ã¹ã¦ã¿ãŸã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Azure" scheme="http://blog.haniyama.com/tags/Azure/"/>
    
      <category term="GitHub" scheme="http://blog.haniyama.com/tags/GitHub/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ PowerShell ã§å–å¾—ã™ã‚‹</title>
    <link href="http://blog.haniyama.com/2021/04/24/get-aad-token-using-powershell/"/>
    <id>http://blog.haniyama.com/2021/04/24/get-aad-token-using-powershell/</id>
    <published>2021-04-24T07:33:00.000Z</published>
    <updated>2022-05-18T13:45:29.061Z</updated>
    
    <content type="html"><![CDATA[<h2 id="First-Of-All"><a href="#First-Of-All" class="headerlink" title="First Of All"></a>First Of All</h2><p>æ¥­å‹™ç­‰ã§ä½¿ã†ãªã‚‰ç´ ç›´ã« <a href="https://github.com/AzureAD/MSAL.PS/">MSAL.PS</a> ã‚„ã€<a href="https://github.com/microsoftgraph/msgraph-sdk-powershell">Microsoft Graph PowerShell SDK</a> ã‚’åˆ©ç”¨ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã—ã¾ã—ã‚‡ã†ã€‚<br>è‡ªåˆ†ã§å®Ÿè£…ã—ã¦ã‚‚å‹‰å¼·ä»¥å¤–ã®å½¹ã«ã¯ãŸã¶ã‚“ç«‹ãŸãªã„ã§ã™ã€‚</p><p>Windows å…¥ã£ã¦ãŸã‚‰ã¨ã‚Šã‚ãˆãšå‹•ãã®ã§ã€å‹‰å¼·ä¼šç”¨ã«ãã‚Œãã‚Œã®ãƒ•ãƒ­ãƒ¼ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã¿ãŸã®ã ãŒã€å‹‰å¼·ä¼šã™ã‚‹æš‡ãªãã¦è…ã£ã¦ãŸã®ã§ä¾›é¤Šã€‚</p><span id="more"></span><h3 id="ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè³‡æ ¼æƒ…å ±ãƒ•ãƒ­ãƒ¼"><a href="#ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè³‡æ ¼æƒ…å ±ãƒ•ãƒ­ãƒ¼" class="headerlink" title="ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè³‡æ ¼æƒ…å ±ãƒ•ãƒ­ãƒ¼"></a>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè³‡æ ¼æƒ…å ±ãƒ•ãƒ­ãƒ¼</h3><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow">https://docs.microsoft.com/ja-jp/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow</a></p><p>ã‚ã¡ã‚ƒç°¡å˜ã€‚</p><script src="https://gist.github.com/watahani/546d21ce1f0368bb90c6ab517843134e.js"></script><p>è¨¼æ˜æ›¸ã§ã‚„ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯å…¨ç„¶ã‚ã‹ã‚‰ã‚“ã—ã€ã‚ã£ã¡ã‚ƒ .Net ã®ã‚¯ãƒ©ã‚¹å‘¼ã‚“ã§ã‚‹ã®ã§å¤šåˆ† C# ã§æ›¸ã„ãŸã»ã†ãŒå‹‰å¼·ã«ãªã‚‹ã€‚</p><script src="https://gist.github.com/watahani/d5b6def478b9f6a1fcb815123f537c53.js"></script><h3 id="èªå¯ã‚³ãƒ¼ãƒ‰ä»˜ä¸-Authorization-Code-Grant"><a href="#èªå¯ã‚³ãƒ¼ãƒ‰ä»˜ä¸-Authorization-Code-Grant" class="headerlink" title="èªå¯ã‚³ãƒ¼ãƒ‰ä»˜ä¸ (Authorization Code Grant)"></a>èªå¯ã‚³ãƒ¼ãƒ‰ä»˜ä¸ (Authorization Code Grant)</h3><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/v2-oauth2-auth-code-flow">https://docs.microsoft.com/ja-jp/azure/active-directory/develop/v2-oauth2-auth-code-flow</a></p><p>ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯èªè¨¼ã‚³ãƒ¼ãƒ‰ãªã®ã¯ç„¡è¦–ã ï¼ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼ã‚’ã—ãŸæ™‚æœŸãŒã‚ã£ã¦ã€ãã®è¾ºã®ã‚³ãƒ¼ãƒ‰ã‚‚æ®‹ã£ã¦ã‚‹ã€‚<br>PowerShell ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã¯ã‚ˆãæ­¢ã¾ã£ã¦ã—ã¾ã†ã‚“ã ã‘ã©ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ã‚„ã‚Šæ–¹ãŒã‚ã‹ã‚‰ãªã„ã€‚</p><p>ç„¡é§„ã« PKCE ã«ã‚‚å¯¾å¿œã—ã¦ã„ã‚‹ãã€‚</p><script src="https://gist.github.com/watahani/383f2aff2480e579e27127821897682a.js"></script><h3 id="ãƒ‡ãƒã‚¤ã‚¹è¨±å¯ä»˜ä¸-Device-Authorization-Grant"><a href="#ãƒ‡ãƒã‚¤ã‚¹è¨±å¯ä»˜ä¸-Device-Authorization-Grant" class="headerlink" title="ãƒ‡ãƒã‚¤ã‚¹è¨±å¯ä»˜ä¸ (Device Authorization Grant)"></a>ãƒ‡ãƒã‚¤ã‚¹è¨±å¯ä»˜ä¸ (Device Authorization Grant)</h3><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/v2-oauth2-device-code">https://docs.microsoft.com/ja-jp/azure/active-directory/develop/v2-oauth2-device-code</a></p><p>ã“ã‚Œã‚‚ç‰¹ã«å¤‰ãªã“ã¨ã¯ã—ã¦ãªã„ã€‚</p><script src="https://gist.github.com/watahani/f53468b819ab1e35bcc5f4d0d1cb3ee2.js"></script><h2 id="ãŠã‚ã‚Š"><a href="#ãŠã‚ã‚Š" class="headerlink" title="ãŠã‚ã‚Š"></a>ãŠã‚ã‚Š</h2><p>On-Behalf-Of ã¨ã‹æ¶ˆãˆã¤ã¤ã‚ã‚‹ SAML Bearer Assertion ãƒ•ãƒ­ãƒ¼ã¯æ°—ãŒå‘ã‘ã°æ›¸ãã‹ã‚‚ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;First-Of-All&quot;&gt;&lt;a href=&quot;#First-Of-All&quot; class=&quot;headerlink&quot; title=&quot;First Of All&quot;&gt;&lt;/a&gt;First Of All&lt;/h2&gt;&lt;p&gt;æ¥­å‹™ç­‰ã§ä½¿ã†ãªã‚‰ç´ ç›´ã« &lt;a href=&quot;https://github.com/AzureAD/MSAL.PS/&quot;&gt;MSAL.PS&lt;/a&gt; ã‚„ã€&lt;a href=&quot;https://github.com/microsoftgraph/msgraph-sdk-powershell&quot;&gt;Microsoft Graph PowerShell SDK&lt;/a&gt; ã‚’åˆ©ç”¨ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã—ã¾ã—ã‚‡ã†ã€‚&lt;br&gt;è‡ªåˆ†ã§å®Ÿè£…ã—ã¦ã‚‚å‹‰å¼·ä»¥å¤–ã®å½¹ã«ã¯ãŸã¶ã‚“ç«‹ãŸãªã„ã§ã™ã€‚&lt;/p&gt;
&lt;p&gt;Windows å…¥ã£ã¦ãŸã‚‰ã¨ã‚Šã‚ãˆãšå‹•ãã®ã§ã€å‹‰å¼·ä¼šç”¨ã«ãã‚Œãã‚Œã®ãƒ•ãƒ­ãƒ¼ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã¿ãŸã®ã ãŒã€å‹‰å¼·ä¼šã™ã‚‹æš‡ãªãã¦è…ã£ã¦ãŸã®ã§ä¾›é¤Šã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Azure" scheme="http://blog.haniyama.com/tags/Azure/"/>
    
      <category term="OAuth" scheme="http://blog.haniyama.com/tags/OAuth/"/>
    
  </entry>
  
  <entry>
    <title>è‡ªåˆ†çš„ CORS ãƒ¡ãƒ¢</title>
    <link href="http://blog.haniyama.com/2021/04/24/cors/"/>
    <id>http://blog.haniyama.com/2021/04/24/cors/</id>
    <published>2021-04-24T06:46:00.000Z</published>
    <updated>2022-05-18T13:45:29.038Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘ CORS ã‚’æ”¹ã‚ã¦å‹‰å¼·ã—ãŸã‘ã©ã€ã‚„ã£ã±ã‚ŠçŸ¥è­˜ãŒã‚ã„ã¾ã„ãªéƒ¨åˆ†ãŒã‚ã‚‹ã®ã§ã€ä¸€æ—¦ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã¨ã—ã¦ã¾ã¨ã‚ã¦ãŠãã€‚</p><span id="more"></span><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>ã¨ã‚Šã‚ãˆãš MDN ã‚’èª­ã‚“ã©ã‘ã°ãªã‚“ã¨ãªãç†è§£ã§ãã‚‹ã€‚</p><ul><li><a href="https://developer.mozilla.org/ja/docs/Web/HTTP/CORS">ã‚ªãƒªã‚¸ãƒ³é–“ãƒªã‚½ãƒ¼ã‚¹å…±æœ‰ (CORS) - HTTP | MDN</a></li></ul><p>ãªã‚“ã§ CORS ãŒã‚ã‚‹ã®ã£ã¦è©±ã€‚</p><ul><li><a href="https://note.crohaco.net/2019/http-cors-preflight/">CORS ã¨ã‹ Preflight ã¨ã‹ã‚ˆãã‚ã‹ã‚“ãªã„ã‚ˆãª - ãã‚ã®ã¦</a></li></ul><p>ãªã‚“ã§ã§ããŸã®ã‹ã¿ãŸã„ãªè©±ã‚’èª¿ã¹ã¦ã„ãã¨ JSONP ã¨ã‹ã„ã†é»’é­”è¡“ã®è©±ãŒã§ã¦æ¥½ã—ãã†ã ãŒã€ã‚­ãƒªãŒãªã•ãã†ã€‚</p><p>TL ã§ CORS å®Œå…¨æ‰‹å†Šã¨ã„ã†ä¸­å›½èªã®ãƒ–ãƒ­ã‚°ãŒç´¹ä»‹ã•ã‚Œã¦ãŠã‚Šã€Google ç¿»è¨³ã§èª­ã‚“ã ã¨ã“ã‚ã™ã”ãã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã€‚å…¨éƒ¨ã§ 6 ç« ã‚ã‚‹ãŒã€è‡ªåˆ†ãŒç†è§£ã§ããŸã®ã¯å¤§ä½“ 3 ç« ã¾ã§ã€‚</p><ul><li><a href="https://blog.huli.tw/2021/02/19/cors-guide-1/">CORS å®Œå…¨æ‰‹å†Šï¼ˆä¸€ï¼‰ï¼šç‚ºä»€éº¼æœƒç™¼ç”Ÿ CORS éŒ¯èª¤ï¼Ÿ - Huli</a></li></ul><p>å¤§ä½“ç†è§£ã—ãŸå¾Œã€æ—¥æœ¬èªã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ¢ã—ãŸã‘ã©ã€ã‚ã‚“ã¾è‰¯ã•ã’ãªã®ã¯ãªã‹ã£ãŸã€‚<br>å®Ÿç”¨ä¸Šã¯ Qiita ã®ã“ã®è¨˜äº‹èª­ã‚“ã©ã‘ã°å¤§ä¸ˆå¤«ãã†ã€‚</p><p><a href="https://qiita.com/tomoyukilabs/items/81698edd5812ff6acb34">CORSã¾ã¨ã‚ - Qiita</a></p><ul><li><a href="https://fetch.spec.whatwg.org/">Fetch Standard</a></li></ul><p>ä»•æ§˜ã¯æ°—ã«ãªã‚‹ã¨ã“ã‚ (<a href="https://fetch.spec.whatwg.org/#cors-preflight-fetch">preflight</a> ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚ãŸã‚Š) ã ã‘ã¤ã¾ã¿èª­ã¿ã—ãŸæ„Ÿã˜ã€‚å¤šãã®äººã¯ã“ã“ã ã‘èª­ã‚“ã§ãŠã‘ã°ååˆ†ã ã‚ã†ã¨æ€ã†ã€‚</p><h2 id="CORS-Step-0"><a href="#CORS-Step-0" class="headerlink" title="CORS Step 0"></a>CORS Step 0</h2><p>CORS ã®åˆ¶ç´„ã¯ Origin ãŒç•°ãªã‚‹ã¨ãã«ç™ºç”Ÿã™ã‚‹ã€‚<a href="https://html.spec.whatwg.org/multipage/origin.html#same-site">same site</a> ã¨ã¯ç•°ãªã‚Šã€same origin ã¯ã‚¹ã‚­ãƒ¼ãƒã¨ãƒãƒ¼ãƒˆã€ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒã™ã¹ã¦ä¸€è‡´ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚<br><a href="http://google.com/">http://google.com</a> ã¨ <a href="https://www.google.com/">https://www.google.com</a> ã¯ same site ã ãŒ same origin ã§ã¯ãªã„ã€‚ã©ã†ã‚‚ã‚¹ã‚­ãƒ¼ãƒãŒé•ã†å ´åˆã«ã¯ schemelessly same site ã¨ã„ã†ã‚‰ã—ã„ãŒâ€¦ã€‚</p><p>ã¨ã«ã‹ã same origin ã§ã¯ãªã„ã‚µã‚¤ãƒˆã¸ã® XMLHttpRequest, fecth API ã‚’åˆ©ç”¨ã—ãŸé€šä¿¡ãŒ CROS ã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ã€‚<br>F12 ã‚’æŠ¼ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã® DevTools ã‚’ç«‹ã¡ä¸Šã’ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã« <code>fetch(&quot;https://google.com&quot;)</code> ã¨æ‰“ã£ã¦ã¿ã‚‹ã€‚</p><pre class="language-js" style="" tabindex="0"><code id="f17ee73d" class="language-js" data-prism-hydrate="{&quot;element&quot;:&quot;f17ee73d&quot;,&quot;language&quot;:&quot;js&quot;,&quot;code&quot;:&quot;\nfetch(\&quot;https://google.com\&quot;)\nPromise&nbsp;{\u003cpending\u003e}\n// cors.html:1 Access to fetch at \u0027https://google.com/' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.\n&quot;,&quot;highlightedCode&quot;:&quot;\n<span class=\&quot;token function\&quot;>fetch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;https://google.com\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span>\nPromise <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token operator\&quot;>\u0026lt;</span>pending<span class=\&quot;token operator\&quot;>></span><span class=\&quot;token punctuation\&quot;>}</span>\n<span class=\&quot;token comment\&quot;>// cors.html:1 Access to fetch at 'https://google.com/' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.</span>\n&quot;}"><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"https://google.com"</span><span class="token punctuation">)</span>Promise <span class="token punctuation">{</span><span class="token operator">&lt;</span>pending<span class="token operator">&gt;</span><span class="token punctuation">}</span><span class="token comment">// cors.html:1 Access to fetch at 'https://google.com/' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.</span></code></pre><p>CORS ãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚Šãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸã¨å‡ºã‚‹ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆ ãƒ¢ãƒ¼ãƒ‰ã‚’ no-cros ã«ã™ã‚Œã° opaque response ã‚’å¾—ã‚‰ã‚Œã‚‹ã¨ã‚ã‚‹ãŒã€ã“ã‚Œã¯é€šä¿¡ã¯ã™ã‚‹ãŒ JavaScript ã«å€¤ã‚’è¿”ã•ãšã«ã€ã‚¨ãƒ©ãƒ¼ã‚‚æŠ‘åˆ¶ã•ã‚Œã‚‹ãƒ¢ãƒ¼ãƒ‰ã§ã€ãŸã„ã¦ã„ã®å ´åˆã¯å½¹ã«ç«‹ãŸãªã„ã€‚<a href="https://blog.fullstacktraining.com/what-is-an-opaque-response/">opaque response ã§ã‚°ã‚°ã‚‹ã¨å‡ºã¦ãã‚‹ã‚µã‚¤ãƒˆã«ã‚ˆã‚‹ã¨</a> ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã«å½¹ç«‹ã¤ã‚‰ã—ã„ãŒä»Šå›ã¯èˆˆå‘³ãŒãªã„ã®ã§ãƒ‘ã‚¹ã€‚</p><p>ã•ã¦ã€CORS ã¯ã‚µãƒ¼ãƒãƒ¼ã®å¿œç­”ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚ˆã‚Šãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ãŒã€é€šä¿¡ã‚’åˆ¶å¾¡ã™ã‚‹ä»•æ§˜ãªã®ã§ Google ã«é€šä¿¡ã‚’é€ã£ãŸã£ã¦ä½•ã‚‚å­¦ã¹ãªã„ã®ã§ã€é©å½“ãªã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¦ã‚‹ã€‚</p><pre class="language-python" style="" tabindex="0"><code id="9fcf6e3f" class="language-python" data-prism-hydrate="{&quot;element&quot;:&quot;9fcf6e3f&quot;,&quot;language&quot;:&quot;python&quot;,&quot;code&quot;:&quot;\nfrom http.server import BaseHTTPRequestHandler, ThreadingHTTPServer\nimport logging\n\&quot;\&quot;\&quot;\nVery simple HTTP server in python for logging requests (for python 3.7 or later)\nUsage::\n    ./server.py [\u003cport\u003e]\n\&quot;\&quot;\&quot;\n\nclass S(BaseHTTPRequestHandler):\n    def _set_response(self, custom_headers = {}):\n        self.send_response(200)\n        self.end_headers()\n\n    def do_GET(self):\n        logging.info(\&quot;GET request,\\nPath: %s\\nHeaders:\\n%s\\n\&quot;,\n                     str(self.path), str(self.headers))\n        self._set_response()\n        self.wfile.write(\&quot;GET request for {},\\n\\nwith request headers: \\n{}\&quot;.format(\n            self.path, self.headers).encode(\u0027utf-8'))\n\ndef run(server_class=ThreadingHTTPServer, handler_class=S, port=8080):\n    logging.basicConfig(level=logging.INFO)\n    server_address = ('', port)\n    httpd = server_class(server_address, handler_class)\n    logging.info(\&quot;Starting httpd... port {}\\n\&quot;.format(str(port)))\n    try:\n        httpd.serve_forever()\n    except KeyboardInterrupt:\n        pass\n    httpd.server_close()\n    logging.info('Stopping httpd...\\n')\n\n\nif __name__ == '__main__':\n    from sys import argv\n\n    if len(argv) == 2:\n        run(port=int(argv[1]))\n    else:\n        run()\n&quot;,&quot;highlightedCode&quot;:&quot;\n<span class=\&quot;token keyword\&quot;>from</span> http<span class=\&quot;token punctuation\&quot;>.</span>server <span class=\&quot;token keyword\&quot;>import</span> BaseHTTPRequestHandler<span class=\&quot;token punctuation\&quot;>,</span> ThreadingHTTPServer\n<span class=\&quot;token keyword\&quot;>import</span> logging\n<span class=\&quot;token triple-quoted-string string\&quot;>\&quot;\&quot;\&quot;\nVery simple HTTP server in python for logging requests (for python 3.7 or later)\nUsage::\n    ./server.py [\u0026lt;port>]\n\&quot;\&quot;\&quot;</span>\n\n<span class=\&quot;token keyword\&quot;>class</span> <span class=\&quot;token class-name\&quot;>S</span><span class=\&quot;token punctuation\&quot;>(</span>BaseHTTPRequestHandler<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>:</span>\n    <span class=\&quot;token keyword\&quot;>def</span> <span class=\&quot;token function\&quot;>_set_response</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>,</span> custom_headers <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>:</span>\n        self<span class=\&quot;token punctuation\&quot;>.</span>send_response<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token number\&quot;>200</span><span class=\&quot;token punctuation\&quot;>)</span>\n        self<span class=\&quot;token punctuation\&quot;>.</span>end_headers<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n    <span class=\&quot;token keyword\&quot;>def</span> <span class=\&quot;token function\&quot;>do_GET</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>:</span>\n        logging<span class=\&quot;token punctuation\&quot;>.</span>info<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;GET request,\\nPath: %s\\nHeaders:\\n%s\\n\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n                     <span class=\&quot;token builtin\&quot;>str</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>.</span>path<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token builtin\&quot;>str</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>.</span>headers<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n        self<span class=\&quot;token punctuation\&quot;>.</span>_set_response<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n        self<span class=\&quot;token punctuation\&quot;>.</span>wfile<span class=\&quot;token punctuation\&quot;>.</span>write<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;GET request for {},\\n\\nwith request headers: \\n{}\&quot;</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token builtin\&quot;>format</span><span class=\&quot;token punctuation\&quot;>(</span>\n            self<span class=\&quot;token punctuation\&quot;>.</span>path<span class=\&quot;token punctuation\&quot;>,</span> self<span class=\&quot;token punctuation\&quot;>.</span>headers<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span>encode<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>'utf-8'</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n<span class=\&quot;token keyword\&quot;>def</span> <span class=\&quot;token function\&quot;>run</span><span class=\&quot;token punctuation\&quot;>(</span>server_class<span class=\&quot;token operator\&quot;>=</span>ThreadingHTTPServer<span class=\&quot;token punctuation\&quot;>,</span> handler_class<span class=\&quot;token operator\&quot;>=</span>S<span class=\&quot;token punctuation\&quot;>,</span> port<span class=\&quot;token operator\&quot;>=</span><span class=\&quot;token number\&quot;>8080</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>:</span>\n    logging<span class=\&quot;token punctuation\&quot;>.</span>basicConfig<span class=\&quot;token punctuation\&quot;>(</span>level<span class=\&quot;token operator\&quot;>=</span>logging<span class=\&quot;token punctuation\&quot;>.</span>INFO<span class=\&quot;token punctuation\&quot;>)</span>\n    server_address <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>''</span><span class=\&quot;token punctuation\&quot;>,</span> port<span class=\&quot;token punctuation\&quot;>)</span>\n    httpd <span class=\&quot;token operator\&quot;>=</span> server_class<span class=\&quot;token punctuation\&quot;>(</span>server_address<span class=\&quot;token punctuation\&quot;>,</span> handler_class<span class=\&quot;token punctuation\&quot;>)</span>\n    logging<span class=\&quot;token punctuation\&quot;>.</span>info<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;Starting httpd... port {}\\n\&quot;</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token builtin\&quot;>format</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token builtin\&quot;>str</span><span class=\&quot;token punctuation\&quot;>(</span>port<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n    <span class=\&quot;token keyword\&quot;>try</span><span class=\&quot;token punctuation\&quot;>:</span>\n        httpd<span class=\&quot;token punctuation\&quot;>.</span>serve_forever<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n    <span class=\&quot;token keyword\&quot;>except</span> KeyboardInterrupt<span class=\&quot;token punctuation\&quot;>:</span>\n        <span class=\&quot;token keyword\&quot;>pass</span>\n    httpd<span class=\&quot;token punctuation\&quot;>.</span>server_close<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n    logging<span class=\&quot;token punctuation\&quot;>.</span>info<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>'Stopping httpd...\\n'</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n\n<span class=\&quot;token keyword\&quot;>if</span> __name__ <span class=\&quot;token operator\&quot;>==</span> <span class=\&quot;token string\&quot;>'__main__'</span><span class=\&quot;token punctuation\&quot;>:</span>\n    <span class=\&quot;token keyword\&quot;>from</span> sys <span class=\&quot;token keyword\&quot;>import</span> argv\n\n    <span class=\&quot;token keyword\&quot;>if</span> <span class=\&quot;token builtin\&quot;>len</span><span class=\&quot;token punctuation\&quot;>(</span>argv<span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token operator\&quot;>==</span> <span class=\&quot;token number\&quot;>2</span><span class=\&quot;token punctuation\&quot;>:</span>\n        run<span class=\&quot;token punctuation\&quot;>(</span>port<span class=\&quot;token operator\&quot;>=</span><span class=\&quot;token builtin\&quot;>int</span><span class=\&quot;token punctuation\&quot;>(</span>argv<span class=\&quot;token punctuation\&quot;>[</span><span class=\&quot;token number\&quot;>1</span><span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n    <span class=\&quot;token keyword\&quot;>else</span><span class=\&quot;token punctuation\&quot;>:</span>\n        run<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n&quot;}"><span class="token keyword">from</span> http<span class="token punctuation">.</span>server <span class="token keyword">import</span> BaseHTTPRequestHandler<span class="token punctuation">,</span> ThreadingHTTPServer<span class="token keyword">import</span> logging<span class="token triple-quoted-string string">"""Very simple HTTP server in python for logging requests (for python 3.7 or later)Usage::    ./server.py [&lt;port&gt;]"""</span><span class="token keyword">class</span> <span class="token class-name">S</span><span class="token punctuation">(</span>BaseHTTPRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">_set_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> custom_headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">do_GET</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"GET request,\nPath: %s\nHeaders:\n%s\n"</span><span class="token punctuation">,</span>                     <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>_set_response<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"GET request for {},\n\nwith request headers: \n{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>            self<span class="token punctuation">.</span>path<span class="token punctuation">,</span> self<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>server_class<span class="token operator">=</span>ThreadingHTTPServer<span class="token punctuation">,</span> handler_class<span class="token operator">=</span>S<span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>    server_address <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span>    httpd <span class="token operator">=</span> server_class<span class="token punctuation">(</span>server_address<span class="token punctuation">,</span> handler_class<span class="token punctuation">)</span>    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Starting httpd... port {}\n"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        httpd<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>        <span class="token keyword">pass</span>    httpd<span class="token punctuation">.</span>server_close<span class="token punctuation">(</span><span class="token punctuation">)</span>    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Stopping httpd...\n'</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    <span class="token keyword">from</span> sys <span class="token keyword">import</span> argv    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>        run<span class="token punctuation">(</span>port<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        run<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>python server.py ã¿ãŸã„ã«ã—ãŸã‚‰å‹•ãã€‚ThreadingHTTPServer ã¯ python 3.7 ã˜ã‚ƒãªã„ã¨å‹•ã‹ãªã„ã®ã§ã€ãã‚Œä»¥ä¸Šã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã€‚ã‚ã‚‰ãŸã‚ã¦ã€fetch ã‚’è©¦ã—ã¦ Python ã‚µãƒ¼ãƒãƒ¼ã®ãƒ­ã‚°ã‚’è¦‹ã‚‹ã€‚</p><pre class="language-javascript" style="" tabindex="0"><code id="0916043f" class="language-javascript" data-prism-hydrate="{&quot;element&quot;:&quot;0916043f&quot;,&quot;language&quot;:&quot;javascript&quot;,&quot;code&quot;:&quot;\nfetch(\&quot;http://localhost:8080/api\&quot;)\nPromise&nbsp;{\u003cpending\u003e}\n//Access to fetch at \u0027http://localhost:8080/api' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.\n&quot;,&quot;highlightedCode&quot;:&quot;\n<span class=\&quot;token function\&quot;>fetch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;http://localhost:8080/api\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span>\nPromise <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token operator\&quot;>\u0026lt;</span>pending<span class=\&quot;token operator\&quot;>></span><span class=\&quot;token punctuation\&quot;>}</span>\n<span class=\&quot;token comment\&quot;>//Access to fetch at 'http://localhost:8080/api' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.</span>\n&quot;}"><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/api"</span><span class="token punctuation">)</span>Promise <span class="token punctuation">{</span><span class="token operator">&lt;</span>pending<span class="token operator">&gt;</span><span class="token punctuation">}</span><span class="token comment">//Access to fetch at 'http://localhost:8080/api' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.</span></code></pre><p>Google ã«é€ã£ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨åŒã˜ã CORS ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ã‚‹ã€‚ä¸€æ–¹ã€Python ã‚µãƒ¼ãƒãƒ¼å´ã®ãƒ­ã‚°ã¯ã“ã‚“ãªã‹ã‚“ã˜ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒåˆ°é”ã—ã¦ã„ã‚‹ã€‚ã¤ã¾ã‚Šãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚‚è¿”ã—ã¦ã„ã‚‹ã€‚</p><pre class="language-log" style="" tabindex="0"><code id="0a574e3f" class="language-log" data-prism-hydrate="{&quot;element&quot;:&quot;0a574e3f&quot;,&quot;language&quot;:&quot;log&quot;,&quot;code&quot;:&quot;\nINFO:root:GET request,\nPath: /api\nHeaders:\nHost: localhost:8080\nConnection: keep-alive\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36 Edg/89.0.774.57\nAccept: */*\nOrigin: https://blog.haniyama.com\nSec-Fetch-Site: cross-site\nSec-Fetch-Mode: cors\nSec-Fetch-Dest: empty\nAccept-Encoding: gzip, deflate, br\nAccept-Language: ja,en-US;q=0.9,en;q=0.8\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token level info keyword\&quot;\u003eINFO</span><span class=\&quot;token operator\&quot;>:</span>root<span class=\&quot;token operator\&quot;>:</span>GET request<span class=\&quot;token punctuation\&quot;>,</span>\n<span class=\&quot;token property\&quot;>Path:</span> <span class=\&quot;token file-path string\&quot;>/api</span>\n<span class=\&quot;token property\&quot;>Headers:</span>\n<span class=\&quot;token property\&quot;>Host:</span> localhost<span class=\&quot;token operator\&quot;>:</span><span class=\&quot;token number\&quot;>8080</span>\n<span class=\&quot;token property\&quot;>Connection:</span> keep<span class=\&quot;token operator\&quot;>-</span>alive\n<span class=\&quot;token property\&quot;>User-Agent:</span> Mozilla<span class=\&quot;token operator\&quot;>/</span><span class=\&quot;token number\&quot;>5.0</span> <span class=\&quot;token operator\&quot;>(</span>Windows NT <span class=\&quot;token number\&quot;>10.0</span><span class=\&quot;token operator\&quot;>;</span> Win64<span class=\&quot;token operator\&quot;>;</span> x64<span class=\&quot;token operator\&quot;>)</span> AppleWebKit<span class=\&quot;token operator\&quot;>/</span><span class=\&quot;token number\&quot;>537.36</span> <span class=\&quot;token operator\&quot;>(</span>KHTML<span class=\&quot;token punctuation\&quot;>,</span> like Gecko<span class=\&quot;token operator\&quot;>)</span> Chrome<span class=\&quot;token operator\&quot;>/</span><span class=\&quot;token number\&quot;>89.0.4389.90</span> Safari<span class=\&quot;token operator\&quot;>/</span><span class=\&quot;token number\&quot;>537.36</span> Edg<span class=\&quot;token operator\&quot;>/</span><span class=\&quot;token ip-address constant\&quot;>89.0.774.57</span>\n<span class=\&quot;token property\&quot;>Accept:</span> <span class=\&quot;token operator\&quot;>*</span><span class=\&quot;token operator\&quot;>/</span><span class=\&quot;token operator\&quot;>*</span>\n<span class=\&quot;token property\&quot;>Origin:</span> <span class=\&quot;token url\&quot;>https://blog.haniyama.com</span>\n<span class=\&quot;token property\&quot;>Sec-Fetch-Site:</span> cross<span class=\&quot;token operator\&quot;>-</span>site\n<span class=\&quot;token property\&quot;>Sec-Fetch-Mode:</span> cors\n<span class=\&quot;token property\&quot;>Sec-Fetch-Dest:</span> empty\n<span class=\&quot;token property\&quot;>Accept-Encoding:</span> gzip<span class=\&quot;token punctuation\&quot;>,</span> deflate<span class=\&quot;token punctuation\&quot;>,</span> br\n<span class=\&quot;token property\&quot;>Accept-Language:</span> ja<span class=\&quot;token punctuation\&quot;>,</span>en<span class=\&quot;token operator\&quot;>-</span>US<span class=\&quot;token operator\&quot;>;</span>q<span class=\&quot;token operator\&quot;>=</span><span class=\&quot;token number\&quot;>0.9</span><span class=\&quot;token punctuation\&quot;>,</span>en<span class=\&quot;token operator\&quot;>;</span>q<span class=\&quot;token operator\&quot;>=</span><span class=\&quot;token number\&quot;>0.8</span>\n&quot;}"><span class="token level info keyword">INFO</span><span class="token operator">:</span>root<span class="token operator">:</span>GET request<span class="token punctuation">,</span><span class="token property">Path:</span> <span class="token file-path string">/api</span><span class="token property">Headers:</span><span class="token property">Host:</span> localhost<span class="token operator">:</span><span class="token number">8080</span><span class="token property">Connection:</span> keep<span class="token operator">-</span>alive<span class="token property">User-Agent:</span> Mozilla<span class="token operator">/</span><span class="token number">5.0</span> <span class="token operator">(</span>Windows NT <span class="token number">10.0</span><span class="token operator">;</span> Win64<span class="token operator">;</span> x64<span class="token operator">)</span> AppleWebKit<span class="token operator">/</span><span class="token number">537.36</span> <span class="token operator">(</span>KHTML<span class="token punctuation">,</span> like Gecko<span class="token operator">)</span> Chrome<span class="token operator">/</span><span class="token number">89.0.4389.90</span> Safari<span class="token operator">/</span><span class="token number">537.36</span> Edg<span class="token operator">/</span><span class="token ip-address constant">89.0.774.57</span><span class="token property">Accept:</span> <span class="token operator">*</span><span class="token operator">/</span><span class="token operator">*</span><span class="token property">Origin:</span> <span class="token url">https://blog.haniyama.com</span><span class="token property">Sec-Fetch-Site:</span> cross<span class="token operator">-</span>site<span class="token property">Sec-Fetch-Mode:</span> cors<span class="token property">Sec-Fetch-Dest:</span> empty<span class="token property">Accept-Encoding:</span> gzip<span class="token punctuation">,</span> deflate<span class="token punctuation">,</span> br<span class="token property">Accept-Language:</span> ja<span class="token punctuation">,</span>en<span class="token operator">-</span>US<span class="token operator">;</span>q<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span>en<span class="token operator">;</span>q<span class="token operator">=</span><span class="token number">0.8</span></code></pre><p>ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã® DevTools ã§ã¯ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å†…å®¹ã¯è¦‹ãˆãªã„ã€‚</p><p><img src="/2021/04/24/cors/devtools01.png"></p><p>Fiddler (http ãªã®ã§ WireShark ã§ã‚‚) ãªã©ã®é€šä¿¡ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’å–å¾—ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§é€šä¿¡ã‚’ã¿ã‚‹ã¨ã€ç¢ºã‹ã«ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ãŒãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ã‘å–ã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚</p><pre class="language-http" style="" tabindex="0"><code id="456e913e" class="language-http" data-prism-hydrate="{&quot;element&quot;:&quot;456e913e&quot;,&quot;language&quot;:&quot;http&quot;,&quot;code&quot;:&quot;\nHTTP/1.0 200 OK\nServer: BaseHTTP/0.6 Python/3.9.0\nDate: Mon, 22 Mar 2021 13:02:37 GMT\n\nGET request for /api,\n\nwith request headers: \nHost: localhost:8080\nConnection: keep-alive\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36 Edg/89.0.774.57\nAccept: */*\nOrigin: https://blog.haniyama.com\nSec-Fetch-Site: cross-site\nSec-Fetch-Mode: cors\nSec-Fetch-Dest: empty\nAccept-Encoding: gzip, deflate, br\nAccept-Language: ja,en-US;q=0.9,en;q=0.8\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token response-status\&quot;\u003e<span class=\&quot;token http-version property\&quot;>HTTP/1.0</span> <span class=\&quot;token status-code number\&quot;>200</span> <span class=\&quot;token reason-phrase string\&quot;>OK</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Server</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>BaseHTTP/0.6 Python/3.9.0</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Date</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>Mon, 22 Mar 2021 13:02:37 GMT</span></span>\n\nGET request for /api,\n\nwith request headers: \n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Host</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>localhost:8080</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Connection</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>keep-alive</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>User-Agent</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36 Edg/89.0.774.57</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Accept</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>*/*</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Origin</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>https://blog.haniyama.com</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Sec-Fetch-Site</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>cross-site</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Sec-Fetch-Mode</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>cors</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Sec-Fetch-Dest</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>empty</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Accept-Encoding</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>gzip, deflate, br</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Accept-Language</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>ja,en-US;q=0.9,en;q=0.8</span></span>\n&quot;}"><span class="token response-status"><span class="token http-version property">HTTP/1.0</span> <span class="token status-code number">200</span> <span class="token reason-phrase string">OK</span></span><span class="token header"><span class="token header-name keyword">Server</span><span class="token punctuation">:</span> <span class="token header-value">BaseHTTP/0.6 Python/3.9.0</span></span><span class="token header"><span class="token header-name keyword">Date</span><span class="token punctuation">:</span> <span class="token header-value">Mon, 22 Mar 2021 13:02:37 GMT</span></span>GET request for /api,with request headers: <span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">localhost:8080</span></span><span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">keep-alive</span></span><span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36 Edg/89.0.774.57</span></span><span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">*/*</span></span><span class="token header"><span class="token header-name keyword">Origin</span><span class="token punctuation">:</span> <span class="token header-value">https://blog.haniyama.com</span></span><span class="token header"><span class="token header-name keyword">Sec-Fetch-Site</span><span class="token punctuation">:</span> <span class="token header-value">cross-site</span></span><span class="token header"><span class="token header-name keyword">Sec-Fetch-Mode</span><span class="token punctuation">:</span> <span class="token header-value">cors</span></span><span class="token header"><span class="token header-name keyword">Sec-Fetch-Dest</span><span class="token punctuation">:</span> <span class="token header-value">empty</span></span><span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate, br</span></span><span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">ja,en-US;q=0.9,en;q=0.8</span></span></code></pre><p>å‹•ã‹ã—ã¦ã¿ã‚Œã°ã‚ã‹ã‚‹ãŒã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ã‘å–ã£ãŸãŒã€CORS ã‚’æˆåŠŸã•ã›ã‚‹ãŸã‚ã®æ¡ä»¶ã‚’æº€ãŸã•ãªã‹ã£ãŸãŸã‚ã€JavaScript ã¸ãƒ‡ãƒ¼ã‚¿ã¯æ¸¡ã•ãªã„ã“ã¨ã‚’é¸æŠã—ãŸå‹•ä½œã¨ãªã£ã¦ã„ã‚‹ã€‚<br>CORS ã‚’åˆ¤å®šã™ã‚‹ã®ã¯å¸¸ã«ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã§ã‚ã‚Šã€ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚‚ JavaScript å´ã§ã‚‚ãªã„ã€‚ãã®ãŸã‚ã€ãŸã¨ãˆã° curl ã‚„ Invoke-WebRequest ãªã©ã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã§ã¯ãªã„ API ã‚¢ã‚¯ã‚»ã‚¹ã¯å•é¡ŒãªãæˆåŠŸã™ã‚‹ã€‚</p><p>ãã—ã¦ CORS ã‚’æˆåŠŸã•ã›ã‚‹ã«ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã§ã‚‚ JavaScript ã§ã‚‚ãªãã€ã‚µãƒ¼ãƒãƒ¼å´ã‚’ä¿®æ­£ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚</p><p>â€» ãŸã ã—ç§ã®å‘¨ã‚Šã§èµ·ã“ã‚‹ CORS ã®å•é¡Œã¯ã€ãŸã„ã¦ã„ã‚µãƒ¼ãƒãƒ¼å´ãŒä½•ã‚‰ã‹ã®ã‚¨ãƒƒã‚¸ã§ã€å®Ÿéš›ã«ä¿®æ­£ãŒã§ããªã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã“ã¨ãŒå¤šã„ã€‚ã¨ã„ã†ã‹ä»•çµ„ã¿ã‚’çŸ¥ã£ã¦ã„ã‚Œã°å½“ãŸã‚Šå‰ãªã®ã ãŒã€<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/manage-apps/application-proxy-understand-cors-issues">äº‹å‰èªè¨¼ãŒæœ‰åŠ¹ãª Azure AD ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ—ãƒ­ã‚­ã‚·ã¯ CORS ã«å¯¾å¿œã—ã¦ã„ãªã„ã€‚</a></p><h2 id="CORS-Step-1-Access-Control-Allow-Origin"><a href="#CORS-Step-1-Access-Control-Allow-Origin" class="headerlink" title="CORS Step 1 (Access-Control-Allow-Origin)"></a>CORS Step 1 (Access-Control-Allow-Origin)</h2><p>ã¨ã„ã†ã“ã¨ã§ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦ã¿ã‚‹ã€‚</p><pre class="language-python" style="" tabindex="0"><code id="39171e3f" class="language-python" data-prism-hydrate="{&quot;element&quot;:&quot;39171e3f&quot;,&quot;language&quot;:&quot;python&quot;,&quot;code&quot;:&quot;\nfrom http.server import BaseHTTPRequestHandler, ThreadingHTTPServer\nimport logging\n\&quot;\&quot;\&quot;\nVery simple HTTP server in python for logging requests (for python 3.7 or later)\nUsage::\n    ./server.py [\u003cport\u003e]\n\&quot;\&quot;\&quot;\n\nclass S(BaseHTTPRequestHandler):\n    def _set_response(self, custom_headers = {}):\n        self.send_response(200)\n        # add header\n        self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;*\&quot;)\n        self.end_headers()\n\n    def do_GET(self):\n        logging.info(\&quot;GET request,\\nPath: %s\\nHeaders:\\n%s\\n\&quot;,\n                     str(self.path), str(self.headers))\n        self._set_response()\n        self.wfile.write(\&quot;GET request for {},\\n\\n with request headers: \\n {}\&quot;.format(\n            self.path, self.headers).encode(\u0027utf-8'))\n\ndef run(server_class=ThreadingHTTPServer, handler_class=S, port=8080):\n    logging.basicConfig(level=logging.INFO)\n    server_address = ('', port)\n    httpd = server_class(server_address, handler_class)\n    logging.info(\&quot;Starting httpd... port {}\\n\&quot;.format(str(port)))\n    try:\n        httpd.serve_forever()\n    except KeyboardInterrupt:\n        pass\n    httpd.server_close()\n    logging.info('Stopping httpd...\\n')\n\n\nif __name__ == '__main__':\n    from sys import argv\n\n    if len(argv) == 2:\n        run(port=int(argv[1]))\n    else:\n        run()\n&quot;,&quot;highlightedCode&quot;:&quot;\n<span class=\&quot;token keyword\&quot;>from</span> http<span class=\&quot;token punctuation\&quot;>.</span>server <span class=\&quot;token keyword\&quot;>import</span> BaseHTTPRequestHandler<span class=\&quot;token punctuation\&quot;>,</span> ThreadingHTTPServer\n<span class=\&quot;token keyword\&quot;>import</span> logging\n<span class=\&quot;token triple-quoted-string string\&quot;>\&quot;\&quot;\&quot;\nVery simple HTTP server in python for logging requests (for python 3.7 or later)\nUsage::\n    ./server.py [\u0026lt;port>]\n\&quot;\&quot;\&quot;</span>\n\n<span class=\&quot;token keyword\&quot;>class</span> <span class=\&quot;token class-name\&quot;>S</span><span class=\&quot;token punctuation\&quot;>(</span>BaseHTTPRequestHandler<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>:</span>\n    <span class=\&quot;token keyword\&quot;>def</span> <span class=\&quot;token function\&quot;>_set_response</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>,</span> custom_headers <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>:</span>\n        self<span class=\&quot;token punctuation\&quot;>.</span>send_response<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token number\&quot;>200</span><span class=\&quot;token punctuation\&quot;>)</span>\n        <span class=\&quot;token comment\&quot;># add header</span>\n        self<span class=\&quot;token punctuation\&quot;>.</span>send_header<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;Access-Control-Allow-Origin\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token string\&quot;>\&quot;*\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span>\n        self<span class=\&quot;token punctuation\&quot;>.</span>end_headers<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n    <span class=\&quot;token keyword\&quot;>def</span> <span class=\&quot;token function\&quot;>do_GET</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>:</span>\n        logging<span class=\&quot;token punctuation\&quot;>.</span>info<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;GET request,\\nPath: %s\\nHeaders:\\n%s\\n\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n                     <span class=\&quot;token builtin\&quot;>str</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>.</span>path<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token builtin\&quot;>str</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>.</span>headers<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n        self<span class=\&quot;token punctuation\&quot;>.</span>_set_response<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n        self<span class=\&quot;token punctuation\&quot;>.</span>wfile<span class=\&quot;token punctuation\&quot;>.</span>write<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;GET request for {},\\n\\n with request headers: \\n {}\&quot;</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token builtin\&quot;>format</span><span class=\&quot;token punctuation\&quot;>(</span>\n            self<span class=\&quot;token punctuation\&quot;>.</span>path<span class=\&quot;token punctuation\&quot;>,</span> self<span class=\&quot;token punctuation\&quot;>.</span>headers<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span>encode<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>'utf-8'</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n<span class=\&quot;token keyword\&quot;>def</span> <span class=\&quot;token function\&quot;>run</span><span class=\&quot;token punctuation\&quot;>(</span>server_class<span class=\&quot;token operator\&quot;>=</span>ThreadingHTTPServer<span class=\&quot;token punctuation\&quot;>,</span> handler_class<span class=\&quot;token operator\&quot;>=</span>S<span class=\&quot;token punctuation\&quot;>,</span> port<span class=\&quot;token operator\&quot;>=</span><span class=\&quot;token number\&quot;>8080</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>:</span>\n    logging<span class=\&quot;token punctuation\&quot;>.</span>basicConfig<span class=\&quot;token punctuation\&quot;>(</span>level<span class=\&quot;token operator\&quot;>=</span>logging<span class=\&quot;token punctuation\&quot;>.</span>INFO<span class=\&quot;token punctuation\&quot;>)</span>\n    server_address <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>''</span><span class=\&quot;token punctuation\&quot;>,</span> port<span class=\&quot;token punctuation\&quot;>)</span>\n    httpd <span class=\&quot;token operator\&quot;>=</span> server_class<span class=\&quot;token punctuation\&quot;>(</span>server_address<span class=\&quot;token punctuation\&quot;>,</span> handler_class<span class=\&quot;token punctuation\&quot;>)</span>\n    logging<span class=\&quot;token punctuation\&quot;>.</span>info<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;Starting httpd... port {}\\n\&quot;</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token builtin\&quot;>format</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token builtin\&quot;>str</span><span class=\&quot;token punctuation\&quot;>(</span>port<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n    <span class=\&quot;token keyword\&quot;>try</span><span class=\&quot;token punctuation\&quot;>:</span>\n        httpd<span class=\&quot;token punctuation\&quot;>.</span>serve_forever<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n    <span class=\&quot;token keyword\&quot;>except</span> KeyboardInterrupt<span class=\&quot;token punctuation\&quot;>:</span>\n        <span class=\&quot;token keyword\&quot;>pass</span>\n    httpd<span class=\&quot;token punctuation\&quot;>.</span>server_close<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n    logging<span class=\&quot;token punctuation\&quot;>.</span>info<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>'Stopping httpd...\\n'</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n\n<span class=\&quot;token keyword\&quot;>if</span> __name__ <span class=\&quot;token operator\&quot;>==</span> <span class=\&quot;token string\&quot;>'__main__'</span><span class=\&quot;token punctuation\&quot;>:</span>\n    <span class=\&quot;token keyword\&quot;>from</span> sys <span class=\&quot;token keyword\&quot;>import</span> argv\n\n    <span class=\&quot;token keyword\&quot;>if</span> <span class=\&quot;token builtin\&quot;>len</span><span class=\&quot;token punctuation\&quot;>(</span>argv<span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token operator\&quot;>==</span> <span class=\&quot;token number\&quot;>2</span><span class=\&quot;token punctuation\&quot;>:</span>\n        run<span class=\&quot;token punctuation\&quot;>(</span>port<span class=\&quot;token operator\&quot;>=</span><span class=\&quot;token builtin\&quot;>int</span><span class=\&quot;token punctuation\&quot;>(</span>argv<span class=\&quot;token punctuation\&quot;>[</span><span class=\&quot;token number\&quot;>1</span><span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n    <span class=\&quot;token keyword\&quot;>else</span><span class=\&quot;token punctuation\&quot;>:</span>\n        run<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n&quot;}"><span class="token keyword">from</span> http<span class="token punctuation">.</span>server <span class="token keyword">import</span> BaseHTTPRequestHandler<span class="token punctuation">,</span> ThreadingHTTPServer<span class="token keyword">import</span> logging<span class="token triple-quoted-string string">"""Very simple HTTP server in python for logging requests (for python 3.7 or later)Usage::    ./server.py [&lt;port&gt;]"""</span><span class="token keyword">class</span> <span class="token class-name">S</span><span class="token punctuation">(</span>BaseHTTPRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">_set_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> custom_headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>        <span class="token comment"># add header</span>        self<span class="token punctuation">.</span>send_header<span class="token punctuation">(</span><span class="token string">"Access-Control-Allow-Origin"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">do_GET</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"GET request,\nPath: %s\nHeaders:\n%s\n"</span><span class="token punctuation">,</span>                     <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>_set_response<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"GET request for {},\n\n with request headers: \n {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>            self<span class="token punctuation">.</span>path<span class="token punctuation">,</span> self<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>server_class<span class="token operator">=</span>ThreadingHTTPServer<span class="token punctuation">,</span> handler_class<span class="token operator">=</span>S<span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>    server_address <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span>    httpd <span class="token operator">=</span> server_class<span class="token punctuation">(</span>server_address<span class="token punctuation">,</span> handler_class<span class="token punctuation">)</span>    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Starting httpd... port {}\n"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        httpd<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>        <span class="token keyword">pass</span>    httpd<span class="token punctuation">.</span>server_close<span class="token punctuation">(</span><span class="token punctuation">)</span>    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Stopping httpd...\n'</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    <span class="token keyword">from</span> sys <span class="token keyword">import</span> argv    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>        run<span class="token punctuation">(</span>port<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        run<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>ã“ã‚Œã§å…ˆã»ã©ã¨åŒã˜ fetch ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦ã¿ã‚‹ã€‚</p><pre class="language-js" style="" tabindex="0"><code id="2072683d" class="language-js" data-prism-hydrate="{&quot;element&quot;:&quot;2072683d&quot;,&quot;language&quot;:&quot;js&quot;,&quot;code&quot;:&quot;\nfetch(\&quot;http://localhost:8080/api/step1\&quot;)\nPromise&nbsp;{\u003cpending\u003e}\n&quot;,&quot;highlightedCode&quot;:&quot;\n<span class=\&quot;token function\&quot;>fetch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;http://localhost:8080/api/step1\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span>\nPromise <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token operator\&quot;>\u0026lt;</span>pending<span class=\&quot;token operator\&quot;>></span><span class=\&quot;token punctuation\&quot;>}</span>\n&quot;}"><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/api/step1"</span><span class="token punctuation">)</span>Promise <span class="token punctuation">{</span><span class="token operator">&lt;</span>pending<span class="token operator">&gt;</span><span class="token punctuation">}</span></code></pre><p>ä»Šåº¦ã¯ã‚¨ãƒ©ãƒ¼ã¯èµ·ã“ã‚‰ãªã„ã€‚</p><pre class="language-js" style="" tabindex="0"><code id="5f9b743f" class="language-js" data-prism-hydrate="{&quot;element&quot;:&quot;5f9b743f&quot;,&quot;language&quot;:&quot;js&quot;,&quot;code&quot;:&quot;\nfetch(\&quot;http://localhost:8080/api/step1\&quot;).then(r =\u003e r.text()).then(data => console.log(data))\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token function\&quot;>fetch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;http://localhost:8080/api/step1\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>r</span> <span class=\&quot;token operator\&quot;>=></span> r<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>text</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>data</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>data<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n&quot;}"><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/api/step1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>ã®ã‚ˆã†ã«ã™ã‚Œã°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å†…å®¹ãŒè¦‹ãˆã‚‹ã¯ãšã€‚ <code>Access-Control-Allow-Origin: &quot;*&quot;</code> ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ CORS ã§ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã‚µãƒ¼ãƒãƒ¼ãŒãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã«è¨±å¯ã™ã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã„ã†ã“ã¨ã€‚</p><h2 id="CORS-Step-2-Access-Control-Allow-Headers"><a href="#CORS-Step-2-Access-Control-Allow-Headers" class="headerlink" title="CORS Step 2 (Access-Control-Allow-Headers)"></a>CORS Step 2 (Access-Control-Allow-Headers)</h2><p>ç„¡äº‹ã« CORS ã®å¯¾å¿œãŒã§ããŸã®ã§ã€æ¬¡ã¯ãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡ã‚’è¡Œã† API ã‚’ä½œã‚‹ã€‚</p><pre class="language-python" style="" tabindex="0"><code id="50c0ad3d" class="language-python" data-prism-hydrate="{&quot;element&quot;:&quot;50c0ad3d&quot;,&quot;language&quot;:&quot;python&quot;,&quot;code&quot;:&quot;\n    def do_POST(self):\n        logging.info(\&quot;POST request,\\nPath: %s\\nHeaders:\\n%s\\n\&quot;,\n                     str(self.path), str(self.headers))\n\n        content_length = int(self.headers[\u0027Content-Length'])\n        post_data = self.rfile.read(content_length)\n        body = json.loads(post_data)\n\n        self._set_response()\n\n        res = json.dumps({\n            \&quot;status\&quot;: \&quot;ok\&quot;,\n            \&quot;message\&quot;: \&quot;hello {}\&quot;.format(body.get(\&quot;name\&quot;))\n        })\n        \n        self.wfile.write(res.encode('utf-8'))\n&quot;,&quot;highlightedCode&quot;:&quot;\n    \u003cspan class=\&quot;token keyword\&quot;\u003edef</span> <span class=\&quot;token function\&quot;>do_POST</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>:</span>\n        logging<span class=\&quot;token punctuation\&quot;>.</span>info<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;POST request,\\nPath: %s\\nHeaders:\\n%s\\n\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n                     <span class=\&quot;token builtin\&quot;>str</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>.</span>path<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token builtin\&quot;>str</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>.</span>headers<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n        content_length <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token builtin\&quot;>int</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>.</span>headers<span class=\&quot;token punctuation\&quot;>[</span><span class=\&quot;token string\&quot;>'Content-Length'</span><span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>)</span>\n        post_data <span class=\&quot;token operator\&quot;>=</span> self<span class=\&quot;token punctuation\&quot;>.</span>rfile<span class=\&quot;token punctuation\&quot;>.</span>read<span class=\&quot;token punctuation\&quot;>(</span>content_length<span class=\&quot;token punctuation\&quot;>)</span>\n        body <span class=\&quot;token operator\&quot;>=</span> json<span class=\&quot;token punctuation\&quot;>.</span>loads<span class=\&quot;token punctuation\&quot;>(</span>post_data<span class=\&quot;token punctuation\&quot;>)</span>\n\n        self<span class=\&quot;token punctuation\&quot;>.</span>_set_response<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n        res <span class=\&quot;token operator\&quot;>=</span> json<span class=\&quot;token punctuation\&quot;>.</span>dumps<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>{</span>\n            <span class=\&quot;token string\&quot;>\&quot;status\&quot;</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;ok\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n            <span class=\&quot;token string\&quot;>\&quot;message\&quot;</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;hello {}\&quot;</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token builtin\&quot;>format</span><span class=\&quot;token punctuation\&quot;>(</span>body<span class=\&quot;token punctuation\&quot;>.</span>get<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;name\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n        <span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span>\n        \n        self<span class=\&quot;token punctuation\&quot;>.</span>wfile<span class=\&quot;token punctuation\&quot;>.</span>write<span class=\&quot;token punctuation\&quot;>(</span>res<span class=\&quot;token punctuation\&quot;>.</span>encode<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>'utf-8'</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n&quot;}">    <span class="token keyword">def</span> <span class="token function">do_POST</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"POST request,\nPath: %s\nHeaders:\n%s\n"</span><span class="token punctuation">,</span>                     <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>        content_length <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Content-Length'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        post_data <span class="token operator">=</span> self<span class="token punctuation">.</span>rfile<span class="token punctuation">.</span>read<span class="token punctuation">(</span>content_length<span class="token punctuation">)</span>        body <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>post_data<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>_set_response<span class="token punctuation">(</span><span class="token punctuation">)</span>        res <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span>            <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"ok"</span><span class="token punctuation">,</span>            <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"hello {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span>res<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>ãã—ã¦ã€POST ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯ JSON ã§ã“ã†é€ã‚‹ã€‚</p><pre class="language-js" style="" tabindex="0"><code id="81a7673f" class="language-js" data-prism-hydrate="{&quot;element&quot;:&quot;81a7673f&quot;,&quot;language&quot;:&quot;js&quot;,&quot;code&quot;:&quot;\nfetch(\&quot;http://localhost:8080/api/step2\&quot;, { method: \&quot;POST\&quot; , body: JSON.stringify({\&quot;name\&quot;: \&quot;watahani\&quot;})}).then(r =\u003e r.text()).then(data => console.log(data))\n\n//{\&quot;status\&quot;: \&quot;ok\&quot;, \&quot;message\&quot;: \&quot;hello watahani\&quot;}\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token function\&quot;>fetch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;http://localhost:8080/api/step2\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token punctuation\&quot;>{</span> <span class=\&quot;token literal-property property\&quot;>method</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;POST\&quot;</span> <span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>body</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token constant\&quot;>JSON</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>stringify</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;watahani\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>r</span> <span class=\&quot;token operator\&quot;>=></span> r<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>text</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>data</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>data<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n<span class=\&quot;token comment\&quot;>//{\&quot;status\&quot;: \&quot;ok\&quot;, \&quot;message\&quot;: \&quot;hello watahani\&quot;}</span>\n&quot;}"><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/api/step2"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span> <span class="token punctuation">,</span> <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"watahani"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//{"status": "ok", "message": "hello watahani"}</span></code></pre><p>ã™ã°ã‚‰ã—ã„ã€‚Access-Control-Allow-Origin ã®ãŠã‹ã’ã§ã†ã¾ãé€šä¿¡ãŒã§ãã¦ã„ã‚‹ã€‚ã—ã‹ã—ãªãŒã‚‰ã€ã“ã“ã§ Content-Type ã‚’ â€œapplication&#x2F;jsonâ€ ã§ã€Authorization ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å«ã‚ã¦é€ã£ã¦ã»ã—ã„ã¨è¦æœ›ãŒã‚ã£ãŸãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¿½åŠ ã™ã‚‹ã¨ã¾ãŸè¬ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã€‚</p><pre class="language-js" style="" tabindex="0"><code id="c371b93e" class="language-js" data-prism-hydrate="{&quot;element&quot;:&quot;c371b93e&quot;,&quot;language&quot;:&quot;js&quot;,&quot;code&quot;:&quot;\nfetch(\&quot;http://localhost:8080/api/step2\&quot;, { method: \&quot;POST\&quot; , headers: {\&quot;Content-Type\&quot;: \&quot;application/json\&quot;, \&quot;Authorization\&quot;: \&quot;xxxxx\&quot;}, body: JSON.stringify({\&quot;name\&quot;: \&quot;watahani\&quot;})}).then(r =\u003e r.text()).then(data => console.log(data))\n\n//Access to fetch at \u0027http://localhost:8080/api/step2' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: Response to preflight request doesn't pass access control check: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token function\&quot;>fetch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;http://localhost:8080/api/step2\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token punctuation\&quot;>{</span> <span class=\&quot;token literal-property property\&quot;>method</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;POST\&quot;</span> <span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>headers</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;Content-Type\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;application/json\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token string-property property\&quot;>\&quot;Authorization\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;xxxxx\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>body</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token constant\&quot;>JSON</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>stringify</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;watahani\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>r</span> <span class=\&quot;token operator\&quot;>=></span> r<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>text</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>data</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>data<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n<span class=\&quot;token comment\&quot;>//Access to fetch at 'http://localhost:8080/api/step2' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: Response to preflight request doesn't pass access control check: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.</span>\n&quot;}"><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/api/step2"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span> <span class="token punctuation">,</span> <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span> <span class="token string-property property">"Authorization"</span><span class="token operator">:</span> <span class="token string">"xxxxx"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"watahani"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//Access to fetch at 'http://localhost:8080/api/step2' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: Response to preflight request doesn't pass access control check: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.</span></code></pre><p>ã“ã‚Œã¯ preflight request ãŒãƒ‘ã‚¹ã—ãªã‹ã£ãŸã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã ã€‚preflight request ã¨ã¯ã€å˜ç´”ãƒªã‚¯ã‚¨ã‚¹ãƒˆ (simple request) ã§ã¯ãªã„é€šä¿¡ãŒç™ºç”Ÿã™ã‚‹éš›ã«ç™ºç”Ÿã™ã‚‹ â€œãŠä¼ºã„â€ ã§ã‚ã‚Šã€OPTIONS ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚ˆã‚Šæœ¬æ¥è¡Œã†ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ã¦ã‚ˆã„ origin ã‹ã‚‰ã®é€šä¿¡ãªã®ã‹ã‚’åˆ¤åˆ¥ã™ã‚‹æ©Ÿèƒ½ã€ã¨ã„ã†ã®ãŒç§ã®ç†è§£ã€‚</p><p>ä¸€æ–¹ã§ <a href="https://developer.mozilla.org/ja/docs/Web/HTTP/CORS#simple_requests">å˜ç´”ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å®Ÿéš›ã®æ¡ä»¶</a> ã¯ MDN ã«çºã¾ã£ã¦ã„ã‚‹ãŒã€API å´ã«å‰¯ä½œç”¨ã‚’ä¸ãˆãšèªè¨¼ã‚’å¿…è¦ã¨ã—ãªã„ GET, HEAD ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã«å…ƒæ¥å«ã¾ã‚Œã¦ã„ã‚‹ form post ã«ã‚ˆã‚‹é€šä¿¡ãŒå˜ç´”ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ã¨ç§ã¯ç†è§£ã—ã¦ã„ã‚‹ã€‚</p><p>ã•ã¦ã€ã“ã‚Œã‚’è§£æ±ºã™ã‚‹ã«ã¯ Access-Control-Allow-Origin ã‚’ <code>*</code> ã§ã¯ãªãã€fetch å…ƒã® Origin ã¨ä¸€è‡´ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚</p><pre class="language-diff" style="" tabindex="0"><code id="4a45ca3c" class="language-diff" data-prism-hydrate="{&quot;element&quot;:&quot;4a45ca3c&quot;,&quot;language&quot;:&quot;diff&quot;,&quot;code&quot;:&quot;\n-        self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;*\&quot;)\n+        self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token deleted-sign deleted\&quot;\u003e<span class=\&quot;token prefix deleted\&quot;>-</span><span class=\&quot;token line\&quot;>        self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;*\&quot;)\n</span></span><span class=\&quot;token inserted-sign inserted\&quot;><span class=\&quot;token prefix inserted\&quot;>+</span><span class=\&quot;token line\&quot;>        self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n</span></span>&quot;}"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">        self.send_header("Access-Control-Allow-Origin", "*")</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">        self.send_header("Access-Control-Allow-Origin", "https://blog.haniyama.com")</span></span></code></pre><p>ã¾ãŸã€OPTIONS ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ä»¥ä¸‹ã‚‚è¿½åŠ ã™ã‚‹ã€‚</p><pre class="language-python" style="" tabindex="0"><code id="b949be3e" class="language-python" data-prism-hydrate="{&quot;element&quot;:&quot;b949be3e&quot;,&quot;language&quot;:&quot;python&quot;,&quot;code&quot;:&quot;\n    def do_OPTIONS(self):\n        logging.info(\&quot;OPTIONS request,\\nPath: %s\\nHeaders:\\n%s\\n\&quot;,\n                     str(self.path), str(self.headers))\n        self._set_response()\n\n        self.wfile.write(\&quot;OPTIONS request for {},\\n\\n with request headers:\\n{}\&quot;.format(\n            self.path, self.headers).encode(\u0027utf-8'))\n&quot;,&quot;highlightedCode&quot;:&quot;\n    \u003cspan class=\&quot;token keyword\&quot;\u003edef</span> <span class=\&quot;token function\&quot;>do_OPTIONS</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>:</span>\n        logging<span class=\&quot;token punctuation\&quot;>.</span>info<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;OPTIONS request,\\nPath: %s\\nHeaders:\\n%s\\n\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n                     <span class=\&quot;token builtin\&quot;>str</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>.</span>path<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token builtin\&quot;>str</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>.</span>headers<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n        self<span class=\&quot;token punctuation\&quot;>.</span>_set_response<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n        self<span class=\&quot;token punctuation\&quot;>.</span>wfile<span class=\&quot;token punctuation\&quot;>.</span>write<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;OPTIONS request for {},\\n\\n with request headers:\\n{}\&quot;</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token builtin\&quot;>format</span><span class=\&quot;token punctuation\&quot;>(</span>\n            self<span class=\&quot;token punctuation\&quot;>.</span>path<span class=\&quot;token punctuation\&quot;>,</span> self<span class=\&quot;token punctuation\&quot;>.</span>headers<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span>encode<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>'utf-8'</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n&quot;}">    <span class="token keyword">def</span> <span class="token function">do_OPTIONS</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"OPTIONS request,\nPath: %s\nHeaders:\n%s\n"</span><span class="token punctuation">,</span>                     <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>_set_response<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"OPTIONS request for {},\n\n with request headers:\n{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>            self<span class="token punctuation">.</span>path<span class="token punctuation">,</span> self<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>ã“ã®çŠ¶æ…‹ã§ã‚‚ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã€‚</p><pre class="language-js" style="" tabindex="0"><code id="2d6fc03e" class="language-js" data-prism-hydrate="{&quot;element&quot;:&quot;2d6fc03e&quot;,&quot;language&quot;:&quot;js&quot;,&quot;code&quot;:&quot;\nfetch(\&quot;http://localhost:8080/api/step2\&quot;, { method: \&quot;POST\&quot; , headers: {\&quot;Content-Type\&quot;: \&quot;application/json\&quot;, \&quot;Authorization\&quot;: \&quot;xxxxx\&quot;}, body: JSON.stringify({\&quot;name\&quot;: \&quot;watahani\&quot;})}).then(r =\u003e r.text()).then(data => console.log(data))\n\nPromise&nbsp;{\u003cpending>}\n\nAccess to fetch at \u0027http://localhost:8080/api/step2' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: Request header field content-type is not allowed by Access-Control-Allow-Headers in preflight response.\n&quot;,&quot;highlightedCode&quot;:&quot;\n<span class=\&quot;token function\&quot;>fetch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;http://localhost:8080/api/step2\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token punctuation\&quot;>{</span> <span class=\&quot;token literal-property property\&quot;>method</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;POST\&quot;</span> <span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>headers</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;Content-Type\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;application/json\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token string-property property\&quot;>\&quot;Authorization\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;xxxxx\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>body</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token constant\&quot;>JSON</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>stringify</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;watahani\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>r</span> <span class=\&quot;token operator\&quot;>=></span> r<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>text</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>data</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>data<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n\nPromise <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token operator\&quot;>\u0026lt;</span>pending<span class=\&quot;token operator\&quot;>></span><span class=\&quot;token punctuation\&quot;>}</span>\n\nAccess to fetch at <span class=\&quot;token string\&quot;>'http://localhost:8080/api/step2'</span> from origin <span class=\&quot;token string\&quot;>'https://blog.haniyama.com'</span> has been blocked by <span class=\&quot;token constant\&quot;>CORS</span> <span class=\&quot;token literal-property property\&quot;>policy</span><span class=\&quot;token operator\&quot;>:</span> Request header field content<span class=\&quot;token operator\&quot;>-</span>type is not allowed by Access<span class=\&quot;token operator\&quot;>-</span>Control<span class=\&quot;token operator\&quot;>-</span>Allow<span class=\&quot;token operator\&quot;>-</span>Headers <span class=\&quot;token keyword\&quot;>in</span> preflight response<span class=\&quot;token punctuation\&quot;>.</span>\n&quot;}"><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/api/step2"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span> <span class="token punctuation">,</span> <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span> <span class="token string-property property">"Authorization"</span><span class="token operator">:</span> <span class="token string">"xxxxx"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"watahani"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>Promise <span class="token punctuation">{</span><span class="token operator">&lt;</span>pending<span class="token operator">&gt;</span><span class="token punctuation">}</span>Access to fetch at <span class="token string">'http://localhost:8080/api/step2'</span> from origin <span class="token string">'https://blog.haniyama.com'</span> has been blocked by <span class="token constant">CORS</span> <span class="token literal-property property">policy</span><span class="token operator">:</span> Request header field content<span class="token operator">-</span>type is not allowed by Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Headers <span class="token keyword">in</span> preflight response<span class="token punctuation">.</span></code></pre><p>ã‚«ã‚¹ã‚¿ãƒ  ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã«ã¯ã€Access-Control-Allow-Headers ã‚’è¿½åŠ ã—ã‚ã¨ã„ã£ã¦ã„ã‚‹ã€‚</p><p>ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆ ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¦‹ã¦ã¿ã‚‹ã¨ <code>Access-Control-Request-Headers: authorization,content-type</code> ã®è¨˜è¼‰ãŒã‚ã‚Šã€API å´ãŒã“ã‚Œã‚‰ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨±å¯ã™ã‚‹ã®ã§ã‚ã‚Œã° <code>Access-Control-Allow-Headers: authorization, content-type</code> ã‚’è¿”ã•ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚</p><pre class="language-http" style="" tabindex="0"><code id="b3ba813e" class="language-http" data-prism-hydrate="{&quot;element&quot;:&quot;b3ba813e&quot;,&quot;language&quot;:&quot;http&quot;,&quot;code&quot;:&quot;\nHost: localhost:8080\nConnection: keep-alive\nAccept: */*\nAccess-Control-Request-Method: POST\nAccess-Control-Request-Headers: authorization,content-type\nOrigin: https://blog.haniyama.com\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36 Edg/89.0.774.63\nSec-Fetch-Mode: cors\nSec-Fetch-Site: cross-site\nSec-Fetch-Dest: empty\nAccept-Encoding: gzip, deflate, br\nAccept-Language: ja,en-US;q=0.9,en;q=0.8\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token header\&quot;\u003e<span class=\&quot;token header-name keyword\&quot;>Host</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>localhost:8080</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Connection</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>keep-alive</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Accept</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>*/*</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Access-Control-Request-Method</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>POST</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Access-Control-Request-Headers</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>authorization,content-type</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Origin</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>https://blog.haniyama.com</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>User-Agent</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36 Edg/89.0.774.63</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Sec-Fetch-Mode</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>cors</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Sec-Fetch-Site</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>cross-site</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Sec-Fetch-Dest</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>empty</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Accept-Encoding</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>gzip, deflate, br</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Accept-Language</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>ja,en-US;q=0.9,en;q=0.8</span></span>\n&quot;}"><span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">localhost:8080</span></span><span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">keep-alive</span></span><span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">*/*</span></span><span class="token header"><span class="token header-name keyword">Access-Control-Request-Method</span><span class="token punctuation">:</span> <span class="token header-value">POST</span></span><span class="token header"><span class="token header-name keyword">Access-Control-Request-Headers</span><span class="token punctuation">:</span> <span class="token header-value">authorization,content-type</span></span><span class="token header"><span class="token header-name keyword">Origin</span><span class="token punctuation">:</span> <span class="token header-value">https://blog.haniyama.com</span></span><span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36 Edg/89.0.774.63</span></span><span class="token header"><span class="token header-name keyword">Sec-Fetch-Mode</span><span class="token punctuation">:</span> <span class="token header-value">cors</span></span><span class="token header"><span class="token header-name keyword">Sec-Fetch-Site</span><span class="token punctuation">:</span> <span class="token header-value">cross-site</span></span><span class="token header"><span class="token header-name keyword">Sec-Fetch-Dest</span><span class="token punctuation">:</span> <span class="token header-value">empty</span></span><span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate, br</span></span><span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">ja,en-US;q=0.9,en;q=0.8</span></span></code></pre><p>ã¨ã„ã†ã“ã¨ã§ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹ã€‚</p><pre class="language-diff" style="" tabindex="0"><code id="5b22513e" class="language-diff" data-prism-hydrate="{&quot;element&quot;:&quot;5b22513e&quot;,&quot;language&quot;:&quot;diff&quot;,&quot;code&quot;:&quot;\n        self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token unchanged\&quot;\u003e<span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n</span></span>&quot;}"><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Origin", "https://blog.haniyama.com")</span></span></code></pre><p>ã“ã‚Œã§ç„¡äº‹ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€šã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚ã¡ãªã¿ã«ç¾æ™‚ç‚¹ã ã¨ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã«ã‚ˆã‚‹æŒ‡å®šã§ã‚‚å•é¡Œãªã„ã€‚</p><pre class="language-diff" style="" tabindex="0"><code id="09349c3e" class="language-diff" data-prism-hydrate="{&quot;element&quot;:&quot;09349c3e&quot;,&quot;language&quot;:&quot;diff&quot;,&quot;code&quot;:&quot;\n        self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n-       self.send_header(\&quot;Access-Control-Allow-Headers\&quot;, \&quot;Authorization, Content-Type\&quot;)\n+       self.send_header(\&quot;Access-Control-Allow-Headers\&quot;, \&quot;*\&quot;)\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token unchanged\&quot;\u003e<span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n</span></span><span class=\&quot;token deleted-sign deleted\&quot;><span class=\&quot;token prefix deleted\&quot;>-</span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Headers\&quot;, \&quot;Authorization, Content-Type\&quot;)\n</span></span><span class=\&quot;token inserted-sign inserted\&quot;><span class=\&quot;token prefix inserted\&quot;>+</span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Headers\&quot;, \&quot;*\&quot;)\n</span></span>&quot;}"><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Origin", "https://blog.haniyama.com")</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">       self.send_header("Access-Control-Allow-Headers", "Authorization, Content-Type")</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">       self.send_header("Access-Control-Allow-Headers", "*")</span></span></code></pre><h2 id="CORS-Step-3-Access-Control-Allow-Headers"><a href="#CORS-Step-3-Access-Control-Allow-Headers" class="headerlink" title="CORS Step 3 (Access-Control-Allow-Headers)"></a>CORS Step 3 (Access-Control-Allow-Headers)</h2><p>ã•ã¦ã€POST ãƒ¡ã‚½ãƒƒãƒ‰ãŒã§ããŸã¨ã“ã‚ã§ Delete ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å—ã‘ä»˜ã‘ã‚‹ API ã‚‚æ§‹æˆã—ãŸã„ã¨ã®ã“ã¨ã§ã€Delete ç”¨ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚µãƒ¼ãƒãƒ¼å´ã«è¿½åŠ ã—ãŸã€‚</p><pre class="language-python" style="" tabindex="0"><code id="46a8f33e" class="language-python" data-prism-hydrate="{&quot;element&quot;:&quot;46a8f33e&quot;,&quot;language&quot;:&quot;python&quot;,&quot;code&quot;:&quot;\n    def do_DELETE(self):\n        logging.info(\&quot;DELETE request,\\nPath: %s\\nHeaders:\\n%s\\n\&quot;,\n                     str(self.path), str(self.headers))\n\n        content_length = int(self.headers[\u0027Content-Length'])\n        post_data = self.rfile.read(content_length)\n        body = json.loads(post_data)\n\n        self._set_response()\n\n        res = json.dumps({\n            \&quot;status\&quot;: \&quot;ok\&quot;,\n            \&quot;message\&quot;: \&quot;deleted {}\&quot;.format(body.get(\&quot;name\&quot;))\n        })\n        \n        self.wfile.write(res.encode('utf-8'))\n&quot;,&quot;highlightedCode&quot;:&quot;\n    \u003cspan class=\&quot;token keyword\&quot;\u003edef</span> <span class=\&quot;token function\&quot;>do_DELETE</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>:</span>\n        logging<span class=\&quot;token punctuation\&quot;>.</span>info<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;DELETE request,\\nPath: %s\\nHeaders:\\n%s\\n\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n                     <span class=\&quot;token builtin\&quot;>str</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>.</span>path<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token builtin\&quot;>str</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>.</span>headers<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n        content_length <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token builtin\&quot;>int</span><span class=\&quot;token punctuation\&quot;>(</span>self<span class=\&quot;token punctuation\&quot;>.</span>headers<span class=\&quot;token punctuation\&quot;>[</span><span class=\&quot;token string\&quot;>'Content-Length'</span><span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>)</span>\n        post_data <span class=\&quot;token operator\&quot;>=</span> self<span class=\&quot;token punctuation\&quot;>.</span>rfile<span class=\&quot;token punctuation\&quot;>.</span>read<span class=\&quot;token punctuation\&quot;>(</span>content_length<span class=\&quot;token punctuation\&quot;>)</span>\n        body <span class=\&quot;token operator\&quot;>=</span> json<span class=\&quot;token punctuation\&quot;>.</span>loads<span class=\&quot;token punctuation\&quot;>(</span>post_data<span class=\&quot;token punctuation\&quot;>)</span>\n\n        self<span class=\&quot;token punctuation\&quot;>.</span>_set_response<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n        res <span class=\&quot;token operator\&quot;>=</span> json<span class=\&quot;token punctuation\&quot;>.</span>dumps<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>{</span>\n            <span class=\&quot;token string\&quot;>\&quot;status\&quot;</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;ok\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n            <span class=\&quot;token string\&quot;>\&quot;message\&quot;</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;deleted {}\&quot;</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token builtin\&quot;>format</span><span class=\&quot;token punctuation\&quot;>(</span>body<span class=\&quot;token punctuation\&quot;>.</span>get<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;name\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n        <span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span>\n        \n        self<span class=\&quot;token punctuation\&quot;>.</span>wfile<span class=\&quot;token punctuation\&quot;>.</span>write<span class=\&quot;token punctuation\&quot;>(</span>res<span class=\&quot;token punctuation\&quot;>.</span>encode<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>'utf-8'</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n&quot;}">    <span class="token keyword">def</span> <span class="token function">do_DELETE</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"DELETE request,\nPath: %s\nHeaders:\n%s\n"</span><span class="token punctuation">,</span>                     <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>        content_length <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Content-Length'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        post_data <span class="token operator">=</span> self<span class="token punctuation">.</span>rfile<span class="token punctuation">.</span>read<span class="token punctuation">(</span>content_length<span class="token punctuation">)</span>        body <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>post_data<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>_set_response<span class="token punctuation">(</span><span class="token punctuation">)</span>        res <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span>            <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"ok"</span><span class="token punctuation">,</span>            <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"deleted {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span>res<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>Step 2 ã§ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ§‹æˆã¯ã™ã‚“ã§ã„ã‚‹ã®ã§ã€å˜ç´”ã« DELETE ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã‚‹ã€‚</p><pre class="language-js" style="" tabindex="0"><code id="45a7023f" class="language-js" data-prism-hydrate="{&quot;element&quot;:&quot;45a7023f&quot;,&quot;language&quot;:&quot;js&quot;,&quot;code&quot;:&quot;\nfetch(\&quot;http://localhost:8080/api/step2\&quot;, { method: \&quot;DELETE\&quot; , headers: {\&quot;Content-Type\&quot;: \&quot;application/json\&quot;, \&quot;Authorization\&quot;: \&quot;xxxxx\&quot;}, body: JSON.stringify({\&quot;name\&quot;: \&quot;watahani\&quot;})}).then(r =\u003e r.text()).then(data => console.log(data))\n\n//Access to fetch at \u0027http://localhost:8080/api/step2' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: Method DELETE is not allowed by Access-Control-Allow-Methods in preflight response.\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token function\&quot;>fetch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;http://localhost:8080/api/step2\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token punctuation\&quot;>{</span> <span class=\&quot;token literal-property property\&quot;>method</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;DELETE\&quot;</span> <span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>headers</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;Content-Type\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;application/json\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token string-property property\&quot;>\&quot;Authorization\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;xxxxx\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>body</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token constant\&quot;>JSON</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>stringify</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;watahani\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>r</span> <span class=\&quot;token operator\&quot;>=></span> r<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>text</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>data</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>data<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n\n<span class=\&quot;token comment\&quot;>//Access to fetch at 'http://localhost:8080/api/step2' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: Method DELETE is not allowed by Access-Control-Allow-Methods in preflight response.</span>\n&quot;}"><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/api/step2"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"DELETE"</span> <span class="token punctuation">,</span> <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span> <span class="token string-property property">"Authorization"</span><span class="token operator">:</span> <span class="token string">"xxxxx"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"watahani"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//Access to fetch at 'http://localhost:8080/api/step2' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: Method DELETE is not allowed by Access-Control-Allow-Methods in preflight response.</span></code></pre><p>ãªã‚‹ã»ã©ã€ä»Šåº¦ã¯ Access-Control-Allow-Methods ãƒ˜ãƒƒãƒ€ãƒ¼ã« DELETE ãŒå«ã¾ã‚Œãªã„ãŸã‚å¤±æ•—ã—ã¦ã—ã¾ã£ãŸã€‚<br>å®Ÿã¯ POST, GET, HEAD ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ CORS-safelisted Methods ã®ãŸã‚ã€å¾Œã«èª¬æ˜ã™ã‚‹ credentials mode ãŒ included ã§ã¯ãªã„å ´åˆã¯æš—é»™çš„ã«è¨±å¯ã•ã‚Œã‚‹ã€‚ã—ã‹ã— CORS-safelisted Methods ã§ã¯ãªã„å ´åˆã¯ Access-Control-Allow-Methods ã®æŒ‡å®šãŒå¿…è¦ã¨ãªã‚‹ã€‚</p><pre class="language-diff" style="" tabindex="0"><code id="8b184a3f" class="language-diff" data-prism-hydrate="{&quot;element&quot;:&quot;8b184a3f&quot;,&quot;language&quot;:&quot;diff&quot;,&quot;code&quot;:&quot;\n        self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n        self.send_header(\&quot;Access-Control-Allow-Headers\&quot;, \&quot;*\&quot;)\n+       self.send_header(\&quot;Access-Control-Allow-Methods\&quot;, \&quot;*\&quot;)\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token unchanged\&quot;\u003e<span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n</span><span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Headers\&quot;, \&quot;*\&quot;)\n</span></span><span class=\&quot;token inserted-sign inserted\&quot;><span class=\&quot;token prefix inserted\&quot;>+</span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Methods\&quot;, \&quot;*\&quot;)\n</span></span>&quot;}"><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Origin", "https://blog.haniyama.com")</span><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Headers", "*")</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">       self.send_header("Access-Control-Allow-Methods", "*")</span></span></code></pre><p>ãªãŠã€credentials mode ãŒ include ã®å ´åˆã€ã‚ˆã‚Šåˆ¶ç´„ãŒå³ã—ããªã‚Š Access-Control-Allow-Headers ã‚„ Access-Control-Allow-Methods ã§ â€œ*â€ ã«ã‚ˆã‚‹ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰æŒ‡å®šã¯ã§ããªããªã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæŒ‡å®šãŒå¿…è¦ã«ãªã‚‹ã€‚</p><pre class="language-diff" style="" tabindex="0"><code id="2c023a3e" class="language-diff" data-prism-hydrate="{&quot;element&quot;:&quot;2c023a3e&quot;,&quot;language&quot;:&quot;diff&quot;,&quot;code&quot;:&quot;\n        self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n        self.send_header(\&quot;Access-Control-Alltoiuow-Headers\&quot;, \&quot;Authorization, Content-Type\&quot;)\n+       self.send_header(\&quot;Access-Control-Allow-Methods\&quot;, \&quot;POST, DELETE\&quot;)\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token unchanged\&quot;\u003e<span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n</span><span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Alltoiuow-Headers\&quot;, \&quot;Authorization, Content-Type\&quot;)\n</span></span><span class=\&quot;token inserted-sign inserted\&quot;><span class=\&quot;token prefix inserted\&quot;>+</span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Methods\&quot;, \&quot;POST, DELETE\&quot;)\n</span></span>&quot;}"><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Origin", "https://blog.haniyama.com")</span><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Alltoiuow-Headers", "Authorization, Content-Type")</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">       self.send_header("Access-Control-Allow-Methods", "POST, DELETE")</span></span></code></pre><h2 id="CORS-Step-4-Access-Control-Allow-Credentials"><a href="#CORS-Step-4-Access-Control-Allow-Credentials" class="headerlink" title="CORS Step 4 (Access-Control-Allow-Credentials)"></a>CORS Step 4 (Access-Control-Allow-Credentials)</h2><p>ã¨ã„ã†ã“ã¨ã§æ¬¡ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã« Cookie ã‚’å«ã‚ãŸã„å ´åˆã®è©±ã€‚fetch ã® credentials ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ â€œincludeâ€ ã«ã™ã‚‹ã¨ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ ãƒ˜ãƒƒãƒ€ãƒ¼ã« <code>Access-Control-Allow-Credentials: true</code> ãŒå¿…è¦ã«ãªã‚‹ã€‚</p><pre class="language-javascript" style="" tabindex="0"><code id="0430413f" class="language-javascript" data-prism-hydrate="{&quot;element&quot;:&quot;0430413f&quot;,&quot;language&quot;:&quot;javascript&quot;,&quot;code&quot;:&quot;\nfetch(\&quot;http://localhost:8080/api/step3\&quot;, { method: \&quot;POST\&quot; , headers: {\&quot;Content-Type\&quot;: \&quot;application/json\&quot;, \&quot;Authorization\&quot;: \&quot;xxxxx\&quot;}, credentials: \&quot;include\&quot;, body: JSON.stringify({\&quot;name\&quot;: \&quot;watahani\&quot;})}).then(r =\u003e r.text()).then(data => console.log(data))\n//Access to fetch at \u0027http://localhost:8080/api/step3' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: Response to preflight request doesn't pass access control check: The value of the 'Access-Control-Allow-Credentials' header in the response is '' which must be 'true' when the request's credentials mode is 'include'.\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token function\&quot;>fetch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;http://localhost:8080/api/step3\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token punctuation\&quot;>{</span> <span class=\&quot;token literal-property property\&quot;>method</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;POST\&quot;</span> <span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>headers</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;Content-Type\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;application/json\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token string-property property\&quot;>\&quot;Authorization\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;xxxxx\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>credentials</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;include\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>body</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token constant\&quot;>JSON</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>stringify</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;watahani\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>r</span> <span class=\&quot;token operator\&quot;>=></span> r<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>text</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>data</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>data<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n<span class=\&quot;token comment\&quot;>//Access to fetch at 'http://localhost:8080/api/step3' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: Response to preflight request doesn't pass access control check: The value of the 'Access-Control-Allow-Credentials' header in the response is '' which must be 'true' when the request's credentials mode is 'include'.</span>\n&quot;}"><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/api/step3"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span> <span class="token punctuation">,</span> <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span> <span class="token string-property property">"Authorization"</span><span class="token operator">:</span> <span class="token string">"xxxxx"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token string">"include"</span><span class="token punctuation">,</span> <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"watahani"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//Access to fetch at 'http://localhost:8080/api/step3' from origin 'https://blog.haniyama.com' has been blocked by CORS policy: Response to preflight request doesn't pass access control check: The value of the 'Access-Control-Allow-Credentials' header in the response is '' which must be 'true' when the request's credentials mode is 'include'.</span></code></pre><p>ã¨ã„ã†ã“ã¨ã§ã€ä»¥ä¸‹ã‚’è¿½åŠ ã™ã‚‹ã€‚</p><pre class="language-diff" style="" tabindex="0"><code id="a934453e" class="language-diff" data-prism-hydrate="{&quot;element&quot;:&quot;a934453e&quot;,&quot;language&quot;:&quot;diff&quot;,&quot;code&quot;:&quot;\n        self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n        self.send_header(\&quot;Access-Control-Alltoiuow-Headers\&quot;, \&quot;Authorization, Content-Type\&quot;)\n        self.send_header(\&quot;Access-Control-Allow-Methods\&quot;, \&quot;POST, DELETE\&quot;)\n+       self.send_header(\&quot;Access-Control-Allow-Credentials\&quot;, \&quot;true\&quot;)\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token unchanged\&quot;\u003e<span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n</span><span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Alltoiuow-Headers\&quot;, \&quot;Authorization, Content-Type\&quot;)\n</span><span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Methods\&quot;, \&quot;POST, DELETE\&quot;)\n</span></span><span class=\&quot;token inserted-sign inserted\&quot;><span class=\&quot;token prefix inserted\&quot;>+</span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Credentials\&quot;, \&quot;true\&quot;)\n</span></span>&quot;}"><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Origin", "https://blog.haniyama.com")</span><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Alltoiuow-Headers", "Authorization, Content-Type")</span><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Methods", "POST, DELETE")</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">       self.send_header("Access-Control-Allow-Credentials", "true")</span></span></code></pre><pre class="language-javascript" style="" tabindex="0"><code id="c24d173f" class="language-javascript" data-prism-hydrate="{&quot;element&quot;:&quot;c24d173f&quot;,&quot;language&quot;:&quot;javascript&quot;,&quot;code&quot;:&quot;\nfetch(\&quot;http://localhost:8080/api/step4\&quot;, { method: \&quot;POST\&quot; , headers: {\&quot;Content-Type\&quot;: \&quot;application/json\&quot;, \&quot;Authorization\&quot;: \&quot;xxxxx\&quot;}, credentials: \&quot;include\&quot;, body: JSON.stringify({\&quot;name\&quot;: \&quot;watahani\&quot;})}).then(r =\u003e r.text()).then(data => console.log(data))\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token function\&quot;>fetch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;http://localhost:8080/api/step4\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token punctuation\&quot;>{</span> <span class=\&quot;token literal-property property\&quot;>method</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;POST\&quot;</span> <span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>headers</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;Content-Type\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;application/json\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token string-property property\&quot;>\&quot;Authorization\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;xxxxx\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>credentials</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;include\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>body</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token constant\&quot;>JSON</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>stringify</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;watahani\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>r</span> <span class=\&quot;token operator\&quot;>=></span> r<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>text</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>data</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>data<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n&quot;}"><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/api/step4"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span> <span class="token punctuation">,</span> <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span> <span class="token string-property property">"Authorization"</span><span class="token operator">:</span> <span class="token string">"xxxxx"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token string">"include"</span><span class="token punctuation">,</span> <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"watahani"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>CORS ã§ Cookie ä»˜ã‘ãŸã„ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã£ã¦ã„ã†ã®ãŒæ­£ç›´ã‚ˆãã‚ã‹ã£ã¦ãªã„ã®ã ã‘ã©ã€ <code>app.example.com</code> ã¨ <code>api.example.com</code> ã§ Cookie å…±æœ‰ã—ã¦ã¦é€ã‚ŠãŸã„ã¿ãŸã„ãªæ™‚ã«ä½¿ã†ã®ã‹ãªï¼Ÿã‚ã¨ã¯ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ç”¨ã¨ã‹ã€‚<br>ãŸã¶ã‚“ API å´ã® Set-Cookie ã¯ 3rd Party Cookie ã«ãªã‚‹ã®ã§æ‹’å¦ã•ã‚Œã‚‹ã¨èªè­˜ã—ã¦ã„ã‚‹ã€‚<br>(æ‰‹å…ƒã§è©¦ã—ã¦ã¿ãŸé™ã‚Š Set-Cookie ã¯ä¸€åˆ‡ãã‹ãªã„å‹•ãï¼Ÿ)</p><h2 id="CORS-Step-5-Access-Control-Expose-Headers"><a href="#CORS-Step-5-Access-Control-Expose-Headers" class="headerlink" title="CORS Step 5 (Access-Control-Expose-Headers)"></a>CORS Step 5 (Access-Control-Expose-Headers)</h2><p>ã‚ã¾ã‚Šèˆˆå‘³ãŒãªã„ã®ã§ã‚µã‚¯ãƒƒã¨ã€‚JavaScript ã‹ã‚‰è§¦ã‚Œã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æŒ‡å®šã™ã‚‹ã€‚</p><pre class="language-diff" style="" tabindex="0"><code id="07dcf43d" class="language-diff" data-prism-hydrate="{&quot;element&quot;:&quot;07dcf43d&quot;,&quot;language&quot;:&quot;diff&quot;,&quot;code&quot;:&quot;\n        self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n        self.send_header(\&quot;Access-Control-Alltoiuow-Headers\&quot;, \&quot;Authorization, Content-Type\&quot;)\n        self.send_header(\&quot;Access-Control-Allow-Methods\&quot;, \&quot;POST, DELETE\&quot;)\n        self.send_header(\&quot;Access-Control-Allow-Credentials\&quot;, \&quot;true\&quot;)\n+       self.send_header(\&quot;Access-Control-Expose-Headers\&quot;, \&quot;X-Exportable\&quot;)\n+       self.send_header(\&quot;X-Exportable\&quot;, \&quot;hogehoge\&quot;)\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token unchanged\&quot;\u003e<span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n</span><span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Alltoiuow-Headers\&quot;, \&quot;Authorization, Content-Type\&quot;)\n</span><span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Methods\&quot;, \&quot;POST, DELETE\&quot;)\n</span><span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Credentials\&quot;, \&quot;true\&quot;)\n</span></span><span class=\&quot;token inserted-sign inserted\&quot;><span class=\&quot;token prefix inserted\&quot;>+</span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Expose-Headers\&quot;, \&quot;X-Exportable\&quot;)\n</span><span class=\&quot;token prefix inserted\&quot;>+</span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;X-Exportable\&quot;, \&quot;hogehoge\&quot;)\n</span></span>&quot;}"><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Origin", "https://blog.haniyama.com")</span><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Alltoiuow-Headers", "Authorization, Content-Type")</span><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Methods", "POST, DELETE")</span><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Credentials", "true")</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">       self.send_header("Access-Control-Expose-Headers", "X-Exportable")</span><span class="token prefix inserted">+</span><span class="token line">       self.send_header("X-Exportable", "hogehoge")</span></span></code></pre><p>ã™ã‚‹ã¨ <code>X-Exportable</code> ãŒ JavaScript ã§èª­ã¿å–ã‚Šå¯èƒ½ã«ãªã‚‹ã€‚</p><pre class="language-javascript" style="" tabindex="0"><code id="7f05743f" class="language-javascript" data-prism-hydrate="{&quot;element&quot;:&quot;7f05743f&quot;,&quot;language&quot;:&quot;javascript&quot;,&quot;code&quot;:&quot;\nfetch(\&quot;http://localhost:8080/api/step5\&quot;, { method: \&quot;POST\&quot; , headers: {\&quot;Content-Type\&quot;: \&quot;application/json\&quot;, \&quot;Authorization\&quot;: \&quot;xxxxx\&quot;}, credentials: \&quot;include\&quot;, body: JSON.stringify({\&quot;name\&quot;: \&quot;watahani\&quot;})}).then(r =\u003e console.log(r.headers.get(\&quot;X-Exportable\&quot;)))\n// hogehoge\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token function\&quot;>fetch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;http://localhost:8080/api/step5\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token punctuation\&quot;>{</span> <span class=\&quot;token literal-property property\&quot;>method</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;POST\&quot;</span> <span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>headers</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;Content-Type\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;application/json\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token string-property property\&quot;>\&quot;Authorization\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;xxxxx\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>credentials</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;include\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>body</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token constant\&quot;>JSON</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>stringify</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;watahani\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>r</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>r<span class=\&quot;token punctuation\&quot;>.</span>headers<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>get</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;X-Exportable\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n<span class=\&quot;token comment\&quot;>// hogehoge</span>\n&quot;}"><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/api/step5"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span> <span class="token punctuation">,</span> <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span> <span class="token string-property property">"Authorization"</span><span class="token operator">:</span> <span class="token string">"xxxxx"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token string">"include"</span><span class="token punctuation">,</span> <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"watahani"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"X-Exportable"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// hogehoge</span></code></pre><h2 id="CORS-Step-6-Access-Control-Max-Age"><a href="#CORS-Step-6-Access-Control-Max-Age" class="headerlink" title="CORS Step 6 (Access-Control-Max-Age)"></a>CORS Step 6 (Access-Control-Max-Age)</h2><p>ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã®çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ç§’æ•°ã‚’å®šç¾©ã™ã‚‹ã€‚</p><pre class="language-diff" style="" tabindex="0"><code id="27a77c3f" class="language-diff" data-prism-hydrate="{&quot;element&quot;:&quot;27a77c3f&quot;,&quot;language&quot;:&quot;diff&quot;,&quot;code&quot;:&quot;\n        self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n        self.send_header(\&quot;Access-Control-Alltoiuow-Headers\&quot;, \&quot;Authorization, Content-Type\&quot;)\n        self.send_header(\&quot;Access-Control-Allow-Methods\&quot;, \&quot;POST, DELETE\&quot;)\n        self.send_header(\&quot;Access-Control-Allow-Credentials\&quot;, \&quot;true\&quot;)\n        self.send_header(\&quot;Access-Control-Expose-Headers\&quot;, \&quot;X-Exportable\&quot;)\n        self.send_header(\&quot;X-Exportable\&quot;, \&quot;hogehoge\&quot;)\n+       self.send_header(\&quot;Access-Control-Max-Age\&quot;, \&quot;10\&quot;)\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token unchanged\&quot;\u003e<span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Origin\&quot;, \&quot;https://blog.haniyama.com\&quot;)\n</span><span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Alltoiuow-Headers\&quot;, \&quot;Authorization, Content-Type\&quot;)\n</span><span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Methods\&quot;, \&quot;POST, DELETE\&quot;)\n</span><span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Allow-Credentials\&quot;, \&quot;true\&quot;)\n</span><span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Expose-Headers\&quot;, \&quot;X-Exportable\&quot;)\n</span><span class=\&quot;token prefix unchanged\&quot;> </span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;X-Exportable\&quot;, \&quot;hogehoge\&quot;)\n</span></span><span class=\&quot;token inserted-sign inserted\&quot;><span class=\&quot;token prefix inserted\&quot;>+</span><span class=\&quot;token line\&quot;>       self.send_header(\&quot;Access-Control-Max-Age\&quot;, \&quot;10\&quot;)\n</span></span>&quot;}"><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Origin", "https://blog.haniyama.com")</span><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Alltoiuow-Headers", "Authorization, Content-Type")</span><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Methods", "POST, DELETE")</span><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Allow-Credentials", "true")</span><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("Access-Control-Expose-Headers", "X-Exportable")</span><span class="token prefix unchanged"> </span><span class="token line">       self.send_header("X-Exportable", "hogehoge")</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">       self.send_header("Access-Control-Max-Age", "10")</span></span></code></pre><p>ç„¡ã‘ã‚Œã°æ¯å›ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãŸã‚ã® OPTIONS ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé£›ã‚“ã§ã—ã¾ã†ãŸã‚ã€é‡è¦ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã€‚ä»Šã®ä»•äº‹ã ã¨æ°—ã«ã™ã‚‹ã“ã¨ãŒãªã„ã®ã§ã•ã‚‰ã£ã¨ã€‚</p><pre class="language-javascript" style="" tabindex="0"><code id="75a1c63d" class="language-javascript" data-prism-hydrate="{&quot;element&quot;:&quot;75a1c63d&quot;,&quot;language&quot;:&quot;javascript&quot;,&quot;code&quot;:&quot;\nvar f = () =\u003e fetch(\&quot;http://localhost:8080/api/step6\&quot;, { method: \&quot;POST\&quot; , headers: {\&quot;Content-Type\&quot;: \&quot;application/json\&quot;, \&quot;Authorization\&quot;: \&quot;xxxxx\&quot;}, credentials: \&quot;include\&quot;, body: JSON.stringify({\&quot;name\&quot;: \&quot;watahani\&quot;})}).then(r => console.log(r.headers.get(\&quot;X-Exportable\&quot;)))\nvar timer = setInterval(f, 1000);\n// clearInterval(timer)\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token keyword\&quot;>var</span> <span class=\&quot;token function-variable function\&quot;>f</span> <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token operator\&quot;>=></span> <span class=\&quot;token function\&quot;>fetch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;http://localhost:8080/api/step6\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token punctuation\&quot;>{</span> <span class=\&quot;token literal-property property\&quot;>method</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;POST\&quot;</span> <span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>headers</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;Content-Type\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;application/json\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token string-property property\&quot;>\&quot;Authorization\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;xxxxx\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>credentials</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;include\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>body</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token constant\&quot;>JSON</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>stringify</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>{</span><span class=\&quot;token string-property property\&quot;>\&quot;name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;watahani\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>r</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>r<span class=\&quot;token punctuation\&quot;>.</span>headers<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>get</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;X-Exportable\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n<span class=\&quot;token keyword\&quot;>var</span> timer <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token function\&quot;>setInterval</span><span class=\&quot;token punctuation\&quot;>(</span>f<span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token number\&quot;>1000</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token comment\&quot;>// clearInterval(timer)</span>\n&quot;}"><span class="token keyword">var</span> <span class="token function-variable function">f</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/api/step6"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span> <span class="token punctuation">,</span> <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span> <span class="token string-property property">"Authorization"</span><span class="token operator">:</span> <span class="token string">"xxxxx"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token string">"include"</span><span class="token punctuation">,</span> <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"watahani"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"X-Exportable"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">var</span> timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// clearInterval(timer)</span></code></pre><p>10 ç§’é–“ã¯ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ã®ã§ã€ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé£›ã¶ã®ã¯ 10 ç§’ã«ä¸€å›ãã‚‰ã„ã«ãªã‚‹ã€‚<br>Edge ã® DevTool ã ã¨ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã™ã”ãã‚ã‹ã‚Šã‚„ã™ã„ã®ã§ãŠå‹§ã‚ã€‚</p><p><img src="/2021/04/24/cors/devtools02.png"></p><p>ã¨ã„ã†ã“ã¨ã§ã€CORS ã«ã¤ã„ã¦ä¸€é€šã‚Šæ‰‹ã‚’å‹•ã‹ã—ã¦å‹‰å¼·ã—ã¦ã¿ãŸã€‚<br>CORS ã¯ã‚ã‹ã£ãŸã‘ã©ã€ä»Šåº¦ã¯ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ Cookie ã®å‹•ããŒè‰¯ãã‚ã‹ã‚‰ã‚“ã¨ãªã£ã¦ã€1 ã‚«æœˆã»ã©æ”¾ç½®ã—ã¦ã„ãŸãŒã€ãã®è¾ºã¯ã¾ãŸåˆ†ã‹ã£ãŸã‚‰æ›¸ãè¶³ã™ã¨ã„ã†ã“ã¨ã§ã€‚</p><p>ã‚³ãƒ¼ãƒ‰ã¯ Gist ã«ä¸Šã’ã¦ãŠã„ãŸã®ã§ã‚‚ã—èˆˆå‘³ãŒã‚ã‚Œã°å‹•ã‹ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</p><script src="https://gist.github.com/watahani/6c026b6899b2897bb57e947d3b1432d5.js"></script>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘ CORS ã‚’æ”¹ã‚ã¦å‹‰å¼·ã—ãŸã‘ã©ã€ã‚„ã£ã±ã‚ŠçŸ¥è­˜ãŒã‚ã„ã¾ã„ãªéƒ¨åˆ†ãŒã‚ã‚‹ã®ã§ã€ä¸€æ—¦ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã¨ã—ã¦ã¾ã¨ã‚ã¦ãŠãã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="é›‘è¨˜" scheme="http://blog.haniyama.com/tags/%E9%9B%91%E8%A8%98/"/>
    
  </entry>
  
  <entry>
    <title>2021-01-14 ã‚ã‚‚</title>
    <link href="http://blog.haniyama.com/2021/01/14/202101/"/>
    <id>http://blog.haniyama.com/2021/01/14/202101/</id>
    <published>2021-01-14T14:02:00.000Z</published>
    <updated>2022-05-18T13:45:28.974Z</updated>
    
    <content type="html"><![CDATA[<p>æ—©ã„ã‚‚ã®ã§ 2020 å¹´ã‚‚çµ‚ã‚ã‚Šã€æ–°å¹´ãŒæ˜ã‘ã¦åŠæœˆãŒéãã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã€‚ãµã¨æ°—ã¥ã„ãŸã‚‰ã€è»¢è·ã—ã¦ã¡ã‚‡ã†ã©ä¸¸ 2 å¹´ã¨ã„ã†ã“ã¨ã«æ°—ã¥ã„ãŸã€‚</p><p>2020 å¹´ã®æŒ¯ã‚Šè¿”ã‚Šã‚‚ã§ãã¦ã„ãªã‹ã£ãŸã®ã§ã€ã“ã“ã„ã‚‰ã§ 2 å¹´ã§ã‚„ã£ãŸã“ã¨ã€ã‚„ã‚ŠãŸã‹ã£ãŸã“ã¨ã€ã§ããªã‹ã£ãŸã“ã¨ã‚’ã¾ã¨ã‚ã¦ã„ã“ã†ã¨æ€ã†ã€‚</p><p>ç‰¹ã«èª°ã®ãŸã‚ã«ãªã‚‹ã‚ã‘ã§ã‚‚ãªãã€ã„ã‚ã‚†ã‚‹ãƒãƒ©è£ã€‚ãƒãƒ©è£ã£ã¦è¨€è‘‰ã‚‚æ­»èªã«ãªã£ãŸã®ã‹å…¨ç„¶èã‹ãªã„ã£ã™ã­ã€‚</p><span id="more"></span><h2 id="2019-2020-æŒ¯ã‚Šè¿”ã‚Š"><a href="#2019-2020-æŒ¯ã‚Šè¿”ã‚Š" class="headerlink" title="2019-2020 æŒ¯ã‚Šè¿”ã‚Š"></a>2019-2020 æŒ¯ã‚Šè¿”ã‚Š</h2><p>ä¸¸ 2 å¹´ã€ã‚µãƒãƒ¼ãƒˆ ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦åƒã„ãŸã€‚Non Tech ãªå†…å®¹ã«ã¤ã„ã¦ã¯ã€æ¥­å‹™ã«ã‹ã‹ã‚ã‚‹ã®ã§æ›¸ãã¥ã‚‰ã‹ã£ãŸã‚Šçºã¾ã£ã¦ãªã‹ã£ãŸã‚Šãªã®ã§ã€ã²ã¨ã¾ãšã‚„ã£ã¦ããŸæŠ€è¡“åˆ†é‡ã«ã¤ã„ã¦ã¾ã¨ã‚ã‚‹ã€‚</p><h3 id="WebAuthn"><a href="#WebAuthn" class="headerlink" title="WebAuthn"></a>WebAuthn</h3><p>2019 å¹´ã¯ã€å‰è·ã§ã‚´ãƒªã‚´ãƒªã‚„ã£ã¦ãŸ WebAuthn é–¢é€£ã®æ´»å‹•ã‚‚ç¶šã‘ã¦ãŠã‚Šã€ã‚‚ãã‚‚ãä¼šã‚’é–‹ã„ãŸã‚ŠæŠ€è¡“åŒäººèªŒå‡ºã—ãŸã‚Šã—ã¦ã„ãŸã€‚WebAuthn ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚«ãƒãƒªãƒ¼ã¨ã‹ã«ã¤ã„ã¦ã¾ã¨ã‚ã¦ãŸã®ãŒã€<a href="https://eprint.iacr.org/2020/1004">Cryptology ePrint</a> ã«ãªã£ã¦ãŸã€‚Cryptology ePrint ã£ã¦ã„ã†ã®ãŒã‚¤ãƒã‚¤ãƒä½ç½®ã¥ã‘ãŒã‚ã‹ã£ã¦ãªã„ã‚“ã ã‘ã©ã€æš—å·åˆ†é‡ã«ãŠã‘ã‚‹ãã‚Œãªã‚Šã«æ¨©å¨ã®ã‚ã‚‹è«–æ–‡ã«ãªã£ã¦ã‚‹ã£ã¦æ„Ÿã˜ãªã‚“ã§ã™ã‹ã­ã€‚æœ€è¿‘ã¯å…¨ç„¶æ‰‹ã‚’ä»˜ã‘ã¦ãŠã‚‰ãšã€åœæ»æ°—å‘³â€¦ã€‚</p><h3 id="Azure-ã®æ©Ÿèƒ½ã¨å‘¨è¾ºæŠ€è¡“"><a href="#Azure-ã®æ©Ÿèƒ½ã¨å‘¨è¾ºæŠ€è¡“" class="headerlink" title="Azure ã®æ©Ÿèƒ½ã¨å‘¨è¾ºæŠ€è¡“"></a>Azure ã®æ©Ÿèƒ½ã¨å‘¨è¾ºæŠ€è¡“</h3><p>2019 å¹´ 1 æœˆæ™‚ç‚¹ã§ã¯ã€Azure AD ã«ã¤ã„ã¦å³ã‚‚å·¦ã‚‚ã‚ã‹ã‚‰ãªã„ã¾ã¾ã ã£ãŸãªã‚â€¦ã€‚Azure ã®æ©Ÿèƒ½ã¨ã—ã¦ãƒ¡ã‚¤ãƒ³ã§ã‚´ãƒªã‚´ãƒªã‚„ã£ã¦ãŸã®ã¯ã“ã®ã‚ãŸã‚Šã€‚</p><ul><li>æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ ãƒãƒªã‚·ãƒ¼</li><li>AD FS</li><li>Azure AD ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ—ãƒ­ã‚­ã‚·</li><li>OAuth, OIDC, ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«</li><li>MSAL (.Net&#x2F;Core&#x2F;Android&#x2F;js)</li><li>Azure AD B2C</li></ul><h4 id="æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã®å‹•ä½œ"><a href="#æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã®å‹•ä½œ" class="headerlink" title="æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã®å‹•ä½œ"></a>æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã®å‹•ä½œ</h4><p>Azure AD ã®ä¸­ã§ã‚‚ã¨ã£ã¤ãã‚„ã™ãã€æ¤œè¨¼ã‚‚ã—ã‚„ã™ã„æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ ãƒãƒªã‚·ãƒ¼ã¯ç¾è·ã®ãƒãƒ¼ãƒ ã®ä¸­ã§ã¯ã€å…¥é–€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¨ã—ã¦å­˜åœ¨ã™ã‚‹æ„ŸãŒã‚ã‚‹ã€‚</p><p>ã—ã‹ã—ã€æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ ãƒãƒªã‚·ãƒ¼ã¯ Azure AD ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãªã‹ã§ä¸­å¿ƒã¨ãªã‚‹æ©Ÿèƒ½ã®ä¸€ã¤ã§ã‚ã‚‹ãŸã‚ã€å…¥é–€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¨ã—ã¦ã‚‚ã€ã‚ˆã‚Šæ·±ã„ Azure AD ã®ç†è§£ã®ãŸã‚ã«ã‚‚ã‚ˆã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ (?) ã ã¨æ€ã†ã€‚å…·ä½“çš„ã«ã¯ã€æ¤œè¨¼ã‚’è¡Œã†ä¸­ã§ã€ãƒ†ãƒŠãƒ³ãƒˆã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã‚°ãƒ«ãƒ¼ãƒ—ã€ã‚²ã‚¹ãƒˆ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã„ã£ãŸ Azure AD ã®åŸºç¤çŸ¥è­˜ã‚’ç¿’å¾—ã—ã¦ã„ã‘ã‚‹ã€‚ã¾ãŸã€ Azure AD ã§ä¿è­·ã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ã€ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã€OAuth, OpenID Connect ã¨ã„ã£ãŸæŠ€è¡“é ˜åŸŸã¾ã§ç™ºå±•ã—ã¦å­¦ç¿’ãŒã§ãã‚‹ã—ã€èˆˆå‘³ãŒã‚ã‚Œã° Office 365 ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã¨é€£æºã—ãŸå­¦ç¿’ã‚‚å¯èƒ½ã ã¨æ€ã†ã€‚</p><p>æ³¥è‡­ã„ãƒãƒªã‚·ãƒ¼ã®æ¤œè¨¼ã‚„å‹•ä½œç¢ºèªã¯è¾›ã„ã“ã¨ã‚‚ã‚ã‚‹ãŒã€æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ ãƒãƒªã‚·ãƒ¼ã‚’æ¥µã‚ã‚‹ã«å½“ãŸã‚Šã€Azure AD ã®ã•ã¾ã–ã¾ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç†è§£ã§ãã‚‹ã€‚</p><p>ã¨ã„ã†ã“ã¨ã§ã€Azure AD å‹‰å¼·ã™ã‚‹äººã¯ãœã²æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã‹ã‚‰å‹‰å¼·ã—ã¾ã—ã‚‡ã†ï¼Ÿ</p><h4 id="AD-FS-SAML-WS-Fed-WS-Trust-ã®åŸºæœ¬ã¨ãƒ­ã‚°è§£æ"><a href="#AD-FS-SAML-WS-Fed-WS-Trust-ã®åŸºæœ¬ã¨ãƒ­ã‚°è§£æ" class="headerlink" title="AD FS, SAML, WS-Fed, WS-Trust ã®åŸºæœ¬ã¨ãƒ­ã‚°è§£æ"></a>AD FS, SAML, WS-Fed, WS-Trust ã®åŸºæœ¬ã¨ãƒ­ã‚°è§£æ</h4><p>ã“ã‚Œã¯ã‚ã¾ã‚Šèªã‚‹ã“ã¨ã¯ãªã„ãŒã€Windows ã‚µãƒ¼ãƒãƒ¼ã‚’ã‚ã¾ã‚Šè§¦ã£ãŸã“ã¨ã®ãªã‹ã£ãŸç§ã«ã¯ã€ã‚ªãƒ³ãƒ—ãƒ¬ã® Active Directory ã‚’ç«‹ã¦ã‚‹ã“ã¨ã‹ã‚‰å‹‰å¼·ã ã£ãŸã€‚ã„ã¾ã ã«ã‚ªãƒ³ãƒ—ãƒ¬ã® AD ã«ã¤ã„ã¦ã¯çŸ¥ã‚‰ãªã„ã“ã¨ã ã‚‰ã‘ã ãŒã€ã¾ã‚æœ€ä½é™ Kerberos ãªã©ã®èªè¨¼ç³»ã®åŸºæœ¬çš„ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã¤ã„ã¦ã¯ç†è§£ãŒã§ãã¦ã„ã‚‹ã¤ã‚‚ã‚Šã€‚</p><p>SAML ã«ã¤ã„ã¦ã¯ AD FS ã‚„ Azure AD ã®å‹•ä½œãƒ™ãƒ¼ã‚¹ã§ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®æ¦‚è¦ã¯ç†è§£ã—ãŸã€‚ãŸã¾ãƒ¼ã« OASIS ã®ä»•æ§˜ã‚’è¦‹ã«è¡Œãã“ã¨ãŒã‚ã£ãŸãŒã€æ¯ã‚ŒãŸæŠ€è¡“ãªã®ã§ç¾çŠ¶ã®å‹•ä½œãŒç†è§£ã§ãã‚Œã°ååˆ†ã ã‚ã†ã¨æ€ã£ã¦ã‚‹ã€‚WS-Fed, WS-Trust ã£ã¦ã®ã‚‚å…ƒæ°—ã«å‹•ã„ã¦ã‚‹ã“ã¨ã‚’çŸ¥ã£ãŸã€‚</p><p>AD FS ã«ã¤ã„ã¦ã¯åŸºç¤å‹•ä½œã‚„ã€åŸºæœ¬çš„ãªãƒ­ã‚°è§£æã«ã¤ã„ã¦ã¯å­¦ç¿’ã—ãŸãŒã€æœ€è¿‘ã‚ã‚“ã¾ã‚„ã£ã¦ãªã„ã®ã§ã»ã¨ã‚“ã©å¿˜ã‚ŒãŸã€‚</p><h4 id="Azure-AD-Application-Proxy"><a href="#Azure-AD-Application-Proxy" class="headerlink" title="Azure AD Application Proxy"></a>Azure AD Application Proxy</h4><p>æ„å¤–ã¨å„ä»‹ãªã‚„ã¤ã§ã€ãªã‚“ã‹ã„ã‚ã„ã‚è‹¦åŠ´ã—ãŸè¦šãˆãŒã‚ã‚‹ã€‚AD FS ã¨ã“ã„ã¤ã®ãƒˆãƒ©ãƒ–ãƒ« ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ãŸã‚ã«ãƒ‘ã‚±ãƒƒãƒˆè§£æã®åŸºç¤ã‚’ç¿’å¾—ã—ãŸã€‚ã‚ã¨æ„å¤–ã¨ Web æ¨™æº–ç³»ã® RFC ãªã©ã‚’è¦‹ã‚‹å¿…è¦ãŒã‚ã‚Šã€ãã®è¾ºã®æŠ€è¡“ãŒèº«ã«ã¤ã„ãŸæ°—ãŒã™ã‚‹ã€‚</p><h3 id="OAuth-OIDC-ã‚µãƒ¼ãƒ“ã‚¹-ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«"><a href="#OAuth-OIDC-ã‚µãƒ¼ãƒ“ã‚¹-ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«" class="headerlink" title="OAuth, OIDC, ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«"></a>OAuth, OIDC, ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«</h3><p>2019 å¹´ã®å¾ŒåŠã‹ã‚‰ã€2020 å¹´ã¯ã»ã¨ã‚“ã©ã“ã®è¾ºã®æŠ€è¡“é ˜åŸŸã°ã‹ã‚Šèª¿ã¹ã¦ãŸè¨˜æ†¶ãŒã‚ã‚‹ã€‚å®Ÿéš›ã®ã¨ã“ã‚ã¯ RFC ã¨ã‹ã¯æ–œã‚èª­ã¿ã—ã‹ã—ã¦ãŠã‚‰ãšã€Azure AD ã®å®Ÿè£…ã—ã‹è¦‹ã¦ã„ãªã„ã®ãŒã‚¤ãƒã‚¤ãƒãªã¨ã“ã‚ã€‚Azure AD ã®å®Ÿè£…ã«ã ã‘ã¯ã‚„ãŸã‚‰è©³ã—ããªã£ãŸã®ã§ã€<a href="https://qiita.com/watahani/items/1f3f533097b7a15d6698">Qiita</a> ã¨ã‹ãƒãƒ¼ãƒ ã®ãƒ–ãƒ­ã‚°ã«ãƒãƒãƒãƒã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã—ã¦ãŸã€‚</p><h3 id="Azure-AD-B2C"><a href="#Azure-AD-B2C" class="headerlink" title="Azure AD B2C"></a>Azure AD B2C</h3><p>ã¨ã«ã‹ãè‹¦åŠ´ã—ãŸãŠã‚‚ã²ã§ã€‚ã¨ã«ã‹ãå½“æ™‚ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå°‘ãªãã€ä½•ã‚’ã™ã‚‹ã«ã—ã¦ã‚‚ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«èãã¿ãŸã„ãªæ„Ÿã˜ã ã£ãŸã‚ˆã†ã«æ€ã†ã€‚(ç§ãŒå§‹ã‚ãŸæ™‚ã‚ˆã‚Šå‰ã¯ã‚‚ã£ã¨ç„¡ã‹ã£ãŸã‚‰ã—ã„ã®ã ãŒ)</p><p>å®Ÿã¯ Stack Overflow ã‚’ MS ã®é–‹ç™ºé™£ãŒã†ã‚ã¤ã„ã¦ã¦ã€æŠ€è¡“çš„ãªã“ã¨ã¯ Stack Overflow ã§çºã¾ã£ã¦ãŸã‚Šã™ã‚‹ã€‚ä»Šã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚å……å®Ÿã—ã¦ããŸã®ã§æœ¬å½“ã«ã†ã‚Œã—ã„ã—ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œã£ã¦ã‚‹äººã«ãƒã‚¸æ„Ÿè¬ã§ã‚ã‚‹ã€‚ã¨ã¯ã„ãˆå–ã£ã¤ãã¥ã‚‰ã„ã¨ã“ã‚ã‚‚ã‚ã‚‹ã®ã§ã€ãã®è¾ºã¯ã¾ã¨ã‚ãŸè¨˜äº‹ã‚’ãƒãƒ¼ãƒ ãƒ–ãƒ­ã‚°ã«æ›¸ã„ãŸã‚Šã—ãŸã€‚</p><p>ã‚«ã‚¹ã‚¿ãƒ  ãƒãƒªã‚·ãƒ¼ã¯ç›¸å¤‰ã‚ã‚‰ãšéå¸¸ã«é›£ã—ãã€ã¾ãŸã€å®Ÿéš›ã«è¦æœ›ãŒãªã„ã¨ä½œã£ã¦ã¿ã‚ˆã†ã¨ãªã‚‰ãªã„ã®ã§ã€æœ€è¿‘ã¯ã•ã¼ã‚Šæ°—å‘³ã€‚ãªã‚“ã‹å€‹äººå®›ã«ä»•äº‹ãã ã•ã„w</p><h4 id="MSAL-Net-x2F-Core-x2F-Android-x2F-js-x2F-Java"><a href="#MSAL-Net-x2F-Core-x2F-Android-x2F-js-x2F-Java" class="headerlink" title="MSAL (.Net&#x2F;Core&#x2F;Android&#x2F;js&#x2F;Java)"></a>MSAL (.Net&#x2F;Core&#x2F;Android&#x2F;js&#x2F;Java)</h4><p>MSAL ã¯ .Net, .Net Core, Android, msal.js (1.0&#x2F;2.0), Java ãªã‚“ã‹ã‚’å‹•ã‹ã—ãŸã€‚OIDC ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚„å„ç¨®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã©ã®ã‚ˆã†ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹ã«ã¤ã„ã¦ã¯å¤§ã¾ã‹ã«ç†è§£ã—ãŸã—ã€Android ã® Broker ã‚¢ãƒ—ãƒªã®å‹•ä½œã«ã¤ã„ã¦ã‚‚å¤§ä½“å‹•ä½œã‚’èˆã‚ã¦ã„ã‚‹ãŒã€ã“ã®ã‚ãŸã‚Šã¯æ­£ç›´å„è¨€èªã‚„ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ã¤ã„ã¦ç†è§£ã—ã¦ã„ãªã„ã¨å³ã—ã„éƒ¨åˆ†ãŒã‚ã‚Šã€ã©ã“ã¾ã§æ¥µã‚ã‚‹ã‹ã«ã¤ã„ã¦ã¯è¦æ¤œè¨ã€‚</p><h3 id="è‹±èª"><a href="#è‹±èª" class="headerlink" title="è‹±èª"></a>è‹±èª</h3><p>å¤–è³‡ç³»ä¼æ¥­ã«å…¥ã‚Œã°å¤šå°‘ã¯ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‚„ã‚ã†ã¨æ€ã£ãŸã‘ã©ã€åŠåˆ†ã¯æ­£è§£ã€‚ãƒ’ã‚¢ãƒªãƒ³ã‚°ã¯ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã‘ã©ã€ä¸€æ–¹ã§å…¨ãå–‹ã‚Œã‚“ã€‚ç¾è·ã ã¨å–‹ã‚‹æ©Ÿä¼šã‚‚å°‘ãªã„ã®ã§ã€ãã®è¾ºã¯è‡ªå·±æŠ•è³‡ã§ã‚„ã£ã¦ã„ã‹ãªã„ã¨ã¨æ€ã„ãªãŒã‚‰ã¾ã‚å¤§ã—ã¦ã§ãã¦ãªã„ã€‚å›°ã‚‰ãªã„ã¨å‹•ã‹ãªã„ã€‚</p><p>å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ (å€‹äººã®è¦³æ¸¬ç¯„å›²ã§ã¯) ã‚ˆããªã£ã¦ã„ã‚‹ã¨æ€ã†ãŒã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒå¿…è¦ãªéƒ¨åˆ†ã¯ã¾ã ã¾ã ã‚ã‚‹ã®ã§è‹±èªã§ã‚´ãƒªã‚´ãƒª PR æ›¸ã‘ã‚‹ã‚ˆã†ã«ãªã‚ŠãŸã„ã€‚ã‘ã©ã€ã¡ã‚‡ã£ã¨è‹±èªã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›¸ããƒ¬ãƒ™ãƒ«ã®è‹±èªåŠ›ãŒç„¡ã„ã®ãŒå›°ã£ã¦ã‚‹ã¨ã“ã‚ã€‚æ—¥æœ¬èªãªã‚‰ã„ã„ã‚“ã§ã™ã‘ã©ã­â€¦ã€‚<br>ã¡ã‚‡ã£ã¨è‹±èªã¨ã¯è©±ãŒãã‚Œã‚‹ãŒã€ã“ã‚Œã¯ã€Œã‚„ã‚‰ãªãã¦ã‚‚è‰¯ã„ã€ä»•äº‹ãªã‚“ã ã‘ã©ã€ãƒˆãƒ¼ã‚¿ãƒ«ãªãƒªã‚¿ãƒ¼ãƒ³ã‚’è€ƒãˆã‚‹ã¨ã€Œçµ¶å¯¾ã‚„ã£ãŸæ–¹ãŒã„ã„ã€ä»•äº‹ãªã®ã§ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç›´ã™ã“ã¨ã«ã‚ˆã‚‹ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–ãŒåƒãã‚ˆã†ã«ãªã‚Œã°ãªãƒ¼ã¨ç©ºæƒ³ã—ã¦ã‚‹ã€‚</p><h3 id="ãã®ä»–"><a href="#ãã®ä»–" class="headerlink" title="ãã®ä»–"></a>ãã®ä»–</h3><p>å€‹äººçš„ãªèˆˆå‘³ã®ç¯„å›²ã§ã€æš—å·æŠ€è¡“ã®ã™ã¹ã¦ã€ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«SSL&#x2F;TLS ã‚ãŸã‚Šã‚’èª­ã‚“ã ãŒã€å®Ÿè£…ãƒ¬ãƒ™ãƒ«ã§ç†è§£ã—ã¦ã„ãªã„ã€‚æš—å·æŠ€è¡“ã®ã™ã¹ã¦ã‚’èª­ã¿ãªãŒã‚‰ .Net ã®å‹‰å¼·ãŒã¦ã‚‰å®Ÿè£…ã—ã¦ã¿ã‚ˆã†ã‹ãªã¨æ€ã£ã¦ã„ã‚‹ã€‚ECDSA ã®å‘¨ã‚Šã‚‚ã‚‚ã†ä¸€åº¦å†å…¥é–€ã—ãŸã„ã®ã ãŒã€å…¨ç„¶å‹‰å¼·ãŒé€²ã‚“ã§ãŠã‚‰ãšã€ã¡ã‚‡ã£ã¨ç‹¬å­¦ä»¥å¤–ã®å‹‰å¼·ã—ã‚ˆã†ã¨è¼ªèª­ä¼šãªã‚“ã‹ã‚‚ã‚„ã£ã¦ãŸã‘ã©ã€ã‚ã‚“ã¾ã‚Šæ€ã„é€šã‚Šã«ã¯ãªã‚‰ãªã‹ã£ãŸã€‚DID ã¨ã‹ã‚‚ãã†ã ã‘ã©ã€å®Ÿå‹™ã§ç›´æ¥æ‰±ã‚ãªã„åˆ†é‡ã®å‹‰å¼·ãŒå…¨ç„¶é€²ã¾ãªã„ã®ãŒã¡ã‚‡ã£ã¨èª²é¡Œã€‚å¼·å¼•ã«å®Ÿå‹™ã«ã™ã‚‹æ©Ÿä¼šãŒãªã„ã‹ã¯è™è¦–çœˆã€…ã¨ç‹™ã£ã¦ã„ã‚‹ã€‚</p><p>ã‚ã¨ã€ãƒãƒ¼ãƒ ãƒ–ãƒ­ã‚°ã®ç«‹ã¡ä¸Šã’ã¨é‹ç”¨ã‚’ã—ã¦ã„ã‚‹ãŒã€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£æ´»å‹•ã£ã¦å»ºä»˜ã‘ãªã®ã§ã€ã¡ã‚‡ã£ã¨ãƒãƒ©ãƒ³ã‚¹ãŒé›£ã—ã„ã€‚</p><h2 id="2021-å¹´ã®è±Šå¯Œ"><a href="#2021-å¹´ã®è±Šå¯Œ" class="headerlink" title="2021 å¹´ã®è±Šå¯Œ"></a>2021 å¹´ã®è±Šå¯Œ</h2><p>å¨˜ãŒç”Ÿã¾ã‚ŒãŸã®ã§ãƒ¯ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ•ãƒãƒ©ãƒ³ã‚¹å¤§äº‹ã«ã„ããŸã„ã€‚</p><p>çœŸé¢ç›®ãªè©±ã‚’ã™ã‚‹ã¨ã€ã‚µãƒãƒ¼ãƒˆã®ä»•äº‹ã‚’ä¸¸ 2 å¹´çµŒé¨“ã—ãŸæ„Ÿæƒ³ã¨ã—ã¦ã‚‚ã£ã¨ãƒ—ãƒ­ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«å‹•ã‹ãªã„ã¨æ¥­å‹™éå¤šã§æ­»ã¬ã¨ã„ã†ã“ã¨ã€‚ãƒ–ãƒ­ã‚°ã§ã®ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆä»¥å¤–ã®æƒ…å ±ç™ºä¿¡ã¨ã‹å…±æœ‰ã«ã¤ã„ã¦ã€ã‚‚ã†ã¡ã£ã¨ãƒ­ã‚¸ã‚«ãƒ«ã«è€ƒãˆã¦ã„ã‹ãªã„ã¨å¨˜ã¨ã®æ™‚é–“ã‚’å–ã‚Œãªã„æ°—ãŒã—ã¦ã„ã‚‹ã®ã§ã€ãã®è¾ºã¾ã™ã¾ã™æ³¨åŠ›ã—ãŸã„ã€‚</p><p>ã—ã‹ã—ã€å­è‚²ã¦ã¯æœ¬å½“ã«å¤§å¤‰ã§ã€ä¸–ã®ä¸­ã®ãŠçˆ¶ã•ã‚“ãŠæ¯ã•ã‚“ã«ã¯é ­ãŒä¸ŠãŒã‚‰ãªã„ã€‚ãŸã¾ãŸã¾è‚²å…ä¼‘æš‡ã¨ãƒªãƒ¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ã§å¦»ã¨é•·ãéã”ã™ã“ã¨ãŒã§ãã¦ã€éå¸¸ã«ã„ã„çµŒé¨“ã«ãªã£ãŸã®ã§ãã®è¾ºã®è©±ã‚‚ã¾ã¨ã‚ã¦ãŠããŸã„ãŒã€ã¾ãŸåˆ¥ã®æ©Ÿä¼šã«ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æ—©ã„ã‚‚ã®ã§ 2020 å¹´ã‚‚çµ‚ã‚ã‚Šã€æ–°å¹´ãŒæ˜ã‘ã¦åŠæœˆãŒéãã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã€‚ãµã¨æ°—ã¥ã„ãŸã‚‰ã€è»¢è·ã—ã¦ã¡ã‚‡ã†ã©ä¸¸ 2 å¹´ã¨ã„ã†ã“ã¨ã«æ°—ã¥ã„ãŸã€‚&lt;/p&gt;
&lt;p&gt;2020 å¹´ã®æŒ¯ã‚Šè¿”ã‚Šã‚‚ã§ãã¦ã„ãªã‹ã£ãŸã®ã§ã€ã“ã“ã„ã‚‰ã§ 2 å¹´ã§ã‚„ã£ãŸã“ã¨ã€ã‚„ã‚ŠãŸã‹ã£ãŸã“ã¨ã€ã§ããªã‹ã£ãŸã“ã¨ã‚’ã¾ã¨ã‚ã¦ã„ã“ã†ã¨æ€ã†ã€‚&lt;/p&gt;
&lt;p&gt;ç‰¹ã«èª°ã®ãŸã‚ã«ãªã‚‹ã‚ã‘ã§ã‚‚ãªãã€ã„ã‚ã‚†ã‚‹ãƒãƒ©è£ã€‚ãƒãƒ©è£ã£ã¦è¨€è‘‰ã‚‚æ­»èªã«ãªã£ãŸã®ã‹å…¨ç„¶èã‹ãªã„ã£ã™ã­ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="é›‘è¨˜" scheme="http://blog.haniyama.com/tags/%E9%9B%91%E8%A8%98/"/>
    
  </entry>
  
  <entry>
    <title>OpenID Connect ã® Shared Signals and Events</title>
    <link href="http://blog.haniyama.com/2020/12/09/oidc-sse-cape-risc/"/>
    <id>http://blog.haniyama.com/2020/12/09/oidc-sse-cape-risc/</id>
    <published>2020-12-09T10:38:29.000Z</published>
    <updated>2022-05-18T13:45:29.114Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬è¨˜äº‹ã¯ <a href="https://qiita.com/advent-calendar/2020/iddance">Digital IdentityæŠ€è¡“å‹‰å¼·ä¼š #iddance Advent Calendar 2020</a> 9æ—¥ã‚ã®è¨˜äº‹ã§ã™ã€‚<br>æœ€è¿‘ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ã—ã¦å®Ÿè£…ã•ã‚ŒãŸ Azure AD ã® CAE ã¨ã„ã†æ©Ÿèƒ½ãŒã‚ã‚‹ã€‚</p><ul><li><a href="https://jpazureid.github.io/blog/azure-active-directory/moving-towards-real-time-policy-and-security-enforcement/">ãƒãƒªã‚·ãƒ¼ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãƒªã‚¢ãƒ« ã‚¿ã‚¤ãƒ ãªé©ç”¨ã«å‘ã‘ã¦ | Japan Azure Identity Support Blog</a></li></ul><h2 id="ä½•ã®ãŸã‚ã®æ©Ÿèƒ½ã‹"><a href="#ä½•ã®ãŸã‚ã®æ©Ÿèƒ½ã‹" class="headerlink" title="ä½•ã®ãŸã‚ã®æ©Ÿèƒ½ã‹"></a>ä½•ã®ãŸã‚ã®æ©Ÿèƒ½ã‹</h2><p>ã‚‚ã¨ã‚‚ã¨ Azure AD ã§ç™ºè¡Œã•ã‚Œã‚‹ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã¯å†…åŒ…å‹ãƒˆãƒ¼ã‚¯ãƒ³ã§ã€Azure AD ã®ç§˜å¯†éµã§ç½²åã•ã‚Œã¦ã„ã‚‹ã€‚ãã®ãŸã‚ RP ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæç¤ºã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã«ã¤ã„ã¦ã€Azure AD ã«é€šä¿¡ã‚’è¡Œã†ã“ã¨ãªãç½²åã¨ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’æ¤œè¨¼ã™ã‚‹ã“ã¨ã§æ­£å½“æ€§ã‚’ç¢ºèªã§ãã‚‹ã€‚ã“ã‚Œã¯é€†ã«è¨€ã†ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¸€åº¦å–å¾—ã™ã‚Œã°æœ‰åŠ¹æœŸé™åˆ‡ã‚Œ (æ—¢å®šã§ã¯ 1 æ™‚é–“) ã¾ã§ã¯ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ç¶šã‘ã‚‰ã‚Œã‚‹ã€‚</p><p>å¤šãã®å ´åˆã“ã®è¨­è¨ˆã§å•é¡Œã¨ãªã‚‹ã“ã¨ã¯å°‘ãªã„ãŒã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã§å•é¡Œã¨ãªã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚</p><span id="more"></span><ul><li><p>A. ãƒ¦ãƒ¼ã‚¶çŠ¶æ…‹ã®å¤‰åŒ–</p><ol><li>ã‚ã‚‹æ™‚ç‚¹ã§æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ã€‚</li><li>æ¬¡ã®æ™‚ç‚¹ã§ä½•ã‚‰ã‹ã®è¦å› ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç„¡åŠ¹åŒ–ã•ã‚ŒãŸãŒã€ç™ºè¡Œã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã¯ç„¡åŠ¹åŒ–ã•ã‚Œãªã„ãŸã‚ RP ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¡Œãˆã‚‹ã€‚</li></ol></li><li><p>B. æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã®åˆ¤å®š</p><ol><li>æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ (IdP å´ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡) ã§èª²ã›ã‚‰ã‚ŒãŸ IP ã‚¢ãƒ‰ãƒ¬ã‚¹åˆ¶å¾¡ã‚„ãƒ‡ãƒã‚¤ã‚¹çŠ¶æ…‹ã®åˆ¶å¾¡ã‚’çªç ´ã™ã‚‹ã€‚</li><li>ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™å†…ã§ã‚ã‚Œã°ä¸Šè¨˜æ¡ä»¶ä¸‹ä»¥å¤–ã®å ´æ‰€ã‹ã‚‰ã€RP ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã€‚ </li></ol></li></ul><blockquote><p>ãã®ä»–ã«ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¥ªå–ã•ã‚Œã‚‹ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã‚‚ã‚ã‚‹ãŒã€ãã®å ´åˆ â€œãã‚Œã©ã“ã‚ã§ã¯ãªã„â€ ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå¤šã‹ã‚ã†ãªã®ã§ç‰¹ã«è€ƒæ…®ã—ãªã„</p></blockquote><p>ä»Šã¾ã§ã¯ Azure AD ã®ä»•çµ„ã¿ä¸Šã“ã®å‹•ä½œã‚’å®Œå…¨ã«é˜²ãã“ã¨ã¯ã§ããšã€ãŸã¨ãˆ IdP å´ã§ IP åˆ¶å¾¡ã‚’ã—ã¦ã„ãŸã¨ã—ã¦ã‚‚ã€Œèªè¨¼æ¸ˆã¿ã®ãƒˆãƒ¼ã‚¯ãƒ³ã€ã‚’æ©Ÿå™¨ã”ã¨æŒã¡ã ã™ã“ã¨ã«ã‚ˆã‚‹ã€å¤–éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å®¹ã™ã‚‹ã—ã‹ãªã‹ã£ãŸã€‚</p><p><strong>ãã‚‚ãã‚‚è«–ã¨ã—ã¦ IP ãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹ã®ã¿ã«ã™ã¹ã¦ã‚’ä»»ã—ã¦ãŠã‚Šã€ç¤¾å†…ã‚¢ã‚¯ã‚»ã‚¹ãŒçµ¶å¯¾ã«å®‰å…¨ã§ã‚ã‚‹ã¨ã„ã†å¢ƒç•Œãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ãƒ™ãƒ¼ã‚¹ã¨ã—ãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’æ§‹æˆã—ã¦ã„ã‚‹ã“ã¨ãŒå•é¡Œ</strong> ã§ã‚ã‚Šãƒ‡ãƒã‚¤ã‚¹ ãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚„ AIP (Azure Identity Protection) ã«ã‚ˆã‚‹ãƒªã‚¹ã‚¯ãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ§‹æˆã™ã¹ãã§ã‚ã‚‹ã¨ã„ã†è©±ã‚‚ã‚ã‚‹ã€‚</p><p>ã¾ãŸã€çµå±€ RP ã¸ã®é€šçŸ¥ãªã©ãŒå³æ™‚ã«è¡Œã‚ã‚Œã‚‹ã‹ã¨ã„ã†ã¨æŠ€è¡“çš„ã«ã‚‚é›£ã—ã„ã—ã€<strong>å®Œå…¨ã«å³æ™‚åˆ¤å®šã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ã‹ã¨ã„ã†ã¨ãã†ã§ã¯ãªã„ã¨æ€ã‚ã‚Œã‚‹ã€‚</strong></p><p><strong>ã¨ã¯ã„ãˆãƒªã‚¹ã‚¯ã‚’åˆ¤æ–­ã™ã‚‹ææ–™/é »åº¦ãŒå¤šã„ã«è¶Šã—ãŸã“ã¨ã¯ãªãã€</strong> ç¶™ç¶šçš„ã« RP å´ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã‚’è©•ä¾¡ã—ã‚ˆã†ã€ã¨ã„ã†ã®ãŒ Continuous Access Evaluation ã¨ã„ã†æ©Ÿèƒ½ã§ã‚ã‚‹ã€‚</p><h2 id="CAE-ã®å‹•ä½œ"><a href="#CAE-ã®å‹•ä½œ" class="headerlink" title="CAE ã®å‹•ä½œ"></a>CAE ã®å‹•ä½œ</h2><p>ç¾çŠ¶ã€Azure AD ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ A, B ã®æ©Ÿèƒ½ã¯ãŠã‚ˆãä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã‚ã‚‹ã€‚</p><ul><li><a href="https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/concept-continuous-access-evaluation">Continuous access evaluation in Azure AD | Microsoft Docs</a></li></ul><h3 id="A-ãƒ¦ãƒ¼ã‚¶çŠ¶æ…‹ã®å¤‰åŒ–"><a href="#A-ãƒ¦ãƒ¼ã‚¶çŠ¶æ…‹ã®å¤‰åŒ–" class="headerlink" title="A. ãƒ¦ãƒ¼ã‚¶çŠ¶æ…‹ã®å¤‰åŒ–"></a>A. ãƒ¦ãƒ¼ã‚¶çŠ¶æ…‹ã®å¤‰åŒ–</h3><p><img src="https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/media/concept-continuous-access-evaluation/user-revocation-event-flow.png" alt=""></p><ol><li>CAE ã«å¯¾å¿œã—ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æç¤ºã—ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã‚’è©¦ã¿ã‚‹ã€‚</li><li>Azure AD ã¯ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ã‚’æ¤œè¨¼ã—ã€ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã™ã‚‹ã€‚</li><li>ç®¡ç†è€…ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã¨ã€ãã®æƒ…å ±ãŒã‚¤ãƒ™ãƒ³ãƒˆã¨ã—ã¦ RP ã«é…ä¿¡ã•ã‚Œã‚‹ã€‚</li><li>ãã®å¾Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ RP ã«æç¤ºã™ã‚‹ã€‚</li><li>RP ã¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’åŸºã«ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ã‚’æ¤œè¨¼ã—ã€ãƒªã‚¸ã‚§ã‚¯ãƒˆã™ã‚‹ã€‚</li></ol><p>ã“ã¡ã‚‰ã®ã‚±ãƒ¼ã‚¹ã§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çŠ¶æ…‹ (ç¾æ™‚ç‚¹ã§ã¯ä»¥ä¸‹) ãŒ RP ã«é…ä¿¡ã•ã‚Œã‚‹ã€‚</p><ul><li>ãƒ¦ãƒ¼ã‚¶ãƒ¼ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå‰Šé™¤ã¾ãŸã¯ç„¡åŠ¹åŒ–ã•ã‚Œã‚‹</li><li>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¤‰æ›´ã¾ãŸã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹</li><li>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® MFA ãŒæœ‰åŠ¹ã«ãªã‚‹</li><li>ç®¡ç†è€…ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã™ã¹ã¦ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ˜ç¤ºçš„ã«ç„¡åŠ¹ã«ã™ã‚‹</li><li>Azure AD Identity Protection ã«ã‚ˆã£ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ ãƒªã‚¹ã‚¯ã®ä¸Šæ˜‡ãŒæ¤œçŸ¥ã•ã‚Œã‚‹</li></ul><h3 id="B-æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã®åˆ¤å®š"><a href="#B-æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã®åˆ¤å®š" class="headerlink" title="B. æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã®åˆ¤å®š"></a>B. æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã®åˆ¤å®š</h3><p><img src="https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/media/concept-continuous-access-evaluation/user-condition-change-flow.png" alt=""></p><ol><li>CAE ã«å¯¾å¿œã—ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æç¤ºã—ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ã€‚</li><li>Azure AD ã§ã¯æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã®åˆ¤å®šã‚’è¡Œã„ã€ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œãªã‘ã‚Œã°ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã™ã‚‹ã€‚</li><li>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ã¹ãå ´æ‰€ã«ç§»å‹•ã™ã‚‹ã€‚ã“ã®éš›ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ã¯åˆ‡ã‚Œã¦ã„ãªã„ã€‚</li><li>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã§è¨±å¯ã•ã‚Œã¦ã„ãªã„å ´æ‰€ã‹ã‚‰ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ RP ã«æç¤ºã™ã‚‹ã€‚</li><li>RP ã¯ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ã‚’æ¤œè¨¼ã—ã€ã•ã‚‰ã« Azure AD ã‹ã‚‰é€šçŸ¥ã•ã‚ŒãŸæ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ ã‚¢ã‚¯ã‚»ã‚¹ã§è¨±å¯ã•ã‚Œã‚‹ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ã®é€šä¿¡ã‹ã‚’åˆ¤å®šã™ã‚‹ã€‚ã“ã®å ´åˆã€æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ã¹ãå ´æ‰€ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ãªã®ã§ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¯ãƒªã‚¸ã‚§ã‚¯ãƒˆã•ã‚Œã‚‹ã€‚</li></ol><p>ã“ã¡ã‚‰ã®ã‚±ãƒ¼ã‚¹ã§ã¯ã€æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã§å¯¾è±¡ã® RP ãŒè¨±å¯ã•ã‚Œã‚‹/ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çµ„ã¿åˆã‚ã›ãŒé…ä¿¡ã•ã‚Œã‚‹ã‚‚ã®ã¨è€ƒãˆã‚‰ã‚Œã‚‹ã€‚</p><h2 id="Shared-Signal-and-Events-Working-Group"><a href="#Shared-Signal-and-Events-Working-Group" class="headerlink" title="Shared Signal and Events Working Group"></a>Shared Signal and Events Working Group</h2><p>ãƒ–ãƒ­ã‚°ã‹ã‚‰ã¯ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ãŒ <a href="https://openid.net/wg/sse/">Shared Signal and Events Working Group</a> ã§ CAEP (Continuous Access Evaluation Protocol) ã¨ã—ã¦æ¨™æº–åŒ–ã‚’é€²ã‚ã¦ã„ã‚‹ã¨å…¬è¡¨ã•ã‚Œã¦ã„ã‚‹ã€‚</p><p>B ã¯æ˜ã‚‰ã‹ã«ç‹¬è‡ªã®ä»•æ§˜ã£ã½ã„ãŒã€æ¨™æº–åŒ–ã®ç¯„å›²ãªã®ã ã‚ã†ã‹ã€‚æ®‹å¿µãªãŒã‚‰å…¬é–‹ã•ã‚Œã¦ã„ã‚‹æƒ…å ±ã‹ã‚‰ã¯ã‚ˆãã‚ã‹ã‚‰ãªã‹ã£ãŸã€‚<br>ã¨ã„ã†ã®ã‚‚ Azure AD ã® CAE ã¯å¯¾å¿œ RP ãŒ Exchange Online ã‚„ SharePoint Online ãªã©ã® 1st Party è£½ã‚¢ãƒ—ãƒªã«é™ã‚‰ã‚Œã¦ãŠã‚Šã€IdP ã¨ RP ãŒã©ã®ã‚ˆã†ãªãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ä¼šè©±ã‚’ã—ã¦ã„ã‚‹ã‹ã«ã¤ã„ã¦ã¯ã€å¤–ã‹ã‚‰è¦‹ãˆãªã„ãŸã‚ã ã€‚</p><h3 id="RISC"><a href="#RISC" class="headerlink" title="RISC"></a>RISC</h3><p>åŒæ§˜ã®æ©Ÿèƒ½ã¨ã—ã¦ Mitigating Catastrophic Account Compromise (RISC) ã¨ã„ã†ã®ã‚‚ææ¡ˆã•ã‚Œã¦ãŠã‚Šã€å†…å®¹çš„ã«ã¯å…¨ãåŒã˜ã‚ˆã†ãªæ„Ÿã˜ã§ RP ãŒ IdP ã‹ã‚‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ Compromise ã•ã‚ŒãŸãªã©ã®æƒ…å ±ã‚’ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–ã—ã¦ã€é€šçŸ¥ã•ã‚ŒãŸæƒ…å ±ã‚’åŸºã« RP å´ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åˆ‡æ–­ã™ã‚‹ãªã©ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒè¡Œãˆã‚‹ã€‚</p><p>ã©ã†ã‚„ã‚‰ Google ã®å®Ÿè£…ãŒã™ã§ã«ã‚ã‚‹ã‚ˆã†ã§ã€<a href="https://developers.google.com/identity/protocols/risc">Cross-Account Protection</a> ã«è©³ç´°ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹ã€‚</p><p>é€šçŸ¥ã¯ jwt ã®å½¢ã§é€ä¿¡ã•ã‚Œã€ä»¥ä¸‹ã®ã‚ˆã†ã« RP ã«å¯¾ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® sub ãŒé€šçŸ¥ã•ã‚Œã‚‹ã‚ˆã†ã ã€‚</p><pre class=" language-json"><code class="language-json">&amp;#<span class="token number">123</span><span class="token punctuation">;</span>  <span class="token property">"iss"</span><span class="token operator">:</span> <span class="token string">"https://accounts.google.com/"</span><span class="token punctuation">,</span>  <span class="token property">"aud"</span><span class="token operator">:</span> <span class="token string">"123456789-abcedfgh.apps.googleusercontent.com"</span><span class="token punctuation">,</span>  <span class="token property">"iat"</span><span class="token operator">:</span> <span class="token number">1508184845</span><span class="token punctuation">,</span>  <span class="token property">"jti"</span><span class="token operator">:</span> <span class="token string">"756E69717565206964656E746966696572"</span><span class="token punctuation">,</span>  <span class="token property">"events"</span><span class="token operator">:</span> &amp;#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token property">"https://schemas.openid.net/secevent/risc/event-type/account-disabled"</span><span class="token operator">:</span> &amp;#<span class="token number">123</span><span class="token punctuation">;</span>      <span class="token property">"subject"</span><span class="token operator">:</span> &amp;#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token property">"subject_type"</span><span class="token operator">:</span> <span class="token string">"iss-sub"</span><span class="token punctuation">,</span>        <span class="token property">"iss"</span><span class="token operator">:</span> <span class="token string">"https://accounts.google.com/"</span><span class="token punctuation">,</span>        <span class="token property">"sub"</span><span class="token operator">:</span> <span class="token string">"7375626A656374"</span>      &amp;#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span>      <span class="token property">"reason"</span><span class="token operator">:</span> <span class="token string">"hijacking"</span>    &amp;#<span class="token number">125</span><span class="token punctuation">;</span>  &amp;#<span class="token number">125</span><span class="token punctuation">;</span>&amp;#<span class="token number">125</span><span class="token punctuation">;</span></code></pre><p>ãˆã€CAEP (A ã®ãƒ‘ã‚¿ãƒ¼ãƒ³) ã¨å…¨ãåŒã˜ã‚„ã‚“â€¦ ã¨ã‚‚æ€ã£ãŸãŒã€<a href="https://openid.net/2018/07/09/three-risc-implementers-drafts-approved/">RISC ã®ã»ã†ãŒãƒ‰ãƒ©ãƒ•ãƒˆã‚‚å‡ºã¦ãŠã‚Š</a> ãªã‚“ã¨ãªãé€²ã‚“ã§ã„ã‚‹ã‚ˆã†ãªæ„Ÿã˜ã€‚</p><p>events ã®ã‚¿ã‚¤ãƒ—ã‚‚<a href="https://openid.net/specs/openid-risc-event-types-1_0-ID1.htm">ãƒ‰ãƒ©ãƒ•ãƒˆ</a> ãŒå‡ºã¦ãŠã‚Šã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¤ãƒ™ãƒ³ãƒˆãŒè¦å®šã•ã‚Œã¦ã„ã‚‹ã€‚</p><ul><li>2.1. Account Credential Change Required</li><li>2.2. Account Purged</li><li>2.3. Account Disabled</li><li>2.4. Account Enabled</li><li>2.5. Identifier Changed</li><li>2.6. Identifier Recycled</li><li>2.7. Opt Out<ul><li>2.7.1. Opt In</li><li>2.7.2. Opt Out Initiated</li><li>2.7.3. Opt Out Cancelled</li><li>2.7.4. Opt Out Effective</li></ul></li><li>2.8. Recovery Activated</li><li>2.9. Recovery Information Changed</li><li>2.10. Sessions Revoked</li></ul><p>ã“ã®ã†ã¡ Google ã§ã¯ã€ä»¥ä¸‹ã® events types ã«å¯¾å¿œã—ã¦ã„ã‚‹ã‚ˆã†ã§ã‚ã£ãŸã€‚</p><ul><li>sessions-revoked</li><li>tokens-revoked</li><li>account-disabled</li><li>account-enabled</li><li>account-purged</li><li>account-credential-change-required</li><li>verification //RP ã¨ã®ç–é€šç¢ºèªç”¨?</li></ul><p>ãã‚Œãã‚Œã®ã‚¤ãƒ™ãƒ³ãƒˆã®å—ä¿¡æ™‚ã« RP ãŒã¨ã‚‹ã¹ã <a href="https://developers.google.com/identity/protocols/risc#supported_event_types">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦ã‚‚ã¾ã¨ã‚ã‚‰ã‚Œã¦ã„ã‚‹ã€‚</a></p><h3 id="RISC-ã¨-CAEP-ã®é•ã„"><a href="#RISC-ã¨-CAEP-ã®é•ã„" class="headerlink" title="RISC ã¨ CAEP ã®é•ã„"></a>RISC ã¨ CAEP ã®é•ã„</h3><p>ãƒ‰ãƒ©ãƒ•ãƒˆãªã©ã‚’çœºã‚ã¦ã¿ã‚‹ã¨ã©ã¡ã‚‰ã‹ã¨ã„ã†ã¨ RISC ã¯ id_token ã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã®çµæœç™ºè¡Œã•ã‚Œã‚‹ RP ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¸»çœ¼ã«ç½®ã„ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ã€‚<br>ä¸€æ–¹ CAEP ã¯ãƒ‰ãƒ©ãƒ•ãƒˆãªã©ã¯ãªã„ã®ã§ Microsoft ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰ã®åˆ¤æ–­ã«ãªã‚‹ãŒ RP ã®ãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ (access_token) ã‚’ä¸»çœ¼ã«ãŠã„ã¦ã„ã‚‹ã‚ˆã†ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ã€‚</p><p>ã¾ãŸã€CAEP ã¯åå‰ã®é€šã‚Šã€ç¶™ç¶šçš„ãªã‚¢ã‚¯ã‚»ã‚¹è©•ä¾¡ã§ RISC ã¯ä¾µå®³ã•ã‚ŒãŸè³‡æ ¼æƒ…å ±ã‚’åˆ©ç”¨ã—ãŸæ¨ªæ–¹å‘ã®ä¾µå®³ã®é€£é–ã®é˜»æ­¢ã‚’ä¸»ç›®çš„ã¨ã—ã¦ã„ã‚‹ã‚ˆã†ã ã€‚<br>ç›®çš„ãŒé•ã†ã®ã¯ãã®é€šã‚Šãªã®ã ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç„¡åŠ¹åŒ–ã€ãƒˆãƒ¼ã‚¯ãƒ³ã®ç ´æ£„ã€ãƒªã‚¹ã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãªã©ã¯ã€CAEP ã¨ RISC ã©ã¡ã‚‰ã‚‚å…±é€šã®ã‚ˆã†ãªæ°—ãŒã—ã¦ãŠã‚Šãªã‚“ã§åˆ†ã‹ã‚Œã¦ã„ã‚‹ã®ã‹ã¯ã‚¤ãƒã‚¤ãƒç†è§£ã§ããªã‹ã£ãŸã€‚</p><p>B ã®æ©Ÿèƒ½ã‚‚ CAEP ã«å«ã‚€ã®ã§ã‚ã‚Œã°ãšã„ã¶ã‚“è©±ãŒå¤‰ã‚ã£ã¦ãã‚‹ãŒã€å…¬é–‹ã•ã‚Œã¦ã„ã‚‹æƒ…å ±ã‹ã‚‰ã¯ CAEP ã®æ¨™æº–åŒ–æ´»å‹•ã«ã¤ã„ã¦ã¯è¿½ã†ã“ã¨ãŒã§ããšã€å¼•ãç¶šãã‚¦ã‚©ãƒƒãƒã—ã¦ã„ããŸã„ã€‚ã“ã®ã‚ãŸã‚Šè©³ã—ã„äººã„ãŸã‚‰ Twitter ã§æ•™ãˆã¦ãã ã•ã„ã€‚</p><p>ç´°ã‹ã„å‹•ä½œã¯ãã®ã†ã¡è©¦ã—ãŸã‚‰ã¾ãŸã¾ã¨ã‚ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ¬è¨˜äº‹ã¯ &lt;a href=&quot;https://qiita.com/advent-calendar/2020/iddance&quot;&gt;Digital IdentityæŠ€è¡“å‹‰å¼·ä¼š #iddance Advent Calendar 2020&lt;/a&gt; 9æ—¥ã‚ã®è¨˜äº‹ã§ã™ã€‚&lt;br&gt;æœ€è¿‘ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ã—ã¦å®Ÿè£…ã•ã‚ŒãŸ Azure AD ã® CAE ã¨ã„ã†æ©Ÿèƒ½ãŒã‚ã‚‹ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://jpazureid.github.io/blog/azure-active-directory/moving-towards-real-time-policy-and-security-enforcement/&quot;&gt;ãƒãƒªã‚·ãƒ¼ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãƒªã‚¢ãƒ« ã‚¿ã‚¤ãƒ ãªé©ç”¨ã«å‘ã‘ã¦ | Japan Azure Identity Support Blog&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;ä½•ã®ãŸã‚ã®æ©Ÿèƒ½ã‹&quot;&gt;&lt;a href=&quot;#ä½•ã®ãŸã‚ã®æ©Ÿèƒ½ã‹&quot; class=&quot;headerlink&quot; title=&quot;ä½•ã®ãŸã‚ã®æ©Ÿèƒ½ã‹&quot;&gt;&lt;/a&gt;ä½•ã®ãŸã‚ã®æ©Ÿèƒ½ã‹&lt;/h2&gt;&lt;p&gt;ã‚‚ã¨ã‚‚ã¨ Azure AD ã§ç™ºè¡Œã•ã‚Œã‚‹ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã¯å†…åŒ…å‹ãƒˆãƒ¼ã‚¯ãƒ³ã§ã€Azure AD ã®ç§˜å¯†éµã§ç½²åã•ã‚Œã¦ã„ã‚‹ã€‚ãã®ãŸã‚ RP ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæç¤ºã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã«ã¤ã„ã¦ã€Azure AD ã«é€šä¿¡ã‚’è¡Œã†ã“ã¨ãªãç½²åã¨ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’æ¤œè¨¼ã™ã‚‹ã“ã¨ã§æ­£å½“æ€§ã‚’ç¢ºèªã§ãã‚‹ã€‚ã“ã‚Œã¯é€†ã«è¨€ã†ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¸€åº¦å–å¾—ã™ã‚Œã°æœ‰åŠ¹æœŸé™åˆ‡ã‚Œ (æ—¢å®šã§ã¯ 1 æ™‚é–“) ã¾ã§ã¯ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ç¶šã‘ã‚‰ã‚Œã‚‹ã€‚&lt;/p&gt;
&lt;p&gt;å¤šãã®å ´åˆã“ã®è¨­è¨ˆã§å•é¡Œã¨ãªã‚‹ã“ã¨ã¯å°‘ãªã„ãŒã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã§å•é¡Œã¨ãªã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="OAuth" scheme="http://blog.haniyama.com/tags/OAuth/"/>
    
      <category term="OpenID Connect" scheme="http://blog.haniyama.com/tags/OpenID-Connect/"/>
    
  </entry>
  
  <entry>
    <title>YubiKey 5 ã‚·ãƒªãƒ¼ã‚ºã§ Azure AD ã®ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®è¨¼æ˜æ›¸èªè¨¼ã™ã‚‹</title>
    <link href="http://blog.haniyama.com/2020/10/17/serviceprincipal-certauth-using-yubikey5/"/>
    <id>http://blog.haniyama.com/2020/10/17/serviceprincipal-certauth-using-yubikey5/</id>
    <published>2020-10-17T12:40:24.000Z</published>
    <updated>2022-05-18T13:45:29.116Z</updated>
    
    <content type="html"><![CDATA[<p>YubiKey 5 ã‚·ãƒªãƒ¼ã‚ºã§ Azure AD ã®ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®è¨¼æ˜æ›¸èªè¨¼ã‚’è©¦ã—ãŸã®ã§ãƒ¡ãƒ¢ã€‚</p><span id="more"></span><h2 id="å…ƒãƒã‚¿"><a href="#å…ƒãƒã‚¿" class="headerlink" title="å…ƒãƒã‚¿"></a>å…ƒãƒã‚¿</h2><p>åœŸæ›œã®æ˜¼ã«ãŠããŸã‚‰ EMS å‹‰å¼·ä¼šãªã‚‹ã‚‚ã® TL ã§ç››ã‚Šä¸ŠãŒã£ã¦ã„ã‚‹ã®ã§è¦‹ã¦ã„ãŸã‚‰ã€æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã§ç®¡ç†è€…ãŒãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã•ã‚Œã¦å›°ã£ãŸã¨ã„ã†è©±ãŒã‚ã‚Šã€ã“ã†ã„ã†ã®ã‚ã‚Œã°ã„ã„ãªãƒ¼ã¨æ€ã£ãŸã®ã§ä½œã£ã¦ã¿ã‚‹ã€‚</p><blockquote class="twitter-tweet"><p lang="ja" dir="ltr">æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ Microsoft Graph API ã§å©ã‘ã‚‹ã‚ˆã†ã«ãªã£ãŸã—ã€ç·Šæ€¥è§£é™¤ãƒœã‚¿ãƒ³ã¨ã‹ä½œã‚‹ã®æ¥½ã—ãã†ã€‚<a href="https://twitter.com/hashtag/jpemsug?src=hash&amp;ref_src=twsrc%5Etfw">#jpemsug</a> <a href="https://t.co/WvVDsaLkLu">pic.twitter.com/WvVDsaLkLu</a></p>&mdash; 82@ã¯ã« (@watahani) <a href="https://twitter.com/watahani/status/1317353605867790336?ref_src=twsrc%5Etfw">October 17, 2020</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>ç·Šæ€¥è§£é™¤ãƒœã‚¿ãƒ³ã‚’ä½œã‚‹ã€‚</p><p><img src="/2020/10/17/serviceprincipal-certauth-using-yubikey5/pose_button_osu.png" alt="ã„ã‚‰ã™ã¨ã‚„"></p><h2 id="å•é¡Œç‚¹"><a href="#å•é¡Œç‚¹" class="headerlink" title="å•é¡Œç‚¹"></a>å•é¡Œç‚¹</h2><p>Microsoft Graph API ã§ <a href="https://docs.microsoft.com/ja-jp/graph/api/resources/conditionalaccesspolicy?view=graph-rest-1.0">æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ãŒæ“ä½œ</a> ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã€ ç·Šæ€¥è§£é™¤ãƒœã‚¿ãƒ³ã‚’ä½œã‚‹ã“ã¨è‡ªä½“ã¯ç°¡å˜ãªã®ã§ã™ãŒèª°ã§ã‚‚æŠ¼ã›ã¦ã—ã¾ã†ã¨å›°ã‚Šã¾ã™ã­ã€‚</p><p>ã†ãƒ¼ã‚“ã€è³‡æ ¼æƒ…å ±ã‚’å®‰å…¨ã«ä¿ç®¡ã§ãã‚‹ç´ æ•µãªãƒ‡ãƒã‚¤ã‚¹ã¯ãªã„ã‹ãªãï½ï¼Ÿ</p><p>è¨¼æ˜æ›¸ã‚’ä¿å­˜ã§ãã¦ã€æ‰‹ã”ã‚ã§ä¸ˆå¤«ãªãƒ‡ãƒã‚¤ã‚¹ç„¡ã„ã‹ãªï½ï¼Ÿ<br>.<br>.<br>.<br>.</p><p>ã¯ã„ã€ã‚ã‚Šã¾ã—ãŸã€‚</p><iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=82p-22&language=ja_JP&o=9&p=8&l=as4&m=amazon&f=ifr&ref=as_ss_li_til&asins=B07HBD71HL&linkId=f2bf005f94ac048773128cc9c094d7fb"></iframe><blockquote><p>å®£ä¼ã—ãŸã®ã§æŒ‡ç´‹èªè¨¼ã®ã§ãã‚‹ YubiKey ãã ã•ã„ğŸ¤¤ğŸ¤¤</p></blockquote><h2 id="YubiKey-ã«ä¿å­˜ã—ãŸè¨¼æ˜æ›¸ã§ã€è¨¼æ˜æ›¸èªè¨¼ãŒã—ãŸã„"><a href="#YubiKey-ã«ä¿å­˜ã—ãŸè¨¼æ˜æ›¸ã§ã€è¨¼æ˜æ›¸èªè¨¼ãŒã—ãŸã„" class="headerlink" title="YubiKey ã«ä¿å­˜ã—ãŸè¨¼æ˜æ›¸ã§ã€è¨¼æ˜æ›¸èªè¨¼ãŒã—ãŸã„"></a>YubiKey ã«ä¿å­˜ã—ãŸè¨¼æ˜æ›¸ã§ã€è¨¼æ˜æ›¸èªè¨¼ãŒã—ãŸã„</h2><p>YubiKey4, YubiKey5 ã‚·ãƒªãƒ¼ã‚ºã¯ã€Windows ä¸Šã§ã‚¹ãƒãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ã¨ã—ã¦åƒãã€‚Windows 10 ã®å ´åˆã€minidriver ã‚‚åˆã‚ã‹ã‚‰å…¥ã£ã¦ã„ã‚‹ã®ã§ã€Service Principal ã®èªè¨¼ã‚‚ã§ãã‚‹ã‚“ã˜ã‚ƒãªã„ï¼Ÿã¨æ€ã£ã¦ã‚„ã£ã¦ã¿ãŸã‚‰ç°¡å˜ã«ã§ããŸã®ã§ã€ãƒ¡ãƒ¢ã€‚</p><h2 id="Azure-AD-ã«æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹è§£é™¤ç”¨ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«-ã‚¢ãƒ—ãƒª-ã‚’ä½œã‚‹"><a href="#Azure-AD-ã«æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹è§£é™¤ç”¨ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«-ã‚¢ãƒ—ãƒª-ã‚’ä½œã‚‹" class="headerlink" title="Azure AD ã«æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹è§£é™¤ç”¨ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ« (ã‚¢ãƒ—ãƒª) ã‚’ä½œã‚‹"></a>Azure AD ã«æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹è§£é™¤ç”¨ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ« (ã‚¢ãƒ—ãƒª) ã‚’ä½œã‚‹</h2><p>ã¾ãšã¯ã€æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹è§£é™¤ç”¨ã®ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã‚’ä½œã‚‹ã€‚ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã«ã¤ã„ã¦ã¯<a href="https://qiita.com/watahani/items/1f3f533097b7a15d6698">ä»¥å‰ Qiita ã§æ›¸ã„ãŸã®ã§</a>ã•ã£ãã‚Šã¨ã€‚</p><h3 id="ã‚¢ãƒ—ãƒªã®ä½œæˆ"><a href="#ã‚¢ãƒ—ãƒªã®ä½œæˆ" class="headerlink" title="ã‚¢ãƒ—ãƒªã®ä½œæˆ"></a>ã‚¢ãƒ—ãƒªã®ä½œæˆ</h3><p><code>Azure Active Directory</code> &gt; <code>ã‚¢ãƒ—ãƒªã®ç™»éŒ²</code> &gt; <code>æ–°ã—ã„ã‚¢ãƒ—ãƒª</code></p><p><img src="/2020/10/17/serviceprincipal-certauth-using-yubikey5/newapp.png"></p><p>å…¨ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç™»éŒ²ã€‚</p><h3 id="API-ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯"><a href="#API-ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯" class="headerlink" title="API ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯"></a>API ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯</h3><p>ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã§æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã‚’æ“ä½œã™ã‚‹ã«ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ¨©é™ã® <code>Policy.Read.All</code>, <code>Policy.ReadWrite.ConditionalAccess</code>, <code>Application.Read.All</code> ãŒå¿…è¦ã€‚</p><p><code>ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã®è¿½åŠ </code> ã‹ã‚‰ Microsoft Graph API ã‚’é¸ã³ã€ã€Œã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ¨©é™ã€ã§ã€ä¸Šè¨˜ 3 ã¤ã®æ¨©é™ã‚’è¿½åŠ ã™ã‚‹ã€‚ãã®å¾Œã€ã€Œ&lt;ãƒ†ãƒŠãƒ³ãƒˆå&gt;ã«ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’è¿½åŠ ã—ã¾ã™ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€Admin Consent ã‚’å®Ÿæ–½ã™ã‚‹ã€‚</p><p><img src="/2020/10/17/serviceprincipal-certauth-using-yubikey5/api-permissions.png"></p><h2 id="YubiKey-ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"><a href="#YubiKey-ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—" class="headerlink" title="YubiKey ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"></a>YubiKey ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h2><p>ãã®å¾Œã€ãŠã‚‚ã‚€ã‚ã« YubiKey 5 ã‚’ PC ã«åˆºã—ã¦ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã€‚</p><pre class="language-powershell" style="" tabindex="0"><code id="3a92693f" class="language-powershell" data-prism-hydrate="{&quot;element&quot;:&quot;3a92693f&quot;,&quot;language&quot;:&quot;powershell&quot;,&quot;code&quot;:&quot;\n$currentDate = Get-Date\n$notAfter  = $currentDate.AddYears(10)\n$selfCert = New-SelfSignedCertificate -CertStoreLocation cert:\\CurrentUser\\my -Subject \&quot;CN=d22351ce-beb5-4e41-8346-3a7d99db934,OU=ConditionalAccessUnlocker\&quot;  -Provider \&quot;Microsoft Base Smart Card Crypto Provider\&quot; -KeySpec Signature -NotAfter $notAfter\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token variable\&quot;\u003e$currentDate</span> = <span class=\&quot;token function\&quot;>Get-Date</span>\n<span class=\&quot;token variable\&quot;>$notAfter</span>  = <span class=\&quot;token variable\&quot;>$currentDate</span><span class=\&quot;token punctuation\&quot;>.</span>AddYears<span class=\&quot;token punctuation\&quot;>(</span>10<span class=\&quot;token punctuation\&quot;>)</span>\n<span class=\&quot;token variable\&quot;>$selfCert</span> = <span class=\&quot;token function\&quot;>New-SelfSignedCertificate</span> <span class=\&quot;token operator\&quot;>-</span>CertStoreLocation cert:\\CurrentUser\\my <span class=\&quot;token operator\&quot;>-</span>Subject <span class=\&quot;token string\&quot;>\&quot;CN=d22351ce-beb5-4e41-8346-3a7d99db934,OU=ConditionalAccessUnlocker\&quot;</span>  <span class=\&quot;token operator\&quot;>-</span>Provider <span class=\&quot;token string\&quot;>\&quot;Microsoft Base Smart Card Crypto Provider\&quot;</span> <span class=\&quot;token operator\&quot;>-</span>KeySpec Signature <span class=\&quot;token operator\&quot;>-</span>NotAfter <span class=\&quot;token variable\&quot;>$notAfter</span>\n&quot;}"><span class="token variable">$currentDate</span> = <span class="token function">Get-Date</span><span class="token variable">$notAfter</span>  = <span class="token variable">$currentDate</span><span class="token punctuation">.</span>AddYears<span class="token punctuation">(</span>10<span class="token punctuation">)</span><span class="token variable">$selfCert</span> = <span class="token function">New-SelfSignedCertificate</span> <span class="token operator">-</span>CertStoreLocation cert:\CurrentUser\my <span class="token operator">-</span>Subject <span class="token string">"CN=d22351ce-beb5-4e41-8346-3a7d99db934,OU=ConditionalAccessUnlocker"</span>  <span class="token operator">-</span>Provider <span class="token string">"Microsoft Base Smart Card Crypto Provider"</span> <span class="token operator">-</span>KeySpec Signature <span class="token operator">-</span>NotAfter <span class="token variable">$notAfter</span></code></pre><p><img src="/2020/10/17/serviceprincipal-certauth-using-yubikey5/new-selfsigncertificate.png" alt="PIN"></p><blockquote><p>è¨¼æ˜æ›¸ã®ä½œæ³•ã¯ã‚ã¾ã‚Šåˆ†ã‹ã‚‰ãªã„ã‘ã©ã€AppId ã‚’ Subject ã«å…¥ã‚Œã¨ã‘ã°ä¾¿åˆ©ãã†ã€‚<br>ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã¯ãƒ†ã‚¹ãƒˆä¸­ã®ãªã®ã§ã€DNS ã§è¨­å®šã—ã¦ã‚‹ã€‚</p></blockquote><p>PIN ã‚’è¦æ±‚ã•ã‚Œã‚‹ã®ã§ã€YubiKey 5 ã® PIN ã‚’å…¥ã‚Œã‚‹ã€‚Azure AD ãªã©ã§ FIDO2 ã§ä½¿ã£ã¦ã„ã‚‹å ´åˆã¯å…±é€šãªã®ã§ã€ãã‚Œã‚’å…¥ã‚Œã‚‹ã€‚åˆã‚ã¦ä½¿ã†å ´åˆã¯å¥½ããª PIN ã‚’å…¥ã‚Œã‚‹ã€‚</p><p>ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã§ YubiKey ä¸Šã«è‡ªå·±è¨¼æ˜æ›¸ãŒä¿å­˜ã•ã‚Œã‚‹ã€‚YubiKey Manager ã§è¦‹ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã§ 9a ã‚¹ãƒ­ãƒƒãƒˆã«è¨¼æ˜æ›¸ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã®ãŒåˆ†ã‹ã‚‹ã€‚</p><p><img src="/2020/10/17/serviceprincipal-certauth-using-yubikey5/yubikey-manager.png"></p><p><code>certutil</code> ã§ã‚‚ç¢ºèªã§ãã‚‹ã€‚</p><pre class="language-powershell" style="" tabindex="0"><code id="f947843e" class="language-powershell" data-prism-hydrate="{&quot;element&quot;:&quot;f947843e&quot;,&quot;language&quot;:&quot;powershell&quot;,&quot;code&quot;:&quot;\ncertutil -scinfo\n&quot;,&quot;highlightedCode&quot;:&quot;\ncertutil \u003cspan class=\&quot;token operator\&quot;\u003e-</span>scinfo\n&quot;}">certutil <span class="token operator">-</span>scinfo</code></pre><p>å‰Šé™¤ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚‚ãƒ¡ãƒ¢ã£ã¦ãŠãã€‚</p><pre class="language-powershell" style="" tabindex="0"><code id="4af8693f" class="language-powershell" data-prism-hydrate="{&quot;element&quot;:&quot;4af8693f&quot;,&quot;language&quot;:&quot;powershell&quot;,&quot;code&quot;:&quot;\n certutil -delkey -csp \&quot;Microsoft Base Smart Card Crypto Provider\&quot; \&quot;te-4d4c1e9d-2c00-4995-9396-4014ef5a281d\&quot; #ã‚­ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠåã¯ -scinfo ã§å‡ºã¦ããŸã‚„ã¤\n&quot;,&quot;highlightedCode&quot;:&quot;\n certutil \u003cspan class=\&quot;token operator\&quot;\u003e-</span>delkey <span class=\&quot;token operator\&quot;>-</span>csp <span class=\&quot;token string\&quot;>\&quot;Microsoft Base Smart Card Crypto Provider\&quot;</span> <span class=\&quot;token string\&quot;>\&quot;te-4d4c1e9d-2c00-4995-9396-4014ef5a281d\&quot;</span> <span class=\&quot;token comment\&quot;>#ã‚­ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠåã¯ -scinfo ã§å‡ºã¦ããŸã‚„ã¤</span>\n&quot;}"> certutil <span class="token operator">-</span>delkey <span class="token operator">-</span>csp <span class="token string">"Microsoft Base Smart Card Crypto Provider"</span> <span class="token string">"te-4d4c1e9d-2c00-4995-9396-4014ef5a281d"</span> <span class="token comment">#ã‚­ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠåã¯ -scinfo ã§å‡ºã¦ããŸã‚„ã¤</span></code></pre><p>ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§è¨¼æ˜æ›¸ã‚’å‡ºåŠ›ã™ã‚‹ã€‚</p><pre class="language-powershell" style="" tabindex="0"><code id="87b04a3f" class="language-powershell" data-prism-hydrate="{&quot;element&quot;:&quot;87b04a3f&quot;,&quot;language&quot;:&quot;powershell&quot;,&quot;code&quot;:&quot;\n$cerfile = \&quot;.\\ConditionalAccessUnlocker.cer\&quot;\nExport-Certificate -Cert $cert -FilePath $cerfile\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token variable\&quot;\u003e$cerfile</span> = <span class=\&quot;token string\&quot;>\&quot;.\\ConditionalAccessUnlocker.cer\&quot;</span>\n<span class=\&quot;token function\&quot;>Export-Certificate</span> <span class=\&quot;token operator\&quot;>-</span>Cert <span class=\&quot;token variable\&quot;>$cert</span> <span class=\&quot;token operator\&quot;>-</span>FilePath <span class=\&quot;token variable\&quot;>$cerfile</span>\n&quot;}"><span class="token variable">$cerfile</span> = <span class="token string">".\ConditionalAccessUnlocker.cer"</span><span class="token function">Export-Certificate</span> <span class="token operator">-</span>Cert <span class="token variable">$cert</span> <span class="token operator">-</span>FilePath <span class="token variable">$cerfile</span></code></pre><blockquote><p>Note:<br> ã“ã®è¾ºå‹•ã‹ãªã„ã¨ãã¯ã€ã‚‚ã—ã‹ã™ã‚‹ã¨ã“ã®è¾ºã®ãƒ¬ã‚¸ã‚¹ãƒˆãƒªãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚<br><a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/ff404287(v=ws.10)">https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/ff404287(v=ws.10)</a></p></blockquote><h3 id="è¨¼æ˜æ›¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"><a href="#è¨¼æ˜æ›¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰" class="headerlink" title="è¨¼æ˜æ›¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"></a>è¨¼æ˜æ›¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3><p>Azure ãƒãƒ¼ã‚¿ãƒ«ã«æˆ»ã£ã¦ã€ä½œã£ãŸã‚¢ãƒ—ãƒªã® <code>è¨¼æ˜æ›¸ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ</code> ã‚’é¸æŠã—ã€å…ˆã»ã©ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸè¨¼æ˜æ›¸ã€ <code>ConditionalAccessUnlocker.cer</code> ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã€‚</p><p><img src="/2020/10/17/serviceprincipal-certauth-using-yubikey5/cert.png"></p><h2 id="Azure-AD-PowerShell-Module-ã§æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã‚’æ“ä½œ"><a href="#Azure-AD-PowerShell-Module-ã§æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã‚’æ“ä½œ" class="headerlink" title="Azure AD PowerShell Module ã§æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã‚’æ“ä½œ"></a>Azure AD PowerShell Module ã§æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã‚’æ“ä½œ</h2><h3 id="PowerShell-Module-ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"><a href="#PowerShell-Module-ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«" class="headerlink" title="PowerShell Module ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"></a>PowerShell Module ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</h3><p>Azure AD PowerShell Module v2 ã® Version <code>2.0.2.106</code> ä»¥ä¸Šã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚</p><pre class="language-powershell" style="" tabindex="0"><code id="d685373f" class="language-powershell" data-prism-hydrate="{&quot;element&quot;:&quot;d685373f&quot;,&quot;language&quot;:&quot;powershell&quot;,&quot;code&quot;:&quot;\nInstall-Module -Name AzureAD -Force\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token function\&quot;\u003eInstall-Module</span> <span class=\&quot;token operator\&quot;>-</span>Name AzureAD <span class=\&quot;token operator\&quot;>-</span>Force\n&quot;}"><span class="token function">Install-Module</span> <span class="token operator">-</span>Name AzureAD <span class="token operator">-</span>Force</code></pre><h3 id="ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹-ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®æ¨©é™ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³"><a href="#ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹-ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®æ¨©é™ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³" class="headerlink" title="ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®æ¨©é™ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³"></a>ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®æ¨©é™ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³</h3><p>ã•ã£ãä½œæˆã—ãŸè¨¼æ˜æ›¸ã‚’èª­ã¿è¾¼ã‚“ã§ã€ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®æ¨©é™ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã™ã‚‹ã€‚</p><pre class="language-powershell" style="" tabindex="0"><code id="0a3f213f" class="language-powershell" data-prism-hydrate="{&quot;element&quot;:&quot;0a3f213f&quot;,&quot;language&quot;:&quot;powershell&quot;,&quot;code&quot;:&quot;\n$cert = Get-ChildItem Cert:\\CurrentUser\\My\\ | ?{ $_.Subject -like \&quot;*OU=ConditionalAccessUnlocker*\&quot;} ; $cert\n$appId = $cert.Subject.Split(\&quot;,\&quot;)[0].Split(\&quot;=\&quot;)[1]\n\nConnect-AzureAD -TenantId $tenantId -ApplicationId $appId -CertificateThumbprint $cert.Thumbprint\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token variable\&quot;\u003e$cert</span> = <span class=\&quot;token function\&quot;>Get-ChildItem</span> Cert:\\CurrentUser\\My\\ <span class=\&quot;token punctuation\&quot;>|</span> ?<span class=\&quot;token punctuation\&quot;>{</span> <span class=\&quot;token variable\&quot;>$_</span><span class=\&quot;token punctuation\&quot;>.</span>Subject <span class=\&quot;token operator\&quot;>-like</span> <span class=\&quot;token string\&quot;>\&quot;*OU=ConditionalAccessUnlocker*\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span> <span class=\&quot;token punctuation\&quot;>;</span> <span class=\&quot;token variable\&quot;>$cert</span>\n<span class=\&quot;token variable\&quot;>$appId</span> = <span class=\&quot;token variable\&quot;>$cert</span><span class=\&quot;token punctuation\&quot;>.</span>Subject<span class=\&quot;token punctuation\&quot;>.</span>Split<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;,\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>[</span>0<span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>.</span>Split<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;=\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>[</span>1<span class=\&quot;token punctuation\&quot;>]</span>\n\n<span class=\&quot;token function\&quot;>Connect-AzureAD</span> <span class=\&quot;token operator\&quot;>-</span>TenantId <span class=\&quot;token variable\&quot;>$tenantId</span> <span class=\&quot;token operator\&quot;>-</span>ApplicationId <span class=\&quot;token variable\&quot;>$appId</span> <span class=\&quot;token operator\&quot;>-</span>CertificateThumbprint <span class=\&quot;token variable\&quot;>$cert</span><span class=\&quot;token punctuation\&quot;>.</span>Thumbprint\n&quot;}"><span class="token variable">$cert</span> = <span class="token function">Get-ChildItem</span> Cert:\CurrentUser\My\ <span class="token punctuation">|</span> ?<span class="token punctuation">{</span> <span class="token variable">$_</span><span class="token punctuation">.</span>Subject <span class="token operator">-like</span> <span class="token string">"*OU=ConditionalAccessUnlocker*"</span><span class="token punctuation">}</span> <span class="token punctuation">;</span> <span class="token variable">$cert</span><span class="token variable">$appId</span> = <span class="token variable">$cert</span><span class="token punctuation">.</span>Subject<span class="token punctuation">.</span>Split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">[</span>0<span class="token punctuation">]</span><span class="token punctuation">.</span>Split<span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">)</span><span class="token punctuation">[</span>1<span class="token punctuation">]</span><span class="token function">Connect-AzureAD</span> <span class="token operator">-</span>TenantId <span class="token variable">$tenantId</span> <span class="token operator">-</span>ApplicationId <span class="token variable">$appId</span> <span class="token operator">-</span>CertificateThumbprint <span class="token variable">$cert</span><span class="token punctuation">.</span>Thumbprint</code></pre><p><img src="/2020/10/17/serviceprincipal-certauth-using-yubikey5/connect-azuread.png"></p><p>PIN ã‚’èã‹ã‚Œã‚‹ã®ã§ã€YubiKey ã® PIN ã‚’å…¥åŠ›ã™ã‚‹ã€‚</p><p><img src="/2020/10/17/serviceprincipal-certauth-using-yubikey5/get-policy.png"></p><p>ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã§ãã‚‹ã®ã§ã€å¾Œã¯ãƒãƒªã‚·ãƒ¼ã‚’æ“ä½œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’ãƒãƒãƒãƒå©ã„ã¦è§£é™¤ã™ã‚Œã°â€¦</p><p><img src="/2020/10/17/serviceprincipal-certauth-using-yubikey5/disable-policy.png"></p><p><strong>ã‚ã‚Œâ€¦ ã†ã¾ãå‹•ã‹ãªã„â€¦ã€‚</strong> ğŸ˜…</p><h2 id="ã¾ã¨ã‚"><a href="#ã¾ã¨ã‚" class="headerlink" title="ã¾ã¨ã‚"></a>ã¾ã¨ã‚</h2><p><del>å‰Šé™¤ã¯ä¸Šæ‰‹ãå‹•ã„ãŸã®ã§ã€ç·Šæ€¥æ™‚ã¯ Remove-AzureADMSConditionalAccessPolicy ã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã‚‹ãƒãƒªã‚·ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹ãªã‚Šã—ã¦ãã ã•ã„ã€‚</del></p><p>ã„ã¤ã®é–“ã«ã‹æ²»ã£ã¦ã¾ã—ãŸã€‚</p><pre class="language-powershell" style="" tabindex="0"><code id="6776693f" class="language-powershell" data-prism-hydrate="{&quot;element&quot;:&quot;6776693f&quot;,&quot;language&quot;:&quot;powershell&quot;,&quot;code&quot;:&quot;\nGet-AzureADMSConditionalAccessPolicy | %{ Set-AzureADMSConditionalAccessPolicy -PolicyId $_.Id -State \&quot;disabled\&quot;}\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token function\&quot;\u003eGet-AzureADMSConditionalAccessPolicy</span> <span class=\&quot;token punctuation\&quot;>|</span> <span class=\&quot;token operator\&quot;>%</span><span class=\&quot;token punctuation\&quot;>{</span> <span class=\&quot;token function\&quot;>Set-AzureADMSConditionalAccessPolicy</span> <span class=\&quot;token operator\&quot;>-</span>PolicyId <span class=\&quot;token variable\&quot;>$_</span><span class=\&quot;token punctuation\&quot;>.</span>Id <span class=\&quot;token operator\&quot;>-</span>State <span class=\&quot;token string\&quot;>\&quot;disabled\&quot;</span><span class=\&quot;token punctuation\&quot;>}</span>\n&quot;}"><span class="token function">Get-AzureADMSConditionalAccessPolicy</span> <span class="token punctuation">|</span> <span class="token operator">%</span><span class="token punctuation">{</span> <span class="token function">Set-AzureADMSConditionalAccessPolicy</span> <span class="token operator">-</span>PolicyId <span class="token variable">$_</span><span class="token punctuation">.</span>Id <span class="token operator">-</span>State <span class="token string">"disabled"</span><span class="token punctuation">}</span></code></pre><p>ã“ã‚Œã§ã€ç·Šæ€¥æ™‚ã« YubiKey ãŒã‚ã‚Œã°æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã‚’å‰Šé™¤ã—ã¦ãƒ†ãƒŠãƒ³ãƒˆã«å…¥ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã€å®‰å¿ƒã—ã¦æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã®å®Ÿé¨“ãŒå‡ºæ¥ã¾ã™ã­ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://github.com/Azure-Samples/azure-ad-conditional-access-apis/tree/main/01-configure/powershell">azure-ad-conditional-access-apis&#x2F;01-configure&#x2F;powershell at main Â· Azure-Samples&#x2F;azure-ad-conditional-access-apis</a></li><li><a href="https://docs.microsoft.com/en-us/graph/api/resources/conditionalaccesspolicy?view=graph-rest-1.0">Use query parameters to customize responses - Microsoft Graph | Microsoft Docs</a></li><li><a href="https://pivkey.zendesk.com/hc/en-us/articles/204519855-Deleting-a-Certificate-and-Keys-using-Certutil">Deleting a Certificate and Keys using Certutil â€“ Taglio PIVKey</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;YubiKey 5 ã‚·ãƒªãƒ¼ã‚ºã§ Azure AD ã®ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®è¨¼æ˜æ›¸èªè¨¼ã‚’è©¦ã—ãŸã®ã§ãƒ¡ãƒ¢ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Azure AD" scheme="http://blog.haniyama.com/tags/Azure-AD/"/>
    
      <category term="YubiKey" scheme="http://blog.haniyama.com/tags/YubiKey/"/>
    
  </entry>
  
  <entry>
    <title>OneNote ã‹ã‚‰ Markdown ã«å¤‰æ›ãƒ¡ãƒ¢</title>
    <link href="http://blog.haniyama.com/2020/10/09/onenote-to-markdown/"/>
    <id>http://blog.haniyama.com/2020/10/09/onenote-to-markdown/</id>
    <published>2020-10-09T13:05:24.000Z</published>
    <updated>2022-05-18T13:45:29.115Z</updated>
    
    <content type="html"><![CDATA[<p>OneNote ã‹ã‚‰ Markdown ã«å¤‰æ›ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸã®ã§æ‰‹é †ã‚’ãƒ¡ãƒ¢ã€‚</p><p>ã‚‚ã¨ã‚‚ã¨ã¯ @azu ã•ã‚“ã® <a href="https://efcl.info/2020/05/23/onenote-to-markdown/">OneNoteã®ãƒ‡ãƒ¼ã‚¿ã‚’ç”»åƒä»˜ãã®Markdownã«exportã™ã‚‹ | Web Scratch</a> ã‚’è©¦ãã†ã¨æ€ã£ãŸã‘ã©ã€ä¼æ¥­ã® OneNote ã§ã¯ä¸Šæ‰‹ãå‹•ã‹ãªã‹ã£ãŸã®ã§ã€ä»¥ä¸‹ã® gist ã‚’å‚è€ƒã« pandoc ã§å¤‰æ›ã—ãŸã€‚</p><p>å‚è€ƒ: <a href="https://gist.github.com/heardk/ded40b72056cee33abb18f3724e0a580">https://gist.github.com/heardk/ded40b72056cee33abb18f3724e0a580</a></p><p>æ•°ãƒšãƒ¼ã‚¸ã‚’å¤‰æ›ã™ã‚‹ã ã‘ã ã£ãŸã®ã§ã€ã“ã‚Œã§æ¸ˆã‚“ã ã‘ã©ã€å¤§é‡ã«ã™ã‚‹ã¨ãã¯ã€åˆ¥ã®æ–¹æ³•ã®ã»ã†ãŒã„ã„ã‹ã‚‚ã—ã‚Œãªã„ã€‚</p><span id="more"></span><ol><li>OneNote 2016 ã§ã€OneNote ã®ãƒšãƒ¼ã‚¸ã‹ã‚‰ Word ã«å¤‰æ›ã™ã‚‹ã€‚ (Store ç‰ˆã§ã©ã†ã‚„ã‚‹ã‹ã¯çŸ¥ã‚‰ãªã„)</li><li>pandoc ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</li></ol><pre class=" language-sh"><code class="language-sh">scoop install pandoc</code></pre><ol start="3"><li>ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã§å¤‰æ›</li></ol><pre class=" language-sh"><code class="language-sh">pandoc.exe -f docx -t markdown_strict -i word.docx -o "word.md" --wrap=none --atx-headers</code></pre><ol start="4"><li>Word ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–ã‚Šå‡ºã—</li></ol><pre class=" language-ps1"><code class="language-ps1">7z x .\seo.docx -otmpmv tmp\word\media .\mediarm -Recurse -Force .\tmp</code></pre><ol start="5"><li>ç”»åƒã‚¿ã‚°ã‚’å¤‰æ›</li></ol><p><code>&lt;img src=&quot;media/(.+?)&quot; .+? /&gt;</code> =&gt; <code>![$1](./media/$1)</code></p><p>å¾Œã¯ä½“è£ã‚’æ•´ãˆã¦å®Œäº†ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;OneNote ã‹ã‚‰ Markdown ã«å¤‰æ›ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸã®ã§æ‰‹é †ã‚’ãƒ¡ãƒ¢ã€‚&lt;/p&gt;
&lt;p&gt;ã‚‚ã¨ã‚‚ã¨ã¯ @azu ã•ã‚“ã® &lt;a href=&quot;https://efcl.info/2020/05/23/onenote-to-markdown/&quot;&gt;OneNoteã®ãƒ‡ãƒ¼ã‚¿ã‚’ç”»åƒä»˜ãã®Markdownã«exportã™ã‚‹ | Web Scratch&lt;/a&gt; ã‚’è©¦ãã†ã¨æ€ã£ãŸã‘ã©ã€ä¼æ¥­ã® OneNote ã§ã¯ä¸Šæ‰‹ãå‹•ã‹ãªã‹ã£ãŸã®ã§ã€ä»¥ä¸‹ã® gist ã‚’å‚è€ƒã« pandoc ã§å¤‰æ›ã—ãŸã€‚&lt;/p&gt;
&lt;p&gt;å‚è€ƒ: &lt;a href=&quot;https://gist.github.com/heardk/ded40b72056cee33abb18f3724e0a580&quot;&gt;https://gist.github.com/heardk/ded40b72056cee33abb18f3724e0a580&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æ•°ãƒšãƒ¼ã‚¸ã‚’å¤‰æ›ã™ã‚‹ã ã‘ã ã£ãŸã®ã§ã€ã“ã‚Œã§æ¸ˆã‚“ã ã‘ã©ã€å¤§é‡ã«ã™ã‚‹ã¨ãã¯ã€åˆ¥ã®æ–¹æ³•ã®ã»ã†ãŒã„ã„ã‹ã‚‚ã—ã‚Œãªã„ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="é›‘è¨˜" scheme="http://blog.haniyama.com/tags/%E9%9B%91%E8%A8%98/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD External Identity ã®ã‚»ãƒ«ãƒ• ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã¨ API ã‚³ãƒã‚¯ã‚¿ãƒ¼</title>
    <link href="http://blog.haniyama.com/2020/09/27/aad-external-identity-api-connector/"/>
    <id>http://blog.haniyama.com/2020/09/27/aad-external-identity-api-connector/</id>
    <published>2020-09-27T13:17:58.000Z</published>
    <updated>2022-05-18T13:45:28.975Z</updated>
    
    <content type="html"><![CDATA[<p>Azure AD ã® B2B æ©Ÿèƒ½ã€ã¤ã¾ã‚Šã€ç¤¾å¤–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ãŒã©ã‚“ã©ã‚“ Azure AD B2C ã£ã½ããªã£ã¦ã„ã‚‹ã€‚ã¨ã„ã†ã“ã¨ã§ã€ä»Šå›ã¯ Azure AD External Identity ã®ã‚»ãƒ«ãƒ• ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ— ã¨ API ã‚³ãƒã‚¯ã‚¿ãƒ¼ã‚’è§¦ã£ã¦ã¿ãŸã®ã§ãã®ãƒ¡ãƒ¢ã€‚</p><!-- more  --><ul><li>å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: <a href="https://docs.microsoft.com/en-us/azure/active-directory/external-identities/self-service-sign-up-add-api-connector">Add API connectors to self-service sign-up flows - Azure AD | Microsoft Docs</a></li><li>å…¬å¼ãƒ–ãƒ­ã‚°: <a href="https://techcommunity.microsoft.com/t5/azure-active-directory-identity/evolving-azure-ad-for-every-user-and-any-identity-with-external/ba-p/1257361">Evolving Azure AD for every user and any identity with External Identities - Microsoft Tech Community</a></li></ul><h2 id="ã‚»ãƒ«ãƒ•ã‚µãƒ¼ãƒ“ã‚¹-ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—"><a href="#ã‚»ãƒ«ãƒ•ã‚µãƒ¼ãƒ“ã‚¹-ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—" class="headerlink" title="ã‚»ãƒ«ãƒ•ã‚µãƒ¼ãƒ“ã‚¹ ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—"></a>ã‚»ãƒ«ãƒ•ã‚µãƒ¼ãƒ“ã‚¹ ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—</h2><p>ã¨ã‚Šã‚ãˆãšã©ã†ã„ã†æ©Ÿèƒ½ã‹ã¨ã„ã†ã¨ã€ãã®åã®é€šã‚Šä¼šç¤¾ã®ãƒ†ãƒŠãƒ³ãƒˆã«ã‚²ã‚¹ãƒˆ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã§ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã§ãã‚‹æ©Ÿèƒ½ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã™ã‚‹ãŸã‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼ã¨ã€æ¤œè¨¼ã®ç‚ºã® API ã‚³ãƒã‚¯ã‚¿ãƒ¼ã‚’çµ„ã¿åˆã‚ã›ã¦æ§‹æˆã•ã‚Œã¦ã„ã‚‹ã€‚</p><p>åŒã˜åå‰ã§å‘¼ã°ã‚Œã‚‹ Azure AD ã®æ©Ÿèƒ½ã§ã€Azure AD ã«æœªç™»éŒ²ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã§ Power BI ãªã©ã«ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã™ã‚‹ã¨è‡ªå‹•ã§ä½œæˆã•ã‚Œã‚‹ <a href="https://qiita.com/Shinya-Yamaguchi/items/cb1942c51eda2dba31ff">â€œã‚»ãƒ«ãƒ•ã‚µãƒ¼ãƒ“ã‚¹ ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ— ãƒ†ãƒŠãƒ³ãƒˆâ€ ã¨å‘¼ã°ã‚Œã‚‹ã€ä¸€éƒ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã¯è«¸æ‚ªã®æ ¹æºã®ã”ã¨ãå«Œã‚ã‚Œã‚‹ã‚„ã¤</a>ãŒã„ã‚‹ãŒã€ãã‚Œã¨ã¯å…¨ãé•ã†æ©Ÿèƒ½ãªã®ã§æ°—ã‚’ä»˜ã‘ã¦æ¬²ã—ã„ã€‚</p><p>å¤§ã¾ã‹ãªæµã‚Œã¯ã“ã‚“ãªæ„Ÿã˜ã€‚é€šå¸¸ã¯ç·‘ã®ãƒ•ãƒ­ãƒ¼ (ãƒ¡ãƒ¼ãƒ«æ‹›å¾…) ã§ã‚²ã‚¹ãƒˆã‚’æ‹›å¾…ã™ã‚‹ãŒã€ã‚ªãƒ¬ãƒ³ã‚¸ã®ãƒ•ãƒ­ãƒ¼ãŒã‚»ãƒ«ãƒ• ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ— ãƒ•ãƒ­ãƒ¼ã€‚</p><p><img src="/2020/09/27/aad-external-identity-api-connector/b2b-flow.png"></p><h3 id="ãã‚‚ãã‚‚-B2B-ã£ã¦ï¼Ÿ"><a href="#ãã‚‚ãã‚‚-B2B-ã£ã¦ï¼Ÿ" class="headerlink" title="ãã‚‚ãã‚‚ B2B ã£ã¦ï¼Ÿ"></a>ãã‚‚ãã‚‚ B2B ã£ã¦ï¼Ÿ</h3><p>ã¾ãšã€Azure AD ã®ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ©Ÿèƒ½ã‚’çŸ¥ã‚‰ãªã„äººã®ãŸã‚ã«ã€å°‘ã—ã ã‘èª¬æ˜ã™ã‚‹ã€‚ãã‚‚ãã‚‚ Azure AD ã§ã¯å¤–éƒ¨ãƒ†ãƒŠãƒ³ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Microsoft Account (MSA ã„ã‚ã‚†ã‚‹å€‹äººã‚¢ã‚«ã‚¦ãƒ³ãƒˆ) ã‚’ â€œã‚²ã‚¹ãƒˆ ãƒ¦ãƒ¼ã‚¶ãƒ¼â€ ã¨ã—ã¦æ‹›å¾…ã§ãã‚‹ã€‚<br>ä¾‹ãˆã°å”åŠ›ä¼šç¤¾ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’ã‚²ã‚¹ãƒˆ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦æ‹›å¾…ã•ã›ã¦ä½œæ¥­ã‚’ã•ã›ã‚‹ã ã¨ã‹ã€å¤–éƒ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã« Office 365 ã®ãƒªã‚½ãƒ¼ã‚¹ã‚„ã‚‰ SharePoint ã‚„ã‚‰é€£æºã‚¢ãƒ—ãƒªã‚„ã‚‰ã‚’ä½¿ã‚ã›ã‚‹ãŸã‚ã«ä½¿ãˆã‚‹ã€‚</p><h3 id="B2B-ã®ã—ãã¿"><a href="#B2B-ã®ã—ãã¿" class="headerlink" title="B2B ã®ã—ãã¿"></a>B2B ã®ã—ãã¿</h3><p>å®Ÿéš›ä¼æ¥­ãŒã©ã®ã‚ˆã†ã«ä½¿ã£ã¦ã„ã‚‹ã‹ã€ã£ã¦ã“ã¨ã¯æ­£ç›´ã‚ˆãã‚ã‹ã‚‰ãªã„ãŒã€è¦ã¯å¤–éƒ¨ã® IdP ã¨ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹æˆã™ã‚‹æ©Ÿèƒ½ã§ã‚ã‚‹ã€‚æ‹›å¾…ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€ã©ã®ã‚ˆã†ãªå½¢ã§ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹æˆã™ã‚‹ã‹ã¯å°‘ã—ã‚„ã‚„ã“ã—ã„ãŒã€åŸºæœ¬ã¯å¤–éƒ¨ãƒ†ãƒŠãƒ³ãƒˆã€ã‚‚ã—ãã¯ MSA ã¨ã®é€£æºã«ãªã‚‹ã€‚Google, Facebook, Direct Federation ã¯ãƒ†ãƒŠãƒ³ãƒˆã§è¿½åŠ ã®è¨­å®šãŒå¿…è¦ã«ãªã£ã¦ãã‚‹ãŸã‚ã ã€‚<br>ã¡ãªã¿ã«å¤–éƒ¨ãƒ†ãƒŠãƒ³ãƒˆã‚„ MSA, Google, Facebook ã¯ OIDC&#x2F;OAuth ã§ã€ç›´æ¥ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (Direct Federation) ã¯ SAML ã§é€£æºã™ã‚‹ã€‚</p><p>ã‚ã€OTP ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã“ã¨ã‚’å¿˜ã‚Œã¦ãŸã€‚ã„ãšã‚Œã®ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚‚ç´ã¥ã„ã¦ã„ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¤ã„ã¦ã¯ <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/external-identities/one-time-passcode">B2B ã‚²ã‚¹ãƒˆ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ  ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰èªè¨¼ - Azure AD | Microsoft Docs</a> ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚Œã°ã€OTP ã§ãƒ†ãƒŠãƒ³ãƒˆã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã™ã‚‹ã“ã¨ã«ãªã‚‹ã€‚è©³ã—ã„æµã‚Œã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ãŒã‚ã‚‹ã€‚</p><p><img src="https://docs.microsoft.com/ja-jp/azure/active-directory/external-identities/media/redemption-experience/invitation-redemption-flow.png"></p><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/external-identities/redemption-experience">B2B ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æ‹›å¾…ã®åˆ©ç”¨ - Azure AD | Microsoft Docs</a></p><blockquote><p>æœ€è¿‘ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ—¢å®šã®æ¨©é™ã«<a href="https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/users-restrict-guest-permissions">æ–°ã—ã„æ¨©é™ãŒè¿½åŠ </a>ã•ã‚Œã¦ã€æ‹›å¾…ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ†ãƒŠãƒ³ãƒˆå†…éƒ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¦‹ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ã€ã¨ã„ã£ãŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ãŒè¿½åŠ ã•ã‚ŒãŸãŒã€ä»Šæ—¥ã¯ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒ«ãƒ•ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã«é–¢ã™ã‚‹ãŠè©±ã€‚å®Ÿéš›ã«è§¦ã£ãŸã®ã¯ 7 æœˆã ã‘ã©ã€å¿™ã—ã™ãã¦ãƒ–ãƒ­ã‚°æ›¸ã‹ãšã«ã„ãŸã‚‰ã‚‚ã† 3 ã‚«æœˆãŒãŸã£ã¦ãŸâ€¦ã€‚</p></blockquote><p>ã¨ã„ã†ã“ã¨ã§ã€æ—©é€Ÿæœ¬é¡Œã®ã‚»ãƒ«ãƒ• ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã®è©±ã€‚ã•ã£ãã‚‚è¨€ã£ãŸé€šã‚Šã€ã–ã£ãã‚Šãƒ¦ãƒ¼ã‚¶ãƒ¼ ãƒ•ãƒ­ãƒ¼ã€API ã‚³ãƒã‚¯ã‚¿ãƒ¼ã§æ§‹æˆã•ã‚Œã¦ã„ã‚‹ã€‚ã‚ã¨è¿½åŠ ã®ã‚«ã‚¹ã‚¿ãƒ å±æ€§ã«ã¤ã„ã¦ãƒãƒ©ãƒƒã¨è§£èª¬ã™ã‚‹ã€‚</p><h3 id="ãƒ¦ãƒ¼ã‚¶ãƒ¼-ãƒ•ãƒ­ãƒ¼"><a href="#ãƒ¦ãƒ¼ã‚¶ãƒ¼-ãƒ•ãƒ­ãƒ¼" class="headerlink" title="ãƒ¦ãƒ¼ã‚¶ãƒ¼ ãƒ•ãƒ­ãƒ¼"></a>ãƒ¦ãƒ¼ã‚¶ãƒ¼ ãƒ•ãƒ­ãƒ¼</h3><p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ ãƒ•ãƒ­ãƒ¼â€¦ã€ã¯ã„ã€ãã†ã§ã™ Azure AD B2C ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ ãƒ•ãƒ­ãƒ¼ã¨å…¨ãåŒã˜è¦‹ãŸç›®ã—ã¦ã¾ã™ã­ã€‚</p><p><img src="/2020/09/27/aad-external-identity-api-connector/b2x-user-flow.png"></p><p>è¨­å®šå†…å®¹ã‚‚å¤§ä½“åŒã˜ãªã®ã§ã€Azure AD B2C ã‚’è§¦ã£ã¦ã„ã‚Œã°å›°ã‚‹ã“ã¨ã¯ç„¡ã„ã§ã—ã‚‡ã†ã€‚</p><p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ ãƒ•ãƒ­ãƒ¼ã«ã¯ã€ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æ™‚ã«è¦æ±‚ã™ã‚‹å±æ€§ã‚’æ§‹æˆã§ãã‚‹ã€‚ä¾‹ãˆã°ã€æ°åã‚„ä½æ‰€ã‚’è¿½åŠ ã§å…¥åŠ›ã•ã›ãŸã‚Šã€ã‚«ã‚¹ã‚¿ãƒ å±æ€§ã‚’è¿½åŠ ã§å…¥åŠ›ã•ã›ãŸã‚Šã§ãã‚‹ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ ãƒ•ãƒ­ãƒ¼ã‚’ä½œæˆã—ãŸã‚‰ã€Azure AD ã«ç™»éŒ²ã—ãŸã‚¢ãƒ—ãƒªã‚’ç´ã¥ã‘ã‚‹ã€‚</p><p>ãªãœã‚¢ãƒ—ãƒªã‚’ç´ã¥ã‘ã‚‹ã®ã‹ã€ã¨ã„ã†è©±ãªã®ã ãŒã€å®Ÿéš›ã«ã‚¢ãƒ—ãƒªã‚’ç´ã¥ã‘ã¦ãã®ã‚¢ãƒ—ãƒªã«æœªã‚µã‚¤ãƒ³ã‚¤ãƒ³ã®çŠ¶æ…‹å‡ºç´ã¥ã‘ãŸã‚¢ãƒ—ãƒªã¨ã—ã¦ Authorize ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆãƒœã‚¿ãƒ³ãŒè¿½åŠ ã•ã‚Œã‚‹ã€‚</p><p><img src="/2020/09/27/aad-external-identity-api-connector/create-user-button.png"></p><blockquote><p>åŸ¼ç‰çœŒæ°‘ã«åªšã³ã‚‹ãŸã‚ã«ä½œã£ãŸãƒ•ãƒ­ãƒ¼ãªã®ã§ã€ãªã‚“ã‹å¤‰ãªå±æ€§ã®åé›†ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹</p></blockquote><p>ã“ã“ã§ç´ã¥ã‘ã¦ã„ãªã„ã‚¢ãƒ—ãƒªã«ã¯ã€ã“ã®ã‚»ãƒ«ãƒ• ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã®ãŸã‚ã®ãƒœã‚¿ãƒ³ã¯è¡¨ç¤ºã•ã‚Œãªã„ã€‚<br>ç¾çŠ¶ã“ã‚“ãªæ„Ÿã˜ã§ã¡ã£ã¡ã‚ƒã„ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãªã„ã¨ã‚»ãƒ«ãƒ•ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãŒå‡ºæ¥ãªã„ã€‚æ‹›å¾…ã•ã‚Œã¦ã„ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ Sign in ç”»é¢ã«å…¥ã‚Œã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã¨æ€’ã‚‰ã‚Œã‚‹ã€‚</p><p>å‡ºæ¥ã‚Œã°ã€ã‚¯ã‚¨ãƒªãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã«ç›´æ¥è¡Œã‘ã‚‹ã»ã†ãŒæ··ä¹±ãŒå°‘ãªãã¦è‰¯ã„ã¨æ€ã†ã‘ã©ã€ç¾çŠ¶ã“ã‚“ãªå‹•ä½œã€‚</p><h3 id="Custom-User-Attributes"><a href="#Custom-User-Attributes" class="headerlink" title="Custom User Attributes"></a>Custom User Attributes</h3><p>Create one! ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã“ã¨ã§ã€ã‚²ã‚¹ãƒˆ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ã®ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãŒè¡Œãˆã‚‹ãŒã€ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æ™‚ã«å±æ€§ã‚’åé›†ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã‚‹ã€‚ãã“ã§çµ„ã¿è¾¼ã¿ã®å±æ€§ä»¥å¤–ã‚’é›†ã‚ãŸã„å ´åˆã¯ã€ã‚«ã‚¹ã‚¿ãƒ å±æ€§ã‚’åˆ©ç”¨ã™ã‚‹ã€‚</p><p>ã‚«ã‚¹ã‚¿ãƒ å±æ€§ã¯ã€ã‚«ã‚¹ã‚¿ãƒ ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§ã§äº‹å‰ã«ä½œæˆã™ã‚‹ã€‚</p><p><img src="/2020/09/27/aad-external-identity-api-connector/custom-attributes.png"></p><p>ã“ã“ã§å±æ€§ã‚’è¿½åŠ ã™ã‚‹ã¨ã€<code>aad-extensions-app. Do not modify...</code> ã¨ã„ã†ã‚¢ãƒ—ãƒªãŒå‡ºæ¥ä¸ŠãŒã‚Šã€å±æ€§ã¯ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã«ä¿å­˜ã•ã‚Œã‚‹ã€‚ </p><p><img src="/2020/09/27/aad-external-identity-api-connector/aad-extensions-app.png"></p><p>å®Ÿéš›ã«ä¿å­˜ã•ã‚ŒãŸå±æ€§ã¯ <code>extension_&lt;appid&gt;_&lt;extension_name&gt;</code> ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã€‚<br>ã“ã®ã‚ãŸã‚Šã‚‚ B2C ã¨å¤§ä½“åŒã˜ãªã®ã§ã€ã¾ã‚é•å’Œæ„Ÿãªã„ã§ã—ã‚‡ã†ã€‚</p><h3 id="API-Connector"><a href="#API-Connector" class="headerlink" title="API Connector"></a>API Connector</h3><p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æ™‚ã«ã€å±æ€§æƒ…å ±ã® Validation ã‚„ã€å¤‰æ›ãªã©ã‚’ API çµŒç”±ã§è¡Œãˆã‚‹ã€‚</p><p><img src="/2020/09/27/aad-external-identity-api-connector/api-connector.png"></p><p>ä¾‹ãˆã°ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã€å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã¨é€£æºã—ã€è¿½åŠ ã®ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’å…¥åŠ›ã™ã‚‹ãªã©ã€‚<br>å…¬å¼ã§ã‚‚ã„ãã¤ã‹ã®ã‚µãƒ³ãƒ—ãƒ«ãŒç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€ãƒ¡ãƒ¼ãƒ« ãƒ‰ãƒ¡ã‚¤ãƒ³ã®æ¤œè¨¼ã€æ‰¿èªã‚·ã‚¹ãƒ†ãƒ ã€<a href="https://github.com/Azure-Samples/active-directory-dotnet-external-identities-idology-identity-verification">IDology</a> ã‚„ <a href="https://github.com/Azure-Samples/active-directory-dotnet-external-identities-experian-identity-verification">Experian</a> ã¨ã„ã£ãŸå¤–éƒ¨ SaaS ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ ã¨ã¤ãªã„ã§æ¤œè¨¼ã™ã‚‹ã¨ã„ã£ãŸã‚µãƒ³ãƒ—ãƒ«ã‚‚ã‚ã‚‹ã€‚</p><p><a href="https://docs.microsoft.com/en-us/azure/active-directory/external-identities/code-samples-self-service-sign-up">API connector code samples for user flows - Azure AD | Microsoft Docs</a></p><p>Azure Function ã®ã‚µãƒ³ãƒ—ãƒ«ã‚‚ã‚ã‚‹ã®ã§ã€ã‚µã‚¯ãƒƒã¨ãŸã‚ã—ãŸã„ãªã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã‚Œã°è‰¯ã„ã¨æ€ã†ã€‚è‡ªåˆ†ã‚‚ 3 ã‚«æœˆãã‚‰ã„å‰ã« <a href="https://github.com/watahani/azure-ad-external-identity-api">ã‚µãƒ³ãƒ—ãƒ«</a> ä½œã£ãŸã‘ã©ã€è§£èª¬ä½œã‚‹å‰ã«å…¬å¼ã‚µãƒ³ãƒ—ãƒ«ãŒå‡ºæ¥ã¦ã—ã¾ã£ãŸã€‚</p><p>ãƒ‘ãƒƒã¨è€ƒãˆãŸã ã‘ã§ã‚‚ã€ã‚²ã‚¹ãƒˆ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå‰ã« prefix ã‚’è¿½åŠ ã—ã¦è¦‹ã‚„ã™ãã™ã‚‹ã¨ã‹ã€è¿½åŠ ã®æ§‹æˆã¯å¿…è¦ã ãŒã€ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æ—¥æ™‚ã‚’ä¿å­˜ã—ã¦ç‰¹å®šæ—¥æ™‚ãŒãŸã£ãŸã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç„¡åŠ¹åŒ–ã•ã›ã‚‹ã¨ã„ã£ãŸãƒ•ãƒ­ãƒ¼ãªã©ã€è‰²ã€…è€ƒãˆã‚‰ã‚Œã¦ã„ã„æ©Ÿèƒ½ã ã¨æ€ã†ã€‚</p><h2 id="ã–ã£ãã‚Šã¾ã¨ã‚"><a href="#ã–ã£ãã‚Šã¾ã¨ã‚" class="headerlink" title="ã–ã£ãã‚Šã¾ã¨ã‚"></a>ã–ã£ãã‚Šã¾ã¨ã‚</h2><p>ä¼æ¥­é–“ã§ B2B ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†éš›ã«ã¯ã€ç‰¹ã«åˆ¶é™ã¯è¡Œã‚ãšä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‹›å¾…å¯èƒ½ã«ã™ã‚‹ã€ã‚ã‚‹ã„ã¯æ‹›å¾…ã‚’åˆ¶é™ã—ã€ç®¡ç†è€…ã®ã¿ãŒæ‹›å¾…æ¨©é™ã‚’æŒã¤ã‚ˆã†æ§‹æˆã™ã‚‹ã€ã¨ã„ã†ã©ã¡ã‚‰ã‹ã®æ–¹æ³•ã—ã‹ãªã‹ã£ãŸã€‚ã—ã‹ã—ã‚»ãƒ«ãƒ• ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€ã‚ˆã‚ŠæŸ”è»Ÿãªæ‹›å¾…æ–¹æ³•ã®æ§‹æˆãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚</p><p>ãŸã¨ãˆã°ã€å¤–éƒ¨ ID ã®è¨­å®šã¨ã—ã¦ã¯ã€ã“ã‚“ãªæ„Ÿã˜ã§æ‹›å¾…ã‚’ç¦æ­¢ã—ã¦ãŠã„ã¦ã€ç‰¹å®šã®ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‹ã‚‰ API ã®æ¤œè¨¼ã®çµæœ OK ãªã‚‰ã‚»ãƒ«ãƒ• ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã§ãã‚‹ã®ã‚ˆã†ãªæ§‹æˆã‚‚å–ã‚Œã‚‹ã€‚</p><p><img src="/2020/09/27/aad-external-identity-api-connector/external-identities-settings.png"></p><p>API Connector ã‚‚ B2C ã¨é•ã£ã¦ã€ã‚«ã‚¹ã‚¿ãƒ  ãƒãƒªã‚·ãƒ¼ã‚’å¼„ã£ãŸã‚Šã›ãšã«ç°¡å˜ã«æ§‹æˆã§ãã‚‹ã€‚B2C ã«ã‚‚æ—©ãé€†è¼¸å…¥ã•ã‚Œã¦æ¬²ã—ã„ã€‚ã¨ã„ã†ã‹ã€B2X ãŒã‚ã‚Œã°ã€ä»Šã¾ã§ B2C ã§æ§‹æˆã—ã¦ã„ãŸã„ãã¤ã‹ã®ãƒ¦ãƒ¼ã‚¹ ã‚±ãƒ¼ã‚¹ã¯ã“ã¡ã‚‰ã§å¯¾å¿œã§ãã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚‹ã€‚<br>Azure AD Premium ã®æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼ã¨çµ„ã¿åˆã‚ã›ã‚Œã°ã€æ‹›å¾…æ™‚ã«åˆ©ç”¨è¦ç´„ã¸ã®åŒæ„ãªã‚“ã‹ã‚‚è¡Œãˆã‚‹ã€‚</p><p>ã¨ã“ã‚ã§ã€å¤–éƒ¨ ID ã«ã¤ã„ã¦ã¯ã€ã‚‚ã†ä¸€ã¤å¤§ããªã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒã‚ã‚Šã€<a href="https://azure.microsoft.com/ja-jp/pricing/details/active-directory/external-identities/">ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãŒã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã§æ‰•ãˆã‚‹ã‚ˆã†ã«</a> ãªã£ã¦ã‚‹ã€‚<br>ä»Šã¾ã§ã¯ Azure AD Premium ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã¯ã€ãƒ†ãƒŠãƒ³ãƒˆã§æœ‰åŠ¹ãªãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã® 5 å€ã¾ã§ã®ã‚²ã‚¹ãƒˆ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåˆ©ç”¨ã§ãã‚‹ã¨ã‹ã€ã‚ã‚‹æ„å‘³æ›–æ˜§ãªæ–™é‡‘ä½“ç³»ã ã£ãŸãŒã€ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å½¢å¼ã«åˆ‡ã‚Šæ›¿ãˆã‚Œã° 50,000 ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ã§ã¯ç„¡æ–™ (!?) ã«ãªã‚‹ã®ã§ã€å¤šãã®ä¼æ¥­ã§ã¯åˆ‡ã‚Šæ›¿ãˆãŸã»ã†ãŒã‚ªãƒˆã‚¯ã«ãªã‚Šãã†ã€‚</p><p><img src="/2020/09/27/aad-external-identity-api-connector/external-identities-pricing.png"></p><p><a href="https://azure.microsoft.com/ja-jp/pricing/details/active-directory/external-identities/">https://azure.microsoft.com/ja-jp/pricing/details/active-directory/external-identities/</a></p><p>ã¨ã¯ã„ãˆã€ãƒ‘ãƒ–ãƒªãƒƒã‚¯ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãªã®ã§ã€å®Ÿéš›ã« GA ã•ã‚Œã‚‹ã¨ãã©ã‚“ãªå‹•ä½œã«ãªã‚‹ã‹ã¯åˆ†ã‹ã‚‰ãªã„ã®ã§æ‚ªã—ã‹ã‚‰ãšã€‚</p><p>ä»Šæ—¥ã¯ã“ã®è¾ºã§ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Azure AD ã® B2B æ©Ÿèƒ½ã€ã¤ã¾ã‚Šã€ç¤¾å¤–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ãŒã©ã‚“ã©ã‚“ Azure AD B2C ã£ã½ããªã£ã¦ã„ã‚‹ã€‚ã¨ã„ã†ã“ã¨ã§ã€ä»Šå›ã¯ Azure AD External Identity ã®ã‚»ãƒ«ãƒ• ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ— ã¨ API ã‚³ãƒã‚¯ã‚¿ãƒ¼ã‚’è§¦ã£ã¦ã¿ãŸã®ã§
      
    
    </summary>
    
    
      <category term="Azure AD" scheme="http://blog.haniyama.com/tags/Azure-AD/"/>
    
      <category term="B2B" scheme="http://blog.haniyama.com/tags/B2B/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD ã® SPA å‘ã‘ Authorize Code Flow with PKCE (MSAL.js 2.x)</title>
    <link href="http://blog.haniyama.com/2020/06/02/aad-spa-auth-code-grant-with-pkce/"/>
    <id>http://blog.haniyama.com/2020/06/02/aad-spa-auth-code-grant-with-pkce/</id>
    <published>2020-06-02T09:23:00.000Z</published>
    <updated>2022-05-18T13:45:28.985Z</updated>
    
    <content type="html"><![CDATA[<p>Authorization Code Flow with PKCE ã«å¯¾å¿œã—ãŸ MSAL.js 2.x ãŒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ã„ãŸã®ã§ã€è§¦ã£ã¦ã¿ãŸãƒ¡ãƒ¢ã€‚</p><h2 id="Azure-ãƒãƒ¼ã‚¿ãƒ«ã®ã‚¢ãƒ—ãƒªã®ç™»éŒ²ç”»é¢"><a href="#Azure-ãƒãƒ¼ã‚¿ãƒ«ã®ã‚¢ãƒ—ãƒªã®ç™»éŒ²ç”»é¢" class="headerlink" title="Azure ãƒãƒ¼ã‚¿ãƒ«ã®ã‚¢ãƒ—ãƒªã®ç™»éŒ²ç”»é¢"></a>Azure ãƒãƒ¼ã‚¿ãƒ«ã®ã‚¢ãƒ—ãƒªã®ç™»éŒ²ç”»é¢</h2><p>Azure AD ã®ã‚¢ãƒ—ãƒªç™»éŒ²ã®ç”»é¢ãŒã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ãŠã‚Šã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ URI ã®ç™»éŒ²ã« SPA ãŒè¿½åŠ ã•ã‚Œã¦ã„ãŸã€‚</p><span id="more"></span><p><img src="/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-new-redirect-uri.png"></p><p>ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã“ã‚“ãªè¡¨ç¤ºãŒã€‚</p><p><img src="/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-spa.png"></p><blockquote><p>æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã® MSAL.js ã§ã¯ã€PKCE ã¨ CORS ã§èªè¨¼ã‚³ãƒ¼ãƒ‰ ãƒ•ãƒ­ãƒ¼ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</p></blockquote><blockquote><p>ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ URI ã¯ã€PKCE ã§ã®æ‰¿èªã‚³ãƒ¼ãƒ‰ ãƒ•ãƒ­ãƒ¼ã®å¯¾è±¡ã¨ãªã‚Šã¾ã™ã€‚</p></blockquote><p>å°‘ã—ã‚ã‹ã‚Šè¾›ã„ãŒã€æ—¢å®šã§ã¯ MSAL.js 2.0 ã‚’åˆ©ç”¨ã—ãŸæ‰¿èªã‚³ãƒ¼ãƒ‰ ãƒ•ãƒ­ãƒ¼ (Authorize Code Flow) with <a href="https://tools.ietf.org/html/rfc7636">PKCE</a> ã‚’åˆ©ç”¨ã™ã‚‹è¨­å®šã«ãªã£ãŸã¨ã®ã“ã¨ã‚‰ã—ã„ã€‚</p><p>ã‚‚ã¡ã‚ã‚“æš—é»™ã®ä»˜ä¸ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã“ã¨ã§ã€å¼•ãç¶šã Implicit Flow ã‚‚åˆ©ç”¨ã§ãã‚‹ã€‚</p><h2 id="MSAL-js-2-0"><a href="#MSAL-js-2-0" class="headerlink" title="MSAL.js 2.0"></a>MSAL.js 2.0</h2><p>Microsoft ãŒ SPA å‘ã‘ã«æä¾›ã—ã¦ã„ã‚‹ JavaScript å‘ã‘ã®èªè¨¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦ã¯ä»¥ä¸‹ã® 3 ã¤ãŒã‚ã‚‹ã€‚ãªãŠ ADAL ã¯ã€å¤ã„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€æ–°è¦ã§é–‹ç™ºã™ã‚‹å ´åˆã«ã¯é¸æŠè‚¢ã‹ã‚‰å¤–ãã†ã€‚</p><ul><li>Authorize Code Grant ã‚’åˆ©ç”¨ã™ã‚‹ <a href="https://github.com/AzureAD/microsoft-authentication-library-for-js/tree/dev/lib/msal-browser">MSAL.js 2.x</a></li><li>Implicit Flow ã‚’åˆ©ç”¨ã™ã‚‹ <a href="https://github.com/AzureAD/microsoft-authentication-library-for-js/tree/dev/lib/msal-core">MSAL.js 1.x</a>  </li><li>Implicit Flow (v1 ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ) ã‚’åˆ©ç”¨ã™ã‚‹ ADAL.js</li></ul><p>ä»Šå‡ºã¦ã„ã‚‹ MSAL.js é–¢é€£ã®è¨˜äº‹ã¯ 1.x ç³»ã®ã‚‚ã®ãŒã»ã¨ã‚“ã©ã ãŒã€ä»Šå¾Œã¯ 1.x ç³»ãªã®ã‹ã€2.x ç³»ãªã®ã‹ã—ã£ã‹ã‚Šè¦‹æ¥µã‚ã¦èª­ã‚€å¿…è¦ãŒã‚ã‚‹ã€‚</p><h2 id="ã‚µãƒ³ãƒ—ãƒ«ã‚’å‹•ã‹ã™"><a href="#ã‚µãƒ³ãƒ—ãƒ«ã‚’å‹•ã‹ã™" class="headerlink" title="ã‚µãƒ³ãƒ—ãƒ«ã‚’å‹•ã‹ã™"></a>ã‚µãƒ³ãƒ—ãƒ«ã‚’å‹•ã‹ã™</h2><p>ã‚¢ãƒ—ãƒªç™»éŒ²ç”»é¢ãŒæ›´æ–°ã•ã‚Œã€ã‚µãƒ³ãƒ—ãƒ« ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚ã‚ã£ã¡ã‚ƒæ¥½ã«å‹•ãã€‚ã™ã”ã„ä¾¿åˆ©ã€‚</p><p>ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‹ã‚‰ã‚µãƒ³ãƒ—ãƒ«ã‚’ä½œã‚‹ã€‚</p><p><img src="/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-quick-start.png"></p><blockquote><p>ã‚·ãƒ³ã‚°ãƒ«ãƒšãƒ¼ã‚¸ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ (SPA) &gt; JavaScript (èªè¨¼ã‚³ãƒ¼ãƒ‰ ãƒ•ãƒ­ãƒ¼) ã‚’é¸æŠ</p></blockquote><p><img src="/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-quick-start-spa.png"></p><blockquote><p>æ—¢å®šã§ Code Grant ã‚’æ¨ã—ã¦ã¯ã„ã‚‹ã‘ã©ã€ã‚ãã¾ã§ MSAL.js 2.x ã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</p></blockquote><p><img src="/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-quick-start-notice.png"></p><p>ã‚ã¨ã¯æ‰‹é †é€šã‚Šã«ãƒœã‚¿ãƒ³ã‚’ãƒãƒãƒãƒã—ã¦ã„ãã¨ã€ã‚¢ãƒ—ãƒªç™»éŒ²ã®è¨­å®šå¤‰æ›´ã‚’è¡Œã„ã€client_id ãªã©ã‚’åŸ‹ã‚è¾¼ã‚“ã ã‚µãƒ³ãƒ—ãƒ«ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã€‚</p><p> <code>ã“ã‚Œã‚‰ã®å¤‰æ›´ã‚’è¡Œã„ã¾ã™</code> ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ã‚¢ãƒ—ãƒªã®è¨­å®šã‚’æ›´æ–°ã—ãŸã®ã¡ã€ã‚³ãƒ¼ãƒ‰ã‚µãƒ³ãƒ—ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã€‚</p><p><img src="/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-quick-start-download-sample.png"></p><p>è‡ªå‹•ã§è¨­å®šã•ã‚Œã‚‹å†…å®¹ã¯ã“ã‚“ãªæ„Ÿã˜</p><p><img src="/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-settings-auth.png"></p><p>ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã«ã¯ã€<code>type: &quot;spa&quot;</code> ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã€‚</p><p><img src="/2020/06/02/aad-spa-auth-code-grant-with-pkce/app-registration-settings-manifest.png"></p><p>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚µãƒ³ãƒ—ãƒ«ã‚’è§£å‡ã—ã¦ã€npm install &amp;&amp; npm start ã‚’å®Ÿè¡Œã™ã‚‹ã¨ <a href="http://localhost:3000/">http://localhost:3000</a> ã§ã‚µãƒ³ãƒ—ãƒ«ãŒå‹•ãã€‚</p><p><img src="/2020/06/02/aad-spa-auth-code-grant-with-pkce/sample-top.png"></p><h2 id="èªè¨¼ã®æµã‚Œ"><a href="#èªè¨¼ã®æµã‚Œ" class="headerlink" title="èªè¨¼ã®æµã‚Œ"></a>èªè¨¼ã®æµã‚Œ</h2><p>Sign In ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã“ã¨ã§ã€Authorize Endpoint ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé£›ã¶ã€‚</p><p>ã‚µãƒ³ãƒ—ãƒ«ã¯ãƒãƒ«ãƒ ãƒ†ãƒŠãƒ³ãƒˆã‚¢ãƒ—ãƒªãªã®ã§ã€organizations ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã—èªè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã€‚</p><pre class="language-http" style="" tabindex="0"><code id="a6781e3f" class="language-http" data-prism-hydrate="{&quot;element&quot;:&quot;a6781e3f&quot;,&quot;language&quot;:&quot;http&quot;,&quot;code&quot;:&quot;\nhttps://login.microsoftonline.com/organizations/oauth2/v2.0/authorize?\n\nresponse_type=code\u0026\nscope=openid%20profile%20user.read%20offline_access&amp;\nclient_id=47a5a26f-13c5-4f59-84f8-6a57b8ede039&amp;\nredirect_uri=http%3A%2F%2Flocalhost%3A3000%2F&amp;\nstate=d57b6054-1930-422d-b707-fe840584790c&amp;\nnonce=2babda35-58fd-4d5c-9381-ed174e9214d3&amp;\nclient_info=1&amp;\nx-client-SKU=MSAL.JS&amp;\nx-client-Ver=1.0.0-beta.0&amp;\ncode_challenge=ZhDtcgD2hU8bRjD1Qpvhcrvm-J38iUvkovNdbbc3o0w&amp;\ncode_challenge_method=S256&amp;\nclient-request-id=303fc61d-7bbe-4f25-8430-5d11b7b5240f&amp;\nresponse_mode=fragment&amp;\nsso_reload=true\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token header\&quot;\u003e<span class=\&quot;token header-name keyword\&quot;>https</span><span class=\&quot;token punctuation\&quot;>:</span><span class=\&quot;token header-value\&quot;>//login.microsoftonline.com/organizations/oauth2/v2.0/authorize?</span></span>\n\nresponse_type=code&amp;amp;\nscope=openid%20profile%20user.read%20offline_access&amp;amp;\nclient_id=47a5a26f-13c5-4f59-84f8-6a57b8ede039&amp;amp;\nredirect_uri=http%3A%2F%2Flocalhost%3A3000%2F&amp;amp;\nstate=d57b6054-1930-422d-b707-fe840584790c&amp;amp;\nnonce=2babda35-58fd-4d5c-9381-ed174e9214d3&amp;amp;\nclient_info=1&amp;amp;\nx-client-SKU=MSAL.JS&amp;amp;\nx-client-Ver=1.0.0-beta.0&amp;amp;\ncode_challenge=ZhDtcgD2hU8bRjD1Qpvhcrvm-J38iUvkovNdbbc3o0w&amp;amp;\ncode_challenge_method=S256&amp;amp;\nclient-request-id=303fc61d-7bbe-4f25-8430-5d11b7b5240f&amp;amp;\nresponse_mode=fragment&amp;amp;\nsso_reload=true\n&quot;}"><span class="token header"><span class="token header-name keyword">https</span><span class="token punctuation">:</span><span class="token header-value">//login.microsoftonline.com/organizations/oauth2/v2.0/authorize?</span></span>response_type=code&amp;scope=openid%20profile%20user.read%20offline_access&amp;client_id=47a5a26f-13c5-4f59-84f8-6a57b8ede039&amp;redirect_uri=http%3A%2F%2Flocalhost%3A3000%2F&amp;state=d57b6054-1930-422d-b707-fe840584790c&amp;nonce=2babda35-58fd-4d5c-9381-ed174e9214d3&amp;client_info=1&amp;x-client-SKU=MSAL.JS&amp;x-client-Ver=1.0.0-beta.0&amp;code_challenge=ZhDtcgD2hU8bRjD1Qpvhcrvm-J38iUvkovNdbbc3o0w&amp;code_challenge_method=S256&amp;client-request-id=303fc61d-7bbe-4f25-8430-5d11b7b5240f&amp;response_mode=fragment&amp;sso_reload=true</code></pre><p>ãƒã‚¤ãƒ³ãƒˆã¯ã€code_challenge ã¨ code_challenge_method ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã€‚</p><blockquote><p>code_challenge&#x3D;ZhDtcgD2hU8bRjD1Qpvhcrvm-J38iUvkovNdbbc3o0w</p></blockquote><p>ã‚µã‚¤ãƒ³ã‚¤ãƒ³ &amp; Consent å¾Œã€code ãŒè¿”å´ã•ã‚Œã‚‹</p><pre class="language-http" style="" tabindex="0"><code id="89243d3f" class="language-http" data-prism-hydrate="{&quot;element&quot;:&quot;89243d3f&quot;,&quot;language&quot;:&quot;http&quot;,&quot;code&quot;:&quot;\nhttp://localhost:3000/#\n\ncode=0.ASsArFzjubin3UihAruhjq...\u0026\nclient_info=eyJ1aWQiOiIxMTc1MGFiZS1kOWE2LTQ3MTYtOTdiNS03N2I0MzBjOGFmNjUiLCJ1dGlkIjoiYjllMzVjYWMtYTdiOC00OGRkLWExMDItYmJhMThlYWNhNTI0In0&amp;\nstate=0bf48805-be5d-404f-9f9a-c31fc321a292&amp;\nsession_state=c1f74a08-8442-486c-bb75-107298d6dc7e\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token header\&quot;\u003e<span class=\&quot;token header-name keyword\&quot;>http</span><span class=\&quot;token punctuation\&quot;>:</span><span class=\&quot;token header-value\&quot;>//localhost:3000/#</span></span>\n\ncode=0.ASsArFzjubin3UihAruhjq...&amp;amp;\nclient_info=eyJ1aWQiOiIxMTc1MGFiZS1kOWE2LTQ3MTYtOTdiNS03N2I0MzBjOGFmNjUiLCJ1dGlkIjoiYjllMzVjYWMtYTdiOC00OGRkLWExMDItYmJhMThlYWNhNTI0In0&amp;amp;\nstate=0bf48805-be5d-404f-9f9a-c31fc321a292&amp;amp;\nsession_state=c1f74a08-8442-486c-bb75-107298d6dc7e\n&quot;}"><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//localhost:3000/#</span></span>code=0.ASsArFzjubin3UihAruhjq...&amp;client_info=eyJ1aWQiOiIxMTc1MGFiZS1kOWE2LTQ3MTYtOTdiNS03N2I0MzBjOGFmNjUiLCJ1dGlkIjoiYjllMzVjYWMtYTdiOC00OGRkLWExMDItYmJhMThlYWNhNTI0In0&amp;state=0bf48805-be5d-404f-9f9a-c31fc321a292&amp;session_state=c1f74a08-8442-486c-bb75-107298d6dc7e</code></pre><p>token ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã® POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã¯ code_verifier ã‚’ä»˜ä¸ã™ã‚‹ã€‚</p><pre class="language-http" style="" tabindex="0"><code id="9ab3c13e" class="language-http" data-prism-hydrate="{&quot;element&quot;:&quot;9ab3c13e&quot;,&quot;language&quot;:&quot;http&quot;,&quot;code&quot;:&quot;\nPOST https://login.microsoftonline.com/organizations/oauth2/v2.0/token HTTP/1.1\nHost: login.microsoftonline.com\nConnection: keep-alive\nContent-Length: 1052\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.61 Safari/537.36\ncontent-type: application/x-www-form-urlencoded\nAccept: */*\nOrigin: http://localhost:3000\nSec-Fetch-Site: cross-site\nSec-Fetch-Mode: cors\nSec-Fetch-Dest: empty\nReferer: http://localhost:3000/\nAccept-Encoding: gzip, deflate, br\nAccept-Language: en-US,en;q=0.9,ja-CA;q=0.8,ja;q=0.7\n\nclient_id=47a5a26f-13c5-4f59-84f8-6a57b8ede039\u0026\nscope=openid%20profile%20user.read%20offline_access&amp;\nredirect_uri=http%3A%2F%2Flocalhost%3A3000%2F&amp;\ncode=0.ASsArFzjubin3UihAruhjqylJG...&amp;\ncode_verifier=NUJGSXpNM1VEazlHVW9vYXRWb0o5RDJSTXI2Q1l3WGI&amp;\ngrant_type=authorization_code\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token request-line\&quot;\u003e<span class=\&quot;token method property\&quot;>POST</span> <span class=\&quot;token request-target url\&quot;>https://login.microsoftonline.com/organizations/oauth2/v2.0/token</span> <span class=\&quot;token http-version property\&quot;>HTTP/1.1</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Host</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>login.microsoftonline.com</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Connection</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>keep-alive</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Content-Length</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>1052</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>User-Agent</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.61 Safari/537.36</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>content-type</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>application/x-www-form-urlencoded</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Accept</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>*/*</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Origin</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>http://localhost:3000</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Sec-Fetch-Site</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>cross-site</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Sec-Fetch-Mode</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>cors</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Sec-Fetch-Dest</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>empty</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Referer</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>http://localhost:3000/</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Accept-Encoding</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>gzip, deflate, br</span></span>\n<span class=\&quot;token header\&quot;><span class=\&quot;token header-name keyword\&quot;>Accept-Language</span><span class=\&quot;token punctuation\&quot;>:</span> <span class=\&quot;token header-value\&quot;>en-US,en;q=0.9,ja-CA;q=0.8,ja;q=0.7</span></span>\n\nclient_id=47a5a26f-13c5-4f59-84f8-6a57b8ede039&amp;amp;\nscope=openid%20profile%20user.read%20offline_access&amp;amp;\nredirect_uri=http%3A%2F%2Flocalhost%3A3000%2F&amp;amp;\ncode=0.ASsArFzjubin3UihAruhjqylJG...&amp;amp;\ncode_verifier=NUJGSXpNM1VEazlHVW9vYXRWb0o5RDJSTXI2Q1l3WGI&amp;amp;\ngrant_type=authorization_code\n&quot;}"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">https://login.microsoftonline.com/organizations/oauth2/v2.0/token</span> <span class="token http-version property">HTTP/1.1</span></span><span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">login.microsoftonline.com</span></span><span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">keep-alive</span></span><span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">1052</span></span><span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.61 Safari/537.36</span></span><span class="token header"><span class="token header-name keyword">content-type</span><span class="token punctuation">:</span> <span class="token header-value">application/x-www-form-urlencoded</span></span><span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">*/*</span></span><span class="token header"><span class="token header-name keyword">Origin</span><span class="token punctuation">:</span> <span class="token header-value">http://localhost:3000</span></span><span class="token header"><span class="token header-name keyword">Sec-Fetch-Site</span><span class="token punctuation">:</span> <span class="token header-value">cross-site</span></span><span class="token header"><span class="token header-name keyword">Sec-Fetch-Mode</span><span class="token punctuation">:</span> <span class="token header-value">cors</span></span><span class="token header"><span class="token header-name keyword">Sec-Fetch-Dest</span><span class="token punctuation">:</span> <span class="token header-value">empty</span></span><span class="token header"><span class="token header-name keyword">Referer</span><span class="token punctuation">:</span> <span class="token header-value">http://localhost:3000/</span></span><span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate, br</span></span><span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">en-US,en;q=0.9,ja-CA;q=0.8,ja;q=0.7</span></span>client_id=47a5a26f-13c5-4f59-84f8-6a57b8ede039&amp;scope=openid%20profile%20user.read%20offline_access&amp;redirect_uri=http%3A%2F%2Flocalhost%3A3000%2F&amp;code=0.ASsArFzjubin3UihAruhjqylJG...&amp;code_verifier=NUJGSXpNM1VEazlHVW9vYXRWb0o5RDJSTXI2Q1l3WGI&amp;grant_type=authorization_code</code></pre><p>code_verifier ã®å€¤ã‚’ã€SHA256 ã§ãƒãƒƒã‚·ãƒ¥ã‚’å–ã‚‹ã¨ã€code_challenge ã®å€¤ã¨ä¸€è‡´ã™ã‚‹ã¯ãšã€‚</p><pre class="language-powershell" style="" tabindex="0"><code id="19cf1b3e" class="language-powershell" data-prism-hydrate="{&quot;element&quot;:&quot;19cf1b3e&quot;,&quot;language&quot;:&quot;powershell&quot;,&quot;code&quot;:&quot;\n ConvertFrom-CodeVerifier - \u0027NUJGSXpNM1VEazlHVW9vYXRWb0o5RDJSTXI2Q1l3WGI'\n# ZhDtcgD2hU8bRjD1Qpvhcrvm-J38iUvkovNdbbc3o0w\n&quot;,&quot;highlightedCode&quot;:&quot;\n \u003cspan class=\&quot;token function\&quot;\u003eConvertFrom-CodeVerifier</span> <span class=\&quot;token operator\&quot;>-</span> <span class=\&quot;token string\&quot;>'NUJGSXpNM1VEazlHVW9vYXRWb0o5RDJSTXI2Q1l3WGI'</span>\n<span class=\&quot;token comment\&quot;># ZhDtcgD2hU8bRjD1Qpvhcrvm-J38iUvkovNdbbc3o0w</span>\n&quot;}"> <span class="token function">ConvertFrom-CodeVerifier</span> <span class="token operator">-</span> <span class="token string">'NUJGSXpNM1VEazlHVW9vYXRWb0o5RDJSTXI2Q1l3WGI'</span><span class="token comment"># ZhDtcgD2hU8bRjD1Qpvhcrvm-J38iUvkovNdbbc3o0w</span></code></pre><p>code_verifier ã‹ã‚‰ code_challenge ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚</p><script src="https://gist.github.com/watahani/57b91116335d4738e23918f5996d7553.js"></script><h2 id="ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã¦ã¿ãŸãƒ¡ãƒ¢"><a href="#ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã¦ã¿ãŸãƒ¡ãƒ¢" class="headerlink" title="ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã¦ã¿ãŸãƒ¡ãƒ¢"></a>ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã¦ã¿ãŸãƒ¡ãƒ¢</h2><h3 id="AADSTS50148-ã‚¨ãƒ©ãƒ¼"><a href="#AADSTS50148-ã‚¨ãƒ©ãƒ¼" class="headerlink" title="AADSTS50148 ã‚¨ãƒ©ãƒ¼"></a>AADSTS50148 ã‚¨ãƒ©ãƒ¼</h3><p>ãƒˆãƒ¼ã‚¯ãƒ³ ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ code_verifier ã‚’æ¶ˆã—ãŸã‚Šã€é–“é•ãˆãŸã‚Šã—ã¦é€ã£ã¦ã¿ã‚‹ã€‚æ€’ã‚‰ã‚Œã‚‹ã€‚</p><pre class="language-js" style="" tabindex="0"><code id="88760d3f" class="language-js" data-prism-hydrate="{&quot;element&quot;:&quot;88760d3f&quot;,&quot;language&quot;:&quot;js&quot;,&quot;code&quot;:&quot;\nu=\u0027https://login.microsoftonline.com/organizations/oauth2/v2.0/token'\ndata = {\n    \&quot;client_id\&quot;: \&quot;47a5a26f-13c5-4f59-84f8-6a57b8ede039\&quot;,\n    \&quot;scope\&quot;: \&quot;openid\&quot;,\n    \&quot;grant_type\&quot;: \&quot;authorization_code\&quot;,\n    \&quot;redirect_uri\&quot;: \&quot;http://localhost:3000/\&quot;,\n    \&quot;code\&quot;: code\n  }\n\nlet urlEncodedDataPairs = [];\nfor(let name in data ) {\n    urlEncodedDataPairs.push( encodeURIComponent( name ) + '=' + encodeURIComponent( data[name] ) );\n}\nurlEncodedData = urlEncodedDataPairs.join( '\u0026' ).replace( /%20/g, '+' );\n\nvar request = new XMLHttpRequest()\nrequest.addEventListener( 'load', function(event) {\n  console.log(event.target.response);\n});\nrequest.open(\&quot;POST\&quot;,u)\nrequest.setRequestHeader( 'Content-Type', 'application/x-www-form-urlencoded' )\n\nrequest.send(urlEncodedData)\n\n//{\&quot;error\&quot;:\&quot;invalid_grant\&quot;,\&quot;error_description\&quot;:\&quot;AADSTS50148: The code_verifier does not match the code_challenge supplied in the authorization request for PKCE.\\r\\nTrace ID: 5c4218e1-fa34-4609-bdb6-f3a63a918200\\r\\nCorrelation ID: 6957aeea-d8fd-43b7-bf3f-79c2a3654bde\\r\\nTimestamp: 2020-06-02 08:00:46Z\&quot;,\&quot;error_codes\&quot;:[50148],\&quot;timestamp\&quot;:\&quot;2020-06-02 08:00:46Z\&quot;,\&quot;trace_id\&quot;:\&quot;5c4218e1-fa34-4609-bdb6-f3a63a918200\&quot;,\&quot;correlation_id\&quot;:\&quot;6957aeea-d8fd-43b7-bf3f-79c2a3654bde\&quot;,\&quot;error_uri\&quot;:\&quot;https://login.microsoftonline.com/error?code=50148\&quot;}\n&quot;,&quot;highlightedCode&quot;:&quot;\nu\u003cspan class=\&quot;token operator\&quot;\u003e=</span><span class=\&quot;token string\&quot;>'https://login.microsoftonline.com/organizations/oauth2/v2.0/token'</span>\ndata <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token punctuation\&quot;>{</span>\n    <span class=\&quot;token string-property property\&quot;>\&quot;client_id\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;47a5a26f-13c5-4f59-84f8-6a57b8ede039\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string-property property\&quot;>\&quot;scope\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;openid\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string-property property\&quot;>\&quot;grant_type\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;authorization_code\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string-property property\&quot;>\&quot;redirect_uri\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;http://localhost:3000/\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string-property property\&quot;>\&quot;code\&quot;</span><span class=\&quot;token operator\&quot;>:</span> code\n  <span class=\&quot;token punctuation\&quot;>}</span>\n\n<span class=\&quot;token keyword\&quot;>let</span> urlEncodedDataPairs <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token punctuation\&quot;>[</span><span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token keyword\&quot;>for</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token keyword\&quot;>let</span> name <span class=\&quot;token keyword\&quot;>in</span> data <span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token punctuation\&quot;>{</span>\n    urlEncodedDataPairs<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>push</span><span class=\&quot;token punctuation\&quot;>(</span> <span class=\&quot;token function\&quot;>encodeURIComponent</span><span class=\&quot;token punctuation\&quot;>(</span> name <span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token operator\&quot;>+</span> <span class=\&quot;token string\&quot;>'='</span> <span class=\&quot;token operator\&quot;>+</span> <span class=\&quot;token function\&quot;>encodeURIComponent</span><span class=\&quot;token punctuation\&quot;>(</span> data<span class=\&quot;token punctuation\&quot;>[</span>name<span class=\&quot;token punctuation\&quot;>]</span> <span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token punctuation\&quot;>}</span>\nurlEncodedData <span class=\&quot;token operator\&quot;>=</span> urlEncodedDataPairs<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>join</span><span class=\&quot;token punctuation\&quot;>(</span> <span class=\&quot;token string\&quot;>'&amp;amp;'</span> <span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>replace</span><span class=\&quot;token punctuation\&quot;>(</span> <span class=\&quot;token regex\&quot;><span class=\&quot;token regex-delimiter\&quot;>/</span><span class=\&quot;token regex-source language-regex\&quot;>%20</span><span class=\&quot;token regex-delimiter\&quot;>/</span><span class=\&quot;token regex-flags\&quot;>g</span></span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token string\&quot;>'+'</span> <span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n\n<span class=\&quot;token keyword\&quot;>var</span> request <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token keyword\&quot;>new</span> <span class=\&quot;token class-name\&quot;>XMLHttpRequest</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\nrequest<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>addEventListener</span><span class=\&quot;token punctuation\&quot;>(</span> <span class=\&quot;token string\&quot;>'load'</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token keyword\&quot;>function</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>event</span><span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token punctuation\&quot;>{</span>\n  console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>event<span class=\&quot;token punctuation\&quot;>.</span>target<span class=\&quot;token punctuation\&quot;>.</span>response<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\nrequest<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>open</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;POST\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>u<span class=\&quot;token punctuation\&quot;>)</span>\nrequest<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>setRequestHeader</span><span class=\&quot;token punctuation\&quot;>(</span> <span class=\&quot;token string\&quot;>'Content-Type'</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token string\&quot;>'application/x-www-form-urlencoded'</span> <span class=\&quot;token punctuation\&quot;>)</span>\n\nrequest<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>send</span><span class=\&quot;token punctuation\&quot;>(</span>urlEncodedData<span class=\&quot;token punctuation\&quot;>)</span>\n\n<span class=\&quot;token comment\&quot;>//{\&quot;error\&quot;:\&quot;invalid_grant\&quot;,\&quot;error_description\&quot;:\&quot;AADSTS50148: The code_verifier does not match the code_challenge supplied in the authorization request for PKCE.\\r\\nTrace ID: 5c4218e1-fa34-4609-bdb6-f3a63a918200\\r\\nCorrelation ID: 6957aeea-d8fd-43b7-bf3f-79c2a3654bde\\r\\nTimestamp: 2020-06-02 08:00:46Z\&quot;,\&quot;error_codes\&quot;:[50148],\&quot;timestamp\&quot;:\&quot;2020-06-02 08:00:46Z\&quot;,\&quot;trace_id\&quot;:\&quot;5c4218e1-fa34-4609-bdb6-f3a63a918200\&quot;,\&quot;correlation_id\&quot;:\&quot;6957aeea-d8fd-43b7-bf3f-79c2a3654bde\&quot;,\&quot;error_uri\&quot;:\&quot;https://login.microsoftonline.com/error?code=50148\&quot;}</span>\n&quot;}">u<span class="token operator">=</span><span class="token string">'https://login.microsoftonline.com/organizations/oauth2/v2.0/token'</span>data <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token string-property property">"client_id"</span><span class="token operator">:</span> <span class="token string">"47a5a26f-13c5-4f59-84f8-6a57b8ede039"</span><span class="token punctuation">,</span>    <span class="token string-property property">"scope"</span><span class="token operator">:</span> <span class="token string">"openid"</span><span class="token punctuation">,</span>    <span class="token string-property property">"grant_type"</span><span class="token operator">:</span> <span class="token string">"authorization_code"</span><span class="token punctuation">,</span>    <span class="token string-property property">"redirect_uri"</span><span class="token operator">:</span> <span class="token string">"http://localhost:3000/"</span><span class="token punctuation">,</span>    <span class="token string-property property">"code"</span><span class="token operator">:</span> code  <span class="token punctuation">}</span><span class="token keyword">let</span> urlEncodedDataPairs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> name <span class="token keyword">in</span> data <span class="token punctuation">)</span> <span class="token punctuation">{</span>    urlEncodedDataPairs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span> name <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'='</span> <span class="token operator">+</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span> data<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>urlEncodedData <span class="token operator">=</span> urlEncodedDataPairs<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span> <span class="token string">'&amp;'</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">%20</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'+'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>request<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span> <span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>request<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">,</span>u<span class="token punctuation">)</span>request<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span> <span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'application/x-www-form-urlencoded'</span> <span class="token punctuation">)</span>request<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>urlEncodedData<span class="token punctuation">)</span><span class="token comment">//{"error":"invalid_grant","error_description":"AADSTS50148: The code_verifier does not match the code_challenge supplied in the authorization request for PKCE.\r\nTrace ID: 5c4218e1-fa34-4609-bdb6-f3a63a918200\r\nCorrelation ID: 6957aeea-d8fd-43b7-bf3f-79c2a3654bde\r\nTimestamp: 2020-06-02 08:00:46Z","error_codes":[50148],"timestamp":"2020-06-02 08:00:46Z","trace_id":"5c4218e1-fa34-4609-bdb6-f3a63a918200","correlation_id":"6957aeea-d8fd-43b7-bf3f-79c2a3654bde","error_uri":"https://login.microsoftonline.com/error?code=50148"}</span></code></pre><h3 id="AADSTS900144-ã‚¨ãƒ©ãƒ¼"><a href="#AADSTS900144-ã‚¨ãƒ©ãƒ¼" class="headerlink" title="AADSTS900144 ã‚¨ãƒ©ãƒ¼"></a>AADSTS900144 ã‚¨ãƒ©ãƒ¼</h3><p>code_challenge ãŒãªã„ AuthZ ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ã¦ã¿ã‚‹ã¨ AADSTS900144 ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã€‚</p><pre class="language-http" style="" tabindex="0"><code id="8ccce53e" class="language-http" data-prism-hydrate="{&quot;element&quot;:&quot;8ccce53e&quot;,&quot;language&quot;:&quot;http&quot;,&quot;code&quot;:&quot;\nhttps://login.microsoftonline.com/organizations/oauth2/v2.0/authorize?\n\nresponse_type=code\u0026\nscope=openid%20profile%20user.read%20offline_access&amp;\nclient_id=47a5a26f-13c5-4f59-84f8-6a57b8ede039&amp;\nredirect_uri=http%3A%2F%2Flocalhost%3A3000%2F&amp;\nstate=d57b6054-1930-422d-b707-fe840584790c&amp;\nnonce=2babda35-58fd-4d5c-9381-ed174e9214d3&amp;\nresponse_mode=fragment\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token header\&quot;\u003e<span class=\&quot;token header-name keyword\&quot;>https</span><span class=\&quot;token punctuation\&quot;>:</span><span class=\&quot;token header-value\&quot;>//login.microsoftonline.com/organizations/oauth2/v2.0/authorize?</span></span>\n\nresponse_type=code&amp;amp;\nscope=openid%20profile%20user.read%20offline_access&amp;amp;\nclient_id=47a5a26f-13c5-4f59-84f8-6a57b8ede039&amp;amp;\nredirect_uri=http%3A%2F%2Flocalhost%3A3000%2F&amp;amp;\nstate=d57b6054-1930-422d-b707-fe840584790c&amp;amp;\nnonce=2babda35-58fd-4d5c-9381-ed174e9214d3&amp;amp;\nresponse_mode=fragment\n&quot;}"><span class="token header"><span class="token header-name keyword">https</span><span class="token punctuation">:</span><span class="token header-value">//login.microsoftonline.com/organizations/oauth2/v2.0/authorize?</span></span>response_type=code&amp;scope=openid%20profile%20user.read%20offline_access&amp;client_id=47a5a26f-13c5-4f59-84f8-6a57b8ede039&amp;redirect_uri=http%3A%2F%2Flocalhost%3A3000%2F&amp;state=d57b6054-1930-422d-b707-fe840584790c&amp;nonce=2babda35-58fd-4d5c-9381-ed174e9214d3&amp;response_mode=fragment</code></pre><p><img src="/2020/06/02/aad-spa-auth-code-grant-with-pkce/AADSTS900144.png"></p><h3 id="AADSTS9002327-ã‚¨ãƒ©ãƒ¼"><a href="#AADSTS9002327-ã‚¨ãƒ©ãƒ¼" class="headerlink" title="AADSTS9002327 ã‚¨ãƒ©ãƒ¼"></a>AADSTS9002327 ã‚¨ãƒ©ãƒ¼</h3><p>Code ã‚’å–å¾—ã—ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã® XHR ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã¯ãªãã€PowerShell ãªã©ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦ã¿ã‚‹ã¨ã€AADSTS9002327 ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã€‚ã©ã“è¦‹ã¦ã‚‹ã‚“ã ã‚ã€ã‚ã‚“ã¾æ¤œè¨¼ã—ã¦ãªã„ã€‚</p><pre class="language-powershell" style="" tabindex="0"><code id="cbb0b63d" class="language-powershell" data-prism-hydrate="{&quot;element&quot;:&quot;cbb0b63d&quot;,&quot;language&quot;:&quot;powershell&quot;,&quot;code&quot;:&quot;\n$clientId = \u002747a5a26f-13c5-4f59-84f8-6a57b8ede039'\n$redirectUri='https://localhost:3000/'\n$tenantId = \&quot;organization\&quot;\n$tokenEndpont = \&quot;https://login.microsoftonline.com/$tenantId/oauth2/v2.0/token\&quot;\n$scope = \&quot;openid profile user.read offline_access\&quot;\n\n$code='0.ASsArFzjubin3Ui...'\n$codeVerifier = 'NUJGSXpNM1VEazlHVW9vYXRWb0o5RDJSTXI2Q1l3WGI'\n\n$postParams = @{\n    client_id = $clientId;\n    redirect_uri=$redirectUri;\n    grant_type = 'authorization_code';\n    scope = $scope;\n    code=$code;\n    code_verifier=$codeVerifier;\n}\n\n$body = (Invoke-WebRequest -Uri $tokenEndpont -Method POST -Body $postParams) | ConvertFrom-Json\n\n#Invoke-WebRequest : {\&quot;error\&quot;:\&quot;invalid_request\&quot;,\&quot;error_description\&quot;:\&quot;AADSTS9002327: Tokens issued for the 'Single-Page Application' client-type may only be redeemed via cross-origin requests.\\r\\nTrace ID: c739...\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token variable\&quot;\u003e$clientId</span> = <span class=\&quot;token string\&quot;>'47a5a26f-13c5-4f59-84f8-6a57b8ede039'</span>\n<span class=\&quot;token variable\&quot;>$redirectUri</span>=<span class=\&quot;token string\&quot;>'https://localhost:3000/'</span>\n<span class=\&quot;token variable\&quot;>$tenantId</span> = <span class=\&quot;token string\&quot;>\&quot;organization\&quot;</span>\n<span class=\&quot;token variable\&quot;>$tokenEndpont</span> = <span class=\&quot;token string\&quot;>\&quot;https://login.microsoftonline.com/<span class=\&quot;token variable\&quot;>$tenantId</span>/oauth2/v2.0/token\&quot;</span>\n<span class=\&quot;token variable\&quot;>$scope</span> = <span class=\&quot;token string\&quot;>\&quot;openid profile user.read offline_access\&quot;</span>\n\n<span class=\&quot;token variable\&quot;>$code</span>=<span class=\&quot;token string\&quot;>'0.ASsArFzjubin3Ui...'</span>\n<span class=\&quot;token variable\&quot;>$codeVerifier</span> = <span class=\&quot;token string\&quot;>'NUJGSXpNM1VEazlHVW9vYXRWb0o5RDJSTXI2Q1l3WGI'</span>\n\n<span class=\&quot;token variable\&quot;>$postParams</span> = @<span class=\&quot;token punctuation\&quot;>{</span>\n    client_id = <span class=\&quot;token variable\&quot;>$clientId</span><span class=\&quot;token punctuation\&quot;>;</span>\n    redirect_uri=<span class=\&quot;token variable\&quot;>$redirectUri</span><span class=\&quot;token punctuation\&quot;>;</span>\n    grant_type = <span class=\&quot;token string\&quot;>'authorization_code'</span><span class=\&quot;token punctuation\&quot;>;</span>\n    scope = <span class=\&quot;token variable\&quot;>$scope</span><span class=\&quot;token punctuation\&quot;>;</span>\n    code=<span class=\&quot;token variable\&quot;>$code</span><span class=\&quot;token punctuation\&quot;>;</span>\n    code_verifier=<span class=\&quot;token variable\&quot;>$codeVerifier</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token punctuation\&quot;>}</span>\n\n<span class=\&quot;token variable\&quot;>$body</span> = <span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token function\&quot;>Invoke-WebRequest</span> <span class=\&quot;token operator\&quot;>-</span>Uri <span class=\&quot;token variable\&quot;>$tokenEndpont</span> <span class=\&quot;token operator\&quot;>-</span>Method POST <span class=\&quot;token operator\&quot;>-</span>Body <span class=\&quot;token variable\&quot;>$postParams</span><span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token punctuation\&quot;>|</span> <span class=\&quot;token function\&quot;>ConvertFrom-Json</span>\n\n<span class=\&quot;token comment\&quot;>#Invoke-WebRequest : {\&quot;error\&quot;:\&quot;invalid_request\&quot;,\&quot;error_description\&quot;:\&quot;AADSTS9002327: Tokens issued for the 'Single-Page Application' client-type may only be redeemed via cross-origin requests.\\r\\nTrace ID: c739...</span>\n&quot;}"><span class="token variable">$clientId</span> = <span class="token string">'47a5a26f-13c5-4f59-84f8-6a57b8ede039'</span><span class="token variable">$redirectUri</span>=<span class="token string">'https://localhost:3000/'</span><span class="token variable">$tenantId</span> = <span class="token string">"organization"</span><span class="token variable">$tokenEndpont</span> = <span class="token string">"https://login.microsoftonline.com/<span class="token variable">$tenantId</span>/oauth2/v2.0/token"</span><span class="token variable">$scope</span> = <span class="token string">"openid profile user.read offline_access"</span><span class="token variable">$code</span>=<span class="token string">'0.ASsArFzjubin3Ui...'</span><span class="token variable">$codeVerifier</span> = <span class="token string">'NUJGSXpNM1VEazlHVW9vYXRWb0o5RDJSTXI2Q1l3WGI'</span><span class="token variable">$postParams</span> = @<span class="token punctuation">{</span>    client_id = <span class="token variable">$clientId</span><span class="token punctuation">;</span>    redirect_uri=<span class="token variable">$redirectUri</span><span class="token punctuation">;</span>    grant_type = <span class="token string">'authorization_code'</span><span class="token punctuation">;</span>    scope = <span class="token variable">$scope</span><span class="token punctuation">;</span>    code=<span class="token variable">$code</span><span class="token punctuation">;</span>    code_verifier=<span class="token variable">$codeVerifier</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token variable">$body</span> = <span class="token punctuation">(</span><span class="token function">Invoke-WebRequest</span> <span class="token operator">-</span>Uri <span class="token variable">$tokenEndpont</span> <span class="token operator">-</span>Method POST <span class="token operator">-</span>Body <span class="token variable">$postParams</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">ConvertFrom-Json</span><span class="token comment">#Invoke-WebRequest : {"error":"invalid_request","error_description":"AADSTS9002327: Tokens issued for the 'Single-Page Application' client-type may only be redeemed via cross-origin requests.\r\nTrace ID: c739...</span></code></pre><h3 id="ãŠã¾ã‘-AADSTS50076-ã‚¨ãƒ©ãƒ¼"><a href="#ãŠã¾ã‘-AADSTS50076-ã‚¨ãƒ©ãƒ¼" class="headerlink" title="(ãŠã¾ã‘) AADSTS50076 ã‚¨ãƒ©ãƒ¼"></a>(ãŠã¾ã‘) AADSTS50076 ã‚¨ãƒ©ãƒ¼</h3><p>IP ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã£ã¤ã‚Šé•ã†ã¨ã“ã‹ã‚‰ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ã£ã¦ã¿ã‚‹ã¨ã€AADSTS50076 ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã€‚AIP ãŒæœ‰åŠ¹ã˜ã‚ƒãªã„ã¨å‡ºãªã„ã£ã½ã„ã€‚</p><pre class="language-js" style="" tabindex="0"><code id="0f304a3f" class="language-js" data-prism-hydrate="{&quot;element&quot;:&quot;0f304a3f&quot;,&quot;language&quot;:&quot;js&quot;,&quot;code&quot;:&quot;\nu=\u0027https://login.microsoftonline.com/organizations/oauth2/v2.0/token'\ndata = {\n    \&quot;scope\&quot;: \&quot;openid\&quot;,\n    \&quot;grant_type\&quot;: \&quot;refresh_token\&quot;,\n    \&quot;redirect_uri\&quot;: \&quot;http://localhost:3000/\&quot;,\n    \&quot;refresh_token\&quot;: refresh_token\n  }\n\nlet urlEncodedDataPairs = [];\nfor(let name in data ) {\n    urlEncodedDataPairs.push( encodeURIComponent( name ) + '=' + encodeURIComponent( data[name] ) );\n}\nurlEncodedData = urlEncodedDataPairs.join( '\u0026' ).replace( /%20/g, '+' );\n\nvar request = new XMLHttpRequest()\nrequest.addEventListener( 'load', function(event) {\n  console.log(event.target.response);\n});\nrequest.open(\&quot;POST\&quot;,u)\nrequest.setRequestHeader( 'Content-Type', 'application/x-www-form-urlencoded' )\n\nrequest.send(urlEncodedData)\n// {\&quot;error\&quot;:\&quot;invalid_grant\&quot;,\&quot;error_description\&quot;:\&quot;AADSTS50076: Due to a configuration change made by your administrator, or because you moved to a new location, you must use multi-factor authentication to access '00000003-0000-0000-c000-000000000000'.\\r\\nTrace ID: 4fa9c1ce...\n&quot;,&quot;highlightedCode&quot;:&quot;\nu\u003cspan class=\&quot;token operator\&quot;\u003e=</span><span class=\&quot;token string\&quot;>'https://login.microsoftonline.com/organizations/oauth2/v2.0/token'</span>\ndata <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token punctuation\&quot;>{</span>\n    <span class=\&quot;token string-property property\&quot;>\&quot;scope\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;openid\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string-property property\&quot;>\&quot;grant_type\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;refresh_token\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string-property property\&quot;>\&quot;redirect_uri\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;http://localhost:3000/\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token string-property property\&quot;>\&quot;refresh_token\&quot;</span><span class=\&quot;token operator\&quot;>:</span> refresh_token\n  <span class=\&quot;token punctuation\&quot;>}</span>\n\n<span class=\&quot;token keyword\&quot;>let</span> urlEncodedDataPairs <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token punctuation\&quot;>[</span><span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token keyword\&quot;>for</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token keyword\&quot;>let</span> name <span class=\&quot;token keyword\&quot;>in</span> data <span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token punctuation\&quot;>{</span>\n    urlEncodedDataPairs<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>push</span><span class=\&quot;token punctuation\&quot;>(</span> <span class=\&quot;token function\&quot;>encodeURIComponent</span><span class=\&quot;token punctuation\&quot;>(</span> name <span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token operator\&quot;>+</span> <span class=\&quot;token string\&quot;>'='</span> <span class=\&quot;token operator\&quot;>+</span> <span class=\&quot;token function\&quot;>encodeURIComponent</span><span class=\&quot;token punctuation\&quot;>(</span> data<span class=\&quot;token punctuation\&quot;>[</span>name<span class=\&quot;token punctuation\&quot;>]</span> <span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token punctuation\&quot;>}</span>\nurlEncodedData <span class=\&quot;token operator\&quot;>=</span> urlEncodedDataPairs<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>join</span><span class=\&quot;token punctuation\&quot;>(</span> <span class=\&quot;token string\&quot;>'&amp;amp;'</span> <span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>replace</span><span class=\&quot;token punctuation\&quot;>(</span> <span class=\&quot;token regex\&quot;><span class=\&quot;token regex-delimiter\&quot;>/</span><span class=\&quot;token regex-source language-regex\&quot;>%20</span><span class=\&quot;token regex-delimiter\&quot;>/</span><span class=\&quot;token regex-flags\&quot;>g</span></span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token string\&quot;>'+'</span> <span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n\n<span class=\&quot;token keyword\&quot;>var</span> request <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token keyword\&quot;>new</span> <span class=\&quot;token class-name\&quot;>XMLHttpRequest</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\nrequest<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>addEventListener</span><span class=\&quot;token punctuation\&quot;>(</span> <span class=\&quot;token string\&quot;>'load'</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token keyword\&quot;>function</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>event</span><span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token punctuation\&quot;>{</span>\n  console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>event<span class=\&quot;token punctuation\&quot;>.</span>target<span class=\&quot;token punctuation\&quot;>.</span>response<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\nrequest<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>open</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;POST\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>u<span class=\&quot;token punctuation\&quot;>)</span>\nrequest<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>setRequestHeader</span><span class=\&quot;token punctuation\&quot;>(</span> <span class=\&quot;token string\&quot;>'Content-Type'</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token string\&quot;>'application/x-www-form-urlencoded'</span> <span class=\&quot;token punctuation\&quot;>)</span>\n\nrequest<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>send</span><span class=\&quot;token punctuation\&quot;>(</span>urlEncodedData<span class=\&quot;token punctuation\&quot;>)</span>\n<span class=\&quot;token comment\&quot;>// {\&quot;error\&quot;:\&quot;invalid_grant\&quot;,\&quot;error_description\&quot;:\&quot;AADSTS50076: Due to a configuration change made by your administrator, or because you moved to a new location, you must use multi-factor authentication to access '00000003-0000-0000-c000-000000000000'.\\r\\nTrace ID: 4fa9c1ce...</span>\n&quot;}">u<span class="token operator">=</span><span class="token string">'https://login.microsoftonline.com/organizations/oauth2/v2.0/token'</span>data <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token string-property property">"scope"</span><span class="token operator">:</span> <span class="token string">"openid"</span><span class="token punctuation">,</span>    <span class="token string-property property">"grant_type"</span><span class="token operator">:</span> <span class="token string">"refresh_token"</span><span class="token punctuation">,</span>    <span class="token string-property property">"redirect_uri"</span><span class="token operator">:</span> <span class="token string">"http://localhost:3000/"</span><span class="token punctuation">,</span>    <span class="token string-property property">"refresh_token"</span><span class="token operator">:</span> refresh_token  <span class="token punctuation">}</span><span class="token keyword">let</span> urlEncodedDataPairs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> name <span class="token keyword">in</span> data <span class="token punctuation">)</span> <span class="token punctuation">{</span>    urlEncodedDataPairs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span> name <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'='</span> <span class="token operator">+</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span> data<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>urlEncodedData <span class="token operator">=</span> urlEncodedDataPairs<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span> <span class="token string">'&amp;'</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">%20</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'+'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>request<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span> <span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>request<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">,</span>u<span class="token punctuation">)</span>request<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span> <span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'application/x-www-form-urlencoded'</span> <span class="token punctuation">)</span>request<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>urlEncodedData<span class="token punctuation">)</span><span class="token comment">// {"error":"invalid_grant","error_description":"AADSTS50076: Due to a configuration change made by your administrator, or because you moved to a new location, you must use multi-factor authentication to access '00000003-0000-0000-c000-000000000000'.\r\nTrace ID: 4fa9c1ce...</span></code></pre>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Authorization Code Flow with PKCE ã«å¯¾å¿œã—ãŸ MSAL.js 2.x ãŒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ã„ãŸã®ã§ã€è§¦ã£ã¦ã¿ãŸãƒ¡ãƒ¢ã€‚&lt;/p&gt;
&lt;h2 id=&quot;Azure-ãƒãƒ¼ã‚¿ãƒ«ã®ã‚¢ãƒ—ãƒªã®ç™»éŒ²ç”»é¢&quot;&gt;&lt;a href=&quot;#Azure-ãƒãƒ¼ã‚¿ãƒ«ã®ã‚¢ãƒ—ãƒªã®ç™»éŒ²ç”»é¢&quot; class=&quot;headerlink&quot; title=&quot;Azure ãƒãƒ¼ã‚¿ãƒ«ã®ã‚¢ãƒ—ãƒªã®ç™»éŒ²ç”»é¢&quot;&gt;&lt;/a&gt;Azure ãƒãƒ¼ã‚¿ãƒ«ã®ã‚¢ãƒ—ãƒªã®ç™»éŒ²ç”»é¢&lt;/h2&gt;&lt;p&gt;Azure AD ã®ã‚¢ãƒ—ãƒªç™»éŒ²ã®ç”»é¢ãŒã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ãŠã‚Šã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ URI ã®ç™»éŒ²ã« SPA ãŒè¿½åŠ ã•ã‚Œã¦ã„ãŸã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Azure" scheme="http://blog.haniyama.com/tags/Azure/"/>
    
      <category term="OAuth" scheme="http://blog.haniyama.com/tags/OAuth/"/>
    
  </entry>
  
  <entry>
    <title>Azure Storage Blob ã« Content-Type ä»˜ãã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹</title>
    <link href="http://blog.haniyama.com/2020/04/30/azure-storage-blob-content-type-nodejs/"/>
    <id>http://blog.haniyama.com/2020/04/30/azure-storage-blob-content-type-nodejs/</id>
    <published>2020-04-30T13:15:38.000Z</published>
    <updated>2022-05-18T13:45:28.994Z</updated>
    
    <content type="html"><![CDATA[<p>åŠå¹´ã« 1 å›ãã‚‰ã„ Azure Storage Blob ã‚’è§¦ã‚‹ã‚“ã ã‘ã©ã€æ¯å› Content-Type ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ã®ã‚’å¿˜ã‚Œã¦ãƒãƒã£ã¦ã„ã‚‹ã€‚<br>ä»Šå›ã¯ nodejs ã§æ›¸ã„ãŸã®ã§ã€å¿˜ã‚Œãªã„ã‚ˆã†ã«ãƒ¡ãƒ¢ã€‚</p><p>ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦ <code>@azure/storage-blob</code> ã‚’ä½¿ã†ã€‚ã‚ã¨ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ã®ãŸã‚ã« <code>glob</code> ã‚‚ã¤ã‹ã†ã€‚</p><span id="more"></span><pre class="language-js" style="" tabindex="0"><code id="eed0213e" class="language-js" data-prism-hydrate="{&quot;element&quot;:&quot;eed0213e&quot;,&quot;language&quot;:&quot;js&quot;,&quot;code&quot;:&quot;\nnpm install -S @azure/storage-blob glob\n&quot;,&quot;highlightedCode&quot;:&quot;\nnpm install \u003cspan class=\&quot;token operator\&quot;\u003e-</span><span class=\&quot;token constant\&quot;>S</span> @azure<span class=\&quot;token operator\&quot;>/</span>storage<span class=\&quot;token operator\&quot;>-</span>blob glob\n&quot;}">npm install <span class="token operator">-</span><span class="token constant">S</span> @azure<span class="token operator">/</span>storage<span class="token operator">-</span>blob glob</code></pre><p>ã¨ã‚Šã‚ãˆãšãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã€‚</p><pre class="language-js" style="" tabindex="0"><code id="caa8d63e" class="language-js" data-prism-hydrate="{&quot;element&quot;:&quot;caa8d63e&quot;,&quot;language&quot;:&quot;js&quot;,&quot;code&quot;:&quot;\nconst mime = require(\&quot;mime\&quot;);\nconst { BlobServiceClient } = require(\&quot;@azure/storage-blob\&quot;);\n\nconst AZURE_STORAGE_CONNECTION_STRING = \&quot;DefaultEndpointsProtocol=https;AccountName=xxxx;AccountKey=xxxxx;EndpointSuffix=core.windows.net\&quot;;\nconst fileName = \&quot;./file.html\&quot;;\nconst containerName = \&quot;$web\&quot;;\n\nasync function uploadToBlob(fileName) {\n  const blobServiceClient = await BlobServiceClient.fromConnectionString(\n    AZURE_STORAGE_CONNECTION_STRING\n  );\n\n  const containerClient = await blobServiceClient.getContainerClient(\n    containerName\n  );\n\n  const blockBlobClient = containerClient.getBlockBlobClient(\&quot;file.html\&quot;);\n  const data = fs.readFileSync(fileName);\n  const contentType = mime.getType(fileName);\n  const options = {\n    blobHTTPHeaders: {\n      blobContentType: contentType,\n    },\n  };\n\n  return await blockBlobClient.upload(data, data.length, options);\n}\n\nuploadToBlob(fileName)\n  .then((result) =\u003e console.log(result))\n  .catch((e) => console.error(e));\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token keyword\&quot;>const</span> mime <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token function\&quot;>require</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;mime\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token keyword\&quot;>const</span> <span class=\&quot;token punctuation\&quot;>{</span> BlobServiceClient <span class=\&quot;token punctuation\&quot;>}</span> <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token function\&quot;>require</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;@azure/storage-blob\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n\n<span class=\&quot;token keyword\&quot;>const</span> <span class=\&quot;token constant\&quot;>AZURE_STORAGE_CONNECTION_STRING</span> <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token string\&quot;>\&quot;DefaultEndpointsProtocol=https;AccountName=xxxx;AccountKey=xxxxx;EndpointSuffix=core.windows.net\&quot;</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token keyword\&quot;>const</span> fileName <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token string\&quot;>\&quot;./file.html\&quot;</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token keyword\&quot;>const</span> containerName <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token string\&quot;>\&quot;$web\&quot;</span><span class=\&quot;token punctuation\&quot;>;</span>\n\n<span class=\&quot;token keyword\&quot;>async</span> <span class=\&quot;token keyword\&quot;>function</span> <span class=\&quot;token function\&quot;>uploadToBlob</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>fileName</span><span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token punctuation\&quot;>{</span>\n  <span class=\&quot;token keyword\&quot;>const</span> blobServiceClient <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token keyword\&quot;>await</span> BlobServiceClient<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>fromConnectionString</span><span class=\&quot;token punctuation\&quot;>(</span>\n    <span class=\&quot;token constant\&quot;>AZURE_STORAGE_CONNECTION_STRING</span>\n  <span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n\n  <span class=\&quot;token keyword\&quot;>const</span> containerClient <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token keyword\&quot;>await</span> blobServiceClient<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>getContainerClient</span><span class=\&quot;token punctuation\&quot;>(</span>\n    containerName\n  <span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n\n  <span class=\&quot;token keyword\&quot;>const</span> blockBlobClient <span class=\&quot;token operator\&quot;>=</span> containerClient<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>getBlockBlobClient</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;file.html\&quot;</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n  <span class=\&quot;token keyword\&quot;>const</span> data <span class=\&quot;token operator\&quot;>=</span> fs<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>readFileSync</span><span class=\&quot;token punctuation\&quot;>(</span>fileName<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n  <span class=\&quot;token keyword\&quot;>const</span> contentType <span class=\&quot;token operator\&quot;>=</span> mime<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>getType</span><span class=\&quot;token punctuation\&quot;>(</span>fileName<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n  <span class=\&quot;token keyword\&quot;>const</span> options <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token punctuation\&quot;>{</span>\n    <span class=\&quot;token literal-property property\&quot;>blobHTTPHeaders</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>{</span>\n      <span class=\&quot;token literal-property property\&quot;>blobContentType</span><span class=\&quot;token operator\&quot;>:</span> contentType<span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>;</span>\n\n  <span class=\&quot;token keyword\&quot;>return</span> <span class=\&quot;token keyword\&quot;>await</span> blockBlobClient<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>upload</span><span class=\&quot;token punctuation\&quot;>(</span>data<span class=\&quot;token punctuation\&quot;>,</span> data<span class=\&quot;token punctuation\&quot;>.</span>length<span class=\&quot;token punctuation\&quot;>,</span> options<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token punctuation\&quot;>}</span>\n\n<span class=\&quot;token function\&quot;>uploadToBlob</span><span class=\&quot;token punctuation\&quot;>(</span>fileName<span class=\&quot;token punctuation\&quot;>)</span>\n  <span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>result</span><span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>result<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n  <span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>catch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>e</span><span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>error</span><span class=\&quot;token punctuation\&quot;>(</span>e<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n&quot;}"><span class="token keyword">const</span> mime <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"mime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token punctuation">{</span> BlobServiceClient <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"@azure/storage-blob"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token constant">AZURE_STORAGE_CONNECTION_STRING</span> <span class="token operator">=</span> <span class="token string">"DefaultEndpointsProtocol=https;AccountName=xxxx;AccountKey=xxxxx;EndpointSuffix=core.windows.net"</span><span class="token punctuation">;</span><span class="token keyword">const</span> fileName <span class="token operator">=</span> <span class="token string">"./file.html"</span><span class="token punctuation">;</span><span class="token keyword">const</span> containerName <span class="token operator">=</span> <span class="token string">"$web"</span><span class="token punctuation">;</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">uploadToBlob</span><span class="token punctuation">(</span><span class="token parameter">fileName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> blobServiceClient <span class="token operator">=</span> <span class="token keyword">await</span> BlobServiceClient<span class="token punctuation">.</span><span class="token function">fromConnectionString</span><span class="token punctuation">(</span>    <span class="token constant">AZURE_STORAGE_CONNECTION_STRING</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> containerClient <span class="token operator">=</span> <span class="token keyword">await</span> blobServiceClient<span class="token punctuation">.</span><span class="token function">getContainerClient</span><span class="token punctuation">(</span>    containerName  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> blockBlobClient <span class="token operator">=</span> containerClient<span class="token punctuation">.</span><span class="token function">getBlockBlobClient</span><span class="token punctuation">(</span><span class="token string">"file.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> data <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> contentType <span class="token operator">=</span> mime<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token literal-property property">blobHTTPHeaders</span><span class="token operator">:</span> <span class="token punctuation">{</span>      <span class="token literal-property property">blobContentType</span><span class="token operator">:</span> contentType<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">await</span> blockBlobClient<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> data<span class="token punctuation">.</span>length<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">uploadToBlob</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>ãƒã‚¤ãƒ³ãƒˆã¯ mime ã§ Content-Type ã‚’åˆ¤åˆ¥ã—ã¦ã€blobContentType ã«çªã£è¾¼ã‚€ã€ã£ã¦ã“ã‚Œæ™®é€šã« node ã‚„ã£ã¦ã‚‹äººã‹ã‚‰ã—ãŸã‚ãŸã‚Šã¾ãˆãªã®ã‹ãªã€‚å…¬å¼ã‚µãƒ³ãƒ—ãƒ«ç„¡ã„ã®ãªã‚“ã§ãªã‚“ã ã‚â€¦ ã™ã”ã„æ‚©ã‚“ã ã€‚</p><p>ã¾ã¨ã‚ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹æ™‚ã¯ glob ä½¿ã£ã¦ã“ã‚“ãªæ„Ÿã˜ã€‚</p><pre class="language-js" style="" tabindex="0"><code id="ed008e3d" class="language-js" data-prism-hydrate="{&quot;element&quot;:&quot;ed008e3d&quot;,&quot;language&quot;:&quot;js&quot;,&quot;code&quot;:&quot;\nasync function uploadFolderToBlob() {\n  const blobServiceClient = await BlobServiceClient.fromConnectionString(\n    AZURE_STORAGE_CONNECTION_STRING\n  );\n\n  const containerClient = await blobServiceClient.getContainerClient(\n    containerName\n  );\n\n  return Promise.all(\n    glob(\&quot;./public/**/*.*\&quot;, { nodir: true, sync: true }).map(async (fileName) =\u003e {\n      console.log(fileName);\n      const blockBlobClient = containerClient.getBlockBlobClient(fileName);\n      const data = fs.readFileSync(fileName);\n      const contentType = mime.getType(fileName);\n      const options = {\n        blobHTTPHeaders: {\n          blobContentType: contentType,\n        },\n      };\n      return await blockBlobClient.upload(data, data.length, options);\n    })\n  );\n}\n\nuploadFolderToBlob()\n  .then((results) => console.log(results))\n  .catch((e) => console.error(e));\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token keyword\&quot;>async</span> <span class=\&quot;token keyword\&quot;>function</span> <span class=\&quot;token function\&quot;>uploadFolderToBlob</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token punctuation\&quot;>{</span>\n  <span class=\&quot;token keyword\&quot;>const</span> blobServiceClient <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token keyword\&quot;>await</span> BlobServiceClient<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>fromConnectionString</span><span class=\&quot;token punctuation\&quot;>(</span>\n    <span class=\&quot;token constant\&quot;>AZURE_STORAGE_CONNECTION_STRING</span>\n  <span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n\n  <span class=\&quot;token keyword\&quot;>const</span> containerClient <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token keyword\&quot;>await</span> blobServiceClient<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>getContainerClient</span><span class=\&quot;token punctuation\&quot;>(</span>\n    containerName\n  <span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n\n  <span class=\&quot;token keyword\&quot;>return</span> Promise<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>all</span><span class=\&quot;token punctuation\&quot;>(</span>\n    <span class=\&quot;token function\&quot;>glob</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>\&quot;./public/**/*.*\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token punctuation\&quot;>{</span> <span class=\&quot;token literal-property property\&quot;>nodir</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token boolean\&quot;>true</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token literal-property property\&quot;>sync</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token boolean\&quot;>true</span> <span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>map</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token keyword\&quot;>async</span> <span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>fileName</span><span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token operator\&quot;>=></span> <span class=\&quot;token punctuation\&quot;>{</span>\n      console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>fileName<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n      <span class=\&quot;token keyword\&quot;>const</span> blockBlobClient <span class=\&quot;token operator\&quot;>=</span> containerClient<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>getBlockBlobClient</span><span class=\&quot;token punctuation\&quot;>(</span>fileName<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n      <span class=\&quot;token keyword\&quot;>const</span> data <span class=\&quot;token operator\&quot;>=</span> fs<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>readFileSync</span><span class=\&quot;token punctuation\&quot;>(</span>fileName<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n      <span class=\&quot;token keyword\&quot;>const</span> contentType <span class=\&quot;token operator\&quot;>=</span> mime<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>getType</span><span class=\&quot;token punctuation\&quot;>(</span>fileName<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n      <span class=\&quot;token keyword\&quot;>const</span> options <span class=\&quot;token operator\&quot;>=</span> <span class=\&quot;token punctuation\&quot;>{</span>\n        <span class=\&quot;token literal-property property\&quot;>blobHTTPHeaders</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>{</span>\n          <span class=\&quot;token literal-property property\&quot;>blobContentType</span><span class=\&quot;token operator\&quot;>:</span> contentType<span class=\&quot;token punctuation\&quot;>,</span>\n        <span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>,</span>\n      <span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>;</span>\n      <span class=\&quot;token keyword\&quot;>return</span> <span class=\&quot;token keyword\&quot;>await</span> blockBlobClient<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>upload</span><span class=\&quot;token punctuation\&quot;>(</span>data<span class=\&quot;token punctuation\&quot;>,</span> data<span class=\&quot;token punctuation\&quot;>.</span>length<span class=\&quot;token punctuation\&quot;>,</span> options<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n    <span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>)</span>\n  <span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n<span class=\&quot;token punctuation\&quot;>}</span>\n\n<span class=\&quot;token function\&quot;>uploadFolderToBlob</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>)</span>\n  <span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>then</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>results</span><span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>log</span><span class=\&quot;token punctuation\&quot;>(</span>results<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span>\n  <span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>catch</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token parameter\&quot;>e</span><span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token operator\&quot;>=></span> console<span class=\&quot;token punctuation\&quot;>.</span><span class=\&quot;token function\&quot;>error</span><span class=\&quot;token punctuation\&quot;>(</span>e<span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>)</span><span class=\&quot;token punctuation\&quot;>;</span>\n&quot;}"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">uploadFolderToBlob</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> blobServiceClient <span class="token operator">=</span> <span class="token keyword">await</span> BlobServiceClient<span class="token punctuation">.</span><span class="token function">fromConnectionString</span><span class="token punctuation">(</span>    <span class="token constant">AZURE_STORAGE_CONNECTION_STRING</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> containerClient <span class="token operator">=</span> <span class="token keyword">await</span> blobServiceClient<span class="token punctuation">.</span><span class="token function">getContainerClient</span><span class="token punctuation">(</span>    containerName  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>    <span class="token function">glob</span><span class="token punctuation">(</span><span class="token string">"./public/**/*.*"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">nodir</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">sync</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">fileName</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">const</span> blockBlobClient <span class="token operator">=</span> containerClient<span class="token punctuation">.</span><span class="token function">getBlockBlobClient</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">const</span> data <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">const</span> contentType <span class="token operator">=</span> mime<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>        <span class="token literal-property property">blobHTTPHeaders</span><span class="token operator">:</span> <span class="token punctuation">{</span>          <span class="token literal-property property">blobContentType</span><span class="token operator">:</span> contentType<span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token punctuation">}</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">await</span> blockBlobClient<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> data<span class="token punctuation">.</span>length<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">uploadFolderToBlob</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><code>Promise.all()</code> ã§ Promise ã®ãƒªã‚¹ãƒˆã‚’åŒ…ã‚“ã§ã‚„ã‚‹ã®ãŒãƒã‚¤ãƒ³ãƒˆã€‚ç›¸å¤‰ã‚ã‚‰ãšéåŒæœŸå‡¦ç†ã®æ›¸ãæ–¹ãŒåˆ†ã‹ã£ã¦ãªã„ã®ã§ã€ã„ã¤ã‚‚ã‚°ã‚°ã‚ŠãªãŒã‚‰æ›¸ã„ã¦ã‚‹ã€‚<br>è©¦ã—ãŸæ„Ÿã˜ fileName ãŒ <code>./path/to/file</code> ã¿ãŸããªã£ã¦ã‚‚ã€ã„ã„æ„Ÿã˜ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã‚Œã‚‹ã‚‰ã—ã„ã€‚<br>(ä¸Šè¨˜ã®ä¾‹ã ã¨ <code>$web/path/to/file</code> ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹)</p><p>ä»Šå¹´ã‚‚ 1&#x2F;3 ãŒçµ‚ã‚ã£ã¦ã—ã¾ã£ãŸã€‚ãã‚ãã‚ Azure AD B2C ã®ã‚«ã‚¹ã‚¿ãƒ  ãƒãƒªã‚·ãƒ¼ã®ã¾ã¨ã‚ãƒã‚¿ã‚’æ›¸ããŸã„ã‘ã©ã€ç›¸å¤‰ã‚ã‚‰ãšå…¨ç„¶ã‚ã‹ã‚‰ã‚“ã®ã§ã¡ã‚‡ã„ãƒã‚¿ã§ãƒ–ãƒ­ã‚°æ›´æ–°ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åŠå¹´ã« 1 å›ãã‚‰ã„ Azure Storage Blob ã‚’è§¦ã‚‹ã‚“ã ã‘ã©ã€æ¯å› Content-Type ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ã®ã‚’å¿˜ã‚Œã¦ãƒãƒã£ã¦ã„ã‚‹ã€‚&lt;br&gt;ä»Šå›ã¯ nodejs ã§æ›¸ã„ãŸã®ã§ã€å¿˜ã‚Œãªã„ã‚ˆã†ã«ãƒ¡ãƒ¢ã€‚&lt;/p&gt;
&lt;p&gt;ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦ &lt;code&gt;@azure/storage-blob&lt;/code&gt; ã‚’ä½¿ã†ã€‚ã‚ã¨ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ã®ãŸã‚ã« &lt;code&gt;glob&lt;/code&gt; ã‚‚ã¤ã‹ã†ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Azure" scheme="http://blog.haniyama.com/tags/Azure/"/>
    
      <category term="javascript" scheme="http://blog.haniyama.com/tags/javascript/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD ã§ OAuth/OIDC ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹</title>
    <link href="http://blog.haniyama.com/2020/02/16/customize-aad-token-claims/"/>
    <id>http://blog.haniyama.com/2020/02/16/customize-aad-token-claims/</id>
    <published>2020-02-16T09:24:36.000Z</published>
    <updated>2022-05-18T13:45:29.042Z</updated>
    
    <content type="html"><![CDATA[<p>Azure AD ãŒç™ºè¡Œã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹æ–¹æ³•ã‚’å°‘ã—èª¿ã¹ãŸã®ã§ãƒ¡ãƒ¢ã€‚</p><h2 id="ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º"><a href="#ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º" class="headerlink" title="ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º"></a>ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</h2><p>ãã‚‚ãã‚‚ Azure AD ã®ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚’ã™ã‚‹ç†ç”±ã¨ã—ã¦ã¯å¤§ããåˆ†ã‘ã‚‹ã¨ä»¥ä¸‹ã® 2 ã¤ã ã¨æ€ã†ã€‚</p><ol><li>é€£æºã‚¢ãƒ—ãƒªã«å¯¾ã—ã¦ç™ºè¡Œã™ã‚‹ <strong>ID ãƒˆãƒ¼ã‚¯ãƒ³</strong> ã®å±æ€§ã‚’è¿½åŠ ãƒ»æ—¢å­˜ã®å±æ€§ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã€‚</li><li>Azure AD ã«ç™»éŒ²ã—ãŸ Web API ã‚’åˆ©ç”¨ã™ã‚‹ç”¨ã« <strong>ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³</strong> ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã€‚</li></ol><p>å‰è€…ã¯ã‚¢ãƒ—ãƒªå´ã§ Azure AD ã®å±æ€§ã‚’ä½¿ã„ãŸã„å ´åˆã«åˆ©ç”¨ã™ã‚‹ã€‚</p><span id="more"></span><h3 id="ID-ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º"><a href="#ID-ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º" class="headerlink" title="ID ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º"></a>ID ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</h3><p>ãŸã¨ãˆã°æ‰€å±ã—ã¦ã„ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã‚„ã€ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹å¦ã‹ã€ç‰¹å®šã® Role ã‚’æŒã£ã¦ã„ã‚‹ã‹ãªã©ã¨ã„ã£ãŸæƒ…å ±ã‚’ã€é€£æºã‚¢ãƒ—ãƒªã«æ¸¡ã™ãŸã‚ã« ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’åˆ©ç”¨ã™ã‚‹ã€‚<br>MS Graph ã§å–å¾—ã§ãã‚‹æƒ…å ±ã‚‚ã‚ã‚‹ã¨æ€ã†ãŒã€ã‚¢ãƒ—ãƒªå´ã§ Graph ã‚’å©ãå¿…è¦ãŒãªã„ã®ã¨ã€èªè¨¼æ™‚ã®çŠ¶æ…‹ã‚’å–å¾—ã§ãã‚‹ã®ã§å¿…è¦ã«å¿œã˜ã¦ä½¿ã„ã‚ã‘ã‚Œã°ã„ã„ã®ã‹ã¨æ€ã†ã€‚</p><h3 id="ã‚¢ã‚¯ã‚»ã‚¹-ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º"><a href="#ã‚¢ã‚¯ã‚»ã‚¹-ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º" class="headerlink" title="ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º"></a>ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</h3><p>å¾Œè€…ã¯ RBAC ãªã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’ Azure AD ãŒã‚‚ã¤å±æ€§ã‚’ãƒ™ãƒ¼ã‚¹ã«è¡Œã„ãŸã„ã¨ãã«åˆ©ç”¨ã§ãã‚‹ã€‚<br>ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã®ã¿ã®ã‚¢ãƒ—ãƒªã§ã‚ã‚Œã° ID ãƒˆãƒ¼ã‚¯ãƒ³ã«å«ã‚ãŸå€¤ã‚’ä½¿ãˆã°è‰¯ã„ã—ã€ã‚¹ã‚³ãƒ¼ãƒ—ã‚’æŒ‡å®šã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã«å«ã‚ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã€‚</p><p>ã‚ã¾ã‚Šã«æƒ…å ±ã‚’è©°ã‚è¾¼ã¿ã™ãã‚‹ã¨ã€query ã§é€ã‚‹å ´åˆã¯ URL ã‚¯ã‚¨ãƒªãƒ¼ã®é•·ã•åˆ¶é™ã«å¼•ã£ã‹ã‹ã‚‹ã®ã§ãã®ç‚¹ã¯æ°—ã‚’ä»˜ã‘ãŸã»ã†ãŒè‰¯ã•ãã†ã€‚<br>è¨­å®šã®ä»•æ–¹è‡ªä½“ã¯ ID ãƒˆãƒ¼ã‚¯ãƒ³ã€ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³å…±ã«å¤§ããå·®ã¯ãªã„ã¯ãšã ã‘ã©ã€ã™ã¹ã¦æ¤œè¨¼ã—ãŸã‚ã‘ã˜ã‚ƒãªã„ã®ã§ã©ã£ã‹ã«ç½ ãŒã‚ã‚‹ã‹ã‚‚ã€‚</p><h2 id="ãƒˆãƒ¼ã‚¯ãƒ³-ã®å±æ€§ã‚’è¿½åŠ ãƒ»æ—¢å­˜ã®å±æ€§ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹"><a href="#ãƒˆãƒ¼ã‚¯ãƒ³-ã®å±æ€§ã‚’è¿½åŠ ãƒ»æ—¢å­˜ã®å±æ€§ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹" class="headerlink" title="ãƒˆãƒ¼ã‚¯ãƒ³ ã®å±æ€§ã‚’è¿½åŠ ãƒ»æ—¢å­˜ã®å±æ€§ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹"></a>ãƒˆãƒ¼ã‚¯ãƒ³ ã®å±æ€§ã‚’è¿½åŠ ãƒ»æ—¢å­˜ã®å±æ€§ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹</h2><h3 id="å±æ€§ã‚’è¿½åŠ ã™ã‚‹"><a href="#å±æ€§ã‚’è¿½åŠ ã™ã‚‹" class="headerlink" title="å±æ€§ã‚’è¿½åŠ ã™ã‚‹"></a>å±æ€§ã‚’è¿½åŠ ã™ã‚‹</h3><p>å‚è€ƒ: <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/active-directory-optional-claims">Azure AD ã‚¢ãƒ—ãƒªã«çœç•¥å¯èƒ½ãªè¦æ±‚ã‚’æä¾›ã™ã‚‹ - Microsoft identity platform | Microsoft Docs</a></p><p>ãƒˆãƒ¼ã‚¯ãƒ³ã«å±æ€§ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ã‚¢ãƒ—ãƒªã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ç·¨é›†ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸãŒã€æœ€è¿‘ Azure ãƒãƒ¼ã‚¿ãƒ«ä¸Šã® GUI ã§ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚<br>å…·ä½“çš„ã«ã¯ <code>Azure Active Directory</code> &gt; <code>ã‚¢ãƒ—ãƒªã®ç™»éŒ²</code> &gt; å¯¾è±¡ã‚¢ãƒ—ãƒªã® <code>ãƒˆãƒ¼ã‚¯ãƒ³æ§‹æˆ (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼)</code> ã‹ã‚‰ã€è¿½åŠ ã®ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’é¸æŠã™ã‚‹ã€‚</p><p><img src="/2020/02/16/customize-aad-token-claims/optional-claims.png"></p><p>ã¨ã‚Šã‚ãˆãšã€å…¨éƒ¨é¸æŠã—ã¦ ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ã¦ã¿ãŸãŒã€ãƒ‡ãƒã‚¤ã‚¹ç™»éŒ²ã—ãªã‘ã‚Œã°å–å¾—ã§ããªã„å±æ€§ã‚„ã‚ªãƒ³ãƒ—ãƒ¬ã‹ã‚‰ã®åŒæœŸå±æ€§ã‚‚ã‚ã‚Šã€ã‚¯ãƒ©ã‚¦ãƒ‰ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å–å¾—ã§ããŸã®ã¯ã“ã‚Œã ã‘ã€‚</p><pre class="language-json" style="" tabindex="0"><code id="8378933e" class="language-json" data-prism-hydrate="{&quot;element&quot;:&quot;8378933e&quot;,&quot;language&quot;:&quot;json&quot;,&quot;code&quot;:&quot;\n{\n  \&quot;aud\&quot;: \&quot;815680bb-ebc9-4e5f-a594-f2c55b83bb27\&quot;,\n  \&quot;iss\&quot;: \&quot;https://login.microsoftonline.com/b9e35cac-a7b8-48dd-a102-bba18eaca524/v2.0\&quot;,\n  \&quot;iat\&quot;: 1581832899,\n  \&quot;nbf\&quot;: 1581832899,\n  \&quot;exp\&quot;: 1581836799,\n  \&quot;family_name\&quot;: \&quot;example\&quot;,\n  \&quot;given_name\&quot;: \&quot;watahani\&quot;,\n  \&quot;auth_time\&quot;: 1581833193,//èªè¨¼æ™‚åˆ»\n  \&quot;acct\&quot;: 0,//ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç¨®é¡ ã‚²ã‚¹ãƒˆã®å ´åˆ 1\n  \&quot;ipaddr\&quot;: \&quot;xxx.249.32.yyy\&quot;, //IP ã‚¢ãƒ‰ãƒ¬ã‚¹\n  \&quot;platf\&quot;: \&quot;3\&quot;, //ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€Win/macOS ãªã©å…¥ã‚‹ã£ã½ã„ã€‚3 ã¯ç„¡ã—ï¼Ÿ\n  \&quot;xms_tpl\&quot;: \&quot;ja\&quot;,//Tenant Preferred Language\n  \&quot;tenant_ctry\&quot;: \&quot;JP\&quot;, //ãƒ†ãƒŠãƒ³ãƒˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® country code\n  \&quot;tenant_region_scope\&quot;: \&quot;AS\&quot;, //ãƒªãƒ¼ã‚¸ãƒ§ãƒ³\n  \&quot;sid\&quot;: \&quot;f18a735d-0753-4de7-b038-fa1f84fc3751\&quot;,//ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID\n  //ã„ã¤ã‚‚ã®\n  \&quot;name\&quot;: \&quot;example watahani\&quot;,\n  \&quot;nonce\&quot;: \&quot;defaultNonce\&quot;,\n  \&quot;oid\&quot;: \&quot;992f309f-2fab-45fa-9e56-f02216d2e0a7\&quot;,\n  \&quot;preferred_username\&quot;: \&quot;example@watahani.com\&quot;,\n  \&quot;sub\&quot;: \&quot;TDuey17YS4iCKyTxdnT-sx5P6juRfTbiiN4FrnaYqn4\&quot;,\n  \&quot;tid\&quot;: \&quot;b9e35cac-a7b8-48dd-a102-bba18eaca524\&quot;, \n  \&quot;upn\&quot;: \&quot;example@watahani.com\&quot;, \n  \&quot;ver\&quot;: \&quot;2.0\&quot;\n}\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token punctuation\&quot;\u003e{</span>\n  <span class=\&quot;token property\&quot;>\&quot;aud\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;815680bb-ebc9-4e5f-a594-f2c55b83bb27\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;iss\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;https://login.microsoftonline.com/b9e35cac-a7b8-48dd-a102-bba18eaca524/v2.0\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;iat\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token number\&quot;>1581832899</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;nbf\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token number\&quot;>1581832899</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;exp\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token number\&quot;>1581836799</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;family_name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;example\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;given_name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;watahani\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;auth_time\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token number\&quot;>1581833193</span><span class=\&quot;token punctuation\&quot;>,</span><span class=\&quot;token comment\&quot;>//èªè¨¼æ™‚åˆ»</span>\n  <span class=\&quot;token property\&quot;>\&quot;acct\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token number\&quot;>0</span><span class=\&quot;token punctuation\&quot;>,</span><span class=\&quot;token comment\&quot;>//ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç¨®é¡ ã‚²ã‚¹ãƒˆã®å ´åˆ 1</span>\n  <span class=\&quot;token property\&quot;>\&quot;ipaddr\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;xxx.249.32.yyy\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token comment\&quot;>//IP ã‚¢ãƒ‰ãƒ¬ã‚¹</span>\n  <span class=\&quot;token property\&quot;>\&quot;platf\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;3\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token comment\&quot;>//ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€Win/macOS ãªã©å…¥ã‚‹ã£ã½ã„ã€‚3 ã¯ç„¡ã—ï¼Ÿ</span>\n  <span class=\&quot;token property\&quot;>\&quot;xms_tpl\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;ja\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span><span class=\&quot;token comment\&quot;>//Tenant Preferred Language</span>\n  <span class=\&quot;token property\&quot;>\&quot;tenant_ctry\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;JP\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token comment\&quot;>//ãƒ†ãƒŠãƒ³ãƒˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® country code</span>\n  <span class=\&quot;token property\&quot;>\&quot;tenant_region_scope\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;AS\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> <span class=\&quot;token comment\&quot;>//ãƒªãƒ¼ã‚¸ãƒ§ãƒ³</span>\n  <span class=\&quot;token property\&quot;>\&quot;sid\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;f18a735d-0753-4de7-b038-fa1f84fc3751\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span><span class=\&quot;token comment\&quot;>//ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID</span>\n  <span class=\&quot;token comment\&quot;>//ã„ã¤ã‚‚ã®</span>\n  <span class=\&quot;token property\&quot;>\&quot;name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;example watahani\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;nonce\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;defaultNonce\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;oid\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;992f309f-2fab-45fa-9e56-f02216d2e0a7\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;preferred_username\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;example@watahani.com\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;sub\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;TDuey17YS4iCKyTxdnT-sx5P6juRfTbiiN4FrnaYqn4\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;tid\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;b9e35cac-a7b8-48dd-a102-bba18eaca524\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> \n  <span class=\&quot;token property\&quot;>\&quot;upn\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;example@watahani.com\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span> \n  <span class=\&quot;token property\&quot;>\&quot;ver\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;2.0\&quot;</span>\n<span class=\&quot;token punctuation\&quot;>}</span>\n&quot;}"><span class="token punctuation">{</span>  <span class="token property">"aud"</span><span class="token operator">:</span> <span class="token string">"815680bb-ebc9-4e5f-a594-f2c55b83bb27"</span><span class="token punctuation">,</span>  <span class="token property">"iss"</span><span class="token operator">:</span> <span class="token string">"https://login.microsoftonline.com/b9e35cac-a7b8-48dd-a102-bba18eaca524/v2.0"</span><span class="token punctuation">,</span>  <span class="token property">"iat"</span><span class="token operator">:</span> <span class="token number">1581832899</span><span class="token punctuation">,</span>  <span class="token property">"nbf"</span><span class="token operator">:</span> <span class="token number">1581832899</span><span class="token punctuation">,</span>  <span class="token property">"exp"</span><span class="token operator">:</span> <span class="token number">1581836799</span><span class="token punctuation">,</span>  <span class="token property">"family_name"</span><span class="token operator">:</span> <span class="token string">"example"</span><span class="token punctuation">,</span>  <span class="token property">"given_name"</span><span class="token operator">:</span> <span class="token string">"watahani"</span><span class="token punctuation">,</span>  <span class="token property">"auth_time"</span><span class="token operator">:</span> <span class="token number">1581833193</span><span class="token punctuation">,</span><span class="token comment">//èªè¨¼æ™‚åˆ»</span>  <span class="token property">"acct"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">//ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç¨®é¡ ã‚²ã‚¹ãƒˆã®å ´åˆ 1</span>  <span class="token property">"ipaddr"</span><span class="token operator">:</span> <span class="token string">"xxx.249.32.yyy"</span><span class="token punctuation">,</span> <span class="token comment">//IP ã‚¢ãƒ‰ãƒ¬ã‚¹</span>  <span class="token property">"platf"</span><span class="token operator">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token comment">//ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€Win/macOS ãªã©å…¥ã‚‹ã£ã½ã„ã€‚3 ã¯ç„¡ã—ï¼Ÿ</span>  <span class="token property">"xms_tpl"</span><span class="token operator">:</span> <span class="token string">"ja"</span><span class="token punctuation">,</span><span class="token comment">//Tenant Preferred Language</span>  <span class="token property">"tenant_ctry"</span><span class="token operator">:</span> <span class="token string">"JP"</span><span class="token punctuation">,</span> <span class="token comment">//ãƒ†ãƒŠãƒ³ãƒˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® country code</span>  <span class="token property">"tenant_region_scope"</span><span class="token operator">:</span> <span class="token string">"AS"</span><span class="token punctuation">,</span> <span class="token comment">//ãƒªãƒ¼ã‚¸ãƒ§ãƒ³</span>  <span class="token property">"sid"</span><span class="token operator">:</span> <span class="token string">"f18a735d-0753-4de7-b038-fa1f84fc3751"</span><span class="token punctuation">,</span><span class="token comment">//ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID</span>  <span class="token comment">//ã„ã¤ã‚‚ã®</span>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"example watahani"</span><span class="token punctuation">,</span>  <span class="token property">"nonce"</span><span class="token operator">:</span> <span class="token string">"defaultNonce"</span><span class="token punctuation">,</span>  <span class="token property">"oid"</span><span class="token operator">:</span> <span class="token string">"992f309f-2fab-45fa-9e56-f02216d2e0a7"</span><span class="token punctuation">,</span>  <span class="token property">"preferred_username"</span><span class="token operator">:</span> <span class="token string">"example@watahani.com"</span><span class="token punctuation">,</span>  <span class="token property">"sub"</span><span class="token operator">:</span> <span class="token string">"TDuey17YS4iCKyTxdnT-sx5P6juRfTbiiN4FrnaYqn4"</span><span class="token punctuation">,</span>  <span class="token property">"tid"</span><span class="token operator">:</span> <span class="token string">"b9e35cac-a7b8-48dd-a102-bba18eaca524"</span><span class="token punctuation">,</span>   <span class="token property">"upn"</span><span class="token operator">:</span> <span class="token string">"example@watahani.com"</span><span class="token punctuation">,</span>   <span class="token property">"ver"</span><span class="token operator">:</span> <span class="token string">"2.0"</span><span class="token punctuation">}</span></code></pre><p>ç°¡å˜ã§ã™ã­ã€‚</p><h3 id="ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ã‚¯ãƒ¬ãƒ¼ãƒ ã«å«ã‚ã‚‹"><a href="#ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ã‚¯ãƒ¬ãƒ¼ãƒ ã«å«ã‚ã‚‹" class="headerlink" title="ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ã‚¯ãƒ¬ãƒ¼ãƒ ã«å«ã‚ã‚‹"></a>ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ã‚¯ãƒ¬ãƒ¼ãƒ ã«å«ã‚ã‚‹</h3><p>Azure AD ã§æ‰€å±ã—ã¦ã„ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã€‚</p><p><img src="/2020/02/16/customize-aad-token-claims/groups-claims.png"></p><p>ID ãƒˆãƒ¼ã‚¯ãƒ³ã«å‡ºåŠ›ã•ã‚Œã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚</p><pre class="language-json" style="" tabindex="0"><code id="94e2173f" class="language-json" data-prism-hydrate="{&quot;element&quot;:&quot;94e2173f&quot;,&quot;language&quot;:&quot;json&quot;,&quot;code&quot;:&quot;\n{\n    \&quot;groups\&quot;: [\n    \&quot;ebeac31c-d21e-40bd-8cac-06ce217b2bcc\&quot; //group ã® objectId\n  ],\n} \n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token punctuation\&quot;\u003e{</span>\n    <span class=\&quot;token property\&quot;>\&quot;groups\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>[</span>\n    <span class=\&quot;token string\&quot;>\&quot;ebeac31c-d21e-40bd-8cac-06ce217b2bcc\&quot;</span> <span class=\&quot;token comment\&quot;>//group ã® objectId</span>\n  <span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>,</span>\n<span class=\&quot;token punctuation\&quot;>}</span> \n&quot;}"><span class="token punctuation">{</span>    <span class="token property">"groups"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token string">"ebeac31c-d21e-40bd-8cac-06ce217b2bcc"</span> <span class="token comment">//group ã® objectId</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">}</span> </code></pre><p>ãŸã ã—ã€ã‚°ãƒ«ãƒ¼ãƒ—ã¯ Object ID ã§å‡ºåŠ›ã•ã‚Œã‚‹ã®ã§ Group åã¨ã‹å¼•ã£å¼µã£ã¦ãã‚‹ã«ã¯ Graph ã‚’å©ãå¿…è¦ãŒã‚ã‚‹ã€‚<br><code>ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ãƒ­ãƒ¼ãƒ«è¦æ±‚ã¨ã—ã¦ç”Ÿæˆã™ã‚‹</code> ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€groups ã§ã¯ãªã roles ã¨ã—ã¦å‡ºåŠ›ã•ã‚Œã‚‹ã€‚</p><pre class="language-json" style="" tabindex="0"><code id="3d5c483e" class="language-json" data-prism-hydrate="{&quot;element&quot;:&quot;3d5c483e&quot;,&quot;language&quot;:&quot;json&quot;,&quot;code&quot;:&quot;\n{\n  \&quot;roles\&quot;: [\n    \&quot;ebeac31c-d21e-40bd-8cac-06ce217b2bcc\&quot;\n  ],\n}\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token punctuation\&quot;\u003e{</span>\n  <span class=\&quot;token property\&quot;>\&quot;roles\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>[</span>\n    <span class=\&quot;token string\&quot;>\&quot;ebeac31c-d21e-40bd-8cac-06ce217b2bcc\&quot;</span>\n  <span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>,</span>\n<span class=\&quot;token punctuation\&quot;>}</span>\n&quot;}"><span class="token punctuation">{</span>  <span class="token property">"roles"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token string">"ebeac31c-d21e-40bd-8cac-06ce217b2bcc"</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">}</span></code></pre><p>ã“ã‚Œã€ã‚°ãƒ«ãƒ¼ãƒ—ãŒã»ã‚“ã¨ã«å¤§é‡ã«ã‚ã‚‹çµ„ç¹”ã§ä½¿ã£ãŸã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ãƒ‰ã‚¨ãƒ©ã‚¤ã“ã¨ã«ãªã‚Šãã†ã§ã™ã­ã€‚</p><h3 id="å±æ€§ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹"><a href="#å±æ€§ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹" class="headerlink" title="å±æ€§ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹"></a>å±æ€§ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹</h3><p>ã‚ã¾ã‚Šæ©Ÿä¼šã¯ãªã„ã‹ã‚‚ã—ã‚Œãªã„ãŒã€æ—¢å­˜ã®å±æ€§ã‚’ä¸Šæ›¸ãã—ãŸã„ã“ã¨ã‚‚ã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚<br>Azure AD ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã†ä»¥ä¸Šã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å±æ€§ã‚’ä½¿ã†ã®ãŒè‰¯ã„ã¨æ€ã†ãŒã€ã‚„ã‚“ã”ã¨ãªãç†ç”±ã«ã‚ˆã‚Šæ—¢å­˜ã®å±æ€§ã‚’ä¸Šæ›¸ãã™ã‚‹ã«ã¯ Claim Mapping Policy ã‚’åˆ©ç”¨ã™ã‚‹ã€‚</p><pre class="language-powershell" style="" tabindex="0"><code id="ada2683f" class="language-powershell" data-prism-hydrate="{&quot;element&quot;:&quot;ada2683f&quot;,&quot;language&quot;:&quot;powershell&quot;,&quot;code&quot;:&quot;\nInstall-Module AzureADPreview\nConnect-AzureAD\n\n# name å±æ€§ã« UPN ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆ\n$policy = New-AzureADPolicy -Definition @(\u0027{\&quot;ClaimsMappingPolicy\&quot;:{\&quot;Version\&quot;:1,\&quot;IncludeBasicClaimSet\&quot;:\&quot;true\&quot;, \&quot;ClaimsSchema\&quot;: [{\&quot;Source\&quot;:\&quot;user\&quot;,\&quot;ID\&quot;:\&quot;userprincipalname\&quot;,\&quot;JwtClaimType\&quot;:\&quot;name\&quot;}]}}') -DisplayName \&quot;JwtClaimMappingUPNAsName\&quot; -Type \&quot;ClaimsMappingPolicy\&quot;;\n\n$sp = Get-AzureADServicePrincipal -Filter \&quot;DisplayName eq 'Optional Claims'\&quot;;\n\nAdd-AzureADServicePrincipalPolicy -Id $sp.ObjectId -RefObjectId  $policy.Id\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token function\&quot;\u003eInstall-Module</span> AzureADPreview\n<span class=\&quot;token function\&quot;>Connect-AzureAD</span>\n\n<span class=\&quot;token comment\&quot;># name å±æ€§ã« UPN ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆ</span>\n<span class=\&quot;token variable\&quot;>$policy</span> = <span class=\&quot;token function\&quot;>New-AzureADPolicy</span> <span class=\&quot;token operator\&quot;>-</span>Definition @<span class=\&quot;token punctuation\&quot;>(</span><span class=\&quot;token string\&quot;>'{\&quot;ClaimsMappingPolicy\&quot;:{\&quot;Version\&quot;:1,\&quot;IncludeBasicClaimSet\&quot;:\&quot;true\&quot;, \&quot;ClaimsSchema\&quot;: [{\&quot;Source\&quot;:\&quot;user\&quot;,\&quot;ID\&quot;:\&quot;userprincipalname\&quot;,\&quot;JwtClaimType\&quot;:\&quot;name\&quot;}]}}'</span><span class=\&quot;token punctuation\&quot;>)</span> <span class=\&quot;token operator\&quot;>-</span>DisplayName <span class=\&quot;token string\&quot;>\&quot;JwtClaimMappingUPNAsName\&quot;</span> <span class=\&quot;token operator\&quot;>-</span><span class=\&quot;token function\&quot;>Type</span> <span class=\&quot;token string\&quot;>\&quot;ClaimsMappingPolicy\&quot;</span><span class=\&quot;token punctuation\&quot;>;</span>\n\n<span class=\&quot;token variable\&quot;>$sp</span> = <span class=\&quot;token function\&quot;>Get-AzureADServicePrincipal</span> <span class=\&quot;token operator\&quot;>-</span><span class=\&quot;token keyword\&quot;>Filter</span> <span class=\&quot;token string\&quot;>\&quot;DisplayName eq 'Optional Claims'\&quot;</span><span class=\&quot;token punctuation\&quot;>;</span>\n\n<span class=\&quot;token function\&quot;>Add-AzureADServicePrincipalPolicy</span> <span class=\&quot;token operator\&quot;>-</span>Id <span class=\&quot;token variable\&quot;>$sp</span><span class=\&quot;token punctuation\&quot;>.</span>ObjectId <span class=\&quot;token operator\&quot;>-</span>RefObjectId  <span class=\&quot;token variable\&quot;>$policy</span><span class=\&quot;token punctuation\&quot;>.</span>Id\n&quot;}"><span class="token function">Install-Module</span> AzureADPreview<span class="token function">Connect-AzureAD</span><span class="token comment"># name å±æ€§ã« UPN ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆ</span><span class="token variable">$policy</span> = <span class="token function">New-AzureADPolicy</span> <span class="token operator">-</span>Definition @<span class="token punctuation">(</span><span class="token string">'{"ClaimsMappingPolicy":{"Version":1,"IncludeBasicClaimSet":"true", "ClaimsSchema": [{"Source":"user","ID":"userprincipalname","JwtClaimType":"name"}]}}'</span><span class="token punctuation">)</span> <span class="token operator">-</span>DisplayName <span class="token string">"JwtClaimMappingUPNAsName"</span> <span class="token operator">-</span><span class="token function">Type</span> <span class="token string">"ClaimsMappingPolicy"</span><span class="token punctuation">;</span><span class="token variable">$sp</span> = <span class="token function">Get-AzureADServicePrincipal</span> <span class="token operator">-</span><span class="token keyword">Filter</span> <span class="token string">"DisplayName eq 'Optional Claims'"</span><span class="token punctuation">;</span><span class="token function">Add-AzureADServicePrincipalPolicy</span> <span class="token operator">-</span>Id <span class="token variable">$sp</span><span class="token punctuation">.</span>ObjectId <span class="token operator">-</span>RefObjectId  <span class="token variable">$policy</span><span class="token punctuation">.</span>Id</code></pre><p>ãªã‚“ã§ã‚‚ã‹ã‚“ã§ã‚‚ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã‚‹ã®ã§ã¯ãªãã€åŸºæœ¬è¦æ±‚ã‚»ãƒƒãƒˆã¨å‘¼ã°ã‚Œã‚‹ã‚¯ãƒ¬ãƒ¼ãƒ ã®ã¿å¤‰æ›´ã§ãã€å¿…é ˆã‚¯ãƒ¬ãƒ¼ãƒ ã‚„ã€<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/active-directory-claims-mapping#table-1-json-web-token-jwt-restricted-claim-set">åˆ¶é™ä»˜ãè¦æ±‚ã‚»ãƒƒãƒˆ</a>ã¯å¤‰æ›´ã§ããªã„ã€‚</p><p>ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã‚µãƒ³ãƒ—ãƒ«ã®ä¾‹ã‚’è€ƒãˆã‚ˆã†ã¨æ€ã£ãŸãŒã€ã‚ªãƒ³ãƒ—ãƒ¬ã®å±æ€§ã‚’ name ãªã©ã®å±æ€§ã«ã„ã‚Œã‚‹ãã‚‰ã„ã—ã‹ä½¿ã„ã©ã“ã‚ãŒæ€ã„ã¤ã‹ãªã‹ã£ãŸã€‚</p><p>ãƒãƒªã‚·ãƒ¼ã‚’å‰²ã‚Šå½“ã¦ãŸçŠ¶æ…‹ã§ã€ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€AADSTS50146 ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã€‚</p><p><img src="/2020/02/16/customize-aad-token-claims/claim-mapping-error.png"></p><blockquote><p>AADSTS50146: This application is required to be configured with an application-specific signing key. It is either not configured with one, or the key has expired or is not yet valid.</p></blockquote><p>æ–‡å­—é€šã‚Šã«èª­ã‚ã°ã€ã‚¢ãƒ—ãƒªç‹¬è‡ªã®ç½²åç”¨ã‚­ãƒ¼ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã²ã¤ã‚ˆã†ãŒã‚ã‚‹ (ã—ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ã§è§£æ¶ˆã‚‚ã§ãã‚‹) ãŒã€ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã«ä»¥ä¸‹ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã‚‚å›é¿ã§ãã‚‹ã€‚</p><pre class="language-json" style="" tabindex="0"><code id="7fec6b3f" class="language-json" data-prism-hydrate="{&quot;element&quot;:&quot;7fec6b3f&quot;,&quot;language&quot;:&quot;json&quot;,&quot;code&quot;:&quot;\n  \&quot;acceptMappedClaims\&quot;: true,\n&quot;,&quot;highlightedCode&quot;:&quot;\n  \u003cspan class=\&quot;token property\&quot;\u003e\&quot;acceptMappedClaims\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token boolean\&quot;>true</span><span class=\&quot;token punctuation\&quot;>,</span>\n&quot;}">  <span class="token property">"acceptMappedClaims"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></code></pre><p><img src="/2020/02/16/customize-aad-token-claims/acceptmappedclaims.png"></p><p>ä¸Šè¨˜ã‚’è¨­å®šã‚’ã€ID ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã™ã‚‹ã¨ã€UPN ãŒ name å±æ€§ã¨ã—ã¦å‡ºåŠ›ã•ã‚ŒãŸã€‚</p><pre class="language-json" style="" tabindex="0"><code id="5ccd7c3f" class="language-json" data-prism-hydrate="{&quot;element&quot;:&quot;5ccd7c3f&quot;,&quot;language&quot;:&quot;json&quot;,&quot;code&quot;:&quot;\n{\n  \&quot;name\&quot;: \&quot;example@watahani.com\&quot;\n}\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token punctuation\&quot;\u003e{</span>\n  <span class=\&quot;token property\&quot;>\&quot;name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;example@watahani.com\&quot;</span>\n<span class=\&quot;token punctuation\&quot;>}</span>\n&quot;}"><span class="token punctuation">{</span>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"example@watahani.com"</span><span class="token punctuation">}</span></code></pre><h2 id="ãƒ­ãƒ¼ãƒ«ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹"><a href="#ãƒ­ãƒ¼ãƒ«ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹" class="headerlink" title="ãƒ­ãƒ¼ãƒ«ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹"></a>ãƒ­ãƒ¼ãƒ«ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹</h2><p>ã‚¢ãƒ—ãƒªç‹¬è‡ªã®ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã€ç®¡ç†ã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã€‚<br>ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ roles ã¨ã™ã‚‹ã“ã¨ã§ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ ã‚°ãƒ«ãƒ¼ãƒ—ã‚„åŒæœŸã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«æ¨©é™ã‚’æ±ºå®šã™ã‚‹ã“ã¨ã‚‚å‡ºæ¥ã‚‹ã®ã§ã€ãã¡ã‚‰ã¨ã®ä½¿ã„åˆ†ã‘ã®ã‚’ã©ã®ã‚ˆã†ã«ã™ã‚‹ã®ã‹ã¯ã£ãã‚Šã¨ç†è§£ã§ãã¦ã¯ã„ãªã„ãŒã€æ‰‹é †ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã€‚</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/howto-add-app-roles-in-azure-ad-apps">ã‚¢ãƒ—ãƒª ãƒ­ãƒ¼ãƒ«ã‚’è¿½åŠ ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰å–å¾—ã™ã‚‹ - Microsoft identity platform | Microsoft Docs</a></li></ul><p>ä¸Šè¨˜ã®è¨˜äº‹ã®é€šã‚Šãªã®ã ãŒã€ã‚¢ãƒ—ãƒªã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã€ã‚ã‚‹ã„ã¯ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã«ãƒ­ãƒ¼ãƒ«ã‚’å®šç¾©ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚<br>ã‚¢ãƒ—ãƒªè‡ªèº«ã®ãƒ­ãƒ¼ãƒ«ã«åŠ ãˆã€Web API ã¨ã—ã¦å…¬é–‹ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦ã‚‚æ¨©é™ã‚’è¨­å®šã§ãã€RBAC ã«ã‚ˆã‚‹ API ã®ç®¡ç†ã«ã‚‚åˆ©ç”¨ã§ãã‚‹ã€‚</p><p>ä»Šå›ã¯ã‚¢ãƒ—ãƒªã‹ã‚‰ã€Web API ã‚’å©ãæƒ³å®šã§ã€æ–°ã—ã„ Web API ã‚’ç™»éŒ²ã—ã¦ã€ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã—ãŸã€‚</p><h3 id="Web-API-ã®ä½œæˆ"><a href="#Web-API-ã®ä½œæˆ" class="headerlink" title="Web API ã®ä½œæˆ"></a>Web API ã®ä½œæˆ</h3><p>é©å½“ã« Web API (RBAC Web API) ã‚’ä½œæˆã—ã€ã‚¹ã‚³ãƒ¼ãƒ—ã¨ã—ã¦ File.Write ã‚’ä½œã‚‹ã€‚<br>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ Consent ã§ãã‚‹ã‚ˆã†ã«ã€ã•ã£ãä½œã£ãŸã‚¢ãƒ—ãƒªã‚’æ‰¿èªæ¸ˆã¿ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ç™»éŒ²ã™ã‚‹ã€‚</p><p><img src="/2020/02/16/customize-aad-token-claims/api-scope.png"></p><p>ãƒ­ãƒ¼ãƒ«ã¯é©å½“ã«ç®¡ç†è€…ã«ã‚ˆã‚‹æ›¸ãè¾¼ã¿ã¨ã€ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹æ›¸ãè¾¼ã¿ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã¦ Write_Ad_Admin ã¨ Write ã‚’è¨­å®šã€‚</p><p><img src="/2020/02/16/customize-aad-token-claims/api-manifest.png"></p><pre class="language-json" style="" tabindex="0"><code id="28a1733e" class="language-json" data-prism-hydrate="{&quot;element&quot;:&quot;28a1733e&quot;,&quot;language&quot;:&quot;json&quot;,&quot;code&quot;:&quot;\n\&quot;appRoles\&quot;: [\n  {\n    \&quot;allowedMemberTypes\&quot;: [\n      \&quot;User\&quot;,\n      \&quot;Application\&quot;\n    ],\n    \&quot;description\&quot;: \&quot;Writer as Administrator\&quot;,\n    \&quot;displayName\&quot;: \&quot;Write_Ad_Admin\&quot;,\n    \&quot;id\&quot;: \&quot;5b2c669d-eee3-406d-8a9b-b98b74cd5018\&quot;,\n    \&quot;isEnabled\&quot;: true,\n    \&quot;lang\&quot;: null,\n    \&quot;origin\&quot;: \&quot;Application\&quot;,\n    \&quot;value\&quot;: \&quot;Write_Ad_Admin\&quot;\n  },\n  {\n    \&quot;allowedMemberTypes\&quot;: [\n      \&quot;User\&quot;\n    ],\n    \&quot;description\&quot;: \&quot;Writer as User\&quot;,\n    \&quot;displayName\&quot;: \&quot;Writer\&quot;,\n    \&quot;id\&quot;: \&quot;66482f6f-d935-4f17-bfcb-32f295d8024b\&quot;,\n    \&quot;isEnabled\&quot;: true,\n    \&quot;lang\&quot;: null,\n    \&quot;origin\&quot;: \&quot;Application\&quot;,\n    \&quot;value\&quot;: \&quot;Writer\&quot;\n  }\n],\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token property\&quot;\u003e\&quot;appRoles\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>[</span>\n  <span class=\&quot;token punctuation\&quot;>{</span>\n    <span class=\&quot;token property\&quot;>\&quot;allowedMemberTypes\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>[</span>\n      <span class=\&quot;token string\&quot;>\&quot;User\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n      <span class=\&quot;token string\&quot;>\&quot;Application\&quot;</span>\n    <span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token property\&quot;>\&quot;description\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;Writer as Administrator\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token property\&quot;>\&quot;displayName\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;Write_Ad_Admin\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token property\&quot;>\&quot;id\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;5b2c669d-eee3-406d-8a9b-b98b74cd5018\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token property\&quot;>\&quot;isEnabled\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token boolean\&quot;>true</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token property\&quot;>\&quot;lang\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token null keyword\&quot;>null</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token property\&quot;>\&quot;origin\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;Application\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token property\&quot;>\&quot;value\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;Write_Ad_Admin\&quot;</span>\n  <span class=\&quot;token punctuation\&quot;>}</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token punctuation\&quot;>{</span>\n    <span class=\&quot;token property\&quot;>\&quot;allowedMemberTypes\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>[</span>\n      <span class=\&quot;token string\&quot;>\&quot;User\&quot;</span>\n    <span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token property\&quot;>\&quot;description\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;Writer as User\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token property\&quot;>\&quot;displayName\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;Writer\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token property\&quot;>\&quot;id\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;66482f6f-d935-4f17-bfcb-32f295d8024b\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token property\&quot;>\&quot;isEnabled\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token boolean\&quot;>true</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token property\&quot;>\&quot;lang\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token null keyword\&quot;>null</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token property\&quot;>\&quot;origin\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;Application\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n    <span class=\&quot;token property\&quot;>\&quot;value\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;Writer\&quot;</span>\n  <span class=\&quot;token punctuation\&quot;>}</span>\n<span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>,</span>\n&quot;}"><span class="token property">"appRoles"</span><span class="token operator">:</span> <span class="token punctuation">[</span>  <span class="token punctuation">{</span>    <span class="token property">"allowedMemberTypes"</span><span class="token operator">:</span> <span class="token punctuation">[</span>      <span class="token string">"User"</span><span class="token punctuation">,</span>      <span class="token string">"Application"</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Writer as Administrator"</span><span class="token punctuation">,</span>    <span class="token property">"displayName"</span><span class="token operator">:</span> <span class="token string">"Write_Ad_Admin"</span><span class="token punctuation">,</span>    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"5b2c669d-eee3-406d-8a9b-b98b74cd5018"</span><span class="token punctuation">,</span>    <span class="token property">"isEnabled"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token property">"lang"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>    <span class="token property">"origin"</span><span class="token operator">:</span> <span class="token string">"Application"</span><span class="token punctuation">,</span>    <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"Write_Ad_Admin"</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span>    <span class="token property">"allowedMemberTypes"</span><span class="token operator">:</span> <span class="token punctuation">[</span>      <span class="token string">"User"</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Writer as User"</span><span class="token punctuation">,</span>    <span class="token property">"displayName"</span><span class="token operator">:</span> <span class="token string">"Writer"</span><span class="token punctuation">,</span>    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"66482f6f-d935-4f17-bfcb-32f295d8024b"</span><span class="token punctuation">,</span>    <span class="token property">"isEnabled"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token property">"lang"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>    <span class="token property">"origin"</span><span class="token operator">:</span> <span class="token string">"Application"</span><span class="token punctuation">,</span>    <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"Writer"</span>  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span></code></pre><h3 id="ãƒ­ãƒ¼ãƒ«ã®å‰²ã‚Šå½“ã¦"><a href="#ãƒ­ãƒ¼ãƒ«ã®å‰²ã‚Šå½“ã¦" class="headerlink" title="ãƒ­ãƒ¼ãƒ«ã®å‰²ã‚Šå½“ã¦"></a>ãƒ­ãƒ¼ãƒ«ã®å‰²ã‚Šå½“ã¦</h3><p>ãã—ã¦ã€å¯¾è±¡ã®ã‚¢ãƒ—ãƒªã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã€‚<br>ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚º ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ <code>RBAC Web API</code> ã‚’é¸æŠã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰ãƒ­ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã€‚</p><p><img src="/2020/02/16/customize-aad-token-claims/assign-group.png"></p><p><del>æ®‹å¿µãªãŒã‚‰ã€ãƒ­ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦ã‚‹ MS Graph API ã¯å­˜åœ¨ã—ãªã„</del> ã®ã§ã€ã“ã®ã‚ãŸã‚Šã®åˆ¶å¾¡ã‚’ã‚¢ãƒ—ãƒªã§è¡Œã†å ´åˆã¯ç‰¹å®šã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‰²ã‚Šå½“ã¦ã¦ãŠã„ã¦ã€ãã‚Œãã‚Œã®ã‚°ãƒ«ãƒ¼ãƒ—ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰²ã‚Šå½“ã¦ã‚‹ãªã©å·¥å¤«ãŒå¿…è¦ãã†ã€‚</p><blockquote><p>è¿½è¨˜ã€ã„ã¤ã®é–“ã«ã‹ API ãŒç”Ÿãˆã¦ã„ãŸã®ã‹ã€æ°—ã¥ã‹ãªã‹ã£ãŸã®ã‹ã€‚<br><a href="https://docs.microsoft.com/ja-jp/graph/api/serviceprincipal-post-approleassignments?view=graph-rest-1.0&tabs=http">https://docs.microsoft.com/ja-jp/graph/api/serviceprincipal-post-approleassignments?view=graph-rest-1.0&amp;tabs=http</a></p></blockquote><blockquote><p><del>ã‚ã‚Œã€ã˜ã‚ƒã‚ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ãã®ã¾ã¾ãƒ­ãƒ¼ãƒ«ã¨ã—ã¦æ‰±ã£ã¦ã—ã¾ãˆã°è‰¯ã„ã®ã§ã¯â€¦ï¼Ÿ</del><br>ã‚°ãƒ«ãƒ¼ãƒ—ãŒ 150 ã‚’è¶…ãˆã‚‹ãªã©ã€ãƒˆãƒ¼ã‚¯ãƒ³ã«å«ã¿åˆ‡ã‚Œãªã„å ´åˆãŒã‚ã‚‹ã—ã€ã‚¢ãƒ—ãƒªç‹¬è‡ªã® Role ã‚’å®šç¾©ã—ãŸã„å ´åˆã‚‚ã‚ã‚‹ã ã‚ã†ã€‚</p></blockquote><p>å®Ÿéš›ã«ã“ã® API ã«å¯¾ã™ã‚‹ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ã€‚</p><p>è¨­å®šã—ãŸãƒ­ãƒ¼ãƒ«ã¯å½“ç„¶ã€<strong>ãã®ã‚¢ãƒ—ãƒªã«å¯¾ã™ã‚‹</strong> ãƒ­ãƒ¼ãƒ«ã§ã‚ã‚‹ã€‚<br>ãã®ãŸã‚ã‚¹ã‚³ãƒ¼ãƒ—ã¨ã—ã¦ãƒ­ãƒ¼ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚</p><pre class="language-txt" style="" tabindex="0"><code id="f6c5203c" class="language-txt" data-prism-hydrate="{&quot;element&quot;:&quot;f6c5203c&quot;,&quot;language&quot;:&quot;txt&quot;,&quot;code&quot;:&quot;\nhttps://login.microsoftonline.com/b9e35cac-a7b8-48dd-a102-bba18eaca524/oauth2/v2.0/authorize?\nclient_id=815680bb-ebc9-4e5f-a594-f2c55b83bb27\n\u0026scope=api://d2213a10-046d-4e07-8643-095dbe5262b3/Files.Write \n&amp;redirect_uri=https%3A%2F%2Fjwt.ms\n&amp;response_type=token\n&quot;,&quot;highlightedCode&quot;:&quot;\nhttps://login.microsoftonline.com/b9e35cac-a7b8-48dd-a102-bba18eaca524/oauth2/v2.0/authorize?\nclient_id=815680bb-ebc9-4e5f-a594-f2c55b83bb27\n&amp;amp;scope=api://d2213a10-046d-4e07-8643-095dbe5262b3/Files.Write \n&amp;amp;redirect_uri=https%3A%2F%2Fjwt.ms\n&amp;amp;response_type=token\n&quot;}">https://login.microsoftonline.com/b9e35cac-a7b8-48dd-a102-bba18eaca524/oauth2/v2.0/authorize?client_id=815680bb-ebc9-4e5f-a594-f2c55b83bb27&amp;scope=api://d2213a10-046d-4e07-8643-095dbe5262b3/Files.Write &amp;redirect_uri=https%3A%2F%2Fjwt.ms&amp;response_type=token</code></pre><p>ã“ã‚Œã€è©¦ã™ã¨ãã€Web API ã¨ã‚¢ãƒ—ãƒªã‚’åŒã˜ã‚‚ã®ã¨ã—ã¦ã„ãŸãŸã‚ã€ã‚¹ã‚³ãƒ¼ãƒ—ã‚’æŒ‡å®šã—å¿˜ã‚Œã¦ãƒ­ãƒ¼ãƒ«ãŒå–ã‚Œãªãã¦ã™ã”ãæ‚©ã‚“ã ã€‚<br>MS Graph API å©ããŸã‚ã®ãƒˆãƒ¼ã‚¯ãƒ³ã«ã¯ã€å½“ç„¶ Roles ã¯å«ã¾ã‚Œãªã„ã€‚</p><p>å–å¾—ã—ãŸã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã«ã¯ãƒ­ãƒ¼ãƒ«ãŒå…¥ã£ã¦ã„ã‚‹ã€‚</p><pre class="language-json" style="" tabindex="0"><code id="ff9f733f" class="language-json" data-prism-hydrate="{&quot;element&quot;:&quot;ff9f733f&quot;,&quot;language&quot;:&quot;json&quot;,&quot;code&quot;:&quot;\n{\n  \&quot;aud\&quot;: \&quot;api://d2213a10-046d-4e07-8643-095dbe5262b3\&quot;,\n  \&quot;iss\&quot;: \&quot;https://sts.windows.net/b9e35cac-a7b8-48dd-a102-bba18eaca524/\&quot;,\n  \&quot;iat\&quot;: 1581840878,\n  \&quot;nbf\&quot;: 1581840878,\n  \&quot;exp\&quot;: 1581844778,\n  \&quot;appid\&quot;: \&quot;815680bb-ebc9-4e5f-a594-f2c55b83bb27\&quot;,\n  \&quot;name\&quot;: \&quot;example watahani\&quot;,\n  \&quot;oid\&quot;: \&quot;992f309f-2fab-45fa-9e56-f02216d2e0a7\&quot;,\n  \&quot;roles\&quot;: [\n    \&quot;Writer\&quot;\n  ],\n  \&quot;scp\&quot;: \&quot;Files.Write\&quot;,\n  \&quot;upn\&quot;: \&quot;example@watahani.com\&quot;,\n  \&quot;uti\&quot;: \&quot;8lfnfIEUUES_MPqR-4okAA\&quot;,\n  \&quot;ver\&quot;: \&quot;1.0\&quot;\n  //ç•¥\n}\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token punctuation\&quot;\u003e{</span>\n  <span class=\&quot;token property\&quot;>\&quot;aud\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;api://d2213a10-046d-4e07-8643-095dbe5262b3\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;iss\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;https://sts.windows.net/b9e35cac-a7b8-48dd-a102-bba18eaca524/\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;iat\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token number\&quot;>1581840878</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;nbf\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token number\&quot;>1581840878</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;exp\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token number\&quot;>1581844778</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;appid\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;815680bb-ebc9-4e5f-a594-f2c55b83bb27\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;name\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;example watahani\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;oid\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;992f309f-2fab-45fa-9e56-f02216d2e0a7\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;roles\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token punctuation\&quot;>[</span>\n    <span class=\&quot;token string\&quot;>\&quot;Writer\&quot;</span>\n  <span class=\&quot;token punctuation\&quot;>]</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;scp\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;Files.Write\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;upn\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;example@watahani.com\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;uti\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;8lfnfIEUUES_MPqR-4okAA\&quot;</span><span class=\&quot;token punctuation\&quot;>,</span>\n  <span class=\&quot;token property\&quot;>\&quot;ver\&quot;</span><span class=\&quot;token operator\&quot;>:</span> <span class=\&quot;token string\&quot;>\&quot;1.0\&quot;</span>\n  <span class=\&quot;token comment\&quot;>//ç•¥</span>\n<span class=\&quot;token punctuation\&quot;>}</span>\n&quot;}"><span class="token punctuation">{</span>  <span class="token property">"aud"</span><span class="token operator">:</span> <span class="token string">"api://d2213a10-046d-4e07-8643-095dbe5262b3"</span><span class="token punctuation">,</span>  <span class="token property">"iss"</span><span class="token operator">:</span> <span class="token string">"https://sts.windows.net/b9e35cac-a7b8-48dd-a102-bba18eaca524/"</span><span class="token punctuation">,</span>  <span class="token property">"iat"</span><span class="token operator">:</span> <span class="token number">1581840878</span><span class="token punctuation">,</span>  <span class="token property">"nbf"</span><span class="token operator">:</span> <span class="token number">1581840878</span><span class="token punctuation">,</span>  <span class="token property">"exp"</span><span class="token operator">:</span> <span class="token number">1581844778</span><span class="token punctuation">,</span>  <span class="token property">"appid"</span><span class="token operator">:</span> <span class="token string">"815680bb-ebc9-4e5f-a594-f2c55b83bb27"</span><span class="token punctuation">,</span>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"example watahani"</span><span class="token punctuation">,</span>  <span class="token property">"oid"</span><span class="token operator">:</span> <span class="token string">"992f309f-2fab-45fa-9e56-f02216d2e0a7"</span><span class="token punctuation">,</span>  <span class="token property">"roles"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token string">"Writer"</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token property">"scp"</span><span class="token operator">:</span> <span class="token string">"Files.Write"</span><span class="token punctuation">,</span>  <span class="token property">"upn"</span><span class="token operator">:</span> <span class="token string">"example@watahani.com"</span><span class="token punctuation">,</span>  <span class="token property">"uti"</span><span class="token operator">:</span> <span class="token string">"8lfnfIEUUES_MPqR-4okAA"</span><span class="token punctuation">,</span>  <span class="token property">"ver"</span><span class="token operator">:</span> <span class="token string">"1.0"</span>  <span class="token comment">//ç•¥</span><span class="token punctuation">}</span></code></pre><p>ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å—ã‘å–ã£ãŸ API å´ã§ã¯ã€å«ã¾ã‚Œã¦ã„ã‚‹ãƒ­ãƒ¼ãƒ«ã«ã‚ˆã£ã¦ãµã‚‹ã¾ã„ã‚’å¤‰ãˆã‚‹ã“ã¨ã§ RBAC ãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãŒå¯èƒ½ã«ãªã‚‹ã€‚</p><p>ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼ã¯ MSAL ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã—ã¦é©å½“ã«ã‚„ã£ã¦ãã ã•ã„ã€‚</p><h2 id="é›‘æ„Ÿ"><a href="#é›‘æ„Ÿ" class="headerlink" title="é›‘æ„Ÿ"></a>é›‘æ„Ÿ</h2><p>Azure AD ã®ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ–¹æ³•ã‚’ç°¡å˜ã«ç´¹ä»‹ã—ãŸã€‚Optional Claims ã¯ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚„è¨€èªãªã©ä½¿ãˆãã†ãªã‚¯ãƒ¬ãƒ¼ãƒ ã¯ã‚ã‚‹ã‚‚ã®ã®ã€ã‚¤ãƒã‚¤ãƒãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãŒæ€ã„ã¤ã‹ãªã‹ã£ãŸã€‚</p><p>ä¸€æ–¹ãƒ­ãƒ¼ãƒ«ã«ã¤ã„ã¦ã¯ã‚°ãƒ«ãƒ¼ãƒ—ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã‚‚ã€ç‹¬è‡ªã®ãƒ­ãƒ¼ãƒ«ã‚’è¨­å®šã™ã‚‹å ´åˆã«ã‚‚ RBAC ã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’ç°¡å˜ã«åˆ¶å¾¡ã§ããã†ã ã£ãŸã€‚<br>ã©ã£ã¡ã®æ–¹æ³•ã§ç®¡ç†ã™ã¹ãã‹ã¯ãŸã¶ã‚“çµ„ç¹”è¦æ¨¡ã‚„ã‚¢ãƒ—ãƒªã®æ€§è³ªã«ã‚ˆã£ã¦å¤‰ã‚ã£ã¦ãã¦æ¥ã‚‹ã®ã ã‚ã†ã¨æ€ã†ã€‚<br>å‰è¿°ã®é€šã‚Šãƒ­ãƒ¼ãƒ«ã®å‰²ã‚Šå½“ã¦ã‚’ MS Graph API ã§è¡Œã†æ–¹æ³•ã¯ä»Šã®ã¨ã“ã‚ãªãã€ã©ã†ã›ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ãƒ­ãƒ¼ãƒ«ã«å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã«ãªã‚‹ã¨ã¯æ€ã†ã€‚ãŸã <br>ã€ã‚°ãƒ«ãƒ¼ãƒ—ãŒæ˜ç¢ºã«ãƒ­ãƒ¼ãƒ«ã¨ 1:1 ã®çµ„ç¹”ã§ã‚ã‚Œã°ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ãã®ã¾ã¾ãƒ­ãƒ¼ãƒ«ã¨ã—ã¦å‡ºåŠ›ã—ã¦ã‚‚è‰¯ã•ãã†ã ãŒã€æ™®é€šã¯ãã†æ˜ç¢ºã«ã‚°ãƒ«ãƒ¼ãƒ— &#x3D; ãƒ­ãƒ¼ãƒ«ã¨ã¯å‡ºæ¥ãªã„ã‚ˆã†ã«æ€ã†ã€‚</p><p>ã¨ã„ã†ã“ã¨ã§ã€ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«ã¤ã„ã¦ã¯ã¡ã‚‡ã£ã¨èª°ã‹ãŒæ•™ãˆã¦ãã‚Œã‚‹ã“ã¨ã‚’æœŸå¾…ã—ã¤ã¤ã€ãƒ­ãƒ¼ãƒ«ãŒæ˜ç¢ºã«ãªã£ã¦ã„ã‚‹ä¼šç¤¾ã»ã©ã€ã“ã†ã„ã£ãŸ RBAC ãªåˆ¶å¾¡ã‚’åˆ©ç”¨ã—ã‚„ã™ã„ã®ã‹ãªã‚ã¨ã€çµ„ç¹”è«–çš„ãªã“ã¨ã‚‚å°‘ã—è€ƒãˆãŸã€‚</p><p>ä»¥å‰ OpenID Summit ã«å‚åŠ ã—ãŸã¨ãã«ã‚‚æ„Ÿã˜ãŸãŒã€IDå¨ã®æŠ€è¡“ã‚’è¿½ã£ã¦ã„ãã«ã¯ã€ç¾å®Ÿä¸–ç•Œã®å•é¡Œã«ã¤ã„ã¦ã‚‚æ·±ãç†è§£ã™ã‚‹å¿…è¦ã‚‚ã‚ã‚Šãã†ãªã®ã§ã€ä½•ã‹æ‰‹ã‚’ä»˜ã‘ã‚Œã‚‹ã¨ã“ã‚ã‹ã‚‰å­¦ç¿’ã‚’å§‹ã‚ãŸã„ã¨ã“ã‚ã€‚</p><p>ã§ã‚‚ä»Šæ—¥ã¯ãƒã‚±ãƒ¢ãƒ³HOME ã§ 6V ãƒ¡ã‚¿ãƒ¢ãƒ³è¼¸é€ã›ãªã„ã‹ã‚“ã®ã§ã€ã“ã®ã¸ã‚“ã§ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Azure AD ãŒç™ºè¡Œã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹æ–¹æ³•ã‚’å°‘ã—èª¿ã¹ãŸã®ã§ãƒ¡ãƒ¢ã€‚&lt;/p&gt;
&lt;h2 id=&quot;ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º&quot;&gt;&lt;a href=&quot;#ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º&quot; class=&quot;headerlink&quot; title=&quot;ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º&quot;&gt;&lt;/a&gt;ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º&lt;/h2&gt;&lt;p&gt;ãã‚‚ãã‚‚ Azure AD ã®ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚’ã™ã‚‹ç†ç”±ã¨ã—ã¦ã¯å¤§ããåˆ†ã‘ã‚‹ã¨ä»¥ä¸‹ã® 2 ã¤ã ã¨æ€ã†ã€‚&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;é€£æºã‚¢ãƒ—ãƒªã«å¯¾ã—ã¦ç™ºè¡Œã™ã‚‹ &lt;strong&gt;ID ãƒˆãƒ¼ã‚¯ãƒ³&lt;/strong&gt; ã®å±æ€§ã‚’è¿½åŠ ãƒ»æ—¢å­˜ã®å±æ€§ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã€‚&lt;/li&gt;
&lt;li&gt;Azure AD ã«ç™»éŒ²ã—ãŸ Web API ã‚’åˆ©ç”¨ã™ã‚‹ç”¨ã« &lt;strong&gt;ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³&lt;/strong&gt; ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å‰è€…ã¯ã‚¢ãƒ—ãƒªå´ã§ Azure AD ã®å±æ€§ã‚’ä½¿ã„ãŸã„å ´åˆã«åˆ©ç”¨ã™ã‚‹ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="OAuth" scheme="http://blog.haniyama.com/tags/OAuth/"/>
    
      <category term="OIDC" scheme="http://blog.haniyama.com/tags/OIDC/"/>
    
      <category term="Azure AD" scheme="http://blog.haniyama.com/tags/Azure-AD/"/>
    
  </entry>
  
  <entry>
    <title>Azure B2C ã® FIDO2 ã‚µãƒ³ãƒ—ãƒ«ã‚’å‹•ã‹ã™</title>
    <link href="http://blog.haniyama.com/2019/12/06/azuread-b2c-fido2-custompolicy/"/>
    <id>http://blog.haniyama.com/2019/12/06/azuread-b2c-fido2-custompolicy/</id>
    <published>2019-12-05T16:29:00.000Z</published>
    <updated>2022-05-18T13:45:28.998Z</updated>
    
    <content type="html"><![CDATA[<p>ã“ã®è¨˜äº‹ã¯<a href="https://qiita.com/advent-calendar/2019/identity">èªè¨¼èªå¯ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a> ã®6æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚</p><p>å‹•æ©Ÿ: ã‚„ã£ã± OIDC ãƒã‚¿ã¨ FIDO ãƒã‚¿ãŒå¤šã„ã‹ã‚‰ã€<strong>ã©ã£ã¡ã‚‚çµ¡ã‚ãŸã‚„ã¤ã‚’æ›¸ã‘ã°ã‚ã£ã¡ã‚ƒã‚¦ã‚±ã‚‹ã®ã§ã¯ï¼Ÿ</strong><br>â†’ Azure AD B2C ã« WebAuthn ã«ã‚ˆã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¬ã‚¹ ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’å®Ÿè£…ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚ã£ãŸãªã‚â€¦</p><p>ã¨ã€è‹¦ã—ç´›ã‚Œã«ãƒã‚¿ã‚’ã²ã­ã‚Šå‡ºã—ãŸçµæœã€ãã£ããƒ‹ãƒƒãƒãªè¨˜äº‹ã«ãªã£ã¦ã—ã¾ã£ãŸã€‚</p><span id="more"></span><p>æ”¹ã‚ã¦èª­ã¿ç›´ã—ã¦ã¿ã¦ã‚‚ã€ãƒ†ãƒ¼ãƒã‚’ Azure B2C ã«ã—ã¦ã—ã¾ã£ãŸã“ã¨ã§ B2C ã‚’è§¦ã£ãŸã“ã¨ã‚ã‚‹äººã§ã€ã‹ã¤ FIDO ã«èˆˆå‘³ã‚ã‚‹äººã¨ã„ã†ã€ <strong>èª­è€… ã‚’ç‹­ã‚ã¦ã—ã¾ã£ã¦ã„ã‚‹</strong> ãŒã€é ‘å¼µã£ã¦æ›¸ã„ãŸã®ã§ã‚‚ã—å…¨éƒ¨è©¦ã—ãŸã¨ã„ã†é…”ç‹‚ãªäººãŒ (ãµã˜ãˆã•ã‚“ä»¥å¤–ã§) å±…ãŸã‚‰ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¨ãƒ­ã€‚</p><h2 id="Azure-AD-B2C"><a href="#Azure-AD-B2C" class="headerlink" title="Azure AD B2C"></a>Azure AD B2C</h2><p>Azure AD B2C ã¨ã¯ã€Twitter ã‚„ Facebook, ãã®ä»–ã® OpenID Provider ã‚’çµ±åˆã—ã€Azure AD B2C ç‹¬è‡ªã® Id Token, Access Token ã‚’ç™ºè¡Œã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã‚‹ã€‚è¦ã¯ Auth0 çš„ãªã‚µãƒ¼ãƒ“ã‚¹ã€‚(æœ¬ãƒ–ãƒ­ã‚°äºŒåº¦ç›®)</p><p>çµ„ã¿è¾¼ã¿ãƒãƒªã‚·ãƒ¼ã¨å‘¼ã°ã‚Œã‚‹æ—¢å®šã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã§ã€è¤‡æ•°ã® IdP ã¨æ¥ç¶šã—ã¦ã€ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼ã‚’ä½œã‚Œã‚‹ã€‚<br>OIDC ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’æ¥ç¶šã™ã‚‹ã¨ãã®ã‚¯ã‚»ãŒå¼·ã‹ã£ãŸã‚Šã™ã‚‹ã®ã ãŒã€ã‚«ã‚¹ã‚¿ãƒ  ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€å¤–éƒ¨ã® OP ã‚’æ¥ç¶šã§ãã‚‹ã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ©Ÿèƒ½ã‚‚æœ€ä½é™å¿…è¦ãªã‚‚ã®ã¯ãã‚ã£ã¦ã‚‹ã€‚</p><p>ã®ã ãŒã€è¤‡é›‘ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’çµ„ã¿è¾¼ã‚‚ã†ã¨ã™ã‚‹ã¨ã€ã‚«ã‚¹ã‚¿ãƒ  ãƒãƒªã‚·ãƒ¼ã‚’å¼„ã‚‹ã“ã¨ã«ãªã‚‹ã€‚</p><h2 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h2><p>ã‚ã‚‰ã‹ã˜ã‚æ³¨æ„ã‚’ã—ã¦ãŠãã¨ã€ã‚«ã‚¹ã‚¿ãƒ  ãƒãƒªã‚·ãƒ¼ã‚’å¼„ã‚‹ã®ã¯ã‹ãªã‚Šã¤ã‚‰ã„ä½œæ¥­ã§ã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚‚å¤§å¤‰ãªã®ã§ã§ãã‚‹ã“ã¨ãªã‚‰çµ„ã¿è¾¼ã¿ã®ãƒãƒªã‚·ãƒ¼ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚’ <strong>å¼·ãã‚ªã‚¹ã‚¹ãƒ¡ã™ã‚‹</strong>ã€‚</p><p>B2C ã®ã‚«ã‚¹ã‚¿ãƒ  ãƒãƒªã‚·ãƒ¼ã¯ãƒã‚¸ã§ãªã‚“ã§ã‚‚å‡ºæ¥ã¦ã—ã¾ã†ã®ã§ã€ä¸­èº«ãŒã‚ã‹ã£ã¦ãªã„ã¨ãªãœå‹•ã‹ãªã„ã®ã‹å…¨ãã‚ã‹ã‚‰ãªããªã‚‹ã€‚</p><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/active-directory-b2c-overview-custom">å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</a> ã«ã‚‚ã€ã“ã†æ›¸ã„ã¦ã‚ã‚‹ã€‚</p><blockquote><p>ID ã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã€ã‚·ã‚¹ãƒ†ãƒ  ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚¿ã€ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆã€ç¤¾å†…ã® ID ãƒãƒ¼ãƒ ã€‚ å½¼ã‚‰ã¯ OpenID Connect ã®ãƒ•ãƒ­ãƒ¼ã«æ…£ã‚Œã¦ãŠã‚Šã€ID ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚„è¦æ±‚ãƒ™ãƒ¼ã‚¹ã®èªè¨¼ã‚’ç†è§£ã—ã¦ã„ã¾ã™ã€‚</p></blockquote><blockquote><p>æ³¨: Azure Active Directory B2C ã§ã€ã‚«ã‚¹ã‚¿ãƒ  ãƒãƒªã‚·ãƒ¼ã¯ã€ä¸»ã«ã€è¤‡é›‘ãªã‚·ãƒŠãƒªã‚ªã«å–ã‚Šçµ„ã‚€ç”¨é€”å‘ã‘ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚<br>ã»ã¨ã‚“ã©ã®ã‚·ãƒŠãƒªã‚ªã§ã€çµ„ã¿è¾¼ã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ ãƒ•ãƒ­ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚</p></blockquote><p><strong>æ„è¨³: ID ã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ä»¥å¤–ã¯ä½¿ã†ãª</strong></p><p>å€‹äººçš„ãªæ„è¦‹ã‚’è¿½åŠ ã™ã‚‹ãªã‚‰ã€ID ã ã‘ã§ãªã XML ã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ã¨æ€ã†ã€‚</p><p>ã¾ãŸã€æœ¬è¨˜äº‹ã§ã¯ã‚«ã‚¹ã‚¿ãƒ  ãƒãƒªã‚·ãƒ¼ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã«ã¤ã„ã¦ã¯è§£èª¬ã—ãªã„ã€‚<br>å„è‡ªå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç­‰ã§ç¢ºèªã—ã¦ã»ã—ã„ã€‚</p><h2 id="ã‚«ã‚¹ã‚¿ãƒ -ãƒãƒªã‚·ãƒ¼"><a href="#ã‚«ã‚¹ã‚¿ãƒ -ãƒãƒªã‚·ãƒ¼" class="headerlink" title="ã‚«ã‚¹ã‚¿ãƒ  ãƒãƒªã‚·ãƒ¼"></a>ã‚«ã‚¹ã‚¿ãƒ  ãƒãƒªã‚·ãƒ¼</h2><p>ã‚«ã‚¹ã‚¿ãƒ  ãƒãƒªã‚·ãƒ¼ã¨ã¯ä½•ãã‚„ã€‚<br>Azure AD B2C ã¯ã€ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨é€£æºã—ã€Azure AD B2C ç‹¬è‡ªã® Id Token, Access Token ã‚’ç™ºè¡Œã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã‚‹ã€‚</p><p>ãã®éš›å„ç¨® IdP ã¨ claim ã®ã‚„ã‚Šå–ã‚Šã‚’è¡Œã„ã€æ¤œè¨¼ã—ã€å¤‰æ›ã—ã€ä»»æ„ã®ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’æ§‹ç¯‰ã—ã€æœ€çµ‚çš„ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ‰•ã„å‡ºã™ã€‚</p><p>ãã®éš›ã«ã¯æ§˜ã€…ãªãƒ‡ãƒ¼ã‚¿ãŒå…¥åŠ›ã•ã‚Œã‚‹ã€‚<br>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ID/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã‚ã£ãŸã‚Šã€ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã€ä»–ã® IdP ã‹ã‚‰è¿”å´ã•ã‚Œã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‚ã—ã‚Œãªã„ã€‚</p><p>ãã‚Œã‚‰ã®å…¥åŠ›ã‹ã‚‰ claim ã‚’å–ã‚Šå‡ºã—ã€å¤‰æ›ã—ãŸã‚Šã€å¤–éƒ¨ API ã§ Validation ã—ãŸã‚Šã—ã¦ã€æœ€çµ‚çš„ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆã— B2C ã®ç§˜å¯†éµã§ç½²åã™ã‚‹ã®ãŒ Azure B2C ã®ã‚­ãƒ¢ã€‚</p><p>ã“ã® claim ã®å¤‰æ›è¦å‰‡ã‚„ã€ä¿å­˜å…ˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã€ãã‚Œã‚‰ã®ã™ã¹ã¦ã‚’è‡ªç”±ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã‚‹ã®ãŒã€ã‚«ã‚¹ã‚¿ãƒ  ãƒãƒªã‚·ãƒ¼ã§ã‚ã‚‹ã€‚</p><p>ãã—ã¦è¨­å®šã¯ <strong>ã™ã¹ã¦ XML ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã€‚</strong></p><p>ãã†â€¦â€¦ <strong>XML</strong> ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã®ã ã€‚</p><p>ã‚µãƒ³ãƒ—ãƒ«ã‚’å‹•ã‹ã™ã®ã«å¿…è¦ãªçŸ¥è­˜ã¯ã€ ä»¥ä¸‹ã®ãƒ–ãƒ­ã‚°ã«ã¾ã¨ã‚ã‚‰ã‚Œã¦ã„ã¦ã€å®Ÿéš›ã«ä¸€ã¤ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’å‹•ã‹ã—ã¦ã¿ãŸã®ãŒã€ä»Šå›ã®è¨˜äº‹ã§ã‚ã‚‹ã€‚</p><ul><li><a href="https://blog.azure.moe/2019/11/22/%e5%86%b4%e3%81%88%e3%81%aa%e3%81%84custom-policy%e3%81%ae%e8%82%b2%e3%81%a6%e6%96%b9/">å†´ãˆãªã„Custom Policyã®è‚²ã¦æ–¹ | ãƒ–ãƒã‚¶ãƒƒã‚­</a></li></ul><h2 id="ä»Šå›å‹•ã‹ã™ã‚µãƒ³ãƒ—ãƒ«"><a href="#ä»Šå›å‹•ã‹ã™ã‚µãƒ³ãƒ—ãƒ«" class="headerlink" title="ä»Šå›å‹•ã‹ã™ã‚µãƒ³ãƒ—ãƒ«"></a>ä»Šå›å‹•ã‹ã™ã‚µãƒ³ãƒ—ãƒ«</h2><p>ä»Šå›å‹•ã‹ã™ã‚µãƒ³ãƒ—ãƒ«ã¯ã“ã¡ã‚‰ã€‚</p><p>Sign-in with FIDO authenticator<br><a href="https://github.com/azure-ad-b2c/samples/tree/master/policies/fido2">https://github.com/azure-ad-b2c/samples/tree/master/policies/fido2</a></p><p>ID/Password ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã€FIDO2 ã® Authenticator ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã™ã‚‹ãƒ•ãƒ­ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ã‚‚ã®ã€‚</p><p>æœ€çµ‚çš„ãªå‹•ãã¯ã“ã‚“ãªæ„Ÿã˜ã€‚</p><p>åˆæœŸç™»éŒ²ã—ã¦<br><img src="https://raw.githubusercontent.com/azure-ad-b2c/samples/master/policies/fido2/media/registration-user-flow.png" alt=""></p><p>èªè¨¼ã™ã‚‹ã€‚<br><img src="https://github.com/azure-ad-b2c/samples/blob/master/policies/fido2/media/authentication-user-flow.png?raw=true" alt=""></p><h2 id="äº‹å‰æº–å‚™"><a href="#äº‹å‰æº–å‚™" class="headerlink" title="äº‹å‰æº–å‚™"></a>äº‹å‰æº–å‚™</h2><p>æ®‹å¿µãªãŒã‚‰ã€ã“ã®ãƒãƒªã‚·ãƒ¼ã€ã“ã‚Œã ã‘ã§ã¯å‹•ã‹ãªã„ã€‚</p><p>ã¾ãšã¯ã‚«ã‚¹ã‚¿ãƒ  ãƒãƒªã‚·ãƒ¼ã® starterpack ã‚’æ§‹æˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚</p><p><a href="https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack">https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack</a></p><p>å¹¸ã„ã‚«ã‚¹ã‚¿ãƒ  ãƒãƒªã‚·ãƒ¼ã®å°å…¥ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹ã®ã§ã€ãã®é€šã‚Šã«æ§‹æˆã™ã‚Œã°ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼ãŒã§ãã‚‹ã¯ãšã€‚</p><p>ã‚«ã‚¹ã‚¿ãƒ  ãƒãƒªã‚·ãƒ¼ã®æ¦‚è¦ - Azure Active Directory B2C | Microsoft Docs<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/active-directory-b2c-get-started-custom?tabs=applications">https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/active-directory-b2c-get-started-custom?tabs=applications</a></p><p>ãŸã„ã¦ã„ã®äººã¯ã“ã“ã§ XML ã‚’è¦‹ã¦æ˜‡å¤©ã™ã‚‹ã€‚å¿ƒã‚’å¼·ãæŒã£ã¦ã»ã—ã„ã€‚</p><p>XML ã®ç·¨é›†ã¯ <a href="https://marketplace.visualstudio.com/items?itemName=AzureADB2CTools.aadb2c">Azure AD B2C ã® VS Code æ‹¡å¼µ</a> ã‚’å…¥ã‚Œã‚‹ã¨ã€å°‘ã—ã¯æ¥½ã«ãªã‚‹ã€‚<br>æ˜¯éå…¥ã‚Œã‚ˆã†ã€‚</p><h2 id="FIDO2-ã®ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼"><a href="#FIDO2-ã®ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼" class="headerlink" title="FIDO2 ã®ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼"></a>FIDO2 ã®ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼</h2><p>ã•ã¦ã€äº‹å‰æº–å‚™ã‚’çªç ´ã—ã¦ã—ã¾ã£ãŸã‚‰ã€è¿½åŠ ã®ãƒãƒªã‚·ãƒ¼ã‚’è¨­å®šã—ã¦ã„ãã€‚<br><a href="https://github.com/azure-ad-b2c/samples/tree/master/policies/fido2">ã‚µãƒ³ãƒ—ãƒ«</a> ã«ã¯ã€èªè¨¼ã®ã‚³ã‚¢ã¨ãªã‚‹è¦æ±‚ã‚¯ãƒ¬ãƒ¼ãƒ ã‚„ API ã‚³ãƒ¼ãƒ«ãŒå®šç¾©ã•ã‚ŒãŸ <code>FIDOExtensions.xml</code> ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®Ÿéš›ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãƒ•ãƒ­ãƒ¼ã‚’å®šç¾©ã—ãŸ <code>FIDORegistration.xml</code> ã¨ <code>FIDOSignUpOrSignin.xml</code> ãŒã‚ã‚‹ã€‚</p><p>è©³ã—ãã¯ <a href="https://github.com/azure-ad-b2c/ief-wiki/wiki/Policy-structure">ief-wiki</a> ãªã©ã‚’å‚ç…§ã—ã¦æ¬²ã—ã„ãŒã€ã‚«ã‚¹ã‚¿ãƒ  ãƒãƒªã‚·ãƒ¼ã® XML ã¯å…ˆã»ã©ä½œæˆã—ãŸ <code>TrustFrameworkBase.xml</code> ã‚’ç¶™æ‰¿ã—ã¦ã€æ‹¡å¼µå±æ€§ãªã©ã‚’å®šç¾©ã™ã‚‹ã€‚æœ€çµ‚çš„ã«ç¶™æ‰¿ã•ã‚ŒãŸ Extension ã®å†…å®¹ã™ã¹ã¦ã‚’çµ±åˆã—ã¦ã€B2C ã®ãƒãƒªã‚·ãƒ¼ãŒå®Œæˆã™ã‚‹ã€‚</p><blockquote><p>IEF ã¯ dentity Experience Framework ã®ç•¥</p></blockquote><p>ä»Šå›ã®å ´åˆã¯ <code>TrustFrameworkBase.xml</code> &gt; <code>TrustFrameworkExtensions</code> &gt; <code>FIDOExtensions.xml</code> ã¨ç¶™æ‰¿ã•ã‚Œã¦ã„ã‚‹ã€‚<br><code>FIDORegistration.xml</code> ã¨ <code>FIDOSignUpOrSignin.xml</code> ã¯ã€ç¶™æ‰¿ã•ã‚Œçµ±åˆã•ã‚ŒãŸ <code>FIDOExtensions.xml</code> ã‚’å‚ç…§ã™ã‚‹ã€‚</p><p><code>FIDOExtensions.xml</code> ã«å®šç¾©ã•ã‚Œã¦ã„ãªã„è¨­å®šã¯ã€ç¶™æ‰¿å…ƒã®ã©ã“ã‹ã«è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ã¯ãšãªã®ã§ã€æ°—åŠ›ãŒã‚ã‚Œã°ç¶™æ‰¿å…ƒã®ãƒãƒªã‚·ãƒ¼ã‚’è¦—ã„ã¦ã¿ã‚ˆã†ã€‚</p><p>ä»Šå›ã¯ <code>FIDOExtensions.xml</code> ã®ã¿ã‚’ç·¨é›†ã™ã‚‹ã€‚ãŸã ã—ã€ç·¨é›†ã™ã‚‹å‰ã«äº‹å‰æº–å‚™ãŒå¿…è¦ãªã®ã§é †ã«ã‚„ã£ã¦ã„ãã€‚</p><h3 id="äº‹å‰æº–å‚™-1-FIDO2-ã‚µãƒ¼ãƒãƒ¼ã®ä½œæˆ"><a href="#äº‹å‰æº–å‚™-1-FIDO2-ã‚µãƒ¼ãƒãƒ¼ã®ä½œæˆ" class="headerlink" title="äº‹å‰æº–å‚™ 1. FIDO2 ã‚µãƒ¼ãƒãƒ¼ã®ä½œæˆ"></a>äº‹å‰æº–å‚™ 1. FIDO2 ã‚µãƒ¼ãƒãƒ¼ã®ä½œæˆ</h3><p>ã¾ãšã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ä½¿ã† FIDO2 ã‚µãƒ¼ãƒãƒ¼ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’å‹•ã‹ãã†ã€‚<br>ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã¯ã€FIDO2 ã®ã‚µãƒ¼ãƒãƒ¼éƒ¨åˆ†ã¯ä»¥ä¸‹ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’æµç”¨ã—ã¦ã„ã‚‹ã€‚</p><p><a href="https://github.com/MicrosoftEdge/webauthnsample">https://github.com/MicrosoftEdge/webauthnsample</a></p><p>ã‚‚ã¨ã‚‚ã¨ã¯ HTML ã‚‚å«ã‚ãŸã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—/ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã®ã‚µãƒ³ãƒ—ãƒ«ã ãŒã€ã‚¦ã‚§ãƒ–ã®ç”»é¢ã¯åˆ©ç”¨ã›ãšã«ã€API ã ã‘åˆ©ç”¨ã™ã‚‹ã€‚</p><p>ãƒ›ãƒ³ãƒˆã¯ Azure Function ã¨ã‹ã«è¼‰ã›ã‚ˆã†ã¨ã—ãŸã‘ã©ä½¿ã„æ–¹ã‚ã‹ã‚‰ãªãã¦æ–­å¿µã€‚<br>Azure AppService ã¨ã‹ã‚‚ä½¿ã£ãŸã“ã¨ãªã„ã®ã§ã€now.sh ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã€‚</p><p>æ³¨æ„ç‚¹ã¨ã—ã¦ã¯ã€æœ€çµ‚çš„ã« WebAuthn ãŒå‹•ãã®ã¯ B2C ã®ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã€ã¤ã¾ã‚Š <code>https://yourtenant.b2clogin.com</code> ä¸Šãªã®ã§ã€rpId ã‚‚ <code>yourtenant.b2clogin.com</code> ã«ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã“ã¨ã€‚</p><ul><li>fido.js ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ä»¥ä¸‹ã®éƒ¨åˆ†ã‚’ä¿®æ­£ã™ã‚‹</li></ul><pre class=" language-diff"><code class="language-diff"><span class="token deleted">- const hostname = process.env.HOSTNAME || "localhost";</span><span class="token inserted">+ const hostname = "yourtenant.b2clogin.com";</span></code></pre><p>now.sh ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãŸã‚ã«ã€<code>now.json</code> ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä½œæˆã™ã‚‹ã€‚</p><script src="https://gist.github.com/watahani/1169bdea01979e888dbe1e18b8c35982.js"></script><p>å¾Œã¯ã€<code>npm install -g now</code> ã—ã¦ <code>now</code> ã§ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã€‚</p><p><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/nowsh.png" alt=""></p><blockquote><p>now.sh ãŒ v2 ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã—ã¦ã„ã¦å›°ã£ãŸãŒ <a href="https://qiita.com/aggre/items/f0cb9f8b8e8c54768e50">Now ã§ã‚¯ãƒ©ã‚¦ãƒ‰ã®è¤‡é›‘ã•ã‹ã‚‰è§£æ”¾ã•ã‚Œã‚ˆã†ã€ä»Šã™ãã« - Qiita</a> ã‚ãŸã‚Šã‚’å‚è€ƒã«ã—ãŸ</p></blockquote><p><code>https://source-code.username.now.sh</code> ã¨ã‹ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã®ã§ <code>https://source-code.username.now.sh/challenge</code> ã«ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãŒè¿”ã‚Œã° OKã€‚</p><p>URL ã¯å¾Œã§ä½¿ã†ã®ã§ãƒ¡ãƒ¢ã£ã¦ãŠãã€‚</p><p>ãªãŠã€å¾Œè¿°ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜å…ˆã®é–¢ä¿‚ä¸Šã€WebAuthn ã® sign count ã¯ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ãªã„ã€‚</p><h3 id="äº‹å‰æº–å‚™-2-é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ›ã‚¹ãƒˆ"><a href="#äº‹å‰æº–å‚™-2-é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ›ã‚¹ãƒˆ" class="headerlink" title="äº‹å‰æº–å‚™ 2. é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ›ã‚¹ãƒˆ"></a>äº‹å‰æº–å‚™ 2. é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ›ã‚¹ãƒˆ</h3><p>WebAuthn ã®ã‚­ãƒ¼ã‚’ç™»éŒ²/èªè¨¼ã™ã‚‹ãŸã‚ã®ã€ã‚«ã‚¹ã‚¿ãƒ  ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã®ãŸã‚ã®é™çš„ HTML ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã€‚</p><p>Azure B2C ã§ã¯å¤–éƒ¨ã® HTML ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ JavaScript ã§ãƒ•ã‚§ãƒƒãƒã—ã¦ã€å¿…è¦ãªãƒ•ã‚©ãƒ¼ãƒ ã‚’åŸ‹ã‚è¾¼ã‚“ã§è¡¨ç¤ºã™ã‚‹ã€‚</p><p>ä»Šå›ã¯ã€ã‚«ã‚¹ã‚¿ãƒ  HTML ä¸Šã§ Authenticator ã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«è©°ã‚ã¦ã€æ¬¡ã®ãƒ•ãƒ­ãƒ¼ã«æµã™ã€‚</p><p><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/b2chtml.png" alt=""></p><p>é©å½“ã« gist ã§ã‚‚ GitHub ã®ãƒªãƒã‚¸ãƒˆãƒªã§ã‚‚ CORS ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹å ´æ‰€ã§ã‚ã‚Œã°ã©ã“ã§ã‚‚é©å½“ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«ã—ã¦ã„ã„ã€‚</p><p><a href="https://gist.githubusercontent.com/watahani/f94a8362a4cc075a67254eb403c9c1c7/raw/e83697aa603d0c11b78d9f503b4885ac84695601/self-asserted.html">https://gist.githubusercontent.com/watahani/f94a8362a4cc075a67254eb403c9c1c7/raw/e83697aa603d0c11b78d9f503b4885ac84695601/self-asserted.html</a><br><a href="https://gist.githubusercontent.com/watahani/a49bec0c38ad1e2540b829ee4121d8ba/raw/dc5eaa4c36b80459980eae312861fac7339b269c/welcome.html">https://gist.githubusercontent.com/watahani/a49bec0c38ad1e2540b829ee4121d8ba/raw/dc5eaa4c36b80459980eae312861fac7339b269c/welcome.html</a></p><p>URL ã¯å¾Œã§ä½¿ã†ã®ã§ãƒ¡ãƒ¢ã£ã¦ãŠãã€‚</p><h3 id="äº‹å‰æº–å‚™-3-ã‚¢ãƒ—ãƒªã®ç™»éŒ²"><a href="#äº‹å‰æº–å‚™-3-ã‚¢ãƒ—ãƒªã®ç™»éŒ²" class="headerlink" title="äº‹å‰æº–å‚™ 3. ã‚¢ãƒ—ãƒªã®ç™»éŒ²"></a>äº‹å‰æº–å‚™ 3. ã‚¢ãƒ—ãƒªã®ç™»éŒ²</h3><p>ã‚µãƒ³ãƒ—ãƒ«ã§ã¯ WebAuthn ã® Credential ID ã¨å…¬é–‹éµãªã©ã‚’ä¿å­˜ã™ã‚‹ã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã¦ã„ã‚‹ã€‚<br>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã« Credential ID ã‚’ä¿å­˜ã™ã‚‹é–¢ä¿‚ä¸Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ 1 ã¤ã® Credential ã—ã‹ä¿å­˜ã§ããªã„ã€‚</p><p>æœ¬æ¥åˆ¥é€” DB ã‚’ç”¨æ„ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨å…¬é–‹éµã‚’ä¿å­˜ã™ã¹ãã ãŒã€Application Extension (æ‹¡å¼µãƒ—ãƒ­ãƒ‘ãƒ†ã‚£) ã«ä¿å­˜ã—ã¦ã„ã‚‹ã€‚<br>Custom Policy ã®ç·´ç¿’ã®ãŸã‚ã«ã“ã†ãªã£ã¦ã‚‹ã®ã ã¨è¨€ã„èã‹ã›ã¦ã€è¨­å®šã‚’é€²ã‚ã‚‹ã€‚</p><ul><li>Azure Active Directory B2C ã§ã‚«ã‚¹ã‚¿ãƒ  ãƒãƒªã‚·ãƒ¼ã«ç‹¬è‡ªã®å±æ€§ã‚’è¿½åŠ ã™ã‚‹ | Microsoft Docs<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/active-directory-b2c-create-custom-attributes-profile-edit-custom">https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/active-directory-b2c-create-custom-attributes-profile-edit-custom</a></li></ul><p>ä½•ã‚’ã‚„ã£ã¦ã„ã‚‹ã‹ç°¡å˜ã«èª¬æ˜ã™ã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§ã‚’ä¿å­˜ &amp; èª­ã¿æ›¸ãã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã€ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼å†…ã§ WebAuthn ã®æƒ…å ±ã‚’ä¿å­˜ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã€‚</p><p>ã‚¢ãƒ—ãƒªã®ç™»éŒ²ã§ç™»éŒ²ã™ã‚‹ã€‚ã‚¢ãƒ—ãƒªã®åå‰ã¯ <code>WebApp-GraphAPI-FIDO2-Extensions</code> ã¨ã—ãŸã€‚</p><p>ç”»é¢ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚</p><p><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/appreg.png" alt=""></p><p>Admin Consent ã‚’å®Œäº†ã•ã›ã‚‹ã€‚</p><p><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/apppermission.png" alt=""></p><p>ã§ä½œæˆã—ãŸã‚¢ãƒ—ãƒªã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ ID ã¨ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ID ã‚’ãƒ¡ãƒ¢ã£ã¦ãŠãã€‚</p><h2 id="FIDOExtensions-xml-ã®ç·¨é›†"><a href="#FIDOExtensions-xml-ã®ç·¨é›†" class="headerlink" title="FIDOExtensions.xml ã®ç·¨é›†"></a>FIDOExtensions.xml ã®ç·¨é›†</h2><p>ã“ã“ã¾ã§ã®æ‰‹é †ã‚’å®Œäº†ã—ãŸé…”ç‹‚ãªäººãŒã„ãŸå ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ãªçŠ¶æ…‹ã«ãªã£ã¦ã„ã‚‹ã¯ãšã§ã‚ã‚‹ã€‚</p><p><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/extensions.png" alt=""></p><p>ã“ã®ç´°åˆ‡ã‚Œã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ã€FIDOExtensions.xml ã§ã¤ãªã„ã§ã„ãã€‚XML ã§â€¦ã€‚</p><h3 id="UserJourneys"><a href="#UserJourneys" class="headerlink" title="UserJourneys"></a>UserJourneys</h3><p>ã©ã‚“ã©ã‚“èªè¨¼èªå¯ã®è©±ãŒé–¢ä¿‚ãªã£ã¦ãã¦ã„ã‚‹ãŒã€å…ˆã«é€²ã¿ã¾ã™ã€‚</p><p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ•ãƒ­ãƒ¼ã«ã¤ã„ã¦ã¯ã€UserJourneys ã¨å‘¼ã°ã‚Œã‚‹ã‚¿ã‚°ã«å®šç¾©ã•ã‚Œã¦ãŠã‚Šã€UserJourneys ã¯å¤§æŠµ Extensions ã‹ã€SignInSignUp ã®å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚ã‚‹ã€‚</p><p>ä»Šå›ã¯ FIDORegistration.xml ã‚’è»½ã (?) ã¿ã¦ã„ãã€‚ã‚ãã¾ã§è»½ãã­ã€‚</p><pre class=" language-xml"><code class="language-xml">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UserJourneys</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UserJourney</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>FIDO-Registration<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationSteps</span><span class="token punctuation">></span></span>        <span class="token comment" spellcheck="true">&lt;!--Sample: Present the enrollment welcome screen--></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationStep</span> <span class="token attr-name">Order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ClaimsExchange<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchanges</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchange</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SelfAsserted-EnrollmentWelcome<span class="token punctuation">"</span></span> <span class="token attr-name">TechnicalProfileReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SelfAsserted-FIDOEnrollmentWelcome<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ClaimsExchanges</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OrchestrationStep</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationStep</span> <span class="token attr-name">Order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>CombinedSignInAndSignUp<span class="token punctuation">"</span></span> <span class="token attr-name">ContentDefinitionReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>api.signuporsignin<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsProviderSelections</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsProviderSelection</span> <span class="token attr-name">ValidationClaimsExchangeId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>LocalAccountSigninEmailExchange<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ClaimsProviderSelections</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchanges</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchange</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>LocalAccountSigninEmailExchange<span class="token punctuation">"</span></span> <span class="token attr-name">TechnicalProfileReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SelfAsserted-LocalAccountSignin-Email<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ClaimsExchanges</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OrchestrationStep</span><span class="token punctuation">></span></span>        <span class="token comment" spellcheck="true">&lt;!-- Check if the user has selected to sign in using one of the social providers --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationStep</span> <span class="token attr-name">Order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ClaimsExchange<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Preconditions</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Precondition</span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ClaimsExist<span class="token punctuation">"</span></span> <span class="token attr-name">ExecuteActionsIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Value</span><span class="token punctuation">></span></span>objectId<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Value</span><span class="token punctuation">></span></span>              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Action</span><span class="token punctuation">></span></span>SkipThisOrchestrationStep<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Action</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Precondition</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Preconditions</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchanges</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchange</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SignUpWithLogonEmailExchange<span class="token punctuation">"</span></span> <span class="token attr-name">TechnicalProfileReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>LocalAccountSignUpWithLogonEmail<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ClaimsExchanges</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OrchestrationStep</span><span class="token punctuation">></span></span>        <span class="token comment" spellcheck="true">&lt;!-- This step reads any user attributes that we may not have received when authenticating using ESTS so they can be sent           in the token. --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationStep</span> <span class="token attr-name">Order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ClaimsExchange<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchanges</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchange</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AADUserReadWithObjectId<span class="token punctuation">"</span></span> <span class="token attr-name">TechnicalProfileReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AAD-UserReadUsingObjectId<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ClaimsExchanges</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OrchestrationStep</span><span class="token punctuation">></span></span>        <span class="token comment" spellcheck="true">&lt;!--Sample: FIDO get a FIDO challenge value from the REST API service--></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationStep</span> <span class="token attr-name">Order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ClaimsExchange<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchanges</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchange</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>REST-FIDOGetChallenge<span class="token punctuation">"</span></span> <span class="token attr-name">TechnicalProfileReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>REST-FIDOGetChallenge<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ClaimsExchanges</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OrchestrationStep</span><span class="token punctuation">></span></span>        <span class="token comment" spellcheck="true">&lt;!--Sample: FIDO enrollment step--></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationStep</span> <span class="token attr-name">Order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>6<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ClaimsExchange<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchanges</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchange</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SelfAsserted-Enrollment<span class="token punctuation">"</span></span> <span class="token attr-name">TechnicalProfileReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SelfAsserted-FIDOEnrollment<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ClaimsExchanges</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OrchestrationStep</span><span class="token punctuation">></span></span>        <span class="token comment" spellcheck="true">&lt;!--Sample: FIDO enrollment persist data--></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationStep</span> <span class="token attr-name">Order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>7<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ClaimsExchange<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchanges</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchange</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AAD-UserWriteFidoUsingObjectId<span class="token punctuation">"</span></span> <span class="token attr-name">TechnicalProfileReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AAD-UserWriteFidoUsingObjectId<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ClaimsExchanges</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OrchestrationStep</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationStep</span> <span class="token attr-name">Order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>8<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SendClaims<span class="token punctuation">"</span></span> <span class="token attr-name">CpimIssuerTechnicalProfileReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>JwtIssuer<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OrchestrationSteps</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClientDefinition</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DefaultWeb<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>UserJourney</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>UserJourneys</span><span class="token punctuation">></span></span></code></pre><p>OrchestrationStep ã® 1 ~ 4 ã¾ã§ã¯é€šå¸¸ã®èªè¨¼ãƒ•ãƒ­ãƒ¼ãªã®ã§ä»Šå›ã¯ã‚¹ã‚­ãƒƒãƒ—ã€‚<br>ã„ã¤ã‹è§£èª¬è¨˜äº‹ã‚’æ›¸ã‘ãŸã‚‰ã‹ãã‹ã‚‚ã€‚</p><p>5 ãŒ API ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’å®Ÿè¡Œã™ã‚‹éƒ¨åˆ†ã€‚</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationStep</span> <span class="token attr-name">Order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ClaimsExchange<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchanges</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchange</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>REST-FIDOGetChallenge<span class="token punctuation">"</span></span> <span class="token attr-name">TechnicalProfileReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>REST-FIDOGetChallenge<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ClaimsExchanges</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OrchestrationStep</span><span class="token punctuation">></span></span></code></pre><p>TechnicalProfileReferenceId ã« <code>REST-FIDOGetChallenge&quot;</code> ã¨ã‚ã‚‹ã®ã§ã€<code>FIDOExtensions.xml</code> ã®è©²å½“ã™ã‚‹éƒ¨åˆ†ã‚’ç¢ºèªã™ã‚‹ã¨ã€‚</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TechnicalProfile</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>REST-FIDOGetChallenge<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DisplayName</span><span class="token punctuation">></span></span>GET a FIDO Challenge<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DisplayName</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Protocol</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Proprietary<span class="token punctuation">"</span></span> <span class="token attr-name">Handler</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version<span class="token punctuation">=</span>1.0.0.0, Culture<span class="token punctuation">=</span>neutral, PublicKeyToken<span class="token punctuation">=</span>null<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Metadata</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ServiceUrl<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>https://yoursite.azurewebsites.net/challenge<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AuthenticationType<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>None<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SendClaimsIn<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>QueryString<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!-- Remove in Production--></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AllowInsecureAuthInProduction<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Metadata</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaims</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>challenge<span class="token punctuation">"</span></span> <span class="token attr-name">PartnerClaimType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>result<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token comment" spellcheck="true">&lt;!--Sample: Set the identity provider name to FIDO--></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>identityProvider<span class="token punctuation">"</span></span> <span class="token attr-name">DefaultValue</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fido<span class="token punctuation">"</span></span> <span class="token attr-name">AlwaysUseDefaultValue</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OutputClaims</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UseTechnicalProfileForSessionManagement</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SM-Noop<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TechnicalProfile</span><span class="token punctuation">></span></span></code></pre><p>ã“ã‚ŒãŒ TechnicalProfile ã§ã™!</p><p>ã“ã®ã‚ˆã†ã«API ã‚’ã‚³ãƒ¼ãƒ«ã—ã¦ Challenge ã‚’å–å¾—ã—ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã­!!</p><p><code>Protocol</code> ã‚¿ã‚°ã« <code>Handler=&quot;Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null&quot;</code> ã¨æŒ‡å®šãŒã‚ã‚‹ã®ã§ã€ãŸã—ã‹ã« Rest API ã§ã™ã­!!!</p><p>ã•ã¦ã€API ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒ <a href="https://yoursite.azurewebsites.net/challenge">https://yoursite.azurewebsites.net/challenge</a> ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ä»Šå› now.sh ä¸Šã«æ§‹ç¯‰ã—ãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¤‰æ›´ã€‚</p><p>ã“ã®ä¸¦ã³ã« WebAuthn ã® Assertion ã¨ Attestation ä»–ã® API ã‚‚ã¤ã„ã§ã«ç·¨é›†ã—ã¦ãŠãã€‚</p><p>è›‡è¶³ã§ã™ãŒã€ã‚µãƒ³ãƒ—ãƒ«ã® FIDO ã‚µãƒ¼ãƒãƒ¼ãŒå¤ã„ã®ã§ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã® API ãŒ /credentials ã¨ /assertion ã«ãªã£ã¦ã„ã‚‹ãŒã€ä»Šãªã‚‰ <a href="https://fidoalliance.org/specs/fido-v2.0-rd-20180702/fido-server-v2.0-rd-20180702.html">Server Requirements and Transport Binding Profile</a> ã«æº–æ‹ ã™ã‚‹ã‚ˆã†ã«ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆåã¯ç·¨é›†ã—ãŸã»ã†ãŒã„ã„ã ã‚ã†ã€‚</p><p>ã¨ãªã‚‹ã¨ XML éƒ¨åˆ†ã‚‚ç›´ã•ãªã„ã¨ã„ã‘ãªã„ã—ã€ãã‚‚ãã‚‚ B2C ã§å¼•ãå›ã›ã‚‹ã‚¯ãƒ¬ãƒ¼ãƒ ã¨ã—ã¦ã©ã®ç¨‹åº¦ã®ãƒ‡ãƒ¼ã‚¿é‡ãŒè¡Œã‘ã‚‹ã‹ã¯ã‚ˆãã‚ã‹ã£ã¦ãªã„ã€‚<br>ã‚„ã£ã±æ™®é€šã«ã‚µãƒ¼ãƒãƒ¼ã¸ã®èªè¨¼éƒ¨åˆ†ã¯å¤–éƒ¨ã«ä¸¸æŠ•ã’ã—ã¦ã—ã¾ã£ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ ID ã¨ Authenticator ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãã‚‰ã„æŠ•ã’ãŸã‚‰ True, False ãŒè¿”ã£ã¦ãã‚‹ãã‚‰ã„å¤–éƒ¨ã®ã‚µãƒ¼ãƒãƒ¼ã‚’ä½œã‚Šã“ã‚“ã©ã„ãŸã»ã†ãŒå–ã‚Šå›ã—ã¯æ¥½ãã†ã€‚</p><p>ã¾ã‚ã‚ãã¾ã§ã‚µãƒ³ãƒ—ãƒ«ã§ã™ã€‚</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TechnicalProfile</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>REST-FIDOMakeCredential<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DisplayName</span><span class="token punctuation">></span></span>GET a FIDO Challenge<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DisplayName</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Protocol</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Proprietary<span class="token punctuation">"</span></span> <span class="token attr-name">Handler</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version<span class="token punctuation">=</span>1.0.0.0, Culture<span class="token punctuation">=</span>neutral, PublicKeyToken<span class="token punctuation">=</span>null<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Metadata</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ServiceUrl<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>https://yoursite.azurewebsites.net/credentials<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AuthenticationType<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>None<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SendClaimsIn<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Body<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!-- Remove in Production--></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AllowInsecureAuthInProduction<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Metadata</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaims</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>extension_fido_rawId<span class="token punctuation">"</span></span> <span class="token attr-name">PartnerClaimType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>clientDataJSON<span class="token punctuation">"</span></span> <span class="token attr-name">PartnerClaimType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>clientDataJSON<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>attestationObject<span class="token punctuation">"</span></span> <span class="token attr-name">PartnerClaimType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>attestationObject<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>InputClaims</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaims</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fido_publicKeyJwk<span class="token punctuation">"</span></span> <span class="token attr-name">PartnerClaimType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>publicKeyJwk<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>extension_fido_publicKeyJwk1<span class="token punctuation">"</span></span> <span class="token attr-name">PartnerClaimType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>publicKeyJwk1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>extension_fido_publicKeyJwk2<span class="token punctuation">"</span></span> <span class="token attr-name">PartnerClaimType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>publicKeyJwk2<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OutputClaims</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UseTechnicalProfileForSessionManagement</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SM-Noop<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TechnicalProfile</span><span class="token punctuation">></span></span></code></pre><p>ã“ã‚Œã¯ã€ç™»éŒ²æ™‚ã« Authenticator ã®ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹ã¨ã€ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦å…¬é–‹éµã‚’è¿”ã™ã‚³ãƒ¼ãƒ‰ã€‚<br>ã¡ãªã¿ã« Attestation ã¯å–å¾—ã—ã¦ã„ã‚‹ã‚‚ã®ã®ã€ä¿å­˜ã‚‚æ¤œè¨¼ã‚‚ã—ã¦ã„ãªã„ã®ã§æ‚ªã—ã‹ã‚‰ãšã€‚</p><p>ãªãœ publicKeyJwk1 ã¨ publicKeyJwk2 ãŒã‚ã‚‹ã®ã‹ã¨ã„ã†ã¨ã€å…ˆã»ã©ä½œæˆã—ãŸ Azure AD ã®æ‹¡å¼µå±æ€§ã«æ ¼ç´ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒ 245 æ–‡å­—ã¾ã§ãªã®ã§ã€é•·ã„å…¬é–‹éµã¯åˆ†å‰²ã—ã¦ã„ã‚‹ã‹ã‚‰ï½—</p><p>ã¡ãªã¿ã«å¯¾å¿œã™ã‚‹ API ã¯ã“ã¡ã‚‰ã€‚</p><pre class=" language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/credentials'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> credential <span class="token operator">=</span> <span class="token keyword">await</span> fido<span class="token punctuation">.</span><span class="token function">makeCredential</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> publicKeyJwkStr <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>credential<span class="token punctuation">.</span>publicKeyJwk<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">var</span> publicKeyJwk1 <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>        <span class="token keyword">var</span> publicKeyJwk2 <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>publicKeyJwkStr<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">245</span> <span class="token punctuation">)</span>        <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            publicKeyJwk1 <span class="token operator">=</span> publicKeyJwkStr<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">245</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            publicKeyJwk2 <span class="token operator">=</span> publicKeyJwkStr<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">245</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token keyword">else</span>        <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            publicKeyJwk1 <span class="token operator">=</span> publicKeyJwkStr<span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            publicKeyJwk<span class="token punctuation">:</span> publicKeyJwkStr<span class="token punctuation">,</span>            publicKeyJwk1<span class="token punctuation">:</span> publicKeyJwk1<span class="token punctuation">,</span>            publicKeyJwk2<span class="token punctuation">:</span> publicKeyJwk2        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">409</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> version<span class="token punctuation">:</span> <span class="token string">"1.0"</span><span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token number">409</span><span class="token punctuation">,</span> userMessage<span class="token punctuation">:</span> <span class="token string">'ERROR: '</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>message <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>ç›´è¦³çš„ã§ã¯ãªã„ãŒã€InputCalim ãŒ Azure AD B2C ã‹ã‚‰é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã§ã€OutputClaim ãŒ API ã‹ã‚‰è¿”ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã€‚</p><p>èªè¨¼ã™ã‚‹ã»ã†ã‚‚ç›´ã—ã¦ãŠãã€‚</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TechnicalProfile</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>REST-FIDOAssertion<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DisplayName</span><span class="token punctuation">></span></span>GET a FIDO Challenge<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DisplayName</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Protocol</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Proprietary<span class="token punctuation">"</span></span> <span class="token attr-name">Handler</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version<span class="token punctuation">=</span>1.0.0.0, Culture<span class="token punctuation">=</span>neutral, PublicKeyToken<span class="token punctuation">=</span>null<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Metadata</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ServiceUrl<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>https://yoursite.azurewebsites.net/assertion<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AuthenticationType<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>None<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SendClaimsIn<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Body<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!-- Remove in Production--></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AllowInsecureAuthInProduction<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Metadata</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaims</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>extension_fido_rawId<span class="token punctuation">"</span></span> <span class="token attr-name">PartnerClaimType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>clientDataJSON<span class="token punctuation">"</span></span>  <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userHandle<span class="token punctuation">"</span></span>  <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>signature<span class="token punctuation">"</span></span>  <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>authenticatorData<span class="token punctuation">"</span></span>  <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>extension_fido_publicKeyJwk1<span class="token punctuation">"</span></span> <span class="token attr-name">PartnerClaimType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>publicKeyJwk1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>extension_fido_publicKeyJwk2<span class="token punctuation">"</span></span> <span class="token attr-name">PartnerClaimType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>publicKeyJwk2<span class="token punctuation">"</span></span> <span class="token attr-name">DefaultValue</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>InputClaims</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UseTechnicalProfileForSessionManagement</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SM-Noop<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TechnicalProfile</span><span class="token punctuation">></span></span></code></pre><p>ã•ã£ãã‹ã‚‰ã¡ã‚ã¡ã‚ã‚ã‚‹ <code>Remove in Production</code> ã®è­¦å‘Šã¯ã€API ã®èªè¨¼ã‚’ç„¡è¦–ã™ã‚‹è¨­å®šã€‚<br>æœ¬ç•ªç’°å¢ƒã§ã¯ã€ãƒ™ãƒ¼ã‚·ãƒƒã‚¯èªè¨¼ã€ã§ãã‚Œã° <strong>è¨¼æ˜æ›¸èªè¨¼ã§ API ã‚’ä¿è­·ã—ã¦ãã ã•ã„ã€‚</strong></p><p>API ã‚’å©ãéƒ¨åˆ†ã‚’æ›¸ã„ãŸã‚‰ã€æ¬¡ã¯ step 6.</p><p>ãã‚ãã‚æ°—æŒã¡æ‚ªããªã£ã¦ãã¾ã—ãŸã­ã€‚ã¼ãã‚‚ã§ã™ã€‚</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationStep</span> <span class="token attr-name">Order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>6<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ClaimsExchange<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchanges</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchange</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SelfAsserted-Enrollment<span class="token punctuation">"</span></span> <span class="token attr-name">TechnicalProfileReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SelfAsserted-FIDOEnrollment<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ClaimsExchanges</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OrchestrationStep</span><span class="token punctuation">></span></span></code></pre><p><code>SelfAsserted-FIDOEnrollment</code> ã‚’ XML ã§æ¢ã—ã¦ã¿ã‚‹ã¨ã€ã•ã£ãã¨åŒã˜ TechnicalProfile ã‚¿ã‚°ã ã‘ã©ã€ </p><p>Handler ã« <code>Handler=&quot;Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null&quot;</code> ã¨ã‚ã‚‹ã®ã§ã€ã“ã‚Œã¯ Web ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹éƒ¨åˆ†ã§ã™ã­!?</p><p>ã•ã£ãã¨åŒã˜ãã€ç›´è¦³çš„ã§ã¯ãªã„ã§ã™ãŒ OutputClaim ãŒã€å¤–éƒ¨ã‹ã‚‰ã®å…¥åŠ›ã€ä»Šå›ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã™ã‚‹é …ç›®ã§ã™ã€‚<br>å®Ÿéš›ã«ã¯ Web ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã€OutputClaim ã¨åŒã˜ form ãŒè¿½åŠ ã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’ä¿ƒã—ã¾ã™ã€‚</p><p>ãŒã€ä»Šå›ã¯ WebAuthn ã®ã‚­ãƒ¼ã§ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãªã®ã§ã€js ã§ credentials.create ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ form ã«ã„ã„æ„Ÿã˜ã«çªã£è¾¼ã¿ã¾ã™ã€‚</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TechnicalProfile</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SelfAsserted-FIDOEnrollment<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DisplayName</span><span class="token punctuation">></span></span>Welcome to FIDO enrollment<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DisplayName</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Protocol</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Proprietary<span class="token punctuation">"</span></span> <span class="token attr-name">Handler</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version<span class="token punctuation">=</span>1.0.0.0, Culture<span class="token punctuation">=</span>neutral, PublicKeyToken<span class="token punctuation">=</span>null<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Metadata</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ContentDefinitionReferenceId<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>api.selfasserted.fido<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Metadata</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaimsTransformations</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaimsTransformation</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>CopyEmailAddress<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaimsTransformation</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>CopyDisplayName<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaimsTransformation</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>FIDOEnrollmentCreateRegistrationMessage<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>InputClaimsTransformations</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaims</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userMessage<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>readOnlyName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>readOnlyDisplayName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>objectId<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>challenge<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>InputClaims</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaims</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!--Sample: Read only claims to present to be sent the authenticator--></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userMessage<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>readOnlyName<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>readOnlyDisplayName<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>objectId<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>challenge<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token comment" spellcheck="true">&lt;!--Sample: Claims return from the authenticator --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>extension_fido_rawId<span class="token punctuation">"</span></span>  <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>clientDataJSON<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>attestationObject<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token comment" spellcheck="true">&lt;!--Sample: Bubble up claims from the validation technical profile--></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fido_publicKeyJwk<span class="token punctuation">"</span></span>  <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>extension_fido_publicKeyJwk1<span class="token punctuation">"</span></span>  <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>extension_fido_publicKeyJwk2<span class="token punctuation">"</span></span>  <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OutputClaims</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ValidationTechnicalProfiles</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ValidationTechnicalProfile</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>REST-FIDOMakeCredential<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ValidationTechnicalProfiles</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UseTechnicalProfileForSessionManagement</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SM-Noop<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TechnicalProfile</span><span class="token punctuation">></span></span></code></pre><p>ã©ã†ã‚„ã£ã¦çªã£è¾¼ã‚“ã§ã‚‹ã®? ã£ã¦ã¨ã“ã‚ã¯ã€ã•ã£ãä¸Šã’ãŸ HTML ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã‚’è¦‹ã‚Œã°åˆ†ã‹ã‚‹ã€‚<br>XML ã«çªã£è¾¼ã‚€éƒ¨åˆ†ã¯ <code>ContentDefinitionReferenceId</code> ã® <code>api.selfasserted.fido</code> ã«ã‚ã‚‹ã€LoadUri ã®å®šç¾©éƒ¨åˆ†ã‚’ç¢ºèªã€‚</p><pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!--Sample: FIDO self-asserted HTML page--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ContentDefinition</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>api.selfasserted.fido<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LoadUri</span><span class="token punctuation">></span></span>https://yourtenant.blob.core.windows.net/azure-ad-b2c/fido/self-asserted.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LoadUri</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RecoveryUri</span><span class="token punctuation">></span></span>~/common/default_page_error.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RecoveryUri</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DataUri</span><span class="token punctuation">></span></span>urn:com:microsoft:aad:b2c:elements:contract:selfasserted:1.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DataUri</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ContentDefinition</span><span class="token punctuation">></span></span>`</code></pre><p>html å†…ã® javascript ã®å½“è©²ã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã€‚<br>ã„ã¤ã‚‚ã® credentials.get ã‚³ãƒãƒ³ãƒ‰ã®çµ‚äº†å¾Œã«ã€HTML ã®ãƒ•ã‚©ãƒ¼ãƒ ã«æˆ»ã‚Šå€¤ã‚’çªã£è¾¼ã‚“ã§ã¾ã™ã€‚<br>B2C ã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¿”ã—ã¦ã—ã‹å€¤ã‚’å–ã‚Œãªã„ã®ã â€¦ã€‚</p><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createCredential</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"createCredential started"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>PublicKeyCredential <span class="token operator">||</span> <span class="token keyword">typeof</span> PublicKeyCredential<span class="token punctuation">.</span>isUserVerifyingPlatformAuthenticatorAvailable <span class="token operator">!==</span> <span class="token string">"function"</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">"WebAuthn APIs are not available on this user agent."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> attachment <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"input[name='attachment']:checked"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> createCredentialOptions <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        rp<span class="token punctuation">:</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            name<span class="token punctuation">:</span> <span class="token string">"WebAuthn Sample App"</span><span class="token punctuation">,</span>            icon<span class="token punctuation">:</span> <span class="token string">"https://example.com/rpIcon.png"</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span>        user<span class="token punctuation">:</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            id<span class="token punctuation">:</span> <span class="token function">stringToArrayBuffer</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#objectId"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            name<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#readOnlyName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            displayName<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#readOnlyDisplayName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            icon<span class="token punctuation">:</span> <span class="token string">"https://example.com/userIcon.png"</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span>        pubKeyCredParams<span class="token punctuation">:</span> <span class="token punctuation">[</span>            <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//External authenticators support the ES256 algorithm</span>                type<span class="token punctuation">:</span> <span class="token string">"public-key"</span><span class="token punctuation">,</span>                alg<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">7</span>                             <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span>             <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//Windows Hello supports the RS256 algorithm</span>                type<span class="token punctuation">:</span> <span class="token string">"public-key"</span><span class="token punctuation">,</span>                alg<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">257</span>            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        authenticatorSelection<span class="token punctuation">:</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//Select authenticators that support username-less flows</span>            requireResidentKey<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//Select authenticators that have a second factor (e.g. PIN, Bio)</span>            userVerification<span class="token punctuation">:</span> <span class="token string">"required"</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//Selects between bound or detachable authenticators</span>            authenticatorAttachment<span class="token punctuation">:</span> attachment        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//Since Edge shows UI, it is better to select larger timeout values</span>        timeout<span class="token punctuation">:</span> <span class="token number">50000</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//an opaque challenge that the authenticator signs over</span>        challenge<span class="token punctuation">:</span>  <span class="token function">stringToArrayBuffer</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#challenge"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//prevent re-registration by specifying existing credentials here</span>        excludeCredentials<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">//specifies whether you need an attestation statement</span>        attestation<span class="token punctuation">:</span> <span class="token string">"none"</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> navigator<span class="token punctuation">.</span>credentials<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        publicKey<span class="token punctuation">:</span> createCredentialOptions    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>rawAttestation <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#extension_fido_rawId"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token function">base64encode</span><span class="token punctuation">(</span>rawAttestation<span class="token punctuation">.</span>rawId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#clientDataJSON"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token function">base64encode</span><span class="token punctuation">(</span>rawAttestation<span class="token punctuation">.</span>response<span class="token punctuation">.</span>clientDataJSON<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#attestationObject"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token function">base64encode</span><span class="token punctuation">(</span>rawAttestation<span class="token punctuation">.</span>response<span class="token punctuation">.</span>attestationObject<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">"credentialId"</span><span class="token punctuation">,</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#extension_fido_rawId"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#status"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">"Successfully created credential with ID: "</span> <span class="token operator">+</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#extension_fido_rawId"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDebug<span class="token punctuation">)</span>            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#continue"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span></code></pre><p>ã¨ã€ã„ã†ã“ã¨ã§ã€ã‚³ã‚³ã® URI ã‚’ã•ã£ã Gist ã«ä¸Šã’ãŸ URI ã«å¤‰æ›´ã—ã¦ãŠãã€‚ä¸¦ã³ã‚‚ã¤ã„ã§ã«ä¿®æ­£ã€‚</p><p><a href="https://gist.githubusercontent.com/watahani/f94a8362a4cc075a67254eb403c9c1c7/raw/e83697aa603d0c11b78d9f503b4885ac84695601/self-asserted.html">https://gist.githubusercontent.com/watahani/f94a8362a4cc075a67254eb403c9c1c7/raw/e83697aa603d0c11b78d9f503b4885ac84695601/self-asserted.html</a></p><pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!--Sample: FIDO welcome self-asserted HTML page--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ContentDefinition</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>api.selfasserted.fido.welcome<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LoadUri</span><span class="token punctuation">></span></span>https://gist.githubusercontent.com/watahani/a49bec0c38ad1e2540b829ee4121d8ba/raw/dc5eaa4c36b80459980eae312861fac7339b269c/welcome.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LoadUri</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RecoveryUri</span><span class="token punctuation">></span></span>~/common/default_page_error.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RecoveryUri</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DataUri</span><span class="token punctuation">></span></span>urn:com:microsoft:aad:b2c:elements:contract:selfasserted:1.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DataUri</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ContentDefinition</span><span class="token punctuation">></span></span></code></pre><p>ã„ã‚ˆã„ã‚ˆã‚¢ã‚¿ãƒãŒç—›ããªã£ã¦ãã¾ã—ãŸãŒã€æœ€å¾Œã§ã™ã€‚<br>step 7 ã® <code>AAD-UserWriteFidoUsingObjectId</code> ã‚’ç¢ºèªã™ã‚‹ã€‚</p><pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!--Sample: FIDO enrollment persist data--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationStep</span> <span class="token attr-name">Order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>7<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ClaimsExchange<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchanges</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchange</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AAD-UserWriteFidoUsingObjectId<span class="token punctuation">"</span></span> <span class="token attr-name">TechnicalProfileReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AAD-UserWriteFidoUsingObjectId<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ClaimsExchanges</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OrchestrationStep</span><span class="token punctuation">></span></span></code></pre><p>ã¯ã„ã€ãã‚ãã‚è¦‹æ…£ã‚Œã¦ããŸ TechnicalProfile ã§ã™ãŒã€Protocol ãŒãªã„ã€‚<br>ä»£ã‚ã‚Šã« IncludeTechnicalProfile ãŒã‚ã‚‹ã®ã§ãã¡ã‚‰ã‚’è¦‹ã¦ã¿ã‚‹ã¨â€¦</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TechnicalProfile</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AAD-UserWriteFidoUsingObjectId<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Metadata</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Operation<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Write<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>RaiseErrorIfClaimsPrincipalAlreadyExists<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>RaiseErrorIfClaimsPrincipalDoesNotExist<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Metadata</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>IncludeInSso</span><span class="token punctuation">></span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>IncludeInSso</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaims</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>objectId<span class="token punctuation">"</span></span> <span class="token attr-name">Required</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>InputClaims</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PersistedClaims</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!-- Required claims --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PersistedClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>objectId<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token comment" spellcheck="true">&lt;!-- Sample: Writ FIDO claims to the user account --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PersistedClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>extension_fido_publicKeyJwk1<span class="token punctuation">"</span></span> <span class="token attr-name">DefaultValue</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PersistedClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>extension_fido_publicKeyJwk2<span class="token punctuation">"</span></span> <span class="token attr-name">DefaultValue</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PersistedClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>extension_fido_rawId<span class="token punctuation">"</span></span> <span class="token attr-name">DefaultValue</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PersistedClaims</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>IncludeTechnicalProfile</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AAD-Common<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TechnicalProfile</span><span class="token punctuation">></span></span></code></pre><p>AAD-Common ã® TechnicalProfile ã‚’è¦‹ã‚‹ã¨ã€å…ˆã»ã©ä½œæˆã—ãŸã‚¢ãƒ—ãƒªã® Object ID ã¨ Client ID (ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ID) ã‚’å…¥ã‚Œã‚‹ã¨ã“ã‚ãŒã‚ã‚‹!<br>ãã†ã€ã‚³ã‚³ãŒæ‹¡å¼µå±æ€§ã‚’æ›¸ãè¾¼ã‚€ã‚¢ãƒ—ãƒªãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹éƒ¨åˆ†ã€‚</p><p>ã¨ã„ã†ã“ã¨ã§ã€ã•ã£ãä½œæˆã—ãŸã‚¢ãƒ—ãƒªã® Client ID ã¨ Object ID ã‚’çªã£è¾¼ã‚€ã€‚</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TechnicalProfile</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AAD-Common<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DisplayName</span><span class="token punctuation">></span></span>Azure Active Directory<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DisplayName</span><span class="token punctuation">></span></span>  <span class="token comment" spellcheck="true">&lt;!--  Sample: Provide objectId and appId before using extension properties.        For more information: https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-create-custom-attributes-profile-edit-custom         Action required: Insert objectId and appId here --></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Metadata</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ApplicationObjectId<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ ID<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ClientId<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ID<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Metadata</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TechnicalProfile</span><span class="token punctuation">></span></span></code></pre><p>XML ã®ç·¨é›†ã¯ä»¥ä¸Šã§çµ‚äº†ã€‚</p><p>æœ€å¾Œã® step 8 ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã€‚</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationStep</span> <span class="token attr-name">Order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>8<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SendClaims<span class="token punctuation">"</span></span> <span class="token attr-name">CpimIssuerTechnicalProfileReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>JwtIssuer<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code></pre><p>ã“ã“ã¾ã§é›†ã‚ãŸ Claims ã‚’ Jwt å½¢å¼ã«ã—ã¦ sign ã—ã¦ã‚¢ãƒ—ãƒªã«é€ä¿¡ã™ã‚‹ã ã‘ã€‚</p><p>è«¸ã€…é£›ã°ã—ãŸã¨ã“ã‚ã¯ã‚ã‚Šã¾ã™ãŒã€ã²ã¨ã¾ãš XML ã®ä½œæˆã¯å®Œäº†ã—ãŸã®ã§ B2C ã«ãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ãƒƒãƒ—ã—ã‚ˆã†ã€‚<br>ã‚¢ãƒƒãƒ—ã§ããªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã€é ‘å¼µã£ã¦ç›´ã—ã¦ãã ã•ã„â€¦ã€‚</p><p>ã•ã¦ã€ã“ã“ã¾ã§ã‚„ã‚Šé‚ã’ãŸã‚ãªãŸãªã‚‰ã€å…ˆã»ã©ã®å›³ã‚‚ç†è§£ã§ãã‚‹ã¯ãšã§ã™ã­ã€‚</p><p><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/b2ccomponent.png" alt=""></p><p>ç´ æ™´ã‚‰ã—ã„ï¼ XML ãŒä¸–ç•Œã‚’å›ã—ã¦ã„ã‚‹ã“ã¨ã‚’å®Ÿæ„Ÿã—ã¾ã™ã­!?</p><h2 id="å‹•ä½œç¢ºèª"><a href="#å‹•ä½œç¢ºèª" class="headerlink" title="å‹•ä½œç¢ºèª"></a>å‹•ä½œç¢ºèª</h2><p>æœ€å¾Œã«å‹•ä½œç¢ºèªã‚’ã—ã¦ã€å®Ÿéš›ã®å‹•ãã‚’ç¢ºã‹ã‚ã¦ã¿ã‚‹ã€‚</p><h3 id="ãƒ¬ã‚¸ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³-ãƒ•ãƒ­ãƒ¼"><a href="#ãƒ¬ã‚¸ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³-ãƒ•ãƒ­ãƒ¼" class="headerlink" title="ãƒ¬ã‚¸ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ•ãƒ­ãƒ¼"></a>ãƒ¬ã‚¸ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ•ãƒ­ãƒ¼</h3><p>Authenticator ã®ç™»éŒ²ã«ã¯ã€æ—¢å­˜ã®è³‡æ ¼æƒ…å ± (ã“ã“ã§ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰) ã‚’å…¥åŠ›ã™ã‚‹ã€‚<br>å®Ÿéš›ã«é‹ç”¨ã™ã‚‹ãªã‚‰ã€MFA ã‚’çªç ´ã—ãŸå¾Œã®ã»ã†ãŒã„ã„ã‘ã©ã€ã“ã‚Œä»¥ä¸Š XML ã¯å¼„ã‚ŠãŸããªã„ã®ã§ã€‚</p><p>ç™»éŒ²ã®å‰ã«ã¯ã€å†åº¦è³‡æ ¼æƒ…å ±ãŒå¿…è¦ã¨ã„ã†è­¦å‘Šã‚’è¡¨ç¤ºã—ã¦</p><p><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_01.png" alt=""></p><p>è³‡æ ¼æƒ…å ±ã‚’å…¥ã‚Œã¦<br><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_02.png" alt=""></p><p>Platform Authenticator ã‹ Cross-Platform Authenticator ã‹ã‚’é¸ã¶ã€‚<br>ä»Šå›ã¯ SoloKey ã‚’ä½¿ã†ã®ã§ Cross-Platform Authenticatorã€‚</p><p><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_03.png" alt=""></p><p>Attestation è¦æ±‚ã—ã¦ã„ã‚‹ã®ã§è­¦å‘ŠãŒã§ã¦ã€ã„ã¤ã‚‚ã®ã€‚</p><p><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_04.png" alt=""></p><p>id_token ãŒç™ºè¡Œã•ã‚Œã‚‹ã€‚</p><p><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_05.png" alt=""></p><h3 id="ã‚µã‚¤ãƒ³ã‚¤ãƒ³-ãƒ•ãƒ­ãƒ¼"><a href="#ã‚µã‚¤ãƒ³ã‚¤ãƒ³-ãƒ•ãƒ­ãƒ¼" class="headerlink" title="ã‚µã‚¤ãƒ³ã‚¤ãƒ³ ãƒ•ãƒ­ãƒ¼"></a>ã‚µã‚¤ãƒ³ã‚¤ãƒ³ ãƒ•ãƒ­ãƒ¼</h3><p>ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã®éš›ã¯ã€FIDO ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦</p><p><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_06.png" alt=""></p><p>Authenticate ãƒœã‚¿ãƒ³ã§ js ãŒå‘¼ã°ã‚Œã¦<br><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_07.png" alt=""></p><p>ã„ ã¤ ã‚‚ ã®<br><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_08.png" alt=""></p><p>id_token ãŒç™ºè¡Œã•ã‚Œã‚‹ã€‚<br><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_09.png" alt=""></p><p>Debug ãƒœã‚¿ãƒ³ã§ hidden çŠ¶æ…‹ã® form ã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚<br><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_10.png" alt=""></p><p>WebAuthn ã®å…¬é–‹éµã«ã¤ã„ã¦ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‹¡å¼µå±æ€§ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã€‚<br>ãªã‚“ã§ã‹ Azure AD B2C ãƒ†ãƒŠãƒ³ãƒˆã¯ Microsoft Graph API ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ (ä½¿ãˆã‚‹ã‘ã©) ã®ã§ã€Azure AD Graph ã‚’å©ã„ã¦ç¢ºèªã™ã‚‹ã€‚</p><p>ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã¨ã€ç¢ºã‹ã«å…¬é–‹éµãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã€‚</p><ul><li>Azure AD Graph Explorer<br><a href="https://graphexplorer.azurewebsites.net/#">https://graphexplorer.azurewebsites.net/#</a></li></ul><p><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/extensionsvalue.png" alt=""></p><h2 id="ã¾ã¨ã‚"><a href="#ã¾ã¨ã‚" class="headerlink" title="ã¾ã¨ã‚"></a>ã¾ã¨ã‚</h2><p>ä»Šå›ã¯ Azure AD B2C ã« FIDO2 ã‚’çµ„ã¿è¾¼ã‚€ã‚µãƒ³ãƒ—ãƒ«ã‚’å‹•ã‹ã—ã¦ã¿ãŸã€‚<br>XML ã‚’èª­ã¿è§£ãã®ã¯æœã¦ã—ãªãã¤ã‚‰ã„ä½œæ¥­ã ã£ãŸãŒã€å‹•ã„ã¦ã„ã‚‹ã®ã‚’è¦‹ã‚‹ã¨ã„ã¨ãŠã—ãæ„Ÿã˜ã¦ãã‚‹ã‹ã‚‰ä¸æ€è­°ã§ã‚ã‚‹ã€‚</p><p>ã“ã“ã¾ã§è‰²ã€…ã„ã˜ã‚Œ (ã¦ã—ã¾ãˆ) ã‚‹ OP ã¯ä¸­ã€…ãªãã€XML ã®ã¤ãªãŒã‚Šã‚’è¾¿ã‚‹ã®ã¯æœã¦ã—ãªãã¤ã‚‰ã„ä½œæ¥­ã ãŒã€ã‚¯ãƒ¬ãƒ¼ãƒ ã®å¤‰æ›ã‚„æ¤œè¨¼ã€Azure AD ã¸ã®æ›¸ãè¾¼ã¿ã‚„èª­ã¿è¾¼ã¿ãªã©ã€éå¸¸ã«ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–ãªå‹•ä½œã‚’ãªã‚“ã¨ãªãä½“é¨“ã§ãã‚‹é¢ç™½ã„ã‚ªãƒ¢ãƒãƒ£ãªã®ã§ã€èˆˆå‘³ãŒã‚ã‚‹äººã¯è§¦ã£ã¦ã¿ã¦ã»ã—ã„ã€‚</p><p>ãŸã ã€XML ã‚’å¼„ã‚‹ã®ã¯æœã¦ã—ãªãã¤ã‚‰ã„ä½œæ¥­ãªã®ã§ã€ç§ã¯ã—ã°ã‚‰ãè¦‹ãŸããªã„ã€‚ä»¥ä¸Šã€‚</p><p>æ˜æ—¥ã® Advent Calendar ã¯ <a href="https://twitter.com/@kishisuke">@kishisuke</a> ã® Sign In with Apple ã§ã™ã€‚</p><p>ãã†ã„ãˆã°ã€èª°ã‹ãŒ Sign In Apple ã‚‚ Azure AD B2C ã«ã¤ãªã„ã§ã¾ã—ãŸã­ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ã“ã®è¨˜äº‹ã¯&lt;a href=&quot;https://qiita.com/advent-calendar/2019/identity&quot;&gt;èªè¨¼èªå¯ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼&lt;/a&gt; ã®6æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚&lt;/p&gt;
&lt;p&gt;å‹•æ©Ÿ: ã‚„ã£ã± OIDC ãƒã‚¿ã¨ FIDO ãƒã‚¿ãŒå¤šã„ã‹ã‚‰ã€&lt;strong&gt;ã©ã£ã¡ã‚‚çµ¡ã‚ãŸã‚„ã¤ã‚’æ›¸ã‘ã°ã‚ã£ã¡ã‚ƒã‚¦ã‚±ã‚‹ã®ã§ã¯ï¼Ÿ&lt;/strong&gt;&lt;br&gt;â†’ Azure AD B2C ã« WebAuthn ã«ã‚ˆã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¬ã‚¹ ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’å®Ÿè£…ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚ã£ãŸãªã‚â€¦&lt;/p&gt;
&lt;p&gt;ã¨ã€è‹¦ã—ç´›ã‚Œã«ãƒã‚¿ã‚’ã²ã­ã‚Šå‡ºã—ãŸçµæœã€ãã£ããƒ‹ãƒƒãƒãªè¨˜äº‹ã«ãªã£ã¦ã—ã¾ã£ãŸã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Azure" scheme="http://blog.haniyama.com/tags/Azure/"/>
    
      <category term="OAuth" scheme="http://blog.haniyama.com/tags/OAuth/"/>
    
      <category term="FIDO2" scheme="http://blog.haniyama.com/tags/FIDO2/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Ignite 2019 ãƒ¡ãƒ¢</title>
    <link href="http://blog.haniyama.com/2019/11/24/ms-ignite-2019/"/>
    <id>http://blog.haniyama.com/2019/11/24/ms-ignite-2019/</id>
    <published>2019-11-24T01:40:00.000Z</published>
    <updated>2022-05-18T13:45:29.097Z</updated>
    
    <content type="html"><![CDATA[<p>Microsoft Ignite 2019 ãŒä»Šå¹´ã‚‚é–‹å‚¬ã•ã‚Œã¦ã¾ã—ãŸã­ã€‚</p><p>ä»Šå¹´ã‚‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ¼ã«é–¢ã—ã¦ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒã‚ã£ãŸã‘ã©ã€ãƒã‚±ãƒ¢ãƒ³å‰£ç›¾ã§æ™‚é–“ã¨ã‚‰ã‚Œã¦ã€ä½™è£•ãªã„ã®ã§é›‘ã«ãƒ¡ãƒ¢ã€‚</p><p>å­µåŒ–ã‚ã¾ã‚Šã€ã ã‚Œã‹äº¤æ›ã—ã¾ã—ã‚‡ã†ã€‚</p><span id="more"></span><p>å»å¹´ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ¼ã§ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³å«ã‚€ã€WebAuthn, ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¬ã‚¹ç³»ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’èã„ã¦ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ä¸Šã’ã¦ã¾ã—ãŸã­ãƒ¼ã€‚ã‚‚ã†ä¸€å¹´ã‹ã€æ—©ã„ã‚‚ã‚“ã ã€‚</p><h2 id="BRK2130-Azure-Active-Directory-New-features-and-roadmap"><a href="#BRK2130-Azure-Active-Directory-New-features-and-roadmap" class="headerlink" title="BRK2130 Azure Active Directory: New features and roadmap"></a>BRK2130 Azure Active Directory: New features and roadmap</h2><p><a href="https://myignite.techcommunity.microsoft.com/sessions/81713?source=sessions">https://myignite.techcommunity.microsoft.com/sessions/81713?source=sessions</a></p><p>Azure AD ã®æ–°æ©Ÿèƒ½ã®ãŠè©±ã€‚</p><ul><li>SaaS ã‚¢ãƒ—ãƒªã¨ã® SCIM ã«ã‚ˆã‚‹ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°<ul><li>Salesforce, Facebook ç­‰ã¸ã¯ SCIM ã§æ¥ç¶šæ¸ˆã¿</li><li>ãªã‚“ã‹è¦‹ã¦ã‚‹ã¨ã€3rd Party ã® ID ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ Azure AD ã¸ã®åŒæœŸã‚‚ã§ããã†ãªé›°å›²æ°—</li><li>SaaS &#x3D;&gt; AAD ã‚‚ SCIM ãªã®ã‹ãªâ€¦ï¼Ÿ</li></ul></li><li>ã‚ªãƒ³ãƒ—ãƒ¬ã¨ã®åŒæœŸãƒ„ãƒ¼ãƒ«ã€Azure AD Cloud Provisioning<ul><li>(ã‚°ã‚°ãƒ©ãƒ“ãƒªãƒ†ã‚£ä½ããªã„ï¼Ÿ)</li><li>è»½é‡ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã ã‘ã§è¨­å®šã¯ã‚¯ãƒ©ã‚¦ãƒ‰</li><li>ä¸‰äº•ä½å‹? ã® 200 ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆã‚ã‚‹ãƒ†ãƒŠãƒ³ãƒˆã§è©¦ã—ã¦ãŸï¼Ÿ (è‹±èªèãå–ã‚Œãš)</li><li>MIM ã¨ã‹çŸ¥ã‚‰ãªã„ã£ã™ã€‚</li></ul></li><li>First Worker å‘ã‘æ©Ÿèƒ½<ul><li>è£½é€ ãƒ»å°å£²ã‚Šç­‰ã®å¾“æ¥­å“¡å‘ã‘ã£ã½ã„</li><li>ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã¨ <strong>é›»è©±ç•ªå·ã§ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³!</strong></li></ul></li><li>B2B ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼))<ul><li>Google, Okta, Ping Fed ã‚„ã€ä»–ç¤¾ã® AD FS ã‹ã‚‰ç›´æ¥ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µã‚¤ãƒ³ã‚¤ãƒ³ã§ãã‚‹</li><li>ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/b2b/direct-federation">ã“ã®ã¸ã‚“</a></li></ul></li><li>ã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ãƒãƒ«ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«ã‚ˆã‚‹ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°æ©Ÿèƒ½<ul><li>ãªã‚“ã§ä»Šã¾ã§ãªã‹ã£ãŸã‚“ã‚„â€¦</li></ul></li><li>Entitlement Management ã¨å¤–éƒ¨ãƒ„ãƒ¼ãƒ«ã«ã‚ˆã‚‹? æ¨©é™ç”³è«‹ãƒ»æ‰¿èªãƒ•ãƒ­ãƒ¼ã®ãƒ‡ãƒ¢</li><li>Azure AD ã® Availability ã®ã¯ãªã—</li><li>ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ç’°å¢ƒã¸ã® FIDO2 Security Key ã«ã‚ˆã‚‹ã‚µã‚¤ãƒ³ã‚¤ãƒ³<ul><li>Hybrid Azure AD Joined ç’°å¢ƒã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ¼ã§ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã§ãã‚‹</li><li>FY20Q1  Public Preview ã®äºˆå®šâ€¦ã‚‰ã—ã„</li></ul></li><li>æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã®ãƒ¬ãƒãƒ¼ãƒˆ ã‚ªãƒ³ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰<ul><li>æ¡ä»¶ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã®è¨­å®šãƒ†ã‚¹ãƒˆã®ãŸã‚ã«ã€ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒ­ã‚°ã«å‡ºã™ã ã‘ã§ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ãƒ¢ãƒ¼ãƒ‰</li></ul></li></ul><p>ç››ã‚Šã ãã•ã‚“ã ã‘ã©ã€æ°—ã«ãªã£ãŸã®ã¯ First Worker å‘ã‘ã®é›»è©±ç•ªå·ã§ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã¨ã€Hybrid Azure AD ç’°å¢ƒã§ã® FIDO2 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ¼ã€‚</p><p>ã‚ã¨ SCIM è§¦ã£ãŸã“ã¨ãªã„ã®ã§ã€ã©ã£ã‹ã§è§¦ã£ã¦ãŠããŸã„ã€‚</p><h2 id="Eliminate-your-weakest-link-with-passwordless-authentication"><a href="#Eliminate-your-weakest-link-with-passwordless-authentication" class="headerlink" title="Eliminate your weakest link with passwordless authentication"></a>Eliminate your weakest link with passwordless authentication</h2><p><a href="https://myignite.techcommunity.microsoft.com/sessions/81716?source=sessions">https://myignite.techcommunity.microsoft.com/sessions/81716?source=sessions</a></p><p>Hybrid ç’°å¢ƒã§ã® FIDO2 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ¼ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã€‚2020å¹´ã®å§‹ã‚ã«ãƒ‘ãƒ–ãƒªãƒƒã‚¯ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®äºˆå®šã€‚</p><p>Azure AD Connect ã®æœ€æ–°ç‰ˆ + Win10 ã® Insider Build + ãƒ‰ãƒ¡ã‚³ãƒ³ã¸ã®ãƒ‘ãƒƒãƒãŒå¿…è¦ã‚‰ã—ã„ã€‚</p><p>ãƒ•ãƒ­ãƒ¼ã¯ã“ã‚“ãªæ„Ÿã˜</p><p><img src="/2019/11/24/ms-ignite-2019/auth-flow.png"></p><ul><li>(0) Azure AD Connect ã§ Kerberos Server keys ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ã‚‚ã£ã¦ã„ã</li><li>WebAuthn ã§èªè¨¼</li><li>AAD ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã ã‘å…¥ã£ãŸä¸€æ™‚çš„ãª TGT ãƒã‚±ãƒƒãƒˆã‚’åŒæœŸã—ãŸç§˜å¯†éµã§ç”Ÿæˆã—ã¦å–å¾—</li><li>PRT ã¨ä¸€ç·’ã« Windows 10 ãŒå—ã‘å–ã‚‹</li><li>ã‚ªãƒ³ãƒ—ãƒ¬ã® AD ã« ä¸€æ™‚çš„ãª TGT ãƒã‚±ãƒƒãƒˆã‚’æç¤º</li><li>ã‚ªãƒ³ãƒ—ãƒ¬ AD ãŒå®Œå…¨ãª TGT ãƒã‚±ãƒƒãƒˆã‚’è¿”å´</li></ul><p>ã“ã‚Œã€AD ã«ã¤ãªãŒã‚‰ãªã„ã¨ãã¯ã©ã‚“ãªå‹•ãã™ã‚‹ã‚“ã ã‚ã†ã€‚æ™®é€šã« PRT è½ã¡ã¦ãã¦ã‚‹ã‹ã‚‰ã€Azure AD ã«å¯¾ã—ã¦ã¯èªè¨¼ã§ããã†ã€‚</p><p>ã‚ã¨ã¯ Kerberos Server keys ã‚’çµ„ç¹”ã®å¤–ã«åŒæœŸã™ã‚‹ã£ã¦ã€ã©ã®ç¨‹åº¦ã®ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆãªã®ã‹ã‚ˆãã‚ã‹ã‚‰ã‚“ã€‚</p><p>ãã—ã¦å‹•ã‹ã‚“ããªã£ãŸã¨ãã®ãƒ‡ãƒãƒƒã‚°ã¤ã‚‰ãã†ï½—</p><p>ã‚ã¨ã¯ã€Windows ã¨ CTAP2 ã®çµ±åˆã€‚</p><p><img src="/2019/11/24/ms-ignite-2019/winconf.png"></p><p><img src="/2019/11/24/ms-ignite-2019/winconffinger.png"></p><p>æŒ‡ç´‹ã‚„ PIN ã®è¨­å®šã‚’ Windows ã®è¨­å®šã‹ã‚‰è¡Œãˆã‚‹ã‚ˆã†ã«ãªã£ãŸã¨ã®ã“ã¨ã€‚ãƒ‡ãƒ¢ã§ã¯å¤±æ•—ã—ã¦ãŸã‘ã©ã€‚</p><p>Biometrics ç³»ã® API ã£ã¦æ¨™æº–åŒ–ã•ã‚Œã¦ã‚‹ã‚“ã‹ãªã€‚ã“ã®è¾ºæœ€è¿‘è¿½ã£ã¦ãªã„ã®ã§ã‚ã‹ã‚‰ã‚“ã€‚</p><h3 id="ã¾ã¨ã‚"><a href="#ã¾ã¨ã‚" class="headerlink" title="ã¾ã¨ã‚"></a>ã¾ã¨ã‚</h3><p><img src="/2019/11/24/ms-ignite-2019/funnel.png"></p><p><img src="/2019/11/24/ms-ignite-2019/roadmap.png"></p><p>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¬ã‚¹ã¸ç§»è¡Œã™ã‚‹ãŸã‚ã®é“ç­‹çš„ãªã®ã¯ã“ã£ã¡</p><ul><li>THR3076 Get the most out of passwordless authentication and avoid pitfalls<br><a href="https://myignite.techcommunity.microsoft.com/sessions/81735?source=sessions">https://myignite.techcommunity.microsoft.com/sessions/81735?source=sessions</a></li></ul><p>ãƒ‡ãƒã‚¤ã‚¹ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚µã‚¤ã‚¯ãƒ«ã«åˆã‚ã›ã¦ TPM ä½¿ãˆã‚‹ãƒã‚·ãƒ³ã«ã—ã‚ã¨ã‹ã€MSAL ä½¿ã£ãŸ OIDC ã®èªè¨¼ã«åˆ‡ã‚Šæ›¿ãˆã‚è¦‹ãŸã„ãªè©±ã—ã‚’ã—ã¦ã„ãŸã¨æ€ã†ã€‚(ã¡ã‚ƒã‚“ã¨èã„ã¦ãªã„)</p><p><img src="/2019/11/24/ms-ignite-2019/passwordlessjourney.png"></p><h2 id="BRK2261-Empower-firstline-worker-productivity-from-day-one"><a href="#BRK2261-Empower-firstline-worker-productivity-from-day-one" class="headerlink" title="BRK2261 Empower firstline worker productivity from day one"></a>BRK2261 Empower firstline worker productivity from day one</h2><p><a href="https://myignite.techcommunity.microsoft.com/sessions/81630?source=sessions">https://myignite.techcommunity.microsoft.com/sessions/81630?source=sessions</a></p><p>AAD æ–°æ©Ÿèƒ½ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¿ã¦ã¡ã‚‡ã£ã¨æ°—ã«ãªã£ãŸã®ã§ã€‚</p><p><img src="/2019/11/24/ms-ignite-2019/firstlineworker.png"></p><p>FirstLine Worker ã£ã¦è¨€è‘‰ã‚’çŸ¥ã‚‰ãªã‹ã£ãŸã‚“ã ã‘ã©ã€å°å£²åº—ã‚„è£½é€ æ¥­ã®ã€åº—èˆ—å¾“æ¥­å“¡ã‚„ä½œæ¥­å“¡ã¨ã„ã£ãŸæ„å‘³ã‚‰ã—ã„ã€‚</p><p>ãã†ã„ã£ãŸäººãŸã¡ã«ã‚‚ã€Teams ã‚„ã‚‰ Shift (Staff Hub ã®å¾Œç¶™) ã‚’ä½¿ã£ã¦ã‚‚ã‚‰ã£ã¦ã€ä»•äº‹åŠ¹ç‡é«˜ã‚ã‚ˆã†ã¨ã„ã†è©±ã€‚</p><p>MS ã‚·ãƒ•ãƒˆç®¡ç†ãƒ„ãƒ¼ãƒ«ã¾ã§æŒã£ã¦ã‚‹ã‚“ã‹â€¦ã€‚Staff Hub ã¨ã‹èã„ãŸã“ã¨ãªã‹ã£ãŸã‚ã€‚</p><p>ã¯ã€ç½®ã„ã¨ã„ã¦ã€ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã—ã¦ä½¿ã„å§‹ã‚ã¦ã‚‚ã‚‰ã†ã£ã¦ã„ã†æ–‡è„ˆã§ã€ç®¡ç†è€…ãŒè¨­å®šã—ãŸé›»è©±ç•ªå·ã«ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ  ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰é€ã£ã¦ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãŒã§ãã‚‹ã¨ã„ã†æ©Ÿèƒ½ã€‚<br>Y!ã£ã½ã„ã‚ã‚Œã§ã™ã­ã€‚</p><p><img src="/2019/11/24/ms-ignite-2019/workday-provisioning.png"></p><p>HR ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã—ã¦ã€Teams ã®ãƒãƒ£ãƒãƒ«ã«è‡ªå‹•æ‹›å¾…ã€‚ã‚ã¨é›»è©±ç•ªå·ã‚‚ç™»éŒ²ã€‚</p><p><img src="/2019/11/24/ms-ignite-2019/signin-with-phone-number.png"></p><p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®é›»è©±ç•ªå·ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã™ã‚‹ã ã‘ã€‚</p><p>è¤‡æ•°ã®çµ„ç¹”ã«æ‰€å±ã—ã¦ãŸã‚‰ã©ã†ãªã‚‹ã‚“ã ã‚ã†ã¨ã‹ã€æ°—ã«ãªã‚‹ã¨ã“ã‚ã¯ã‚ã‚‹ã‘ã©ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ ãƒªã‚»ãƒƒãƒˆã®ãƒ˜ãƒ«ãƒ—ã‚»ãƒ³ã‚¿ãƒ¼ã®ç®¡ç†ã™ã‚‹ã‚ˆã‚Šãšã£ã¨ã„ã„ã‚“ã˜ã‚ƒãªã„ã§ã—ã‚‡ã†ã‹ã€‚</p><p>ä»Šæ—¥ã¯ãƒ’ãƒãƒ‹ãƒ¼ã®å­µåŒ–ä½œæ¥­ãŒã‚ã‚‹ã®ã§ã€ã“ã“ã¾ã§ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Microsoft Ignite 2019 ãŒä»Šå¹´ã‚‚é–‹å‚¬ã•ã‚Œã¦ã¾ã—ãŸã­ã€‚&lt;/p&gt;
&lt;p&gt;ä»Šå¹´ã‚‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ¼ã«é–¢ã—ã¦ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒã‚ã£ãŸã‘ã©ã€ãƒã‚±ãƒ¢ãƒ³å‰£ç›¾ã§æ™‚é–“ã¨ã‚‰ã‚Œã¦ã€ä½™è£•ãªã„ã®ã§é›‘ã«ãƒ¡ãƒ¢ã€‚&lt;/p&gt;
&lt;p&gt;å­µåŒ–ã‚ã¾ã‚Šã€ã ã‚Œã‹äº¤æ›ã—ã¾ã—ã‚‡ã†ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="é›‘è¨˜" scheme="http://blog.haniyama.com/tags/%E9%9B%91%E8%A8%98/"/>
    
      <category term="Azure AD" scheme="http://blog.haniyama.com/tags/Azure-AD/"/>
    
      <category term="Microsoft" scheme="http://blog.haniyama.com/tags/Microsoft/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD B2C ã« Yahoo! ID ã‚’é€£æºã—ã‚ˆã†ã¨ã—ã¦å¤±æ•—ã—ãŸè©±</title>
    <link href="http://blog.haniyama.com/2019/09/23/azuread-b2c-can-not-connect-yahooid/"/>
    <id>http://blog.haniyama.com/2019/09/23/azuread-b2c-can-not-connect-yahooid/</id>
    <published>2019-09-23T11:28:11.000Z</published>
    <updated>2022-05-18T13:45:28.994Z</updated>
    
    <content type="html"><![CDATA[<p>ä»Šæ—¥ã¯ Azure AD B2C ã‚’ OIDC ãª IdP ã§ã‚ã‚‹ Yahoo! ID ã¨ã¤ãªã’ã¦ã¿ã‚ˆã†ã€ã¨ã„ã†ãŠè©±ã€‚</p><h2 id="Azure-AD-B2C-ã¨ã¯"><a href="#Azure-AD-B2C-ã¨ã¯" class="headerlink" title="Azure AD B2C ã¨ã¯"></a>Azure AD B2C ã¨ã¯</h2><p>Microsoft ãŒæä¾›ã™ã‚‹ Auth0 ã¿ãŸã„ãªã‚µãƒ¼ãƒ“ã‚¹ã€‚</p><span id="more"></span><p>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸ã®èªè¨¼ã‚’ Google ã‚„ Facebook, Twitter ã¨ã„ã£ãŸã‚½ãƒ¼ã‚·ãƒ£ãƒ« ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§è¡Œã†ãŸã‚ã«ã€Azure AD B2C ã¨ã„ã†ãƒ†ãƒŠãƒ³ãƒˆã«ã€è¤‡æ•°ã® IdP ã‚’é€£æºã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚</p><p>å…·ä½“çš„ã«ã¯ B2C å´ãŒã€é€£æºã™ã‚‹ IdP ã‹ã‚‰ id_token ã‚„ã‚‰ userinfo ã‚’å¼•ã£å¼µã£ã¦ãã¦ã€è‰¯ã—ãªã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ãƒ»èªè¨¼ã—ã¦ãã‚Œã‚‹ã£ã¦æ„Ÿã˜ã€‚<br>æ§˜ã€…ãª IdP ã«å¯¾å¿œã—ã¦ã„ã¦ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã¯ã€Azure AD B2C ã‹ã‚‰ç™ºè¡Œã•ã‚Œã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã ã‘è¦‹ã¦ã‚Œã°ã„ã„ã®ã§è‰²ã€…æ¥½ã§ã™ã‚ˆã€ã¨ã„ã†ã‚„ã¤ã§ã™ã­ã€‚ã‚¿ãƒ–ãƒ³ãƒã€‚</p><h2 id="ã ã‚ã§ã—ãŸãƒ¼"><a href="#ã ã‚ã§ã—ãŸãƒ¼" class="headerlink" title="ã ã‚ã§ã—ãŸãƒ¼"></a>ã ã‚ã§ã—ãŸãƒ¼</h2><p>ã‚¿ã‚¤ãƒˆãƒ«ã«ã‚ã‚‹é€šã‚Šã€çµè«–ã‹ã‚‰è¨€ã†ã¨é€£æºã§ããªã‹ã£ãŸã€‚<br>å¤±æ•—ã—ãŸç†ç”±ã¨ã—ã¦ã¯ Yahoo! ID ãŒ response_mode&#x3D;query ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã‚Œãªã‹ã£ãŸ (â€» B2C ãŒ response_mode ã‚’çœç•¥ã—ã¦ãã‚Œãªã‹ã£ãŸ) ã‹ã‚‰ãªã®ã ã‘ã©ã€ã„ã‚ã„ã‚æ‰‹é †ã‚‚æ®‹ã—ã¦ãŠããŸã„ã®ã§ãƒ–ãƒ­ã‚°ã«ã¾ã¨ã‚ã‚ˆã†ã¨æ€ã†ã€‚</p><blockquote><p>è¿½è¨˜: ã‚«ã‚¹ã‚¿ãƒ  ãƒãƒªã‚·ãƒ¼ã§ OAuth ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã§ä½œæˆã™ã‚Œã°ã„ã‘ãŸã€‚</p></blockquote><h2 id="å¤±æ•—æ‰‹é †"><a href="#å¤±æ•—æ‰‹é †" class="headerlink" title="å¤±æ•—æ‰‹é †"></a>å¤±æ•—æ‰‹é †</h2><p>ç´°ã‹ã„æ‰‹é †ã¯çœç•¥ã—ã¦ã„ã‚‹ã®ã§ã€å„è‡ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç­‰ã‚ˆã‚“ã§èª¿ã¹ã¦ãã ã•ã„ã€‚</p><h3 id="B2C-ãƒ†ãƒŠãƒ³ãƒˆã‚’ä½œã‚‹"><a href="#B2C-ãƒ†ãƒŠãƒ³ãƒˆã‚’ä½œã‚‹" class="headerlink" title="B2C ãƒ†ãƒŠãƒ³ãƒˆã‚’ä½œã‚‹"></a>B2C ãƒ†ãƒŠãƒ³ãƒˆã‚’ä½œã‚‹</h3><p>ç•¥ã€‚</p><h3 id="Yahoo-ID-ã‚’åˆ©ç”¨ã™ã‚‹ã‚¢ãƒ—ãƒªã®ç™»éŒ²"><a href="#Yahoo-ID-ã‚’åˆ©ç”¨ã™ã‚‹ã‚¢ãƒ—ãƒªã®ç™»éŒ²" class="headerlink" title="Yahoo! ID ã‚’åˆ©ç”¨ã™ã‚‹ã‚¢ãƒ—ãƒªã®ç™»éŒ²"></a>Yahoo! ID ã‚’åˆ©ç”¨ã™ã‚‹ã‚¢ãƒ—ãƒªã®ç™»éŒ²</h3><p><a href="https://developer.yahoo.co.jp/start/">ã”åˆ©ç”¨ã‚¬ã‚¤ãƒ‰ - Yahoo!ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯</a> ã«ã€step by step ã§æ‰‹é †ãŒã‚ã‚‹ã®ã§ã€ãã®é€šã‚Šã«ã‚¢ãƒ—ãƒªã‚’ç™»éŒ²ã™ã‚‹ã€‚</p><p>Authorize Code Flow ã‚’å‹•ã‹ã™ã®ã§ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ â€œã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ï¼ˆYahoo! IDé€£æº v2ï¼‰â€ ã‚’é¸ã‚“ã§ã€ã‚ã¨ã¯é©å½“ã«å…¥åŠ›ã™ã‚‹ã€‚</p><p><img src="/2019/09/23/azuread-b2c-can-not-connect-yahooid/callback.png"></p><p>ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ URL ã«ã¯ã€å¾Œè¿°ã™ã‚‹ãŒä»¥ä¸‹ã® 2 ã¤ã‚’è¿½åŠ ã—ã¦ãŠãã€‚</p><ul><li><a href="https://yourdomain.b2clogin.com/yourdomain.onmicrosoft.com/oauth2/authresp">https://yourdomain.b2clogin.com/yourdomain.onmicrosoft.com/oauth2/authresp</a></li><li><a href="https://yourdomain.b2clogin.com/yourdomain.onmicrosoft.com/b2c_1a_trustframeworkbaseyahoo/oauth2/authresp">https://yourdomain.b2clogin.com/yourdomain.onmicrosoft.com/b2c_1a_trustframeworkbaseyahoo/oauth2/authresp</a></li></ul><p>ã‚ã¨ã¯ã€æ¤œè¨¼ç”¨ã« jwt.io ã¨ã‹ jwt.ms ã¨ã‹ localhost ã¨ã‹å¿…è¦ã§ã‚ã‚Œã°è¿½åŠ ã—ã¦ãŠãã€‚</p><h3 id="ã‚«ã‚¹ã‚¿ãƒ -OIDC-ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¨ã—ã¦-Yahoo-ID-ã‚’è¿½åŠ ã™ã‚‹"><a href="#ã‚«ã‚¹ã‚¿ãƒ -OIDC-ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¨ã—ã¦-Yahoo-ID-ã‚’è¿½åŠ ã™ã‚‹" class="headerlink" title="ã‚«ã‚¹ã‚¿ãƒ  OIDC ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¨ã—ã¦ Yahoo! ID ã‚’è¿½åŠ ã™ã‚‹"></a>ã‚«ã‚¹ã‚¿ãƒ  OIDC ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¨ã—ã¦ Yahoo! ID ã‚’è¿½åŠ ã™ã‚‹</h3><p>çµ„ã¿è¾¼ã¿ãƒãƒªã‚·ãƒ¼ã‚’åˆ©ç”¨ã—ã¦ B2C ã« OIDC ã® IdP ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ã€<code>Azure AD B2C</code> &gt; <code>ID ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼</code> &gt; <code>æ–°ã—ã„ OpenID Connect ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼</code> ã‚’é¸æŠã™ã‚‹ã€‚</p><p>OIDC ã®å ´åˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ URL ã‚’æŒ‡å®šã™ã‚Œã°ã»ã¼å®Œäº†ã€‚Yahoo! ID ã®å ´åˆã¯ä»¥ä¸‹ã® URLã¨ãªã‚‹ã€‚</p><ul><li><a href="https://auth.login.yahoo.co.jp/yconnect/v2/.well-known/openid-configuration">https://auth.login.yahoo.co.jp/yconnect/v2/.well-known/openid-configuration</a></li></ul><p>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ID ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¯ã€ã‚¢ãƒ—ãƒªã‚’ä½œã£ãŸã¨ãã«æ‰•ã„å‡ºã•ã‚ŒãŸã‚‚ã®ã‚’ã€‚ã‚¹ã‚³ãƒ¼ãƒ—ã¯<code>openid profile email</code>ã€<br>å¿œç­”ã®ç¨®é¡ã¯ <code>code</code>ã€å¿œç­”ãƒ¢ãƒ¼ãƒ‰ã¯ <code>query</code>ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ’ãƒ³ãƒˆã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒ B2C ã«å¯¾ã—ã¦èªè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆæŠ•ã’ã‚‹ã¨ãã«åˆ©ç”¨ã™ã‚‹ã‚‚ã®ã ã¨æ€ã†ã®ã§é©å½“ã§ OKã€‚</p><p>ã‚ã¨ã¯ã‚¯ãƒ¬ãƒ¼ãƒ ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ <a href="https://developer.yahoo.co.jp/yconnect/v2/userinfo.html">Yahoo! ID ã® UserInfo API ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</a> ã‚’ã¿ã¦é©å½“ã«æ±ºã‚ã‚‹ã€‚</p><p><img src="/2019/09/23/azuread-b2c-can-not-connect-yahooid/custom-oidc-provider.png"></p><p>æ‰‹é †ã¯ã“ã‚Œã ã‘ã§ OKã€‚</p><h3 id="ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼ã®ä½œæˆ"><a href="#ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼ã®ä½œæˆ" class="headerlink" title="ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼ã®ä½œæˆ"></a>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼ã®ä½œæˆ</h3><p><code>ãƒ¦ãƒ¼ã‚¶ãƒ¼ ãƒ•ãƒ­ãƒ¼</code> &gt; <code>æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ ãƒ•ãƒ­ãƒ¼</code> &gt; <code>ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã¨ã‚µã‚¤ãƒ³ã‚¤ãƒ³</code> ã‹ã‚‰ã€æ–°ã—ã„ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã¨ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼ã‚’ä½œæˆã—ã€IdP ã¨ã—ã¦å…ˆã»ã©ç™»éŒ²ã—ãŸ OIDC ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ (Yahoo!) ã‚’é¸ã¶ã€‚ã‚¯ãƒ¬ãƒ¼ãƒ ã®è¦æ±‚ã¯é©å½“ã«è¨­å®šã—ã¦ä¿å­˜ã™ã‚‹ã€‚</p><h3 id="ã‚¢ãƒ—ãƒªã®ç™»éŒ²"><a href="#ã‚¢ãƒ—ãƒªã®ç™»éŒ²" class="headerlink" title="ã‚¢ãƒ—ãƒªã®ç™»éŒ²"></a>ã‚¢ãƒ—ãƒªã®ç™»éŒ²</h3><p>Azure AD B2C ã‚’ IdP ã¨ã—ã¦åˆ©ç”¨ã™ã‚‹ã‚¢ãƒ—ãƒªã®ç™»éŒ²ã€‚ç•¥ã€‚</p><h3 id="ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼-ãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆ"><a href="#ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼-ãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆ" class="headerlink" title="ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ ãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆ"></a>ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ ãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆ</h3><p>ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ ãƒ•ãƒ­ãƒ¼ã‚’é¸æŠã—ã€<code>ä»Šã™ãå®Ÿè¡Œ</code> ã‚’é¸æŠã™ã‚‹ã€‚</p><p><img src="/2019/09/23/azuread-b2c-can-not-connect-yahooid/run-flow.png"></p><h3 id="çµæœ"><a href="#çµæœ" class="headerlink" title="çµæœ"></a>çµæœ</h3><p>â€˜Error: invalid_request,Error Description: response_mode is invalid.â€™</p><p><img src="/2019/09/23/azuread-b2c-can-not-connect-yahooid/result.png"></p><p>åˆã‚ã«æ›¸ã„ãŸé€šã‚Šã€çµè«–ã‹ã‚‰è¨€ã†ã¨å‹•ã‹ãªã‹ã£ãŸã€‚ãªãœã†ã¾ãå‹•ã‹ãªã„ã®ã‹ã€ã‚‚ã†å°‘ã—è©³ç´°ã«ã¿ã¦ã¿ã‚‹ã€‚</p><p>Chrome ã® <a href="https://chrome.google.com/webstore/detail/redirect-path/aomidfkchockcldhbkggjokdkkebmdll">Redirect Path</a> ã¨ã„ã†æ‹¡å¼µã‚’åˆ©ç”¨ã—ã¦ã€ã‚µã‚¤ãƒ³ã‚¤ãƒ³æ™‚ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã®å‹•ãã‚’è¦‹ã¦ã¿ãŸã€‚</p><p>B2C ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³ ãƒšãƒ¼ã‚¸ã‹ã‚‰ Yahoo! ã¸ã¯ä»¥ä¸‹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ã‚‰ã‚Œã¦ã„ãŸã€‚</p><pre class="language-http" style="" tabindex="0"><code id="e052293e" class="language-http" data-prism-hydrate="{&quot;element&quot;:&quot;e052293e&quot;,&quot;language&quot;:&quot;http&quot;,&quot;code&quot;:&quot;\nhttps://auth.login.yahoo.co.jp/yconnect/v2/authorization?\n  client_id=xxxxxxxxxxxxxxxxxxxxxxxxxxxxx\u0026\n  redirect_uri=https%3a%2f%2fyourdomain.b2clogin.com%2fyourdomain.onmicrosoft.com%2foauth2%2fauthresp&amp;\n  response_type=code&amp;\n  scope=openid+profile+email&amp;\n  response_mode=query&amp;\n  nonce=CpKTVRSC%2fgtFG0FSaQEpIg%3d%3d&amp;\n  ui_locales=en-US&amp;\n  state=StateProperties%3deyJ....\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token header\&quot;\u003e<span class=\&quot;token header-name keyword\&quot;>https</span><span class=\&quot;token punctuation\&quot;>:</span><span class=\&quot;token header-value\&quot;>//auth.login.yahoo.co.jp/yconnect/v2/authorization?\n  client_id=xxxxxxxxxxxxxxxxxxxxxxxxxxxxx&amp;amp;\n  redirect_uri=https%3a%2f%2fyourdomain.b2clogin.com%2fyourdomain.onmicrosoft.com%2foauth2%2fauthresp&amp;amp;\n  response_type=code&amp;amp;\n  scope=openid+profile+email&amp;amp;\n  response_mode=query&amp;amp;\n  nonce=CpKTVRSC%2fgtFG0FSaQEpIg%3d%3d&amp;amp;\n  ui_locales=en-US&amp;amp;\n  state=StateProperties%3deyJ....</span></span>\n&quot;}"><span class="token header"><span class="token header-name keyword">https</span><span class="token punctuation">:</span><span class="token header-value">//auth.login.yahoo.co.jp/yconnect/v2/authorization?  client_id=xxxxxxxxxxxxxxxxxxxxxxxxxxxxx&amp;  redirect_uri=https%3a%2f%2fyourdomain.b2clogin.com%2fyourdomain.onmicrosoft.com%2foauth2%2fauthresp&amp;  response_type=code&amp;  scope=openid+profile+email&amp;  response_mode=query&amp;  nonce=CpKTVRSC%2fgtFG0FSaQEpIg%3d%3d&amp;  ui_locales=en-US&amp;  state=StateProperties%3deyJ....</span></span></code></pre><p>ã§ã€Yahoo! ID ã¯ã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã—ã€ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¦ã„ãŸã€‚</p><pre class="language-http" style="" tabindex="0"><code id="f843073f" class="language-http" data-prism-hydrate="{&quot;element&quot;:&quot;f843073f&quot;,&quot;language&quot;:&quot;http&quot;,&quot;code&quot;:&quot;\nhttps://yourdomain.b2clogin.com/yourdomain.onmicrosoft.com/oauth2/authresp?\n  error=invalid_request\u0026\n  error_description=response_mode+is+invalid.&amp;\n  error_code=1227&amp;\n  state=StateProperties%3DeyJ...\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token header\&quot;\u003e<span class=\&quot;token header-name keyword\&quot;>https</span><span class=\&quot;token punctuation\&quot;>:</span><span class=\&quot;token header-value\&quot;>//yourdomain.b2clogin.com/yourdomain.onmicrosoft.com/oauth2/authresp?\n  error=invalid_request&amp;amp;\n  error_description=response_mode+is+invalid.&amp;amp;\n  error_code=1227&amp;amp;\n  state=StateProperties%3DeyJ...</span></span>\n&quot;}"><span class="token header"><span class="token header-name keyword">https</span><span class="token punctuation">:</span><span class="token header-value">//yourdomain.b2clogin.com/yourdomain.onmicrosoft.com/oauth2/authresp?  error=invalid_request&amp;  error_description=response_mode+is+invalid.&amp;  error_code=1227&amp;  state=StateProperties%3DeyJ...</span></span></code></pre><p>B2C ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ã€ã‚¨ãƒ©ãƒ¼ã‚’å—ã‘å–ã£ãŸã‚‰ãã®ã¾ã¾ã‚¢ãƒ—ãƒªã«è¿”ã™ã‚‰ã—ãã€ç™»éŒ²ã—ã¦ã„ãŸ jwt.ms ã«ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¦ã„ãŸã€‚</p><pre class="language-http" style="" tabindex="0"><code id="bf989f3d" class="language-http" data-prism-hydrate="{&quot;element&quot;:&quot;bf989f3d&quot;,&quot;language&quot;:&quot;http&quot;,&quot;code&quot;:&quot;\nhttps://jwt.ms/#\n  error=server_error\u0026\n  error_description=AADB2C90273%3a+An+invalid+response+was+received+%3a+%27Error%3a+invalid_request%2cError+Description%3a+response_mode+is+invalid.%27%0d%0aCorrelation+ID%3a+b300b4fb-c1ab-491d-86f1-4d1dc129892f%0d%0aTimestamp%3a+2019-09-23+09%3a39%3a54Z%0d%0a\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token header\&quot;\u003e<span class=\&quot;token header-name keyword\&quot;>https</span><span class=\&quot;token punctuation\&quot;>:</span><span class=\&quot;token header-value\&quot;>//jwt.ms/#\n  error=server_error&amp;amp;\n  error_description=AADB2C90273%3a+An+invalid+response+was+received+%3a+%27Error%3a+invalid_request%2cError+Description%3a+response_mode+is+invalid.%27%0d%0aCorrelation+ID%3a+b300b4fb-c1ab-491d-86f1-4d1dc129892f%0d%0aTimestamp%3a+2019-09-23+09%3a39%3a54Z%0d%0a</span></span>\n&quot;}"><span class="token header"><span class="token header-name keyword">https</span><span class="token punctuation">:</span><span class="token header-value">//jwt.ms/#  error=server_error&amp;  error_description=AADB2C90273%3a+An+invalid+response+was+received+%3a+%27Error%3a+invalid_request%2cError+Description%3a+response_mode+is+invalid.%27%0d%0aCorrelation+ID%3a+b300b4fb-c1ab-491d-86f1-4d1dc129892f%0d%0aTimestamp%3a+2019-09-23+09%3a39%3a54Z%0d%0a</span></span></code></pre><p>ã¨ã„ã†ã“ã¨ã§ã€B2C ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã«æŠ•ã’ã‚‹ response_mode ã‚’æŒ‡å®šã—ã¦ã„ã‚‹éƒ¨åˆ†ãŒæ‚ªãã†ã ã¨ã„ã†ã®ãŒåˆ†ã‹ã‚‹ã€‚å®Ÿéš›ã€Yahoo! ID ã«æŠ•ã’ã‚‹ Authorize Request ã‹ã‚‰ response_mode ã‚’æ¶ˆã—ã¦ã‚„ã‚‹ã¨ã†ã¾ãå‹•ãã€‚</p><p>respones_mode è‡ªä½“ã¯ OAuth ã®<a href="https://openid.net/specs/oauth-v2-multiple-response-types-1_0.html">OAuth 2.0 Multiple Response Type Encoding Practices</a> ã§ã€AuthZ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã©ã“ã«è¿”ã™ã‹ã‚’æŒ‡å®šã™ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚‰ã—ã„ã€‚<br>@TakahikoKawasaki ã•ã‚“ã® <a href="https://qiita.com/TakahikoKawasaki/items/185d34814eb9f7ac7ef3#13-%E5%BF%9C%E7%AD%94%E3%83%A2%E3%83%BC%E3%83%89-response_mode">OAuth &amp; OpenID Connect é–¢é€£ä»•æ§˜ã¾ã¨ã‚ - Qiita</a> ãŒéå¸¸ã«ã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã€‚</p><p>ã¨ã¯ã„ãˆã€å¿…é ˆã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã¯ãªã„ã®ã§ B2C ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦ã¯æ¶ˆã›ã¦ã‚‚ã„ã„æ°—ãŒã™ã‚‹ã‘ã©â€¦ã€‚</p><h3 id="ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼ã§è©¦ã™"><a href="#ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼ã§è©¦ã™" class="headerlink" title="ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼ã§è©¦ã™"></a>ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼ã§è©¦ã™</h3><p>Azure B2C ãŒ response_mode ã‚’çµ¶å¯¾å…¥ã‚Œã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã®ãŒãƒ€ãƒ¡ãªã®ã§ã€è‰²ã€…ã§ãã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼ã§è©¦ã—ã¦ã¿ã‚‹ã€‚</p><p>ã¾ãšã¯ã€Client Secret ã‚’ ãƒãƒªã‚·ãƒ¼ ã‚­ãƒ¼ ã« <code>B2C_1A_YahooAppSecret</code> ã¨ã—ã¦ç™»éŒ²ã™ã‚‹ã€‚<br>ãã®å¾Œ<a href="https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack">B2C Custom Policy Starterpack</a> ã® SocialandLocalAccounts ã® TrustFrameworkBase.xml ã® Facebook éƒ¨åˆ†ã‚’ä»¥ä¸‹ã«å…¥ã‚Œæ›¿ãˆã‚‹ã€‚</p><pre class="language-xml" style="" tabindex="0"><code id="d6a5423f" class="language-xml" data-prism-hydrate="{&quot;element&quot;:&quot;d6a5423f&quot;,&quot;language&quot;:&quot;xml&quot;,&quot;code&quot;:&quot;\n      \u003cClaimsProvider\u003e\n      <!-- The following Domain element allows this profile to be used if the request comes with domain_hint \n           query string parameter, e.g. domain_hint=facebook.com  -->\n      <Domain>yahoo.co.jp</Domain>\n      <DisplayName>Yahoo! Japan</DisplayName>\n      <TechnicalProfiles>\n        <TechnicalProfile Id=\&quot;Yahoo-OIDCv2\&quot;>\n          <!-- The text in the following DisplayName element is shown to the user on the claims provider \n               selection screen. -->\n          <DisplayName>Yahoo!</DisplayName>\n          <Protocol Name=\&quot;OpenIdConnect\&quot; />\n          <Metadata>\n            <Item Key=\&quot;ProviderName\&quot;>yahoo</Item>\n            <Item Key=\&quot;METADATA\&quot;>https://auth.login.yahoo.co.jp/yconnect/v2/.well-known/openid-configuration</Item>\n            <Item Key=\&quot;response_types\&quot;>code</Item>\n            <Item Key=\&quot;scope\&quot;>openid profile email</Item>\n            <!-- æ¶ˆã™ <Item Key=\&quot;response_mode\&quot;>query</Item> -->\n            <Item Key=\&quot;HttpBinding\&quot;>GET</Item>\n            <Item Key=\&quot;client_id\&quot;>xxxxxxxxx</Item>\n          </Metadata>\n          <CryptographicKeys>\n            <Key Id=\&quot;client_secret\&quot; StorageReferenceId=\&quot;B2C_1A_YahooAppSecret\&quot; />\n          </CryptographicKeys>\n          <InputClaims />\n          <OutputClaims>\n            <OutputClaim ClaimTypeReferenceId=\&quot;identityProvider\&quot; DefaultValue=\&quot;yahoo.co.jp\&quot; />\n            <OutputClaim ClaimTypeReferenceId=\&quot;authenticationSource\&quot; DefaultValue=\&quot;socialIdpAuthentication\&quot; />\n            <OutputClaim ClaimTypeReferenceId=\&quot;issuerUserId\&quot; PartnerClaimType=\&quot;sub\&quot; />\n            <OutputClaim ClaimTypeReferenceId=\&quot;displayName\&quot; PartnerClaimType=\&quot;name\&quot; />\n            <OutputClaim ClaimTypeReferenceId=\&quot;email\&quot; />\n          </OutputClaims>\n          <OutputClaimsTransformations>\n            <OutputClaimsTransformation ReferenceId=\&quot;CreateRandomUPNUserName\&quot; />\n            <OutputClaimsTransformation ReferenceId=\&quot;CreateUserPrincipalName\&quot; />\n            <OutputClaimsTransformation ReferenceId=\&quot;CreateAlternativeSecurityId\&quot; />\n            <OutputClaimsTransformation ReferenceId=\&quot;CreateSubjectClaimFromAlternativeSecurityId\&quot; />\n          </OutputClaimsTransformations>\n          <UseTechnicalProfileForSessionManagement ReferenceId=\&quot;SM-SocialLogin\&quot; />\n        </TechnicalProfile>\n      </TechnicalProfiles>\n    </ClaimsProvider>\n&quot;,&quot;highlightedCode&quot;:&quot;\n      <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>\u0026lt;</span>ClaimsProvider</span><span class=\&quot;token punctuation\&quot;>></span></span>\n      <span class=\&quot;token comment\&quot;>&amp;lt;!-- The following Domain element allows this profile to be used if the request comes with domain_hint \n           query string parameter, e.g. domain_hint=facebook.com  --></span>\n      <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>Domain</span><span class=\&quot;token punctuation\&quot;>></span></span>yahoo.co.jp<span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>Domain</span><span class=\&quot;token punctuation\&quot;>></span></span>\n      <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>DisplayName</span><span class=\&quot;token punctuation\&quot;>></span></span>Yahoo! Japan<span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>DisplayName</span><span class=\&quot;token punctuation\&quot;>></span></span>\n      <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>TechnicalProfiles</span><span class=\&quot;token punctuation\&quot;>></span></span>\n        <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>TechnicalProfile</span> <span class=\&quot;token attr-name\&quot;>Id</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>Yahoo-OIDCv2<span class=\&quot;token punctuation\&quot;>\&quot;</span></span><span class=\&quot;token punctuation\&quot;>></span></span>\n          <span class=\&quot;token comment\&quot;>&amp;lt;!-- The text in the following DisplayName element is shown to the user on the claims provider \n               selection screen. --></span>\n          <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>DisplayName</span><span class=\&quot;token punctuation\&quot;>></span></span>Yahoo!<span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>DisplayName</span><span class=\&quot;token punctuation\&quot;>></span></span>\n          <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>Protocol</span> <span class=\&quot;token attr-name\&quot;>Name</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>OpenIdConnect<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n          <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>Metadata</span><span class=\&quot;token punctuation\&quot;>></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>Item</span> <span class=\&quot;token attr-name\&quot;>Key</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>ProviderName<span class=\&quot;token punctuation\&quot;>\&quot;</span></span><span class=\&quot;token punctuation\&quot;>></span></span>yahoo<span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>Item</span><span class=\&quot;token punctuation\&quot;>></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>Item</span> <span class=\&quot;token attr-name\&quot;>Key</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>METADATA<span class=\&quot;token punctuation\&quot;>\&quot;</span></span><span class=\&quot;token punctuation\&quot;>></span></span>https://auth.login.yahoo.co.jp/yconnect/v2/.well-known/openid-configuration<span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>Item</span><span class=\&quot;token punctuation\&quot;>></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>Item</span> <span class=\&quot;token attr-name\&quot;>Key</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>response_types<span class=\&quot;token punctuation\&quot;>\&quot;</span></span><span class=\&quot;token punctuation\&quot;>></span></span>code<span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>Item</span><span class=\&quot;token punctuation\&quot;>></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>Item</span> <span class=\&quot;token attr-name\&quot;>Key</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>scope<span class=\&quot;token punctuation\&quot;>\&quot;</span></span><span class=\&quot;token punctuation\&quot;>></span></span>openid profile email<span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>Item</span><span class=\&quot;token punctuation\&quot;>></span></span>\n            <span class=\&quot;token comment\&quot;>&amp;lt;!-- æ¶ˆã™ &amp;lt;Item Key=\&quot;response_mode\&quot;>query&amp;lt;/Item> --></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>Item</span> <span class=\&quot;token attr-name\&quot;>Key</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>HttpBinding<span class=\&quot;token punctuation\&quot;>\&quot;</span></span><span class=\&quot;token punctuation\&quot;>></span></span>GET<span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>Item</span><span class=\&quot;token punctuation\&quot;>></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>Item</span> <span class=\&quot;token attr-name\&quot;>Key</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>client_id<span class=\&quot;token punctuation\&quot;>\&quot;</span></span><span class=\&quot;token punctuation\&quot;>></span></span>xxxxxxxxx<span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>Item</span><span class=\&quot;token punctuation\&quot;>></span></span>\n          <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>Metadata</span><span class=\&quot;token punctuation\&quot;>></span></span>\n          <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>CryptographicKeys</span><span class=\&quot;token punctuation\&quot;>></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>Key</span> <span class=\&quot;token attr-name\&quot;>Id</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>client_secret<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token attr-name\&quot;>StorageReferenceId</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>B2C_1A_YahooAppSecret<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n          <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>CryptographicKeys</span><span class=\&quot;token punctuation\&quot;>></span></span>\n          <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>InputClaims</span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n          <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>OutputClaims</span><span class=\&quot;token punctuation\&quot;>></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>OutputClaim</span> <span class=\&quot;token attr-name\&quot;>ClaimTypeReferenceId</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>identityProvider<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token attr-name\&quot;>DefaultValue</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>yahoo.co.jp<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>OutputClaim</span> <span class=\&quot;token attr-name\&quot;>ClaimTypeReferenceId</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>authenticationSource<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token attr-name\&quot;>DefaultValue</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>socialIdpAuthentication<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>OutputClaim</span> <span class=\&quot;token attr-name\&quot;>ClaimTypeReferenceId</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>issuerUserId<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token attr-name\&quot;>PartnerClaimType</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>sub<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>OutputClaim</span> <span class=\&quot;token attr-name\&quot;>ClaimTypeReferenceId</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>displayName<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token attr-name\&quot;>PartnerClaimType</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>name<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>OutputClaim</span> <span class=\&quot;token attr-name\&quot;>ClaimTypeReferenceId</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>email<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n          <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>OutputClaims</span><span class=\&quot;token punctuation\&quot;>></span></span>\n          <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>OutputClaimsTransformations</span><span class=\&quot;token punctuation\&quot;>></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>OutputClaimsTransformation</span> <span class=\&quot;token attr-name\&quot;>ReferenceId</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>CreateRandomUPNUserName<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>OutputClaimsTransformation</span> <span class=\&quot;token attr-name\&quot;>ReferenceId</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>CreateUserPrincipalName<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>OutputClaimsTransformation</span> <span class=\&quot;token attr-name\&quot;>ReferenceId</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>CreateAlternativeSecurityId<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>OutputClaimsTransformation</span> <span class=\&quot;token attr-name\&quot;>ReferenceId</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>CreateSubjectClaimFromAlternativeSecurityId<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n          <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>OutputClaimsTransformations</span><span class=\&quot;token punctuation\&quot;>></span></span>\n          <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>UseTechnicalProfileForSessionManagement</span> <span class=\&quot;token attr-name\&quot;>ReferenceId</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>SM-SocialLogin<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n        <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>TechnicalProfile</span><span class=\&quot;token punctuation\&quot;>></span></span>\n      <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>TechnicalProfiles</span><span class=\&quot;token punctuation\&quot;>></span></span>\n    <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>ClaimsProvider</span><span class=\&quot;token punctuation\&quot;>></span></span>\n&quot;}">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsProvider</span><span class="token punctuation">&gt;</span></span>      <span class="token comment">&lt;!-- The following Domain element allows this profile to be used if the request comes with domain_hint            query string parameter, e.g. domain_hint=facebook.com  --&gt;</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Domain</span><span class="token punctuation">&gt;</span></span>yahoo.co.jp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Domain</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DisplayName</span><span class="token punctuation">&gt;</span></span>Yahoo! Japan<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DisplayName</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TechnicalProfiles</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TechnicalProfile</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Yahoo-OIDCv2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>          <span class="token comment">&lt;!-- The text in the following DisplayName element is shown to the user on the claims provider                selection screen. --&gt;</span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DisplayName</span><span class="token punctuation">&gt;</span></span>Yahoo!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DisplayName</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Protocol</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>OpenIdConnect<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Metadata</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ProviderName<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>yahoo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>METADATA<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>https://auth.login.yahoo.co.jp/yconnect/v2/.well-known/openid-configuration<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>response_types<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>code<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>scope<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>openid profile email<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">&gt;</span></span>            <span class="token comment">&lt;!-- æ¶ˆã™ &lt;Item Key="response_mode"&gt;query&lt;/Item&gt; --&gt;</span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>HttpBinding<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>GET<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>client_id<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>xxxxxxxxx<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Metadata</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CryptographicKeys</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Key</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>client_secret<span class="token punctuation">"</span></span> <span class="token attr-name">StorageReferenceId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>B2C_1A_YahooAppSecret<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CryptographicKeys</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaims</span> <span class="token punctuation">/&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaims</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>identityProvider<span class="token punctuation">"</span></span> <span class="token attr-name">DefaultValue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yahoo.co.jp<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>authenticationSource<span class="token punctuation">"</span></span> <span class="token attr-name">DefaultValue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>socialIdpAuthentication<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>issuerUserId<span class="token punctuation">"</span></span> <span class="token attr-name">PartnerClaimType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sub<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>displayName<span class="token punctuation">"</span></span> <span class="token attr-name">PartnerClaimType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OutputClaims</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaimsTransformations</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaimsTransformation</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CreateRandomUPNUserName<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaimsTransformation</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CreateUserPrincipalName<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaimsTransformation</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CreateAlternativeSecurityId<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaimsTransformation</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CreateSubjectClaimFromAlternativeSecurityId<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OutputClaimsTransformations</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UseTechnicalProfileForSessionManagement</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SM-SocialLogin<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TechnicalProfile</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TechnicalProfiles</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ClaimsProvider</span><span class="token punctuation">&gt;</span></span></code></pre><p>ã‚ã¨ã€PolicyId ã¯ <code>B2C_1A_TrustFrameworkBaseYahoo</code> ã«å¤‰ãˆã¦ãŠã (å‚ç…§ã—ã¦ã‚‹ xml ã‚‚ç›´ã—ã¦ãŠã)ã€‚<br>ã§ããŸã‚‰ <code>TrustFrameworkBase.xml</code>, <code>TrustFrameworkExtensions.xml</code>, <code>SignUpOrSignIn.xml</code> ã® 3 ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ <code>Identity Experience Framework</code> ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã€‚</p><p>ClaimsProvider ã‚’è¨˜è¿°ã—ãŸ PolicyId ãŒã€callback URL ã«ãªã‚‹ã‚‰ã—ãã€PolicyId ãŒ <code>trustframeworkbaseyahoo</code> ã ã£ãŸã‚‰ã€ä»¥ä¸‹ã® URL ã¨ãªã‚‹ã€‚</p><ul><li><a href="https://yourdomain.b2clogin.com/yourdomain.onmicrosoft.com/b2c_1a_trustframeworkbaseyahoo/oauth2/authresp">https://yourdomain.b2clogin.com/yourdomain.onmicrosoft.com/b2c_1a_trustframeworkbaseyahoo/oauth2/authresp</a></li></ul><blockquote><p>â€»ãªã‚“ã‹ <a href="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/openid-connect-technical-profile">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</a> ã«ã¯ <a href="https://yourtenant.b2clogin.com/your-tenant.onmicrosoft.com/oauth2/authresp">https://yourtenant.b2clogin.com/your-tenant.onmicrosoft.com/oauth2/authresp</a> ä½¿ã†ã£ã¦ã‹ã„ã¦ã‚ã£ã¦å®Ÿéš›ã®å‹•ä½œã¨é•ã†â€¦ã€‚ãªã‚“ã ã“ã‚Œï¼Ÿ</p></blockquote><p>ã§ã€response_mode ã‚’æ¶ˆã—ãŸã‚Šã€ç©ºã§è¨­å®šã—ã¦ã¿ãŸã‚Šâ€¦</p><pre class="language-xml" style="" tabindex="0"><code id="41fccf3e" class="language-xml" data-prism-hydrate="{&quot;element&quot;:&quot;41fccf3e&quot;,&quot;language&quot;:&quot;xml&quot;,&quot;code&quot;:&quot;\n\u003cItem Key=\&quot;response_mode\&quot;\u003e</Item>\n&quot;,&quot;highlightedCode&quot;:&quot;\n<span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>\u0026lt;</span>Item</span> <span class=\&quot;token attr-name\&quot;>Key</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>response_mode<span class=\&quot;token punctuation\&quot;>\&quot;</span></span><span class=\&quot;token punctuation\&quot;>></span></span><span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>Item</span><span class=\&quot;token punctuation\&quot;>></span></span>\n&quot;}"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>response_mode<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">&gt;</span></span></code></pre><p>ã—ã‹ã— B2C ã‹ã‚‰ã® AuthZ ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ response_mode ãŒæ¶ˆãˆã‚‹ã“ã¨ã¯ãªã‹ã£ãŸâ€¦ã€‚ã‹ãªã—ã„ã€‚<br>ãªãŠã€response_mode ã‚’æ¶ˆã—ãŸã‚Šã€å€¤ã‚’ç©ºã«ã™ã‚‹ã¨ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® <code>form_post</code> ã«ãªã‚‹ã€‚</p><blockquote class="twitter-tweet"><p lang="ja" dir="ltr">MSã•ã‚“JSè‹¦æ‰‹ &amp; SAMLè„³ã‚‰ã—ãã¦ã€id_tokenç›´ã§è¿”ã—ã¦æ¬²ã—ã„ãã›ã«fragmentã¯ä½¿ã„ãŸããªã„ã¨ã‹è¨€ã„ãŠã£ã¦ãªã€å‡ºã—ã¦ããŠã£ãŸã‚“ã‚„ã€form_postã‚’ã€‚ãã‚“ãªçµŒç·¯ã§å‡ºæ¥ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚„ã‹ã‚‰ã€MSã•ã‚“ã«ã¯å¿…é ˆã‹ã‚‚ã—ã‚Œã‚“ã€‚</p>&mdash; nov matake (@nov) <a href="https://twitter.com/nov/status/1176051340339843072?ref_src=twsrc%5Etfw">September 23, 2019</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>ãªã‚‹ã»ã©ï¼Ÿ</p><p>ã¨ã„ã†ã“ã¨ã§ã€ç¾åœ¨ã®ã¨ã“ã‚ Yahoo! ID ã‚’ Azure B2C ã¨é€£æºã™ã‚‹ã“ã¨ã¯ <del>ã§ããªã„ã‚ˆã†ã§ã™ã€‚ã¾ã‚‹ã€‚</del> </p><blockquote class="twitter-tweet"><p lang="ja" dir="ltr">Azure AD B2Cã®Protocolè¨­å®šã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å—ä»˜ãŒè‹¥å¹²ã‚¯ã‚»ãŒå¼·ã„ã‹ã‚‰OAuth2æŒ‡å®šã§ã‚‚scopeã«openidã‚’æŒ‡å®šã™ã‚Œã°OpenID Connectã¨ã—ã¦å‹•ã„ã¦ãã‚Œã‚‹&amp;response_modeå•é¡Œã‚‚è§£æ±ºã™ã‚‹</p>&mdash; Naohiro Fujie (@phr_eidentity) <a href="https://twitter.com/phr_eidentity/status/1176194980886396928?ref_src=twsrc%5Etfw">September 23, 2019</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>ã¨ã„ã†ã“ã¨ã§ã€ã‚«ã‚¹ã‚¿ãƒ  ãƒãƒªã‚·ãƒ¼ãªã‚‰ã„ã‘ã¾ã—ãŸã€‚</p><script src="https://gist.github.com/watahani/6ee0ffff0f4879b760ba5ab171df7430.js"></script><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://developer.yahoo.co.jp/yconnect/v2/">Yahoo! IDé€£æº:v2 - Yahoo!ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/active-directory-b2c-setup-msa-app">Microsoft ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã®ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãŠã‚ˆã³ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’è¨­å®šã™ã‚‹ - Azure Active Directory B2C | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/openid-connect-technical-profile">Azure Active Directory B2C å†…ã®ã‚«ã‚¹ã‚¿ãƒ  ãƒãƒªã‚·ãƒ¼ã§ OpenID Connect æŠ€è¡“ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®šç¾©ã™ã‚‹ | Microsoft Docs</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»Šæ—¥ã¯ Azure AD B2C ã‚’ OIDC ãª IdP ã§ã‚ã‚‹ Yahoo! ID ã¨ã¤ãªã’ã¦ã¿ã‚ˆã†ã€ã¨ã„ã†ãŠè©±ã€‚&lt;/p&gt;
&lt;h2 id=&quot;Azure-AD-B2C-ã¨ã¯&quot;&gt;&lt;a href=&quot;#Azure-AD-B2C-ã¨ã¯&quot; class=&quot;headerlink&quot; title=&quot;Azure AD B2C ã¨ã¯&quot;&gt;&lt;/a&gt;Azure AD B2C ã¨ã¯&lt;/h2&gt;&lt;p&gt;Microsoft ãŒæä¾›ã™ã‚‹ Auth0 ã¿ãŸã„ãªã‚µãƒ¼ãƒ“ã‚¹ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Azure" scheme="http://blog.haniyama.com/tags/Azure/"/>
    
      <category term="OIDC" scheme="http://blog.haniyama.com/tags/OIDC/"/>
    
  </entry>
  
  <entry>
    <title>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ¼ã‚’ãªãã—ãŸã®ã§ãƒªã‚«ãƒãƒªæ–¹æ³•ã‚’å®Ÿè·µã—ã¦ã¿ã‚‹</title>
    <link href="http://blog.haniyama.com/2019/09/09/lost-securiykeys/"/>
    <id>http://blog.haniyama.com/2019/09/09/lost-securiykeys/</id>
    <published>2019-09-09T11:40:44.000Z</published>
    <updated>2022-05-18T13:45:29.082Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>è¿½è¨˜: è¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚</p></blockquote><p><blockquote class="twitter-tweet"><p lang="ja" dir="ltr">å‡ºã¦ãã¾ã—ãŸï¼ <a href="https://t.co/U9DkvPkkNF">pic.twitter.com/U9DkvPkkNF</a></p>&mdash; 82@ã¯ã« (@watahani) <a href="https://twitter.com/watahani/status/1171410293634715648?ref_src=twsrc%5Etfw">September 10, 2019</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p><p>æ™®æ®µä½¿ã„ã®ãƒãƒƒã‚°ã‚’ãªãã—ãŸã€‚<del>ãŸã¶ã‚“ç½®ãå¼•ã</del> â€»1ã€‚</p><p>ä¸­ã«ã¯æ¤œè¨¼&amp;æ™®æ®µä½¿ã„ã«åˆ©ç”¨ã—ã¦ã„ãŸ YubiKey ã‚‚ã‚ã£ãŸã€‚ã¦ã‹å±±ã»ã© Authenticator å…¥ã£ã¦ãŸã€‚</p><p>ã¾ã•ã‹ã€ç½®ãå¼•ãé‡éƒã‚‚ã€ã‚«ãƒãƒ³é–‹ã‘ãŸã‚‰é‡‘ã¯ä¸€åˆ‡å…¥ã£ã¦ãªãã¦ã€æ„å‘³ã‚ã‹ã‚‰ã‚“ USB æ©Ÿå™¨ãŒå±±ã»ã©ã¯ã„ã£ã¦ã‚‹ã¨ã¯æ€ã†ã¾ã„ â€»1ã€‚</p><blockquote><p>â€»1 ãƒ©ãƒ³ãƒã«è¡Œã£ãŸç„¼è‚‰å±‹ã«ç½®ãå¿˜ã‚ŒãŸã“ã¨ã‚’å¿˜ã‚ŒãŸã ã‘ã€‚</p></blockquote><span id="more"></span><p><img src="https://blog.haniyama.com/2019/02/04/job-change/keys.jpg" alt=""></p><blockquote><p>ã“ã‚Œ</p></blockquote><h2 id="ã‚ã‚‰ã™ã˜"><a href="#ã‚ã‚‰ã™ã˜" class="headerlink" title="ã‚ã‚‰ã™ã˜"></a>ã‚ã‚‰ã™ã˜</h2><p>åœŸæ›œæ—¥ã®åˆå‰ä¸­ã«ç—…é™¢ã«è¡Œãã€è–¬å±€ã§è–¬ã‚’å‡ºã—ã¦ã‚‚ã‚‰ã£ã¦ã€å®¶ã«å¸°ã£ãŸ â€»2ã€‚</p><p>ãã®æ™‚ã©ã†ã‚„ã‚‰ãƒãƒƒã‚°ã‚’èª¿å‰¤è–¬å±€ã«å¿˜ã‚ŒãŸã‚‰ã—ã„ã€‚<br>å«ã«ã¯ã€å°å­¦æ ¡ã«ãƒ©ãƒ³ãƒ‰ã‚»ãƒ«ã—ã‚‡ã£ã¦å¿˜ã‚Œã¦ãã‚‹ã‚„ã¤ãŠã‚‹ã‹ï¼Ÿã¨ã‚ãã‚Œã‚‰ã‚ŒãŸãŒã€ã¾ã•ã«ãã‚Œã‚’ã‚„ã£ã¦ã®ã‘ãŸç§ã§ã‚ã‚‹ã€‚ä»•æ–¹ãŒãªã„ã€‚</p><p>ã•ã¦ã€ã‚„ã£ã¨æ¬¡ã®æ—¥ã«ãªã£ã¦ã€ã‚«ãƒãƒ³ãŒãªã„ã“ã¨ã«æ°—ã¥ãã€è–¬å±€ã«é›»è©±ã—ãŸãŒè¦‹ã¤ã‹ã‚‰ãšã€‚<br>ã“ã‚Œã‚’ç½®ãå¼•ãã¨å‘¼ã‚“ã§ã‚ˆã„ã‹ã¯ã‚ˆãã‚ã‹ã‚‰ãªã„ãŒã€ä¸­ã«å…¥ã£ã¦ãŸã‚‚ã‚ã‚‚ã‚ã‚’ãƒ­ã‚¹ãƒˆã—ã¦ã—ã¾ã£ãŸã€‚</p><p>ã§ã€å¤§é‡ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ¼ã‚‚ãªãã—ãŸã®ã§ã€å„ç¤¾ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ¼ã®ç„¡åŠ¹åŒ–æ‰‹æ®µã«ã¤ã„ã¦ç¢ºèªã—ã¦ãŠã“ã†ã¨ã„ã†ã®ãŒæœ¬æ—¥ã®ä¼ç”»ã€‚</p><blockquote><p>â€»2 ä½•åº¦ã‚‚è¨€ã†ãŒã€ãƒ©ãƒ³ãƒã«è¡Œã£ãŸç„¼è‚‰å±‹ã«ç½®ãå¿˜ã‚ŒãŸã“ã¨ã‚’å¿˜ã‚ŒãŸã ã‘ã€‚</p></blockquote><h2 id="Google"><a href="#Google" class="headerlink" title="Google"></a>Google</h2><p><a href="https://myaccount.google.com/">https://myaccount.google.com/</a> ã‹ã‚‰ã€<code>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</code> &gt; <code>äºŒæ®µéšèªè¨¼</code> ã«ç§»å‹•ã€‚</p><p>ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã¯ä¿¡é ¼ã•ã‚ŒãŸãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã‹ã‚‰ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã ã‘ã§ OK ã ã£ãŸã€‚<br>ã“ã®è¾ºã¯çµ„ç¹”ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã©ã†ã‹ã¨ã‹ã§å‹•ä½œãŒé•ã†ã¨æ€ã‚ã‚Œã‚‹ã€‚</p><p><img src="/2019/09/09/lost-securiykeys/google-securitykeys.png" alt=""></p><p>ä¿¡é ¼ã•ã‚ŒãŸãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã£ã¦çµæ§‹è‰²ã€…ã§ãã‚‹ã®ã§æ°—ã‚’ä»˜ã‘ãŸã»ã†ãŒã„ã„ãªã¨ã‚³ãƒŠãƒŸã€‚</p><p>ã¡ã‚ƒã‚“ã¨æœ€çµ‚ä½¿ç”¨æ—¥ãŒã‚ã‚‹ãŸã‚ã€ä¸æ­£ãƒ­ã‚°ã‚¤ãƒ³ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèªå¯èƒ½ã ã£ãŸã€‚ã¾ãŸã€ãŠãŠã‚ˆãã®æœ€çµ‚ä»•æ§˜å ´æ‰€ã‚‚ã‚ã‹ã‚‹ã€‚<br>ç·¨é›†ãƒœã‚¿ãƒ³ã‹ã‚‰ Revoke ã—ã¦å®Œäº†ã€‚</p><h2 id="Microsoft-Account"><a href="#Microsoft-Account" class="headerlink" title="Microsoft Account"></a>Microsoft Account</h2><p><a href="https://account.microsoft.com">https://account.microsoft.com</a> ã‹ã‚‰ã€<code>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</code> ã«ç§»å‹•ã€‚</p><p>è¿½åŠ ã®èªè¨¼ã¯ã‚¹ãƒãƒ›ã¸ã®é€šçŸ¥ã«ã¦ã€‚</p><p><img src="/2019/09/09/lost-securiykeys/msa-mfa.png" alt=""></p><p> <code>2 æ®µéšèªè¨¼ (è¿½åŠ ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</code> ã«ç§»å‹•ã—ã¦ <code>Windows Hello ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ¼</code> &gt; <code>ã‚µã‚¤ãƒ³ã‚¤ãƒ³æ–¹æ³•ã®ç®¡ç†</code> ã«ã¦ä¸€è¦§ã‚’ç¢ºèªå¯èƒ½ã€‚<br>MS ã£ã¦å€‹äººã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ MFA ã˜ã‚ƒãªãã¦2æ®µéšèªè¨¼ã‚„ã­ã‚“ãªã€‚</p><p><img src="/2019/09/09/lost-securiykeys/ms-securitykeys.png" alt=""></p><p>æœ€çµ‚åˆ©ç”¨æ—¥ãŒåˆ†ã‹ã‚‹ã€‚å‰Šé™¤ãƒœã‚¿ãƒ³æŠ¼ã—ã¦ revoke å®Œäº†ã€‚</p><h2 id="GitHub"><a href="#GitHub" class="headerlink" title="GitHub"></a>GitHub</h2><p><a href="https://github.com/settings/">https://github.com/settings/</a> ã‹ã‚‰ <code>Security</code> &gt; <code>Two-factor authentication</code> &gt; <code>Security keys</code> ã«ã‚¢ã‚¯ã‚»ã‚¹ã€‚</p><p><img src="/2019/09/09/lost-securiykeys/github-settings.png" alt=""></p><p>å®¶ã«ã‚ã‚‹ YubiKey ã‚’ç™»éŒ²ã—ã¦ã‚ã£ãŸã®ã§ã€ã‚µã‚¤ãƒ³ã‚¤ãƒ³ ã‚»ãƒƒã‚·ãƒ§ãƒ³ + è¿½åŠ ã®èªè¨¼ YubiKey ã‚¿ãƒƒãƒã§ã‚¢ã‚¯ã‚»ã‚¹ã§ããŸã€‚<br>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ¼ã¾ã£ãŸããªã„å ´åˆã¯ Authenticator ã‚¢ãƒ—ãƒªã‹ãƒªã‚«ãƒãƒªã‚³ãƒ¼ãƒ‰ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‹ãªã€‚</p><p>ã‚‚ã—ã‹ã™ã‚‹ã¨ä¿¡é ¼ã•ã‚ŒãŸç«¯æœ«ã‹ã‚‰ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã ã‘ã§å…¥ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã‘ã©æœªç¢ºèªã€‚</p><p><img src="/2019/09/09/lost-securiykeys/github-securitykeys.png" alt=""></p><p>ã‚´ãƒŸç®±ã‚¢ã‚¤ã‚³ãƒ³ã§å‰Šé™¤â€¦ã—ãŸå¾Œã®ç”»é¢ã§ã™ã€‚<br>ã¨ã„ã†ã®ã‚‚ã€ä»–ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«æ¯”ã¹ã¦ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ãŸéš›ã®é€šçŸ¥ãŒæ¥ãªã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã ã£ãŸã®ã§ã€ãªã‚“ã¨ãªãä¸€ç•ªä¸å®‰ã«æ„Ÿã˜ãŸã‹ã‚‰ã€GitHub ã®ã‚­ãƒ¼ã‚’çœŸã£å…ˆã«ã‚ã«ç„¡åŠ¹åŒ–ã—ãŸã‚“ã§ã™ã€‚</p><h2 id="Facebook"><a href="#Facebook" class="headerlink" title="Facebook"></a>Facebook</h2><p><a href="https://www.facebook.com/settings">https://www.facebook.com/settings</a> ã‹ã‚‰ã€<code>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ­ã‚°ã‚¤ãƒ³</code> &gt; <code>äºŒæ®µéšèªè¨¼ã‚’ä½¿ç”¨</code></p><p>è¿½åŠ ã®ç¢ºèªã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã ã£ãŸã€‚ã“ã‚Œã‚‚ä¿¡é ¼ã•ã‚ŒãŸãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã¨ã—ã¦ä¿å­˜ã—ã¦ã„ã‚‹ã‹ã‚‰ã‹ãªã€‚</p><p><img src="/2019/09/09/lost-securiykeys/facebook-confirm.png" alt=""></p><p><code>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ¼</code> ã‹ã‚‰ç™»éŒ²ã—ã¦ã„ã‚‹ã‚­ãƒ¼ã‚’å‰Šé™¤â€¦ã¨æ€ã£ãŸã‘ã©ã€ã„ã¤ç™»éŒ²ã—ãŸã‹ã‚ã‹ã‚‰ã‚“ã‚„ãƒ¼ã¤ã—ã‹ãªã‹ã£ãŸã®ã§å…¨éƒ¨å‰Šé™¤ã—ã¦æ‰‹å…ƒã®ã‚­ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãŠãã€‚</p><p><img src="/2019/09/09/lost-securiykeys/facebook-securitykeys.png" alt=""></p><h2 id="Twitter"><a href="#Twitter" class="headerlink" title="Twitter"></a>Twitter</h2><p><a href="https://twitter.com/settings/account">https://twitter.com/settings/account</a> ã«ã‚¢ã‚¯ã‚»ã‚¹ã€‚</p><p>ãƒ­ã‚°ã‚¤ãƒ³ã¯ Authenticator ã‚¢ãƒ—ãƒªã§ã€‚Chrome ã§ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åˆ‡ã‚Šæ›¿ãˆã¦ä½¿ã£ã¦ã‚‹ã¨ã€ãªãœã‹ Twitter ã®èªè¨¼ãŒåˆ‡ã‚Œã¦ã—ã¾ã†ã®ã§æœ€è¿‘ã¯ãšã£ã¨ Authenticator ã‚¢ãƒ—ãƒªä½¿ã£ã¦ãŸã€‚</p><p><code>Security</code> &gt; <code>Two-factor authentication</code> ã‹ã‚‰ Security Key ã®ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ã ã‘ã€‚</p><p><img src="/2019/09/09/lost-securiykeys/twitter-securitykey.png" alt=""></p><p>ã¤ã„ã§ã«æ‰‹å…ƒã®ã‚­ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãŠãã‘ã©ã€ç›¸å¤‰ã‚ã‚‰ãšä¸€æœ¬ã—ã‹ç™»éŒ²ã§ããªã„ã—åå‰ã‚‚ä»˜ã‘ã‚Œãªã„ã®ã§ãã£ã¨ã¾ãŸå¿˜ã‚Œã‚‹ã€‚</p><h2 id="ã¾ã¨ã‚"><a href="#ã¾ã¨ã‚" class="headerlink" title="ã¾ã¨ã‚"></a>ã¾ã¨ã‚</h2><p>ã¨ã€ã„ã†ã“ã¨ã§ã€é™ã‚‰ã‚ŒãŸã‚µãƒ³ãƒ—ãƒ«ã§ã¯ã‚ã‚‹ãŒã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ¼ã‚’ãªãã—ãŸå ´åˆã®ãƒªã‚«ãƒãƒªæ‰‹é †ã§ã—ãŸã€‚</p><p>Google ã¨ Facebook ã¯ä¿¡é ¼ã•ã‚ŒãŸç«¯æœ«ã‹ã‚‰ã®è¨­å®šã§ã‚ã‚Œã°ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ã¿ã§ãƒªã‚«ãƒãƒªå¯èƒ½ã ã‘ã©ã€Microsoft ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ã€Authenticator ã‚¢ãƒ—ãƒªã§ã®è¿½åŠ èªè¨¼ãŒå¿…è¦ã ã£ãŸã€‚Twitter ã¯æœ€è¿‘å¸¸ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ‡ã‚Œã¦ã‚‹ã®ã§ã‚ˆãã‚ã‹ã‚‰ãšã€‚</p><p>ã‚‚ã—ã‹ã™ã‚‹ã¨ Microsoft ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã¤ã„ã¦ã‚‚ä¿¡é ¼ã•ã‚ŒãŸç«¯æœ«ã«ã—ã¦ã‚Œã°å‹•ä½œé•ã†ã‹ã‚‚ãªã®ã§ã‚ãã¾ã§å‚è€ƒç¨‹åº¦ã«ã€‚</p><p>ã§ã€ã‚„ã£ã±æœ€çµ‚ä½¿ç”¨æ—¥æ™‚ã¨ã€ã‚µã‚¤ãƒ³ã‚¤ãƒ³æ™‚ã®é€šçŸ¥ãŒæ¥ã‚‹ã®ã¯æ©Ÿèƒ½ã¨ã—ã¦è‰¯ã„ã€‚</p><p>ä¸€ç•ªã®å•é¡Œã¯ã€ãªãã—ãŸã‚­ãƒ¼ã‚’è²·ã†ãŸã‚ã®äºˆç®—ãŒé€šã‚‹ã‹ã§ã‚ã‚‹ã€‚ã‚ã¨ã€å°¼ã§è²·ã†ã¨ã€å‰è·ã«ã“ã„ã¤ã‚­ãƒ¼ãªãã—ãŸãªã£ã¦ãƒãƒ¬ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ãŒã¤ã‚‰ã„ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;è¿½è¨˜: è¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;blockquote class=&quot;twitter-tweet&quot;&gt;&lt;p lang=&quot;ja&quot; dir=&quot;ltr&quot;&gt;å‡ºã¦ãã¾ã—ãŸï¼ &lt;a href=&quot;https://t.co/U9DkvPkkNF&quot;&gt;pic.twitter.com/U9DkvPkkNF&lt;/a&gt;&lt;/p&gt;&amp;mdash; 82@ã¯ã« (@watahani) &lt;a href=&quot;https://twitter.com/watahani/status/1171410293634715648?ref_src=twsrc%5Etfw&quot;&gt;September 10, 2019&lt;/a&gt;&lt;/blockquote&gt; &lt;script async src=&quot;https://platform.twitter.com/widgets.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;&lt;/p&gt;
&lt;p&gt;æ™®æ®µä½¿ã„ã®ãƒãƒƒã‚°ã‚’ãªãã—ãŸã€‚&lt;del&gt;ãŸã¶ã‚“ç½®ãå¼•ã&lt;/del&gt; â€»1ã€‚&lt;/p&gt;
&lt;p&gt;ä¸­ã«ã¯æ¤œè¨¼&amp;amp;æ™®æ®µä½¿ã„ã«åˆ©ç”¨ã—ã¦ã„ãŸ YubiKey ã‚‚ã‚ã£ãŸã€‚ã¦ã‹å±±ã»ã© Authenticator å…¥ã£ã¦ãŸã€‚&lt;/p&gt;
&lt;p&gt;ã¾ã•ã‹ã€ç½®ãå¼•ãé‡éƒã‚‚ã€ã‚«ãƒãƒ³é–‹ã‘ãŸã‚‰é‡‘ã¯ä¸€åˆ‡å…¥ã£ã¦ãªãã¦ã€æ„å‘³ã‚ã‹ã‚‰ã‚“ USB æ©Ÿå™¨ãŒå±±ã»ã©ã¯ã„ã£ã¦ã‚‹ã¨ã¯æ€ã†ã¾ã„ â€»1ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;â€»1 ãƒ©ãƒ³ãƒã«è¡Œã£ãŸç„¼è‚‰å±‹ã«ç½®ãå¿˜ã‚ŒãŸã“ã¨ã‚’å¿˜ã‚ŒãŸã ã‘ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="YubiKey" scheme="http://blog.haniyama.com/tags/YubiKey/"/>
    
      <category term="Account Recovery" scheme="http://blog.haniyama.com/tags/Account-Recovery/"/>
    
  </entry>
  
</feed>
