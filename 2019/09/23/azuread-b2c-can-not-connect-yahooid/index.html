<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description" content="今日は Azure AD B2C を OIDC な IdP である Yahoo! ID とつなげてみよう、というお話。 Azure AD B2C とはMicrosoft が提供する Auth0 みたいなサービス。">
<meta property="og:type" content="article">
<meta property="og:title" content="Azure AD B2C に Yahoo! ID を連携しようとして失敗した話">
<meta property="og:url" content="http://blog.haniyama.com/2019/09/23/azuread-b2c-can-not-connect-yahooid/index.html">
<meta property="og:site_name" content="enjoy struggling">
<meta property="og:description" content="今日は Azure AD B2C を OIDC な IdP である Yahoo! ID とつなげてみよう、というお話。 Azure AD B2C とはMicrosoft が提供する Auth0 みたいなサービス。">
<meta property="og:locale">
<meta property="og:image" content="http://blog.haniyama.com/2019/09/23/azuread-b2c-can-not-connect-yahooid/callback.png">
<meta property="og:image" content="http://blog.haniyama.com/2019/09/23/azuread-b2c-can-not-connect-yahooid/custom-oidc-provider.png">
<meta property="og:image" content="http://blog.haniyama.com/2019/09/23/azuread-b2c-can-not-connect-yahooid/run-flow.png">
<meta property="og:image" content="http://blog.haniyama.com/2019/09/23/azuread-b2c-can-not-connect-yahooid/result.png">
<meta property="article:published_time" content="2019-09-23T11:28:11.000Z">
<meta property="article:modified_time" content="2022-05-18T13:45:28.994Z">
<meta property="article:author" content="watahani">
<meta property="article:tag" content="Azure">
<meta property="article:tag" content="OIDC">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.haniyama.com/2019/09/23/azuread-b2c-can-not-connect-yahooid/callback.png">
<meta name="twitter:creator" content="@watahani"><meta name="description"><meta name="keywords" content="Java, Javascript, AWS, GCP, PGP"><link rel="alternate" type="application/atom+xml" href="/atom.xml" title="enjoy struggling"><title>Azure AD B2C に Yahoo! ID を連携しようとして失敗した話 - enjoy struggling</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.png"><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create', 'UA-113476970-1', 'auto');ga('send', 'pageview');</script><meta name="generator" content="Hexo 6.3.0"><link rel="stylesheet" href="/css/prism-atom-dark.css" type="text/css"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a target="_blank" rel="noopener" href="https://github.com/watahani"><span>Github</span></a></li><li><a target="_blank" rel="noopener" href="https://qiita.com/watahani"><span>Qiita</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><link rel="amphtml" href="./amp/index.html"><label class="navi-button light" for="navi">MENU</label><img class="background" src="https://storage.googleapis.com/blog-haniyama/background-min.png"><div class="post-title"><h1 class="title">Azure AD B2C に Yahoo! ID を連携しようとして失敗した話</h1><ul class="meta"><li><i class="icon icon-author"></i>watahani</li><li><i class="icon icon-clock"></i>54 Minutes</li><li><i class="icon icon-calendar"></i>September 23, 2019</li></ul></div></div><div class="article-content" style="max-width:800px"><p>今日は Azure AD B2C を OIDC な IdP である Yahoo! ID とつなげてみよう、というお話。</p>
<h2 id="Azure-AD-B2C-とは"><a href="#Azure-AD-B2C-とは" class="headerlink" title="Azure AD B2C とは"></a>Azure AD B2C とは</h2><p>Microsoft が提供する Auth0 みたいなサービス。</p>
<span id="more"></span>

<p>アプリケーションへの認証を Google や Facebook, Twitter といったソーシャル アカウントで行うために、Azure AD B2C というテナントに、複数の IdP を連携させることができる。</p>
<p>具体的には B2C 側が、連携する IdP から id_token やら userinfo を引っ張ってきて、良しなにユーザーを登録・認証してくれるって感じ。<br>様々な IdP に対応していて、アプリケーション側は、Azure AD B2C から発行されるトークンだけ見てればいいので色々楽ですよ、というやつですね。タブンネ。</p>
<h2 id="だめでしたー"><a href="#だめでしたー" class="headerlink" title="だめでしたー"></a>だめでしたー</h2><p>タイトルにある通り、結論から言うと連携できなかった。<br>失敗した理由としては Yahoo! ID が response_mode&#x3D;query のパラメータを読み込んでくれなかった (※ B2C が response_mode を省略してくれなかった) からなのだけど、いろいろ手順も残しておきたいのでブログにまとめようと思う。</p>
<blockquote>
<p>追記: カスタム ポリシーで OAuth プロファイルで作成すればいけた。</p>
</blockquote>
<h2 id="失敗手順"><a href="#失敗手順" class="headerlink" title="失敗手順"></a>失敗手順</h2><p>細かい手順は省略しているので、各自ドキュメント等よんで調べてください。</p>
<h3 id="B2C-テナントを作る"><a href="#B2C-テナントを作る" class="headerlink" title="B2C テナントを作る"></a>B2C テナントを作る</h3><p>略。</p>
<h3 id="Yahoo-ID-を利用するアプリの登録"><a href="#Yahoo-ID-を利用するアプリの登録" class="headerlink" title="Yahoo! ID を利用するアプリの登録"></a>Yahoo! ID を利用するアプリの登録</h3><p><a target="_blank" rel="noopener" href="https://developer.yahoo.co.jp/start/">ご利用ガイド - Yahoo!デベロッパーネットワーク</a> に、step by step で手順があるので、その通りにアプリを登録する。</p>
<p>Authorize Code Flow を動かすので、アプリケーションは “サーバーサイド（Yahoo! ID連携 v2）” を選んで、あとは適当に入力する。</p>
<p><img src="/2019/09/23/azuread-b2c-can-not-connect-yahooid/callback.png"></p>
<p>コールバック URL には、後述するが以下の 2 つを追加しておく。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://yourdomain.b2clogin.com/yourdomain.onmicrosoft.com/oauth2/authresp">https://yourdomain.b2clogin.com/yourdomain.onmicrosoft.com/oauth2/authresp</a></li>
<li><a target="_blank" rel="noopener" href="https://yourdomain.b2clogin.com/yourdomain.onmicrosoft.com/b2c_1a_trustframeworkbaseyahoo/oauth2/authresp">https://yourdomain.b2clogin.com/yourdomain.onmicrosoft.com/b2c_1a_trustframeworkbaseyahoo/oauth2/authresp</a></li>
</ul>
<p>あとは、検証用に jwt.io とか jwt.ms とか localhost とか必要であれば追加しておく。</p>
<h3 id="カスタム-OIDC-プロバイダーとして-Yahoo-ID-を追加する"><a href="#カスタム-OIDC-プロバイダーとして-Yahoo-ID-を追加する" class="headerlink" title="カスタム OIDC プロバイダーとして Yahoo! ID を追加する"></a>カスタム OIDC プロバイダーとして Yahoo! ID を追加する</h3><p>組み込みポリシーを利用して B2C に OIDC の IdP を追加するには、<code>Azure AD B2C</code> &gt; <code>ID プロバイダー</code> &gt; <code>新しい OpenID Connect プロバイダー</code> を選択する。</p>
<p>OIDC の場合メタデータ URL を指定すればほぼ完了。Yahoo! ID の場合は以下の URLとなる。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://auth.login.yahoo.co.jp/yconnect/v2/.well-known/openid-configuration">https://auth.login.yahoo.co.jp/yconnect/v2/.well-known/openid-configuration</a></li>
</ul>
<p>クライアント ID とクライアント シークレットは、アプリを作ったときに払い出されたものを。スコープは<code>openid profile email</code>、<br>応答の種類は <code>code</code>、応答モードは <code>query</code>、ドメインのヒントは、アプリケーションが B2C に対して認証リクエスト投げるときに利用するものだと思うので適当で OK。</p>
<p>あとはクレームのマッピングを <a target="_blank" rel="noopener" href="https://developer.yahoo.co.jp/yconnect/v2/userinfo.html">Yahoo! ID の UserInfo API のドキュメント</a> をみて適当に決める。</p>
<p><img src="/2019/09/23/azuread-b2c-can-not-connect-yahooid/custom-oidc-provider.png"></p>
<p>手順はこれだけで OK。</p>
<h3 id="ユーザーフローの作成"><a href="#ユーザーフローの作成" class="headerlink" title="ユーザーフローの作成"></a>ユーザーフローの作成</h3><p><code>ユーザー フロー</code> &gt; <code>新しいユーザー フロー</code> &gt; <code>サインアップとサインイン</code> から、新しいサインアップとサインインフローを作成し、IdP として先ほど登録した OIDC プロバイダー (Yahoo!) を選ぶ。クレームの要求は適当に設定して保存する。</p>
<h3 id="アプリの登録"><a href="#アプリの登録" class="headerlink" title="アプリの登録"></a>アプリの登録</h3><p>Azure AD B2C を IdP として利用するアプリの登録。略。</p>
<h3 id="作成したユーザー-フローのテスト"><a href="#作成したユーザー-フローのテスト" class="headerlink" title="作成したユーザー フローのテスト"></a>作成したユーザー フローのテスト</h3><p>作成したユーザー フローを選択し、<code>今すぐ実行</code> を選択する。</p>
<p><img src="/2019/09/23/azuread-b2c-can-not-connect-yahooid/run-flow.png"></p>
<h3 id="結果"><a href="#結果" class="headerlink" title="結果"></a>結果</h3><p>‘Error: invalid_request,Error Description: response_mode is invalid.’</p>
<p><img src="/2019/09/23/azuread-b2c-can-not-connect-yahooid/result.png"></p>
<p>初めに書いた通り、結論から言うと動かなかった。なぜうまく動かないのか、もう少し詳細にみてみる。</p>
<p>Chrome の <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/redirect-path/aomidfkchockcldhbkggjokdkkebmdll">Redirect Path</a> という拡張を利用して、サインイン時のリダイレクトの動きを見てみた。</p>
<p>B2C のサインイン ページから Yahoo! へは以下のリクエストが送られていた。</p>
<pre class="language-http" style="" tabindex="0"><code id="e052293e" class="language-http" data-prism-hydrate="{&quot;element&quot;:&quot;e052293e&quot;,&quot;language&quot;:&quot;http&quot;,&quot;code&quot;:&quot;\nhttps://auth.login.yahoo.co.jp/yconnect/v2/authorization?\n  client_id=xxxxxxxxxxxxxxxxxxxxxxxxxxxxx\u0026\n  redirect_uri=https%3a%2f%2fyourdomain.b2clogin.com%2fyourdomain.onmicrosoft.com%2foauth2%2fauthresp&amp;\n  response_type=code&amp;\n  scope=openid+profile+email&amp;\n  response_mode=query&amp;\n  nonce=CpKTVRSC%2fgtFG0FSaQEpIg%3d%3d&amp;\n  ui_locales=en-US&amp;\n  state=StateProperties%3deyJ....\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token header\&quot;\u003e<span class=\&quot;token header-name keyword\&quot;>https</span><span class=\&quot;token punctuation\&quot;>:</span><span class=\&quot;token header-value\&quot;>//auth.login.yahoo.co.jp/yconnect/v2/authorization?\n  client_id=xxxxxxxxxxxxxxxxxxxxxxxxxxxxx&amp;amp;\n  redirect_uri=https%3a%2f%2fyourdomain.b2clogin.com%2fyourdomain.onmicrosoft.com%2foauth2%2fauthresp&amp;amp;\n  response_type=code&amp;amp;\n  scope=openid+profile+email&amp;amp;\n  response_mode=query&amp;amp;\n  nonce=CpKTVRSC%2fgtFG0FSaQEpIg%3d%3d&amp;amp;\n  ui_locales=en-US&amp;amp;\n  state=StateProperties%3deyJ....</span></span>\n&quot;}">
<span class="token header"><span class="token header-name keyword">https</span><span class="token punctuation">:</span><span class="token header-value">//auth.login.yahoo.co.jp/yconnect/v2/authorization?
  client_id=xxxxxxxxxxxxxxxxxxxxxxxxxxxxx&amp;
  redirect_uri=https%3a%2f%2fyourdomain.b2clogin.com%2fyourdomain.onmicrosoft.com%2foauth2%2fauthresp&amp;
  response_type=code&amp;
  scope=openid+profile+email&amp;
  response_mode=query&amp;
  nonce=CpKTVRSC%2fgtFG0FSaQEpIg%3d%3d&amp;
  ui_locales=en-US&amp;
  state=StateProperties%3deyJ....</span></span>
</code></pre>

<p>で、Yahoo! ID はこのリクエストに対し、以下のエラーを返していた。</p>
<pre class="language-http" style="" tabindex="0"><code id="f843073f" class="language-http" data-prism-hydrate="{&quot;element&quot;:&quot;f843073f&quot;,&quot;language&quot;:&quot;http&quot;,&quot;code&quot;:&quot;\nhttps://yourdomain.b2clogin.com/yourdomain.onmicrosoft.com/oauth2/authresp?\n  error=invalid_request\u0026\n  error_description=response_mode+is+invalid.&amp;\n  error_code=1227&amp;\n  state=StateProperties%3DeyJ...\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token header\&quot;\u003e<span class=\&quot;token header-name keyword\&quot;>https</span><span class=\&quot;token punctuation\&quot;>:</span><span class=\&quot;token header-value\&quot;>//yourdomain.b2clogin.com/yourdomain.onmicrosoft.com/oauth2/authresp?\n  error=invalid_request&amp;amp;\n  error_description=response_mode+is+invalid.&amp;amp;\n  error_code=1227&amp;amp;\n  state=StateProperties%3DeyJ...</span></span>\n&quot;}">
<span class="token header"><span class="token header-name keyword">https</span><span class="token punctuation">:</span><span class="token header-value">//yourdomain.b2clogin.com/yourdomain.onmicrosoft.com/oauth2/authresp?
  error=invalid_request&amp;
  error_description=response_mode+is+invalid.&amp;
  error_code=1227&amp;
  state=StateProperties%3DeyJ...</span></span>
</code></pre>

<p>B2C のエンドポイントは、エラーを受け取ったらそのままアプリに返すらしく、登録していた jwt.ms に以下のようにエラーを返していた。</p>
<pre class="language-http" style="" tabindex="0"><code id="bf989f3d" class="language-http" data-prism-hydrate="{&quot;element&quot;:&quot;bf989f3d&quot;,&quot;language&quot;:&quot;http&quot;,&quot;code&quot;:&quot;\nhttps://jwt.ms/#\n  error=server_error\u0026\n  error_description=AADB2C90273%3a+An+invalid+response+was+received+%3a+%27Error%3a+invalid_request%2cError+Description%3a+response_mode+is+invalid.%27%0d%0aCorrelation+ID%3a+b300b4fb-c1ab-491d-86f1-4d1dc129892f%0d%0aTimestamp%3a+2019-09-23+09%3a39%3a54Z%0d%0a\n&quot;,&quot;highlightedCode&quot;:&quot;\n\u003cspan class=\&quot;token header\&quot;\u003e<span class=\&quot;token header-name keyword\&quot;>https</span><span class=\&quot;token punctuation\&quot;>:</span><span class=\&quot;token header-value\&quot;>//jwt.ms/#\n  error=server_error&amp;amp;\n  error_description=AADB2C90273%3a+An+invalid+response+was+received+%3a+%27Error%3a+invalid_request%2cError+Description%3a+response_mode+is+invalid.%27%0d%0aCorrelation+ID%3a+b300b4fb-c1ab-491d-86f1-4d1dc129892f%0d%0aTimestamp%3a+2019-09-23+09%3a39%3a54Z%0d%0a</span></span>\n&quot;}">
<span class="token header"><span class="token header-name keyword">https</span><span class="token punctuation">:</span><span class="token header-value">//jwt.ms/#
  error=server_error&amp;
  error_description=AADB2C90273%3a+An+invalid+response+was+received+%3a+%27Error%3a+invalid_request%2cError+Description%3a+response_mode+is+invalid.%27%0d%0aCorrelation+ID%3a+b300b4fb-c1ab-491d-86f1-4d1dc129892f%0d%0aTimestamp%3a+2019-09-23+09%3a39%3a54Z%0d%0a</span></span>
</code></pre>

<p>ということで、B2C がリクエストに投げる response_mode を指定している部分が悪そうだというのが分かる。実際、Yahoo! ID に投げる Authorize Request から response_mode を消してやるとうまく動く。</p>
<p>respones_mode 自体は OAuth の<a target="_blank" rel="noopener" href="https://openid.net/specs/oauth-v2-multiple-response-types-1_0.html">OAuth 2.0 Multiple Response Type Encoding Practices</a> で、AuthZ レスポンスをどこに返すかを指定するパラメータらしい。<br>@TakahikoKawasaki さんの <a target="_blank" rel="noopener" href="https://qiita.com/TakahikoKawasaki/items/185d34814eb9f7ac7ef3#13-%E5%BF%9C%E7%AD%94%E3%83%A2%E3%83%BC%E3%83%89-response_mode">OAuth &amp; OpenID Connect 関連仕様まとめ - Qiita</a> が非常にわかりやすかった。</p>
<p>とはいえ、必須のパラメータではないので B2C のパラメータとしては消せてもいい気がするけど…。</p>
<h3 id="カスタムポリシーで試す"><a href="#カスタムポリシーで試す" class="headerlink" title="カスタムポリシーで試す"></a>カスタムポリシーで試す</h3><p>Azure B2C が response_mode を絶対入れてリクエストを送るのがダメなので、色々できるカスタムポリシーで試してみる。</p>
<p>まずは、Client Secret を ポリシー キー に <code>B2C_1A_YahooAppSecret</code> として登録する。<br>その後<a target="_blank" rel="noopener" href="https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack">B2C Custom Policy Starterpack</a> の SocialandLocalAccounts の TrustFrameworkBase.xml の Facebook 部分を以下に入れ替える。</p>
<pre class="language-xml" style="" tabindex="0"><code id="d6a5423f" class="language-xml" data-prism-hydrate="{&quot;element&quot;:&quot;d6a5423f&quot;,&quot;language&quot;:&quot;xml&quot;,&quot;code&quot;:&quot;\n      \u003cClaimsProvider\u003e\n      <!-- The following Domain element allows this profile to be used if the request comes with domain_hint \n           query string parameter, e.g. domain_hint=facebook.com  -->\n      <Domain>yahoo.co.jp</Domain>\n      <DisplayName>Yahoo! Japan</DisplayName>\n      <TechnicalProfiles>\n        <TechnicalProfile Id=\&quot;Yahoo-OIDCv2\&quot;>\n          <!-- The text in the following DisplayName element is shown to the user on the claims provider \n               selection screen. -->\n          <DisplayName>Yahoo!</DisplayName>\n          <Protocol Name=\&quot;OpenIdConnect\&quot; />\n          <Metadata>\n            <Item Key=\&quot;ProviderName\&quot;>yahoo</Item>\n            <Item Key=\&quot;METADATA\&quot;>https://auth.login.yahoo.co.jp/yconnect/v2/.well-known/openid-configuration</Item>\n            <Item Key=\&quot;response_types\&quot;>code</Item>\n            <Item Key=\&quot;scope\&quot;>openid profile email</Item>\n            <!-- 消す <Item Key=\&quot;response_mode\&quot;>query</Item> -->\n            <Item Key=\&quot;HttpBinding\&quot;>GET</Item>\n            <Item Key=\&quot;client_id\&quot;>xxxxxxxxx</Item>\n          </Metadata>\n          <CryptographicKeys>\n            <Key Id=\&quot;client_secret\&quot; StorageReferenceId=\&quot;B2C_1A_YahooAppSecret\&quot; />\n          </CryptographicKeys>\n          <InputClaims />\n          <OutputClaims>\n            <OutputClaim ClaimTypeReferenceId=\&quot;identityProvider\&quot; DefaultValue=\&quot;yahoo.co.jp\&quot; />\n            <OutputClaim ClaimTypeReferenceId=\&quot;authenticationSource\&quot; DefaultValue=\&quot;socialIdpAuthentication\&quot; />\n            <OutputClaim ClaimTypeReferenceId=\&quot;issuerUserId\&quot; PartnerClaimType=\&quot;sub\&quot; />\n            <OutputClaim ClaimTypeReferenceId=\&quot;displayName\&quot; PartnerClaimType=\&quot;name\&quot; />\n            <OutputClaim ClaimTypeReferenceId=\&quot;email\&quot; />\n          </OutputClaims>\n          <OutputClaimsTransformations>\n            <OutputClaimsTransformation ReferenceId=\&quot;CreateRandomUPNUserName\&quot; />\n            <OutputClaimsTransformation ReferenceId=\&quot;CreateUserPrincipalName\&quot; />\n            <OutputClaimsTransformation ReferenceId=\&quot;CreateAlternativeSecurityId\&quot; />\n            <OutputClaimsTransformation ReferenceId=\&quot;CreateSubjectClaimFromAlternativeSecurityId\&quot; />\n          </OutputClaimsTransformations>\n          <UseTechnicalProfileForSessionManagement ReferenceId=\&quot;SM-SocialLogin\&quot; />\n        </TechnicalProfile>\n      </TechnicalProfiles>\n    </ClaimsProvider>\n&quot;,&quot;highlightedCode&quot;:&quot;\n      <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>\u0026lt;</span>ClaimsProvider</span><span class=\&quot;token punctuation\&quot;>></span></span>\n      <span class=\&quot;token comment\&quot;>&amp;lt;!-- The following Domain element allows this profile to be used if the request comes with domain_hint \n           query string parameter, e.g. domain_hint=facebook.com  --></span>\n      <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>Domain</span><span class=\&quot;token punctuation\&quot;>></span></span>yahoo.co.jp<span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>Domain</span><span class=\&quot;token punctuation\&quot;>></span></span>\n      <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>DisplayName</span><span class=\&quot;token punctuation\&quot;>></span></span>Yahoo! Japan<span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>DisplayName</span><span class=\&quot;token punctuation\&quot;>></span></span>\n      <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>TechnicalProfiles</span><span class=\&quot;token punctuation\&quot;>></span></span>\n        <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>TechnicalProfile</span> <span class=\&quot;token attr-name\&quot;>Id</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>Yahoo-OIDCv2<span class=\&quot;token punctuation\&quot;>\&quot;</span></span><span class=\&quot;token punctuation\&quot;>></span></span>\n          <span class=\&quot;token comment\&quot;>&amp;lt;!-- The text in the following DisplayName element is shown to the user on the claims provider \n               selection screen. --></span>\n          <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>DisplayName</span><span class=\&quot;token punctuation\&quot;>></span></span>Yahoo!<span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>DisplayName</span><span class=\&quot;token punctuation\&quot;>></span></span>\n          <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>Protocol</span> <span class=\&quot;token attr-name\&quot;>Name</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>OpenIdConnect<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n          <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>Metadata</span><span class=\&quot;token punctuation\&quot;>></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>Item</span> <span class=\&quot;token attr-name\&quot;>Key</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>ProviderName<span class=\&quot;token punctuation\&quot;>\&quot;</span></span><span class=\&quot;token punctuation\&quot;>></span></span>yahoo<span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>Item</span><span class=\&quot;token punctuation\&quot;>></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>Item</span> <span class=\&quot;token attr-name\&quot;>Key</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>METADATA<span class=\&quot;token punctuation\&quot;>\&quot;</span></span><span class=\&quot;token punctuation\&quot;>></span></span>https://auth.login.yahoo.co.jp/yconnect/v2/.well-known/openid-configuration<span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>Item</span><span class=\&quot;token punctuation\&quot;>></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>Item</span> <span class=\&quot;token attr-name\&quot;>Key</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>response_types<span class=\&quot;token punctuation\&quot;>\&quot;</span></span><span class=\&quot;token punctuation\&quot;>></span></span>code<span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>Item</span><span class=\&quot;token punctuation\&quot;>></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>Item</span> <span class=\&quot;token attr-name\&quot;>Key</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>scope<span class=\&quot;token punctuation\&quot;>\&quot;</span></span><span class=\&quot;token punctuation\&quot;>></span></span>openid profile email<span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>Item</span><span class=\&quot;token punctuation\&quot;>></span></span>\n            <span class=\&quot;token comment\&quot;>&amp;lt;!-- 消す &amp;lt;Item Key=\&quot;response_mode\&quot;>query&amp;lt;/Item> --></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>Item</span> <span class=\&quot;token attr-name\&quot;>Key</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>HttpBinding<span class=\&quot;token punctuation\&quot;>\&quot;</span></span><span class=\&quot;token punctuation\&quot;>></span></span>GET<span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>Item</span><span class=\&quot;token punctuation\&quot;>></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>Item</span> <span class=\&quot;token attr-name\&quot;>Key</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>client_id<span class=\&quot;token punctuation\&quot;>\&quot;</span></span><span class=\&quot;token punctuation\&quot;>></span></span>xxxxxxxxx<span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>Item</span><span class=\&quot;token punctuation\&quot;>></span></span>\n          <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>Metadata</span><span class=\&quot;token punctuation\&quot;>></span></span>\n          <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>CryptographicKeys</span><span class=\&quot;token punctuation\&quot;>></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>Key</span> <span class=\&quot;token attr-name\&quot;>Id</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>client_secret<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token attr-name\&quot;>StorageReferenceId</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>B2C_1A_YahooAppSecret<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n          <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>CryptographicKeys</span><span class=\&quot;token punctuation\&quot;>></span></span>\n          <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>InputClaims</span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n          <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>OutputClaims</span><span class=\&quot;token punctuation\&quot;>></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>OutputClaim</span> <span class=\&quot;token attr-name\&quot;>ClaimTypeReferenceId</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>identityProvider<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token attr-name\&quot;>DefaultValue</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>yahoo.co.jp<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>OutputClaim</span> <span class=\&quot;token attr-name\&quot;>ClaimTypeReferenceId</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>authenticationSource<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token attr-name\&quot;>DefaultValue</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>socialIdpAuthentication<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>OutputClaim</span> <span class=\&quot;token attr-name\&quot;>ClaimTypeReferenceId</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>issuerUserId<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token attr-name\&quot;>PartnerClaimType</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>sub<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>OutputClaim</span> <span class=\&quot;token attr-name\&quot;>ClaimTypeReferenceId</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>displayName<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token attr-name\&quot;>PartnerClaimType</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>name<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>OutputClaim</span> <span class=\&quot;token attr-name\&quot;>ClaimTypeReferenceId</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>email<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n          <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>OutputClaims</span><span class=\&quot;token punctuation\&quot;>></span></span>\n          <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>OutputClaimsTransformations</span><span class=\&quot;token punctuation\&quot;>></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>OutputClaimsTransformation</span> <span class=\&quot;token attr-name\&quot;>ReferenceId</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>CreateRandomUPNUserName<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>OutputClaimsTransformation</span> <span class=\&quot;token attr-name\&quot;>ReferenceId</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>CreateUserPrincipalName<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>OutputClaimsTransformation</span> <span class=\&quot;token attr-name\&quot;>ReferenceId</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>CreateAlternativeSecurityId<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n            <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>OutputClaimsTransformation</span> <span class=\&quot;token attr-name\&quot;>ReferenceId</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>CreateSubjectClaimFromAlternativeSecurityId<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n          <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>OutputClaimsTransformations</span><span class=\&quot;token punctuation\&quot;>></span></span>\n          <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;</span>UseTechnicalProfileForSessionManagement</span> <span class=\&quot;token attr-name\&quot;>ReferenceId</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>SM-SocialLogin<span class=\&quot;token punctuation\&quot;>\&quot;</span></span> <span class=\&quot;token punctuation\&quot;>/></span></span>\n        <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>TechnicalProfile</span><span class=\&quot;token punctuation\&quot;>></span></span>\n      <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>TechnicalProfiles</span><span class=\&quot;token punctuation\&quot;>></span></span>\n    <span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>ClaimsProvider</span><span class=\&quot;token punctuation\&quot;>></span></span>\n&quot;}">
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsProvider</span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!-- The following Domain element allows this profile to be used if the request comes with domain_hint 
           query string parameter, e.g. domain_hint=facebook.com  --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Domain</span><span class="token punctuation">&gt;</span></span>yahoo.co.jp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Domain</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DisplayName</span><span class="token punctuation">&gt;</span></span>Yahoo! Japan<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DisplayName</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TechnicalProfiles</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TechnicalProfile</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Yahoo-OIDCv2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token comment">&lt;!-- The text in the following DisplayName element is shown to the user on the claims provider 
               selection screen. --&gt;</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DisplayName</span><span class="token punctuation">&gt;</span></span>Yahoo!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DisplayName</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Protocol</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>OpenIdConnect<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Metadata</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ProviderName<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>yahoo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>METADATA<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>https://auth.login.yahoo.co.jp/yconnect/v2/.well-known/openid-configuration<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>response_types<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>code<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>scope<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>openid profile email<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- 消す &lt;Item Key="response_mode"&gt;query&lt;/Item&gt; --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>HttpBinding<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>GET<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>client_id<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>xxxxxxxxx<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Metadata</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CryptographicKeys</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Key</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>client_secret<span class="token punctuation">"</span></span> <span class="token attr-name">StorageReferenceId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>B2C_1A_YahooAppSecret<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CryptographicKeys</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaims</span> <span class="token punctuation">/&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaims</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>identityProvider<span class="token punctuation">"</span></span> <span class="token attr-name">DefaultValue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yahoo.co.jp<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>authenticationSource<span class="token punctuation">"</span></span> <span class="token attr-name">DefaultValue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>socialIdpAuthentication<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>issuerUserId<span class="token punctuation">"</span></span> <span class="token attr-name">PartnerClaimType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sub<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>displayName<span class="token punctuation">"</span></span> <span class="token attr-name">PartnerClaimType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OutputClaims</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaimsTransformations</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaimsTransformation</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CreateRandomUPNUserName<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaimsTransformation</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CreateUserPrincipalName<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaimsTransformation</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CreateAlternativeSecurityId<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaimsTransformation</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>CreateSubjectClaimFromAlternativeSecurityId<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OutputClaimsTransformations</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UseTechnicalProfileForSessionManagement</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SM-SocialLogin<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TechnicalProfile</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TechnicalProfiles</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ClaimsProvider</span><span class="token punctuation">&gt;</span></span>
</code></pre>

<p>あと、PolicyId は <code>B2C_1A_TrustFrameworkBaseYahoo</code> に変えておく (参照してる xml も直しておく)。<br>できたら <code>TrustFrameworkBase.xml</code>, <code>TrustFrameworkExtensions.xml</code>, <code>SignUpOrSignIn.xml</code> の 3 ファイルを <code>Identity Experience Framework</code> にアップロードする。</p>
<p>ClaimsProvider を記述した PolicyId が、callback URL になるらしく、PolicyId が <code>trustframeworkbaseyahoo</code> だったら、以下の URL となる。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://yourdomain.b2clogin.com/yourdomain.onmicrosoft.com/b2c_1a_trustframeworkbaseyahoo/oauth2/authresp">https://yourdomain.b2clogin.com/yourdomain.onmicrosoft.com/b2c_1a_trustframeworkbaseyahoo/oauth2/authresp</a></li>
</ul>
<blockquote>
<p>※なんか <a target="_blank" rel="noopener" href="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/openid-connect-technical-profile">ドキュメント</a> には <a target="_blank" rel="noopener" href="https://yourtenant.b2clogin.com/your-tenant.onmicrosoft.com/oauth2/authresp">https://yourtenant.b2clogin.com/your-tenant.onmicrosoft.com/oauth2/authresp</a> 使うってかいてあって実際の動作と違う…。なんだこれ？</p>
</blockquote>
<p>で、response_mode を消したり、空で設定してみたり…</p>
<pre class="language-xml" style="" tabindex="0"><code id="41fccf3e" class="language-xml" data-prism-hydrate="{&quot;element&quot;:&quot;41fccf3e&quot;,&quot;language&quot;:&quot;xml&quot;,&quot;code&quot;:&quot;\n\u003cItem Key=\&quot;response_mode\&quot;\u003e</Item>\n&quot;,&quot;highlightedCode&quot;:&quot;\n<span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>\u0026lt;</span>Item</span> <span class=\&quot;token attr-name\&quot;>Key</span><span class=\&quot;token attr-value\&quot;><span class=\&quot;token punctuation attr-equals\&quot;>=</span><span class=\&quot;token punctuation\&quot;>\&quot;</span>response_mode<span class=\&quot;token punctuation\&quot;>\&quot;</span></span><span class=\&quot;token punctuation\&quot;>></span></span><span class=\&quot;token tag\&quot;><span class=\&quot;token tag\&quot;><span class=\&quot;token punctuation\&quot;>&amp;lt;/</span>Item</span><span class=\&quot;token punctuation\&quot;>></span></span>\n&quot;}">
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>response_mode<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">&gt;</span></span>
</code></pre>

<p>しかし B2C からの AuthZ リクエストから response_mode が消えることはなかった…。かなしい。<br>なお、response_mode を消したり、値を空にすると、デフォルトの <code>form_post</code> になる。</p>
<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">MSさんJS苦手 &amp; SAML脳らしくて、id_token直で返して欲しいくせにfragmentは使いたくないとか言いおってな、出してきおったんや、form_postを。そんな経緯で出来たパラメーターやから、MSさんには必須かもしれん。</p>&mdash; nov matake (@nov) <a target="_blank" rel="noopener" href="https://twitter.com/nov/status/1176051340339843072?ref_src=twsrc%5Etfw">September 23, 2019</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>なるほど？</p>
<p>ということで、現在のところ Yahoo! ID を Azure B2C と連携することは <del>できないようです。まる。</del> </p>
<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">Azure AD B2CのProtocol設定とパラメータの受付が若干クセが強いからOAuth2指定でもscopeにopenidを指定すればOpenID Connectとして動いてくれる&amp;response_mode問題も解決する</p>&mdash; Naohiro Fujie (@phr_eidentity) <a target="_blank" rel="noopener" href="https://twitter.com/phr_eidentity/status/1176194980886396928?ref_src=twsrc%5Etfw">September 23, 2019</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>ということで、カスタム ポリシーならいけました。</p>
<script src="https://gist.github.com/watahani/6ee0ffff0f4879b760ba5ab171df7430.js"></script>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://developer.yahoo.co.jp/yconnect/v2/">Yahoo! ID連携:v2 - Yahoo!デベロッパーネットワーク</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/active-directory-b2c-setup-msa-app">Microsoft アカウントでのサインアップおよびサインインを設定する - Azure Active Directory B2C | Microsoft Docs</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/openid-connect-technical-profile">Azure Active Directory B2C 内のカスタム ポリシーで OpenID Connect 技術プロファイルを定義する | Microsoft Docs</a></li>
</ul>
<div class="related-post"><h3>関連記事</h3><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2020\06\02\aad-spa-auth-code-grant-with-pkce\" title="Azure AD の SPA 向け Authorize Code Flow with PKCE (MSAL.js 2.x)" rel="bookmark">Azure AD の SPA 向け Authorize Code Flow with PKCE (MSAL.js 2.x)</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2021\11\05\azure-portal-change-language\" title="Azure ポータルの言語をワンクリックで切り替える" rel="bookmark">Azure ポータルの言語をワンクリックで切り替える</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2020\04\30\azure-storage-blob-content-type-nodejs\" title="Azure Storage Blob に Content-Type 付きでアップロードする" rel="bookmark">Azure Storage Blob に Content-Type 付きでアップロードする</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2019\12\06\azuread-b2c-fido2-custompolicy\" title="Azure B2C の FIDO2 サンプルを動かす" rel="bookmark">Azure B2C の FIDO2 サンプルを動かす</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2019\07\15\azuread-fido2-security-key-public-preview\" title="Azure AD の FIDO2 Security Key 対応のパブリックプレビューが来たー" rel="bookmark">Azure AD の FIDO2 Security Key 対応のパブリックプレビューが来たー</a></h3></div></li></ul></div></div><div class="article-meta" style="max-width:800px"><div class="tags"><i class="icon icon-tag"></i><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure/" rel="tag">Azure</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OIDC/" rel="tag">OIDC</a><span class="tag-list-count">2</span></li></ul></div></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2019/11/24/ms-ignite-2019/"><i class="icon icon-arror-left"></i></a></li><li><a href="/2019/09/09/lost-securiykeys/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/82p" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="https://twitter.com/watahani" title="Twitter" target="_blank"><i class="icon icon-twitter"></i></a></li><li><a href="https://www.facebook.com/haniyama.wataru" title="Facebook" target="_blank"><i class="icon icon-facebook"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2023 enjoy struggling<br><small>POWER BY <a href="https://hexo.io" target="_blank">HEXO</a></small><small>, THEME BY <a href="https://github.com/BoizZ/hexo-theme-laughing" target="_blank">LAUGHING</a></small></p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>