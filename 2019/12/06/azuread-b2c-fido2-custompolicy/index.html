<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description" content="この記事は認証認可アドベントカレンダー の6日目の記事です。 動機: やっぱ OIDC ネタと FIDO ネタが多いから、どっちも絡めたやつを書けばめっちゃウケるのでは？→ Azure AD B2C に WebAuthn によるパスワードレス サインインを実装するサンプルあったなあ… と、苦し紛れにネタをひねり出した結果、くっそニッチな記事になってしまった。">
<meta property="og:type" content="article">
<meta property="og:title" content="Azure B2C の FIDO2 サンプルを動かす">
<meta property="og:url" content="http://blog.haniyama.com/2019/12/06/azuread-b2c-fido2-custompolicy/index.html">
<meta property="og:site_name" content="enjoy struggling">
<meta property="og:description" content="この記事は認証認可アドベントカレンダー の6日目の記事です。 動機: やっぱ OIDC ネタと FIDO ネタが多いから、どっちも絡めたやつを書けばめっちゃウケるのでは？→ Azure AD B2C に WebAuthn によるパスワードレス サインインを実装するサンプルあったなあ… と、苦し紛れにネタをひねり出した結果、くっそニッチな記事になってしまった。">
<meta property="og:locale">
<meta property="og:image" content="https://raw.githubusercontent.com/azure-ad-b2c/samples/master/policies/fido2/media/registration-user-flow.png">
<meta property="og:image" content="https://github.com/azure-ad-b2c/samples/blob/master/policies/fido2/media/authentication-user-flow.png?raw=true">
<meta property="og:image" content="http://blog.haniyama.com/2019/12/06/azuread-b2c-fido2-custompolicy/nowsh.png">
<meta property="og:image" content="http://blog.haniyama.com/2019/12/06/azuread-b2c-fido2-custompolicy/b2chtml.png">
<meta property="og:image" content="http://blog.haniyama.com/2019/12/06/azuread-b2c-fido2-custompolicy/appreg.png">
<meta property="og:image" content="http://blog.haniyama.com/2019/12/06/azuread-b2c-fido2-custompolicy/apppermission.png">
<meta property="og:image" content="http://blog.haniyama.com/2019/12/06/azuread-b2c-fido2-custompolicy/extensions.png">
<meta property="og:image" content="http://blog.haniyama.com/2019/12/06/azuread-b2c-fido2-custompolicy/b2ccomponent.png">
<meta property="og:image" content="http://blog.haniyama.com/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_01.png">
<meta property="og:image" content="http://blog.haniyama.com/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_02.png">
<meta property="og:image" content="http://blog.haniyama.com/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_03.png">
<meta property="og:image" content="http://blog.haniyama.com/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_04.png">
<meta property="og:image" content="http://blog.haniyama.com/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_05.png">
<meta property="og:image" content="http://blog.haniyama.com/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_06.png">
<meta property="og:image" content="http://blog.haniyama.com/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_07.png">
<meta property="og:image" content="http://blog.haniyama.com/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_08.png">
<meta property="og:image" content="http://blog.haniyama.com/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_09.png">
<meta property="og:image" content="http://blog.haniyama.com/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_10.png">
<meta property="og:image" content="http://blog.haniyama.com/2019/12/06/azuread-b2c-fido2-custompolicy/extensionsvalue.png">
<meta property="article:published_time" content="2019-12-05T16:29:00.000Z">
<meta property="article:modified_time" content="2022-05-18T13:45:28.998Z">
<meta property="article:author" content="watahani">
<meta property="article:tag" content="Azure">
<meta property="article:tag" content="OAuth">
<meta property="article:tag" content="FIDO2">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/azure-ad-b2c/samples/master/policies/fido2/media/registration-user-flow.png">
<meta name="twitter:creator" content="@watahani"><meta name="description"><meta name="keywords" content="Java, Javascript, AWS, GCP, PGP"><link rel="alternate" type="application/atom+xml" href="/atom.xml" title="enjoy struggling"><title>Azure B2C の FIDO2 サンプルを動かす - enjoy struggling</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.png"><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create', 'UA-113476970-1', 'auto');ga('send', 'pageview');</script><meta name="generator" content="Hexo 6.3.0"><link rel="stylesheet" href="/css/prism-atom-dark.css" type="text/css"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a target="_blank" rel="noopener" href="https://github.com/watahani"><span>Github</span></a></li><li><a target="_blank" rel="noopener" href="https://qiita.com/watahani"><span>Qiita</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><link rel="amphtml" href="./amp/index.html"><label class="navi-button light" for="navi">MENU</label><img class="background" src="https://storage.googleapis.com/blog-haniyama/background-min.png"><div class="post-title"><h1 class="title">Azure B2C の FIDO2 サンプルを動かす</h1><ul class="meta"><li><i class="icon icon-author"></i>watahani</li><li><i class="icon icon-clock"></i>123 Minutes</li><li><i class="icon icon-calendar"></i>December 6, 2019</li></ul></div></div><div class="article-content" style="max-width:800px"><p>この記事は<a target="_blank" rel="noopener" href="https://qiita.com/advent-calendar/2019/identity">認証認可アドベントカレンダー</a> の6日目の記事です。</p>
<p>動機: やっぱ OIDC ネタと FIDO ネタが多いから、<strong>どっちも絡めたやつを書けばめっちゃウケるのでは？</strong><br>→ Azure AD B2C に WebAuthn によるパスワードレス サインインを実装するサンプルあったなあ…</p>
<p>と、苦し紛れにネタをひねり出した結果、くっそニッチな記事になってしまった。</p>
<span id="more"></span>
<p>改めて読み直してみても、テーマを Azure B2C にしてしまったことで B2C を触ったことある人で、かつ FIDO に興味ある人という、 <strong>読者 を狭めてしまっている</strong> が、頑張って書いたのでもし全部試したという酔狂な人が (ふじえさん以外で) 居たらフィードバックヨロ。</p>
<h2 id="Azure-AD-B2C"><a href="#Azure-AD-B2C" class="headerlink" title="Azure AD B2C"></a>Azure AD B2C</h2><p>Azure AD B2C とは、Twitter や Facebook, その他の OpenID Provider を統合し、Azure AD B2C 独自の Id Token, Access Token を発行することが出来る。要は Auth0 的なサービス。(本ブログ二度目)</p>
<p>組み込みポリシーと呼ばれる既定のプロファイルで、複数の IdP と接続して、サインインフローを作れる。<br>OIDC のプロバイダーを接続するときのクセが強かったりするのだが、カスタム プロバイダーを追加することで、外部の OP を接続できるし、デフォルトの機能も最低限必要なものはそろってる。</p>
<p>のだが、複雑なビジネスロジックを組み込もうとすると、カスタム ポリシーを弄ることになる。</p>
<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>あらかじめ注意をしておくと、カスタム ポリシーを弄るのはかなりつらい作業で、メンテナンスも大変なのでできることなら組み込みのポリシーを利用することを <strong>強くオススメする</strong>。</p>
<p>B2C のカスタム ポリシーはマジでなんでも出来てしまうので、中身がわかってないとなぜ動かないのか全くわからなくなる。</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/active-directory-b2c-overview-custom">公式ドキュメント</a> にも、こう書いてある。</p>
<blockquote>
<p>ID のプロフェッショナル、システム インテグレータ、コンサルタント、社内の ID チーム。 彼らは OpenID Connect のフローに慣れており、ID プロバイダーや要求ベースの認証を理解しています。</p>
</blockquote>
<blockquote>
<p>注: Azure Active Directory B2C で、カスタム ポリシーは、主に、複雑なシナリオに取り組む用途向けに設計されています。<br>ほとんどのシナリオで、組み込みユーザー フローを使用することをお勧めします。</p>
</blockquote>
<p><strong>意訳: ID のプロフェッショナル以外は使うな</strong></p>
<p>個人的な意見を追加するなら、ID だけでなく XML のプロフェッショナルである必要があると思う。</p>
<p>また、本記事ではカスタム ポリシーのチュートリアルについては解説しない。<br>各自公式ドキュメント等で確認してほしい。</p>
<h2 id="カスタム-ポリシー"><a href="#カスタム-ポリシー" class="headerlink" title="カスタム ポリシー"></a>カスタム ポリシー</h2><p>カスタム ポリシーとは何ぞや。<br>Azure AD B2C は、ソーシャルアカウントと連携し、Azure AD B2C 独自の Id Token, Access Token を発行することが出来る。</p>
<p>その際各種 IdP と claim のやり取りを行い、検証し、変換し、任意のクレームを構築し、最終的にトークンを払い出す。</p>
<p>その際には様々なデータが入力される。<br>ユーザーの入力ID/パスワードであったり、ニックネーム、他の IdP から返却されるトークンかもしれない。</p>
<p>それらの入力から claim を取り出し、変換したり、外部 API で Validation したりして、最終的にトークンを作成し B2C の秘密鍵で署名するのが Azure B2C のキモ。</p>
<p>この claim の変換規則や、保存先、ユーザーの入力フォーム、それらのすべてを自由にカスタマイズできるのが、カスタム ポリシーである。</p>
<p>そして設定は <strong>すべて XML に保存されている。</strong></p>
<p>そう…… <strong>XML</strong> に保存されているのだ。</p>
<p>サンプルを動かすのに必要な知識は、 以下のブログにまとめられていて、実際に一つのサンプルを動かしてみたのが、今回の記事である。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.azure.moe/2019/11/22/%e5%86%b4%e3%81%88%e3%81%aa%e3%81%84custom-policy%e3%81%ae%e8%82%b2%e3%81%a6%e6%96%b9/">冴えないCustom Policyの育て方 | ブチザッキ</a></li>
</ul>
<h2 id="今回動かすサンプル"><a href="#今回動かすサンプル" class="headerlink" title="今回動かすサンプル"></a>今回動かすサンプル</h2><p>今回動かすサンプルはこちら。</p>
<p>Sign-in with FIDO authenticator<br><a target="_blank" rel="noopener" href="https://github.com/azure-ad-b2c/samples/tree/master/policies/fido2">https://github.com/azure-ad-b2c/samples/tree/master/policies/fido2</a></p>
<p>ID/Password でサインインするユーザーに、FIDO2 の Authenticator でサインインするフローを追加するもの。</p>
<p>最終的な動きはこんな感じ。</p>
<p>初期登録して<br><img src="https://raw.githubusercontent.com/azure-ad-b2c/samples/master/policies/fido2/media/registration-user-flow.png" alt=""></p>
<p>認証する。<br><img src="https://github.com/azure-ad-b2c/samples/blob/master/policies/fido2/media/authentication-user-flow.png?raw=true" alt=""></p>
<h2 id="事前準備"><a href="#事前準備" class="headerlink" title="事前準備"></a>事前準備</h2><p>残念ながら、このポリシー、これだけでは動かない。</p>
<p>まずはカスタム ポリシーの starterpack を構成する必要がある。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack">https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack</a></p>
<p>幸いカスタム ポリシーの導入はドキュメントがあるので、その通りに構成すればサインインフローができるはず。</p>
<p>カスタム ポリシーの概要 - Azure Active Directory B2C | Microsoft Docs<br><a target="_blank" rel="noopener" href="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/active-directory-b2c-get-started-custom?tabs=applications">https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/active-directory-b2c-get-started-custom?tabs=applications</a></p>
<p>たいていの人はここで XML を見て昇天する。心を強く持ってほしい。</p>
<p>XML の編集は <a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=AzureADB2CTools.aadb2c">Azure AD B2C の VS Code 拡張</a> を入れると、少しは楽になる。<br>是非入れよう。</p>
<h2 id="FIDO2-のカスタムポリシー"><a href="#FIDO2-のカスタムポリシー" class="headerlink" title="FIDO2 のカスタムポリシー"></a>FIDO2 のカスタムポリシー</h2><p>さて、事前準備を突破してしまったら、追加のポリシーを設定していく。<br><a target="_blank" rel="noopener" href="https://github.com/azure-ad-b2c/samples/tree/master/policies/fido2">サンプル</a> には、認証のコアとなる要求クレームや API コールが定義された <code>FIDOExtensions.xml</code> と、ユーザーが実際にアクセスするフローを定義した <code>FIDORegistration.xml</code> と <code>FIDOSignUpOrSignin.xml</code> がある。</p>
<p>詳しくは <a target="_blank" rel="noopener" href="https://github.com/azure-ad-b2c/ief-wiki/wiki/Policy-structure">ief-wiki</a> などを参照して欲しいが、カスタム ポリシーの XML は先ほど作成した <code>TrustFrameworkBase.xml</code> を継承して、拡張属性などを定義する。最終的に継承された Extension の内容すべてを統合して、B2C のポリシーが完成する。</p>
<blockquote>
<p>IEF は dentity Experience Framework の略</p>
</blockquote>
<p>今回の場合は <code>TrustFrameworkBase.xml</code> &gt; <code>TrustFrameworkExtensions</code> &gt; <code>FIDOExtensions.xml</code> と継承されている。<br><code>FIDORegistration.xml</code> と <code>FIDOSignUpOrSignin.xml</code> は、継承され統合された <code>FIDOExtensions.xml</code> を参照する。</p>
<p><code>FIDOExtensions.xml</code> に定義されていない設定は、継承元のどこかに記述されているはずなので、気力があれば継承元のポリシーを覗いてみよう。</p>
<p>今回は <code>FIDOExtensions.xml</code> のみを編集する。ただし、編集する前に事前準備が必要なので順にやっていく。</p>
<h3 id="事前準備-1-FIDO2-サーバーの作成"><a href="#事前準備-1-FIDO2-サーバーの作成" class="headerlink" title="事前準備 1. FIDO2 サーバーの作成"></a>事前準備 1. FIDO2 サーバーの作成</h3><p>まずはバックエンドに使う FIDO2 サーバーのサンプルを動かそう。<br>このサンプルでは、FIDO2 のサーバー部分は以下のサンプルを流用している。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/MicrosoftEdge/webauthnsample">https://github.com/MicrosoftEdge/webauthnsample</a></p>
<p>もともとは HTML も含めたサインアップ/サインインのサンプルだが、ウェブの画面は利用せずに、API だけ利用する。</p>
<p>ホントは Azure Function とかに載せようとしたけど使い方わからなくて断念。<br>Azure AppService とかも使ったことないので、now.sh にデプロイした。</p>
<p>注意点としては、最終的に WebAuthn が動くのは B2C のログイン画面、つまり <code>https://yourtenant.b2clogin.com</code> 上なので、rpId も <code>yourtenant.b2clogin.com</code> にしなければならないこと。</p>
<ul>
<li>fido.js ファイル内の以下の部分を修正する</li>
</ul>
<pre class=" language-diff"><code class="language-diff"><span class="token deleted">- const hostname = process.env.HOSTNAME || "localhost";</span>
<span class="token inserted">+ const hostname = "yourtenant.b2clogin.com";</span>
</code></pre>
<p>now.sh にデプロイするために、<code>now.json</code> を以下のように作成する。</p>
<script src="https://gist.github.com/watahani/1169bdea01979e888dbe1e18b8c35982.js"></script>

<p>後は、<code>npm install -g now</code> して <code>now</code> でデプロイ完了。</p>
<p><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/nowsh.png" alt=""></p>
<blockquote>
<p>now.sh が v2 にバージョンアップしていて困ったが <a target="_blank" rel="noopener" href="https://qiita.com/aggre/items/f0cb9f8b8e8c54768e50">Now でクラウドの複雑さから解放されよう、今すぐに - Qiita</a> あたりを参考にした</p>
</blockquote>
<p><code>https://source-code.username.now.sh</code> とかでデプロイされるので <code>https://source-code.username.now.sh/challenge</code> にブラウザでアクセスしてチャレンジが返れば OK。</p>
<p>URL は後で使うのでメモっておく。</p>
<p>なお、後述するユーザーデータの保存先の関係上、WebAuthn の sign count はチェックしていない。</p>
<h3 id="事前準備-2-静的ファイルのホスト"><a href="#事前準備-2-静的ファイルのホスト" class="headerlink" title="事前準備 2. 静的ファイルのホスト"></a>事前準備 2. 静的ファイルのホスト</h3><p>WebAuthn のキーを登録/認証するための、カスタム サインインページのための静的 HTML をアップロードする。</p>
<p>Azure B2C では外部の HTML テンプレートを JavaScript でフェッチして、必要なフォームを埋め込んで表示する。</p>
<p>今回は、カスタム HTML 上で Authenticator からのレスポンスをフォームに詰めて、次のフローに流す。</p>
<p><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/b2chtml.png" alt=""></p>
<p>適当に gist でも GitHub のリポジトリでも CORS が許可されている場所であればどこでも適当にアップロードにしていい。</p>
<p><a target="_blank" rel="noopener" href="https://gist.githubusercontent.com/watahani/f94a8362a4cc075a67254eb403c9c1c7/raw/e83697aa603d0c11b78d9f503b4885ac84695601/self-asserted.html">https://gist.githubusercontent.com/watahani/f94a8362a4cc075a67254eb403c9c1c7/raw/e83697aa603d0c11b78d9f503b4885ac84695601/self-asserted.html</a><br><a target="_blank" rel="noopener" href="https://gist.githubusercontent.com/watahani/a49bec0c38ad1e2540b829ee4121d8ba/raw/dc5eaa4c36b80459980eae312861fac7339b269c/welcome.html">https://gist.githubusercontent.com/watahani/a49bec0c38ad1e2540b829ee4121d8ba/raw/dc5eaa4c36b80459980eae312861fac7339b269c/welcome.html</a></p>
<p>URL は後で使うのでメモっておく。</p>
<h3 id="事前準備-3-アプリの登録"><a href="#事前準備-3-アプリの登録" class="headerlink" title="事前準備 3. アプリの登録"></a>事前準備 3. アプリの登録</h3><p>サンプルでは WebAuthn の Credential ID と公開鍵などを保存するアプリを作成している。<br>アプリケーションに Credential ID を保存する関係上、ユーザーは 1 つの Credential しか保存できない。</p>
<p>本来別途 DB を用意して、ユーザーと公開鍵を保存すべきだが、Application Extension (拡張プロパティ) に保存している。<br>Custom Policy の練習のためにこうなってるのだと言い聞かせて、設定を進める。</p>
<ul>
<li>Azure Active Directory B2C でカスタム ポリシーに独自の属性を追加する | Microsoft Docs<br><a target="_blank" rel="noopener" href="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/active-directory-b2c-create-custom-attributes-profile-edit-custom">https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/active-directory-b2c-create-custom-attributes-profile-edit-custom</a></li>
</ul>
<p>何をやっているか簡単に説明すると、ユーザー属性を保存 &amp; 読み書きするアプリケーションを作成し、カスタムポリシー内で WebAuthn の情報を保存できるようにしている。</p>
<p>アプリの登録で登録する。アプリの名前は <code>WebApp-GraphAPI-FIDO2-Extensions</code> とした。</p>
<p>画面はこんな感じ。</p>
<p><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/appreg.png" alt=""></p>
<p>Admin Consent を完了させる。</p>
<p><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/apppermission.png" alt=""></p>
<p>で作成したアプリのオブジェクト ID と アプリケーション ID をメモっておく。</p>
<h2 id="FIDOExtensions-xml-の編集"><a href="#FIDOExtensions-xml-の編集" class="headerlink" title="FIDOExtensions.xml の編集"></a>FIDOExtensions.xml の編集</h2><p>ここまでの手順を完了した酔狂な人がいた場合、以下のような状態になっているはずである。</p>
<p><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/extensions.png" alt=""></p>
<p>この細切れのコンポーネントを、FIDOExtensions.xml でつないでいく。XML で…。</p>
<h3 id="UserJourneys"><a href="#UserJourneys" class="headerlink" title="UserJourneys"></a>UserJourneys</h3><p>どんどん認証認可の話が関係なってきているが、先に進みます。</p>
<p>ユーザーのフローについては、UserJourneys と呼ばれるタグに定義されており、UserJourneys は大抵 Extensions か、SignInSignUp の定義ファイルにある。</p>
<p>今回は FIDORegistration.xml を軽く (?) みていく。あくまで軽くね。</p>
<pre class=" language-xml"><code class="language-xml">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UserJourneys</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UserJourney</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>FIDO-Registration<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationSteps</span><span class="token punctuation">></span></span>
        <span class="token comment" spellcheck="true">&lt;!--Sample: Present the enrollment welcome screen--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationStep</span> <span class="token attr-name">Order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ClaimsExchange<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchanges</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchange</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SelfAsserted-EnrollmentWelcome<span class="token punctuation">"</span></span> <span class="token attr-name">TechnicalProfileReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SelfAsserted-FIDOEnrollmentWelcome<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ClaimsExchanges</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OrchestrationStep</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationStep</span> <span class="token attr-name">Order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>CombinedSignInAndSignUp<span class="token punctuation">"</span></span> <span class="token attr-name">ContentDefinitionReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>api.signuporsignin<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsProviderSelections</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsProviderSelection</span> <span class="token attr-name">ValidationClaimsExchangeId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>LocalAccountSigninEmailExchange<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ClaimsProviderSelections</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchanges</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchange</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>LocalAccountSigninEmailExchange<span class="token punctuation">"</span></span> <span class="token attr-name">TechnicalProfileReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SelfAsserted-LocalAccountSignin-Email<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ClaimsExchanges</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OrchestrationStep</span><span class="token punctuation">></span></span>
        <span class="token comment" spellcheck="true">&lt;!-- Check if the user has selected to sign in using one of the social providers --></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationStep</span> <span class="token attr-name">Order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ClaimsExchange<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Preconditions</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Precondition</span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ClaimsExist<span class="token punctuation">"</span></span> <span class="token attr-name">ExecuteActionsIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Value</span><span class="token punctuation">></span></span>objectId<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Value</span><span class="token punctuation">></span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Action</span><span class="token punctuation">></span></span>SkipThisOrchestrationStep<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Action</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Precondition</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Preconditions</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchanges</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchange</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SignUpWithLogonEmailExchange<span class="token punctuation">"</span></span> <span class="token attr-name">TechnicalProfileReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>LocalAccountSignUpWithLogonEmail<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ClaimsExchanges</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OrchestrationStep</span><span class="token punctuation">></span></span>
        <span class="token comment" spellcheck="true">&lt;!-- This step reads any user attributes that we may not have received when authenticating using ESTS so they can be sent 
          in the token. --></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationStep</span> <span class="token attr-name">Order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ClaimsExchange<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchanges</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchange</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AADUserReadWithObjectId<span class="token punctuation">"</span></span> <span class="token attr-name">TechnicalProfileReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AAD-UserReadUsingObjectId<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ClaimsExchanges</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OrchestrationStep</span><span class="token punctuation">></span></span>
        <span class="token comment" spellcheck="true">&lt;!--Sample: FIDO get a FIDO challenge value from the REST API service--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationStep</span> <span class="token attr-name">Order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ClaimsExchange<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchanges</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchange</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>REST-FIDOGetChallenge<span class="token punctuation">"</span></span> <span class="token attr-name">TechnicalProfileReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>REST-FIDOGetChallenge<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ClaimsExchanges</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OrchestrationStep</span><span class="token punctuation">></span></span>
        <span class="token comment" spellcheck="true">&lt;!--Sample: FIDO enrollment step--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationStep</span> <span class="token attr-name">Order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>6<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ClaimsExchange<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchanges</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchange</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SelfAsserted-Enrollment<span class="token punctuation">"</span></span> <span class="token attr-name">TechnicalProfileReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SelfAsserted-FIDOEnrollment<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ClaimsExchanges</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OrchestrationStep</span><span class="token punctuation">></span></span>
        <span class="token comment" spellcheck="true">&lt;!--Sample: FIDO enrollment persist data--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationStep</span> <span class="token attr-name">Order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>7<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ClaimsExchange<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchanges</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchange</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AAD-UserWriteFidoUsingObjectId<span class="token punctuation">"</span></span> <span class="token attr-name">TechnicalProfileReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AAD-UserWriteFidoUsingObjectId<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ClaimsExchanges</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OrchestrationStep</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationStep</span> <span class="token attr-name">Order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>8<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SendClaims<span class="token punctuation">"</span></span> <span class="token attr-name">CpimIssuerTechnicalProfileReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>JwtIssuer<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OrchestrationSteps</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClientDefinition</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DefaultWeb<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>UserJourney</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>UserJourneys</span><span class="token punctuation">></span></span>
</code></pre>
<p>OrchestrationStep の 1 ~ 4 までは通常の認証フローなので今回はスキップ。<br>いつか解説記事を書けたらかくかも。</p>
<p>5 が API のアクセスを実行する部分。</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationStep</span> <span class="token attr-name">Order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ClaimsExchange<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchanges</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchange</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>REST-FIDOGetChallenge<span class="token punctuation">"</span></span> <span class="token attr-name">TechnicalProfileReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>REST-FIDOGetChallenge<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ClaimsExchanges</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OrchestrationStep</span><span class="token punctuation">></span></span>
</code></pre>
<p>TechnicalProfileReferenceId に <code>REST-FIDOGetChallenge&quot;</code> とあるので、<code>FIDOExtensions.xml</code> の該当する部分を確認すると。</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TechnicalProfile</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>REST-FIDOGetChallenge<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DisplayName</span><span class="token punctuation">></span></span>GET a FIDO Challenge<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DisplayName</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Protocol</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Proprietary<span class="token punctuation">"</span></span> <span class="token attr-name">Handler</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version<span class="token punctuation">=</span>1.0.0.0, Culture<span class="token punctuation">=</span>neutral, PublicKeyToken<span class="token punctuation">=</span>null<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Metadata</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ServiceUrl<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>https://yoursite.azurewebsites.net/challenge<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AuthenticationType<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>None<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SendClaimsIn<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>QueryString<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>
    <span class="token comment" spellcheck="true">&lt;!-- Remove in Production--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AllowInsecureAuthInProduction<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Metadata</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaims</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>challenge<span class="token punctuation">"</span></span> <span class="token attr-name">PartnerClaimType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>result<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token comment" spellcheck="true">&lt;!--Sample: Set the identity provider name to FIDO--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>identityProvider<span class="token punctuation">"</span></span> <span class="token attr-name">DefaultValue</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fido<span class="token punctuation">"</span></span> <span class="token attr-name">AlwaysUseDefaultValue</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OutputClaims</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UseTechnicalProfileForSessionManagement</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SM-Noop<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TechnicalProfile</span><span class="token punctuation">></span></span>
</code></pre>
<p>これが TechnicalProfile です!</p>
<p>このようにAPI をコールして Challenge を取得していることが分かりますね!!</p>
<p><code>Protocol</code> タグに <code>Handler=&quot;Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null&quot;</code> と指定があるので、たしかに Rest API ですね!!!</p>
<p>さて、API のエンドポイントが <a target="_blank" rel="noopener" href="https://yoursite.azurewebsites.net/challenge">https://yoursite.azurewebsites.net/challenge</a> になっているので、今回 now.sh 上に構築したエンドポイントに変更。</p>
<p>この並びに WebAuthn の Assertion と Attestation 他の API もついでに編集しておく。</p>
<p>蛇足ですが、サンプルの FIDO サーバーが古いので、バックエンドの API が /credentials と /assertion になっているが、今なら <a target="_blank" rel="noopener" href="https://fidoalliance.org/specs/fido-v2.0-rd-20180702/fido-server-v2.0-rd-20180702.html">Server Requirements and Transport Binding Profile</a> に準拠するようにエンドポイント名は編集したほうがいいだろう。</p>
<p>となると XML 部分も直さないといけないし、そもそも B2C で引き回せるクレームとしてどの程度のデータ量が行けるかはよくわかってない。<br>やっぱ普通にサーバーへの認証部分は外部に丸投げしてしまって、ユーザー ID と Authenticator のレスポンスぐらい投げたら True, False が返ってくるぐらい外部のサーバーを作りこんどいたほうが取り回しは楽そう。</p>
<p>まああくまでサンプルです。</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TechnicalProfile</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>REST-FIDOMakeCredential<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DisplayName</span><span class="token punctuation">></span></span>GET a FIDO Challenge<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DisplayName</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Protocol</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Proprietary<span class="token punctuation">"</span></span> <span class="token attr-name">Handler</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version<span class="token punctuation">=</span>1.0.0.0, Culture<span class="token punctuation">=</span>neutral, PublicKeyToken<span class="token punctuation">=</span>null<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Metadata</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ServiceUrl<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>https://yoursite.azurewebsites.net/credentials<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AuthenticationType<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>None<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SendClaimsIn<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Body<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>
    <span class="token comment" spellcheck="true">&lt;!-- Remove in Production--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AllowInsecureAuthInProduction<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Metadata</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaims</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>extension_fido_rawId<span class="token punctuation">"</span></span> <span class="token attr-name">PartnerClaimType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>clientDataJSON<span class="token punctuation">"</span></span> <span class="token attr-name">PartnerClaimType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>clientDataJSON<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>attestationObject<span class="token punctuation">"</span></span> <span class="token attr-name">PartnerClaimType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>attestationObject<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>InputClaims</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaims</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fido_publicKeyJwk<span class="token punctuation">"</span></span> <span class="token attr-name">PartnerClaimType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>publicKeyJwk<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>extension_fido_publicKeyJwk1<span class="token punctuation">"</span></span> <span class="token attr-name">PartnerClaimType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>publicKeyJwk1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>extension_fido_publicKeyJwk2<span class="token punctuation">"</span></span> <span class="token attr-name">PartnerClaimType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>publicKeyJwk2<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OutputClaims</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UseTechnicalProfileForSessionManagement</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SM-Noop<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TechnicalProfile</span><span class="token punctuation">></span></span>
</code></pre>
<p>これは、登録時に Authenticator のデータを送信すると、デコードして公開鍵を返すコード。<br>ちなみに Attestation は取得しているものの、保存も検証もしていないので悪しからず。</p>
<p>なぜ publicKeyJwk1 と publicKeyJwk2 があるのかというと、先ほど作成した Azure AD の拡張属性に格納できるデータが 245 文字までなので、長い公開鍵は分割しているからｗ</p>
<p>ちなみに対応する API はこちら。</p>
<pre class=" language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/credentials'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> credential <span class="token operator">=</span> <span class="token keyword">await</span> fido<span class="token punctuation">.</span><span class="token function">makeCredential</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> publicKeyJwkStr <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>credential<span class="token punctuation">.</span>publicKeyJwk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> publicKeyJwk1 <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> publicKeyJwk2 <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>publicKeyJwkStr<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">245</span> <span class="token punctuation">)</span>
        <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            publicKeyJwk1 <span class="token operator">=</span> publicKeyJwkStr<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">245</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            publicKeyJwk2 <span class="token operator">=</span> publicKeyJwkStr<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">245</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
        <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            publicKeyJwk1 <span class="token operator">=</span> publicKeyJwkStr<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            publicKeyJwk<span class="token punctuation">:</span> publicKeyJwkStr<span class="token punctuation">,</span>
            publicKeyJwk1<span class="token punctuation">:</span> publicKeyJwk1<span class="token punctuation">,</span>
            publicKeyJwk2<span class="token punctuation">:</span> publicKeyJwk2
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">409</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> version<span class="token punctuation">:</span> <span class="token string">"1.0"</span><span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token number">409</span><span class="token punctuation">,</span> userMessage<span class="token punctuation">:</span> <span class="token string">'ERROR: '</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>message <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>直観的ではないが、InputCalim が Azure AD B2C から送信するデータで、OutputClaim が API から返されるデータ。</p>
<p>認証するほうも直しておく。</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TechnicalProfile</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>REST-FIDOAssertion<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DisplayName</span><span class="token punctuation">></span></span>GET a FIDO Challenge<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DisplayName</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Protocol</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Proprietary<span class="token punctuation">"</span></span> <span class="token attr-name">Handler</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version<span class="token punctuation">=</span>1.0.0.0, Culture<span class="token punctuation">=</span>neutral, PublicKeyToken<span class="token punctuation">=</span>null<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Metadata</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ServiceUrl<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>https://yoursite.azurewebsites.net/assertion<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AuthenticationType<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>None<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SendClaimsIn<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Body<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>
    <span class="token comment" spellcheck="true">&lt;!-- Remove in Production--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AllowInsecureAuthInProduction<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Metadata</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaims</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>extension_fido_rawId<span class="token punctuation">"</span></span> <span class="token attr-name">PartnerClaimType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>clientDataJSON<span class="token punctuation">"</span></span>  <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userHandle<span class="token punctuation">"</span></span>  <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>signature<span class="token punctuation">"</span></span>  <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>authenticatorData<span class="token punctuation">"</span></span>  <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>extension_fido_publicKeyJwk1<span class="token punctuation">"</span></span> <span class="token attr-name">PartnerClaimType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>publicKeyJwk1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>extension_fido_publicKeyJwk2<span class="token punctuation">"</span></span> <span class="token attr-name">PartnerClaimType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>publicKeyJwk2<span class="token punctuation">"</span></span> <span class="token attr-name">DefaultValue</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>InputClaims</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UseTechnicalProfileForSessionManagement</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SM-Noop<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TechnicalProfile</span><span class="token punctuation">></span></span>
</code></pre>
<p>さっきからちろちろある <code>Remove in Production</code> の警告は、API の認証を無視する設定。<br>本番環境では、ベーシック認証、できれば <strong>証明書認証で API を保護してください。</strong></p>
<p>API を叩く部分を書いたら、次は step 6.</p>
<p>そろそろ気持ち悪くなってきましたね。ぼくもです。</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationStep</span> <span class="token attr-name">Order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>6<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ClaimsExchange<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchanges</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchange</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SelfAsserted-Enrollment<span class="token punctuation">"</span></span> <span class="token attr-name">TechnicalProfileReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SelfAsserted-FIDOEnrollment<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ClaimsExchanges</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OrchestrationStep</span><span class="token punctuation">></span></span>
</code></pre>
<p><code>SelfAsserted-FIDOEnrollment</code> を XML で探してみると、さっきと同じ TechnicalProfile タグだけど、 </p>
<p>Handler に <code>Handler=&quot;Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null&quot;</code> とあるので、これは Web ページを表示する部分ですね!?</p>
<p>さっきと同じく、直観的ではないですが OutputClaim が、外部からの入力、今回はユーザーが入力する項目です。<br>実際には Web のテンプレートに、OutputClaim と同じ form が追加され、ユーザーの入力を促します。</p>
<p>が、今回は WebAuthn のキーでのサインインなので、js で credentials.create したデータを form にいい感じに突っ込みます。</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TechnicalProfile</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SelfAsserted-FIDOEnrollment<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DisplayName</span><span class="token punctuation">></span></span>Welcome to FIDO enrollment<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DisplayName</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Protocol</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Proprietary<span class="token punctuation">"</span></span> <span class="token attr-name">Handler</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version<span class="token punctuation">=</span>1.0.0.0, Culture<span class="token punctuation">=</span>neutral, PublicKeyToken<span class="token punctuation">=</span>null<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Metadata</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ContentDefinitionReferenceId<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>api.selfasserted.fido<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Metadata</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaimsTransformations</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaimsTransformation</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>CopyEmailAddress<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaimsTransformation</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>CopyDisplayName<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaimsTransformation</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>FIDOEnrollmentCreateRegistrationMessage<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>InputClaimsTransformations</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaims</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userMessage<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>readOnlyName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>readOnlyDisplayName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>objectId<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>challenge<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>InputClaims</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaims</span><span class="token punctuation">></span></span>
    <span class="token comment" spellcheck="true">&lt;!--Sample: Read only claims to present to be sent the authenticator--></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userMessage<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>readOnlyName<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>readOnlyDisplayName<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>objectId<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>challenge<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>

    <span class="token comment" spellcheck="true">&lt;!--Sample: Claims return from the authenticator --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>extension_fido_rawId<span class="token punctuation">"</span></span>  <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>clientDataJSON<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>attestationObject<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>

    <span class="token comment" spellcheck="true">&lt;!--Sample: Bubble up claims from the validation technical profile--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fido_publicKeyJwk<span class="token punctuation">"</span></span>  <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>extension_fido_publicKeyJwk1<span class="token punctuation">"</span></span>  <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>extension_fido_publicKeyJwk2<span class="token punctuation">"</span></span>  <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OutputClaims</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ValidationTechnicalProfiles</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ValidationTechnicalProfile</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>REST-FIDOMakeCredential<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ValidationTechnicalProfiles</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UseTechnicalProfileForSessionManagement</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SM-Noop<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TechnicalProfile</span><span class="token punctuation">></span></span>
</code></pre>
<p>どうやって突っ込んでるの? ってところは、さっき上げた HTML のテンプレート内を見れば分かる。<br>XML に突っ込む部分は <code>ContentDefinitionReferenceId</code> の <code>api.selfasserted.fido</code> にある、LoadUri の定義部分を確認。</p>
<pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!--Sample: FIDO self-asserted HTML page--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ContentDefinition</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>api.selfasserted.fido<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LoadUri</span><span class="token punctuation">></span></span>https://yourtenant.blob.core.windows.net/azure-ad-b2c/fido/self-asserted.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LoadUri</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RecoveryUri</span><span class="token punctuation">></span></span>~/common/default_page_error.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RecoveryUri</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DataUri</span><span class="token punctuation">></span></span>urn:com:microsoft:aad:b2c:elements:contract:selfasserted:1.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DataUri</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ContentDefinition</span><span class="token punctuation">></span></span>
`
</code></pre>
<p>html 内の javascript の当該のコードはこちら。<br>いつもの credentials.get コマンドの終了後に、HTML のフォームに戻り値を突っ込んでます。<br>B2C はフォームを返してしか値を取れないのだ…。</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createCredential</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"createCredential started"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>PublicKeyCredential <span class="token operator">||</span> <span class="token keyword">typeof</span> PublicKeyCredential<span class="token punctuation">.</span>isUserVerifyingPlatformAuthenticatorAvailable <span class="token operator">!==</span> <span class="token string">"function"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">"WebAuthn APIs are not available on this user agent."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> attachment <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"input[name='attachment']:checked"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> createCredentialOptions <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        rp<span class="token punctuation">:</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            name<span class="token punctuation">:</span> <span class="token string">"WebAuthn Sample App"</span><span class="token punctuation">,</span>
            icon<span class="token punctuation">:</span> <span class="token string">"https://example.com/rpIcon.png"</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span>
        user<span class="token punctuation">:</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            id<span class="token punctuation">:</span> <span class="token function">stringToArrayBuffer</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#objectId"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            name<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#readOnlyName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            displayName<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#readOnlyDisplayName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            icon<span class="token punctuation">:</span> <span class="token string">"https://example.com/userIcon.png"</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span>
        pubKeyCredParams<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//External authenticators support the ES256 algorithm</span>
                type<span class="token punctuation">:</span> <span class="token string">"public-key"</span><span class="token punctuation">,</span>
                alg<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">7</span>                 
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span> 
            <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//Windows Hello supports the RS256 algorithm</span>
                type<span class="token punctuation">:</span> <span class="token string">"public-key"</span><span class="token punctuation">,</span>
                alg<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">257</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        authenticatorSelection<span class="token punctuation">:</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//Select authenticators that support username-less flows</span>
            requireResidentKey<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">//Select authenticators that have a second factor (e.g. PIN, Bio)</span>
            userVerification<span class="token punctuation">:</span> <span class="token string">"required"</span><span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">//Selects between bound or detachable authenticators</span>
            authenticatorAttachment<span class="token punctuation">:</span> attachment
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">//Since Edge shows UI, it is better to select larger timeout values</span>
        timeout<span class="token punctuation">:</span> <span class="token number">50000</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">//an opaque challenge that the authenticator signs over</span>
        challenge<span class="token punctuation">:</span>  <span class="token function">stringToArrayBuffer</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#challenge"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">//prevent re-registration by specifying existing credentials here</span>
        excludeCredentials<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">//specifies whether you need an attestation statement</span>
        attestation<span class="token punctuation">:</span> <span class="token string">"none"</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> navigator<span class="token punctuation">.</span>credentials<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        publicKey<span class="token punctuation">:</span> createCredentialOptions
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>rawAttestation <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#extension_fido_rawId"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token function">base64encode</span><span class="token punctuation">(</span>rawAttestation<span class="token punctuation">.</span>rawId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#clientDataJSON"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token function">base64encode</span><span class="token punctuation">(</span>rawAttestation<span class="token punctuation">.</span>response<span class="token punctuation">.</span>clientDataJSON<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#attestationObject"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token function">base64encode</span><span class="token punctuation">(</span>rawAttestation<span class="token punctuation">.</span>response<span class="token punctuation">.</span>attestationObject<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">"credentialId"</span><span class="token punctuation">,</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#extension_fido_rawId"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#status"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">"Successfully created credential with ID: "</span> <span class="token operator">+</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#extension_fido_rawId"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDebug<span class="token punctuation">)</span>
            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"#continue"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>と、いうことで、ココの URI をさっき Gist に上げた URI に変更しておく。並びもついでに修正。</p>
<p><a target="_blank" rel="noopener" href="https://gist.githubusercontent.com/watahani/f94a8362a4cc075a67254eb403c9c1c7/raw/e83697aa603d0c11b78d9f503b4885ac84695601/self-asserted.html">https://gist.githubusercontent.com/watahani/f94a8362a4cc075a67254eb403c9c1c7/raw/e83697aa603d0c11b78d9f503b4885ac84695601/self-asserted.html</a></p>
<pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!--Sample: FIDO welcome self-asserted HTML page--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ContentDefinition</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>api.selfasserted.fido.welcome<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LoadUri</span><span class="token punctuation">></span></span>https://gist.githubusercontent.com/watahani/a49bec0c38ad1e2540b829ee4121d8ba/raw/dc5eaa4c36b80459980eae312861fac7339b269c/welcome.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LoadUri</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RecoveryUri</span><span class="token punctuation">></span></span>~/common/default_page_error.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RecoveryUri</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DataUri</span><span class="token punctuation">></span></span>urn:com:microsoft:aad:b2c:elements:contract:selfasserted:1.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DataUri</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ContentDefinition</span><span class="token punctuation">></span></span>
</code></pre>
<p>いよいよアタマが痛くなってきましたが、最後です。<br>step 7 の <code>AAD-UserWriteFidoUsingObjectId</code> を確認する。</p>
<pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!--Sample: FIDO enrollment persist data--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationStep</span> <span class="token attr-name">Order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>7<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ClaimsExchange<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchanges</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClaimsExchange</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AAD-UserWriteFidoUsingObjectId<span class="token punctuation">"</span></span> <span class="token attr-name">TechnicalProfileReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AAD-UserWriteFidoUsingObjectId<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ClaimsExchanges</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OrchestrationStep</span><span class="token punctuation">></span></span>
</code></pre>
<p>はい、そろそろ見慣れてきた TechnicalProfile ですが、Protocol がない。<br>代わりに IncludeTechnicalProfile があるのでそちらを見てみると…</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TechnicalProfile</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AAD-UserWriteFidoUsingObjectId<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Metadata</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Operation<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Write<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>RaiseErrorIfClaimsPrincipalAlreadyExists<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>RaiseErrorIfClaimsPrincipalDoesNotExist<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Metadata</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>IncludeInSso</span><span class="token punctuation">></span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>IncludeInSso</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaims</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>InputClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>objectId<span class="token punctuation">"</span></span> <span class="token attr-name">Required</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>InputClaims</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PersistedClaims</span><span class="token punctuation">></span></span>
    <span class="token comment" spellcheck="true">&lt;!-- Required claims --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PersistedClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>objectId<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>

    <span class="token comment" spellcheck="true">&lt;!-- Sample: Writ FIDO claims to the user account --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PersistedClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>extension_fido_publicKeyJwk1<span class="token punctuation">"</span></span> <span class="token attr-name">DefaultValue</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PersistedClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>extension_fido_publicKeyJwk2<span class="token punctuation">"</span></span> <span class="token attr-name">DefaultValue</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PersistedClaim</span> <span class="token attr-name">ClaimTypeReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>extension_fido_rawId<span class="token punctuation">"</span></span> <span class="token attr-name">DefaultValue</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PersistedClaims</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>IncludeTechnicalProfile</span> <span class="token attr-name">ReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AAD-Common<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TechnicalProfile</span><span class="token punctuation">></span></span>
</code></pre>
<p>AAD-Common の TechnicalProfile を見ると、先ほど作成したアプリの Object ID と Client ID (アプリケーション ID) を入れるところがある!<br>そう、ココが拡張属性を書き込むアプリが定義されている部分。</p>
<p>ということで、さっき作成したアプリの Client ID と Object ID を突っ込む。</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TechnicalProfile</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AAD-Common<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DisplayName</span><span class="token punctuation">></span></span>Azure Active Directory<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DisplayName</span><span class="token punctuation">></span></span>
  <span class="token comment" spellcheck="true">&lt;!--  Sample: Provide objectId and appId before using extension properties.
        For more information: https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-create-custom-attributes-profile-edit-custom 
        Action required: Insert objectId and appId here --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Metadata</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ApplicationObjectId<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>オブジェクト ID<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Item</span> <span class="token attr-name">Key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ClientId<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>アプリケーション ID<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Item</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Metadata</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TechnicalProfile</span><span class="token punctuation">></span></span>
</code></pre>
<p>XML の編集は以上で終了。</p>
<p>最後の step 8 はシンプルです。</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OrchestrationStep</span> <span class="token attr-name">Order</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>8<span class="token punctuation">"</span></span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SendClaims<span class="token punctuation">"</span></span> <span class="token attr-name">CpimIssuerTechnicalProfileReferenceId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>JwtIssuer<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
</code></pre>
<p>ここまで集めた Claims を Jwt 形式にして sign してアプリに送信するだけ。</p>
<p>諸々飛ばしたところはありますが、ひとまず XML の作成は完了したので B2C にポリシーをアップしよう。<br>アップできなければエラーメッセージを確認し、頑張って直してください…。</p>
<p>さて、ここまでやり遂げたあなたなら、先ほどの図も理解できるはずですね。</p>
<p><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/b2ccomponent.png" alt=""></p>
<p>素晴らしい！ XML が世界を回していることを実感しますね!?</p>
<h2 id="動作確認"><a href="#動作確認" class="headerlink" title="動作確認"></a>動作確認</h2><p>最後に動作確認をして、実際の動きを確かめてみる。</p>
<h3 id="レジストレーション-フロー"><a href="#レジストレーション-フロー" class="headerlink" title="レジストレーション フロー"></a>レジストレーション フロー</h3><p>Authenticator の登録には、既存の資格情報 (ここではパスワード) を入力する。<br>実際に運用するなら、MFA を突破した後のほうがいいけど、これ以上 XML は弄りたくないので。</p>
<p>登録の前には、再度資格情報が必要という警告を表示して</p>
<p><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_01.png" alt=""></p>
<p>資格情報を入れて<br><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_02.png" alt=""></p>
<p>Platform Authenticator か Cross-Platform Authenticator かを選ぶ。<br>今回は SoloKey を使うので Cross-Platform Authenticator。</p>
<p><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_03.png" alt=""></p>
<p>Attestation 要求しているので警告がでて、いつもの。</p>
<p><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_04.png" alt=""></p>
<p>id_token が発行される。</p>
<p><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_05.png" alt=""></p>
<h3 id="サインイン-フロー"><a href="#サインイン-フロー" class="headerlink" title="サインイン フロー"></a>サインイン フロー</h3><p>サインインの際は、FIDO ボタンをクリックして</p>
<p><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_06.png" alt=""></p>
<p>Authenticate ボタンで js が呼ばれて<br><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_07.png" alt=""></p>
<p>い つ も の<br><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_08.png" alt=""></p>
<p>id_token が発行される。<br><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_09.png" alt=""></p>
<p>Debug ボタンで hidden 状態の form を表示することができる。<br><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/b2c_10.png" alt=""></p>
<p>WebAuthn の公開鍵についてはユーザーの拡張属性に保存されている。<br>なんでか Azure AD B2C テナントは Microsoft Graph API をサポートしていない (使えるけど) ので、Azure AD Graph を叩いて確認する。</p>
<p>サインインしたユーザー情報を取得すると、確かに公開鍵が保存されている。</p>
<ul>
<li>Azure AD Graph Explorer<br><a target="_blank" rel="noopener" href="https://graphexplorer.azurewebsites.net/#">https://graphexplorer.azurewebsites.net/#</a></li>
</ul>
<p><img src="/2019/12/06/azuread-b2c-fido2-custompolicy/extensionsvalue.png" alt=""></p>
<h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>今回は Azure AD B2C に FIDO2 を組み込むサンプルを動かしてみた。<br>XML を読み解くのは果てしなくつらい作業だったが、動いているのを見るといとおしく感じてくるから不思議である。</p>
<p>ここまで色々いじれ (てしまえ) る OP は中々なく、XML のつながりを辿るのは果てしなくつらい作業だが、クレームの変換や検証、Azure AD への書き込みや読み込みなど、非常にプリミティブな動作をなんとなく体験できる面白いオモチャなので、興味がある人は触ってみてほしい。</p>
<p>ただ、XML を弄るのは果てしなくつらい作業なので、私はしばらく見たくない。以上。</p>
<p>明日の Advent Calendar は <a target="_blank" rel="noopener" href="https://twitter.com/@kishisuke">@kishisuke</a> の Sign In with Apple です。</p>
<p>そういえば、誰かが Sign In Apple も Azure AD B2C につないでましたね。</p>
<div class="related-post"><h3>関連記事</h3><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2020\06\02\aad-spa-auth-code-grant-with-pkce\" title="Azure AD の SPA 向け Authorize Code Flow with PKCE (MSAL.js 2.x)" rel="bookmark">Azure AD の SPA 向け Authorize Code Flow with PKCE (MSAL.js 2.x)</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2019\07\15\azuread-fido2-security-key-public-preview\" title="Azure AD の FIDO2 Security Key 対応のパブリックプレビューが来たー" rel="bookmark">Azure AD の FIDO2 Security Key 対応のパブリックプレビューが来たー</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2023\04\26\do-not-validate-ms-graph-token\" title="Microsoft Graph API のトークンを検証しないでください" rel="bookmark">Microsoft Graph API のトークンを検証しないでください</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2021\04\24\get-aad-token-using-powershell\" title="Azure AD のトークンを PowerShell で取得する" rel="bookmark">Azure AD のトークンを PowerShell で取得する</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\2021\11\05\azure-portal-change-language\" title="Azure ポータルの言語をワンクリックで切り替える" rel="bookmark">Azure ポータルの言語をワンクリックで切り替える</a></h3></div></li></ul></div></div><div class="article-meta" style="max-width:800px"><div class="tags"><i class="icon icon-tag"></i><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure/" rel="tag">Azure</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FIDO2/" rel="tag">FIDO2</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OAuth/" rel="tag">OAuth</a><span class="tag-list-count">6</span></li></ul></div></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2020/02/16/customize-aad-token-claims/"><i class="icon icon-arror-left"></i></a></li><li><a href="/2019/11/24/ms-ignite-2019/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/82p" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="https://twitter.com/watahani" title="Twitter" target="_blank"><i class="icon icon-twitter"></i></a></li><li><a href="https://www.facebook.com/haniyama.wataru" title="Facebook" target="_blank"><i class="icon icon-facebook"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2023 enjoy struggling<br><small>POWER BY <a href="https://hexo.io" target="_blank">HEXO</a></small><small>, THEME BY <a href="https://github.com/BoizZ/hexo-theme-laughing" target="_blank">LAUGHING</a></small></p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>