<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description" content="ä»¥å‰è²·ã£ãŸãƒŸãƒ‹ PC ã‚’è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ã«ã—ã‚ˆã†ã¨ã—ã¦ã„ãŸã®ã ãŒã€ã¾ã£ãŸãæ™‚é–“ãŒç„¡ãã¦æ”¾ç½®ã—ã¦ã„ãŸã€‚è‚²ä¼‘ä¸­ã«å°‘ã—æ™‚é–“ãŒå–ã‚ŒãŸã®ã§ã€ã¨ã‚Šã‚ãˆãš Ubuntu ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ Nextcloud ã‚’å‹•ã‹ã—ã¦ã¿ãŸã€‚docker ã‚’ä½¿ã£ã¦æ§‹æˆã—ãŸãŒçµæ§‹ãƒãƒã£ãŸã®ã§ã€ãã®è¾ºã®ãƒ¡ãƒ¢ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="ä¹…ã—ã¶ã‚Šã«è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¦ã¦ Nextcloud ã‚’å‹•ã‹ã™">
<meta property="og:url" content="http://blog.haniyama.com/2024/02/15/home-server-nextcloud/index.html">
<meta property="og:site_name" content="enjoy struggling">
<meta property="og:description" content="ä»¥å‰è²·ã£ãŸãƒŸãƒ‹ PC ã‚’è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ã«ã—ã‚ˆã†ã¨ã—ã¦ã„ãŸã®ã ãŒã€ã¾ã£ãŸãæ™‚é–“ãŒç„¡ãã¦æ”¾ç½®ã—ã¦ã„ãŸã€‚è‚²ä¼‘ä¸­ã«å°‘ã—æ™‚é–“ãŒå–ã‚ŒãŸã®ã§ã€ã¨ã‚Šã‚ãˆãš Ubuntu ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ Nextcloud ã‚’å‹•ã‹ã—ã¦ã¿ãŸã€‚docker ã‚’ä½¿ã£ã¦æ§‹æˆã—ãŸãŒçµæ§‹ãƒãƒã£ãŸã®ã§ã€ãã®è¾ºã®ãƒ¡ãƒ¢ã€‚">
<meta property="og:locale">
<meta property="og:image" content="http://blog.haniyama.com/2024/02/15/home-server-nextcloud/docker-nginx-certbot-ddns/timechart.png">
<meta property="article:published_time" content="2024-02-15T03:00:00.000Z">
<meta property="article:modified_time" content="2024-02-15T02:55:58.453Z">
<meta property="article:author" content="watahani">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.haniyama.com/2024/02/15/home-server-nextcloud/docker-nginx-certbot-ddns/timechart.png">
<meta name="twitter:creator" content="@watahani"><meta name="description"><meta name="keywords" content="Java, Javascript, AWS, GCP, PGP"><link rel="alternate" type="application/atom+xml" href="/atom.xml" title="enjoy struggling"><title>ä¹…ã—ã¶ã‚Šã«è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¦ã¦ Nextcloud ã‚’å‹•ã‹ã™ - enjoy struggling</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.png"><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create', 'UA-113476970-1', 'auto');ga('send', 'pageview');</script><meta name="generator" content="Hexo 6.3.0"><link rel="stylesheet" href="/css/prism-atom-dark.css" type="text/css"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a target="_blank" rel="noopener" href="https://github.com/watahani"><span>Github</span></a></li><li><a target="_blank" rel="noopener" href="https://qiita.com/watahani"><span>Qiita</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><link rel="amphtml" href="./amp/index.html"><label class="navi-button light" for="navi">MENU</label><img class="background" src="https://storage.googleapis.com/blog-haniyama/background-min.png"><div class="post-title"><h1 class="title">ä¹…ã—ã¶ã‚Šã«è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¦ã¦ Nextcloud ã‚’å‹•ã‹ã™</h1><ul class="meta"><li><i class="icon icon-author"></i>watahani</li><li><i class="icon icon-clock"></i>39 Minutes</li><li><i class="icon icon-calendar"></i>February 15, 2024</li></ul></div></div><div class="article-content" style="max-width:800px"><p>ä»¥å‰è²·ã£ãŸãƒŸãƒ‹ PC ã‚’è‡ªå®…ã‚µãƒ¼ãƒãƒ¼ã«ã—ã‚ˆã†ã¨ã—ã¦ã„ãŸã®ã ãŒã€ã¾ã£ãŸãæ™‚é–“ãŒç„¡ãã¦æ”¾ç½®ã—ã¦ã„ãŸã€‚è‚²ä¼‘ä¸­ã«å°‘ã—æ™‚é–“ãŒå–ã‚ŒãŸã®ã§ã€ã¨ã‚Šã‚ãˆãš Ubuntu ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ Nextcloud ã‚’å‹•ã‹ã—ã¦ã¿ãŸã€‚docker ã‚’ä½¿ã£ã¦æ§‹æˆã—ãŸãŒçµæ§‹ãƒãƒã£ãŸã®ã§ã€ãã®è¾ºã®ãƒ¡ãƒ¢ã€‚</p>
<span id="more"></span>
<h2 id="ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆã«ã¤ã„ã¦"><a href="#ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆã«ã¤ã„ã¦" class="headerlink" title="ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆã«ã¤ã„ã¦"></a>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆã«ã¤ã„ã¦</h2><p>IIJMio ã²ã‹ã‚Šã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ã€æ™®æ®µã¯ DS-Lite IPv4 over IPv6 ã§ã®é€šä¿¡ã‚’ã—ã¦ã„ã‚‹ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¯è©³ã—ããªã„ãŒã€DS-Lite ã§ã¯è¤‡æ•°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒä¸€ã® IPv4 ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…±æœ‰ã™ã‚‹ã“ã¨ã«ãªã‚‹ã®ã§ã€ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ãŒã§ããªã„ã€‚</p>
<p>å½“åˆã¯ IPv4 ã§ã®å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ã¨ DS-Lite ã®ä¸¡ç«‹ã‚’ç›®æŒ‡ã—ãŸãŒå®Ÿéš›ã« PPPoE æ¥ç¶šã‚’è©¦ã—ãŸã¨ã“ã‚ã€æ—¥ä¸­ã‚„å¤•æ–¹ã®æ··é›‘éšŠã§ã‚‚ DS-Lite ã¨éœè‰²ãŒãªã„ã“ã¨ãŒåˆ†ã‹ã£ãŸã€‚ã¨ã„ã†ã“ã¨ã§ã€PPPoE ã§æ™®é€šã«ãƒ«ãƒ¼ã‚¿ãƒ¼ã§ NAT ã™ã‚‹ã€‚</p>
<p>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒé…ã„ã¨æ„Ÿã˜ãŸã‚‰ãã®æ™‚ã«å‹‰å¼·ã—ã¾ã™ã€‚ä¸€èˆ¬ã®ã”å®¶åº­ãªã®ã§â€¦ã€‚</p>
<p>é€Ÿåº¦æ¸¬å®šã¯ <a target="_blank" rel="noopener" href="https://www.speedtest.net/ja/apps/cli">speedtest-cli</a> ã§è¡Œã£ãŸã€‚</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> curl
curl -s https://packagecloud.io/install/repositories/ookla/speedtest-cli/script.deb.sh <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">bash</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> speedtest
</code></pre>
<p>cron ã§å®šæœŸçš„ã«æ¸¬å®šã™ã‚‹ã‚ˆã†ã«ã—ãŸã®ã ãŒã€sppedtest ã‚³ãƒãƒ³ãƒ‰ã ã‘ã§ã¯æ—¥ä»˜ãŒå‡ºãªã„ã®ã§ã€3æ—¥ãã‚‰ã„ç„¡é§„ã«ã—ãŸã€‚ã‚ã‚‰ã‹ã˜ã‚é©å½“ã«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ ã—ã¦ãŠãã“ã¨ã€‚</p>
<pre class=" language-cron"><code class="language-cron">24  *   *   *   *   now=\"$(date +"\%Y-\%m-\%d \%H:\%M:\%S")\",; /usr/bin/speedtest -f csv -s 48463 | sed "s/^/$now/" >> /home/user/speedtest.csv
</code></pre>
<p>jupyter notebook ã§ pandas ã§èª­ã¿è¾¼ã‚“ã§ã‚°ãƒ©ãƒ•åŒ–ã€‚ã“ã†ã„ã†ã®ã¯ Copilot Chat ã«èã‘ã°å‹æ‰‹ã«ã‚„ã£ã¦ãã‚Œã‚‹ã®ã§å¬‰ã—ã„ã€‚</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt

<span class="token comment" spellcheck="true"># Load the CSV file</span>
data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'speedtest.csv'</span><span class="token punctuation">)</span>

data<span class="token punctuation">[</span><span class="token string">'download Mbps'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'download'</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">125000</span>
data<span class="token punctuation">[</span><span class="token string">'upload Mbps'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'upload'</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">125000</span>
<span class="token comment" spellcheck="true"># Assuming 'time' is the column with time information</span>
data<span class="token punctuation">[</span><span class="token string">'time jst'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'datetime utc'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dt<span class="token punctuation">.</span>tz_localize<span class="token punctuation">(</span><span class="token string">'UTC'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>dt<span class="token punctuation">.</span>tz_convert<span class="token punctuation">(</span><span class="token string">'Asia/Tokyo'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Extract hour from time</span>
data<span class="token punctuation">[</span><span class="token string">'hour'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'time jst'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dt<span class="token punctuation">.</span>hour

<span class="token comment" spellcheck="true"># Set 'time jst' as the index of the DataFrame</span>
data<span class="token punctuation">.</span>set_index<span class="token punctuation">(</span><span class="token string">'time jst'</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Plot 'download Mbps' and 'upload Mbps' over time</span>
data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'download Mbps'</span><span class="token punctuation">,</span> <span class="token string">'upload Mbps'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Show the plot</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># Group by hour and calculate mean download speed</span>
average_speed_by_hour <span class="token operator">=</span> data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'hour'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'download Mbps'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Plot the average download speed by hour</span>
average_speed_by_hour<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="./docker-nginx-certbot-ddns/timechart.png" alt=""></p>
<p>é…ã„ã¨ãã§ã‚‚ä¸Šä¸‹ 500Mbps ãã‚‰ã„å‡ºã¦ã„ã‚‹ã®ã§ã€ç‰¹ã«å•é¡Œã¯ãªã•ãã†ã ã€‚</p>
<h2 id="Ubuntu-20-04-ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹-Docker-ãŒå¤ã„"><a href="#Ubuntu-20-04-ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹-Docker-ãŒå¤ã„" class="headerlink" title="Ubuntu 20.04 ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ Docker ãŒå¤ã„"></a>Ubuntu 20.04 ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ Docker ãŒå¤ã„</h2><p>Ubuntu 20.04 ã®åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­ã«è‰²ã€…ã¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒã§ãã‚‹ã®ã ãŒã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã« snap ãŒæ¡ç”¨ã•ã‚Œã¦ã„ã‚‹ã€‚snap ã§ Docker ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨ã€æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ãªã„å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã—ã¾ã†ã€‚</p>
<p>ã‚ã¾ã‚Šå•é¡Œã«ãªã‚‹ã“ã¨ã¯ãªã„ã¨æ€ã†ãŒã€ç§ã®ç’°å¢ƒã§ã¯ä»¥ä¸‹ã®ãƒã‚°ã‚’è¸ã‚“ã§ã—ã¾ã„ docker compose exec ãŒä½¿ãˆãªããªã£ã¦ã—ã¾ã£ãŸã€‚</p>
<p><a target="_blank" rel="noopener" href="https://github.com/docker/compose/issues/11154">[BUG] docker-compose http: invalid Host header Â· Issue #11154 Â· docker/compose</a></p>
<p><code>sudo snap refresh docker --channel=latest/edge</code> ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°ã§ãã‚‹ã‚‰ã—ã„ãŒã€ãã®æƒ…å ±ã‚’è¦‹ã¤ã‘ã‚‹å‰ã« snap ã® docker ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã€å…¬å¼ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã‚’å‚è€ƒã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ç›´ã—ã¦ã—ã¾ã£ãŸã€‚</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> aa-remove-unknown
snap list 
<span class="token function">sudo</span> snap remove docker

<span class="token comment" spellcheck="true"># å†èµ·å‹•å¾Œ Docker å…¬å¼ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã‚’å®Ÿæ–½</span>
</code></pre>
<h2 id="Nextcloud-ã‚’-Docker-ã§å‹•ã‹ã™"><a href="#Nextcloud-ã‚’-Docker-ã§å‹•ã‹ã™" class="headerlink" title="Nextcloud ã‚’ Docker ã§å‹•ã‹ã™"></a>Nextcloud ã‚’ Docker ã§å‹•ã‹ã™</h2><p>ã‚°ã‚°ã‚Œã°è‰²ã€…è¨˜äº‹ãŒã‚ã‚‹ãŒã€<a target="_blank" rel="noopener" href="https://github.com/nextcloud/all-in-one">Nextcloud All-in-One</a> (Nextcloud AIO) ã‚’åˆ©ç”¨ã™ã‚‹ã‹ snap ã§ãƒ›ã‚¹ãƒˆã«ç›´æ¥ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã®ãŒä¸€ç•ªæ¥½ãã†ã ã£ãŸã€‚ç‰¹ã« AIO ç‰ˆã¯æ©Ÿèƒ½ãƒ¢ãƒªãƒ¢ãƒªã§ä¾¿åˆ©ãªã®ã ãŒã€AIO è‡ªä½“ãŒ docker ã‚³ãƒ³ãƒ†ãƒŠã‚’è¤‡æ•°ç«‹ã¡ä¸Šã’ã‚‹ã‚ˆã†ãªã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã€é‡åšéãã‚‹ã®ã§ä»Šå›ã¯ãƒ‘ã‚¹ã€‚<br>ãã‚‚ãã‚‚ã€ãƒ•ãƒ­ãƒ³ãƒˆã« nginx-proxy ã‚’ç½®ã„ã¦æ¤œè¨¼ã‚¢ãƒ—ãƒªã‚’è‰²ã€…å‹•ã‹ã—ãŸã‹ã£ãŸãŸã‚ã€è‡ªåˆ†ã§ docker-compose.yml ã‚’æ›¸ãã“ã¨ã«ã—ãŸã€‚</p>
<h3 id="ngix-proxy"><a href="#ngix-proxy" class="headerlink" title="ngix-proxy"></a>ngix-proxy</h3><p><a target="_blank" rel="noopener" href="https://github.com/nginx-proxy/nginx-proxy">nginx-proxy</a> ã¯ docker.sock ã‚’ãƒã‚¦ãƒ³ãƒˆã—ã¦ã€èµ·å‹•ä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ç›£è¦–ã—ã¦è‡ªå‹•ã§ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã®è¨­å®šã‚’è¡Œã£ã¦ãã‚Œã‚‹ã€‚nginxproxy/acme-companion ã¯ nginx-proxy ãŒè¨­å®šã—ãŸãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã®è¨­å®šã‚’å…ƒã« Letâ€™s Encrypt ã®è¨¼æ˜æ›¸ã‚’è‡ªå‹•ã§å–å¾—ã—ã¦ãã‚Œã‚‹<br>ã‚ã‚‰ã‹ã˜ã‚ <code>docker network create proxy-network --subnet 172.18.0.0/16</code> ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ä½œæˆã—ã¦ãŠãã€‚ã‚µãƒ–ãƒãƒƒãƒˆã¯ Nextcloud ã® Trusted Proxy ã®ãŸã‚ã«å®šç¾©ã™ã‚‹ã€‚</p>
<pre class=" language-yml"><code class="language-yml">version: '3'

services:
  nginx-proxy:
    image: nginxproxy/nginx-proxy
    container_name: nginx-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - ./certs:/etc/nginx/certs:rw
      - ./vhost.d:/etc/nginx/vhost.d
      - ./html:/usr/share/nginx/html
      - ./custom-nginx.conf:/etc/nginx/conf.d/custom-nginx.conf:ro
    networks:
      proxy-network:
        ipv4_address: 172.18.0.2
    labels:
      - com.github.nginx-proxy.nginx-proxy.keepalive=auto

  letsencrypt:
    image: nginxproxy/acme-companion
    container_name: nginx-acme    
    depends_on:
      - nginx-proxy
    environment:
      - DEFAULT_EMAIL=$&#123;MAILADDRESS&#125;
      - NGINX_PROXY_CONTAINER=nginx-proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./certs:/etc/nginx/certs:rw
      - ./vhost.d:/etc/nginx/vhost.d
      - ./html:/usr/share/nginx/html
    networks:
      - proxy-network

  ddclient:
    image: lscr.io/linuxserver/ddclient:latest
    container_name: ddclient
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
    volumes:
      - ./ddclient_conf:/config
    restart: unless-stopped

networks:
  proxy-network:
    external: true
    driver: bridge
    ipam:
      config:
        - subnet: 172.18.0.0/16
</code></pre>
<p>ã‚¦ãƒã® IP ã¯å‹•çš„ã‚¢ãƒ‰ãƒ¬ã‚¹ãªã®ã§ã€ddclient ã§ DNS ã‚’æ›´æ–°ã™ã‚‹ã€‚CloudFlare ã®å ´åˆã¯ã“ã‚“ãªæ„Ÿã˜ã€‚CloudFlare ã® API ãƒˆãƒ¼ã‚¯ãƒ³ã¯ DNS Read, Write ã®æ¨©é™ã§ååˆ†ã ã£ãŸã€‚<br>ãªãŠã€ã‚ã‚‰ã‹ã˜ã‚ DNS ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒãªã„ã¨å‹•ä½œã—ãªã„ã®ã§ã€æ‰‹å‹•ã§ä½œæˆã—ã¦ãŠãã“ã¨ã€‚</p>
<pre class=" language-conf"><code class="language-conf"># Even though we use -foreground, daemon= is still needed.
# It's value here is ignored, but it's needed. The value used is set in
# ddclient.in in the dockerfile.
daemon=0
verbose=no
ssl=yes
use=web, web=he   # checkip.dns.he.net
protocol=cloudflare
login=token
password='yourtoken'
zone=example.com
dns1.example.com, dns2.example.com
</code></pre>
<p><code>/etc/nginx/vhost.d</code> ã«ãƒ›ã‚¹ãƒˆåã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ãã“ã¨ã§ã€å„ãƒ›ã‚¹ãƒˆã”ã¨ã«è¿½åŠ è¨­å®šãŒã§ãã‚‹ã€‚ä¾‹ãˆã° example.com å‘ã‘ã®è¨­å®šã‚’è¿½åŠ ã—ãŸã‘ã‚Œã° <code>/etc/nginx/vhost.d/example.com</code> ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã™ã‚‹ã€‚Nextcloud ã®ãƒ›ã‚¹ãƒˆåã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚„ Body ä¸Šé™ã®å¤‰æ›´ãªã©ã‚’ã—ã¦ãŠãã€‚</p>
<pre class=" language-ini"><code class="language-ini">send_timeout 300;
keepalive_timeout 300;
proxy_read_timeout 300;
proxy_connect_timeout 300;
proxy_send_timeout 300;
client_max_body_size 1G;
</code></pre>
<h3 id="Nextcloud-æœ¬ä½“"><a href="#Nextcloud-æœ¬ä½“" class="headerlink" title="Nextcloud æœ¬ä½“"></a>Nextcloud æœ¬ä½“</h3><p>ngix-proxy ã‚’ä½¿ã£ã¦ã„ã¦ nginx å´ã¯ã„ã˜ã‚ŠãŸããªã‹ã£ãŸã®ã§ã€apache ç‰ˆã‚’ <a target="_blank" rel="noopener" href="https://github.com/nextcloud/docker/blob/master/.examples/docker-compose/insecure/mariadb/apache/docker-compose.yml">å…¬å¼ã®ã‚µãƒ³ãƒ—ãƒ«</a> ã‚’ã‚‚ã¨ã«ä½œæˆã—ãŸã€‚<br>nginx-proxy ã® vhost.d/ ã«é ‘å¼µã£ã¦è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ã‘ã° nextcloud:fpm ç‰ˆã‚’è‰¯ã„æ„Ÿã˜ã«ä½¿ãˆãã†ã ã£ãŸã‘ã©ã€php ã«ã‚‚ nginx ã®è¨­å®šã‚‚è©³ã—ããªã„ã®ã§ã€ã¨ã‚Šã‚ãˆãš apache ç‰ˆã§ã€‚</p>
<p>å‡ºæ¥ä¸ŠãŒã£ãŸã®ãŒã“ã‚Œã€‚</p>
<pre class=" language-yml"><code class="language-yml">version: '3'

services:
  nextcloud:
    build: ./customimages/nextcloud
    container_name: nextcloud
    volumes:
      - nextcloud_data:/var/www/html
      # - ./config:/var/www/html/config # for debug
      - ./log/:/var/log/nextcloud/
      - ./skeleton/:/var/skeleton/
      - /mnt/hdd01/:/mnt/hdd01/
    env_file:
      - ./.env
      - ./env/db.env
      - ./env/nextcloud.env
    secrets:
      - nextcloud_admin_password
      - nextcloud_admin_user
      - mysql_password
      - mysql_user
      - mysql_database
      - smtp_password
    networks:
      - proxy-network
      - nextcloud-network
    depends_on:
      - db
      - redis
      - elasticsearch

  nextcloud-cron:
    build: ./customimages/nextcloud
    container_name: nextcloud-cron
    restart: unless-stopped
    env_file:
      - ./.env
      - ./env/db.env
      - ./env/nextcloud.env
    volumes:
      - nextcloud_data:/var/www/html
      # - ./config:/var/www/html/config # for debug
      - ./log/:/var/log/nextcloud/
      - ./skeleton/:/var/skeleton/
      - /mnt/hdd01/:/mnt/hdd01/
      # if customize cron file
      # https://help.nextcloud.com/t/docker-setup-cron/78547/5
      # https://github.com/nextcloud/docker/blob/ccdf46609ff8419ffd7c5ce4e51a117e378b72b6/Dockerfile-debian.template#L15
      # - ./mycronfile:/var/spool/cron/crontabs/www-data
    secrets:
      - nextcloud_admin_password
      - nextcloud_admin_user
      - mysql_password
      - mysql_user
      - mysql_database
      - smtp_password
    networks:
      - nextcloud-network
    entrypoint: /cron.sh
    depends_on:
      - nextcloud

  db:
    image: mariadb
    container_name: nextcloud-db
    volumes:
      - db_data:/var/lib/mysql
    env_file:
      - ./.env
      - ./env/db.env
    secrets:
      - mysql_database
      - mysql_password
      - mysql_user
      - mysql_root_password
    networks:
      - nextcloud-network

  redis:
    image: redis:6
    container_name: nextcloud_redis
    restart: always
    command: ["--databases", "1"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - redis_data:/data
    networks:
      - nextcloud-network

  elasticsearch:
    build: ./customimages/elasticsearch
    container_name: elasticsearch
    restart: always
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - xpack.security.enabled=false
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - nextcloud-network

secrets:
  nextcloud_admin_password:
    file: ./secrets/nextcloud_admin_password
  nextcloud_admin_user:
    file: ./secrets/nextcloud_admin_user
  mysql_password:
    file: ./secrets/mysql_password
  mysql_user:
    file: ./secrets/mysql_user
  mysql_database:
    file: ./secrets/mysql_database
  mysql_root_password:
    file: ./secrets/mysql_root_password
  smtp_password:
    file: ./secrets/smtp_password

volumes:
  nextcloud_data:
  db_data:
  redis_data:
  elasticsearch_data:

networks:
  proxy-network:
    external: true
    driver: bridge
    ipam:
      config:
        - subnet: 172.18.0.0/16
  nextcloud-network:
    driver: bridge

</code></pre>
<h3 id="ãƒã‚¤ãƒ³ãƒˆãƒ¡ãƒ¢"><a href="#ãƒã‚¤ãƒ³ãƒˆãƒ¡ãƒ¢" class="headerlink" title="ãƒã‚¤ãƒ³ãƒˆãƒ¡ãƒ¢"></a>ãƒã‚¤ãƒ³ãƒˆãƒ¡ãƒ¢</h3><p>Nextcloud æœ¬ä½“ã¯ nginx-proxy ã¨åŒä¸€ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«ãŠã„ã¦ã€ãã‚Œä»¥å¤–ã®ã‚³ãƒ³ãƒ†ãƒŠ nextcloud-network ã‚’ä½œæˆã—ã¦ãã“ã«é…ç½®ã—ãŸã€‚</p>
<h4 id="ç’°å¢ƒå¤‰æ•°"><a href="#ç’°å¢ƒå¤‰æ•°" class="headerlink" title="ç’°å¢ƒå¤‰æ•°"></a>ç’°å¢ƒå¤‰æ•°</h4><p>.env ãƒ•ã‚¡ã‚¤ãƒ«ãªã©ã®ä¸­èº«ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚</p>
<pre class=" language-ini"><code class="language-ini">#for nginx-proxy
<span class="token constant">VIRTUAL_HOST</span><span class="token attr-value"><span class="token punctuation">=</span>$&amp;#123;YOUR_DOMAIN&amp;#125;</span>
<span class="token constant">LETSENCRYPT_HOST</span><span class="token attr-value"><span class="token punctuation">=</span>$&amp;#123;YOUR_DOMAIN&amp;#125;</span>
<span class="token constant">LETSENCRYPT_EMAIL</span><span class="token attr-value"><span class="token punctuation">=</span>$&amp;#123;MAIL_ADDRESS&amp;#125;</span>
# trust nginx proxy
<span class="token constant">TRUSTED_PROXIES</span><span class="token attr-value"><span class="token punctuation">=</span>172.18.0.2/32</span>
<span class="token constant">OVERWRITEHOST</span><span class="token attr-value"><span class="token punctuation">=</span>$&amp;#123;YOUR_DOMAIN&amp;#125;</span>
<span class="token constant">OVERWRITEPROTOCOL</span><span class="token attr-value"><span class="token punctuation">=</span>https</span>
#admin password
<span class="token constant">NEXTCLOUD_ADMIN_PASSWORD_FILE</span><span class="token attr-value"><span class="token punctuation">=</span>/run/secrets/nextcloud_admin_password</span>
<span class="token constant">NEXTCLOUD_ADMIN_USER_FILE</span><span class="token attr-value"><span class="token punctuation">=</span>/run/secrets/nextcloud_admin_user</span>
<span class="token constant">NEXTCLOUD_TRUSTED_DOMAINS</span><span class="token attr-value"><span class="token punctuation">=</span>$&amp;#123;YOUR_DOMAIN&amp;#125;</span>

# redis settings
<span class="token constant">REDIS_HOST</span><span class="token attr-value"><span class="token punctuation">=</span>nextcloud_redis</span>

# smtp settings
<span class="token constant">SMTP_HOST</span><span class="token attr-value"><span class="token punctuation">=</span>smtp.sendgrid.net</span>
<span class="token constant">SMTP_NAME</span><span class="token attr-value"><span class="token punctuation">=</span>apikey</span>
<span class="token constant">SMTP_PASSWORD_FILE</span><span class="token attr-value"><span class="token punctuation">=</span>/run/secrets/smtp_password</span>
<span class="token constant">MAIL_FROM_ADDRESS</span><span class="token attr-value"><span class="token punctuation">=</span>noreply</span>
<span class="token constant">SMTP_SECURE</span><span class="token attr-value"><span class="token punctuation">=</span>tls</span>
<span class="token constant">SMTP_AUTHTYPE</span><span class="token attr-value"><span class="token punctuation">=</span>LOGIN</span>
<span class="token constant">MAIL_DOMAIN</span><span class="token attr-value"><span class="token punctuation">=</span>$&amp;#123;MAIL_DOMAIN&amp;#125;</span>
# other settings
<span class="token constant">PHP_UPLOAD_LIMIT</span><span class="token attr-value"><span class="token punctuation">=</span>10G</span>
<span class="token constant">NC_default_phone_region</span><span class="token attr-value"><span class="token punctuation">=</span>JP</span>
<span class="token constant">NC_logtype</span><span class="token attr-value"><span class="token punctuation">=</span>file</span>
<span class="token constant">NC_logfile</span><span class="token attr-value"><span class="token punctuation">=</span>/var/log/nextcloud/nextcloud.log</span>
<span class="token constant">NC_loglevel</span><span class="token attr-value"><span class="token punctuation">=</span>0</span>
<span class="token constant">NC_default_language</span><span class="token attr-value"><span class="token punctuation">=</span>ja</span>
<span class="token constant">NC_default_locale</span><span class="token attr-value"><span class="token punctuation">=</span>ja_JP</span>
<span class="token constant">NC_default_timezone</span><span class="token attr-value"><span class="token punctuation">=</span>Asia/Tokyo</span>
<span class="token constant">NC_skeletondirectory</span><span class="token attr-value"><span class="token punctuation">=</span>/var/skeleton/</span>
<span class="token constant">NC_maintenance_window_start</span><span class="token attr-value"><span class="token punctuation">=</span>16</span>
</code></pre>
<p>NC_ ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒã¤ãç’°å¢ƒå¤‰æ•°ã¯ config.php ã®è¨­å®šã‚’ä¸Šæ›¸ãã™ã‚‹ã€‚ç’°å¢ƒå¤‰æ•°å«ã‚ config.php ã«ç›´æ¥æ›¸ãè¾¼ã‚€ã®ã§ã¯ãªãã€å€¤ã‚’ç„¡è¦–ã—ã¦ç’°å¢ƒå¤‰æ•°ãŒä¸Šæ›¸ãã•ã‚Œã‚‹ã®ã§æ³¨æ„ã€‚ãªã®ã§è¨­å®šãŒé–“é•ã£ã¦ã„ãŸå ´åˆã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã® confing.php ã‚’ç›´æ¥æ›¸ãæ›ãˆã¦ã‚‚åæ˜ ã•ã‚Œãªã„ã€‚ã“ã‚Œã«ãƒãƒã£ã¦ 2, 3 æ™‚é–“ç„¡é§„ã«ã—ãŸã€‚ä¸Šè¨˜è¨­å®šã‚’ã™ã‚Œã°æœ€ä½é™ç®¡ç†ç”»é¢ã§è­¦å‘ŠãŒå‡ºãªããªã‚‹ã¯ãšã€‚</p>
<p>ã¡ãªã¿ã«ã€Nextcloud ã®ç’°å¢ƒå¤‰æ•°ã¯å¤‰æ•°åã®æœ«å°¾ã« _FILE ã¨ã¤ã‘ã‚‹ã“ã¨ã§ã€docker ã® secrets ã§ç®¡ç†ã§ãã‚‹ã€‚Nextcloud ã‚„æ‹¡å¼µæ©Ÿèƒ½ã®ã®è„†å¼±æ€§ãªã©ã§ç’°å¢ƒå¤‰æ•°ãŒæ¼ã‚ŒãŸæ™‚ã«å‚™ãˆã¦ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç³»ã¯ secrets ã§ç®¡ç†ã™ã‚‹ã“ã¨ã«ã—ãŸã€‚</p>
<h4 id="SendGrid"><a href="#SendGrid" class="headerlink" title="SendGrid"></a>SendGrid</h4><p>ãƒ¡ãƒ¼ãƒ«ã®é…ä¿¡ã¯ SendGrid ã‚’ä½¿ã£ã¦ã„ã‚‹ã€‚SMTP_NAME ã¯ apikey, SMTP_PASSWORD ã«ã¯ SendGrid ã® API ã‚­ãƒ¼ã‚’è¨­å®šã™ã‚‹ã€‚</p>
<ul>
<li>å‚è€ƒ: <a target="_blank" rel="noopener" href="https://docs.sendgrid.com/ja/for-developers/sending-email/getting-started-smtp">SMTPãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡æ–¹æ³• | Twilio</a></li>
</ul>
<h4 id="skelton-ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª"><a href="#skelton-ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª" class="headerlink" title="skelton ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª"></a>skelton ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª</h4><p>æ–°è¦ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é…ç½®ã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã§ãã‚‹ã€‚æ—¢å®šã ã¨ã‚µãƒ³ãƒ—ãƒ«ã®ç”»åƒãªã©ãŒå…¥ã£ã¦ã„ã‚‹ã®ã§ NC_skeletondirectory=/var/skeleton/ ã§æŒ‡å®šã—ã¦ã€docker-compose.yml ã§ãƒã‚¦ãƒ³ãƒˆã—ã¦ãŠãã€‚ä½¿ã„æ–¹ã® PDF ã§ã‚‚ã¤ãã£ã¦ãƒ„ãƒƒã‚³ã‚“ã§ãŠã</p>
<h4 id="ãƒ­ã‚°"><a href="#ãƒ­ã‚°" class="headerlink" title="ãƒ­ã‚°"></a>ãƒ­ã‚°</h4><p>apache ç‰ˆã® docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ apache ã®ãƒ­ã‚°ã—ã‹ stdout ã«å‡ºåŠ›ã—ãªã„ã®ã§ docker compose logs ãªã©ã§ Nextcloud å´ã®ãƒ­ã‚°ãŒç¢ºèªã§ããªã„ã€‚ã¾ãŸãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›ã•ã‚Œã¦ã„ãªã‘ã‚Œã°ã€Web ã®ç®¡ç†ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ãƒ­ã‚°ãŒè¦‹ãˆãªãã¦ä¸ä¾¿ãªã®ã§ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ã™ã‚‹ã‚ˆã†ä¿®æ­£ã€‚å‡ºåŠ›å…ˆã® /var/log/nextcloud/ ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã¯ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ¡ãƒ¼ã‚¸å†…ã§ä½œæˆã—ã¦ www-data ã«ã‚ªãƒ¼ãƒŠãƒ¼ã‚’å¤‰æ›´ã—ã¦ãŠãã€‚ å®‰å®šç¨¼åƒã¾ã§ã¯ NC_loglevel ã§ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’ 0 (DEBUG) ã«ã—ã¦ã‚ã‚‹ã€‚ã—ã°ã‚‰ãã—ãŸã‚‰ 3 (ERROR) ã«æˆ»ã™ã€‚</p>
<h4 id="ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—"><a href="#ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—" class="headerlink" title="ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—"></a>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h4><p>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯é›‘ã« docker volume ã‚’ tar ã§å›ºã‚ã¦ã€å¤–éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ &amp; Azure Blob ã«ä¿å­˜ã—ã¦ã„ã‚‹ã€‚ãƒªã‚¹ãƒˆã‚¢ã¯å‡ºæ¥ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸã‘ã©ã€é›‘ã¯é›‘ã€‚</p>
<pre class=" language-sh"><code class="language-sh"># maintenance mode on
# https://doc.owncloud.com/server/next/admin_manual/maintenance/enable_maintenance.html
cd /home/watahani/docker_apps/nextcloud
docker compose exec -u www-data nextcloud php occ maintenance:mode --on

date=`date '+%Y-%m-%d'`

VOLUMES=("nextcloud_db_data" "nextcloud_nextcloud_data" "nextcloud_redis_data" "elasticsearch_data")
for VOLUME_NAME in $&#123;VOLUMES[@]&#125;; do
    echo back up $VOLUME_NAME start
    BACKUP_DESTINATION=/mnt/hdd01/owncloud_backup/$VOLUME_NAME.tar.gz
    sudo tar -czf "$BACKUP_DESTINATION" -C "/var/lib/docker/volumes/$VOLUME_NAME" _data
    echo upload $VOLUME_NAME start
    azcopy copy $BACKUP_DESTINATION "https://watahaniownvcloud.blob.core.windows.net/backup/$VOLUME_NAME-$date.tar.gz"
    echo back up $VOLUME_NAME finish!
done

docker compose exec -u www-data nextcloud php occ maintenance:mode --off
</code></pre>
<p>azcopy login ãŒå»ƒæ­¢äºˆå®šã«ãªã‚‹ã‚‰ã—ãã€ã‚µãƒ¼ãƒ“ã‚¹ ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã§ã®èªè¨¼ã®å ´åˆã€ã‚ã‚‰ã‹ã˜ã‚ç’°å¢ƒå¤‰æ•°ã« AZCOPY_SPA_APPLICATION_ID, AZCOPY_SPA_CLIENT_SECRET, AZCOPY_TENANT_ID, AZCOPY_AUTO_LOGIN_TYPE=SPN ã‚’è¨­å®šã—ã¦ãŠãã“ã¨ã€‚</p>
<pre class=" language-sh"><code class="language-sh">INFO: 'azcopy login' command will be deprecated starting release 10.22. Use auto-login instead. Visit https://learn.microsoft.com/en-us/azure/storage/common/storage-use-azcopy-authorize-azure-active-directory#authorize-without-a-secret-store  to know more.
</code></pre>
<p>ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªèªè¨¼ã¯ azure-cli ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãŠã„ã¦ãã®èªè¨¼æƒ…å ±ã‚’ä½¿ã„ã¾ã‚ã™å®Ÿè£…ã«ç§»è¡Œã—ã¦ã„ãã‚ˆã†ã ã€‚</p>
<ul>
<li>å‚è€ƒ: <a target="_blank" rel="noopener" href="https://zenn.dev/ciffelia/articles/docker-volume-backup-restore">ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿æŒã—ãŸã¾ã¾Dockerã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒã™ã‚‹</a></li>
</ul>
<p>æœ€æ‚ªã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸå†™çœŸãƒ‡ãƒ¼ã‚¿ãŒç„¡äº‹ãªã‚‰è‰¯ã„ã®ã§ã¾ã‚ã“ã‚Œã§ãƒ¨ã‚·ã€‚</p>
<h4 id="ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ—ãƒª"><a href="#ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ—ãƒª" class="headerlink" title="ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ—ãƒª"></a>ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ—ãƒª</h4><p>ã“ã®è¾ºã‚’å…¥ã‚ŒãŸ</p>
<ul>
<li>memories</li>
<li>fulltextsearch</li>
<li>fulltextsearch_elasticsearch</li>
<li>previewgenerator</li>
</ul>
<p>ã‚³ãƒãƒ³ãƒ‰ã§å…¥ã‚Œã‚‹ãªã‚‰ <code>docker compose exec -u www-data nextcloud php occ app:install memories</code> ã®ã‚ˆã†ã«ã™ã‚‹ã€‚</p>
<p>æ§‹ç¯‰ã—ã¦ã„ãŸå½“æ™‚ã€<a target="_blank" rel="noopener" href="https://apps.nextcloud.com/">https://apps.nextcloud.com/</a> ãŒç•°å¸¸ã«é‡ãã€ã‚¢ãƒ—ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§å‡ºæ¥ãªã‹ã£ãŸã€‚</p>
<pre class=" language-json"><code class="language-json">&amp;#<span class="token number">123</span><span class="token punctuation">;</span><span class="token property">"reqId"</span><span class="token operator">:</span><span class="token string">"CIl2uB04J5qvKBuCFJOe"</span><span class="token punctuation">,</span><span class="token property">"level"</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token property">"time"</span><span class="token operator">:</span><span class="token string">"2024-02-03T13:31:32+00:00"</span><span class="token punctuation">,</span><span class="token property">"remoteAddr"</span><span class="token operator">:</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token property">"user"</span><span class="token operator">:</span><span class="token string">"--"</span><span class="token punctuation">,</span><span class="token property">"app"</span><span class="token operator">:</span><span class="token string">"appstoreFetcher"</span><span class="token punctuation">,</span><span class="token property">"method"</span><span class="token operator">:</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token property">"url"</span><span class="token operator">:</span><span class="token string">"--"</span><span class="token punctuation">,</span><span class="token property">"message"</span><span class="token operator">:</span><span class="token string">"Could not connect to appstore: cURL error 28: Operation timed out after 60000 milliseconds with 2514944 out of 6055936 bytes received (see https://curl.haxx.se/libcurl/c/libcurl-errors.html) for https://apps.nextcloud.com/api/v1/apps.json"</span><span class="token punctuation">,</span><span class="token property">"userAgent"</span><span class="token operator">:</span><span class="token string">"--"</span><span class="token punctuation">,</span><span class="token property">"version"</span><span class="token operator">:</span><span class="token string">"28.0.2.5"</span><span class="token punctuation">,</span><span class="token property">"data"</span><span class="token operator">:</span>&amp;#<span class="token number">123</span><span class="token punctuation">;</span><span class="token property">"app"</span><span class="token operator">:</span><span class="token string">"appstoreFetcher"</span>&amp;#<span class="token number">125</span><span class="token punctuation">;</span>&amp;#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>å¹¸ã„ä½•åº¦ã‹è©¦ã›ã°é€šä¿¡ã§åˆ‡ã‚‹ã¨ããŒã‚ã£ãŸã®ã§ã€ä¸€æ™‚çš„ã«ã‚ªãƒªã‚¸ãƒŠãƒ«ã® json ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ Blob ã«ãŠã„ã¦å¯¾å‡¦ã—ãŸã€‚å…·ä½“çš„ã«ã¯ <a target="_blank" rel="noopener" href="https://apps.nextcloud.com/api/v1/apps.json">https://apps.nextcloud.com/api/v1/apps.json</a> ã¨ <a target="_blank" rel="noopener" href="https://apps.nextcloud.com/api/v1/categories.json">https://apps.nextcloud.com/api/v1/categories.json</a> ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€é©å½“ãªã‚µã‚¤ãƒˆã€åŒã˜ãƒ‘ã‚¹ã§å…¬é–‹ã™ã‚‹ã€‚</p>
<p>ãã®å¾Œã€config.php ã® appstoreurl ã«ã€https://&lt;é©å½“ãªã‚µã‚¤ãƒˆ&gt;/api/v1 ã‚’è¨­å®šã™ã‚‹ã€‚</p>
<pre class=" language-sh"><code class="language-sh">docker compose exec -u www-data nextcloud php occ --no-warnings config:system:set appstoreurl --value="https://<é©å½“ãªã‚µã‚¤ãƒˆ>/api/v1"
</code></pre>
<p>å…ƒã®ã‚µã‚¤ãƒˆãŒå¾©æ—§ã—ãŸã‚‰å…ƒã«æˆ»ã™</p>
<pre class=" language-sh"><code class="language-sh">docker compose exec -u www-data nextcloud php occ --no-warnings config:system:delete appstoreurl
</code></pre>
<h4 id="Elastic-Search"><a href="#Elastic-Search" class="headerlink" title="Elastic Search"></a>Elastic Search</h4><p>Elastic Search ã¯æ—¥æœ¬èªæ¤œç´¢ã®ãŸã‚ã« kuromoji_tokenizer ã‚’ä½¿ã†ã‚ˆã†ã«è¨­å®šã—ã¦ãŠãã€‚ãã®ãŸã‚ã« Dockerfile ã«ã¤ã„ã¦ã‚‚ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ã„ã‚‹ã€‚</p>
<pre class=" language-dockerfile"><code class="language-dockerfile"># Probably from here https://github.com/elastic/elasticsearch/blob/main/distribution/docker/src/docker/Dockerfile
FROM elasticsearch:8.12.0

USER root

# hadolint ignore=DL3008
RUN set -ex; \
    \
    export DEBIAN_FRONTEND=noninteractive; \
    apt-get update; \
    apt-get install -y --no-install-recommends \
        tzdata \
    ; \
    rm -rf /var/lib/apt/lists/*; \
    elasticsearch-plugin install --batch ingest-attachment;\
    elasticsearch-plugin install --batch analysis-kuromoji;\
    elasticsearch-plugin install --batch analysis-icu

USER 1000:0

HEALTHCHECK CMD nc -z localhost 9200 || exit 1
LABEL com.centurylinklabs.watchtower.enable="false"
</code></pre>
<p>fulltextsearch ã‚’å…¥ã‚ŒãŸã‚‰ã€Web ã®ç®¡ç†ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ <a target="_blank" rel="noopener" href="http://elasticsearch:9200">http://elasticsearch:9200</a> ã¨ã€ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã« kuromoji_tokenizer ã‚’æŒ‡å®šã™ã‚‹ã€‚<br>ãã®å¾Œã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®åˆæœŸä½œæˆã‚’ã—ã¦ãŠã</p>
<pre class=" language-sh"><code class="language-sh">docker compose exec -u www-data nextcloud php occ fulltextsearch:reset
docker compose exec -u www-data nextcloud php occ fulltextsearch:index
</code></pre>
<p>ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å®šæœŸä½œæˆã«ã¤ã„ã¦ã¯ã€<a target="_blank" rel="noopener" href="https://rohhie.net/ubuntu22-04-implementing-nextcloud-with-docker/">Ubuntu22.04 Dockerã§Nextcloud | ã‚ã£ã²ãƒ¼</a> ã‚’å‚è€ƒã« /var/www/html/occ fulltextsearch:live â€“service ã‚³ãƒãƒ³ãƒ‰ã‚’èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰å‘¼ã³ã ã™ã‚ˆã† Dockerfile ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸã€‚<br>ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤šãå‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã£ãŸã‚Šã€ãƒãƒƒãƒå‡¦ç†ã‚’ã—ãŸã„ã®ã§ã‚ã‚Œã°å¾Œè¿°ã® cron ã« fulltextsearch:index ã‚’ã‚¸ãƒ§ãƒ–ã¨ã—ã¦è¿½åŠ ã™ã‚Œã°è‰¯ã„ã ã‚ã†ã€‚</p>
<h4 id="memories-ã¨-previewgenerator"><a href="#memories-ã¨-previewgenerator" class="headerlink" title="memories ã¨ previewgenerator"></a>memories ã¨ previewgenerator</h4><p>memories ã‚’å…¥ã‚Œã‚‹ã“ã¨ã«ã‚ˆã‚Š Google Photo ã®ã‚ˆã†ã«æ—¥ä»˜ã”ã¨ã«å†™çœŸã‚’è¡¨ç¤ºã—ãŸã‚Šã€äººç‰©ã‚„å ´æ‰€ã”ã¨ã«å†™çœŸã‚’è¡¨ç¤ºã—ãŸã‚Šã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚ç”»åƒèªè­˜ã¯åˆ¥é€”ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒå¿…è¦ãªã®ã§ã€ä»Šå›ã¯è©¦ã—ã¦ã„ãªã„ã€‚<br>ã¾ãŸã€memories ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã«ã¯ ffmpeg ãŒå¿…è¦ãªã®ã§ã€Dockerfile ã« ffmpeg ã‚’è¿½åŠ ã—ãŸã€‚</p>
<p>memories ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨ Nextcloud æ—¢å®šã§ã¯ 2048px ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ç”Ÿæˆã™ã‚‹ã‚‰ã—ã„ã®ã§ã€å°‘ã—å°ã•ãã€‚</p>
<pre class=" language-sh"><code class="language-sh">docker compose exec -u www-data nextcloud php occ config:system:set preview_max_x --value="1024"
docker compose exec -u www-data nextcloud php occ config:system:set preview_max_y --value="1024"
</code></pre>
<p>previewgenerator ã‚‚åˆæœŸä½œæˆã‚’ã—ã¦ãŠã</p>
<pre class=" language-sh"><code class="language-sh">docker compose exec -it -u www-data nextcloud php occ config:app:set --value="64 256 1024" previewgenerator squareSizes
docker compose exec -it -u www-data nextcloud php occ config:app:set --value="64 256 1024" previewgenerator widthSizes
docker compose exec -it -u www-data nextcloud php occ config:app:set --value="64 256 1024" previewgenerator heightSizes
</code></pre>
<p>å‡ºæ¥ãŸã‚‰åˆå›ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã‚’è¡Œã†</p>
<pre class=" language-sh"><code class="language-sh">nohup docker compose exec -u www-data nextcloud php occ preview:generate-all&
</code></pre>
<p>çµ‚ã‚ã£ãŸã‚‰ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã‚’ nextcloud-cron ã«è¿½åŠ ã—ã¦å®šæœŸçš„ã«å·®åˆ†ç”Ÿæˆã™ã‚‹ã‚ˆã†æ§‹æˆã™ã‚‹ã€‚</p>
<pre class=" language-sh"><code class="language-sh">php /var/www/nextcloud/occ preview:pre-generate
</code></pre>
<h4 id="cron"><a href="#cron" class="headerlink" title="cron"></a>cron</h4><p>Nextcloud ã® cron ã‚¸ãƒ§ãƒ–ã¯ã€nextcloud-cron ã¨ã—ã¦åˆ¥ã‚³ãƒ³ãƒ†ãƒŠã§èµ·å‹•ã—ã¦ã„ã‚‹ã€‚</p>
<p>å‚è€ƒ: <a target="_blank" rel="noopener" href="https://help.nextcloud.com/t/docker-setup-cron/78547/5">Docker setup &amp; cron - Reiner_Nippes ã® #5 - ğŸ“¦ Appliances (Docker, Snappy, VM, NCP, AIO) - Nextcloud community</a></p>
<p>æ—¢å®šã§ã¯ <a target="_blank" rel="noopener" href="https://github.com/nextcloud/docker/blob/ccdf46609ff8419ffd7c5ce4e51a117e378b72b6/Dockerfile-debian.template#L15">php -f /var/www/html/cron.php</a> ãŒ 5 åˆ†ã”ã¨ã«å®Ÿè¡Œã•ã‚Œã‚‹ã€‚ä¸Šæ›¸ãã—ãŸã‘ã‚Œã° <code>/var/spool/cron/crontabs/www-data</code> ã‚’ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ãªã©ã—ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã€‚</p>
<p>memories ã‚„ previewgenerator ã‚’é©å½“ã«å®šæœŸå®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹ã€‚ã“ã®æ™‚ cron ãƒ•ã‚¡ã‚¤ãƒ«ã®æ‰€æœ‰è€…ãŒ root ã§ãªã‘ã‚Œã°å¤±æ•—ã™ã‚‹ã®ã§æ³¨æ„ã€‚</p>
<ul>
<li>å‚è€ƒ: <a target="_blank" rel="noopener" href="https://keep-memory.com/docker-busybox-crond">dockerã§BusyBox crondãŒå‹•ã‹ãªã„ â€“ numa blog</a></li>
</ul>
<pre class=" language-sh"><code class="language-sh">docker compose cp nextcloud-cron:/var/spool/cron/crontabs/www-data ./mycronfile
echo '30 18 * * * php /var/www/html/occ preview:pre-generate' >> ./mycronfile
echo '5 * * * * php /var/www/html/occ memories:index' >> ./mycronfile
sudo chown root:root ./mycronfile
</code></pre>
<p>ã‚³ãƒ³ãƒ†ãƒŠã«ãƒã‚¦ãƒ³ãƒˆ</p>
<pre class=" language-yaml"><code class="language-yaml">  <span class="token key atrule">nextcloud-cron</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span> ./customimages/nextcloud
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> nextcloud<span class="token punctuation">-</span>cron
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped
    <span class="token key atrule">env_file</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./.env
      <span class="token punctuation">-</span> ./env/db.env
      <span class="token punctuation">-</span> ./env/nextcloud.env
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> nextcloud_data<span class="token punctuation">:</span>/var/www/html
      <span class="token comment" spellcheck="true"># - ./config:/var/www/html/config # for debug</span>
      <span class="token punctuation">-</span> ./log/<span class="token punctuation">:</span>/var/log/nextcloud/
      <span class="token punctuation">-</span> ./skeleton/<span class="token punctuation">:</span>/var/skeleton/
      <span class="token punctuation">-</span> /mnt/hdd01/<span class="token punctuation">:</span>/mnt/hdd01/
      <span class="token comment" spellcheck="true"># if customize cron file</span>
      <span class="token comment" spellcheck="true"># https://help.nextcloud.com/t/docker-setup-cron/78547/5</span>
      <span class="token comment" spellcheck="true"># https://github.com/nextcloud/docker/blob/ccdf46609ff8419ffd7c5ce4e51a117e378b72b6/Dockerfile-debian.template#L15</span>
      <span class="token punctuation">-</span> ./mycronfile<span class="token punctuation">:</span>/var/spool/cron/crontabs/www<span class="token punctuation">-</span>data
</code></pre>
<h4 id="Google-Taskout-ã‹ã‚‰ã®ç§»è¡Œ"><a href="#Google-Taskout-ã‹ã‚‰ã®ç§»è¡Œ" class="headerlink" title="Google Taskout ã‹ã‚‰ã®ç§»è¡Œ"></a>Google Taskout ã‹ã‚‰ã®ç§»è¡Œ</h4><p>ä»Šå›ã¯ Google Photo ã‹ã‚‰ã®ç§»è¡Œãªã®ã§ã€<a target="_blank" rel="noopener" href="https://takeout.google.com/settings/takeout">Google Takeout</a> ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ã€Nextcloud ã«å–ã‚Šè¾¼ã‚€ã€‚ä¿å­˜ã—ãŸãƒ‘ã‚¹ã‚’å¤–éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨ã—ã¦ãƒã‚¦ãƒ³ãƒˆã—ã¦ã‚‚è‰¯ã„ã®ã ãŒã€ä»Šå¾Œã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚¹ãƒãƒ›ã®ã‚«ãƒ¡ãƒ©ç”»åƒã¨åŒæ§˜ã®æ‰±ã„ã«ã—ãŸã‹ã£ãŸã®ã§ã€Nextcloud ã«ç›´æ¥å–ã‚Šè¾¼ã‚€ã€‚</p>
<p>memories ãŒãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã‚Œã‚‹ã‚‰ã—ã„ã®ã§ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ Nextcloud ã«è»¢é€å¾Œã«ä»¥ä¸‹ã‚’å®Ÿè¡Œã™ã‚‹ã€‚</p>
<pre class=" language-sh"><code class="language-sh"># ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ docker volume ã«è»¢é€
sudo mv ./Takeout /var/lib/docker/volumes/&#123;volume_name&#125;/_data/data/&#123;username&#125;/
# ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆ
docker compose exec -u www-data nextcloud php occ files:scan --path="&#123;username&#125;/files/Takeout"
# Google Takeout ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
docker compose exec -u www-data nextcloud sh -c 'yes | php occ memories:migrate-google-takeout'
</code></pre>
<p>ãŒã€æ‰‹å…ƒã®ç’°å¢ƒã§ã¯ã†ã¾ãå‹•ã‹ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã£ãŸã®ã§ã€<a target="_blank" rel="noopener" href="https://github.com/TheLastGimbus/GooglePhotosTakeoutHelper">TheLastGimbus/GooglePhotosTakeoutHelper: Script that organizes the Google Takeout archive into one big chronological folder</a> ã‚’ä½¿ã£ã¦ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚“ã ã€‚</p>
<p>guess-from-name ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ãƒ•ã‚¡ã‚¤ãƒ«åãªã©ã‹ã‚‰æ—¥ä»˜ã‚’æ¨æ¸¬ã—ã¦ãã‚Œã‚‹ã‚‰ã—ã„ã€‚å®Ÿéš›ã« memories ã§å–ã‚Šè¾¼ã‚ãªã‹ã£ãŸãƒ‡ãƒ¼ã‚¿ãªã©ãŒã€ãƒ•ã‚©ãƒ«ãƒ€åã®æ—¥ä»˜ã‚’å…ƒã«å–ã‚Šè¾¼ã¾ã‚ŒãŸã®ã§åŠ©ã‹ã£ãŸã€‚ã‚¢ãƒ«ãƒãƒ ã¯æ—¢å®šã§ã¯å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã¯æ—¥ä»˜ãƒ•ã‚©ãƒ«ãƒ€ã«å…¥ã‚Œã¦ã‚¢ãƒ«ãƒãƒ ç”¨ã«ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’å¼µã‚‹è¨­å®šã‚‰ã—ã„ã®ã§ã€nothing ã«ã—ã¦ãŠãã€‚</p>
<pre class=" language-sh"><code class="language-sh">wget https://github.com/TheLastGimbus/GooglePhotosTakeoutHelper/releases/download/v3.4.3/gpth-linux
chmod +x gpth-linux
./gpth-linux -i ./Takeout/ -o ./output --divide-to-dates --guess-from-name --albums nothing
</code></pre>
<p>ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›å¾Œã€å¿µã®ãŸã‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾Œã«ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ç›´æ¥ Docker Volume ã®ä¸­ã«ç§»å‹•ã€‚</p>
<pre class=" language-sh"><code class="language-sh">sudo mv ./output/ALL_PHOTOS  /var/lib/docker/volumes/&#123;volume_name&#125;/_data/data/&#123;username&#125;/
docker compose exec nextcloud chown -R www-data:www-data /var/lib/docker/volumes/&#123;volume_name&#125;/_data/data/&#123;username&#125;/Takeout
</code></pre>
<p>ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œã‚‹</p>
<pre class=" language-sh"><code class="language-sh">docker compose exec -u www-data nextcloud php occ files:scan --path="&#123;username&#125;/files/Takeout"
</code></pre>
<p>é›‘ã ã‘ã©å‹•ã„ãŸã®ã§ãƒ¨ã‚·ãƒƒï¼ãã‚‚ãã‚‚ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒã†ã¾ãå–ã‚Šè¾¼ã‚ãªã„å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€å®¶ã® HDD ã«ã‚ªãƒªã‚¸ãƒŠãƒ«ãŒã‚ã‚‹ã®ã§ã©ã“ã‹ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãã‚Œã«å·®ã—æ›¿ãˆã‚ˆã†ã€‚</p>
<h2 id="æœ€å¾Œã«"><a href="#æœ€å¾Œã«" class="headerlink" title="æœ€å¾Œã«"></a>æœ€å¾Œã«</h2><p>Docker ã§ Nextcloud ã‚’å‹•ã‹ã™ãƒ¡ãƒ¢ã€‚ãƒ•ã‚©ãƒ¼ãƒ©ãƒ ã‚‚å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚ã‹ãªã‚Šå……å®Ÿã—ã¦ã„ã‚‹ã‚‚ã®ã®ã€docker ã§å‹•ã‹ã™ã«ã¯ãã‚Œãªã‚Šã«è‹¦åŠ´ã—ãŸã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã‚„ç›£è¦–ã«ã¤ã„ã¦ã¯ã¾ã å‡ºæ¥ã¦ã„ãªã„ã®ã§ã€å˜ã« Nextcloud ã ã‘ãŒç›®çš„ã§ã‚ã‚Œã° snap ã§å…¥ã‚Œã‚‹ã®ãŒä¸€ç•ªæ¥½ã ã‚ã†ã€‚</p>
<p>æœ€å¾Œã«èªè¨¼ã®è©±ã‚’ã—ã¦ãŠãã¨ Nextcloud è‡ªä½“ã¯ Passkey ã«å¯¾å¿œã—ã¦ã„ã‚‹ã‚ˆã†ã§ã€å€‹äººè¨­å®šã‹ã‚‰ Android ãƒ‡ãƒã‚¤ã‚¹ã‚„ Windows Hello ã‚’è¿½åŠ ã§ããŸã€‚<br>ãŸã ãƒ¢ãƒã‚¤ãƒ« ã‚¢ãƒ—ãƒªã§ã¯ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã« Chrome ãªã©ãŒèµ·å‹•ã™ã‚‹ã®ã§ã¯ãªãã€hwsecurity.dev ã¨ã„ã†ä¼šç¤¾ãŒæä¾›ã—ã¦ã„ã‚‹ SDK ãŒçµ„ã¿è¾¼ã¾ã‚ŒãŸç‹¬è‡ªãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ãŒèµ·å‹•ã—ã¦ã€Security Key ã—ã‹ä½¿ãˆãªã„ UX ã«ãªã£ã¦ã„ãŸã€‚ãã®ãŸã‚ 2FA ã‚’æœ‰åŠ¹ã«ã—ãŸã†ãˆã§ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã€PC ã§ã‚¢ãƒ—ãƒªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç™ºè¡Œã™ã‚‹ã‹ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ ã‚­ãƒ¼ã‚„ OTP ãªã©åˆ¥ã®èªè¨¼è¦ç´ ã‚’ç™»éŒ²ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ã®ã§æ³¨æ„ã€‚</p>
<div class="related-post"><h3>é–¢é€£è¨˜äº‹</h3></div></div><div class="article-meta" style="max-width:800px"></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2023/08/01/tips-for-using-appservice-authentication-securely/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/82p" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="https://twitter.com/watahani" title="Twitter" target="_blank"><i class="icon icon-twitter"></i></a></li><li><a href="https://www.facebook.com/haniyama.wataru" title="Facebook" target="_blank"><i class="icon icon-facebook"></i></a></li></ul></div><div class="bottom"><p class="copyright">Â© 2024 enjoy struggling<br><small>POWER BY <a href="https://hexo.io" target="_blank">HEXO</a></small><small>, THEME BY <a href="https://github.com/BoizZ/hexo-theme-laughing" target="_blank">LAUGHING</a></small></p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>